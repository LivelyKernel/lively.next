var semver;!function(r,e){var t;r={}.exports=U,t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?function(){var r=Array.prototype.slice.call(arguments,0);r.unshift("SEMVER"),console.log.apply(console,r)}:function(){},r.SEMVER_SPEC_VERSION="2.0.0";var n=256,i=Number.MAX_SAFE_INTEGER||9007199254740991,s=r.re=[],o=r.src=[],a=0,c=a++;o[c]="0|[1-9]\\d*";var u=a++;o[u]="[0-9]+";var p=a++;o[p]="\\d*[a-zA-Z-][a-zA-Z0-9-]*";var h=a++;o[h]="("+o[c]+")\\.("+o[c]+")\\.("+o[c]+")";var l=a++;o[l]="("+o[u]+")\\.("+o[u]+")\\.("+o[u]+")";var f=a++;o[f]="(?:"+o[c]+"|"+o[p]+")";var v=a++;o[v]="(?:"+o[u]+"|"+o[p]+")";var m=a++;o[m]="(?:-("+o[f]+"(?:\\."+o[f]+")*))";var g=a++;o[g]="(?:-?("+o[v]+"(?:\\."+o[v]+")*))";var w=a++;o[w]="[0-9A-Za-z-]+";var y=a++;o[y]="(?:\\+("+o[w]+"(?:\\."+o[w]+")*))";var d=a++,j="v?"+o[h]+o[m]+"?"+o[y]+"?";o[d]="^"+j+"$";var E="[v=\\s]*"+o[l]+o[g]+"?"+o[y]+"?",b=a++;o[b]="^"+E+"$";var $=a++;o[$]="((?:<|>)?=?)";var k=a++;o[k]=o[u]+"|x|X|\\*";var R=a++;o[R]=o[c]+"|x|X|\\*";var S=a++;o[S]="[v=\\s]*("+o[R]+")(?:\\.("+o[R]+")(?:\\.("+o[R]+")(?:"+o[m]+")?"+o[y]+"?)?)?";var x=a++;o[x]="[v=\\s]*("+o[k]+")(?:\\.("+o[k]+")(?:\\.("+o[k]+")(?:"+o[g]+")?"+o[y]+"?)?)?";var I=a++;o[I]="^"+o[$]+"\\s*"+o[S]+"$";var T=a++;o[T]="^"+o[$]+"\\s*"+o[x]+"$";var V=a++;o[V]="(?:~>?)";var A=a++;o[A]="(\\s*)"+o[V]+"\\s+",s[A]=new RegExp(o[A],"g");var N=a++;o[N]="^"+o[V]+o[S]+"$";var C=a++;o[C]="^"+o[V]+o[x]+"$";var M=a++;o[M]="(?:\\^)";var _=a++;o[_]="(\\s*)"+o[M]+"\\s+",s[_]=new RegExp(o[_],"g");var D=a++;o[D]="^"+o[M]+o[S]+"$";var X=a++;o[X]="^"+o[M]+o[x]+"$";var z=a++;o[z]="^"+o[$]+"\\s*("+E+")$|^$";var G=a++;o[G]="^"+o[$]+"\\s*("+j+")$|^$";var O=a++;o[O]="(\\s*)"+o[$]+"\\s*("+E+"|"+o[S]+")",s[O]=new RegExp(o[O],"g");var P=a++;o[P]="^\\s*("+o[S]+")\\s+-\\s+("+o[S]+")\\s*$";var Z=a++;o[Z]="^\\s*("+o[x]+")\\s+-\\s+("+o[x]+")\\s*$";var q=a++;o[q]="(<|>)?=?\\s*\\*";for(var B=0;B<a;B++)t(B,o[B]),s[B]||(s[B]=new RegExp(o[B]));function L(r,e){if(r instanceof U)return r;if("string"!=typeof r)return null;if(r.length>n)return null;if(!(e?s[b]:s[d]).test(r))return null;try{return new U(r,e)}catch(r){return null}}function U(r,e){if(r instanceof U){if(r.loose===e)return r;r=r.version}else if("string"!=typeof r)throw new TypeError("Invalid Version: "+r);if(r.length>n)throw new TypeError("version is longer than "+n+" characters");if(!(this instanceof U))return new U(r,e);t("SemVer",r,e),this.loose=e;var o=r.trim().match(e?s[b]:s[d]);if(!o)throw new TypeError("Invalid Version: "+r);if(this.raw=r,this.major=+o[1],this.minor=+o[2],this.patch=+o[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");o[4]?this.prerelease=o[4].split(".").map(function(r){if(/^[0-9]+$/.test(r)){var e=+r;if(e>=0&&e<i)return e}return r}):this.prerelease=[],this.build=o[5]?o[5].split("."):[],this.format()}r.parse=L,r.valid=function(r,e){var t=L(r,e);return t?t.version:null},r.clean=function(r,e){var t=L(r.trim().replace(/^[=v]+/,""),e);return t?t.version:null},r.SemVer=U,U.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},U.prototype.toString=function(){return this.version},U.prototype.compare=function(r){return t("SemVer.compare",this.version,this.loose,r),r instanceof U||(r=new U(r,this.loose)),this.compareMain(r)||this.comparePre(r)},U.prototype.compareMain=function(r){return r instanceof U||(r=new U(r,this.loose)),H(this.major,r.major)||H(this.minor,r.minor)||H(this.patch,r.patch)},U.prototype.comparePre=function(r){if(r instanceof U||(r=new U(r,this.loose)),this.prerelease.length&&!r.prerelease.length)return-1;if(!this.prerelease.length&&r.prerelease.length)return 1;if(!this.prerelease.length&&!r.prerelease.length)return 0;var e=0;do{var n=this.prerelease[e],i=r.prerelease[e];if(t("prerelease compare",e,n,i),void 0===n&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===n)return-1;if(n!==i)return H(n,i)}while(++e)},U.prototype.inc=function(r,e){switch(r){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",e);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",e);break;case"prepatch":this.prerelease.length=0,this.inc("patch",e),this.inc("pre",e);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",e),this.inc("pre",e);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var t=this.prerelease.length;--t>=0;)"number"==typeof this.prerelease[t]&&(this.prerelease[t]++,t=-2);-1===t&&this.prerelease.push(0)}e&&(this.prerelease[0]===e?isNaN(this.prerelease[1])&&(this.prerelease=[e,0]):this.prerelease=[e,0]);break;default:throw new Error("invalid increment argument: "+r)}return this.format(),this.raw=this.version,this},r.inc=function(r,e,t,n){"string"==typeof t&&(n=t,t=void 0);try{return new U(r,t).inc(e,n).version}catch(r){return null}},r.diff=function(r,e){if(Y(r,e))return null;var t=L(r),n=L(e);if(t.prerelease.length||n.prerelease.length){for(var i in t)if(("major"===i||"minor"===i||"patch"===i)&&t[i]!==n[i])return"pre"+i;return"prerelease"}for(var i in t)if(("major"===i||"minor"===i||"patch"===i)&&t[i]!==n[i])return i},r.compareIdentifiers=H;var F=/^[0-9]+$/;function H(r,e){var t=F.test(r),n=F.test(e);return t&&n&&(r=+r,e=+e),t&&!n?-1:n&&!t?1:r<e?-1:r>e?1:0}function J(r,e,t){return new U(r,t).compare(e)}function K(r,e,t){return J(e,r,t)}function Q(r,e,t){return J(r,e,t)>0}function W(r,e,t){return J(r,e,t)<0}function Y(r,e,t){return 0===J(r,e,t)}function rr(r,e,t){return 0!==J(r,e,t)}function er(r,e,t){return J(r,e,t)>=0}function tr(r,e,t){return J(r,e,t)<=0}function nr(r,e,t,n){var i;switch(e){case"===":"object"==typeof r&&(r=r.version),"object"==typeof t&&(t=t.version),i=r===t;break;case"!==":"object"==typeof r&&(r=r.version),"object"==typeof t&&(t=t.version),i=r!==t;break;case"":case"=":case"==":i=Y(r,t,n);break;case"!=":i=rr(r,t,n);break;case">":i=Q(r,t,n);break;case">=":i=er(r,t,n);break;case"<":i=W(r,t,n);break;case"<=":i=tr(r,t,n);break;default:throw new TypeError("Invalid operator: "+e)}return i}function ir(r,e){if(r instanceof ir){if(r.loose===e)return r;r=r.value}if(!(this instanceof ir))return new ir(r,e);t("comparator",r,e),this.loose=e,this.parse(r),this.semver===sr?this.value="":this.value=this.operator+this.semver.version,t("comp",this)}r.rcompareIdentifiers=function(r,e){return H(e,r)},r.major=function(r,e){return new U(r,e).major},r.minor=function(r,e){return new U(r,e).minor},r.patch=function(r,e){return new U(r,e).patch},r.compare=J,r.compareLoose=function(r,e){return J(r,e,!0)},r.rcompare=K,r.sort=function(e,t){return e.sort(function(e,n){return r.compare(e,n,t)})},r.rsort=function(e,t){return e.sort(function(e,n){return r.rcompare(e,n,t)})},r.gt=Q,r.lt=W,r.eq=Y,r.neq=rr,r.gte=er,r.lte=tr,r.cmp=nr,r.Comparator=ir;var sr={};function or(r,e){if(r instanceof or&&r.loose===e)return r;if(!(this instanceof or))return new or(r,e);if(this.loose=e,this.raw=r,this.set=r.split(/\s*\|\|\s*/).map(function(r){return this.parseRange(r.trim())},this).filter(function(r){return r.length}),!this.set.length)throw new TypeError("Invalid SemVer Range: "+r);this.format()}function ar(r){return!r||"x"===r.toLowerCase()||"*"===r}function cr(r,e,t,n,i,s,o,a,c,u,p,h,l){return((e=ar(t)?"":ar(n)?">="+t+".0.0":ar(i)?">="+t+"."+n+".0":">="+e)+" "+(a=ar(c)?"":ar(u)?"<"+(+c+1)+".0.0":ar(p)?"<"+c+"."+(+u+1)+".0":h?"<="+c+"."+u+"."+p+"-"+h:"<="+a)).trim()}function ur(r,e){for(var n=0;n<r.length;n++)if(!r[n].test(e))return!1;if(e.prerelease.length){for(n=0;n<r.length;n++)if(t(r[n].semver),r[n].semver!==sr&&r[n].semver.prerelease.length>0){var i=r[n].semver;if(i.major===e.major&&i.minor===e.minor&&i.patch===e.patch)return!0}return!1}return!0}function pr(r,e,t){try{e=new or(e,t)}catch(r){return!1}return e.test(r)}function hr(r,e,t,n){var i,s,o,a,c;switch(r=new U(r,n),e=new or(e,n),t){case">":i=Q,s=tr,o=W,a=">",c=">=";break;case"<":i=W,s=er,o=Q,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(pr(r,e,n))return!1;for(var u=0;u<e.set.length;++u){var p=null,h=null;if(e.set[u].forEach(function(r){r.semver===sr&&(r=new ir(">=0.0.0")),p=p||r,h=h||r,i(r.semver,p.semver,n)?p=r:o(r.semver,h.semver,n)&&(h=r)}),p.operator===a||p.operator===c)return!1;if((!h.operator||h.operator===a)&&s(r,h.semver))return!1;if(h.operator===c&&o(r,h.semver))return!1}return!0}ir.prototype.parse=function(r){var e=this.loose?s[z]:s[G],t=r.match(e);if(!t)throw new TypeError("Invalid comparator: "+r);this.operator=t[1],"="===this.operator&&(this.operator=""),t[2]?this.semver=new U(t[2],this.loose):this.semver=sr},ir.prototype.toString=function(){return this.value},ir.prototype.test=function(r){return t("Comparator.test",r,this.loose),this.semver===sr||("string"==typeof r&&(r=new U(r,this.loose)),nr(r,this.operator,this.semver,this.loose))},r.Range=or,or.prototype.format=function(){return this.range=this.set.map(function(r){return r.join(" ").trim()}).join("||").trim(),this.range},or.prototype.toString=function(){return this.range},or.prototype.parseRange=function(r){var e=this.loose;r=r.trim(),t("range",r,e);var n=e?s[Z]:s[P];r=r.replace(n,cr),t("hyphen replace",r),r=r.replace(s[O],"$1$2$3"),t("comparator trim",r,s[O]),r=(r=(r=r.replace(s[A],"$1~")).replace(s[_],"$1^")).split(/\s+/).join(" ");var i=e?s[z]:s[G],o=r.split(" ").map(function(r){return function(r,e){return t("comp",r),r=function(r,e){return r.trim().split(/\s+/).map(function(r){return function(r,e){t("caret",r,e);var n=e?s[X]:s[D];return r.replace(n,function(e,n,i,s,o){var a;return t("caret",r,e,n,i,s,o),ar(n)?a="":ar(i)?a=">="+n+".0.0 <"+(+n+1)+".0.0":ar(s)?a="0"===n?">="+n+"."+i+".0 <"+n+"."+(+i+1)+".0":">="+n+"."+i+".0 <"+(+n+1)+".0.0":o?(t("replaceCaret pr",o),"-"!==o.charAt(0)&&(o="-"+o),a="0"===n?"0"===i?">="+n+"."+i+"."+s+o+" <"+n+"."+i+"."+(+s+1):">="+n+"."+i+"."+s+o+" <"+n+"."+(+i+1)+".0":">="+n+"."+i+"."+s+o+" <"+(+n+1)+".0.0"):(t("no pr"),a="0"===n?"0"===i?">="+n+"."+i+"."+s+" <"+n+"."+i+"."+(+s+1):">="+n+"."+i+"."+s+" <"+n+"."+(+i+1)+".0":">="+n+"."+i+"."+s+" <"+(+n+1)+".0.0"),t("caret return",a),a})}(r,e)}).join(" ")}(r,e),t("caret",r),r=function(r,e){return r.trim().split(/\s+/).map(function(r){return function(r,e){var n=e?s[C]:s[N];return r.replace(n,function(e,n,i,s,o){var a;return t("tilde",r,e,n,i,s,o),ar(n)?a="":ar(i)?a=">="+n+".0.0 <"+(+n+1)+".0.0":ar(s)?a=">="+n+"."+i+".0 <"+n+"."+(+i+1)+".0":o?(t("replaceTilde pr",o),"-"!==o.charAt(0)&&(o="-"+o),a=">="+n+"."+i+"."+s+o+" <"+n+"."+(+i+1)+".0"):a=">="+n+"."+i+"."+s+" <"+n+"."+(+i+1)+".0",t("tilde return",a),a})}(r,e)}).join(" ")}(r,e),t("tildes",r),r=function(r,e){return t("replaceXRanges",r,e),r.split(/\s+/).map(function(r){return function(r,e){r=r.trim();var n=e?s[T]:s[I];return r.replace(n,function(e,n,i,s,o,a){t("xRange",r,e,n,i,s,o,a);var c=ar(i),u=c||ar(s),p=u||ar(o),h=p;return"="===n&&h&&(n=""),c?e=">"===n||"<"===n?"<0.0.0":"*":n&&h?(u&&(s=0),p&&(o=0),">"===n?(n=">=",u?(i=+i+1,s=0,o=0):p&&(s=+s+1,o=0)):"<="===n&&(n="<",u?i=+i+1:s=+s+1),e=n+i+"."+s+"."+o):u?e=">="+i+".0.0 <"+(+i+1)+".0.0":p&&(e=">="+i+"."+s+".0 <"+i+"."+(+s+1)+".0"),t("xRange return",e),e})}(r,e)}).join(" ")}(r,e),t("xrange",r),r=function(r,e){return t("replaceStars",r,e),r.trim().replace(s[q],"")}(r,e),t("stars",r),r}(r,e)}).join(" ").split(/\s+/);return this.loose&&(o=o.filter(function(r){return!!r.match(i)})),o=o.map(function(r){return new ir(r,e)})},r.toComparators=function(r,e){return new or(r,e).set.map(function(r){return r.map(function(r){return r.value}).join(" ").trim().split(" ")})},or.prototype.test=function(r){if(!r)return!1;"string"==typeof r&&(r=new U(r,this.loose));for(var e=0;e<this.set.length;e++)if(ur(this.set[e],r))return!0;return!1},r.satisfies=pr,r.maxSatisfying=function(r,e,t){return r.filter(function(r){return pr(r,e,t)}).sort(function(r,e){return K(r,e,t)})[0]||null},r.validRange=function(r,e){try{return new or(r,e).range||"*"}catch(r){return null}},r.ltr=function(r,e,t){return hr(r,e,"<",t)},r.gtr=function(r,e,t){return hr(r,e,">",t)},r.outside=hr,semver=r}({});
(function runtimeDefinition(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;"object"!=typeof e.lively&&(e.lively={});var t={},r={};if(e.lively.FreezerRuntime){let[r,i,s]=(void 0).split(".").map(Number),[l,n,o]=e.lively.FreezerRuntime.version.split(".").map(Number),u=!1;if((isNaN(l)||!isNaN(r)&&r>l)&&(u=!0),!u&&(isNaN(n)||!isNaN(i)&&i>n)&&(u=!0),!u&&(isNaN(o)||!isNaN(s)&&s>o)&&(u=!0),!u)return;t=e.lively.FreezerRuntime.registry}r["@lively-env"]={executed:!0,options:{},moduleEnv(e){const t=System.get(e)||System.fetchStandaloneFor(e)||System.get(e+"index.js");return{recorder:t.recorder||t.exports}}},r["@system-env"]={executed:!0,browser:!0},e.lively.FreezerRuntime={global:window,version:void 0,registry:t,globalModules:r,get(e){return e&&e.startsWith("@")?this.globalModules[e]:this.registry[e]},set(e,t){return this.registry[e]=t},add(e,t=[],r={},i=!1){let s={id:e,dependencies:t,executed:i,exports:r,execute:function(){},setters:[],package:function(){}};return this.set(e,s),s},decanonicalize(t){if(e.lively.FreezerRuntime.globalModules[t])return t;let r=t.replace("lively-object-modules/","").replace(e.System.baseURL,"");if(!(r=r.includes("local://")?r:"local://"+r).match(/\@\S*\//)){let[t,...i]=r.replace("local://","").split("/"),s=Object.keys(e.lively.FreezerRuntime.registry).find(e=>e.replace("local://","").split("@")[0]==t),l=s&&s.match(/\@[\d|\.|\-|\~]*\//)[0];r="local://"+t+l+i}return r},loadObjectFromPartsbinFolder:t=>e.lively.resources.resource(origin+dynamicPartsDir).join(t+".json").readJson().then(t=>e.lively.morphic.loadMorphFromSnapshot(t,{onDeserializationStart:!1,migrations:[]})),fetchStandaloneFor(e){for(let t in this.globalModules)if(e.match(t.replace("local://","").replace(/\@.*\//,"/").replace("/index.js","")))return this.globalModules[t]},resolveSync(t,r){let i=this.get(t);if(i)return i;if(!t.includes("/")){let r=t.split("."),i=e;for(;i&&r.length;)i=i[r.shift()];if(i)return{executed:!0,exports:i,dependencies:[]}}let s=this.get(this.decanonicalize(t,r));if(s)return{executed:!0,exports:s,dependencies:[]};if(i=this.fetchStandaloneFor(t))return i;throw new Error(`Module ${t} cannot be found in lively.freezer bundle!`)},register(e,t,r){let i=this.add(e,t),s=r((e,t)=>{if("string"==typeof e)i.exports[e]=t;else for(let t in e)i.exports[t]=e[t]});return i.execute=s.execute,i.setters=s.setters,i},updateImports(e){if(e.dependencies)for(let t=0;t<e.dependencies.length;t++){let r=e.dependencies[t],i="@empty"!=r&&this.resolveSync(r,e.id);i&&e.setters[t](i.exports)}},updateDependent(e,t){for(let r=0;r<t.dependencies.length;r++){let i=t.dependencies[r];"@empty"!=i&&e==this.resolveSync(i,t.id)&&t.setters[r](e.exports)}},computeUniqDepGraphs(e){var t=[],r={},i={"@empty":[]},s={"@empty":[]};if(!e){let t={},r=lively.FreezerRuntime.registry;for(let e in r)t[e]=r[e].dependencies;e=t}for(let o in e){r.hasOwnProperty(o)||(r[o]=!0,t.push(o));var l=e[o],n={};if(l){i[o]=[];for(let e of l){if(n.hasOwnProperty(e)||o===e)continue;let l=s[e]||(s[e]=[]);l.includes(o)||l.push(o),n[e]=!0,i[o].push(e),r.hasOwnProperty(e)||(r[e]=!0,t.push(e))}}}return{uniqDepGraph:i,inverseDepGraph:s,dependencies:t}},sortForLoad(e){var t,{dependencies:r,uniqDepGraph:i,inverseDepGraph:s}=this.computeUniqDepGraphs(),l=[],n={};function o(e){return e.split("/")[0]}function u(e){return(i[t]||[]).filter(e=>!a(e)).map(e=>o(e))}function a(e){return"@empty"==e||!!lively.FreezerRuntime.globalModules[e]}function p(e,t,r=new Set){return e==t||!!i[e]&&(i[e].includes(t)||i[e].some(e=>!r.has(e)&&p(e,t,new Set([...r,...i[e]]))))}for(let e=r.length;e--;){if(a(t=r[e]))l.push(t);else{let e=o(t);if(!p(e+"/index.js",t))continue;n[e]?(n[e].modules.push(t),n[e].deps.push(...u())):n[e]={modules:[t],deps:u()}}r.splice(e,1)}let d=r;for(var c in n)n[c].deps=new Set(n[c].deps.filter(e=>e!=c));function h(e,...t){return e.filter(e=>"@empty"!=e&&!e.includes("/index.js")).every(e=>t.some(t=>t.includes(e)))}r=Object.keys(n);let f=[];for(;r.length;){for(var g=1/0,y=[],m=[],v=[],x=0;x<r.length;x++){let e=[...n[b=r[x]].deps];e.length>g||(e.length===g&&h(e,f,y)?(y.push(b),m.push(x)):(g=e.length,h(e,f,y)&&(y=[b],m=[x])))}if(0==y.length)break;for(x=m.length;x--;){var b=r[m[x]];r.splice(m[x],1)}f.push(...y)}let S=r;var z;for(var F of f){for(z=n[F].modules;z.length;){for(g=1/0,y=[],m=[],v=[],x=0;x<z.length;x++){b=z[x];let e=i[b]||[];e.length>g||(e.length===g&&h(e,l,y)?(y.push(b),m.push(x),v.push(...s[b]||[])):(g=e.length,h(e,l,y)&&(y=[b],m=[x],v=(s[b]||[]).slice())))}if(0==y.length)break;for(x=m.length;x--;){s[b=z[m[x]]]=[],z.splice(m[x],1)}for(var b of v)i[b]=i[b].filter(e=>!y.includes(e));l.push(...y)}l.push(...z)}for(var F of(r=d,S))r.push(...n[F].modules);for(;r.length;){for(g=1/0,y=[],m=[],v=[],x=0;x<r.length;x++){b=r[x];let e=i[b]||[];e.length>g||(e.length===g&&h(e,l,y)?(y.push(b),m.push(x),v.push(...s[b]||[])):(g=e.length,h(e,l,y)&&(y=[b],m=[x],v=(s[b]||[]).slice())))}if(0==y.length)break;for(x=m.length;x--;){s[b=r[m[x]]]=[],r.splice(m[x],1)}for(var b of v)i[b]=i[b].filter(e=>!y.includes(e));l.push(...y)}let w=[];for(let e in l)(i[e]||[]).length&&w.push(e);return console.log("async modules due to preserved module structures: ",[...w,...r]),[l,r]},initializeClass(t,r,i=[],s=[],l={},n,o){if(void 0===r)throw Error("Superclass can not be undefined!");return e.System.initializeClass._get=e.lively.classes.runtime.initializeClass._get,e.System.initializeClass._set=e.lively.classes.runtime.initializeClass._set,lively.classes.runtime.initializeClass(t,r,i,s,l,n,o)},load(e){let[t,r]=this.sortForLoad(e),{inverseDepGraph:i}=this.computeUniqDepGraphs(),s=[...t,...r],l=e=>{(i[e.id]||[]).forEach(t=>{let r=this.get(t);try{this.updateDependent(e,r)}catch(t){e.executed=!1}})},n=e=>{for(let t of e){let e=this.get(t);if(e&&!e.executed){e.executed=!0;try{this.updateImports(e),e.execute()}catch(t){e.executed=!1}l(e)}}};for(let e=0;s.some(e=>this.get(e)&&!this.get(e).executed)&&e<5;e++)n(s);return this.get(e).exports}},e.System=e.lively.FreezerRuntime})()
!function(t){"use strict";var r,e=Object.prototype.hasOwnProperty,n="function"==typeof Symbol&&Symbol.iterator||"@@iterator",o="object"==typeof module,i=t.regeneratorRuntime;if(i)o&&(module.exports=i);else{(i=t.regeneratorRuntime=o?module.exports:{}).wrap=h;var a="suspendedStart",c="suspendedYield",u="executing",f="completed",l={},s=d.prototype=y.prototype;v.prototype=s.constructor=d,d.constructor=v,v.displayName="GeneratorFunction",i.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===v||"GeneratorFunction"===(r.displayName||r.name))},i.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):t.__proto__=d,t.prototype=Object.create(s),t},i.awrap=function(t){return new w(t)},g(m.prototype),i.async=function(t,r,e,n){var o=new m(h(t,r,e,n));return i.isGeneratorFunction(r)?o:o.next().then(function(t){return t.done?t.value:o.next()})},g(s),s[n]=function(){return this},s.toString=function(){return"[object Generator]"},i.keys=function(t){var r=[];for(var e in t)r.push(e);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},i.values=E,b.prototype={constructor:b,reset:function(t){if(this.prev=0,this.next=0,this.sent=r,this.done=!1,this.delegate=null,this.tryEntries.forEach(x),!t)for(var n in this)"t"===n.charAt(0)&&e.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=r)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function n(e,n){return a.type="throw",a.arg=t,r.next=e,!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var c=e.call(i,"catchLoc"),u=e.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,r){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&e.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=r&&r<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=r,i?this.next=i.finallyLoc:this.complete(a),l},complete:function(t,r){if("throw"===t.type)throw t.arg;"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=t.arg,this.next="end"):"normal"===t.type&&r&&(this.next=r)},finish:function(t){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),x(e),l}},catch:function(t){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc===t){var n=e.completion;if("throw"===n.type){var o=n.arg;x(e)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,e){return this.delegate={iterator:E(t),resultName:r,nextLoc:e},l}}}function h(t,e,n,o){var i=Object.create((e||y).prototype),s=new b(o||[]);return i._invoke=function(t,e,n){var o=a;return function(i,s){if(o===u)throw new Error("Generator is already running");if(o===f){if("throw"===i)throw s;return j()}for(;;){var h=n.delegate;if(h){if("return"===i||"throw"===i&&h.iterator[i]===r){n.delegate=null;var y=h.iterator.return;if(y){var v=p(y,h.iterator,s);if("throw"===v.type){i="throw",s=v.arg;continue}}if("return"===i)continue}var v=p(h.iterator[i],h.iterator,s);if("throw"===v.type){n.delegate=null,i="throw",s=v.arg;continue}i="next",s=r;var d=v.arg;if(!d.done)return o=c,d;n[h.resultName]=d.value,n.next=h.nextLoc,n.delegate=null}if("next"===i)n._sent=s,n.sent=o===c?s:r;else if("throw"===i){if(o===a)throw o=f,s;n.dispatchException(s)&&(i="next",s=r)}else"return"===i&&n.abrupt("return",s);o=u;var v=p(t,e,n);if("normal"===v.type){o=n.done?f:c;var d={value:v.arg,done:n.done};if(v.arg!==l)return d;n.delegate&&"next"===i&&(s=r)}else"throw"===v.type&&(o=f,i="throw",s=v.arg)}}}(t,n,s),i}function p(t,r,e){try{return{type:"normal",arg:t.call(r,e)}}catch(t){return{type:"throw",arg:t}}}function y(){}function v(){}function d(){}function g(t){["next","throw","return"].forEach(function(r){t[r]=function(t){return this._invoke(r,t)}})}function w(t){this.arg=t}function m(t){function r(r,e){var i=t[r](e),a=i.value;return a instanceof w?Promise.resolve(a.arg).then(n,o):Promise.resolve(a).then(function(t){return i.value=t,i})}"object"==typeof process&&process.domain&&(r=process.domain.bind(r));var e,n=r.bind(t,"next"),o=r.bind(t,"throw");r.bind(t,"return");this._invoke=function(t,n){function o(){return r(t,n)}return e=e?e.then(o,o):new Promise(function(t){t(o())})}}function L(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function x(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function b(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function E(t){if(t){var o=t[n];if(o)return o.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,a=function n(){for(;++i<t.length;)if(e.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=r,n.done=!0,n};return a.next=a}}return{next:j}}function j(){return{value:r,done:!0}}}("object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:this);
//LIVELY.LANG - 100k
!function(){var GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;"undefined"==typeof GLOBAL.lively&&(GLOBAL.lively={}),function(){this.lively=this.lively||{},function(exports){"use strict";function Empty(){return function(){}}function K(){return function(e){return e}}function Null(){return function(){return null}}function False(){return function(){return!1}}function True(){return function(){return!0}}function notYetImplemented(){return function(){throw new Error("Not yet implemented")}}function all(e){var r=[];for(var n in e)e.__lookupGetter__(n)||"function"!=typeof e[n]||r.push(n);return r}function own(e){var r=[];for(var n in e)!e.__lookupGetter__(n)&&e.hasOwnProperty(n)&&"function"==typeof e[n]&&r.push(n);return r}function argumentNames(e){if(e.superclass)return[];var r=e.toString(),n="",t=r.match(/(?:\(([^\)]*)\)|([^\(\)-+!]+))\s*=>/);if(t)n=t[1]||t[2]||"";else{var o=r.match(/^[\s\(]*function[^(]*\(([^)]*)\)/);o&&o[1]&&(n=o[1])}return n.replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",").map(function(e){return e.trim()}).filter(function(e){return!!e})}function qualifiedMethodName(e){var r="";return e.declaredClass?r+=e.declaredClass+">>":e.declaredObject&&(r+=e.declaredObject+"."),r+(e.methodName||e.displayName||e.name||"anonymous")}function extractBody(e){for(var r=String(e).replace(/^function[^\{]+\{\s*/,"").replace(/\}$/,"").trim(),n=r.split(/\n|\r/),t=void 0,o=0;o<n.length;o++){var i=n[o].match(/^(\s+)[^\s]/);i&&(void 0===t||i[1].length<t.length)&&(t=i[1])}return t?r.replace(new RegExp("^"+t,"gm"),""):r}function timeToRun(e){var r=Date.now();return e(),Date.now()-r}function timeToRunN$1(e,r){for(var n=Date.now(),t=0;t<r;t++)e();return(Date.now()-n)/r}function delay(e,r){var n=Array.prototype.slice.call(arguments),t=n.shift(),r=1e3*n.shift();return setTimeout(function(){return t.apply(t,n)},r)}function throttle(e,r){var n,t,o,i,a,u,c=debounce(r,function(){a=i=!1});return function(){n=this,t=arguments;var s=function(){o=null,a&&e.apply(n,t),c()};return o||(o=setTimeout(s,r)),i?a=!0:u=e.apply(n,t),c(),i=!0,u}}function debounce(e,r,n){var t;return function(){var o=this,i=arguments,a=function(){t=null,n||r.apply(o,i)};n&&!t&&r.apply(o,i),clearTimeout(t),t=setTimeout(a,e)}}function throttleNamed(e,r,n){function t(){debounceNamed(e,r,function(){delete o[e]})(),n.apply(this,arguments)}var o=_throttledByName;return o[e]?o[e]:o[e]=throttle(t,r)}function debounceNamed(e,r,n,t){function o(){delete i[e],n.apply(this,arguments)}var i=_debouncedByName;return i[e]?i[e]:i[e]=debounce(r,o,t)}function createQueue(e,r){var n=_queues,t=n[e]||(n[e]={_workerActive:!1,worker:r,tasks:[],drain:null,push:function(e){t.tasks.push(e),t.activateWorker()},pushAll:function(e){e.forEach(function(e){t.tasks.push(e)}),t.activateWorker()},pushNoActivate:function(e){t.tasks.push(e)},handleError:function(e){e&&console.error("Error in queue: "+e)},activateWorker:function(){function r(e){t.handleError(e),t.activateWorker()}var o=t.tasks,i=t._workerActive;if(0===o.length)i&&(t._workerActive=!1,"function"==typeof t.drain&&t.drain()),delete n[e];else{i||(t._workerActive=!0);try{t.worker(o.shift(),r)}catch(e){r(e)}}}});return t}function workerWithCallbackQueue(e,r,n){function t(){l&&clearTimeout(l),c=!0,delete i[e]}function o(r){c||(t(),a.callbacks.forEach(function(n){try{n.apply(null,r)}catch(r){console.error("Error when invoking callbacks in queueUntil ["+e+"]:\n"+String(r.stack||r))}}))}var i=_queueUntilCallbacks,a=i[e],u=!!a;if(u)return a;var c=!1,s=!1;if(n)var l=setTimeout(function(){c||o([new Error("timeout")])},n);return a=i[e]={callbacks:[],cancel:function(){s=!0,t()},whenDone:function(e){return a.callbacks.push(e),a}},setTimeout(function(){if(!s)try{r(function(){o(arguments)})}catch(e){o([e])}},0),a}function _composeAsyncDefaultEndCallback(e,r){e&&console.error("lively.lang.composeAsync error",e)}function composeAsync(){var e,r,n=Array.prototype.slice,t=n.call(arguments),o=_composeAsyncDefaultEndCallback,i=o,a=new Promise(function(n,t){e=n,r=t});return t.reverse().reduce(function(e,u,c){var s=!1;return function(){function l(){s=!0;var t=n.call(arguments),o=t.shift();o?(i(o),r(o)):e.apply(null,t)}var f=n.call(arguments);if(i===o&&c===t.length-1){for(;f.length&&"function"!=typeof f[f.length-1];)f.pop();"function"==typeof f[f.length-1]&&(i=f.pop())}if("function"==typeof u)try{var p=u.apply(this,f.concat([l]));p&&"function"==typeof p.then&&"function"==typeof p.catch&&p.then(function(e){return l(null,e)}).catch(function(e){return l(e)})}catch(e){console.error("composeAsync: ",e.stack||e),s||(i(e),r(e))}else if(u&&"function"==typeof u.then&&"function"==typeof u.catch)u.then(function(e){l(null,e)}).catch(function(e){l(e)});else{var h=new Error("Invalid argument to composeAsync: "+u);i(h),r(h)}return a}},function(){var r=n.call(arguments);i.apply(null,[null].concat(r)),e(r[0])})}function compose(){var e=Array.prototype.slice.call(arguments);return e.reverse().reduce(function(e,r){return function(){return e(r.apply(this,arguments))}},function(e){return e})}function flip(e){return function(){var r=Array.prototype.slice.call(arguments),n=[r[1],r[0]].concat(r.slice(2));return e.apply(null,n)}}function withNull(e){return e=e||function(){},function(){var r=lively.lang.arr.from(arguments);e.apply(null,[null].concat(r))}}function waitFor(e,r,n){var t=Date.now(),o=50;n||(n=r,r=e,e=void 0),function i(){if(r())return n();if(e){var a=Date.now()-t,u=e-a;if(u<=0)return n(new Error("timeout"));u<o&&(o=u)}setTimeout(i,o)}()}function waitForAll(e,r,n){function t(e,r,t,a){if(i.length){var u=null,c=i.indexOf(e);c>-1&&i.splice(c,1),t?(i.length=0,u=new Error("in waitForAll at"+("number"==typeof r?" "+r:"")+": \n"+(t.stack||String(t)))):a&&(o[r]=a),i.length||setTimeout(function(){n(u,o)},0)}}n||(n=r,r=e,e=null),e=e||{};var o=r.map(function(){return null});if(!r.length)return void n(null,o);var i=Array.prototype.slice.call(r);r.forEach(function(e,r){try{e(function(){var n=Array.prototype.slice.call(arguments),o=n.shift();t(e,r,o,n)})}catch(n){t(e,r,n,null)}}),e.timeout&&setTimeout(function(){if(i.length){var e=o.map(function(e,r){return null===e&&r}).filter(function(e){return"number"==typeof e}).join(", "),r=new Error("waitForAll timed out, functions at "+e+" not done");t(null,null,r,null)}},e.timeout)}function curry(e,r,n,t){function o(){return e.apply(this,i.concat(Array.prototype.slice.call(arguments)))}if(arguments.length<=1)return arguments[0];var i=Array.prototype.slice.call(arguments),e=i.shift();return o.isWrapper=!0,o.originalFunction=e,o}function wrap(e,r){var n=e,t=function(){var e=Array.prototype.slice.call(arguments),t=r.isWrapper?e:[n.bind(this)].concat(e);return r.apply(this,t)};return t.isWrapper=!0,t.originalFunction=n,t}function getOriginal(e){for(;e.originalFunction;)e=e.originalFunction;return e}function wrapperChain(e){var r=[];do r.push(e),e=e.originalFunction;while(e);return r}function replaceMethodForOneCall(e,r,n){n.originalFunction=e[r];var t=e.hasOwnProperty(r);return e[r]=function(){return t?e[r]=n.originalFunction:delete e[r],n.apply(this,arguments)},e}function once(e){if(e){if("function"!=typeof e)throw new Error("once() expecting a function");var r,n=!1;return function(){return n?r:(n=!0,r=e.apply(this,arguments))}}}function either(){var e=Array.prototype.slice.call(arguments),r=!1;return e.map(function(e){return function(){if(!r)return r=!0,e.apply(this,arguments)}})}function eitherNamed(e,r){var n=Array.prototype.slice.call(arguments),t=_eitherNameRegistry,e=n.shift(),o=t[e]||(t[e]={wasCalled:!1,callsLeft:0});return o.callsLeft++,function(){if(o.callsLeft--,o.callsLeft<=0&&delete t[e],!o.wasCalled)return o.wasCalled=!0,r.apply(this,arguments)}}function evalJS(src){return eval(src)}function fromString(e){return evalJS("("+e.toString()+");")}function asScript(e,r){return Closure.fromFunction(e,r).recreateFunc()}function asScriptOf(e,r,n,t){var o=n||e.name;if(!o)throw Error("Function that wants to be a script needs a name: "+this);var i=Object.getPrototypeOf(r),a={this:r};if(t&&(a=merge([a,t])),i&&i[o]){var u=function(){try{return Object.getPrototypeOf(r)[o].apply(r,arguments)}catch(e){return"undefined"!=typeof $world?$world.logError(e,"Error in $super call"):console.error("Error in $super call: "+e+"\n"+e.stack),null}};a.$super=Closure.fromFunction(u,{obj:r,name:o}).recreateFunc()}return addToObject(asScript(e,a),r,o)}function addToObject(e,r,n){e.displayName=n;var t=r.attributeConnections?r.attributeConnections.filter(function(e){return"update"===e.getSourceAttrName()}):[];return t&&t.forEach(function(e){e.disconnect()}),r[n]=e,("undefined"==typeof r?"undefined":_typeof(r))&&(e.declaredObject=safeToString(r)),"undefined"!=typeof lively&&r&&lively.Tracing&&lively.Tracing.stackTracingEnabled&&lively.Tracing.instrumentMethod(r,n,{declaredObject:safeToString(r)}),t&&t.forEach(function(e){e.connect()}),e}function binds(e,r){return Closure.fromFunction(e,r||{}).recreateFunc()}function setLocalVarValue(e,r,n){e.hasLivelyClosure&&(e.livelyClosure.funcProperties[r]=n)}function getVarMapping(e){return e.hasLivelyClosure?e.livelyClosure.varMapping:e.isWrapper?e.originalFunction.varMapping:e.varMapping?e.varMapping:{}}function setProperty(e,r,n){e[r]=n,e.hasLivelyClosure&&(e.livelyClosure.funcProperties[r]=n)}function functionNames(e){for(var r=[],n=e.prototype;n;)r=Object.keys(n).reduce(function(e,r){return"function"==typeof n[r]&&e.indexOf(r)===-1&&e.push(r),e},r),n=Object.getPrototypeOf(n);return r}function localFunctionNames(e){return Object.keys(e.prototype).filter(function(r){return"function"==typeof e.prototype[r]})}function logErrors(e,r){var n=function(n){var t=Array.prototype.slice.call(arguments);t.shift();try{return n.apply(e,t)}catch(n){if("undefined"!=typeof lively&&lively.morphic&&lively.morphic.World&&lively.morphic.World.current())throw lively.morphic.World.current().logError(n),n;throw r?console.warn("ERROR: %s.%s(%s): err: %s %s",e,r,t,n,n.stack||""):console.warn("ERROR: %s %s",n,n.stack||""),n}};n.methodName="$logErrorsAdvice";var t=wrap(e,n);return t.originalFunction=e,t.methodName="$logErrorsWrapper",t}function logCompletion(e,r){var n=function(n){var t=Array.prototype.slice.call(arguments);t.shift();try{var o=n.apply(e,t)}catch(e){throw console.warn("failed to load "+r+": "+e),"undefined"!=typeof lively&&lively.lang.Execution&&lively.lang.Execution.showStack(),e}return console.log("completed "+r),o};n.methodName="$logCompletionAdvice::"+r;var t=wrap(e,n);return t.methodName="$logCompletionWrapper::"+r,t.originalFunction=e,t}function logCalls(e,r){var n=e,t=function(t){var i=Array.prototype.slice.call(arguments);return i.shift(),o=t.apply(e,i),r?console.warn("%s(%s) -> %s",qualifiedMethodName(n),i,o):console.log("%s(%s) -> %s",qualifiedMethodName(n),i,o),o};t.methodName="$logCallsAdvice::"+qualifiedMethodName(e);var o=wrap(e,t);return o.originalFunction=e,o.methodName="$logCallsWrapper::"+qualifiedMethodName(e),o}function traceCalls(e,r){var n=function(n){var t=Array.prototype.slice.call(arguments);t.shift(),r.push(t);var o=n.apply(e,t);return r.pop(),o};return wrap(e,n)}function webkitStack(){try{throw new Error}catch(e){return String(e.stack).split(/\n/).slice(2).map(function(e){return e.replace(/^\s*at\s*([^\s]+).*/,"$1")}).join("\n")}}function range(e,r,n){n=n||0;var t=[];if(e<=r){n<=0&&(n=-n||1);for(var o=e;o<=r;o+=n)t.push(o)}else{n>=0&&(n=-n||-1);for(var o=e;o>=r;o+=n)t.push(o)}return t}function withN(e,r){for(var n=new Array(e);e>0;)n[--e]=r;return n}function genN(e,r){for(var n=new Array(e);e>0;)n[--e]=r(e);return n}function filter(e,r,n){return e.filter(r,n)}function findAndGet(e,r){var n;return e.find(function(e,t){return n=r(e,t)}),n}function filterByKey(e,r){return e.filter(function(e){return!!e[r]})}function grep(e,r,n){return"string"==typeof r&&(r=new RegExp(r,"i")),e.filter(r.test.bind(r))}function mask(e,r){return e.filter(function(e,n){return!!r[n]})}function reject(e,r,n){function t(e,t){return!r.call(n,e,t)}return e.filter(t)}function rejectByKey(e,r){return e.filter(function(e){return!e[r]})}function without(e,r){return e.filter(function(e){return e!==r})}function withoutAll(e,r){return e.filter(function(e){return r.indexOf(e)===-1})}function uniq(e,r){if(!e.length)return e;var n=[e[0]];if(r)for(var t=1;t<e.length;t++){var o=e[t];o!==n[n.length]&&n.push(o)}else for(var i=1;i<e.length;i++){var a=e[i];n.indexOf(a)===-1&&n.push(a)}return n}function uniqBy(e,r,n){for(var t=e.slice(),o=t.length;o--;)for(var i=e[o],a=o+1;a<t.length;a++)r.call(n,i,t[a])&&t.splice(a--,1);return t}function uniqByKey(e,r){for(var n={},t=[],o=0;o<e.length;o++){var i=e[o];n[i[r]]||(n[i[r]]=!0,t.push(i))}return t}function compact(e){return e.filter(Boolean)}function mutableCompact(e){for(var r=0,n=0,t=e.length;r<t;)e.hasOwnProperty(r)&&(e[n++]=e[r]),r++;for(;n++<t;)e.pop();return e}function forEach$1(e,r,n){return e.forEach(r,n)}function zip(){var e=Array.from(arguments),r=e.shift(),n="function"==typeof last(e)?e.pop():function(e){return e},t=[r].concat(e).map(function(e){return Array.from(e)});return r.map(function(e,r){return n(pluck(t,r),r)})}function flatten(e,r){if("number"==typeof r){if(r<=0)return e;r--}return e.reduce(function(e,n){return e.concat(Array.isArray(n)?flatten(n,r):[n])},[])}function flatmap(e,r,n){for(var t=[],o=0;o<e.length;o++)t.push.apply(t,r.call(n,e[o],o));return t}function interpose(e,r){return e.reduce(function(e,n){return e.length>0&&e.push(r),e.push(n),e},[])}function delimWith(e,r){return interpose(e,r)}function map$1(e,r,n){return e.map(r,n)}function invoke(e,r,n,t,o,i,a,u){return e.map(function(e){return e[r](n,t,o,i,a,u)})}function pluck(e,r){return e.map(function(e){return e[r]})}function reduce(e,r,n,t){return e.reduce(r,n,t)}function reduceRight(e,r,n,t){return e.reduceRight(r,n,t)}function some(e,r,n){return e.some(r,n)}function every(e,r,n){return e.every(r,n)}function equals$2(e,r){var n=e.length;if(!r||n!==r.length)return!1;for(var t=0;t<n;t++){if(e[t]&&r[t]&&e[t].equals&&r[t].equals){if(e[t].equals(r[t]))continue;return!1}if(e[t]!=r[t])return!1}return!0}function deepEquals(e,r){var n=e.length;if(!r||n!==r.length)return!1;for(var t=0;t<n;t++)if(!equals$1(e[t],r[t]))return!1;return!0}function isSorted(e,r){if(r){for(var n=1;n<e.length;n++)if(e[n-1]<e[n])return!1}else for(var n=1;n<e.length;n++)if(e[n-1]>e[n])return!1;return!0}function sort(e,r){return e.sort(r)}function sortBy(e,r,n){return pluck(e.map(function(e,t){return{value:e,criteria:r.call(n,e,t)}}).sort(function(e,r){var n=e.criteria,t=r.criteria;return n<t?-1:n>t?1:0}),"value")}function sortByKey(e,r){return sortBy(e,function(e){return e[r]})}function reverse(e){return e.reverse()}function reversed(e){return e.slice().reverse()}function reMatches$1(e,r,n){return n=n||String,e.map(function(e){return n(e).match(r)})}function first(e){return e[0]}function last(e){return e[e.length-1]}function intersect(e,r){return uniq(e).filter(function(e){return r.indexOf(e)>-1})}function union(e,r){for(var n=e.slice(),t=0;t<r.length;t++){var o=r[t];n.indexOf(o)===-1&&n.push(o)}return n}function pushAt(e,r,n){e.splice(n,0,r)}function removeAt(e,r){e.splice(r,1)}function remove(e,r){var n=e.indexOf(r);return n>=0&&removeAt(e,n),r}function pushAll$1(e,r){return e.push.apply(e,r),e}function pushAllAt(e,r,n){e.splice.apply(e,[n,0].concat(r))}function pushIfNotIncluded(e,r){e.includes(r)||e.push(r)}function replaceAt(e,r,n){e.splice(n,1,r)}function clear(e){return e.length=0,e}function isSubset(e,r){for(var n=0;n<e.length;n++)if(!r.includes(e[n]))return!1;return!0}function doAndContinue(e,r,n,t){return n=n||Null,t=t||GLOBAL$1,r=r||function(e,r,n){r.call(t,e,n)},e.reduceRight(function(e,n,o){return function(){r.call(t,e,n,o)}},n)()}function nestedDelay(e,r,n,t,o,i){return t=t||function(){},e.clone().reverse().reduce(function(e,t,a){return function(){r.call(o||GLOBAL$1,t,a),i&&a%i!==0?e():e.delay(n)}},t)()}function forEachShowingProgress(){var e,r,n,t,o,i=Array.from(arguments),a=i.shift(),u=a.length,c=!1;if(1===i.length?(e=i[0].progressBar,r=i[0].iterator,n=i[0].labelFunction,t=i[0].whenDone,o=i[0].context):(e=i[0],r=i[1],n=i[2],t=i[3],o=i[4]),o||(o="undefined"!=typeof window?window:global),n||(n=function(e){return e}),!e){c=!0;var s="undefined"!=typeof window?window:global,l=s.lively&&lively.morphic&&lively.morphic.World.current();e=l?l.addProgressBar():{setValue:function(e){},setLabel:function(){},remove:function(){}}}return e.setValue(0),a.reduceRight(function(t,i,a){return function(){try{e.setValue(a/u),n&&e.setLabel(n.call(o,i,a)),r.call(o,i,a)}catch(e){console.error("Error in forEachShowingProgress at %s (%s)\n%s\n%s",a,i,e,e.stack)}t.delay(0)}},function(){e.setValue(1),c&&function(){e.remove()}.delay(0),t&&t.call(o)})(),a}function swap(e,r,n){r<0&&(r=e.length+r),n<0&&(n=e.length+n);var t=e[r];return e[r]=e[n],e[n]=t,e}function rotate(e,r){return r=r||1,e.slice(r).concat(e.slice(0,r))}function groupBy(e,r,n){return Group.fromArray(e,r,n)}function groupByKey(e,r){return groupBy(e,function(e){return e[r]})}function partition(e,r,n){r=r||function(e){return e};var t=[],o=[];return e.forEach(function(e,i){(r.call(n,e,i)?t:o).push(e)}),[t,o]}function batchify(e,r,n){function t(e,o){if(!o.length)return[e,[]];var i=o[0],a=o.slice(1),u=e.concat([i]);if(r.call(n,u))return t(u,a);var c=t(e,a);return[c[0],[i].concat(c[1])]}function o(e,r){if(!r.length)return e;var n=t([],r);if(!n[0].length)throw new Error("Batchify constrained does not ensure consumption of at least one item per batch!");return o(e.concat([n[0]]),n[1])}return o([],e)}function toTuples(e,r){return r=r||1,range(0,Math.ceil(e.length/r)-1).map(function(n){return e.slice(n*r,n*r+r)},e)}function combinationsPick(e,r){for(var n=e.map(function(e,n){return e[r[n]]}),t=r.slice(),o=e.length;o--;o>=0){var i=e[o],a=t[o]+1;if(i[a]){t[o]=a;break}if(0===o){t=void 0;break}t[o]=0}return[n,t]}function combinations(e){for(var r=e.reduce(function(e,r){return e*r.length},1),n=e.map(function(e){return 0}),t=new Array(r),o=0;o<r;o++){var i=combinationsPick(e,n);t[o]=i[0],n=i[1]}return t}function take(e,r){return e.slice(0,r)}function drop(e,r){return e.slice(r)}function takeWhile(e,r,n){for(var t=0;t<e.length&&r.call(n,e[t],t);t++);return e.slice(0,t)}function dropWhile(e,r,n){for(var t=0;t<e.length&&r.call(n,e[t],t);t++);return e.slice(t)}function shuffle(e){for(var r=range(0,e.length-1),n=Array(e.length),t=0;t<e.length;t++){var o=r.splice(Math.round(Math.random()*(r.length-1)),1);n[o]=e[t]}return n}function max(e,r,n){r=r||function(e){return e};var t;return e.reduce(function(e,o,i){var a=r.call(n,o,i);return"number"!=typeof a||a<=e?e:(t=o,a)},-(1/0)),t}function min(e,r,n){return r=r||function(e){return e},max(e,function(e,t){return-r.call(n,e,t)})}function sum(e){for(var r=0,n=0;n<e.length;n++)r+=e[n];return r}function count$1(e,r){return e.reduce(function(e,n){return n===r?e+1:e},0)}function size$1(e){return e.length}function histogram(e,r){if("undefined"==typeof r||"number"==typeof r){var n=r||function(){return Math.ceil(Math.log(e.length)/Math.log(2)+1)}(e),t=Math.ceil(Math.round(e.length/n));return range(0,n-1).map(function(r){return e.slice(r*t,(r+1)*t)})}if(r instanceof Array){var o=r;return e.reduce(function(e,r){if(r<o[1])return e[0].push(r),e;for(var n=1;n<o.length;n++)if(r>=o[n]&&(!o[n+1]||r<=o[n+1]))return e[n].push(r),e;throw new Error("Histogram creation: Cannot group data "+r+" into thresholds "+o)},range(1,o.length).map(function(){return[]}))}}function clone$1(e){return[].concat(e)}function toArray$3(e){return from(e)}function each(e,r,n){return e.forEach(r,n)}function all$1(e,r,n){return e.every(r,n)}function any(e,r,n){return e.some(r,n)}function collect(e,r,n){return e.map(r,n)}function findAll(e,r,n){return e.filter(r,n)}function inject(e,r,n,t){return t&&(n=n.bind(t)),e.reduce(n,r)}function mapAsyncSeries(e,r,n){function t(e,r){if(!i&&(e||r)){i=!0;try{n(e,o)}catch(e){console.error("Error in mapAsyncSeries - callback invocation error:\n"+(e.stack||e))}}}var o=[],i=!1;return e.reduceRight(function(e,n,a){if(!i)return function(i,u){if(i)return t(i);a>0&&o.push(u);try{r(n,a,once(e))}catch(e){t(e)}}},function(e,r){o.push(r),t(e,!0)})()}function mapAsync(e,r,n,t){function o(){for(;l<r.parallel&&s<e.length;)f[s++]()}function i(r,n){if(!(u.indexOf(r)>-1||(u.push(r),l--,c))){if(!n&&u.length<e.length)return void o();c=!0;try{t&&t(n,a)}catch(e){console.error("Error in mapAsync - main callback invocation error:\n"+(e.stack||e))}}}if("function"==typeof r&&(t=n,n=r,r=null),r=r||{},!e.length)return t&&t(null,[]);r.parallel||(r.parallel=1/0);var a=[],u=[],c=!1,s=0,l=0,f=e.map(function(e,r){return function(){l++;try{n(e,r,once(function(e,n){a[r]=e||n,i(r,e)}))}catch(e){i(r,e)}}});return o()}function print$1(e){if(e&&Array.isArray(e))return"["+e.map(print$1)+"]";if("string"!=typeof e)return String(e);var r=String(e);return r=r.replace(/\n/g,"\\n\\\n"),r=r.replace(/(")/g,"\\$1"),r='"'+r+'"'}function indent$1(e,r,n){if(!n||n<=0)return e;for(;n>0;)n--,e=r+e;return e}function isArray$$1(e){return Array.isArray(e)}function isElement(e){return e&&1==e.nodeType}function isFunction(e){return e instanceof Function}function isBoolean(e){return"boolean"==typeof e}function isString(e){return"string"==typeof e}function isNumber(e){return"number"==typeof e}function isUndefined(e){return"undefined"==typeof e}function isRegExp(e){return e instanceof RegExp}function isObject(e){return"object"==("undefined"==typeof e?"undefined":_typeof(e))}function isPrimitive(e){if(!e)return!0;switch("undefined"==typeof e?"undefined":_typeof(e)){case"string":case"number":case"boolean":return!0}return!1}function isEmpty(e){for(var r in e)if(e.hasOwnProperty(r))return!1;return!0}function equals$1(e,r){if(e===r)return!0;if(!e||!r)return e==r;if(Array.isArray(e))return deepEquals(e,r);switch(e.constructor){case String:case Date:case Boolean:case Number:return e==r}if("function"==typeof e.isEqualNode)return e.isEqualNode(r);if("function"==typeof e.equals)return e.equals(r);var n=[];for(var t in e)if(n.push(t),"function"!=typeof e[t]&&!equals$1(e[t],r[t]))return!1;for(var t in r)if(n.indexOf(t)===-1&&"function"!=typeof r[t]&&!equals$1(r[t],e[t]))return!1;return!0}function values(e){return e?Object.keys(e).map(function(r){return e[r]}):[]}function select(e,r){for(var n={},t=0;t<r.length;t++)n[r[t]]=e[r[t]];return n}function dissoc(e,r){e=e||{};for(var n=getOwnPropertyDescriptors(e),t=0;t<r.length;t++)r[t]in n&&delete n[r[t]];return Object.defineProperties({},n)}function addScript(e,r,n,t){var o=fromString(r);return asScriptOf(o,e,n,t)}function extend(e,r){for(var n=null,t=1;t<arguments.length;t++)if("string"!=typeof arguments[t]){var r=arguments[t];for(var o in r){var i=r.__lookupGetter__(o),a=r.__lookupSetter__(o);if(i&&e.__defineGetter__(o,i),a&&e.__defineSetter__(o,a),!i&&!a){var u=r[o];e[o]=u,n&&n.push(o),"function"==typeof u&&(u.displayName||(u.displayName=o),"undefined"!=typeof lively&&lively.Module&&lively.Module.current&&(u.sourceModule=lively.Module.current()))}}}else{var c=arguments[t];e.categories||(e.categories={}),e.categories[c]||(e.categories[c]=[]),n=e.categories[c]}return e}function clone$$1(e){if(isPrimitive(e))return e;if(Array.isArray(e))return Array.prototype.slice.call(e);var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}function extract(e,r,n){for(var t={},o=0;o<r.length;o++)r[o]in e&&(t[r[o]]=n?n(r[o],e[r[o]]):e[r[o]]);return t}function inspect(e,r,n){if(r=r||{},n=n||0,r.customPrinter){var t=r._ignoreSignal||(r._ignoreSignal={}),o=function(e){return inspect(e,r,n+1)},i=r.customPrinter(e,t,o);if(i!==t)return i}if(!e)return print$1(e);if("function"==typeof e)return r.printFunctionSource?String(e):"function"+(e.name?" "+e.name:"")+"("+argumentNames(e).join(",")+") {/*...*/}";switch(e.constructor){case String:case Boolean:case RegExp:case Number:return print$1(e)}if("function"==typeof e.serializeExpr)return e.serializeExpr();var a=e&&Array.isArray(e),u=a?"[":"{",c=a?"]":"}";if(r.maxDepth&&n>=r.maxDepth)return u+"/*...*/"+c;var s=[];if(a)s=e.map(function(e){return inspect(e,r,n+1)});else for(var l=Object.keys(e).sort(function(r,n){var t="function"==typeof e[r],o="function"==typeof e[n];return t===o?r<n?-1:r>n?1:0:t?1:-1}),f=0;f<l.length;f++){if(f>(r.maxNumberOfKeys||1/0)){var p=l.length-f;s.push("..."+p+" hidden "+(p>1?"entries":"entry")+"...");break}var h=l[f];a&&inspect(e[h],r,n+1);var d=inspect(e[h],r,n+1);s.push((r.escapeKeys?JSON.stringify(h):h)+": "+d)}if(0===s.length)return u+c;var g=s.join(", "),y=(!a||r.newLineInArrays)&&(!r.minLengthForNewLine||g.length>=r.minLengthForNewLine),m=indent$1("",r.indent||"  ",n),v=indent$1("",r.indent||"  ",n+1),w=y&&!a?"\n"+v:"",b=y?"\n"+v:"",k=y&&!a?"\n"+m:"";return y&&(g=s.join(","+b)),u+w+g+k+c}function merge(e){return arguments.length>1?merge(Array.prototype.slice.call(arguments)):Array.isArray(e[0])?Array.prototype.concat.apply([],e):e.reduce(function(e,r){for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n]);return e},{})}function deepMerge(e,r){if(!e)return r;if(!r)return e;if(Array.isArray(e)){if(!Array.isArray(r))return r;var n=e.map(function(e,n){return deepMerge(e,r[n])});return r.length>e.length&&(n=n.concat(r.slice(e.length))),n}return"object"!==("undefined"==typeof e?"undefined":_typeof(e))||"object"!==("undefined"==typeof r?"undefined":_typeof(r))?r:Object.keys(e).concat(Object.keys(r)).reduce(function(n,t){return e[t]?r[t]?"object"!==_typeof(e[t])||"object"!==_typeof(r[t])?n[t]=r[t]:n[t]=deepMerge(e[t],r[t]):n[t]=e[t]:n[t]=r[t],n},{})}function sortKeysWithBeforeAndAfterConstraints(e){var r=(arguments.length>1&&void 0!==arguments[1]&&arguments[1],[]),n=[],t=[];for(var o in e){var i=e[o],a=i.hasOwnProperty("before")?i.before:i.before=[],u=i.hasOwnProperty("after")?i.after:i.after=[];r.push(o),n.push(i);for(var c=a.length;c--;){var s=a[c],l=e[s];l?(l.hasOwnProperty("after")||(l.after=[]),l.after.push(o)):(console.warn("[initializeProperties] "+this+" sortProperties: "+("Property "+o+" requires to be initialized before "+s+" ")+"but that property cannot be found."),a.splice(c,1))}for(var f=u.length;f--;){var p=u[f],h=e[p];h||(console.warn("[initializeProperties] "+this+" sortProperties: "+("Property "+o+" requires to be initialized after "+p+" ")+"but that property cannot be found."),u.splice(f,1))}t.push(o)}for(var d=[],g=[],y=t.length+1;t.length;){if(y===t.length)throw new Error("Circular dependencies in handler order, could not resolve properties "+t.map(function(r){var n=e[r].before,t=e[r].after;if(!(n&&n.length||t&&t.length))return"";var o=r+"\n";return n&&n.length&&(o+="  - before "+n.join(",")+"\n"),t&&t.length&&(o+="  - after "+t.join(",")+"\n"),o}).join(""));y=t.length;for(var m=[],v=t.length;v--;){var w=t[v];isSubset(e[w].after,g)&&(t.splice(v,1),g.push(w),m.push(w))}d.push(m)}return flatten(d,1)}function inherit(e){return Object.create(e)}function valuesInPropertyHierarchy(e,r){for(var n=[],t=e;t;)t.hasOwnProperty(r)&&n.unshift(t[r]),t=Object.getPrototypeOf(t);return n}function mergePropertyInHierarchy(e,r){return merge(valuesInPropertyHierarchy(e,r))}function deepCopy(e){if(!e||"object"!==("undefined"==typeof e?"undefined":_typeof(e))||e instanceof RegExp)return e;var r=Array.isArray(e)?Array(e.length):{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=deepCopy(e[n]));return r}function typeStringOf(e){return null===e?"null":"undefined"==typeof e?"undefined":e.constructor.name}function shortPrintStringOf(e){function r(e,r,t,o){e.constructor.name===r&&(n+=t,(e.length||Object.keys(e).length)&&(n+="..."),n+=o)}if(!isMutableType(e))return safeToString(e);if("Object"!==e.constructor.name&&!Array.isArray(e)&&e.constructor.name)return e.constructor.name?e.constructor.name:Object.prototype.toString.call(e).split(" ")[1].split("]")[0];var n="";return r(e,"Object","{","}"),r(e,"Array","[","]"),n}function isMutableType(e){var r=["null","undefined","Boolean","Number","String"];return r.indexOf(typeStringOf(e))===-1}function safeToString(e){try{return(e?e.toString():String(e)).replace("\n","")}catch(e){return"<error printing object>"}}function asObject(e){switch("undefined"==typeof e?"undefined":_typeof(e)){case"string":return new String(e);case"boolean":return new Boolean(e);case"number":return new Number(e);default:return e}}function newKeyIn(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"_",t=1;do r=n+"-"+t++;while(r in e);return r}function format(){return formatFromArray(Array.prototype.slice.call(arguments))}function formatFromArray(e){function r(e,r){return""+e}function n(e,r){return e.toString()}function t(e,r,n){return n>-1?e.toFixed(n):e.toString()}function o(e,r){return inspect(e)}function i(e){for(var r=[],n=c.exec(e);n;n=c.exec(e)){var t=n[8]||n[5],i=t in u?u[t]:o,a=n[3]?parseInt(n[3]):"."==n[4]?-1:0;r.push(e.substr(0,"%"==n[0][0]?n.index:n.index+1)),r.push({appender:i,precision:a}),e=e.substr(n.index+n[0].length)}return e&&r.push(e.toString()),r}var a=e.shift();a||console.log("Error in Strings>>formatFromArray, first arg is undefined");for(var u={s:r,d:n,i:n,f:t,o:o},c=/((^%|[^\\]%)(\d+)?(\.)([a-zA-Z]))|((^%|[^\\]%)([a-zA-Z]))/,s=i(a),l="",f=0,p=0;p<s.length;++p){var h=s[p];if(h&&"object"==("undefined"==typeof h?"undefined":_typeof(h))){var d=e[f++];l+=(h.appender||r)(d,l,h.precision)}else l+=r(h,l)}return l}function indent(e,r,n){if(!n||n<=0)return e;for(var t="";n>0;)n--,t+=r;return lines(e).map(function(e){return t+e}).join("\n")}function minIndent(e,r){r||(r="  ");var n=new RegExp("^("+r+")*","gm");return min(e.match(n).map(function(e){return Math.floor(e.length/r.length)}))}function changeIndent(e,r,n){r||(r="  "),n||(n=0);var t=minIndent(e,r);if(t===n)return e;if(t<n)return indent(e,r,n-t);var o=r.repeat(t-n);return lines(e).map(function(e){return e.slice(o.length)}).join("\n")}function quote(e){return'"'+e.replace(/"/g,'\\"')+'"'}function print(e){if(e&&Array.isArray(e))return"["+e.map(print)+"]";if("string"!=typeof e)return String(e);var r=String(e);return r=r.replace(/\n/g,"\\n\\\n"),r=r.replace(/(")/g,"\\$1"),r='"'+r+'"'}function printNested(e,r){return r=r||0,e.reduce(function(e,n){return e+=Array.isArray(n)?printNested(n,r+1):indent(n+"\n","  ",r)},"")}function pad(e,r,n){return n?" ".repeat(r)+e:e+" ".repeat(r)}function printTable(e,r){function n(e){return!i&&(!!a||r&&Array.isArray(r.align)&&"right"===r.align[e])}var t=[],o=r&&r.separator||" ",i=!r||!r.align||"left"===r.align,a=r&&"right"===r.align;return e.forEach(function(e){e.forEach(function(e,r){void 0===t[r]&&(t[r]=0),t[r]=Math.max(t[r],String(e).length)})}),e.map(function(e){return e.map(function(e,r){var o=String(e);return pad(o,t[r]-o.length,n(r))}).join(o)}).join("\n")}function printTree(e,r,n,t){function o(e,a,u){i[a]=t.repeat(e)+r(u,e);var c=n(u,e),s=a+1;if(!c||!c.length)return s;var l=s,f=c.length-1;return c.forEach(function(r,n){s=o(e+1,s,r);for(var a=f===n,u=i[l].split(""),c=e*t.length+1,p=e*t.length+t.length,n=c;n<p;n++)u[n]="-";a&&(u[e*t.length]="\\"),i[l]=u.join(""),a||i.slice(l,s).forEach(function(r,n){var o=r.split("");o[e*t.length]="|",i[l+n]=o.join("")}),l=s}),s}var i=[];return t=t||"  ",o(0,0,e),i.join("\n")}function toArray$1(e){return e.split("")}function lines(e){return e.split(/\n\r?/)}function paragraphs(e,r){function n(e){return/^\s*$/.test(e)}var t=r?r.sep:"\n\n";return r&&r.keepEmptyLines?e.split("\n").concat("").reduce(function(e,r){var t=e[0],o=e[1];return n(o)===n(r)?o+="\n"+r:(o.length&&t.push(o),o=r),[t,o]},[[],""])[0]:e.split(new RegExp(t+"+"))}function nonEmptyLines(e){return lines(e).compact()}function tokens(e,r){return e.split(r||/\s+/).filter(function(e){return!/^\s*$/.test(e)})}function tableize(e,r){r=r||{};for(var n=r.cellSplitter||/\s+/,t=/^\s*$/,o=!r.hasOwnProperty("convertTypes")||!!r.convertTypes,i=lines(e),a=[],u=0;u<i.length;u++){var c=tokens(i[u],n);o&&(c=c.map(function(e){if(e.match(t))return e;var r=Number(e);if(!isNaN(r))return r;var n=new Date(e);return isNaN(+n)?e.trim():n})),c.length>0&&a.push(c)}return a}function unescapeCharacterEntities(e){
if("undefined"==typeof document)throw new Error("Cannot unescapeCharacterEntities");var r=document.createElement("div");return r.innerHTML=e,r.textContent}function toQueryParams(e,r){var n=e.trim().match(/([^?#]*)(#.*)?$/);if(!n)return{};var t=n[1].split(r||"&").inject({},function(e,r){if((r=r.split("="))[0]){var n=decodeURIComponent(r.shift()),t=r.length>1?r.join("="):r[0];void 0!=t&&(t=decodeURIComponent(t)),n in e?(Array.isArray(e[n])||(e[n]=[e[n]]),e[n].push(t)):e[n]=t}return e});return t}function normalizePath$1(e){var r=e.match(urlStartRe),n=r?r[0]:null,t=n?e.slice(n.length):e;do e=t,t=e.replace(pathDoubleDotRe,"");while(t!=e);return t=t.replace(pathDoubleSlashRe,"$1/"),t=t.replace(pathDotRe,"/"),n&&(t=n+t),t}function joinPath(){return normalizePath$1(Array.prototype.slice.call(arguments).reduce(function(e,r){return"string"==typeof r?e.replace(/\/*$/,"")+"/"+r.replace(/^\/*/,""):e}))}function newUUID(){return newUUIDTemplate.replace(newUUIDRe,newUUIDReplacer).toUpperCase()}function createDataURI(e,r){return r=r||"text/plain","data:"+r+";base64,"+btoa(e)}function hashCode(e){var r=0,n=e.length;if(0==n)return r;for(var t=0;t<n;t++){var o=e.charCodeAt(t);r=(r<<5)-r+o,r&=r}return r}function md5(e){function r(e,r,n,t,o,i){return r=f(f(r,e),f(t,i)),f(r<<o|r>>>32-o,n)}function n(e,n,t,o,i,a,u){return r(n&t|~n&o,e,n,i,a,u)}function t(e,n,t,o,i,a,u){return r(n&o|t&~o,e,n,i,a,u)}function o(e,n,t,o,i,a,u){return r(n^t^o,e,n,i,a,u)}function i(e,n,t,o,i,a,u){return r(t^(n|~o),e,n,i,a,u)}function a(e,r){var a=e[0],u=e[1],c=e[2],s=e[3];a=n(a,u,c,s,r[0],7,-680876936),s=n(s,a,u,c,r[1],12,-389564586),c=n(c,s,a,u,r[2],17,606105819),u=n(u,c,s,a,r[3],22,-1044525330),a=n(a,u,c,s,r[4],7,-176418897),s=n(s,a,u,c,r[5],12,1200080426),c=n(c,s,a,u,r[6],17,-1473231341),u=n(u,c,s,a,r[7],22,-45705983),a=n(a,u,c,s,r[8],7,1770035416),s=n(s,a,u,c,r[9],12,-1958414417),c=n(c,s,a,u,r[10],17,-42063),u=n(u,c,s,a,r[11],22,-1990404162),a=n(a,u,c,s,r[12],7,1804603682),s=n(s,a,u,c,r[13],12,-40341101),c=n(c,s,a,u,r[14],17,-1502002290),u=n(u,c,s,a,r[15],22,1236535329),a=t(a,u,c,s,r[1],5,-165796510),s=t(s,a,u,c,r[6],9,-1069501632),c=t(c,s,a,u,r[11],14,643717713),u=t(u,c,s,a,r[0],20,-373897302),a=t(a,u,c,s,r[5],5,-701558691),s=t(s,a,u,c,r[10],9,38016083),c=t(c,s,a,u,r[15],14,-660478335),u=t(u,c,s,a,r[4],20,-405537848),a=t(a,u,c,s,r[9],5,568446438),s=t(s,a,u,c,r[14],9,-1019803690),c=t(c,s,a,u,r[3],14,-187363961),u=t(u,c,s,a,r[8],20,1163531501),a=t(a,u,c,s,r[13],5,-1444681467),s=t(s,a,u,c,r[2],9,-51403784),c=t(c,s,a,u,r[7],14,1735328473),u=t(u,c,s,a,r[12],20,-1926607734),a=o(a,u,c,s,r[5],4,-378558),s=o(s,a,u,c,r[8],11,-2022574463),c=o(c,s,a,u,r[11],16,1839030562),u=o(u,c,s,a,r[14],23,-35309556),a=o(a,u,c,s,r[1],4,-1530992060),s=o(s,a,u,c,r[4],11,1272893353),c=o(c,s,a,u,r[7],16,-155497632),u=o(u,c,s,a,r[10],23,-1094730640),a=o(a,u,c,s,r[13],4,681279174),s=o(s,a,u,c,r[0],11,-358537222),c=o(c,s,a,u,r[3],16,-722521979),u=o(u,c,s,a,r[6],23,76029189),a=o(a,u,c,s,r[9],4,-640364487),s=o(s,a,u,c,r[12],11,-421815835),c=o(c,s,a,u,r[15],16,530742520),u=o(u,c,s,a,r[2],23,-995338651),a=i(a,u,c,s,r[0],6,-198630844),s=i(s,a,u,c,r[7],10,1126891415),c=i(c,s,a,u,r[14],15,-1416354905),u=i(u,c,s,a,r[5],21,-57434055),a=i(a,u,c,s,r[12],6,1700485571),s=i(s,a,u,c,r[3],10,-1894986606),c=i(c,s,a,u,r[10],15,-1051523),u=i(u,c,s,a,r[1],21,-2054922799),a=i(a,u,c,s,r[8],6,1873313359),s=i(s,a,u,c,r[15],10,-30611744),c=i(c,s,a,u,r[6],15,-1560198380),u=i(u,c,s,a,r[13],21,1309151649),a=i(a,u,c,s,r[4],6,-145523070),s=i(s,a,u,c,r[11],10,-1120210379),c=i(c,s,a,u,r[2],15,718787259),u=i(u,c,s,a,r[9],21,-343485551),e[0]=f(a,e[0]),e[1]=f(u,e[1]),e[2]=f(c,e[2]),e[3]=f(s,e[3])}function u(e){var r,n=e.length,t=[1732584193,-271733879,-1732584194,271733878];for(r=64;r<=n;r+=64)a(t,c(e.substring(r-64,r)));e=e.substring(r-64);var o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=e.length;for(r=0;r<i;r++)o[r>>2]|=e.charCodeAt(r)<<(r%4<<3);if(o[r>>2]|=128<<(r%4<<3),r>55)for(a(t,o),r=16;r--;)o[r]=0;return o[14]=8*n,a(t,o),t}function c(e){var r,n=[];for(r=0;r<64;r+=4)n[r>>2]=e.charCodeAt(r)+(e.charCodeAt(r+1)<<8)+(e.charCodeAt(r+2)<<16)+(e.charCodeAt(r+3)<<24);return n}function s(e){for(var r="",n=0;n<4;n++)r+=p[e>>8*n+4&15]+p[e>>8*n&15];return r}function l(e){for(var r=e.length,n=0;n<r;n++)e[n]=s(e[n]);return e.join("")}var f=function(e,r){var n=(65535&e)+(65535&r),t=(e>>16)+(r>>16)+(n>>16);return t<<16|65535&n},p="0123456789abcdef".split("");return l(u(e))}function reMatches$$1(e,r){var n=[];return e.replace(r,function(e,r){n.push({match:e,start:r,end:r+e.length})}),n}function stringMatch(e,r,n){function t(e,r,n,t,o){return t=t||0,o=o||0,[e.slice(0,r),e.slice(r+t,n-o),e.slice(n)]}function o(e,r){if(r.constructor!==RegExp){var n=e.indexOf(r);if(0===n)return{match:r,rest:e.slice(r.length)};for(var t=0;t<r.length;t++)if(r[t]!=e[t])return{match:null,pos:t};return{match:null}}var o=reMatches$$1(e,r);return o&&o.length&&0===o[0].start?{match:o[0].match,rest:e.slice(o[0].end)}:{match:null}}function i(e,r){for(var n=0,t=0;t<r.length;t++){var i=r[t],a=o(e,i);if(!a.match)return{matched:!1,pos:n+(a.pos||0),pattern:i};n+=a.match.length,e=a.rest}return e.length?{matched:!1,pos:n}:{matched:!0}}function a(e){var r=reMatches$$1(e,/__\//g),n=reMatches$$1(e,/\/__/g);if(r.length!==n.length)throw new Error("pattern invalid: "+e+" cannot be split into __/.../__ embedded RegExps\nstarts: "+JSON.stringify(r)+"\nvs ends:\n"+JSON.stringify(n));var o=0;return r.reduce(function(e,r,i){var a=n[i],u=e.pop(),c=t(u,r.start-o,a.end-o,3,3);c[0].length&&(e.push(c[0]),o+=c[0].length);try{c[1].length&&(e.push(new RegExp(c[1])),o+=c[1].length+3+3)}catch(e){throw new Error("Cannot create pattern re from: "+inspect(c))}return c[2].length&&e.push(c[2]),e},[e])}function u(e,r){var n=a(r),t=i(e,n);return t.matched?t:(t.error=e.slice(0,t.pos)+"<--UNMATCHED-->"+e.slice(t.pos),t)}return n=n||{},n.normalizeWhiteSpace&&(e=e.replace(/\s+/g," ")),n.ignoreIndent&&(e=e.replace(/^\s+/gm,""),r=r.replace(/^\s+/gm,"")),e==r?{matched:!0}:u(e,r)}function peekRight(e,r,n){if(e=e.slice(r),"string"==typeof n){var t=e.indexOf(n);return t===-1?null:t+r}if(n.constructor===RegExp){var o=reMatches$$1(e,n);return o[0]?o[0].start:null}return null}function peekLeft(e,r,n){if(e=e.slice(0,r),"string"==typeof n){var t=e.lastIndexOf(n);return t===-1?null:t}if(n.constructor===RegExp){var o=reMatches$$1(e,n);return last(o)?last(o).start:null}return null}function lineIndexComputer(e){var r=lineRanges(e);return function(e){for(var n=0;n<r.length;n++){var t=r[n];if(e>=t[0]&&e<t[1])return n}return-1}}function lineNumberToIndexesComputer(e){return function(r){return lineRanges(e)[r]}}function lineRanges(e){for(var r=0,n=0,t=lines(e),o=[],i=0;i<t.length;i++){var a=t[i];n=r+a.length+1,o.push([r,n]),r=n}return o}function findLineWithIndexInLineRanges(e,r){var n=e.length;if(0===n)return-1;for(var t=0,o=n;;){var i=t+Math.floor((o-t)/2),a=slicedToArray(e[i],2),u=a[0],c=a[1];if(r<u){if(0===i)return-1;o=i}else{if(!(r>c))return i;t=i}}return-1}function regexIndexOf(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,t=this.substring(n||0).search(r);return t>=0?t+(n||0):t}function regexLastIndexOf(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;r=r.global?r:new RegExp(r.source,"g"+(r.ignoreCase?"i":"")+(r.multiLine?"m":""));for(var t,o=this.substring(0,n+1),i=-1,a=0;null!=(t=r.exec(o));)i=t.index,r.lastIndex=++a;return i}function diff(e,r){return"undefined"==typeof JsDiff?"diff not supported":JsDiff.convertChangesToXML(JsDiff.diffWordsWithSpace(e,r))}function empty(e){return""==e}function startsWithVowel(e){var r=e[0];return"A"===r||"E"===r||"I"===r||"O"===r||"U"===r||"a"===r||"e"===r||"i"===r||"o"===r||"u"===r||!1}function withDecimalPrecision(e,r){var n=parseFloat(e);return isNaN(n)?e:n.toFixed(r)}function capitalize(e){return e.length?e.charAt(0).toUpperCase()+e.slice(1):e}function camelCaseString(e){return e.split(" ").map(capitalize).join("")}function camelize(e){var r=e.split("-"),n=r.length;if(1==n)return r[0];for(var t="-"==e.charAt(0)?r[0].charAt(0).toUpperCase()+r[0].substring(1):r[0],o=1;o<n;o++)t+=r[o].charAt(0).toUpperCase()+r[o].substring(1);return t}function truncate(e,r,n){return r=r||30,n=void 0===n?"...":n,e.length>r?e.slice(0,r-n.length)+n:String(e)}function truncateLeft(e,r,n){return r=r||30,n=void 0===n?"...":n,e.length>r?n+e.slice(-r):String(e)}function regExpEscape(e){return e.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08")}function succ(e){return e.slice(0,e.length-1)+String.fromCharCode(e.charCodeAt(e.length-1)+1)}function digitValue(e){return e.charCodeAt(0)-"0".charCodeAt(0)}function longestCommonSubstring(e,r){for(var n=[],t=0;t<e.length;t++){n[t]=[];for(var o=0;o<r.length;o++)n[t][o]=0}for(var i=0;i<e.length;i++)n[i][0]=0;for(var a=1;a<e.length;a++)for(var u=1;u<r.length;u++)n[a][u]=e[a-1]==r[u-1]?n[a-1][u-1]+1:0;for(var c=-1,s=-1,l=-1,f=0;f<e.length;f++)for(var p=0;p<r.length;p++){var h=n[f][p];c<h&&(c=h,s=f-h,l=p-h)}return{length:c,indexA:s,indexB:l,string:c>0?e.slice(s,s+c):""}}function applyChange(e,r){return"insert"===r.action?e.slice(0,r.start)+r.lines.join("\n")+e.slice(r.start):"remove"===r.action?e.slice(0,r.start)+e.slice(r.end):e}function applyChanges(e,r){return r.reduce(function(r,n){return applyChange(e,n)},e)}function levenshtein(e,r){if(0===e.length)return r.length;if(0===r.length)return e.length;var n,t,o,i,a,u;for(e.length>r.length&&(n=e,e=r,r=n),u=Array(e.length+1),t=0;t<=e.length;t++)u[t]=t;for(t=1;t<=r.length;t++){for(i=t,o=1;o<=e.length;o++)a=r[t-1]===e[o-1]?u[o-1]:Math.min(u[o-1]+1,Math.min(i+1,u[o]+1)),u[o-1]=i,i=a;u[e.length]=i}return u[e.length]}function random(e,r){return e=e||0,r=r||100,Math.round(Math.random()*(r-e)+e)}function randomSmallerInteger(e){return Math.floor(Math.random()*e)}function humanReadableByteSize(e){function r(e){return Math.round(100*e)/100}return e<1e3?String(r(e))+"B":(e/=1024,e<1e3?String(r(e))+"KB":(e/=1024,String(r(e))+"MB"))}function average(e){return e.reduce(function(e,r){return e+r},0)/e.length}function averageInc(e,r,n){return(e-r)/n+r}function median(e){var r=e.sort(function(e,r){return r-e}),n=e.length;return n%2===0?.5*(r[n/2-1]+r[n/2]):r[(n-1)/2]}function between(e,r,n,t){t=t||0;var o,i;return r<n?(o=r,i=n):(i=r,o=n),i-e+t>=0&&o-e-t<=0}function sort$1(e){return e.sort(function(e,r){return e-r})}function parseLength(e,r){r=r||"px";var n=e.match(/([0-9\.]+)\s*(.*)/);if(n&&n[1]){var t=parseFloat(n[1]),o=n[2];return convertLength(t,o,r)}}function roundTo(e,r){return r=1/r,Math.round(e*r)/r}function detent(e,r,n,t){var o=roundTo(e,n);if(Math.abs(e-o)<r/2)return o;if(t)return e;var i=e<o?o-r/2:o+r/2;return o+(e-i)*n/(n-r)}function toDegrees(e){return 180*e/Math.PI%360}function toRadians(e){return e/180*Math.PI}function backoff(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e4,t=Math.min(n,r*Math.pow(2,e)),o=t/2+Math.round(Math.random()*(t/2));return Math.min(n,r+Math.random()*(3*o-r))}function interpolate(e,r,n){return r+e*(n-r)}function all$2(e,r){var n=[];for(var t in e)!e.__lookupGetter__(t)&&"function"==typeof e[t]||r&&!r(t,e)||n.push(t);return n}function allOwnPropertiesOrFunctions(e,r){return Object.getOwnPropertyNames(e).reduce(function(n,t){return r&&!r(e,t)||n.push(t),n},[])}function own$1(e){var r=[];for(var n in e)e.hasOwnProperty(n)&&(e.__lookupGetter__(n)||"function"!==e[n])&&r.push(n);return r}function forEachOwn(e,r,n){var t=[];for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];"function"!==i&&t.push(r.call(n||this,o,i))}return t}function nameFor(e,r){for(var n in e)if(e[n]===r)return n}function values$1(e){var r=[];for(var n in e)r.push(e[n]);return r}function ownValues(e){var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push(e[n]);return r}function any$1(e,r){for(var n in e)if(r(e,n))return!0;return!1}function allProperties(e,r){var n=[];for(var t in e)r&&!r(e,t)||n.push(t);return n}function hash(e){return Object.keys(e).sort().join("").hashCode()}function format$1(e,r,n){return dateFormat(e,r,n)}function equals$3(e,r){return r&&r instanceof Date&&r.getTime()===e.getTime()}function relativeTo(e,r){if(!(r instanceof Date))return"";if(r<e)return"";if(r===e)return"now";var n="min",t="sec",o="hour",i="day",a=r-e,u=Math.round(a/1e3),c=u%60,s=Math.floor(u/60)%60,l=Math.floor(u/60/60)%24,f=Math.floor(u/60/60/24),p=[];return f>0&&(p.push(f),f>1&&(i+="s"),p.push(i)),l>0&&f<2&&(p.push(l),l>1&&(o+="s"),p.push(o)),s>0&&l<3&&0===f&&(p.push(s),s>1&&(n+="s"),p.push(n)),c>0&&s<3&&0===l&&0===f&&(p.push(c),c>1&&(t+="s"),p.push(t)),p.join(" ")}function promise(e){return"function"==typeof e?promise.convertCallbackFun(e):Promise.resolve(e)}function delay$1(e,r){return new Promise(function(n){return setTimeout(n,e,r)})}function delayReject(e,r){return new Promise(function(n,t){return setTimeout(t,e,r)})}function timeout(e,r){return new Promise(function(n,t){var o=!1;setTimeout(function(){return!o&&(o=!0)&&t(new Error("Promise timed out"))},e),r.then(function(e){return!o&&(o=!0)&&n(e)},function(e){return!o&&(o=!0)&&t(e)})})}function waitFor$1(e,r,n){return"function"==typeof e&&(r=e,e=void 0),new Promise(function(t,o){var i=!1,a=!1,u=void 0,c=void 0,s=setInterval(function(){if(i)return clearInterval(s);try{c=r()}catch(e){u=e}if(c||u||a)return i=!0,clearInterval(s),u?o(u):a?"undefined"==typeof n?o(new Error("timeout")):t(n):t(c)},10);"number"==typeof e&&setTimeout(function(){return a=!0},e)})}function deferred(){var e,r,n=new Promise(function(n,t){e=n,r=t});return{resolve:e,reject:r,promise:n}}function convertCallbackFun(e){return function(){var r=Array.from(arguments),n=this;return new Promise(function(t,o){r.push(function(e,r){return e?o(e):t(r)}),e.apply(n,r)})}}function convertCallbackFunWithManyArgs(e){return function(){var r=Array.from(arguments),n=this;return new Promise(function(t,o){r.push(function(){var e=Array.from(arguments),r=e.shift();return r?o(r):t(e)}),e.apply(n,r)})}}function _chainResolveNext(e,r,n,t,o){var i=e.shift();if(i)try{Promise.resolve(i(r,n)).then(function(r){return _chainResolveNext(e,r,n,t,o)}).catch(function(e){o(e)})}catch(e){o(e)}else t(r)}function chain$1(e){return new Promise(function(r,n){return _chainResolveNext(e.slice(),void 0,{},r,n)})}function promise_finally(e,r){return Promise.resolve(e).then(function(e){try{r()}catch(e){console.error("Error in promise finally: "+e.stack||e)}return e}).catch(function(e){try{r()}catch(e){console.error("Error in promise finally: "+e.stack||e)}throw e})}function parallel(e){function r(){t--;try{!function(){var r=a++,i=e[r]();i.then(function(e){t++,o[r]=e,0===--u?c():n()}).catch(function(e){return s(e)})}()}catch(e){s(e)}}function n(){for(;!i&&u>0&&a<e.length&&t>0;)r()}var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0;if(!e.length)return Promise.resolve([]);var o=[],i=null,a=0,u=e.length,c=void 0,s=void 0;return new Promise(function(e,r){c=function(){return e(o)},s=function(e){return r(i=e)},n()})}function Path(e,r){return e instanceof Path?e:this instanceof Path?(this.setSplitter(r||"."),void this.fromPath(e)):new Path(e,r)}function clone$2(e){var r={};for(var n in e)r[n]=e[n].slice();return r}function without$1(e,r){var n={};for(var t in e)if(!r.includes(t)){n[t]=[];for(var o=e[t],i=0;i<o.length;i++){var a=o[i];r.includes(a)||n[t].push(a)}}return n}function hull(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;if(!Array.isArray(e[r]))return[];for(var o=[],i={},a={},u=0;u<n.length;u++)a[n[u]]=!0;for(var c=e[r].slice(),s={},l=c.length;l--;){var f=c[l];f in a?c.splice(l,1):s[f]=1}if(n)for(;;){if(0===c.length)break;for(var p=0;p<c.length;p++){var h=c.shift();if(!(h in i||h in a)){var d=s[h]||0;if(!(d>t)){o.push(h),i[h]=!0;var g=e[h];if(g)for(var y=0;y<g.length;y++){var m=g[y];m in i||m in s||(s[m]=d+1,c.push(m))}}}}}return o}function subgraphReachableBy(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;n&&(e=without$1(e,n));for(var o=[r],i=0,a={};o.length&&i++<t;){var u=o.shift();if(!a[u]){var c=e[u]||[];a[u]=c,o.push.apply(o,toConsumableArray(c))}}return a}function invert(e){var r={};for(var n in e)for(var t=e[n],o=0;o<t.length;o++){var i=t[o];r[i]?r[i].push(n):r[i]=[n]}return r}function sortByReference(e,r){var n=[],t={},o={},i={};for(var a in e){t.hasOwnProperty(a)||(t[a]=!0,n.push(a));var u=e[a],c={};if(u){o[a]=[];var s=!0,l=!1,f=void 0;try{for(var p,h=u[Symbol.iterator]();!(s=(p=h.next()).done);s=!0){var d=p.value;if(!c.hasOwnProperty(d)&&a!==d){var g=i[d]||(i[d]=[]);g.includes(a)||g.push(a),c[d]=!0,o[a].push(d),t.hasOwnProperty(d)||(t[d]=!0,n.push(d))}}}catch(e){l=!0,f=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw f}}}}for(var y=[];n.length;){for(var m=1/0,v=[],w=[],b=[],k=0;k<n.length;k++){var O=n[k],A=o[O]||[];if(!(A.length>m))if(A.length!==m||A.some(function(e){return v.includes(e)}))m=A.length,v=[O],w=[k],b=(i[O]||[]).slice();else{var S;v.push(O),w.push(k),(S=b).push.apply(S,toConsumableArray(i[O]||[]))}}for(var k=w.length;k--;){var O=n[w[k]];i[O]=[],n.splice(w[k],1)}var C=!0,j=!1,E=void 0;try{for(var P,x=b[Symbol.iterator]();!(C=(P=x.next()).done);C=!0){var O=P.value;o[O]=o[O].filter(function(e){return!v.includes(e)})}}catch(e){j=!0,E=e}finally{try{!C&&x.return&&x.return()}finally{if(j)throw E}}y.push(v)}return y}function reduce$1(e,r,n,t,o,i){function a(n){if(!(u.indexOf(n)>-1)){t=e.call(i,t,n,c++),u=u.concat([n]);var o=withoutAll(r[n]||[],u);o.forEach(function(e){return a(e)})}}var u=o||[],c=0;return a(n),t}function random$1(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,r={},n=range(1,e).map(String),t=0;t<n.length;t++){var o=Math.floor(Math.random()*e);r[n[t]]=shuffle(n).slice(0,o)}return r}function isInterval(e){return Array.isArray(e)&&e.length>=2&&e[0]<=e[1]}function sort$2(e){return e.sort(compare)}function compare(e,r){return e[0]<r[0]?e[1]<r[0]?-3:e[1]===r[0]?-2:-1:e[0]===r[0]?e[1]===r[1]?0:e[1]<r[1]?-1:1:-1*compare(r,e)}function coalesce(e,r,n){var t=this.compare(e,r);switch(t){case-3:case 3:return null;case 0:return n&&n(e,r,e),e;case 2:case 1:var o=e;e=r,r=o;case-2:case-1:var i=[e[0],Math.max(e[1],r[1])];return n&&n(e,r,i),i;default:throw new Error("Interval compare failed")}}function coalesceOverlapping(e,r){for(var n=[],t=e.length;t>0;){var o=e.shift();t--;for(var i=0;i<t;i++){var a=e[i],u=coalesce(o,a,r);u&&(o=u,e.splice(i,1),t--,i--)}n.push(o)}return this.sort(n)}function mergeOverlapping(e,r,n){for(var t=[];e.length>0;){var o=e.shift(),i=r.map(function(e){var r=compare(o,e);return r===-1||0===r||1===r});t.push(n(o,i[0])),t.push(o)}return t}function intervalsInRangeDo(e,r,n,t,o,i){i=i||GLOBAL$2,n=this.sort(n);for(var a,u=[];a=n.shift();)if(!(a[1]<e)){a[0]<e&&(a=Array.prototype.slice.call(a),a[0]=e);var c=r<a[0]?r:a[0];if(e<c&&u.push(t.call(i,[e,c],!0)),r<a[1]&&(a=Array.prototype.slice.call(a),a[1]=r),a[0]===a[1]){var s;o&&(s=u.slice(-1)[0])&&o.call(i,s,a,s)}else u.push(t.call(i,a,!1));if(e=a[1],e>=r)break}return e<r&&u.push(t.call(i,[e,r],!0)),u}function intervalsInbetween(e,r,n){return intervalsInRangeDo(e,r,coalesceOverlapping(Array.prototype.slice.call(n)),function(e,r){return r?e:null}).filter(Boolean)}function mapToMatchingIndexes(e,r){var n,t,o=0;return r.map(function(r){for(;(t=e[o])&&t[0]<r[0];)o++;if(t&&t[0]===r[0]){for(n=o;(t=e[n])&&t[1]<r[1];)n++;if(t&&t[1]===r[1])return range(o,n)}return[]})}function create(e,r,n){var t=n||0;return t+r>e.length&&(t-=t+r-e.length),{array:e,from:t,to:t+r}}function toArray$4(e){return e.array.slice(e.from,e.to)}function originalToProjectedIndex(e,r){return r<e.from||r>=e.to?null:r-e.from}function projectedToOriginalIndex(e,r){return r<0||r>e.to-e.from?null:e.from+r}function transformToIncludeIndex(e,r){if(!(r in e.array))return null;var n=0;return r<e.from&&(n=-e.from+r),r>=e.to&&(n=r-e.to+1),0===n?e:create(e.array,e.to-e.from,e.from+n)}function get$2(e,r,n){var t=e[r];return t?t[n]:void 0}function set$2(e,r,n,t){var o=e[r];return o&&(o[n]=t),t}function getRow(e,r){return e[r]}function setRow(e,r,n){return e[r]=n}function getCol(e,r){return e.reduce(function(e,n){return e.push(n[r]),e},[])}function setCol(e,r,n){return e.map(function(e,t){return e[r]?e[r]=n[t]:void 0})}function create$1(e,r,n){for(var t=new Array(e);e>0;)t[--e]=withN(r,n);return t}function mapCreate(e,r,n,t){for(var o=new Array(e),i=0;i<e;i++){o[i]=new Array(r);for(var a=0;a<r;a++)o[i][a]=n.call(t||this,i,a)}return o}function forEach$2(e,r,n){e.forEach(function(e,t){e.forEach(function(e,o){r.call(n||this,e,t,o)})})}function map$2(e,r,n){var t=new Array(e.length);return e.forEach(function(e,o){t[o]=new Array(e.length),e.forEach(function(e,i){t[o][i]=r.call(n||this,e,o,i)})}),t}function toObjects(e){for(var r=e[0],n=new Array(e.length-1),t=1;t<e.length;t++)for(var o=n[t-1]={},i=0;i<r.length;i++)o[r[i]]=e[t][i];return n}function tableFromObjects(e,r){Array.isArray(e)||(e=[e]);var n=[[]],t=n[0],o=e.reduce(function(e,r){return e.concat([Object.keys(r).reduce(function(e,n){var o=t.indexOf(n);return o===-1&&(o=t.length,t.push(n)),e[o]=r[n],e},[])])},[]);return r=1===arguments.length?null:r,o.forEach(function(e){for(var n=0;n<t.length;n++)e[n]||(e[n]=r)}),n.concat(o)}function prewalk(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{i:0},o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=t.i++;r(e,i,o),(n(e,i,o)||[]).forEach(function(e){return prewalk(e,r,n,t,o+1)})}function postwalk(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{i:0},o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=t.i++;(n(e,i,o)||[]).forEach(function(e){return postwalk(e,r,n,t,o)}),r(e,i,o)}function find(e,r,n){if(r(e))return e;var t=n(e);if(t&&t.length)for(var o=0;o<t.length;o++){var i=find(t[o],r,n);if(i)return i}}function filter$1(e,r,n){var t=[];return r(e)&&t.push(e),t.concat(flatten((n(e)||[]).map(function(e){return filter$1(e,r,n)})))}function map$3(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return[r(e,t)].concat(flatten((n(e)||[]).map(function(e){return map$3(e,r,n,t+1)})))}function mapTree(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=(n(e)||[]).map(function(e){return mapTree(e,r,n,t+1)});return r(e,o,t)}function create$2(e){var r=[{name:"send",args:["msg","callback"]},{name:"listen",args:["messenger","callback"]},{name:"close",args:["messenger","callback"]},{name:"isOnline",args:[]}],n=r.map(function(e){return e.name}).concat(["id","sendHeartbeat","heartbeatInterval","ignoreUnknownMessages","allowConcurrentSends","sendTimeout","services"]);r.forEach(function(r){if(!e[r.name]){var n="message implementation needs function "+r.name+"("+r.args.join(",")+")";throw new Error(n)}});var t=e.sendHeartbeat&&(e.heartbeatInterval||1e3),o=!!e.hasOwnProperty("ignoreUnknownMessages")&&e.ignoreUnknownMessages,i={_outgoing:[],_inflight:[],_id:e.id||newUUID(),_ignoreUnknownMessages:o,_services:{},_messageCounter:0,_messageResponseCallbacks:{},_whenOnlineCallbacks:[],_statusWatcherProc:null,_startHeartbeatProcessProc:null,_listenInProgress:null,_heartbeatInterval:t,_status:OFFLINE,_runWhenOnlineCallbacks:function(){var e=i._whenOnlineCallbacks.slice();i._whenOnlineCallbacks=[],e.forEach(function(e){try{e.call(null,null,i)}catch(e){console.error("error in _runWhenOnlineCallbacks: %s",e)}})},_ensureStatusWatcher:function(){i._statusWatcherProc||(i._statusWatcherProc=setInterval(function(){i.isOnline()&&i._whenOnlineCallbacks.length&&i._runWhenOnlineCallbacks();var e=i._status;i._status=i.isOnline()?ONLINE:OFFLINE,i._status!==ONLINE&&i._statusWatcherProc&&i.reconnect(),i._status!==e&&i.onStatusChange&&i.onStatusChange()},20))},_addMissingData:function(e){if(!e.target)throw new Error("Message needs target!");if(!e.action)throw new Error("Message needs action!");return e.data||(e.data=null),e.messageId||(e.messageId=newUUID()),e.sender=i.id(),e.messageIndex=i._messageCounter++,e},_queueSend:function(e,r){if(r&&"function"!=typeof r)throw new Error("Expecing a when send callback, got: "+r);i._outgoing.push([e,r])},_deliverMessageQueue:function(){function r(r){if(i._inflight.indexOf(r)!==-1){var n=r[0],o=r[1];o&&(i._messageResponseCallbacks[n.messageId]=o),e.send.call(i,n,function(e){remove(i._inflight,r),e&&t(e,r),i._deliverMessageQueue()})}}function n(r){"number"==typeof e.sendTimeout&&setTimeout(function(){i._inflight.indexOf(r)!==-1&&(remove(i._inflight,r),t(new Error("Timeout sending message"),r),i._deliverMessageQueue())},e.sendTimeout)}function t(e,r){var n=r[0],t=r[1];delete i._messageResponseCallbacks[n.messageId],console.error(e),t&&t(e)}if(e.allowConcurrentSends||!i._inflight.length){var o=i._outgoing.shift();o&&(i._inflight.push(o),i.isOnline()?r(o):i.whenOnline(function(){r(o)}),n(o),e.allowConcurrentSends&&i._outgoing.length&&i._deliverMessageQueue())}},_startHeartbeatProcess:function(){i._startHeartbeatProcessProc||(i._startHeartbeatProcessProc=setTimeout(function(){e.sendHeartbeat.call(i,function(e,r){i._startHeartbeatProcessProc=null,i._startHeartbeatProcess()})},i._heartbeatInterval))},id:function(){return i._id},isOnline:function(){return e.isOnline.call(i)},heartbeatEnabled:function(){return"number"==typeof i._heartbeatInterval},listen:function(r){if(!i._listenInProgress)return i._listenInProgress=!0,i._ensureStatusWatcher(),e.listen.call(i,function(e){i._listenInProgress=null,r&&r(e),i.heartbeatEnabled()&&i._startHeartbeatProcess()})},reconnect:function(){if(i._status!==ONLINE)return i.listen(),i},send:function(e,r){return i._addMissingData(e),i._queueSend(e,r),i._deliverMessageQueue(),e},sendTo:function(e,r,n,t){var o={target:e,action:r,data:n};return i.send(o,t)},onMessage:function(e){if(i.emit("message",e),e.inResponseTo){var r=i._messageResponseCallbacks[e.inResponseTo];r&&!e.expectMoreResponses&&delete i._messageResponseCallbacks[e.inResponseTo],r&&r(null,e)}else{var n=i._services[e.action];if(n)try{n.call(null,e,i)}catch(r){var t=String(r.stack||r);console.error("Error invoking service: "+t),i.answer(e,{error:t})}else if(!i._ignoreUnknownMessages){var o=new Error("messageNotUnderstood: "+e.action);i.answer(e,{error:String(o)})}}},answer:function e(r,n,t,o){"function"==typeof t&&(o=t,t=!1);var e={target:r.sender,action:r.action+"Result",inResponseTo:r.messageId,data:n};return t&&(e.expectMoreResponses=!0),i.send(e,o)},close:function(r){return clearInterval(i._statusWatcherProc),i._statusWatcherProc=null,e.close.call(i,function(e){i._status=OFFLINE,r&&r(e)}),i},whenOnline:function(e){return i._whenOnlineCallbacks.push(e),i.isOnline()&&i._runWhenOnlineCallbacks(),i},outgoingMessages:function(){return pluck(i._inflight.concat(i._outgoing),0)},addServices:function(e){return Object.assign(i._services,e),i}};e.services&&i.addServices(e.services),makeEmitter(i);for(var a in e)n.indexOf(a)===-1&&e.hasOwnProperty(a)&&(i[a]=e[a]);return i}function fork(e,r,n){n||(n=r,r=e,e=null),e=e||{};var t=e.args||[],o=create$3(e);return o.run.apply(o,[r].concat(t).concat(n)),o}function create$3(e){e=e||{},e.useMessenger=!0;var r=e.workerId||newUUID(),n=create$2({sendTimeout:5e3,send:function(e,r){n.worker.postMessage(e),r()},listen:function(r){var t=n.worker=isNodejs?NodejsWorker.create(e):BrowserWorker.create(e);t.on("message",function(e){n.onMessage(e)}),t.on("ready",function(){NodejsWorker.debug&&console.log("WORKER READY!!!")}),t.on("close",function(){NodejsWorker.debug&&console.log("WORKER CLOSED...!!!")}),t.once("ready",r)},close:function(e){return n.worker.ready?n.sendTo(r,"close",{},function(r,t){if(r=r||t.data.error,r&&console.error("Error in worker messenger close: "+r.stack||r),r)e(r);else{var o=!1;n.worker.once("close",function(){o=!0}),waitFor(1e3,function(){return!!o},e)}}):e(null)},isOnline:function(){return n.worker&&n.worker.ready}});return Object.assign(n,{eval:function(e,t){n.sendTo(r,"remoteEval",{expr:e},function(e,r){t(e,r?r.data.result:null)})},run:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),o=e.pop();if("function"!=typeof t)throw new Error("run: no function that should run in worker passed");if("function"!=typeof o)throw new Error("run: no callback passed");return n.sendTo(r,"run",{func:String(t),args:e},function(e,r){o(e||r.data.error,r?r.data.result:null)})}}),n.listen(),n}function createLivelyLangObject(){return{chain:chain$$1,noConflict:noConflict,installGlobals:installGlobals,uninstallGlobals:uninstallGlobals,globalInterfaceSpec:globalInterfaceSpec,toString:function(){return"[object lively.lang]"}}}function chain$$1(e){if(!e)return e;if(Array.isArray(e))return createChain(arr,e);if("Date"===e.constructor.name)return createChain(date,e);switch("undefined"==typeof e?"undefined":_typeof(e)){case"string":return createChain(string,e);case"object":return createChain(obj,e);case"function":return createChain(fun,e);case"number":return createChain(num,e)}throw new Error("Chain for object "+e+" ("+e.constructor.name+") no supported")}function createChain(e,r){return Object.keys(e).reduce(function(n,t){return n[t]=function(){var n=Array.prototype.slice.call(arguments),o=e[t].apply(null,[r].concat(n));return chain$$1(o)},n},{value:function(){return r}})}function noConflict(){if(!isNode){var e=livelyLang._prevLivelyGlobal;e?delete GLOBAL.lively.lang:delete GLOBAL.lively}return livelyLang}function installGlobals(){Object.assign(livelyLang,{worker:worker,messenger:messenger,events:events,tree:tree,grid:grid,arrayProjection:arrayProjection,interval:interval,graph:graph,date:date,properties:properties,obj:obj,arr:arr,fun:fun,num:num,string:string,Closure:Closure,promise:promise,Path:Path,Group:Group}),globalInterfaceSpec.forEach(function(e){if("installMethods"===e.action){var r=Path(e.target);r.isIn(GLOBAL)||r.set(GLOBAL,{},!0);var n=Path(e.sources[0]);e.methods.forEach(function(e){installProperty(n.concat([e]),r.concat([e]))}),e.alias&&e.alias.forEach(function(e){installProperty(n.concat([e[1]]),r.concat([e[0]]))})}else{if("installObject"!==e.action)throw new Error("Cannot deal with global setup action: "+e.action);var r=Path(e.target),t=Path(e.source).get(livelyLang);r.set(GLOBAL,t,!0)}})}function installProperty(e,r){if(!e.isIn(livelyLang)){var n=new Error("property not provided by lively.lang: "+e);throw console.error(n.stack||n),n}var t=e.get(livelyLang);if("function"==typeof t&&"prototype"===r.slice(-2,-1).toString()){var o=t;t=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(this),o.apply(null,e)},t.toString=function(){return o.toString()}}r.set(GLOBAL,t,!0)}function uninstallGlobals(){globalInterfaceSpec.forEach(function(e){if("installMethods"===e.action){var r=Path(e.target),n=Path(e.source).get(livelyLang),t=r.get(GLOBAL);if(!t)return;e.methods.filter(function(e){return n===t[e]}).forEach(function(e){delete t[e]}),e.alias&&e.alias.filter(function(e){return n===t[e]}).forEach(function(e){delete t[e[0]]})}else{if("installObject"!==e.action)throw new Error("Cannot deal with global setup action: "+e.action);var r=Path(e.target);r.del(GLOBAL)}})}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},asyncGenerator=function(){function e(e){this.value=e}function r(r){function n(e,r){return new Promise(function(n,o){var u={key:e,arg:r,resolve:n,reject:o,next:null};a?a=a.next=u:(i=a=u,t(e,r))})}function t(n,i){try{var a=r[n](i),u=a.value;u instanceof e?Promise.resolve(u.value).then(function(e){t("next",e)},function(e){t("throw",e)}):o(a.done?"return":"normal",a.value)}catch(e){o("throw",e)}}function o(e,r){switch(e){case"return":i.resolve({value:r,done:!0});break;case"throw":i.reject(r);break;default:i.resolve({value:r,done:!1})}i=i.next,i?t(i.key,i.arg):a=null}var i,a;this._invoke=n,"function"!=typeof r.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(r.prototype[Symbol.asyncIterator]=function(){
return this}),r.prototype.next=function(e){return this._invoke("next",e)},r.prototype.throw=function(e){return this._invoke("throw",e)},r.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new r(e.apply(this,arguments))}},await:function(r){return new e(r)}}}(),classCallCheck=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),get$1=function e(r,n,t){null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,n);if(void 0===o){var i=Object.getPrototypeOf(r);return null===i?void 0:e(i,n,t)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(t)},set$1=function e(r,n,t,o){var i=Object.getOwnPropertyDescriptor(r,n);if(void 0===i){var a=Object.getPrototypeOf(r);null!==a&&e(a,n,t,o)}else if("value"in i&&i.writable)i.value=t;else{var u=i.set;void 0!==u&&u.call(o,t)}return t},slicedToArray=function(){function e(e,r){var n=[],t=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(t=(a=u.next()).done)&&(n.push(a.value),!r||n.length!==r);t=!0);}catch(e){o=!0,i=e}finally{try{!t&&u.return&&u.return()}finally{if(o)throw i}}return n}return function(r,n){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);r<e.length;r++)n[r]=e[r];return n}return Array.from(e)},parameterRegex=/function[^\(]*\(([^\)]*)\)|\(?([^\)=]*)\)?\s*=>/,Closure=function(){function e(r,n,t,o){classCallCheck(this,e),this.originalFunc=r,this.varMapping=n||{},this.setFuncSource(t||r),this.setFuncProperties(r||o)}return createClass(e,null,[{key:"fromFunction",value:function(e,r){return new this(e,r||{})}},{key:"fromSource",value:function(e,r){return new this(null,r||{},e)}}]),createClass(e,[{key:"setFuncSource",value:function(e){return e="undefined"!=typeof lively&&lively.sourceTransform&&"function"==typeof lively.sourceTransform.stringifyFunctionWithoutToplevelRecorder?lively.sourceTransform.stringifyFunctionWithoutToplevelRecorder(e):String(e),this.source=e}},{key:"getFuncSource",value:function(){return this.source||this.setFuncSource(this.originalFunc)}},{key:"hasFuncSource",value:function(){return this.source&&!0}},{key:"getFunc",value:function(){return this.originalFunc||this.recreateFunc()}},{key:"getFuncProperties",value:function(){return this.funcProperties||(this.funcProperties={})}},{key:"setFuncProperties",value:function(e){var r=this.getFuncProperties();for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n])}},{key:"lookup",value:function(e){return this.varMapping[e]}},{key:"parameterNames",value:function(e){if("undefined"!=typeof lively&&lively.ast&&lively.ast.parseFunction)return(lively.ast.parseFunction(e).params||[]).map(function(e){return"Identifier"===e.type?e.name:e.left&&"Identifier"===e.left.type?e.left.name:null}).filter(Boolean);var r=parameterRegex.exec(e);if(!r)return[];var n=r[1]||r[2]||"";return n.split(",").map(function(e){return e.trim()})}},{key:"firstParameter",value:function(e){return this.parameterNames(e)[0]||null}},{key:"recreateFunc",value:function(){return this.recreateFuncFromSource(this.getFuncSource(),this.originalFunc)}},{key:"recreateFuncFromSource",value:function(e,r){var n=[],t=!1,o="$super"===this.firstParameter(e);for(var i in this.varMapping)this.varMapping.hasOwnProperty(i)&&("this"!=i?n.push("var "+i+" = this.varMapping."+i+";\n"):t=!0);var a="";n.length>0&&(a+=n.join("\n")),o&&(a+="(function superWrapperForClosure() { return "),a+="("+e+")",o&&(a+=".apply(this, [$super.bind(this)].concat(Array.from(arguments))) })");try{var u=evalJS.call(this,a)||this.couldNotCreateFunc(a);return this.addFuncProperties(u),this.originalFunc=u,u}catch(e){var c="Cannot create function "+e+" src: "+a;throw console.error(c),new Error(c)}}},{key:"addFuncProperties",value:function(e){var r=this.getFuncProperties();for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n]);this.addClosureInformation(e)}},{key:"couldNotCreateFunc",value:function(e){var r="Could not recreate closure from source: \n"+e;return console.error(r),function(){throw new Error(r)}}},{key:"asFunction",value:function(){return this.recreateFunc()}},{key:"addClosureInformation",value:function(e){return e.hasLivelyClosure=!0,e.livelyClosure=this,e}},{key:"isLivelyClosure",get:function(){return!0}},{key:"doNotSerialize",get:function(){return["originalFunc"]}}]),e}(),_throttledByName={},_debouncedByName={},_queues={},_queueUntilCallbacks={},_eitherNameRegistry={},fun=Object.freeze({Empty:Empty,K:K,Null:Null,False:False,True:True,notYetImplemented:notYetImplemented,withNull:withNull,all:all,own:own,argumentNames:argumentNames,qualifiedMethodName:qualifiedMethodName,extractBody:extractBody,timeToRun:timeToRun,timeToRunN:timeToRunN$1,delay:delay,throttle:throttle,debounce:debounce,throttleNamed:throttleNamed,debounceNamed:debounceNamed,createQueue:createQueue,workerWithCallbackQueue:workerWithCallbackQueue,composeAsync:composeAsync,compose:compose,waitFor:waitFor,waitForAll:waitForAll,flip:flip,curry:curry,wrap:wrap,binds:binds,getOriginal:getOriginal,wrapperChain:wrapperChain,replaceMethodForOneCall:replaceMethodForOneCall,once:once,either:either,eitherNamed:eitherNamed,evalJS:evalJS,fromString:fromString,asScript:asScript,asScriptOf:asScriptOf,addToObject:addToObject,setLocalVarValue:setLocalVarValue,getVarMapping:getVarMapping,setProperty:setProperty,functionNames:functionNames,localFunctionNames:localFunctionNames,logErrors:logErrors,logCompletion:logCompletion,logCalls:logCalls,traceCalls:traceCalls,webkitStack:webkitStack}),Group=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"toArray",value:function(){return this.reduceGroups(function(e,r,n){return e.concat([n])},[])}},{key:"forEach",value:function(e,r){var n=this;return Object.keys(n).forEach(function(t){n[t].forEach(e.bind(r,t))}),n}},{key:"forEachGroup",value:function(e,r){var n=this;return Object.keys(n).forEach(function(t){e.call(r,t,n[t])}),n}},{key:"map",value:function(r,n){var t=new e;return this.forEachGroup(function(e,o){t[e]=o.map(r.bind(n,e))}),t}},{key:"mapGroups",value:function(r,n){var t=new e;return this.forEachGroup(function(e,o){t[e]=r.call(n,e,o)}),t}},{key:"keys",value:function(){return Object.keys(this)}},{key:"reduceGroups",value:function(e,r,n){return this.forEachGroup(function(t,o){r=e.call(n,r,t,o)}),r}},{key:"count",value:function(){return this.reduceGroups(function(e,r,n){return e[r]=n.length,e},{})}}],[{key:"fromArray",value:function(r,n,t){for(var o=new e,i=0,a=r.length;i<a;i++){var u=n.call(t,r[i],i);o[u]||(o[u]=[]),o[u].push(r[i])}return o}},{key:"by",get:function(){return groupBy}}]),e}(),GLOBAL$1="undefined"!=typeof System?System.global:"undefined"!=typeof window?window:global,features$1={from:!!Array.from,filter:!!Array.prototype.filter,find:!!Array.prototype.find,findIndex:!!Array.prototype.findIndex,includes:!!Array.prototype.includes},from=features$1.from?Array.from:function(e){if(!e)return[];if(Array.isArray(e))return e;if(e.toArray)return e.toArray();for(var r=e.length,n=new Array(r);r--;)n[r]=e[r];return n},detect=features$1.find?function(e,r,n){return e.find(r,n)}:function(e,r,n){for(var t,o=0,i=e.length;o<i;o++)if(t=e[o],r.call(n,t,o))return t},findIndex=features$1.findIndex?function(e,r,n){return e.findIndex(r,n)}:function(e,r,n){var t=-1;return e.find(function(e,o){return t=o,r.call(e,n)})?t:-1},isArray$1=Array.isArray,includes$1=features$1.includes?function(e,r){return e.includes(r)}:function(e,r){return e.indexOf(r)!==-1},include$1=includes$1,permutations=function(){function e(r,n){return r.length?flatmap(r,function(t,o){return e(r.slice(0,o).concat(r.slice(o+1)),n.concat([t]))}):[n]}return function(r){return e(r,[])}}();features$1.from||(Array.from=from),features$1.filter||(Array.prototype.filter=function(e,r){return filter(this,e,r)}),features$1.find||(Array.prototype.find=function(e,r){return detect(this,e,r)}),features$1.findIndex||(Array.prototype.findIndex=function(e,r){return findIndex(this,e,r)}),features$1.includes||(Array.prototype.includes=function(e){return includes$1(this,e)});var arr=Object.freeze({range:range,from:from,withN:withN,genN:genN,filter:filter,detect:detect,findIndex:findIndex,findAndGet:findAndGet,filterByKey:filterByKey,grep:grep,mask:mask,reject:reject,rejectByKey:rejectByKey,without:without,withoutAll:withoutAll,uniq:uniq,uniqBy:uniqBy,uniqByKey:uniqByKey,compact:compact,mutableCompact:mutableCompact,forEach:forEach$1,zip:zip,flatten:flatten,flatmap:flatmap,interpose:interpose,delimWith:delimWith,map:map$1,invoke:invoke,pluck:pluck,reduce:reduce,reduceRight:reduceRight,isArray:isArray$1,includes:includes$1,include:include$1,some:some,every:every,equals:equals$2,deepEquals:deepEquals,isSorted:isSorted,sort:sort,sortBy:sortBy,sortByKey:sortByKey,reverse:reverse,reversed:reversed,reMatches:reMatches$1,first:first,last:last,intersect:intersect,union:union,pushAt:pushAt,removeAt:removeAt,remove:remove,pushAll:pushAll$1,pushAllAt:pushAllAt,pushIfNotIncluded:pushIfNotIncluded,replaceAt:replaceAt,clear:clear,isSubset:isSubset,doAndContinue:doAndContinue,nestedDelay:nestedDelay,forEachShowingProgress:forEachShowingProgress,swap:swap,rotate:rotate,groupBy:groupBy,groupByKey:groupByKey,partition:partition,batchify:batchify,toTuples:toTuples,permutations:permutations,combinationsPick:combinationsPick,combinations:combinations,take:take,drop:drop,takeWhile:takeWhile,dropWhile:dropWhile,shuffle:shuffle,max:max,min:min,sum:sum,count:count$1,size:size$1,histogram:histogram,clone:clone$1,toArray:toArray$3,each:each,all:all$1,any:any,collect:collect,findAll:findAll,inject:inject,mapAsyncSeries:mapAsyncSeries,mapAsync:mapAsync}),getOwnPropertyDescriptors="function"==typeof Object.prototype.getOwnPropertyDescriptors?Object.prototype.getOwnPropertyDescriptors:function(e){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&Object.defineProperty(r,n,{configurable:!0,enumerable:!0,writable:!0,value:Object.getOwnPropertyDescriptor(e,n)});return r},keys$1=Object.keys,obj=Object.freeze({isArray:isArray$$1,isElement:isElement,isFunction:isFunction,isBoolean:isBoolean,isString:isString,isNumber:isNumber,isUndefined:isUndefined,isRegExp:isRegExp,isObject:isObject,isPrimitive:isPrimitive,isEmpty:isEmpty,equals:equals$1,keys:keys$1,values:values,select:select,dissoc:dissoc,addScript:addScript,extend:extend,clone:clone$$1,extract:extract,inspect:inspect,merge:merge,deepMerge:deepMerge,inherit:inherit,valuesInPropertyHierarchy:valuesInPropertyHierarchy,mergePropertyInHierarchy:mergePropertyInHierarchy,sortKeysWithBeforeAndAfterConstraints:sortKeysWithBeforeAndAfterConstraints,deepCopy:deepCopy,typeStringOf:typeStringOf,shortPrintStringOf:shortPrintStringOf,isMutableType:isMutableType,safeToString:safeToString,asObject:asObject,newKeyIn:newKeyIn}),features={repeat:!!String.prototype.repeat,includes:!!String.prototype.includes,startsWith:!!String.prototype.startsWith,endsWith:!!String.prototype.endsWith},pathDotRe=/\/\.\//g,pathDoubleDotRe=/\/[^\/]+\/\.\./,pathDoubleSlashRe=/(^|[^:])[\/]+/g,urlStartRe=/^[a-z0-9-_\.]+:\/\//,newUUIDTemplate="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",newUUIDRe=/[xy]/g,newUUIDReplacer=function(e){var r=16*Math.random()|0,n="x"==e?r:3&r|8;return n.toString(16)},includes$$1=features.includes?function(e,r){return e.includes(r)}:function(e,r){return e.indexOf(r)>-1},include$$1=includes$$1,startsWith=features.startsWith?function(e,r){return e.startsWith(r)}:function(e,r){return 0===e.indexOf(r)},endsWith=features.endsWith?function(e,r){return e.endsWith(r)}:function(e,r){var n=e.length-r.length;return n>=0&&e.lastIndexOf(r)===n},times=features.repeat?function(e,r){return e.repeat(r)}:function(e,r){return r<1?"":new Array(r+1).join(e)},string=Object.freeze({format:format,formatFromArray:formatFromArray,indent:indent,minIndent:minIndent,changeIndent:changeIndent,quote:quote,print:print,printNested:printNested,pad:pad,printTable:printTable,printTree:printTree,toArray:toArray$1,lines:lines,paragraphs:paragraphs,nonEmptyLines:nonEmptyLines,tokens:tokens,tableize:tableize,unescapeCharacterEntities:unescapeCharacterEntities,toQueryParams:toQueryParams,normalizePath:normalizePath$1,joinPath:joinPath,newUUID:newUUID,createDataURI:createDataURI,hashCode:hashCode,md5:md5,reMatches:reMatches$$1,stringMatch:stringMatch,peekRight:peekRight,peekLeft:peekLeft,lineIndexComputer:lineIndexComputer,lineNumberToIndexesComputer:lineNumberToIndexesComputer,findLineWithIndexInLineRanges:findLineWithIndexInLineRanges,regexIndexOf:regexIndexOf,regexLastIndexOf:regexLastIndexOf,lineRanges:lineRanges,diff:diff,empty:empty,includes:includes$$1,include:include$$1,startsWith:startsWith,startsWithVowel:startsWithVowel,endsWith:endsWith,withDecimalPrecision:withDecimalPrecision,capitalize:capitalize,camelCaseString:camelCaseString,camelize:camelize,truncate:truncate,truncateLeft:truncateLeft,regExpEscape:regExpEscape,succ:succ,digitValue:digitValue,times:times,longestCommonSubstring:longestCommonSubstring,applyChange:applyChange,applyChanges:applyChanges,levenshtein:levenshtein}),normalRandom=function(e,r){var n,t=!1;return function(e,r){if(t)return t=!1,n*r+e;var o,i,a;do o=2*Math.random()-1,i=2*Math.random()-1,a=o*o+i*i;while(a>=1||0==a);var u=Math.sqrt(-2*Math.log(a)/a);return n=i*u,t=!0,e+r*o*u}}(),convertLength=function(){function e(r,n){return"cm"===n?r:"mm"===n?.1*r:"in"===n?2.54*r:"px"===n?r*e(1/96,"in"):"pt"===n?r*e(1/72,"in"):"pc"===n?r*e(12,"pt"):void 0}return function r(n,t,o){return t===o?n:"cm"===o?e(n,t):"cm"===t?n/e(1,o):r(r(n,t,"cm"),"cm",o)}}(),num=Object.freeze({random:random,normalRandom:normalRandom,randomSmallerInteger:randomSmallerInteger,humanReadableByteSize:humanReadableByteSize,average:average,averageInc:averageInc,median:median,between:between,sort:sort$1,parseLength:parseLength,convertLength:convertLength,roundTo:roundTo,detent:detent,toDegrees:toDegrees,toRadians:toRadians,backoff:backoff,interpolate:interpolate}),properties=Object.freeze({all:all$2,allOwnPropertiesOrFunctions:allOwnPropertiesOrFunctions,own:own$1,forEachOwn:forEachOwn,nameFor:nameFor,values:values$1,ownValues:ownValues,any:any$1,allProperties:allProperties,hash:hash}),dateFormat=function(){var e=function(){var r=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,n=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,t=/[^-+\dA-Z]/g,o=function(e,r){for(e=String(e),r=r||2;e.length<r;)e="0"+e;return e};return function(i,a,u){var c=e;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(i)||/\d/.test(i)||(a=i,i=void 0),i=i?new Date(i):new Date,isNaN(i))throw SyntaxError("invalid date");a=String(c.masks[a]||a||c.masks.default),"UTC:"==a.slice(0,4)&&(a=a.slice(4),u=!0);var s=u?"getUTC":"get",l=i[s+"Date"](),f=i[s+"Day"](),p=i[s+"Month"](),h=i[s+"FullYear"](),d=i[s+"Hours"](),g=i[s+"Minutes"](),y=i[s+"Seconds"](),m=i[s+"Milliseconds"](),v=u?0:i.getTimezoneOffset(),w={d:l,dd:o(l),ddd:c.i18n.dayNames[f],dddd:c.i18n.dayNames[f+7],m:p+1,mm:o(p+1),mmm:c.i18n.monthNames[p],mmmm:c.i18n.monthNames[p+12],yy:String(h).slice(2),yyyy:h,h:d%12||12,hh:o(d%12||12),H:d,HH:o(d),M:g,MM:o(g),s:y,ss:o(y),l:o(m,3),L:o(m>99?Math.round(m/10):m),t:d<12?"a":"p",tt:d<12?"am":"pm",T:d<12?"A":"P",TT:d<12?"AM":"PM",Z:u?"UTC":(String(i).match(n)||[""]).pop().replace(t,""),o:(v>0?"-":"+")+o(100*Math.floor(Math.abs(v)/60)+Math.abs(v)%60,4),S:["th","st","nd","rd"][l%10>3?0:(l%100-l%10!=10)*l%10]};return a.replace(r,function(e){return e in w?w[e]:e.slice(1,e.length-1)})}}();return e.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},e.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},e}(),date=Object.freeze({format:format$1,equals:equals$3,relativeTo:relativeTo});Object.assign(promise,{delay:delay$1,delayReject:delayReject,timeout:timeout,waitFor:waitFor$1,deferred:deferred,convertCallbackFun:convertCallbackFun,convertCallbackFunWithManyArgs:convertCallbackFunWithManyArgs,chain:chain$1,finally:promise_finally,parallel:parallel}),Object.assign(Path.prototype,{get isPathAccessor(){return!0},fromPath:function(e){return"string"==typeof e&&""!==e&&e!==this.splitter?(this._parts=e.split(this.splitter),this._path=e):Array.isArray(e)?(this._parts=[].concat(e),this._path=e.join(this.splitter)):(this._parts=[],this._path=""),this},setSplitter:function(e){return e&&(this.splitter=e),this},parts:function(){return this._parts},size:function(){return this._parts.length},slice:function(e,r){return Path(this.parts().slice(e,r))},normalizePath:function(){return this._path},isRoot:function(e){return 0===this._parts.length},isIn:function(e){if(this.isRoot())return!0;var r=this.get(e,-1);return r&&r.hasOwnProperty(this._parts[this._parts.length-1])},equals:function(e){return e&&e.isPathAccessor&&this.parts().equals(e.parts())},isParentPathOf:function(e){e=e&&e.isPathAccessor?e:Path(e);for(var r=this.parts(),n=e.parts(),t=0;t<r.length;t++)if(r[t]!=n[t])return!1;return!0},relativePathTo:function(e){return e=Path(e),this.isParentPathOf(e)?e.slice(this.size(),e.size()):void 0},del:function(e){if(this.isRoot())return!1;for(var r=e,n=0;n<this._parts.length-1;n++){var t=this._parts[n];if(!r.hasOwnProperty(t))return!1;r=r[t]}return delete r[this._parts[this._parts.length-1]]},withParentAndKeyDo:function(e,r,n){if(this.isRoot())return n(null,null);for(var t=e,o=0;o<this._parts.length-1;o++){var i=this._parts[o];if(!t.hasOwnProperty(i)||"object"!==_typeof(t[i])&&"function"!=typeof t[i]){if(!r)return n(null,i);t=t[i]={}}else t=t[i]}return n(t,this._parts[this._parts.length-1])},set:function(e,r,n){return this.withParentAndKeyDo(e,n,function(e,n){return e?e[n]=r:void 0})},defineProperty:function(e,r,n){return this.withParentAndKeyDo(e,n,function(e,n){return e?Object.defineProperty(e,n,r):void 0})},get:function(e,r){var n=r?this._parts.slice(0,r):this._parts;return n.reduce(function(e,r){return e?e[r]:e},e)},concat:function(e,r){return Path(this.parts().concat(Path(e,r).parts()))},toString:function(){return this.normalizePath()},serializeExpr:function(){return"lively.lang.Path("+inspect(this.parts())+")"},watch:function(e){if(e&&!this.isRoot()){var r=e.target,n=this.get(r,-1),t=this.parts().slice(-1)[0],o="propertyWatcher$"+t,i=n&&n.hasOwnProperty(o),a=e.uninstall,u=(e.haltWhenChanged,e.showStack),c=n.__lookupGetter__(t),s=n.__lookupSetter__(t);if(r&&t&&n){if(a){if(!i)return;delete n[t],n[t]=n[o],delete n[o];var l="Watcher for "+n+"."+t+" uninstalled";return void show(l)}if(i){var l="Watcher for "+n+"."+t+" already installed";return void show(l)}if(c||s){var l=n+'["'+t+'"] is a getter/setter, watching not support';return console.log(l),void("undefined"==typeof show&&show(l))}n[o]=n[t],n.__defineSetter__(t,function(r){var i=n[o];e.onSet&&e.onSet(r,i);var a=n+"."+t+" changed: "+i+" -> "+r;return u&&(a+="\n"+("undefined"!=typeof lively?lively.printStack():console.trace())),e.verbose&&(console.log(a),"undefined"!=typeof show&&show(a)),n[o]=r}),n.__defineGetter__(t,function(){return e.onGet&&e.onGet(n[o]),n[o]});var l="Watcher for "+n+"."+t+" installed";console.log(l),"undefined"!=typeof show&&show(l)}}},debugFunctionWrapper:function(e){var r=e.target,n=this.get(r,-1),t=this.parts().slice(-1)[0],o=e.uninstall,i=(void 0===e.haltWhenChanged||e.haltWhenChanged,e.showStack),a=n&&t&&n[t],u=a&&a.isDebugFunctionWrapper;if(r&&t&&a&&n){if(o){if(!u)return;n[t]=n[t].debugTargetFunction;var c="Uninstalled debugFunctionWrapper for "+n+"."+t;return console.log(c),"undefined"!=typeof show&&show(c),void show(c)}if(u){var c="debugFunctionWrapper for "+n+"."+t+" already installed";return console.log(c),void("undefined"!=typeof show&&show(c))}var s=n[t]=a.wrap(function(r){var o=Array.from(arguments);return i&&show(lively.printStack()),e.verbose&&show(t+" called"),o.shift().apply(n,o)});s.isDebugFunctionWrapper=!0,s.debugTargetFunction=a;var c="debugFunctionWrapper for "+n+"."+t+" installed";console.log(c),"undefined"!=typeof show&&show(c)}}});var graph=Object.freeze({clone:clone$2,without:without$1,hull:hull,subgraphReachableBy:subgraphReachableBy,invert:invert,sortByReference:sortByReference,reduce:reduce$1,random:random$1}),GLOBAL$2="undefined"!=typeof System?System.global:"undefined"!=typeof window?window:global,interval=Object.freeze({isInterval:isInterval,sort:sort$2,compare:compare,coalesce:coalesce,coalesceOverlapping:coalesceOverlapping,mergeOverlapping:mergeOverlapping,intervalsInRangeDo:intervalsInRangeDo,intervalsInbetween:intervalsInbetween,mapToMatchingIndexes:mapToMatchingIndexes}),arrayProjection=Object.freeze({create:create,toArray:toArray$4,originalToProjectedIndex:originalToProjectedIndex,projectedToOriginalIndex:projectedToOriginalIndex,transformToIncludeIndex:transformToIncludeIndex}),grid=Object.freeze({get:get$2,set:set$2,getRow:getRow,setRow:setRow,getCol:getCol,setCol:setCol,create:create$1,mapCreate:mapCreate,forEach:forEach$2,map:map$2,toObjects:toObjects,tableFromObjects:tableFromObjects}),detect$1=find,tree=Object.freeze({prewalk:prewalk,postwalk:postwalk,find:find,detect:detect$1,filter:filter$1,map:map$3,mapTree:mapTree}),isNode$1="undefined"!=typeof process&&process.versions&&process.versions.node,makeEmitter=isNode$1?function(e,r){if(e.on&&e.removeListener)return e;var n="undefined"!=typeof System?System._nodeRequire("events"):require("events");return Object.assign(e,n.EventEmitter.prototype),n.EventEmitter.call(e),r&&r.maxListenerLimit&&e.setMaxListeners(r.maxListenerLimit),e}:function(e){return e.on&&e.removeListener?e:(e.listeners={},e.on=function(r,n){n&&(e.listeners[r]||(e.listeners[r]=[]),e.listeners[r].push(n))},e.once=function(r,n){function t(){e.removeListener(r,t),n.apply(this,arguments)}n&&e.on(r,t)},e.removeListener=function(r,n){e.listeners[r]&&(e.listeners[r]=e.listeners[r].filter(function(e){return e!==n}))},e.removeAllListeners=function(r){e.listeners[r]&&(e.listeners[r]=[])},e.emit=function(){var r=Array.prototype.slice.call(arguments),n=r.shift(),t=e.listeners[n];t&&t.length&&t.forEach(function(e){try{e.apply(null,r)}catch(e){console.error("Error in event handler: %s",e.stack||String(e))}})},e)},events=Object.freeze({makeEmitter:makeEmitter}),OFFLINE="offline",ONLINE="online",messenger=Object.freeze({create:create$2}),isNodejs="undefined"!=typeof require&&"undefined"!=typeof process,WorkerSetup={loadDependenciesBrowser:function(e){var r="undefined"!=typeof self?self:this;importScripts.apply(r,e.scriptsToLoad||[])},loadDependenciesNodejs:function(e){var r=global.lively||(global.lively={});r.lang=require(require("path").join(e.libLocation,"index"))},initBrowserGlobals:function(e){remoteWorker.send=function(e){postMessage(e)};var r="undefined"!=typeof self?self:this,n=r.Global=r;n.window=n,n.console=n.console||function(){var e={};return["log","error","warn"].forEach(function(r){e[r]=function(){for(var e=arguments[0],n=1;n<arguments.length;n++)e=e.replace("%s",arguments[n]);remoteWorker.send({type:r,message:["[",r.toUpperCase(),"] ",e].join("")})}}),e}()},initOnMessageHandler:function(e){function r(e){if(e=e.data.data?e.data:e,remoteWorker.messenger)remoteWorker.messenger.onMessage(e);else if("close"==e.action)return remoteWorker.send({type:"closed",workerReady:!1}),void remoteWorker.close()}remoteWorker.on?remoteWorker.on("message",r):remoteWorker.onmessage=r},initWorkerInterface:function initWorkerInterface(options){remoteWorker.callStringifiedFunction=function(stringifiedFunc,args,thenDo){var func;try{func=eval("("+stringifiedFunc+")")}catch(e){return void thenDo(new Error("Cannot create function from string: "+e.stack||e))}var usesCallback=func.length===args.length+1,whenDone=lively.lang.fun.once(function(e,r){remoteWorker.isBusy=!1,thenDo(e,r)});remoteWorker.isBusy=!0,usesCallback&&args.push(whenDone);try{var result=func.apply(remoteWorker,args.concat([whenDone]))}catch(e){return void whenDone(e,null)}usesCallback||whenDone(null,result)},remoteWorker.httpRequest=function(e){function r(){4===n.readyState&&e.done&&e.done(n)}if(!e.url)return void console.log("Error, httpRequest needs url");var n=new XMLHttpRequest,t=e.method||"GET";n.onreadystatechange=r,n.open(t,e.url),n.send()},remoteWorker.terminateIfNotBusyIn=function(e){setTimeout(function(){return remoteWorker.isBusy?void remoteWorker.terminateIfNotBusyIn(e):(remoteWorker.send({type:"closed",workerReady:!1}),void remoteWorker.close())},e)}},initWorkerMessenger:function initWorkerMessenger(options){if(!options.useMessenger)return null;if(!lively.lang.messenger)throw new Error("worker.create requires messenger.js to be loaded!");if(!lively.lang.events)throw new Error("worker.create requires events.js to be loaded!");return remoteWorker.messenger=lively.lang.messenger.create({services:{remoteEval:function remoteEval(msg,messenger){var result;try{result=eval(msg.data.expr)}catch(e){result=e.stack||e}messenger.answer(msg,{result:String(result)})},run:function(e,r){var n=e.data.func,t=e.data.args;return n?void remoteWorker.callStringifiedFunction(n,t,function(n,t){r.answer(e,{error:n?String(n):null,result:t})}):void r.answer(e,{error:"no funcString"})},close:function(e,r){r.answer(e,{status:"OK"}),remoteWorker.send({type:"closed",workerReady:!1}),remoteWorker.close()}},isOnline:function(){return!0},send:function(e,r){remoteWorker.send(e),r()},listen:function(e){e()},close:function(e){remoteWorker.send({type:"closed",workerReady:!1}),remoteWorker.close()}})}},BrowserWorker={create:function(e){function r(e,r){makeEmitter(r),e.scriptsToLoad||(e.scriptsToLoad=["base.js","events.js","object.js","collection.js","function.js","string.js","number.js","date.js","messenger.js","worker.js"].map(function(r){return e.libLocation+r}));var n=Object.keys(e).reduce(function(r,n){return"function"!=typeof e[n]&&(r[n]=e[n]),r},{});r.onmessage=function(e){void 0!==e.data.workerReady?(r.ready=!!e.data.workerReady,r.ready?r.emit("ready"):r.emit("close")):r.emit("message",e.data)},r.errors=[],r.onerror=function(e){console.error(e),r.errors.push(e),r.emit("error",e)},r.postMessage({action:"setup",options:n})}function n(){var e=self;e.onmessage=function(e){if("setup"!==e.data.action)throw new Error("expected setup to be first message but got "+JSON.stringify(e.data));var r=e.data.options||{};initBrowserGlobals(r),loadDependenciesBrowser(r),initOnMessageHandler(r),initWorkerInterface(r),initWorkerMessenger(r),postMessage({workerReady:!0})},__FUNCTIONDECLARATIONS__}function t(e){var r;try{r=new Blob([e],{type:"text/javascript"})}catch(n){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,r=new BlobBuilder,r.append(e),r=r.getBlob()}var n="undefined"!=typeof webkitURL?webkitURL:URL;return n.createObjectURL(r)}if(e=e||{},!e.libLocation&&!e.scriptsToLoad){var o=document.querySelector('script[src$="worker.js"]');if(!o)throw new Error('Cannot find library path to start worker. Use worker.create({libLocation: "..."}) to explicitly define the path!');e.libLocation=o.src.replace(/worker.js$/,"")}var i=String(n).replace("__FUNCTIONDECLARATIONS__",[WorkerSetup.initBrowserGlobals,WorkerSetup.loadDependenciesBrowser,WorkerSetup.initOnMessageHandler,WorkerSetup.initWorkerInterface,WorkerSetup.initWorkerMessenger].join("\n")),a="("+Closure.fromSource(i).getFuncSource()+")();",u=new Worker(t(a));return r(e,u),u}},NodejsWorker={debug:!1,initCodeFileCreated:!1,create:function(e){e=e||{};var r,n=makeEmitter({ready:!1,errors:[],postMessage:function(e){return r?n.ready?void r.send(e):void n.emit("error",new Error("nodejs worker process not ready or already closed")):void n.emit("error",new Error("nodejs worker process not yet created"))}});return NodejsWorker.startWorker(e,function(e,t){return e?(n.ready=!1,void n.emit("error",e)):(r=t,r.on("message",function(e){NodejsWorker.debug&&console.log("[WORKER PARENT] got message:",e),n.emit("message",e)}),r.on("close",function(){console.log("[WORKER PARENT] worker closed"),n.emit("close")}),r.on("error",function(e){console.log("[WORKER PARENT] error ",e),n.errors.push(e),n.emit("error",e)}),n.ready=!0,void n.emit("ready"))}),n},workerSetupFunction:function(){var e=process,r=!0;r&&console.log("[WORKER] Starting init"),e.on("message",function(n){if("setup"!==n.action)throw new Error("expected setup to be first message but got "+JSON.stringify(n.data));e.removeAllListeners("message");var t=n.data.options||{};r&&console.log("[WORKER] running setup with options",t),loadDependenciesNodejs(t),initOnMessageHandler(t),initWorkerInterface(t),initWorkerMessenger(t),e.send({workerReady:!0})}),__FUNCTIONDECLARATIONS__},ensureInitCodeFile:function(e,r,n){var t=require("path"),o=require("os"),i=require("fs"),a=t.join(o.tmpDir(),"lively-nodejs-workers/"),u=t.join(a,"nodejs-worker-init.js");NodejsWorker.initCodeFileCreated?i.exists(u,function(t){t?n(null,u):NodejsWorker.createWorkerCodeFile(e,u,r,n)}):NodejsWorker.createWorkerCodeFile(e,u,r,n)},createWorkerCodeFile:function(e,r,n,t){var o=require("path"),i=require("fs"),a=require("child_process").exec;a("mkdir -p "+o.dirname(r),function(e,o,a){return e?void t(new Error(["[WORKER PARENT] Could not create worker temp dir:",o,a].join("\n"))):void i.writeFile(r,n,function(e){NodejsWorker.debug&&console.log("worker code file %s created",r),NodejsWorker.initCodeFileCreated=!0,t(e,r)})})},startWorker:function(e,r){var n=require("util"),t=require("child_process").fork,o=String(NodejsWorker.workerSetupFunction).replace("__FUNCTIONDECLARATIONS__",[WorkerSetup.loadDependenciesNodejs,WorkerSetup.initOnMessageHandler,WorkerSetup.initWorkerInterface,WorkerSetup.initWorkerMessenger].join("\n")),i=n.format("(%s)();\n",o);NodejsWorker.ensureInitCodeFile(e,i,function(n,o){if(n)return r(n);var i=t(o,{});NodejsWorker.debug&&console.log("worker forked"),i.on("message",function(e){"pong"===e.action?console.log("[WORKER pong] ",e):"log"===e.action&&console.log("[Message from WORKER] ",e.data)}),i.once("message",function(e){NodejsWorker.debug&&console.log("worker setup done"),r(null,i,e)}),i.on("close",function(){NodejsWorker.debug&&console.log("[WORKER PARENT] worker closed")}),i.send({action:"setup",data:{options:e}}),global.WORKER=i})}},worker=Object.freeze({fork:fork,create:create$3}),GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:void 0,isNode="undefined"!=typeof process&&process.env&&"function"==typeof process.exit,globalInterfaceSpec=[{action:"installMethods",target:"Array",sources:["arr"],methods:["from","genN","range","withN"]},{action:"installMethods",target:"Array.prototype",sources:["arr"],methods:["all","any","batchify","clear","clone","collect","compact","delimWith","detect","doAndContinue","each","equals","filterByKey","findAll","first","flatten","forEachShowingProgress","grep","groupBy","groupByKey","histogram","include","inject","intersect","invoke","last","mapAsync","mapAsyncSeries","mask","max","min","mutableCompact","nestedDelay","partition","pluck","pushAll","pushAllAt","pushAt","pushIfNotIncluded","reMatches","reject","rejectByKey","remove","removeAt","replaceAt","rotate","shuffle","size","sortBy","sortByKey","sum","swap","toArray","toTuples","union","uniq","uniqBy","without","withoutAll","zip"],
alias:[["select","filter"]]},{action:"installMethods",target:"Date",sources:["date"],methods:[]},{action:"installMethods",target:"Date.prototype",sources:["date"],methods:["equals","format","relativeTo"]},{action:"installMethods",target:"Function",sources:["fun"],methods:["fromString"]},{action:"installMethods",target:"Function.prototype",sources:["fun"],methods:["addToObject","argumentNames","asScript","asScriptOf","binds","curry","delay","functionNames","localFunctionNames","getOriginal","getVarMapping","logCalls","logCompletion","logErrors","qualifiedMethodName","setProperty","traceCalls","wrap"]},{action:"installMethods",target:"Number",sources:["num"],methods:[]},{action:"installMethods",target:"Number.prototype",sources:["num"],methods:["detent","randomSmallerInteger","roundTo","toDegrees","toRadians"]},{action:"installMethods",target:"Object",sources:["obj"],methods:["addScript","clone","deepCopy","extend","inherit","isArray","isBoolean","isElement","isEmpty","isFunction","isNumber","isObject","isRegExp","isString","isUndefined","merge","mergePropertyInHierarchy","values","valuesInPropertyHierarchy"]},{action:"installMethods",target:"Object.prototype",sources:["obj"],methods:[]},{action:"installMethods",target:"String.prototype",sources:["string"],methods:["camelize","capitalize","digitValue","empty","hashCode","include","pad","regExpEscape","startsWithVowel","succ","times","toArray","toQueryParams","truncate"]},{action:"installObject",target:"Numbers",source:"num",methods:["average","between","convertLength","humanReadableByteSize","median","normalRandom","parseLength","random","sort"]},{action:"installObject",target:"Properties",source:"properties",methods:["all","allOwnPropertiesOrFunctions","allProperties","any","forEachOwn","hash","nameFor","own","ownValues","values"]},{action:"installObject",target:"Strings",source:"string",methods:["camelCaseString","createDataURI","diff","format","formatFromArray","indent","lineIndexComputer","lines","md5","newUUID","nonEmptyLines","pad","paragraphs","peekLeft","peekRight","print","printNested","printTable","printTree","quote","reMatches","stringMatch","tableize","tokens","unescapeCharacterEntities","withDecimalPrecision"]},{action:"installObject",target:"Objects",source:"obj",methods:["asObject","equals","inspect","isMutableType","safeToString","shortPrintStringOf","typeStringOf"]},{action:"installObject",target:"Functions",source:"fun",methods:["all","compose","composeAsync","createQueue","debounce","debounceNamed","either","extractBody","flip","notYetImplemented","once","own","throttle","throttleNamed","timeToRun","timeToRunN","waitFor","workerWithCallbackQueue","wrapperChain"]},{action:"installObject",target:"Grid",source:"grid"},{action:"installObject",target:"Interval",source:"interval"},{action:"installObject",target:"lively.ArrayProjection",source:"arrayProjection"},{action:"installObject",target:"lively.Closure",source:"Closure"},{action:"installObject",target:"lively.Grouping",source:"Group"},{action:"installObject",target:"lively.PropertyPath",source:"Path"},{action:"installObject",target:"lively.Worker",source:"worker"},{action:"installObject",target:"lively.Class",source:"classHelper"}],livelyLang=createLivelyLangObject();exports.worker=worker,exports.messenger=messenger,exports.events=events,exports.tree=tree,exports.grid=grid,exports.arrayProjection=arrayProjection,exports.interval=interval,exports.graph=graph,exports.date=date,exports.properties=properties,exports.obj=obj,exports.arr=arr,exports.fun=fun,exports.num=num,exports.string=string,exports.Closure=Closure,exports.promise=promise,exports.Path=Path,exports.Group=Group,exports.livelyLang=livelyLang,exports.chain=chain$$1,exports.noConflict=noConflict,exports.installGlobals=installGlobals,exports.uninstallGlobals=uninstallGlobals}(this.lively.lang=this.lively.lang||{})}.call(GLOBAL),"undefined"!=typeof module&&module.exports&&(module.exports=GLOBAL.lively.lang)}();
//LIVELY.NOTIFICATIONS - 5k
!function(){var i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(i,t){"use strict";var e=null;function n(i){if(void 0===i){if("undefined"==typeof System)return void 0!==e?e:e||(e={emitter:t.events.makeEmitter({},{maxListenerLimit:1e4}),notifications:[]});i=System}var n=i.get("@lively-env");n||i.set("@lively-env",i.newModule({options:{}}));var o=n.options;if(!o)throw new Error("@lively-env registered read-only");return o.emitter||Object.assign(o,{emitter:i["__lively.notifications_emitter"]||(i["__lively.notifications_emitter"]=t.events.makeEmitter({},{maxListenerLimit:1e4})),notifications:i["__lively.notifications_notifications"]||(i["__lively.notifications_notifications"]=[])}),{emitter:o.emitter,notifications:o.notifications}}i.subscribe=function(i,t,e){return n(e).emitter.on(i,t),t},i.subscribeOnce=function(i,t,e){return n(e).emitter.once(i,t),t},i.emit=function(i){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now(),r=arguments[3],s=Object.assign({type:i,time:o},e),l=n(r),c=l.emitter,f=l.notifications;return c.emit(i,s),c.isLogging&&function(i){var e=i.type+" ".repeat(Math.max(0,32-i.type.length));console.log(e+" "+t.obj.inspect(i,{maxDepth:2}))}(s),c.isRecording&&function(i,t){i.push(t),i.limit&&i.splice(0,i.length-i.limit)}(f,s),s},i.unsubscribe=function(i,t,e){return n(e).emitter.removeListener(i,t),t},i.unsubscribeAll=function(i,t){n(t).emitter.removeAllListeners(i)},i.startRecording=function(i){n(i).emitter.isRecording=!0},i.stopRecording=function(i){n(i).emitter.isRecording=!1},i.clearRecord=function(i){var t=n(i).notifications;t.splice(0,t.length)},i.getRecord=function(i){return n(i).notifications},i.startLogging=function(i){n(i).emitter.isLogging=!0},i.stopLogging=function(i){n(i).emitter.isLogging=!1}}(this.lively.notifications=this.lively.notifications||{},lively.lang),"undefined"!=typeof module&&module.exports&&(module.exports=i.lively.notifications)}();
//LIVELY.AST
lively.ast = {query: {}, acorn: {}, nodes: {}, BaseVisitor: function() {}};
//LIVELY.CLASSES - 45k
!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;void 0===lively.lang&&(e.lively.lang={})}(),function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=(function(){function e(e){this.value=e}function t(t){var r,n;function o(r,n){try{var a=t[r](n),l=a.value;l instanceof e?Promise.resolve(l.value).then(function(e){o("next",e)},function(e){o("throw",e)}):i(a.done?"return":"normal",a.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?o(r.key,r.arg):n=null}this._invoke=function(e,t){return new Promise(function(i,a){var l={key:e,arg:t,resolve:i,reject:a,next:null};n?n=n.next=l:(r=n=l,o(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,l=e[Symbol.iterator]();!(n=(a=l.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&l.return&&l.return()}finally{if(o)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},p="properties",y=Symbol.for("lively.classes-properties-and-settings"),f={defaultSetter:null,defaultGetter:null,valueStoreProperty:"_state"};function d(e){var t=b(e),r=t.properties,o=t.propertySettings;e[y]={properties:r,propertySettings:o,classHierarchy:S(e)},r&&"object"===(void 0===r?"undefined":n(r))?v(e,o,r):console.warn("Class "+e.name+" indicates it has managed properties but its properties accessor ("+p+") does not return a valid property descriptor map")}function v(e,r,n){!function(e){Object.defineProperty(e.prototype,"propertiesAndPropertySettings",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.constructor,t=e[y];if(t){if(t.classHierarchy==S(e))return t;var r=b(e),n=r.properties,o=r.propertySettings;e[y]={properties:n,propertySettings:o,classHierarchy:S(e)},v(e,o,n)}return e[y]||b(e)}}),Object.defineProperty(e.prototype,"initializeProperties",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r=this.propertiesAndPropertySettings(),n=r.properties,o=r.propertySettings;return function(e,r,n,o){var i=r.valueStoreProperty,a=t.obj.sortKeysWithBeforeAndAfterConstraints(n),l=[],s={};e.hasOwnProperty(i)||(e[i]={});for(var c=0;c<a.length;c++){var u=a[c],p=n[u],y=p.derived,f=!!p.foldable,d=p.hasOwnProperty("defaultValue")?p.defaultValue:void 0;Array.isArray(d)&&(d=d.slice()),y||f||(e[i][u]=d);var v=void 0;p.hasOwnProperty("initialize")?(v=s[u]={initialize:d},l.push(u)):y&&void 0!==d?(v=s[u]={derived:d},l.push(u)):f&&void 0!==d&&(v=s[u]={folded:d},l.push(u)),o&&u in o&&(p.readOnly?console.warn("Trying to initialize read-only property "+u+" in "+e+", skipping setting value"):(v||(v=s[u]={},l.push(u)),v.value=o[u]))}for(var c=0;c<l.length;c++){var b=l[c],h=s[b],g=h.hasOwnProperty("value");if(h.hasOwnProperty("initialize")){var m=g?h.value:h.initialize;n[b].initialize.call(e,m),g&&(e[b]=h.value)}else h.hasOwnProperty("derived")?e[b]=g?h.value:h.derived:h.hasOwnProperty("folded")?e[b]=g?h.value:h.folded:g&&(e[b]=h.value)}}(this,o,n,e),this}})}(e);var o=r.valueStoreProperty,i=r.defaultGetter,a=r.defaultSetter,l=e.prototype;Object.keys(n).forEach(function(e){var t=n[e],r=l.hasOwnProperty(e)&&l.__lookupGetter__(e);if(!r||r._wasGenerated){var s=t.get||"function"==typeof i&&function(){return i.call(this,e)}||function(){return this[o][e]};s._wasGenerated=!0,l.__defineGetter__(e,s)}var c=l.hasOwnProperty(e)&&l.__lookupSetter__(e);if((!c||c._wasGenerated)&&(t.hasOwnProperty("set")||!t.readOnly)){var u=t.set||"function"==typeof a&&function(t){a.call(this,e,t)}||function(t){this[o][e]=t};u._wasGenerated=!0,l.__defineSetter__(e,u)}})}function b(e){for(var r=l({},f),o={},i=t.obj.valuesInPropertyHierarchy(e,"propertySettings"),a=t.obj.valuesInPropertyHierarchy(e,"properties"),s=0;s<i.length;s++){var c=i[s];c&&"object"===(void 0===c?"undefined":n(c))&&Object.assign(r,c)}for(s=0;s<a.length;s++){var u=a[s];if("object"===(void 0===u?"undefined":n(u)))for(var p in u)o.hasOwnProperty(p)?Object.assign(o[p],u[p]):o[p]=u[p];else console.error("[initializeProperties] "+e+" encountered property declaration that is not a JS object: "+u)}return{properties:o,propertySettings:r}}var h=Symbol.for("lively-instance-initialize"),g=Symbol.for("lively-instance-restorer"),m=Symbol.for("lively-instance-superclass"),_=Symbol.for("lively-module-meta"),O=Symbol.for("lively-object-meta"),j=Symbol.for("lively-klass-changes-subscriber");function S(e){var t=e,r=[];do{r.push(t),t=t[m]}while(t&&t.name);return r.map(function(e){return e.name}).join("->")}var w=/\([^\\)]*\)/,P={enumerable:!1,configurable:!0},x={enumerable:!1,configurable:!0,writable:!0},k="function"==typeof Object.setPrototypeOf?function(e,t){return Object.setPrototypeOf(e,t)}:function(e,t){return e.__proto__=t};function C(e,t){var r=t?"function"==typeof t?t:t.value?t.value:Object:Object,n=e&&e[m];return n&&n===r||(!function(e){if(e===Object||e.prototype[h])return;Object.defineProperty(e.prototype,h,{enumerable:!1,configurable:!0,writable:!0,value:function(){e.apply(this,arguments)}}),e.prototype[h].displayName="lively-initialize-stub"}(r),e[m]=r,k(e.prototype,r.prototype),r!==Object&&k(e,r)),r}function E(e,t,r){if((r=Object.assign(r,x)).value.displayName=r.key,r.needsDeclaringClass){var n=r.value.originalFunction||r.value;r.value=Object.assign(function(){return n.call.apply(n,[this,t].concat(Array.prototype.slice.call(arguments)))},{originalFunction:n,toString:function(){return n.toString()},displayName:r.key})}Object.defineProperty(e,r.key,r)}function z(e,t){t=Object.assign(t,P),Object.defineProperty(e,t.key,t)}function A(e,t,r){r&&r.forEach(function(t){t.value?E(e,e,t):z(e,t)}),t&&t.forEach(function(t){t.value?E(e.prototype,e,t):z(e.prototype,t)}),e.prototype[h]?Object.getOwnPropertySymbols(e.prototype).includes(h)&&e.prototype[h].isDefaultInitializer&&e[m].prototype[h]&&delete e.prototype[h]:(Object.defineProperty(e.prototype,h,{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),e.prototype[h].isDefaultInitializer=!0,e.prototype[h].displayName="lively-initialize");for(var n=t.map(function(e){return e.key}).concat(["constructor","arguments","caller"]),o=Object.getOwnPropertyNames(e.prototype),i=0;i<o.length;i++){var a=o[i];n.includes(a)||delete e.prototype[a]}for(var l=r.map(function(e){return e.key}).concat(["length","name","prototype","arguments","caller"]),s=Object.getOwnPropertyNames(e),c=0;c<s.length;c++){var u=s[c];l.includes(u)||delete e[u]}}function D(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=arguments[5],a=arguments[6],l=e.name,s=l&&o.hasOwnProperty(l)&&o[l],c=s&&s[m];s&&"function"==typeof s&&c||(s=e);C(s,t);if(A(s,r,n),s[O]=a,i){var u=i.package(),p=s[_],y=Date.now();s[_]={package:u?{name:u.name,version:u.version}:{},pathInPackage:u?i.pathInPackage():i.id,lastChange:p&&p.lastChange&&y<=p.lastChange?p.lastChange+1:y,lastSuperclassChange:0},t&&t.referencedAs&&(s.hasOwnProperty(j)&&i.unsubscribeFromToplevelDefinitionChanges(s[j]),s[j]=i.subscribeToToplevelDefinitionChanges(function(e,o){if(e===t.referencedAs){var i=o&&o[_],a=s[_];if(i){if(i.lastChange===a.lastSuperclassChange)return;a.lastSuperclassChange=i.lastChange}C(s,o),A(s,r,n),d(s)}}))}return s.toString=function(){var e=String(this.prototype[h]).match(w),t=this.name,r=this[m];return"class "+t+" "+(r?"extends "+r.name:"")+" {\n  constructor"+(e?e[0]:"()")+" { /*...*/ }\n}"},d(s),s}D._get=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;return void 0===a?void 0:a.call(n)},D._set=function e(t,r,n,o){var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);null!==a&&e(a,r,n,o)}else if("value"in i&&i.writable)i.value=n;else{var l=i.set;void 0!==l&&l.call(o,n)}return n};var T=Object.freeze({initializeSymbol:h,instanceRestorerSymbol:g,superclassSymbol:m,moduleMetaSymbol:_,objMetaSymbol:O,moduleSubscribeToToplevelChangesSym:j,getClassHierarchy:S,setPrototypeOf:k,adoptObject:function(e,t){t!==e.constructor&&(e.constructor=t,k(e,t.prototype))},setSuperclass:C,initializeClass:D}),H=r.nodes.assign,N=r.nodes.member,I=r.nodes.id,M=r.nodes.exprStmt,F=r.nodes.funcCall,G=r.nodes.literal,R=r.nodes.objectLiteral,q=r.nodes.varDecl,J=r.nodes.funcExpr,V=r.nodes.returnStmt,W=r.nodes.binaryExpr,B=r.nodes.ifStmt,L=r.nodes.block;var U=/^[^_a-z]/i,K=/[^_a-z0-9]/gi;function Q(e){return J({id:e?I(e):null},["__first_arg__"],B(W(I("__first_arg__"),"&&",N("__first_arg__",F(N("Symbol","for"),G("lively-instance-restorer")),!0)),L(),L(M(F(N(N("this",F(N("Symbol","for"),G("lively-instance-initialize")),!0),"apply"),I("this"),I("arguments"))))))}var X=Symbol(),Y=Symbol(),Z="__lively_class__",$="__lively_classholder__",ee=function(e){function t(){return o(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,r.BaseVisitor),i(t,[{key:"accept",value:function(e,n,o){return function(e){return"ArrowFunctionExpression"===e.type||"FunctionExpression"===e.type||"FunctionDeclaration"===e.type}(e)&&(n=l({},n,{classHolder:R([]),currentMethod:e[Y]?e:n.currentMethod})),"ClassExpression"!==e.type&&"ClassDeclaration"!==e.type||(e=function(e,t,n,o){console.assert("ClassDeclaration"===e.type||"ClassExpression"===e.type);var i=e.body.body,s=e.superClass,u=e.id,p=e.type,y=e.start,f=e.end,d=I("undefined"),v=I("undefined"),b=u?u.name:"anonymous_class",h=o.evalId,g=o.sourceAccessorName,m=e["x-lively-object-meta"]||{start:y,end:f};if(i.length){var _=i.reduce(function(e,t){var r,n=t.key,o=t.kind,i=t.value,s=t.static;if("Literal"!==n.type&&"Identifier"!==n.type&&console.warn("Unexpected key in classToFunctionTransform! "+JSON.stringify(n)),"method"===o){var c=I(b+"_"+(n.name||n.value).replace(U,"_").replace(K,"_")+"_"),u=["key",G(n.name||n.value),"value",l({},i,a({id:c},Y,s?"static":"proto"))];r=R(u)}else if("get"===o||"set"===o)r=R(["key",G(n.name||n.value),o,Object.assign({},i,a({id:I(o)},Y,s?"static":"proto"))]);else if("constructor"===o){var p=["key",F(N("Symbol","for"),G("lively-instance-initialize")),"value",l({},i,a({id:I(b+"_initialize_")},Y,"proto"))];r=R(p)}else console.warn("[lively.classes] classToFunctionTransform encountered unknown class property with kind "+o+", ignoring it, "+JSON.stringify(t));return(s?e.clazz:e.inst).push(r),e},{inst:[],clazz:[]}),O=_.inst,j=_.clazz;O.length&&(d={type:"ArrayExpression",elements:O}),j.length&&(v={type:"ArrayExpression",elements:j})}var S,w,P=o.scope;if(s&&o.currentModuleAccessor)if(o.classHolder===s.object)w=s,S=s.property.name;else{var x=P&&P.resolvedRefMap&&P.resolvedRefMap.get(s),k=x&&x.decl&&P.decls&&P.decls.find(function(e){var t=c(e,1),r=t[0];return r===x.decl});k&&(w=s,S=s.name)}var C=w?R(["referencedAs",G(S),"value",w]):s||I("undefined"),E=u&&"ClassDeclaration"===p,z=["start",G(m.start),"end",G(m.end)];void 0!==h&&z.push("evalId",G(h));g&&z.push("moduleSource",r.nodes.id(g));var A=R(z),D=F(J({},["superclass"],q($,t.classHolder),q(Z,E?{type:"ConditionalExpression",test:W(F(N($,"hasOwnProperty"),G(u.name)),"&&",W({argument:N($,u),operator:"typeof",prefix:!0,type:"UnaryExpression"},"===",G("function"))),consequent:N($,u),alternate:H(N($,u),Q(u.name))}:Q(u?u.name:null)),V(F(o.functionNode,I(Z),I("superclass"),d,v,I($),o.currentModuleAccessor||I("undefined"),A))),C);if("ClassExpression"===p)return D;var T=D;o.declarationWrapper&&t.classHolder===o.classHolder&&(T=F(o.declarationWrapper,G(u.name),G("class"),T,o.classHolder,A));return(T=q(u,T,"var"))[X]=!0,T}(e,n,0,n.options)),"Super"===e.type&&(e=te(e,n,o,n.options)),"MemberExpression"===e.type&&e.object&&"Super"===e.object.type&&(e=function(e,t,r,n){return console.assert("MemberExpression"===e.type),console.assert("Super"===e.object.type),F(N(n.functionNode,"_get"),te(e.object,t,r.concat(["object"]),n),G(e.property.value||e.property.name),I("this"))}(e,n,o,n.options)),"AssignmentExpression"===e.type&&"MemberExpression"===e.left.type&&"Super"===e.left.object.type&&(e=function(e,t,r,n){return console.assert("AssignmentExpression"===e.type),console.assert("Super"===e.left.object.type),F(N(n.functionNode,"_set"),te(e.left.object,t,r.concat(["left","object"]),n),G(e.left.property.value||e.left.property.name),e.right,I("this"))}(e,n,o,n.options)),"CallExpression"===e.type&&"Super"===e.callee.type&&(e=function(e,t,r,n){return console.assert("CallExpression"===e.type),console.assert("Super"===e.callee.type),F.apply(void 0,[N(F(N(n.functionNode,"_get"),te(e.callee,t,r.concat(["callee"]),n),F(N("Symbol","for"),G("lively-instance-initialize")),I("this")),"call"),I("this")].concat(u(e.arguments)))}(e,n,o,n.options)),"CallExpression"===e.type&&e.callee.object&&"Super"===e.callee.object.type&&(e=function(e,t,r,n){return console.assert("CallExpression"===e.type),console.assert("Super"===e.callee.object.type),F.apply(void 0,[N(F(N(n.functionNode,"_get"),te(e.callee.object,t,r.concat(["callee","object"]),n),G(e.callee.property.value||e.callee.property.name),I("this")),"call"),I("this")].concat(u(e.arguments)))}(e,n,o,n.options)),"ExportDefaultDeclaration"===(e=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(n):void 0}(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"accept",this).call(this,e,n,o)).type?function(e,t,r,n){return e.declaration&&e.declaration[X]?[e.declaration,{declaration:e.declaration.declarations[0].id,type:"ExportDefaultDeclaration"}]:e}(e,0,0,n.options):e}}],[{key:"run",value:function(e,t){var r=new this,n=t.classHolder||R([]);return r.accept(e,{options:t,classHolder:n},[])}}]),t}();function te(e,t,n,o){console.assert("Super"===e.type);var i=t.currentMethod;i||console.warn("[lively.classes] Trying to transform es6 class but got super call outside a method! "+r.stringify(e)+" in "+n.join("."));var a=n.slice(-2),l=c(a,2),s=l[0],u=l[1];return"callee"===s&&"object"===u||"callee"===u?e:i&&"static"===i[Y]?F(N("Object","getPrototypeOf"),I(Z)):F(N("Object","getPrototypeOf"),N(I(Z),"prototype"))}e.runtime=T,e.classToFunctionTransform=function(e,t){var n="string"==typeof e?r.parse(e):e;return t.scope=r.query.resolveReferences(r.query.scopes(n)),ee.run(n,t)}}(this.lively.classes=this.lively.classes||{},lively.lang,lively.ast),"undefined"!=typeof module&&module.exports&&(module.exports=e.lively.classes)}();
//LIVELY.SOURCE-TRANSFORM - 45k
!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;void 0===lively.lang&&(e.lively.lang={})}(),function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(e,r,t,n){"use strict";!function(){function e(e){this.value=e}function r(r){var t,n;function a(t,n){try{var i=r[t](n),c=i.value;c instanceof e?Promise.resolve(c.value).then(function(e){a("next",e)},function(e){a("throw",e)}):o(i.done?"return":"normal",i.value)}catch(e){o("throw",e)}}function o(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?a(t.key,t.arg):n=null}this._invoke=function(e,r){return new Promise(function(o,i){var c={key:e,arg:r,resolve:o,reject:i,next:null};n?n=n.next=c:(t=n=c,a(e,r))})},"function"!=typeof r.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(r.prototype[Symbol.asyncIterator]=function(){return this}),r.prototype.next=function(e){return this._invoke("next",e)},r.prototype.throw=function(e){return this._invoke("throw",e)},r.prototype.return=function(e){return this._invoke("return",e)}}();var a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},o=function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)},i=n.nodes.member,c=n.nodes.prop,l=n.nodes.varDecl,s=n.nodes.assign,u=n.nodes.id,d=n.nodes.literal,p=n.nodes.exprStmt,f=n.nodes.conditional,m=n.nodes.binaryExpr,y=n.nodes.funcCall,v=n.query.topLevelDeclsAndRefs,h=n.query.helpers;function b(e,r){for(var t=r,n=1;e.indexOf(t)>-1;){if(n>1e3)throw new Error("Endless loop searching for unique variable "+t);t=t.replace(/_[0-9]+$|$/,"_"+ ++n)}return t}function x(e,r){return-1===r.excludeDecls.indexOf(e.id.name)&&(!r.includeDecls||r.includeDecls.indexOf(e.id.name)>-1)}var g=Symbol("lively.ast-destructuring-transform");function D(e,r){return"ArrayPattern"===e.type?function(e,r){for(var t=r.declaredNames,n=g,a=[],c=0;c<e.elements.length;c++){var s=e.elements[c];if("Identifier"===s.type){var d=l(s,i(r.parent,u(c),!0));d[n]={capture:!0},a.push(d)}else if("RestElement"===s.type){var d=l(s.argument,{type:"CallExpression",arguments:[{type:"Literal",value:c}],callee:i(r.parent,u("slice"),!1)});d[n]={capture:!0},a.push(d)}else if("AssignmentPattern"==s.type){var d=l(s.left,f(m(i(r.parent,u(c),!0),"===",u("undefined")),s.right,i(r.parent,u(c),!0)));d[n]={capture:!0},a.push(d)}else{var p=u(b(t,r.parent.name+"$"+c)),y=l(p,i(r.parent,c));t.push(p.name),a.push(y),a.push.apply(a,o(D(s,{parent:p,declaredNames:t})))}}return a}(e,r):"ObjectPattern"===e.type?function(e,r){for(var t=r.declaredNames,a=g,c=[],s=0;s<e.properties.length;s++){var d=e.properties[s];if("RestElement"==d.type){var p=e.properties.map(function(e){return e.key&&e.key.name}).filter(Boolean),y=n.nodes.varDecl(d.argument.name,n.nodes.objectLiteral([])),v=n.nodes.varDecl(d.argument.name,u(d.argument.name)),h=n.nodes.exprStmt(n.nodes.funcCall(n.nodes.funcExpr({},[],n.nodes.forIn("__key",r.parent,n.nodes.block.apply(n.nodes,o(p.length?p.map(function(e){return n.nodes.ifStmt(n.nodes.binaryExpr(n.nodes.id("__key"),"===",n.nodes.literal(e)),{type:"ContinueStatement",label:null},null)}):[]).concat([n.nodes.exprStmt(n.nodes.assign(n.nodes.member(d.argument.name,n.nodes.id("__key"),!0),n.nodes.member(r.parent,n.nodes.id("__key"),!0)))]))))));v[a]={capture:!0},c.push(y,v,h)}else if("Identifier"==d.value.type){var y=l(d.value,i(r.parent,d.key));y[a]={capture:!0},c.push(y)}else if("AssignmentPattern"==d.value.type){var y=l(d.value.left,f(m(i(r.parent,d.key),"===",u("undefined")),d.value.right,i(r.parent,d.key)));y[a]={capture:!0},c.push(y)}else{var x=u(b(t,r.parent.name+"$"+d.key.name)),E=l(x,i(r.parent,d.key));E[a]={capture:!1},t.push(x.name),c.push.apply(c,o([E].concat(D(d.value,{parent:x,declaredNames:t}))))}}return c}(e,r):[]}function E(e,r,t){var n=v(e),a=r.id.name;return n.declaredNames.indexOf(a)>-1?p(s(r.id,r.init)):{declarations:[r],kind:t||"var",type:"VariableDeclaration"}}function I(e,r,t,n){return p(s(i(e,r,n),t||u("undefined")))}function O(e,r,t,n,a){return w(n,e,j(r,t,a))}function j(e,r,t){return"string"==typeof e&&(e=d(e)),{arguments:[r].concat(e||[]),callee:t,type:"CallExpression"}}function w(e,t,n){return"string"==typeof t&&(t=d(t)),n=r.obj.deepCopy(n),y(e,t,n)}function F(e,r,t){return p(w(e,r,t))}function S(e,r,t,a,o,i,c){if(r){var l=[],s=!1;if(r["x-lively-object-meta"]){var u=r["x-lively-object-meta"],d=u.start,p=u.end,f=u.evalId,m=u.sourceAccessorName;s=!0,l.push("start",n.nodes.literal(d),"end",n.nodes.literal(p))}if(void 0===f&&c.hasOwnProperty("evalId")&&(f=c.evalId,s=!0),void 0===m&&c.hasOwnProperty("sourceAccessorName")&&(m=c.sourceAccessorName,s=!0),void 0!==f&&l.push("evalId",n.nodes.literal(f)),m&&l.push("moduleSource",n.nodes.id(m)),s)return y(e,t,a,o,i,n.nodes.objectLiteral(l))}return y(e,t,a,o,i)}var k=Object.freeze({rewriteToCaptureTopLevelVariables:function(e,s,f){s||(s={type:"Identifier",name:"__rec"});var m=e;if((f=a({ignoreUndeclaredExcept:null,includeRefs:null,excludeRefs:f&&f.exclude||[],includeDecls:null,excludeDecls:f&&f.exclude||[],recordDefRanges:!1,es6ExportFuncId:null,es6ImportFuncId:null,captureObj:s,moduleExportFunc:{name:f&&f.es6ExportFuncId||"_moduleExport",type:"Identifier"},moduleImportFunc:{name:f&&f.es6ImportFuncId||"_moduleImport",type:"Identifier"},declarationWrapper:void 0,classToFunction:f&&f.hasOwnProperty("classToFunction")?f.classToFunction:{classHolder:s,functionNode:{type:"Identifier",name:"_createOrExtendClass"},declarationWrapper:f&&f.declarationWrapper,evalId:f&&f.evalId,sourceAccessorName:f&&f.sourceAccessorName}},f)).ignoreUndeclaredExcept){var y=v(e);f.excludeRefs=r.arr.withoutAll(y.undeclaredNames,f.ignoreUndeclaredExcept).concat(f.excludeRefs),f.excludeDecls=r.arr.withoutAll(y.undeclaredNames,f.ignoreUndeclaredExcept).concat(f.excludeDecls)}return f.excludeRefs=f.excludeRefs.concat(f.captureObj.name),f.excludeDecls=f.excludeDecls.concat(f.captureObj.name),f.recordDefRanges&&function(e,t){var n=v(e);r.chain(n.scope.varDecls).pluck("declarations").flatten().value().concat(n.scope.funcDecls.filter(function(e){return e.id})).reduce(function(e,r){return e[r.id.name]||(e[r.id.name]=[]),e[r.id.name].push({type:r.type,start:r.start,end:r.end}),e},{})}(m),f.excludeRefs=f.excludeRefs.concat(function(e,t){for(var n=v(e),a=[],i=0;i<n.scope.varDecls.length;i++){var c=n.scope.varDecls[i],l=r.Path(n.scope.varDeclPaths[i]),s=l.slice(0,-1).get(e);"ForStatement"!==s.type&&"ForInStatement"!==s.type&&"ForOfStatement"!==s.type||a.push.apply(a,o(c.declarations))}return n.scope.catches.map(function(e){return e.name}).concat(h.declIds(a.map(function(e){return e.id})).map(function(e){return e.name}))}(e)),f.excludeDecls=f.excludeDecls.concat(function(e,t){for(var n=v(e),a=[],i=0;i<n.scope.varDecls.length;i++){var c=n.scope.varDecls[i],l=r.Path(n.scope.varDeclPaths[i]),s=l.slice(0,-1).get(e);"ForStatement"!==s.type&&"ForInStatement"!==s.type&&"ForOfStatement"!==s.type&&"ExportNamedDeclaration"!==s.type||a.push.apply(a,o(c.declarations))}return n.scope.catches.map(function(e){return e.name}).concat(a.map(function(e){return e.id.name}))}(e)),m=function(e,r){for(var t=[],n=0;n<e.body.length;n++){var a=e.body[n];"ExportDefaultDeclaration"===a.type&&"FunctionDeclaration"===a.declaration.type&&a.declaration.id&&a.declaration.async&&(t.push(a.declaration),a.declaration={type:"Identifier",name:a.declaration.id.name}),t.push(a)}return e.body=t,e}(m),f.es6ExportFuncId&&(f.excludeRefs.push(f.es6ExportFuncId),f.excludeRefs.push(f.es6ImportFuncId),m=function(e,r){return e.body=e.body.reduce(function(e,t){var n,a,o,c;if("ExportNamedDeclaration"===t.type)if(t.source){var s=f=t.source;n=t.specifiers.map(function(e){return{type:"ExpressionStatement",expression:O({type:"Literal",value:e.exported.name},{type:"Literal",value:e.local.name},f,r.moduleExportFunc,r.moduleImportFunc)}})}else if(t.declaration){var u=t.declaration.declarations;n=u?u.map(function(e){return r.excludeDecls.push(e.id),l(e.id,I(r.captureObj,e.id,r.declarationWrapper?S(r.declarationWrapper,null,d(e.id.name),d(t.declaration.kind),e,r.captureObj,r):e.init,!1),t.declaration.kind)}).concat(u.map(function(e){return F(r.moduleExportFunc,e.id.name,e.id)})):[t.declaration].concat(F(r.moduleExportFunc,t.declaration.id.name,t.declaration.id))}else n=t.specifiers.map(function(e){return F(r.moduleExportFunc,e.exported.name,x({id:e.local},r)?i(r.captureObj,e.local):e.local)});else if("ExportDefaultDeclaration"===t.type)n=t.declaration&&t.declaration.id?[t.declaration].concat(F(r.moduleExportFunc,"default",t.declaration.id)):[F(r.moduleExportFunc,"default",t.declaration)];else if("ExportAllDeclaration"===t.type){s={name:r.es6ExportFuncId+"__iterator__",type:"Identifier"};var f=t.source;n=[{type:"ForInStatement",body:{type:"ExpressionStatement",expression:O(s,s,f,r.moduleExportFunc,r.moduleImportFunc)},left:{type:"VariableDeclaration",kind:"var",declarations:[{type:"VariableDeclarator",id:s,init:null}]},right:j(null,f,r.moduleImportFunc)}],r.excludeRefs.push(s.name),r.excludeDecls.push(s.name)}else n="ImportDeclaration"===t.type?t.specifiers.length?t.specifiers.map(function(e){return function(e,r,t,n,a){return l(r,j(t,n,a))}(0,e.local,"ImportSpecifier"===e.type&&e.imported.name||"ImportDefaultSpecifier"===e.type&&"default"||null,t.source,r.moduleImportFunc)}):(a=null,o=t.source,c=r.moduleImportFunc,p(j(a,o,c))):[t];return e.concat(n)},[]),e}(m,f)),m=function(e,t){var n=v(e).scope,o=n.funcDecls;if(!o.length)return e;for(var i=[],c=o.length;c--;){var l=o[c];if(l.id&&x(l,t)){var s=n.funcDeclPaths[c].slice(0,-1),u=r.Path(s).get(n.node),f={type:"Identifier",name:l.id.name},m=t.declarationWrapper?S(t.declarationWrapper,l,d(f.name),d("function"),f,t.captureObj,t):f,y=a({},l);if(Array.isArray(u))u.splice(u.indexOf(l),1,p(l.id));else if("ExportNamedDeclaration"===u.type){var h=n.node.body.indexOf(u);h>-1&&n.node.body.splice(h,1,{type:"ExportNamedDeclaration",specifiers:[{type:"ExportSpecifier",exported:l.id,local:l.id}]})}else"ExportDefaultDeclaration"===u.type&&(u.declaration=l.id);i.unshift(I(t.captureObj,f,m,!1)),i.unshift(y)}}return e.body=i.concat(e.body),e}(m=function(e,r){for(var t=v(e),n=[],a=0;a<e.body.length;a++){var o=e.body[a];"ExportDefaultDeclaration"!==o.type||!o.declaration||o.declaration.type.includes("Declaration")||"Identifier"!==o.declaration.type&&!o.declaration.id?"ExportNamedDeclaration"!==o.type||!o.specifiers.length||o.source?n.push(o):n=n.concat(o.specifiers.map(function(n){return t.declaredNames.includes(n.local.name)?null:E(e,{type:"VariableDeclarator",id:n.local,init:i(r.captureObj,n.local)})}).filter(Boolean)).concat(o):n=n.concat([E(e,{type:"VariableDeclarator",id:o.declaration,init:i(r.captureObj,o.declaration)}),o])}return e.body=n,e}(m=function(e,r){return e.body=e.body.reduce(function(e,t){return e.concat("ImportDeclaration"===t.type&&t.specifiers.length?[t].concat(t.specifiers.map(function(e){return I(r.captureObj,e.local,e.local,!1)})):[t])},[]),e}(m=function(e,t){for(var n=[],a=0;a<e.body.length;a++){var i=e.body[a];if(n.push(i),"ExportNamedDeclaration"!==i.type&&"ExportDefaultDeclaration"!==i.type||!i.declaration);else if("ExportDefaultDeclaration"===i.type&&"Literal"===i.declaration.type){var c=i.declaration,l=(c.raw,b(v(e).declaredNames,"$"+c.raw.split('"').join("")));i.declaration=u(l),r.arr.pushAt(n,I(t.captureObj,l,c.raw,!1),n.indexOf(i))}else i.declaration.declarations?n.push.apply(n,o(i.declaration.declarations.map(function(e){var r=e.id;if(t.declarationWrapper){var n=e.init.callee&&e.init.callee.name===t.declarationWrapper.name;n||(r=S(t.declarationWrapper,e,d(e.id.name),d("assignment"),e.id,t.captureObj,t))}return I(t.captureObj,e.id,r,!1)}))):"FunctionDeclaration"===i.declaration.type||"ClassDeclaration"===i.declaration.type&&n.push(I(t.captureObj,i.declaration.id,i.declaration.id,!1))}return e.body=n,e}(m=function(e,r){for(var t=e.body,n=e.body=[],a=0;a<t.length;a++){var o=t[a];if("ExportNamedDeclaration"!==o.type||!o.declaration||"VariableDeclaration"!==o.declaration.type||o.declaration.declarations.length<=1)n.push(o);else for(var i=o.declaration.declarations,c=0;c<i.length;c++)n.push({type:"ExportNamedDeclaration",specifiers:[],declaration:l(i[c].id,i[c].init,o.declaration.kind)})}return e}(m=function(e,r){if(r.classToFunction)return t.classToFunctionTransform(e,r.classToFunction);var n=v(e);if(!n.classDecls.length)return e;for(var a=e.body.length-1;a>=0;a--){var o=e.body[a];o.id&&n.classDecls.includes(o)&&e.body.splice(a+1,0,I(r.captureObj,o.id,o.id,!1))}return e}(m=function(e,r){var t=v(e);return n.ReplaceManyVisitor.run(e,function(e){if(!t.varDecls.includes(e)||e.declarations.every(function(e){return!x(e,r)}))return e;for(var n=[],a=0;a<e.declarations.length;a++){var c=e.declarations[a];if(x(c,r)){var s=c.init||{operator:"||",type:"LogicalExpression",left:{computed:!1,object:r.captureObj,property:c.id,type:"MemberExpression"},right:{name:"undefined",type:"Identifier"}},u=r.declarationWrapper&&c.id.name?S(r.declarationWrapper,c,d(c.id.name),d(e.kind),s,r.captureObj,r):s;if(c.id.type.includes("Pattern")){var p=b(t.declaredNames,"destructured_1"),f={type:"Identifier",name:p},m={parent:f,declaredNames:t.declaredNames},y=D(c.id,m).map(function(t){return t[g]&&t[g].capture?I(r.captureObj,t.declarations[0].id,r.declarationWrapper?S(r.declarationWrapper,null,d(t.declarations[0].id.name),d(e.kind),t.declarations[0].init,r.captureObj,r):t.declarations[0].init,!1):t});t.declaredNames.push(p),n.push.apply(n,o([l(f,u,e.kind)].concat(y)))}else n.push(I(r.captureObj,c.id,u,!1)),r.keepTopLevelVarDecls&&n.push(l(c.id,i(r.captureObj,c.id)))}else n.push({type:"VariableDeclaration",kind:e.kind||"var",declarations:[c]})}return n})}(m=function(e,r){var t=v(e),l=t.refs.filter(function(e){return function(e,r,t){if(r.scope.importSpecifiers.includes(e))return!1;for(var n=0;n<r.scope.exportDecls.length;n++){var a=r.scope.exportDecls[n];if(a.declarations&&a.declarations.includes(e))return!1;if(a.declaration===e)return!1}return!(t.excludeRefs.includes(e.name)||t.includeRefs&&!t.includeRefs.includes(e.name))}(e,t,r)}),s=[],p=n.ReplaceVisitor.run(e,function(e,t){if("Property"===e.type&&l.includes(e.key)&&e.shorthand)return c(u(e.key.name),e.value);if("ExportNamedDeclaration"===e.type){var n=e.declaration,i=e.specifiers;return n&&(n.id?s.push(n.id):n.declarations&&s.push.apply(s,o(n.declarations.map(function(e){var r=e.id;return r})))),i&&i.forEach(function(e){var r=e.local;return s.push(r)}),e}return"AssignmentExpression"===e.type&&l.includes(e.left)&&r.declarationWrapper?a({},e,{right:S(r.declarationWrapper,null,d(e.left.name),d("assignment"),e.right,r.captureObj,r)}):e});return n.ReplaceVisitor.run(p,function(e,t,n){return l.includes(e)&&!s.includes(e)?i(r.captureObj,e):e})}(m,f),f),f)),f),f),f),f)},rewriteToRegisterModuleToCaptureSetters:function(e,t,o){o=a({captureObj:t||{type:"Identifier",name:"__rec"},exclude:[],declarationWrapper:void 0},o);var c=r.Path("body.0.expression").get(e);if("System"!==c.callee.object.name)throw new Error("rewriteToRegisterModuleToCaptureSetters: input doesn't seem to be a System.register call: "+n.stringify(e).slice(0,300)+"...");if("register"!==c.callee.property.name)throw new Error("rewriteToRegisterModuleToCaptureSetters: input doesn't seem to be a System.register call: "+n.stringify(e).slice(0,300)+"...");var l=r.Path("arguments.1.body.body").get(c),u=r.arr.last(l);if("ReturnStatement"!==u.type)throw new Error("rewriteToRegisterModuleToCaptureSetters: input doesn't seem to be a System.register call, at return statement: "+n.stringify(e).slice(0,300)+"...");var f=u.argument.properties.find(function(e){return"setters"===e.key.name});if(!f)throw new Error("rewriteToRegisterModuleToCaptureSetters: input doesn't seem to be a System.register call, at finding setters: "+n.stringify(e).slice(0,300)+"...");var m=u.argument.properties.find(function(e){return"execute"===e.key.name});if(!m)throw new Error("rewriteToRegisterModuleToCaptureSetters: input doesn't seem to be a System.register call, at finding execute: "+n.stringify(e).slice(0,300)+"...");f.value.elements.forEach(function(e){return e.body.body=e.body.body.map(function(e){if("ExpressionStatement"!==e.type||"AssignmentExpression"!==e.expression.type||"Identifier"!==e.expression.left.type||r.arr.include(o.exclude,e.expression.left.name))return e;var t=e.expression.left,n=o.declarationWrapper?S(o.declarationWrapper,null,d(t.name),d("var"),e.expression,o.captureObj,o):e.expression;return p(s(i(o.captureObj,t),n))})});var y=m.value.body.body.find(function(e){return"ExpressionStatement"===e.type&&"AssignmentExpression"==e.expression.type&&e.expression.left.name===o.captureObj.name});if(y||(y=m.value.body.body.find(function(e){return"VariableDeclaration"===e.type&&e.declarations[0].id&&e.declarations[0].id.name===o.captureObj.name})),y&&(r.arr.remove(m.value.body.body,y),r.arr.pushAt(l,y,l.length-1)),o.sourceAccessorName){var v=m.value.body.body.find(function(e){return"ExpressionStatement"===e.type&&"AssignmentExpression"==e.expression.type&&e.expression.left.name===o.sourceAccessorName});v||(v=m.value.body.body.find(function(e){return"VariableDeclaration"===e.type&&e.declarations[0].id&&e.declarations[0].id.name===o.sourceAccessorName})),v&&(r.arr.remove(m.value.body.body,v),r.arr.pushAt(l,v,l.length-1))}return e}});e.capturing=k,e.stringifyFunctionWithoutToplevelRecorder=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"__lvVarRecorder";if("function"==typeof e&&(e=String(e)),lively.FreezerRuntime)return e.split(r).join("");var t="string"==typeof e?n.parseFunction(e):e,a=n.ReplaceVisitor.run(t,function(e){return"MemberExpression"===e.type&&"Identifier"===e.object.type&&e.object.name===r?e.property:e});return n.stringify(a)}}(this.lively.sourceTransform=this.lively.sourceTransform||{},lively.lang,lively.classes,lively.ast),"undefined"!=typeof module&&module.exports&&(module.exports=e.lively.sourceTransform)}();
//LIVELY.VM
//LIVELY.RESOURCES - 100k
!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(e,t){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=(function(){function e(e){this.value=e}function t(t){var r,n;function i(r,n){try{var a=t[r](n),o=a.value;o instanceof e?Promise.resolve(o.value).then(function(e){i("next",e)},function(e){i("throw",e)}):s(a.done?"return":"normal",a.value)}catch(e){s("throw",e)}}function s(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?i(r.key,r.arg):n=null}this._invoke=function(e,t){return new Promise(function(s,a){var o={key:e,arg:t,resolve:s,reject:a,next:null};n?n=n.next=o:(r=n=o,i(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(i,s){try{var a=t[i](s),o=a.value}catch(e){return void r(e)}if(!a.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}("next")})}}),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,r,n)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(n):void 0},u=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},h=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function f(e,t){return Array.isArray(e)?e.reduce(function(e,t){return f(t,e)},t):"string"==typeof e?t.filter(function(t){return t.path()!==e&&t.name()!==e}):e instanceof RegExp?t.filter(function(t){return!e.test(t.path())&&!e.test(t.name())}):"function"==typeof e?t.filter(function(t){return!e(t)}):t}function l(e){var t=(e=e).split("?"),r=h(t,2),n=(r[0],r[1]),i={};if(!n)return i;var s=n.split("&");if(s)for(var a=0;a<s.length;a++){var o=s[a].split("="),u=o[0],c=!0;if(o.length>1)if("undefined"===(c=decodeURIComponent(o.slice(1).join("="))))c=void 0;else if(c.match(/^(true|false|null|[0-9"[{].*)$/))try{c=JSON.parse(c)}catch(e){"["===c[0]&&(c=c.slice(1,-1).split(","))}i[u]=c}return i}var p=/^([^:\/]+):\/\/([^\/]*)(.*)/,v=/\/\.\//g,y=/\/[^\/]+\/\.\./,m=/(^|[^:])[\/]+/g;function d(e){var t=e,r=t;do{r=(t=r).replace(y,"")}while(r!=t);return r=(r=r.replace(m,"$1/")).replace(v,"/")}function x(e,t){var r=e.match(p),n=t.match(p),i=void 0,s=void 0,a=void 0,o=void 0,u=!0;if((r&&!n||!r&&n)&&(u=!1),r&&n&&(i=r[1],s=r[2],a=n[1],o=n[2],i!==a?u=!1:s!==o?u=!1:(e=r[3],t=n[3])),!u)throw new Error("[relativePathBetween] incompatible paths: "+e+" vs. "+t);if((e=d(e))==(t=d(t)))return"";var c=function(e,t){e.startsWith("/")&&(e=e.slice(1)),t.startsWith("/")&&(t=t.slice(1));for(var r=e.split("/"),n=t.split("/"),i=0;i<n.length&&r[i]&&r[i]==n[i];i++);return"../".repeat(Math.max(0,n.length-i-1))+r.splice(i,r.length).join("/")}(t,e);if(!c)throw new Error("pathname differs in relativePathFrom "+e+" vs "+t);return c}var k=/\/+$/,w=/^\/+/,b=/^[a-z0-9-_\.]+:/,g=/^\/\/[^\/]+/;function R(e,t){throw new Error(t+" for "+e.constructor.name+" not yet implemented")}var P=function(){function e(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(i(this,e),!t)throw new Error("Cannot create resource without url");this.url=String(t),this.binary=!1,this.lastModified=void 0,this.created=void 0,this.etag=void 0,this.size=void 0,this.type=void 0,this.contentType=void 0,this.user=void 0,this.group=void 0,this.mode=void 0,this._isDirectory=void 0,this._isLink=void 0,this.linkCount=void 0}return s(e,null,[{key:"fromProps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new this(e.url).assignProperties(e)}}]),s(e,[{key:"equals",value:function(e){if(!e||this.constructor!==e.constructor)return!1;var t=this.url,r=e.url;return"/"===t[t.length-1]&&(t=t.slice(0,-1)),"/"===r[r.length-1]&&(r=r.slice(0,-1)),t===r}},{key:"toString",value:function(){return this.constructor.name+'("'+this.url+'")'}},{key:"newResource",value:function(e){return $(e)}},{key:"path",value:function(){var e=this.url.replace(b,"").replace(g,"");return""===e?"/":e}},{key:"pathWithoutQuery",value:function(){return this.path().split("?")[0]}},{key:"name",value:function(){var e=this.path(),t=e.lastIndexOf("?");t>-1&&(e=e.slice(0,t)),e.endsWith("/")&&(e=e.slice(0,-1));var r=e.split("/"),n=r[r.length-1];return decodeURIComponent(n)}},{key:"ext",value:function(){var e=this.url;if(e.endsWith("/"))return"";var t=e.match(/\.([^\/\.]+$)/)||["",""],r=h(t,2),n=(r[0],r[1]);return n.toLowerCase()}},{key:"nameWithoutExt",value:function(){var e=this.name(),t=e.lastIndexOf(".");return t>0&&(e=e.slice(0,t)),e}},{key:"scheme",value:function(){return this.url.split(":")[0]}},{key:"host",value:function(){var e=this.url.indexOf("://");if(-1===e)return null;var t=this.url.slice(e+3),r=t.indexOf("/");return t.slice(0,r>-1?r:t.length)}},{key:"schemeAndHost",value:function(){return this.isRoot()?this.asFile().url:this.url.slice(0,this.url.length-this.path().length)}},{key:"parent",value:function(){return this.isRoot()?null:this.newResource(this.url.replace(k,"").split("/").slice(0,-1).join("/")+"/")}},{key:"parents",value:function(){for(var e=[],t=this.parent();t;)e.unshift(t),t=t.parent();return e}},{key:"isParentOf",value:function(e){var t=this;return e.schemeAndHost()===this.schemeAndHost()&&e.parents().some(function(e){return e.equals(t)})}},{key:"query",value:function(){return l(this.url)}},{key:"withQuery",value:function(e){var t=a({},this.query(),e),r=this.url.split("?"),n=h(r,1)[0],i=Object.keys(t).map(function(e){return e+"="+encodeURIComponent(String(t[e]))}).join("&");return this.newResource(n+"?"+i)}},{key:"commonDirectory",value:function(e){if(e.schemeAndHost()!==this.schemeAndHost())return null;if(this.isDirectory()&&this.equals(e))return this;if(this.isRoot())return this.asDirectory();if(e.isRoot())return e.asDirectory();for(var t=e.parents(),r=this.parents(),n=this.root(),i=0;i<r.length;i++){var s=r[i],a=t[i];if(!a||!s.equals(a))return n;n=s}return n}},{key:"withRelativePartsResolved",value:function(){var e=this.path(),t=d(e);return t===e?this:(t.startsWith("/")&&(t=t.slice(1)),this.newResource(this.root().url+t))}},{key:"relativePathFrom",value:function(e){return x(e.url,this.url)}},{key:"withPath",value:function(e){return(this.isRoot()?this:this.root()).join(e)}},{key:"join",value:function(e){return this.newResource(this.url.replace(k,"")+"/"+e.replace(w,""))}},{key:"isRoot",value:function(){return"/"===this.path()}},{key:"isFile",value:function(){return!this.isRoot()&&!this.url.match(k)}},{key:"isDirectory",value:function(){return!this.isFile()}},{key:"asDirectory",value:function(){return this.url.endsWith("/")?this:this.newResource(this.url.replace(k,"")+"/")}},{key:"root",value:function(){if(this.isRoot())return this;var e=this.url.slice(0,-this.path().length);return this.newResource(e+"/")}},{key:"asFile",value:function(){return this.url.endsWith("/")?this.newResource(this.url.replace(k,"")):this}},{key:"assignProperties",value:function(e){for(var t in e)if("url"!==t){var r=t;"isLink"!==t&&"isDirectory"!==t||(r="_"+t),this[r]=e[t]}return this}},{key:"ensureExistance",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.exists();case 2:if(!e.sent){e.next=4;break}return e.abrupt("return",this);case 4:return e.next=6,this.parent().ensureExistance();case 6:if(!this.isFile()){e.next=11;break}return e.next=9,this.write(t||"");case 9:e.next=13;break;case 11:return e.next=13,this.mkdir();case 13:return e.abrupt("return",this);case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"copyTo",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r,n,i,s=this,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isFile()){e.next=13;break}if(r=t.isFile()?t:t.join(this.name()),!a){e.next=5;break}return e.next=5,r.parent().ensureExistance();case 5:return e.t0=r,e.next=8,this.read();case 8:return e.t1=e.sent,e.next=11,e.t0.write.call(e.t0,e.t1);case 11:e.next=25;break;case 13:if(t.isDirectory()){e.next=15;break}throw new Error("Cannot copy a directory to a file!");case 15:return e.next=17,this.dirList("infinity");case 17:return n=e.sent,i=n.map(function(e){return t.join(e.relativePathFrom(s))}),e.next=21,t.ensureExistance();case 21:return e.next=23,n.reduceRight(function(e,t,r){return function(){return Promise.resolve(t.isDirectory()&&i[r].ensureExistance()).then(e)}},function(){return Promise.resolve()})();case 23:return e.next=25,n.reduceRight(function(e,t,r){return function(){return Promise.resolve(t.isFile()&&t.copyTo(i[r],!1)).then(e)}},function(){return Promise.resolve()})();case 25:return e.abrupt("return",this);case 26:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"rename",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.copyTo(t);case 2:return this.remove(),e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"beBinary",value:function(e){return this.setBinary(!0)}},{key:"setBinary",value:function(e){return this.binary=e,this}},{key:"read",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"read");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"write",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"write");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"mkdir",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"mkdir");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"exists");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"remove");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"dirList",value:function(){var e=n(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"dirList");case 1:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"readProperties",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:R(this,"readProperties");case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"writeJson",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.write(t?JSON.stringify(e,null,2):JSON.stringify(e))}},{key:"readJson",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=JSON,e.next=3,this.read();case 3:return e.t1=e.sent,e.abrupt("return",e.t0.parse.call(e.t0,e.t1));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"__serialize__",value:function(){return{__expr__:'var r = null; try { r = resource("'+this.url+'");} catch (err) {}; r',bindings:{"lively.resources":["resource"]}}}},{key:"isResource",get:function(){return!0}},{key:"canDealWithJSON",get:function(){return!1}}]),e}(),_=function(){function e(t){i(this,e),this.expression=t,this.contextNode=null,this.xpe=new XPathEvaluator}return s(e,[{key:"establishContext",value:function(e){if(!this.nsResolver){var t=e.ownerDocument?e.ownerDocument.documentElement:e.documentElement;t!==this.contextNode&&(this.contextNode=t,this.nsResolver=this.xpe.createNSResolver(t))}}},{key:"manualNSLookup",value:function(){return this.nsResolver=function(e){return Namespace[e.toUpperCase()]||null},this}},{key:"findAll",value:function(e,t){this.establishContext(e);for(var r=this.xpe.evaluate(this.expression,e,this.nsResolver,XPathResult.ANY_TYPE,null),n=[],i=null;i=r.iterateNext();)n.push(i);return n.length>0||void 0===t?n:t}},{key:"findFirst",value:function(e){return this.establishContext(e),this.xpe.evaluate(this.expression,e,this.nsResolver,XPathResult.ANY_TYPE,null).iterateNext()}}]),e}();var S={getlastmodified:"lastModified",creationDate:"created",getetag:"etag",getcontentlength:"size",resourcetype:"type",getcontenttype:"contentType"};function T(e){var t=(new DOMParser).parseFromString(e,"text/xml"),r=function(e){var t=e.match(/\/([a-z]+?):multistatus/i);return t?t[1]:"d"}(e),n=new _("/"+r+":multistatus/"+r+":response").findAll(t.documentElement),i=new _(r+":href"),s=new _(r+":propstat/"+r+":prop");return n.map(function(e){var t=s.findFirst(e),r=Array.from(t.childNodes).reduce(function(e,t){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.tagName.replace(/[^:]+:/,""),n=S[r],i=e.textContent;switch(n){case"lastModified":case"created":i=new Date(i);break;case"size":i=Number(i)}return t[n]=i,t}(t,e)},{}),n=i.findFirst(e);return r.url=n.textContent||n.text,r})}var E=["3ds","3g2","3gp","7z","a","aac","adp","ai","aif","aiff","alz","ape","apk","ar","arj","asf","au","avi","bak","bh","bin","bk","bmp","btif","bz2","bzip2","cab","caf","cgm","class","cmx","cpio","cr2","csv","cur","dat","deb","dex","djvu","dll","dmg","dng","doc","docm","docx","dot","dotm","dra","DS_Store","dsk","dts","dtshd","dvb","dwg","dxf","ecelp4800","ecelp7470","ecelp9600","egg","eol","eot","epub","exe","f4v","fbs","fh","fla","flac","fli","flv","fpx","fst","fvt","g3","gif","graffle","gz","gzip","h261","h263","h264","icns","ico","ief","img","ipa","iso","jar","jpeg","jpg","jpgv","jpm","jxr","key","ktx","lha","lvp","lz","lzh","lzma","lzo","m3u","m4a","m4v","mar","mdi","mht","mid","midi","mj2","mka","mkv","mmr","mng","mobi","mov","movie","mp3","mp4","mp4a","mpeg","mpg","mpga","mxu","nef","npx","numbers","o","oga","ogg","ogv","otf","pages","pbm","pcx","pdf","pea","pgm","pic","png","pnm","pot","potm","potx","ppa","ppam","ppm","pps","ppsm","ppsx","ppt","pptm","pptx","psd","pya","pyc","pyo","pyv","qt","rar","ras","raw","rgb","rip","rlc","rmf","rmvb","rtf","rz","s3m","s7z","scpt","sgi","shar","sil","sketch","slk","smv","so","sub","swf","tar","tbz","tbz2","tga","tgz","thmx","tif","tiff","tlz","ttc","ttf","txz","udf","uvh","uvi","uvm","uvp","uvs","uvu","viv","vob","war","wav","wax","wbmp","wdp","weba","webm","webp","whl","wim","wm","wma","wmv","wmx","woff","woff2","wvx","xbm","xif","xla","xlam","xls","xlsb","xlsm","xlsx","xlt","xltm","xltx","xm","xmind","xpi","xpm","xwd","xz","z","zip","zipx"],O="undefined"!=typeof System?System.get("@system-env").node:"undefined"!=typeof global&&"undefined"!=typeof process;function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GET",r=arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=e.url,s=e.useCors,o=e.useProxy,u=e.headers,c=(s=void 0===s||s,{method:t});return(o=void 0===o||o)&&(Object.assign(n,{pragma:"no-cache","cache-control":"no-cache","x-lively-proxy-request":i}),i=e.proxyDomain||document.location.origin),s&&(c.mode="cors"),r&&(c.body=r),c.redirect="follow",c.headers=a({},n,u),fetch(i,c)}var C={name:"http-webdav-resource",matches:function(e){return e.startsWith("http:")||e.startsWith("https:")},resourceClass:function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,t);var n=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.useProxy=!!r.hasOwnProperty("useProxy")&&r.useProxy,n.proxyDomain=r.proxyDomain||void 0,n.useCors=!!r.hasOwnProperty("useCors")&&r.useCors,n.headers=r.headers||{},n.binary=!!n.isFile()&&E.includes(n.ext()),n.errorOnHTTPStatusCodes=!r.hasOwnProperty("errorOnHTTPStatusCodes")||r.errorOnHTTPStatusCodes,n}return u(t,P),s(t,[{key:"join",value:function(e){return Object.assign(o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"join",this).call(this,e),{headers:this.headers,useCors:this.useCors,useProxy:this.useProxy,proxyDomain:this.proxyDomain})}},{key:"makeProxied",value:function(e){return void 0!==e&&(this.proxyDomain=e),this.useProxy?this:new this.constructor(this.url,{headers:this.headers,useCors:this.useCors,useProxy:!0,proxyDomain:this.proxyDomain})}},{key:"noErrorOnHTTPStatusCodes",value:function(){return this.errorOnHTTPStatusCodes=!1,this}},{key:"read",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(this);case 2:if((t=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=5;break}throw new Error("Cannot read "+this.url+": "+t.statusText+" "+t.status);case 5:if(this.binary){e.next=7;break}return e.abrupt("return",t.text());case 7:if("blob"!==this.binary){e.next=9;break}return e.abrupt("return",t.blob());case 9:if("function"!=typeof t.arrayBuffer){e.next=11;break}return e.abrupt("return",t.arrayBuffer());case 11:if("function"!=typeof t.buffer){e.next=13;break}return e.abrupt("return",t.buffer());case 13:throw new Error("Don't now how to read binary resource "+this+"'");case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"write",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isFile()){e.next=2;break}throw new Error("Cannot write a non-file: "+this.url);case 2:return e.next=4,j(this,"PUT",t);case 4:if((r=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=7;break}throw new Error("Cannot write "+this.url+": "+r.statusText+" "+r.status);case 7:return e.abrupt("return",this);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"mkdir",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isFile()){e.next=2;break}throw new Error("Cannot mkdir on a file: "+this.url);case 2:return e.next=4,j(this,"MKCOL");case 4:if((t=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=7;break}throw new Error("Cannot create directory "+this.url+": "+t.statusText+" "+t.status);case 7:return e.abrupt("return",this);case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isRoot()){e.next=4;break}e.t0=!0,e.next=7;break;case 4:return e.next=6,j(this,"HEAD");case 6:e.t0=!!e.sent.ok;case 7:return e.abrupt("return",e.t0);case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(this,"DELETE");case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_propfind",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(this,"PROPFIND",null,{"Content-Type":"text/xml"});case 2:if((t=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=5;break}throw new Error("Error in dirList for "+this.url+": "+t.statusText);case 5:return e.next=7,t.text();case 7:return r=e.sent,n=this.root(),e.abrupt("return",T(r).map(function(e){return n.join(e.url).assignProperties(e)}));case 10:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"dirList",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n,i,s=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("number"==typeof a||"infinity"===a){e.next=2;break}throw new Error("dirList  invalid depth argument: "+a);case 2:if(t=o.exclude,a<=0&&(a=1),1!==a){e.next=13;break}return e.next=7,this._propfind();case 7:return n=e.sent,n.shift(),t&&(n=f(t,n)),e.abrupt("return",n);case 13:return e.delegateYield(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.dirList(1,o);case 2:return t=e.sent,r=t.filter(function(e){return e.isDirectory()}),e.abrupt("return",{v:Promise.all(r.map(function(e){return e.dirList("number"==typeof a?a-1:a,o)})).then(function(e){return e.reduce(function(e,t){return e.concat(t)},t)})});case 5:case"end":return e.stop()}},e,s)})(),"t0",14);case 14:if("object"!==(void 0===(i=e.t0)?"undefined":r(i))){e.next=17;break}return e.abrupt("return",i.v);case 17:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"readProperties",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._propfind();case 2:return r=e.sent[0],e.abrupt("return",this.assignProperties(r));case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"post",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,r,n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return"string"!=typeof i&&(i=JSON.stringify(i)),e.next=3,j(this,"POST",i,{});case 3:return t=e.sent,r=void 0,n=void 0,e.prev=6,e.next=9,t.text();case 9:r=e.sent,e.next=14;break;case 12:e.prev=12,e.t0=e.catch(6);case 14:if(r&&"application/json"===t.headers.get("content-type"))try{n=JSON.parse(r)}catch(e){}if(t.ok||!this.errorOnHTTPStatusCodes){e.next=19;break}throw new Error("Error in POST "+this.url+": "+(r||t.statusText));case 19:return e.abrupt("return",n||r);case 20:case"end":return e.stop()}},e,this,[[6,12]])}));return function(){return e.apply(this,arguments)}}()},{key:"copyTo",value:function(){var e=n(regeneratorRuntime.mark(function e(r){var n,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isFile()){e.next=7;break}if(n=r.isFile()?r:r.join(this.name()),!O){e.next=7;break}if(!n.isHTTPResource){e.next=5;break}return e.abrupt("return",this._copyTo_file_nodejs_http(n,i));case 5:if(!n.isNodeJSFileResource){e.next=7;break}return e.abrupt("return",this._copyTo_file_nodejs_fs(n,i));case 7:return e.abrupt("return",o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"copyTo",this).call(this,r,i));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_copyFrom_file_nodejs_fs",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r,n,i,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!s){e.next=3;break}return e.next=3,this.parent().ensureExistance();case 3:return r=void 0,(n=t._createReadStream()).on("error",function(e){return r=e}),e.next=8,j(this,"PUT",n);case 8:if(i=e.sent,!r){e.next=11;break}throw r;case 11:if(i.ok||!this.errorOnHTTPStatusCodes){e.next=13;break}throw new Error("copyTo: Cannot GET: "+i.statusText+" "+i.status);case 13:return e.abrupt("return",this);case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_copyTo_file_nodejs_fs",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r,n,i=this,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!s){e.next=3;break}return e.next=3,t.parent().ensureExistance();case 3:return e.next=5,j(this,"GET");case 5:if((r=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=8;break}throw new Error("copyTo: Cannot GET: "+r.statusText+" "+r.status);case 8:return n=void 0,e.abrupt("return",new Promise(function(e,s){return r.body.pipe(t._createWriteStream()).on("error",function(e){return n=e}).on("finish",function(){return n?s(n):e(i)})}));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_copyTo_file_nodejs_http",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var r,n,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!i){e.next=3;break}return e.next=3,t.parent().ensureExistance();case 3:return e.next=5,j(this,"GET");case 5:if((r=e.sent).ok||!this.errorOnHTTPStatusCodes){e.next=8;break}throw new Error("copyTo: Cannot GET: "+r.statusText+" "+r.status);case 8:return e.next=10,j(t,"PUT",r.body);case 10:if(n=e.sent,r.ok||!this.errorOnHTTPStatusCodes){e.next=13;break}throw new Error("copyTo: Cannot PUT: "+n.statusText+" "+n.status);case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"isHTTPResource",get:function(){return!0}}]),t}()};function D(e){return function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return new Promise(function(t,n){return e.apply(null,r.concat(function(e,r){return e?n(e):t(r)}))})}}var F=D(t.readFile),z=D(t.writeFile),L=function(e){return new Promise(function(r,n){return t.exists(e,function(e){return r(!!e)})})},N=D(t.readdir),H=D(t.mkdir),A=D(t.rmdir),W=D(t.unlink),B=D(t.lstat),q=D(t.rename),I={name:"nodejs-file-resource",matches:function(e){return e.startsWith("file:")},resourceClass:function(e){function r(){return i(this,r),c(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return u(r,P),s(r,[{key:"path",value:function(){return this.url.replace("file://","")}},{key:"stat",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",B(this.path()));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=F(this.path()),e.abrupt("return",this.binary?t:t.then(String));case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"write",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isDirectory()){e.next=2;break}throw new Error("Cannot write into a directory: "+this.path());case 2:return e.next=4,z(this.path(),t);case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"mkdir",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isFile()){e.next=2;break}throw new Error("Cannot mkdir on a file: "+this.path());case 2:return e.next=4,H(this.path());case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!!this.isRoot()||L(this.path()));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"dirList",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,r,n,i,s,a,o,u,c,h,l,p,v=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,y=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("number"==typeof v||"infinity"===v){e.next=2;break}throw new Error("dirList  invalid depth argument: "+v);case 2:if(t=y.exclude,v<=0&&(v=1),1!==v){e.next=42;break}return r=[],n=!0,i=!1,s=void 0,e.prev=9,e.next=12,N(this.path());case 12:e.t0=Symbol.iterator,a=e.sent[e.t0]();case 14:if(n=(o=a.next()).done){e.next=26;break}return u=o.value,c=this.join(u),e.next=19,c.stat();case 19:h=e.sent,(c=h.isDirectory()?c.asDirectory():c)._assignPropsFromStat(h),r.push(c);case 23:n=!0,e.next=14;break;case 26:e.next=32;break;case 28:e.prev=28,e.t1=e.catch(9),i=!0,s=e.t1;case 32:e.prev=32,e.prev=33,!n&&a.return&&a.return();case 35:if(e.prev=35,!i){e.next=38;break}throw s;case 38:return e.finish(35);case 39:return e.finish(32);case 40:return t&&(r=f(t,r)),e.abrupt("return",r);case 42:return e.next=44,this.dirList(1,y);case 44:return l=e.sent,p=l.filter(function(e){return e.isDirectory()}),e.abrupt("return",Promise.all(p.map(function(e){return e.dirList("number"==typeof v?v-1:v,y)})).then(function(e){return e.reduce(function(e,t){return e.concat(t)},l)}));case 47:case"end":return e.stop()}},e,this,[[9,28,32,40],[33,,35,39]])}));return function(){return e.apply(this,arguments)}}()},{key:"isEmptyDirectory",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dirList();case 2:return e.t0=e.sent.length,e.abrupt("return",0===e.t0);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"rename",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var n,i,s,a,u,c,h,f,l,p,v,y,m,d,x,k,w,b,g,R;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t instanceof this.constructor){e.next=2;break}return e.abrupt("return",o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"rename",this).call(this,t));case 2:if(!this.isFile()){e.next=7;break}t=t.asFile(),q(this.path(),t.path()),e.next=93;break;case 7:return t=t.asDirectory(),e.next=10,t.ensureExistance();case 10:return n=[],i=[],s=!0,a=!1,u=void 0,e.prev=14,e.next=17,this.dirList("infinity");case 17:e.t0=Symbol.iterator,c=e.sent[e.t0]();case 19:if(s=(h=c.next()).done){e.next=25;break}(f=h.value).isDirectory()?i.push(f):n.push(f);case 22:s=!0,e.next=19;break;case 25:e.next=31;break;case 27:e.prev=27,e.t1=e.catch(14),a=!0,u=e.t1;case 31:e.prev=31,e.prev=32,!s&&c.return&&c.return();case 34:if(e.prev=34,!a){e.next=37;break}throw u;case 37:return e.finish(34);case 38:return e.finish(31);case 39:l=!0,p=!1,v=void 0,e.prev=42,y=i[Symbol.iterator]();case 44:if(l=(m=y.next()).done){e.next=51;break}return d=m.value,e.next=48,t.join(d.relativePathFrom(this)).ensureExistance();case 48:l=!0,e.next=44;break;case 51:e.next=57;break;case 53:e.prev=53,e.t2=e.catch(42),p=!0,v=e.t2;case 57:e.prev=57,e.prev=58,!l&&y.return&&y.return();case 60:if(e.prev=60,!p){e.next=63;break}throw v;case 63:return e.finish(60);case 64:return e.finish(57);case 65:x=!0,k=!1,w=void 0,e.prev=68,b=n[Symbol.iterator]();case 70:if(x=(g=b.next()).done){e.next=77;break}return R=g.value,e.next=74,R.rename(t.join(R.relativePathFrom(this)));case 74:x=!0,e.next=70;break;case 77:e.next=83;break;case 79:e.prev=79,e.t3=e.catch(68),k=!0,w=e.t3;case 83:e.prev=83,e.prev=84,!x&&b.return&&b.return();case 86:if(e.prev=86,!k){e.next=89;break}throw w;case 89:return e.finish(86);case 90:return e.finish(83);case 91:return e.next=93,this.remove();case 93:return e.abrupt("return",t);case 94:case"end":return e.stop()}},e,this,[[14,27,31,39],[32,,34,38],[42,53,57,65],[58,,60,64],[68,79,83,91],[84,,86,90]])}));return function(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,r,n,i,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.exists();case 2:if(e.sent){e.next=5;break}e.next=41;break;case 5:if(!this.isDirectory()){e.next=39;break}return t=!0,r=!1,n=void 0,e.prev=9,e.next=12,this.dirList();case 12:e.t0=Symbol.iterator,i=e.sent[e.t0]();case 14:if(t=(s=i.next()).done){e.next=21;break}return a=s.value,e.next=18,a.remove();case 18:t=!0,e.next=14;break;case 21:e.next=27;break;case 23:e.prev=23,e.t1=e.catch(9),r=!0,n=e.t1;case 27:e.prev=27,e.prev=28,!t&&i.return&&i.return();case 30:if(e.prev=30,!r){e.next=33;break}throw n;case 33:return e.finish(30);case 34:return e.finish(27);case 35:return e.next=37,A(this.path());case 37:e.next=41;break;case 39:return e.next=41,W(this.path());case 41:return e.abrupt("return",this);case 42:case"end":return e.stop()}},e,this,[[9,23,27,35],[28,,30,34]])}));return function(){return e.apply(this,arguments)}}()},{key:"readProperties",value:function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this.stat();case 3:return e.t1=e.sent,e.abrupt("return",e.t0._assignPropsFromStat.call(e.t0,e.t1));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"copyTo",value:function(){var e=n(regeneratorRuntime.mark(function e(t){var n,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isFile()){e.next=4;break}if(!(n=t.isFile()?t:t.join(this.name())).isHTTPResource){e.next=4;break}return e.abrupt("return",n._copyFrom_file_nodejs_fs(this,i=!0));case 4:return e.abrupt("return",o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"copyTo",this).call(this,t,i));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_assignPropsFromStat",value:function(e){return this.assignProperties({lastModified:e.mtime,created:e.ctime,size:e.size,type:e.isDirectory()?"directory":"file",isLink:e.isSymbolicLink()})}},{key:"_createWriteStream",value:function(){return t.createWriteStream(this.path())}},{key:"_createReadStream",value:function(){return t.createReadStream(this.path())}},{key:"isNodeJSFileResource",get:function(){return!0}}]),r}()},J=/\//g;function M(e,t){return!t||("string"==typeof t?!e.url.includes(t):"function"==typeof t?!t(e):!(t instanceof RegExp)||!t.test(e.url))}var U=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i(this,e),!t||"string"!=typeof t)throw new Error("LocalResourceInMemoryBackend needs name!");this.name=t,this._filespec=r}return s(e,null,[{key:"removeHost",value:function(e){delete this.hosts[e]}},{key:"ensure",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.named(r.host);return Promise.resolve().then(function(){return e?K("local://"+n.name,e):null}).then(function(){return t})}},{key:"named",value:function(e){return e||(e="default"),this.hosts[e]||(this.hosts[e]=new this(e))}},{key:"hosts",get:function(){return this._hosts||(this._hosts={})}}]),s(e,[{key:"get",value:function(e){return this._filespec[e]}},{key:"set",value:function(e,t){this._filespec[e]=t}},{key:"write",value:function(e,t){var r=this._filespec[e];r||(r=this._filespec[e]={created:new Date}),r.content=t,r.isDirectory=!1,r.lastModified=new Date}},{key:"read",value:function(e){var t=this._filespec[e];return t&&t.content?t.content:""}},{key:"mkdir",value:function(e){var t=this._filespec[e];t&&t.isDirectory||(t||(t=this._filespec[e]={created:new Date}),t.content&&delete t.content,t.isDirectory=!0,t.lastModified=new Date)}},{key:"partialFilespec",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r={},n=this.filespec,i=Object.keys(n),s=0;s<i.length;s++){var a=i[s];if(a.startsWith(e)&&e!==a){var o=a.slice(e.length);(o.includes("/")?o.match(J).length+1:1)>t||(r[a]=n[a])}}return r}},{key:"filespec",get:function(){return this._filespec},set:function(e){this._filespec=e}}]),e}(),G=function(e){function t(){return i(this,t),c(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return u(t,P),s(t,[{key:"read",value:function(){return Promise.resolve(this.localBackend.read(this.path()))}},{key:"write",value:function(e){if(this.isDirectory())throw new Error("Cannot write into a directory! ("+this.url+")");var t=this.localBackend.get(this.path());if(t&&t.isDirectory)throw new Error(this.url+" already exists and is a directory (cannot write into it!)");return this.localBackend.write(this.path(),e),Promise.resolve(this)}},{key:"mkdir",value:function(){if(!this.isDirectory())throw new Error("Cannot mkdir a file! ("+this.url+")");var e=this.localBackend.get(this.path());if(e&&e.isDirectory)return Promise.resolve(this);if(e&&!e.isDirectory)throw new Error(this.url+" already exists and is a file (cannot mkdir it!)");return this.localBackend.mkdir(this.path()),Promise.resolve(this)}},{key:"exists",value:function(){return Promise.resolve(this.isRoot()||this.path()in this.localBackend.filespec)}},{key:"remove",value:function(){var e=this,t=this.path();return Object.keys(this.localBackend.filespec).forEach(function(r){return r.startsWith(t)&&delete e.localBackend.filespec[r]}),Promise.resolve(this)}},{key:"readProperties",value:function(){throw new Error("not yet implemented")}},{key:"dirList",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isDirectory())return this.asDirectory().dirList(t,r);var n=r.exclude,i=this.path(),s=[],a=Object.keys(this.localBackend.filespec);"infinity"===t&&(t=1/0);for(var o=0;o<a.length;o++){var u=a[o];if(u.startsWith(i)&&i!==u){var c=u.slice(i.length);if((c.includes("/")?c.match(J).length+1:1)>t)if("continue"===function(){var r=e.join(c.split("/").slice(0,t).join("/")+"/");return s.some(function(e){return e.equals(r)})||s.push(r),"continue"}())continue;var h=this.join(c);n&&!M(h,n)||s.push(h)}}return Promise.resolve(s)}},{key:"localBackend",get:function(){return U.named(this.host())}}]),t}(),Y=Y||[];function $(e,t){if(!e)throw new Error("lively.resource resource constructor: expects url but got "+e);if(e.isResource)return e;e=String(e);for(var r=0;r<Y.length;r++)if(Y[r].matches(e))return new Y[r].resourceClass(e,t);throw new Error("Cannot find resource type for url "+e)}te({name:"local-resource",matches:function(e){return e.startsWith("local:")},resourceClass:G}),te(C),te(I);var Q,X,K=(Q=n(regeneratorRuntime.mark(function e(t,n,i){var s,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=$(t,i).asDirectory(),e.next=3,s.ensureExistance();case 3:e.t0=regeneratorRuntime.keys(n);case 4:if((e.t1=e.t0()).done){e.next=18;break}if(a=e.t1.value,n.hasOwnProperty(a)){e.next=8;break}return e.abrupt("continue",4);case 8:if(o=s.join(a),"object"!==r(n[a])){e.next=14;break}return e.next=12,K(o,n[a],i);case 12:e.next=16;break;case 14:return e.next=16,o.write(n[a]);case 16:e.next=4;break;case 18:return e.abrupt("return",s);case 19:case"end":return e.stop()}},e,this)})),function(e,t,r){return Q.apply(this,arguments)}),V=(X=n(regeneratorRuntime.mark(function e(t){var r,n,i,s,a,o,u,c,h,f,l,p,v,y,m,d,x,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"infinity",w=arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.dirList(k,w);case 2:r=e.sent,n={},i=!0,s=!1,a=void 0,e.prev=7,o=r[Symbol.iterator]();case 9:if(i=(u=o.next()).done){e.next=44;break}if(!(c=u.value).isDirectory()){e.next=15;break}e.t0={},e.next=18;break;case 15:return e.next=17,c.read();case 17:e.t0=e.sent;case 18:for(h=e.t0,f=c.asFile().relativePathFrom(t).split("/"),l=n,p=!0,v=!1,y=void 0,e.prev=24,m=f.slice(0,-1)[Symbol.iterator]();!(p=(d=m.next()).done);p=!0)x=d.value,l[x]||(l[x]={}),l=l[x];e.next=32;break;case 28:e.prev=28,e.t1=e.catch(24),v=!0,y=e.t1;case 32:e.prev=32,e.prev=33,!p&&m.return&&m.return();case 35:if(e.prev=35,!v){e.next=38;break}throw y;case 38:return e.finish(35);case 39:return e.finish(32);case 40:l[f[f.length-1]]=h;case 41:i=!0,e.next=9;break;case 44:e.next=50;break;case 46:e.prev=46,e.t2=e.catch(7),s=!0,a=e.t2;case 50:e.prev=50,e.prev=51,!i&&o.return&&o.return();case 53:if(e.prev=53,!s){e.next=56;break}throw a;case 56:return e.finish(53);case 57:return e.finish(50);case 58:return e.abrupt("return",n);case 59:case"end":return e.stop()}},e,this,[[7,46,50,58],[24,28,32,40],[33,,35,39],[51,,53,57]])})),function(e){return X.apply(this,arguments)});var Z,ee=(Z=n(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!("fetch"in System.global&&"Headers"in System.global)){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:if(t=System.decanonicalize("lively.resources"),!System.get("@system-env").node){e.next=16;break}e.prev=4,r=System._nodeRequire("fetch-ponyfill"),e.next=14;break;case 8:return e.prev=8,e.t0=e.catch(4),e.next=12,System.normalize("fetch-ponyfill",t);case 12:n=e.sent.replace("file://",""),r=System._nodeRequire(n);case 14:e.next=19;break;case 16:return e.next=18,System.import("fetch-ponyfill",t);case 18:r=e.sent;case 19:Object.assign(System.global,r());case 20:case"end":return e.stop()}},e,this,[[4,8]])})),function(){return Z.apply(this,arguments)});function te(e){var t=e.name;Y=Y.filter(function(e){return e.name!==t}).concat(e)}e.resource=$,e.createFiles=K,e.createFileSpec=V,e.loadViaScript=function(e,t){var r=document.head,n=r.namespaceURI;return new Promise(function(t,i){var s=document.createElementNS(n,"script");s.setAttribute("type","text/ecmascript"),r.appendChild(s),s.setAttributeNS(null,"id",e),"http://www.w3.org/2000/svg"===s.namespaceURI?s.setAttributeNS("http://www.w3.org/1999/xlink","href",e):s.setAttribute("src",e),s.onload=t,s.onerror=i,s.setAttributeNS(null,"async",!0)})},e.ensureFetch=ee,e.registerExtension=te,e.unregisterExtension=function(e){var t="string"==typeof e?e:e.name;Y=Y.filter(function(e){return e.name!==t})},e.Resource=P,e.parseQuery=l}(this.lively.resources=this.lively.resources||{},"undefined"!=typeof module&&"function"==typeof module.require?module.require("fs"):{readFile:function(){throw new Error("fs module not available")}}),"undefined"!=typeof module&&module.exports&&(module.exports=e.lively.resources)}();
//LIVELY.STORAGE - 120k
const PouchDB = {plugin: function() {}};
const pouchdbAdapterMem = {};
!function(){var GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;void 0===GLOBAL.lively&&(GLOBAL.lively={}),"undefined"==typeof btoa&&(GLOBAL.btoa=function(e){return new Buffer(e).toString("base64")}),"undefined"==typeof atob&&(GLOBAL.atob=function(e){return new Buffer(e,"base64").toString()}),function(){this.lively=this.lively||{},function(exports,_PouchDB,pouchdbAdapterMem,lively_lang,lively_resources){"use strict";_PouchDB="default"in _PouchDB?_PouchDB.default:_PouchDB,pouchdbAdapterMem="default"in pouchdbAdapterMem?pouchdbAdapterMem.default:pouchdbAdapterMem;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jsx=(REACT_ELEMENT_TYPE="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103,function(e,t,r,n){var o=e&&e.defaultProps,i=arguments.length-3;if(t||0===i||(t={}),t&&o)for(var a in o)void 0===t[a]&&(t[a]=o[a]);else t||(t=o||{});if(1===i)t.children=n;else if(i>1){for(var s=Array(i),c=0;c<i;c++)s[c]=arguments[c+3];t.children=s}return{$$typeof:REACT_ELEMENT_TYPE,type:e,key:void 0===r?null:""+r,ref:null,props:t,_owner:null}}),REACT_ELEMENT_TYPE,asyncIterator=function(e){if("function"==typeof Symbol){if(Symbol.asyncIterator){var t=e[Symbol.asyncIterator];if(null!=t)return t.call(e)}if(Symbol.iterator)return e[Symbol.iterator]()}throw new TypeError("Object is not async iterable")},asyncGenerator=function(){function e(e){this.value=e}function t(t){var r,n;function o(r,n){try{var a=t[r](n),s=a.value;s instanceof e?Promise.resolve(s.value).then(function(e){o("next",e)},function(e){o("throw",e)}):i(a.done?"return":"normal",a.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?o(r.key,r.arg):n=null}this._invoke=function(e,t){return new Promise(function(i,a){var s={key:e,arg:t,resolve:i,reject:a,next:null};n?n=n.next=s:(r=n=s,o(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),asyncGeneratorDelegate=function(e,t){var r={},n=!1;function o(r,o){return n=!0,o=new Promise(function(t){t(e[r](o))}),{done:!1,value:t(o)}}return"function"==typeof Symbol&&Symbol.iterator&&(r[Symbol.iterator]=function(){return this}),r.next=function(e){return n?(n=!1,e):o("next",e)},"function"==typeof e.throw&&(r.throw=function(e){if(n)throw n=!1,e;return o("throw",e)}),"function"==typeof e.return&&(r.return=function(e){return o("return",e)}),r},asyncToGenerator=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,i){try{var a=t[o](i),s=a.value}catch(e){return void r(e)}if(!a.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),defineEnumerableProperties=function(e,t){for(var r in t){var n=t[r];n.configurable=n.enumerable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,r,n)}return e},defaults=function(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],i=Object.getOwnPropertyDescriptor(t,o);i&&i.configurable&&void 0===e[o]&&Object.defineProperty(e,o,i)}return e},defineProperty=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},get$1=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(n):void 0},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},_instanceof=function(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?t[Symbol.hasInstance](e):e instanceof t},interopRequireDefault=function(e){return e&&e.__esModule?e:{default:e}},interopRequireWildcard=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},newArrowCheck=function(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")},objectDestructuringEmpty=function(e){if(null==e)throw new TypeError("Cannot destructure undefined")},objectWithoutProperties=function(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},selfGlobal="undefined"==typeof global?self:global,set$1=function e(t,r,n,o){var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);null!==a&&e(a,r,n,o)}else if("value"in i&&i.writable)i.value=n;else{var s=i.set;void 0!==s&&s.call(o,n)}return n},slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),slicedToArrayLoose=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){for(var r,n=[],o=e[Symbol.iterator]();!(r=o.next()).done&&(n.push(r.value),!t||n.length!==t););return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")},taggedTemplateLiteral=function(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))},taggedTemplateLiteralLoose=function(e,t){return e.raw=t,e},temporalRef=function(e,t,r){if(e===r)throw new ReferenceError(t+" is not defined - temporal dead zone");return e},temporalUndefined={},toArray=function(e){return Array.isArray(e)?e:Array.from(e)},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},babelHelpers$1=Object.freeze({jsx:jsx,asyncIterator:asyncIterator,asyncGenerator:asyncGenerator,asyncGeneratorDelegate:asyncGeneratorDelegate,asyncToGenerator:asyncToGenerator,classCallCheck:classCallCheck,createClass:createClass,defineEnumerableProperties:defineEnumerableProperties,defaults:defaults,defineProperty:defineProperty,get:get$1,inherits:inherits,interopRequireDefault:interopRequireDefault,interopRequireWildcard:interopRequireWildcard,newArrowCheck:newArrowCheck,objectDestructuringEmpty:objectDestructuringEmpty,objectWithoutProperties:objectWithoutProperties,possibleConstructorReturn:possibleConstructorReturn,selfGlobal:selfGlobal,set:set$1,slicedToArray:slicedToArray,slicedToArrayLoose:slicedToArrayLoose,taggedTemplateLiteral:taggedTemplateLiteral,taggedTemplateLiteralLoose:taggedTemplateLiteralLoose,temporalRef:temporalRef,temporalUndefined:temporalUndefined,toArray:toArray,toConsumableArray:toConsumableArray,typeof:_typeof,extends:_extends,instanceof:_instanceof}),GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:void 0,isNode="undefined"!=typeof global&&"undefined"!=typeof process,PouchDB=_PouchDB;function nodejsRequire(e){if(!isNode)throw new Error("nodejsRequire can only be used in nodejs!");return"undefined"!=typeof System?System._nodeRequire(e):require("module")._load(e)}function nodejs_leveldbPath(e){if(e.startsWith("/"))return e;if(e.match(/[^\/]+:\/\//))return e.startsWith("file:")&&(e=e.replace(/^file:\/\//,"")),e;if(!isNode)throw new Error("nodejs_leveldbPath called under non-nodejs environment");var t="undefined"!=typeof System&&System.baseURL.startsWith("file://")?System.baseURL.replace("file://",""):GLOBAL.process.cwd(),r=nodejsRequire("path").join,n=nodejsRequire("fs"),o=n.mkdirSync,i=n.existsSync,a=(n.readdirSync,n.readFileSync);if(e.includes("/"))return r(t,e);try{var s=a(r(t,"../package.json")),c=JSON.parse(s);if("lively.web"===c.name||"lively.next"===c.name){var u=r(t,"../.livelydbs");return i(u)||o(u),r(u,e)}}catch(e){}var p=r(t,".livelydbs");return i(p)||o(p),r(p,e)}function nodejs_attemptToLoadProperPouchDB(){if(!isNode)throw new Error("nodejs_attemptToLoadProperPouchDB called under non-nodejs environment");if("undefined"!=typeof System){var e=System._nodeRequire("path").join,t=System.normalizeSync("lively.storage/index.js"),r=e(System.normalizeSync("pouchdb",t).replace(/file:\/\//,""),"../../lib/index.js");try{return(PouchDB=System._nodeRequire(r)).plugin(pouchdbAdapterMem),!0}catch(e){return!1}}try{return(PouchDB=require("pouchdb")).plugin(pouchdbAdapterMem),!0}catch(e){return!1}}PouchDB.plugin(pouchdbAdapterMem);var createPouchDB=isNode?(properLoadAttempted=!1,nodejsCouchDBLoaded=!1,function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return properLoadAttempted||(properLoadAttempted=!0,nodejsCouchDBLoaded=nodejs_attemptToLoadProperPouchDB()),t.adapter||(t.adapter=e.startsWith("http")?"http":nodejsCouchDBLoaded?"leveldb":"memory"),"leveldb"==t.adapter&&(e=nodejs_leveldbPath(e)),t=_extends({},t,{name:e}),new PouchDB(t)}):function(e,t){return new PouchDB(_extends({name:e},t))},properLoadAttempted,nodejsCouchDBLoaded,Database=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};classCallCheck(this,e),this.name=t,this.options=r,this._pouchdb=null}return createClass(e,null,[{key:"findDB",value:function(e){return this.databases.get(e)}},{key:"ensureDB",value:function(e,t){var r=this.findDB(e);return r||(r=new this(e,t),this.databases.set(e,r),e.endsWith("lively.storage-meta")||this.createMetaEntryForDB(e,t),r)}},{key:"knownDBs",value:function(t,r){return e.ensureDB("lively.storage-meta").getAll().then(function(e){return e.map(function(e){return e._id})})}},{key:"createMetaEntryForDB",value:function(t,r){var n=e.ensureDB("lively.storage-meta");n.has(t).then(function(e){return!e&&n.set(t,{created:Date.now(),options:r})})}},{key:"knowsDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.ensureDB(t),e.next=3,r.docCount();case 3:if(!(e.sent>0)){e.next=6;break}return e.abrupt("return",!0);case 6:return e.next=8,r.destroy();case 8:return e.abrupt("return",!1);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"PouchDB",get:function(){return PouchDB},set:function(e){PouchDB=e}},{key:"databases",get:function(){return this._databases||(this._databases=new Map)}}]),createClass(e,[{key:"close",value:function(){this._pouchdb&&(this._pouchdb.close(),delete this._pouchdb)}},{key:"isDestroyed",value:function(){return!!this.pouchdb._destroyed}},{key:"destroy",value:function(e){return this.constructor.databases.delete(this.name),this.isDestroyed()?{ok:!0}:this.pouchdb.destroy(e)}},{key:"update",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o,i,a,s,c,u,p,f,l,d,h,m,v,y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=(o=n=n||{}).ensure,a=void 0===i||i,s=o.retryOnConflict,c=void 0===s||s,u=o.maxUpdateAttempts,p=void 0===u?10:u,f={latest:!0},l=this.pouchdb,d=void 0,h=void 0,e.prev=2,e.next=5,l.get(t,f);case 5:d=e.sent,e.next=12;break;case 8:if(e.prev=8,e.t0=e.catch(2),"not_found"===e.t0.name&&a){e.next=12;break}throw e.t0;case 12:return e.next=14,r(d);case 14:if((h=e.sent)&&"object"===(void 0===h?"undefined":_typeof(h))){e.next=17;break}return e.abrupt("return",null);case 17:return h._id!==t&&(h._id=t),d&&h._rev!==d._rev&&(h._rev=d._rev),e.prev=19,e.next=22,l.put(h);case 22:return m=e.sent,m.id,v=m.rev,e.abrupt("return",Object.assign(h,{_rev:v}));case 28:if(e.prev=28,e.t1=e.catch(19),!("conflict"===e.t1.name&&c&&y<p)){e.next=32;break}return e.abrupt("return",this.update(t,r,n,y+1));case 32:throw e.t1;case 33:case"end":return e.stop()}},e,this,[[2,8],[19,28]])}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"mixin",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.update(t,function(e){return Object.assign(e||{_id:t},r)},n));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.update(t,function(e){return r},n));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.pouchdb.get(t,r);case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),"not_found"!==e.t0.name){e.next=10;break}return e.abrupt("return",void 0);case 10:throw e.t0;case 11:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()},{key:"has",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return e.abrupt("return",!!e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"add",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.pouchdb.post(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"docList",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,i,a,s,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.allDocs(c);case 2:for(t=e.sent,r=t.rows,n=[],o=0;o<r.length;o++)i=r[o],a=i.id,s=i.value.rev,n.push({id:a,rev:s});return e.abrupt("return",n);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"docCount",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.allDocs();case 2:return t=e.sent,e.abrupt("return",t.rows.length);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"revList",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.get(t,{revs:!0});case 2:return r=e.sent,r._id,n=r._revisions,o=n.start,i=n.ids,e.abrupt("return",i.map(function(e){return o--+"-"+e}));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAllRevisions",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.skip,n=void 0===r?0:r,o=c.limit,i=void 0===o?0:o,e.next=6,this.revList(t);case 6:return a=e.sent,n>0&&(a=a.slice(n)),i>0&&(a=a.slice(0,i)),s=a.map(function(e){return{rev:e,id:t}}),e.next=12,this.getDocuments(s);case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAll",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.allDocs(_extends({},n,{include_docs:!0}));case 2:return t=e.sent,r=t.rows,e.abrupt("return",r.map(function(e){return e.doc}));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setDocuments",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.bulkDocs(t,r);case 2:n=e.sent,o=0;case 4:if(!(o<n.length)){e.next=16;break}if(i=t[o],(a=n[o]).ok||"conflict"!==a.name||i._rev){e.next=13;break}return e.next=9,this.set(i._id,i);case 9:s=e.sent,c=s._id,u=s._rev,n[o]={ok:!0,id:c,rev:u};case 13:o++,e.next=4;break;case 16:return e.abrupt("return",n);case 17:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateDocuments",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o,i,a,s,c,u,p,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.bulkDocs(t,n);case 2:o=e.sent,i=[],a={},s=0;case 6:if(!(s<o.length)){e.next=18;break}if(c=t[s],u=o[s],a[u._id||c._id]=u,u.ok||"conflict"!==u.name){e.next=15;break}return e.next=12,this.get(c._id);case 12:p=e.sent,(f=r(p,c))&&(f._id||(f._id=c._id),f._rev||(f._rev=p._rev),i.push(f));case 15:s++,e.next=6;break;case 18:if(!i.length){e.next=26;break}return e.t0=babelHelpers$1,e.t1={},e.t2=a,e.next=24,this.updateDocuments(i,r,n);case 24:e.t3=e.sent,a=e.t0.extends.call(e.t0,e.t1,e.t2,e.t3);case 26:return e.abrupt("return",a);case 27:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getDocuments",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.ignoreErrors,n=void 0===r||r,e.next=4,this.pouchdb.bulkGet({docs:t});case 4:o=e.sent,i=o.results,a=[],s=0;case 8:if(!(s<i.length)){e.next=23;break}c=i[s],u=c.docs,p=c.id,console.assert(1===u.length,"getDocuments: expected only one doc for "+p),f=0;case 12:if(!(f<u.length)){e.next=20;break}if(l=u[f],!n||l.ok){e.next=16;break}return e.abrupt("continue",17);case 16:a.push(l.ok||l.error||l);case 17:f++,e.next=12;break;case 20:s++,e.next=8;break;case 23:return e.abrupt("return",a);case 24:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"query",value:function(e,t){return this.pouchdb.query(e,t)}},{key:"remove",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r){e.next=4;break}e.t0={_id:t,_rev:r},e.next=7;break;case 4:return e.next=6,this.get(t);case 6:e.t0=e.sent;case 7:return o=e.t0,e.abrupt("return",o?this.pouchdb.remove(o):void 0);case 9:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"removeAll",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.pouchdb,e.next=3,t.allDocs();case 3:return r=e.sent,e.next=6,Promise.all(r.rows.map(function(e){return t.remove(e.id,e.value.rev)}));case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"replicateTo",value:function(t,r){return t instanceof e&&(t=t.pouchdb),this.pouchdb.replicate.to(t,r)}},{key:"replicateFrom",value:function(t,r){return t instanceof e&&(t=t.pouchdb),this.pouchdb.replicate.from(t,r)}},{key:"sync",value:function(t,r){return t instanceof e&&(t=t.pouchdb),this.pouchdb.sync(t,r)}},{key:"getConflicts",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.query("conflict_index/conflict_index",_extends({reduce:!1,include_docs:!0,conflicts:!0},t));case 2:return r=e.sent,n=r.rows,e.abrupt("return",n.map(function(e){var t={id:e.id,rev:e.doc._rev,doc:e.doc};return e.doc._conflicts&&(t.conflicts=e.doc._conflicts,delete e.doc._conflicts),t}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"resolveConflicts",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u,p,f,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.pouchdb.get(t,{conflicts:!0});case 2:return n=e.sent,o=n._conflicts.map(function(e){return{id:t,rev:e}}),e.next=6,this.getDocuments(o);case 6:i=e.sent,a=n,s=!0,c=!1,u=void 0,e.prev=11,p=i[Symbol.iterator]();case 13:if(s=(f=p.next()).done){e.next=28;break}return l=f.value,e.next=17,r(a,l);case 17:if(a=e.sent){e.next=20;break}return e.abrupt("return",null);case 20:return e.next=22,this.set(t,a);case 22:return a=e.sent,e.next=25,this.pouchdb.remove(l);case 25:s=!0,e.next=13;break;case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(11),c=!0,u=e.t0;case 34:e.prev=34,e.prev=35,!s&&p.return&&p.return();case 37:if(e.prev=37,!c){e.next=40;break}throw u;case 40:return e.finish(37);case 41:return e.finish(34);case 42:return e.abrupt("return",a);case 43:case"end":return e.stop()}},e,this,[[11,30,34,42],[35,,37,41]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"diffWith",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.docList();case 2:return r=e.sent,e.next=5,this.docList();case 5:for(u in n=e.sent,o=r.reduce(function(e,t){return Object.assign(e,defineProperty({},t.id,t.rev))},{}),i=n.reduce(function(e,t){return Object.assign(e,defineProperty({},t.id,t.rev))},{}),a=[],s=[],c=[],o)p=o[u],(f=i[u])?p!=f&&c.push({right:{id:u,rev:p},left:{id:u,rev:f}}):s.push({id:u,rev:p});for(l in i)d=i[l],o[l]||a.push({id:l,rev:d});return e.abrupt("return",{inLeft:a,inRight:s,changed:c});case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"dump",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,i,a,s,c,u,p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=p.filterFn,r=p.name,n=p.type,o=p.dbInfo,i=this.name,a=this.pouchdb,s=r||i,e.t0=s,e.t1=n||a.type(),e.t2=(new Date).toJSON(),e.t3=babelHelpers$1,e.t4={},e.next=14,a.info();case 14:return e.t5=e.sent,e.t6={db_name:s},e.t7=o,e.t8=e.t3.extends.call(e.t3,e.t4,e.t5,e.t6,e.t7),c={name:e.t0,db_type:e.t1,start_time:e.t2,db_info:e.t8},e.next=21,this.getAll({attachments:!0});case 21:return u=e.sent,"function"==typeof t&&(u=t(u,c)),e.abrupt("return",{header:c,docs:u});case 24:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"backup",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.name+"_backup_"+n,r=this.constructor.ensureDB(t),e.next=3,this.replicateTo(r);case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"migrate",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getAll();case 2:r=e.sent,n=[],o=[],i=0;case 5:if(!(i<r.length)){e.next=16;break}if(a=r[i],s=t(a,i)){e.next=10;break}return o.push(a),e.abrupt("continue",13);case 10:s.hasOwnProperty("_id")||(s._id=a._id),s.hasOwnProperty("_rev")&&delete s._rev,n.push(s);case 13:i++,e.next=5;break;case 16:return e.next=18,this.setDocuments(n);case 18:return e.abrupt("return",{migrated:n.length,unchanged:o.length});case 19:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createDesignDocs",value:function(e){return e.map(this.createDesignDoc)}},{key:"createDesignDoc",value:function(e){var t=e.name,r=e.mapFn,n=e.reduceFn,o=e.filterFn,i=e.version,a={_id:"_design/"+t,version:void 0===i?1:i};return o&&lively_lang.Path("filters."+t).set(a,o.toString(),!0),r&&lively_lang.Path("views."+t+".map").set(a,r.toString(),!0),n&&lively_lang.Path("views."+t+".reduce").set(a,n.toString(),!0),a}},{key:"addDesignDocs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.createDesignDocs(t),e.next=3,this.updateDocuments(r,function(e,t){return e.hasOwnProperty("version")?t.hasOwnProperty("version")&&t.version>e.version?t:null:t});case 3:if(n=e.sent,!i){e.next=7;break}return e.next=7,Promise.all(r.map(function(e){return o.designDocDoQueryStale(e._id)}));case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"addDesignDoc",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o=t.name,i=t.mapFn,a=t.reduceFn,s=t.version,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.createDesignDoc({name:o,mapFn:i,reduceFn:a,version:s}),e.next=3,this.set(r._id,r);case 3:if(n=e.sent,!c){e.next=7;break}return e.next=7,this.designDocDoQueryStale(r._id);case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"removeDesignDoc",value:function(e){return this.remove("_design/"+e)}},{key:"designDocDoQueryStale",value:function(e){var t=e.split("/"),r=slicedToArray(t,2),n=(r[0],r[1]);return this.query(n,{stale:"update_after"})}},{key:"pouchdb",get:function(){if(this._pouchdb)return this._pouchdb;var e=this.name,t=this.options;return this._pouchdb=createPouchDB(e,t)}}],[{key:"loadDump",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.header,n=t.docs,o=a.name||r.name,i=this.ensureDB(o),e.next=3,i.setDocuments(n,{new_edits:!1});case 3:return e.abrupt("return",i);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),sha1=function(){var e,t,r;return"object"==("undefined"==typeof process?"undefined":_typeof(process))&&"object"==_typeof(process.versions)&&process.versions.node&&"renderer"!==process.__atom_type?(r="undefined"!=typeof System?System._nodeRequire("crypto"):require("crypto"),t=function(){var e=r.createHash("sha1");return{update:function(t){return e.update(t)},digest:function(){return e.digest("hex")}}}):(e=new Uint32Array(80),t=function(t){function r(e){i[f]|=(255&e)<<l,l?l-=8:(f++,l=24),16===f&&n()}function n(){for(var e=16;e<80;e++){var t=i[e-3]^i[e-8]^i[e-14]^i[e-16];i[e]=t<<1|t>>>31}var r,n,o=a,l=s,d=c,h=u,m=p;for(e=0;e<80;e++){e<20?(r=h^l&(d^h),n=1518500249):e<40?(r=l^d^h,n=1859775393):e<60?(r=l&d|h&(l|d),n=2400959708):(r=l^d^h,n=3395469782);var v=(o<<5|o>>>27)+r+m+n+(0|i[e]);m=h,h=d,d=l<<30|l>>>2,l=o,o=v}for(a=a+o|0,s=s+l|0,c=c+d|0,u=u+h|0,p=p+m|0,f=0,e=0;e<16;e++)i[e]=0}function o(e){for(var t="",r=28;r>=0;r-=4)t+=(e>>r&15).toString(16);return t}var i,a=1732584193,s=4023233417,c=2562383102,u=271733878,p=3285377520,f=0,l=24,d=0;return i=t?e:new Uint32Array(80),{update:function(e){if("string"==typeof e)return function(e){var t=e.length;d+=8*t;for(var n=0;n<t;n++)r(e.charCodeAt(n))}(e);var t=e.length;d+=8*t;for(var n=0;n<t;n++)r(e[n])},digest:function(){r(128),(f>14||14===f&&l<24)&&n(),f=14,l=24,r(0),r(0),r(d>0xffffffffff?d/1099511627776:0),r(d>4294967295?d/4294967296:0);for(var e=24;e>=0;e-=8)r(d>>e);return o(a)+o(s)+o(c)+o(u)+o(p)}}}),function(e){if(void 0===e)return t(!1);var r=t(!0);return r.update(e),r.digest()}}(),hashRe=/^[0-9a-f]+$/i;function isHash(e){return"string"==typeof e&&40===e.length&&e.match(hashRe)}var objectDBs=objectDBs||new Map,ObjectDB=function(){function e(t,r){if(classCallCheck(this,e),this.name=t,!r.snapshotLocation||!r.snapshotLocation.isResource)throw new Error("ObjectDB needs snapshotLocation!");this.snapshotLocation=r.snapshotLocation,this.__commitDB=null,this.__versionDB=null}return createClass(e,null,[{key:"dbList",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=Database.ensureDB("internal__objectdb-meta"),e.next=3,t.getAll();case 3:return e.t0=function(e){return e._id},e.abrupt("return",e.sent.map(e.t0));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"find",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=objectDBs.get(t))){e.next=3;break}return e.abrupt("return",r);case 3:return n=Database.ensureDB("internal__objectdb-meta"),e.next=6,n.get(t);case 6:if(o=e.sent){e.next=9;break}return e.abrupt("return");case 9:return e.abrupt("return",this.named(t,o));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"named",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=objectDBs.get(e);if(r)return r;if(!t||!t.snapshotLocation)throw new Error("need snapshotLocation");if("string"==typeof t.snapshotLocation)try{t.snapshotLocation=lively_resources.resource(t.snapshotLocation)}catch(e){t.snapshotLocation=lively_resources.resource(System.baseURL).join(t.snapshotLocation)}var n=new this(e,t);return objectDBs.set(e,n),Database.ensureDB("internal__objectdb-meta").set(e,_extends({},t,{snapshotLocation:t.snapshotLocation.url})).catch(function(e){return console.error("error writing objectdb meta:",e)}),n}}]),createClass(e,[{key:"destroy",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=Database.findDB(this.name+"-commits"))){e.next=4;break}return e.next=4,t.destroy();case 4:if(!(r=Database.findDB(this.name+"-version-graph"))){e.next=8;break}return e.next=8,r.destroy();case 8:return objectDBs.delete(this.name),n=Database.ensureDB("internal__objectdb-meta"),e.next=12,n.remove(this.name);case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"snapshotResourceFor",value:function(e){var t=e.content.slice(0,2),r=e.content.slice(2);return this.snapshotLocation.join(t+"/"+r+".json")}},{key:"snapshotObject",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o,i,a,s,c){var u,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=o||{},u=function(e){return e},e.next=4,u(n,o);case 4:return p=e.sent,e.abrupt("return",this.commit(t,r,p,i,a,s,c));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n,o,i,a,s,c){return e.apply(this,arguments)}}()},{key:"loadObject",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o,i){var a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=n||{},e.next=3,this.loadSnapshot(t,r,o,i);case 3:return a=e.sent,s=function(e){return e},e.abrupt("return",s(a,n));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n,o,i){return e.apply(this,arguments)}}()},{key:"has",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.objectStats(t,r);case 2:return e.abrupt("return",!!e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"objects",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.objectStats(t);case 2:if(r=e.sent,!t){e.next=5;break}return e.abrupt("return",Object.keys(r||{}));case 5:for(o in n={},r)n[o]=Object.keys(r[o]);return e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"objectStats",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_,k;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n={},e.t0=this.__commitDB,e.t0){e.next=6;break}return e.next=5,this._commitDB();case 5:e.t0=e.sent;case 6:return o=e.t0,i={reduce:!0,group:!0},t&&r?i.key=t+"\0"+r:t&&(i.startkey=t+"\0",i.endkey=t+""),e.prev=9,e.next=12,o.pouchdb.query("nameWithMaxMinTimestamp_index",i);case 12:for(a=e.sent,s=a.rows,c=!0,u=!1,p=void 0,e.prev=17,f=s[Symbol.iterator]();!(c=(l=f.next()).done);c=!0)d=l.value,h=d.key,m=d.value,v=m.count,y=m.max,b=m.min,x=h.split("\0"),g=slicedToArray(x,2),_=g[0],k=g[1],(n[_]||(n[_]={}))[k]={count:v,newest:y,oldest:b};e.next=25;break;case 21:e.prev=21,e.t1=e.catch(17),u=!0,p=e.t1;case 25:e.prev=25,e.prev=26,!c&&f.return&&f.return();case 28:if(e.prev=28,!u){e.next=31;break}throw p;case 31:return e.finish(28);case 32:return e.finish(25);case 33:e.next=39;break;case 35:return e.prev=35,e.t2=e.catch(9),console.error(e.t2),e.abrupt("return",n);case 39:if(!t||!r){e.next=41;break}return e.abrupt("return",(n[t]||{})[r]);case 41:if(!t){e.next=43;break}return e.abrupt("return",n[t]);case 43:return e.abrupt("return",n);case 44:case"end":return e.stop()}},e,this,[[9,35],[17,21,25,33],[26,,28,32]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"getCommits",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"HEAD",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._log(t,r,a,s);case 2:if((n=e.sent).length){e.next=5;break}return e.abrupt("return",[]);case 5:if(e.t0=this.__commitDB,e.t0){e.next=10;break}return e.next=9,this._commitDB();case 9:e.t0=e.sent;case 10:return o=e.t0,e.next=13,o.getDocuments(n.map(function(e){return{id:e}}));case 13:return i=e.sent,e.abrupt("return",i);case 15:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"getCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.__commitDB,e.t0){e.next=5;break}return e.next=4,this._commitDB();case 4:e.t0=e.sent;case 5:return r=e.t0,e.abrupt("return",r.get(t));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getCommitsWithIds",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.length){e.next=2;break}return e.abrupt("return",[]);case 2:if(e.t0=this.__commitDB,e.t0){e.next=7;break}return e.next=6,this._commitDB();case 6:e.t0=e.sent;case 7:return r=e.t0,e.abrupt("return",r.getDocuments(t.map(function(e){return{id:e}})));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getLatestCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"HEAD",u=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._log(t,r,c,1);case 2:if(n=e.sent,o=slicedToArray(n,1),i=o[0]){e.next=7;break}return e.abrupt("return",null);case 7:if(e.t0=this.__commitDB,e.t0){e.next=12;break}return e.next=11,this._commitDB();case 11:e.t0=e.sent;case 12:return a=e.t0,e.next=15,a.get(i);case 15:if(!(s=e.sent)||!s.deleted||u){e.next=18;break}return e.abrupt("return",null);case 18:return e.abrupt("return",s);case 19:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o,i){var a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_,k,w,D,R=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"HEAD",T=arguments[6];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=o.author,s=o.description,c=void 0===s?"no description":s,u=o.tags,p=void 0===u?[]:u,f=o.timestamp,l=o.message,d=void 0===l?"":l,h=o.metadata,m=o.preview,t){e.next=3;break}throw new Error("object needs a type");case 3:if(r){e.next=5;break}throw new Error("object needs a name");case 5:if(a){e.next=7;break}throw new Error("Cannot commit "+t+"/"+r+" without user");case 7:if(e.t0=this.__versionDB,e.t0){e.next=12;break}return e.next=11,this._versionDB();case 11:e.t0=e.sent;case 12:return v=e.t0,e.next=15,this.versionGraph(t,r);case 15:if(y=e.sent,b=y?y.refs[R]:null,x=b?[b]:[],!T){e.next=23;break}if(y){e.next=21;break}throw new Error('Trying to store "'+t+"/"+r+'" on top of expected version '+T+" but no version entry exists!");case 21:if(b===T){e.next=23;break}throw new Error('Trying to store "'+t+"/"+r+'" on top of expected version '+T+" but ref "+R+" is of version "+b+"!");case 23:if(g=isHash(n),_=g?null:n?JSON.stringify(n):null,k=this._createCommit(t,r,c,p,h,a,f,d,x,g?null:n,_,i||m,g?n:null),!n||g){e.next=35;break}return w=this.snapshotResourceFor(k),e.next=28,w.parent().ensureExistance();case 28:if(!w.canDealWithJSON){e.next=33;break}return e.next=31,w.writeJson(n);case 31:e.next=35;break;case 33:return e.next=35,w.write(_);case 35:if(e.t1=this.__commitDB,e.t1){e.next=40;break}return e.next=39,this._commitDB();case 39:e.t1=e.sent;case 40:return D=e.t1,e.next=43,D.set(k._id,k);case 43:return k=e.sent,y||(y={refs:{},history:{}}),y.refs[R]=k._id,y.history[k._id]=x,e.next=49,v.set(t+"/"+r,y);case 49:return e.abrupt("return",k);case 50:case"end":return e.stop()}},e,this)}));return function(t,r,n,o,i){return e.apply(this,arguments)}}()},{key:"loadSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o,i,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"HEAD";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=void 0,!n||"string"==typeof n){e.next=5;break}o=n,e.next=20;break;case 5:if(!n){e.next=17;break}if(e.t0=this.__commitDB,e.t0){e.next=11;break}return e.next=10,this._commitDB();case 10:e.t0=e.sent;case 11:return i=e.t0,e.next=14,i.get(n);case 14:o=e.sent,e.next=20;break;case 17:return e.next=19,this.getLatestCommit(t,r,a);case 19:o=e.sent;case 20:if(o){e.next=22;break}throw new Error("Cannot find commit to loadSnapshot for "+t+"/"+r+" (using "+n+")");case 22:return e.abrupt("return",this.snapshotResourceFor(o).readJson());case 23:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"revert",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o){var i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.__versionDB,e.t0){e.next=5;break}return e.next=4,this._versionDB();case 4:e.t0=e.sent;case 5:return i=e.t0,e.next=8,i.get(t+"/"+r);case 8:return(a=e.sent).refs[n||"HEAD"]=o,delete a.deleted,e.next=13,i.set(t+"/"+r,a);case 13:return e.abrupt("return",a);case 14:case"end":return e.stop()}},e,this)}));return function(t,r,n,o){return e.apply(this,arguments)}}()},{key:"_createCommit",value:function(e,t,r,n,o,i,a){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"",c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:[],u=arguments[9],p=arguments[10],f=arguments[11],l=arguments[12];return!f&&u&&u.preview&&(f=u.preview),this._createCommitFromSpec({name:t,type:e,timestamp:a||Date.now(),author:{name:i.name,email:i.email,realm:i.realm},tags:n,description:r,preview:f,message:s,content:l||p&&sha1(p)||null,deleted:!l&&!u,metadata:o,ancestors:c},!0)}},{key:"_createCommitFromSpec",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.name)throw new Error("commit needs name");if(!e.type)throw new Error("commit needs type");if(!e.author)throw new Error("commit needs author");if(!e.author.name)throw new Error("commit needs author.name");e.timestamp||(e.timestamp=Date.now()),e.tags||(e.tags=[]),!t&&e.content&&((t=isHash(e.content))||(e.content=sha1(e.content)));var r=lively_lang.obj.dissoc(e,["preview"]),n=sha1(JSON.stringify(r));return Object.assign(e,{_id:n})}},{key:"_commitDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.__commitDB){e.next=2;break}return e.abrupt("return",this.__commitDB);case 2:if(t=this.name+"-commits",!(r=Database.findDB(t))){e.next=5;break}return e.abrupt("return",this.__commitDB=r);case 5:return r=Database.ensureDB(t),e.next=8,r.addDesignDocs(this._commitdb_indexes);case 8:return e.abrupt("return",this.__commitDB=r);case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.__commitDB){e.next=4;break}return e.next=3,this.__commitDB.close();case 3:this.__commitDB=null;case 4:if(!this.__versionDB){e.next=8;break}return e.next=7,this.__versionDB.close();case 7:this.__versionDB=null;case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"versionGraph",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.__versionDB,e.t0){e.next=5;break}return e.next=4,this._versionDB();case 4:e.t0=e.sent;case 5:return n=e.t0,e.next=8,n.get(t+"/"+r);case 8:return o=e.sent,e.abrupt("return",!o||o.deleted||o._deleted?null:o);case 10:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_log",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,o,i,a,s,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.versionGraph(t,r);case 2:if((n=e.sent)&&!n.deleted&&!n._deleted){e.next=5;break}return e.abrupt("return",[]);case 5:o=n.refs.HEAD,i=[];case 6:if(!i.includes(o)){e.next=9;break}throw new Error("cyclic version graph???");case 9:if(i.push(o),a=n.history[o]||[],s=slicedToArray(a,1),(o=s[0])&&!(i.length>=c)){e.next=15;break}return e.abrupt("break",17);case 15:e.next=6;break;case 17:return e.abrupt("return",i);case 18:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_findTimestampedVersionsOfObjectNamed",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d,h,m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=m.include_docs,n=void 0===r||r,o=m.descending,i=void 0===o||o,a=m.startTime,s=void 0===a?"0".repeat(13):a,c=m.endTime,u=void 0===c?"9".repeat(13):c,p=t+"\0"+(i?u:s),f=t+"\0"+(i?s:u),e.t0=this.__commitDB,e.t0){e.next=15;break}return e.next=14,this._commitDB();case 14:e.t0=e.sent;case 15:return l=e.t0,e.next=18,l.pouchdb.query("nameAndTimestamp_index",_extends({},m,{descending:i,include_docs:n,startkey:p,endkey:f}));case 18:return d=e.sent,h=d.rows,e.abrupt("return",n?h.map(function(e){return e.doc}):h.map(function(e){return e.id}));case 21:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_versionDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.__versionDB){e.next=2;break}return e.abrupt("return",this.__versionDB);case 2:if(t=this.name+"-version-graph",!(r=Database.findDB(t))){e.next=5;break}return e.abrupt("return",this.__versionDB=r);case 5:return r=Database.ensureDB(t),e.next=8,r.addDesignDocs(this._versiondb_indexes);case 8:return e.abrupt("return",this.__versionDB=r);case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"exportToDir",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_,k,w,D,R,T,B,j,S,C,A,G,O=this,E=arguments.length>2&&void 0!==arguments[2]&&arguments[2],P=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof t&&(t=lively_resources.resource(t)),e.t0=this.__commitDB,e.t0){e.next=6;break}return e.next=5,this._commitDB();case 5:e.t0=e.sent;case 6:if(e.t0,e.t1=this.__versionDB,e.t1){e.next=12;break}return e.next=11,this._versionDB();case 11:e.t1=e.sent;case 12:if(n=e.t1,o=[],r){e.next=58;break}return e.next=17,n.getAll();case 17:i=e.sent,a=!0,s=!1,c=void 0,e.prev=21,u=i[Symbol.iterator]();case 23:if(a=(p=u.next()).done){e.next=42;break}if(f=p.value,l=f.refs,d=f.history,!f._id.startsWith("_")){e.next=28;break}return e.abrupt("continue",39);case 28:return e.next=30,this.getCommit(l.HEAD||Object.keys(d)[0]);case 30:return h=e.sent,m=h.type,v=h.name,y=t.join(m).join(v).asDirectory(),b=Object.keys(d),e.next=37,this.getCommitsWithIds(b);case 37:x=e.sent,o.push({refs:l,history:d,currentExportDir:y,commits:x,name:v,type:m});case 39:a=!0,e.next=23;break;case 42:e.next=48;break;case 44:e.prev=44,e.t2=e.catch(21),s=!0,c=e.t2;case 48:e.prev=48,e.prev=49,!a&&u.return&&u.return();case 51:if(e.prev=51,!s){e.next=54;break}throw c;case 54:return e.finish(51);case 55:return e.finish(48);case 56:e.next=94;break;case 58:g=!0,_=!1,k=void 0,e.prev=61,w=r[Symbol.iterator]();case 63:if(g=(D=w.next()).done){e.next=80;break}return R=D.value,v=R.name,m=R.type,y=t.join(m).join(v).asDirectory(),e.next=69,this.versionGraph(m,v);case 69:return T=e.sent,l=T.refs,d=T.history,b=Object.keys(d),e.next=75,this.getCommitsWithIds(b);case 75:x=e.sent,o.push({refs:l,history:d,currentExportDir:y,commits:x,name:v,type:m});case 77:g=!0,e.next=63;break;case 80:e.next=86;break;case 82:e.prev=82,e.t3=e.catch(61),_=!0,k=e.t3;case 86:e.prev=86,e.prev=87,!g&&w.return&&w.return();case 89:if(e.prev=89,!_){e.next=92;break}throw k;case 92:return e.finish(89);case 93:return e.finish(86);case 94:B=!0,j=!1,S=void 0,e.prev=97,C=regeneratorRuntime.mark(function e(){var t,r,n,o,i,a,s,c,u,p,f,l,d,h,m,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=G.value,r=t.refs,n=t.history,o=t.currentExportDir,i=t.commits,a=t.name,s=t.type,P||(i=i.filter(function(e){return!e.deleted})),c=E?i.map(function(e){if(e.deleted||e._deleted||!e.content)return null;delete e._rev;var t=O.snapshotResourceFor(e);return{from:t,to:o.join(t.parent().name()+"/"+t.name())}}).filter(Boolean):[],E||i.forEach(function(e){delete e._rev}),e.next=7,o.ensureExistance();case 7:return e.next=9,o.join("index.json").writeJson({name:a,type:s});case 9:return e.next=11,o.join("commits.json").writeJson(i);case 11:return e.next=13,o.join("history.json").writeJson({refs:r,history:n});case 13:u=!0,p=!1,f=void 0,e.prev=16,l=c[Symbol.iterator]();case 18:if(u=(d=l.next()).done){e.next=26;break}return h=d.value,m=h.from,v=h.to,e.next=23,m.copyTo(v);case 23:u=!0,e.next=18;break;case 26:e.next=32;break;case 28:e.prev=28,e.t0=e.catch(16),p=!0,f=e.t0;case 32:e.prev=32,e.prev=33,!u&&l.return&&l.return();case 35:if(e.prev=35,!p){e.next=38;break}throw f;case 38:return e.finish(35);case 39:return e.finish(32);case 40:case"end":return e.stop()}},e,O,[[16,28,32,40],[33,,35,39]])}),A=o[Symbol.iterator]();case 100:if(B=(G=A.next()).done){e.next=105;break}return e.delegateYield(C(),"t4",102);case 102:B=!0,e.next=100;break;case 105:e.next=111;break;case 107:e.prev=107,e.t5=e.catch(97),j=!0,S=e.t5;case 111:e.prev=111,e.prev=112,!B&&A.return&&A.return();case 114:if(e.prev=114,!j){e.next=117;break}throw S;case 117:return e.finish(114);case 118:return e.finish(111);case 119:case"end":return e.stop()}},e,this,[[21,44,48,56],[49,,51,55],[61,82,86,94],[87,,89,93],[97,107,111,119],[112,,114,118]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"exportToSpecs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=[],t){e.next=10;break}return t=[],e.next=5,this.objectStats();case 5:if(e.t0=e.sent,e.t0){e.next=8;break}e.t0={};case 8:for(o in n=e.t0)for(i in n[o])t.push({type:o,name:i});case 10:a=!0,s=!1,c=void 0,e.prev=13,u=t[Symbol.iterator]();case 15:if(a=(p=u.next()).done){e.next=33;break}return f=p.value,l=f.name,d=f.type,e.next=20,this.versionGraph(d,l);case 20:return h=e.sent,m=h.refs,v=h.history,y=Object.keys(v),e.next=26,this.getCommitsWithIds(y);case 26:b=e.sent,x||(b=b.filter(function(e){return!e.deleted})),b.forEach(function(e){delete e._rev}),r.push({type:d,name:l,commits:b,history:{refs:m,history:v}});case 30:a=!0,e.next=15;break;case 33:e.next=39;break;case 35:e.prev=35,e.t1=e.catch(13),s=!0,c=e.t1;case 39:e.prev=39,e.prev=40,!a&&u.return&&u.return();case 42:if(e.prev=42,!s){e.next=45;break}throw c;case 45:return e.finish(42);case 46:return e.finish(39);case 47:return e.abrupt("return",r);case 48:case"end":return e.stop()}},e,this,[[13,35,39,47],[40,,42,46]])}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromDir",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=(r=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([t.join("index.json").readJson(),t.join("commits.json").readJson(),t.join("history.json").readJson()]);case 2:if(r=e.sent,n=slicedToArray(r,3),o=n[0],i=o.type,a=o.name,s=n[1],c=n[2],!h){e.next=15;break}return e.next=12,t.dirList(1,{exclude:function(e){return!e.isDirectory()}});case 12:e.t0=e.sent,e.next=16;break;case 15:e.t0=[];case 16:return u=e.t0,e.abrupt("return",{dir:t,type:i,name:a,commits:s,history:c,snapshotDirs:u});case 18:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)}),h=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.dirList(3,{exclude:function(e){return!e.isDirectory()&&"index.json"!==e.name()}});case 2:n=(n=e.sent).filter(function(e){return"index.json"===e.name()}),o=n.map(function(e){return e.parent()}),this.snapshotLocation,i=[],a=!0,s=!1,c=void 0,e.prev=9,u=o[Symbol.iterator]();case 11:if(a=(p=u.next()).done){e.next=21;break}return f=p.value,e.t0=i,e.next=16,d(f);case 16:e.t1=e.sent,e.t0.push.call(e.t0,e.t1);case 18:a=!0,e.next=11;break;case 21:e.next=27;break;case 23:e.prev=23,e.t2=e.catch(9),s=!0,c=e.t2;case 27:e.prev=27,e.prev=28,!a&&u.return&&u.return();case 30:if(e.prev=30,!s){e.next=33;break}throw c;case 33:return e.finish(30);case 34:return e.finish(27);case 35:return e.abrupt("return",this.importFromSpecs(i,l,h));case 36:case"end":return e.stop()}},e,this,[[9,23,27,35],[28,,30,34]])}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromSpecs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d,h,m,v,y=arguments.length>1&&void 0!==arguments[1]&&arguments[1],b=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(y){e.next=36;break}if(e.t0=this.__versionDB,e.t0){e.next=6;break}return e.next=5,this._versionDB();case 5:e.t0=e.sent;case 6:r=e.t0,n=!0,o=!1,i=void 0,e.prev=10,a=t[Symbol.iterator]();case 12:if(n=(s=a.next()).done){e.next=22;break}return c=s.value,u=c.type,p=c.name,e.next=17,r.get(u+"/"+p);case 17:if(!e.sent){e.next=19;break}throw new Error("Import failed: object "+u+"/"+p+" already exists and overwrite is not allowed");case 19:n=!0,e.next=12;break;case 22:e.next=28;break;case 24:e.prev=24,e.t1=e.catch(10),o=!0,i=e.t1;case 28:e.prev=28,e.prev=29,!n&&a.return&&a.return();case 31:if(e.prev=31,!o){e.next=34;break}throw i;case 34:return e.finish(31);case 35:return e.finish(28);case 36:f=!0,l=!1,d=void 0,e.prev=39,h=t[Symbol.iterator]();case 41:if(f=(m=h.next()).done){e.next=48;break}return v=m.value,e.next=45,this.importFromSpec(v,!0,b);case 45:f=!0,e.next=41;break;case 48:e.next=54;break;case 50:e.prev=50,e.t2=e.catch(39),l=!0,d=e.t2;case 54:e.prev=54,e.prev=55,!f&&h.return&&h.return();case 57:if(e.prev=57,!l){e.next=60;break}throw d;case 60:return e.finish(57);case 61:return e.finish(54);case 62:return e.abrupt("return",t);case 63:case"end":return e.stop()}},e,this,[[10,24,28,36],[29,,31,35],[39,50,54,62],[55,,57,61]])}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromSpec",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p=arguments.length>1&&void 0!==arguments[1]&&arguments[1],f=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.__versionDB,e.t0){e.next=5;break}return e.next=4,this._versionDB();case 4:e.t0=e.sent;case 5:if(r=e.t0,e.t1=this.__commitDB,e.t1){e.next=11;break}return e.next=10,this._commitDB();case 10:e.t1=e.sent;case 11:if(n=e.t1,o=this.snapshotLocation,i=t.type,a=t.name,s=t.commits,c=t.history,u=t.snapshotDirs,e.t2=!p,!e.t2){e.next=23;break}return e.next=22,r.get(i+"/"+a);case 22:e.t2=e.sent;case 23:if(!e.t2){e.next=25;break}throw new Error("Import failed: object "+i+"/"+a+" already exists and overwrite is not allowed");case 25:return e.next=27,Promise.all([n.setDocuments(s),r.set(i+"/"+a,c)].concat(toConsumableArray(u&&f?u.map(function(e){return e.copyTo(o.join(e.name()).asDirectory())}):[])));case 27:return e.abrupt("return",t);case 28:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromResource",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o){var i,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.readJson();case 2:if(i=e.sent,e.t0=a,!e.t0){e.next=8;break}return e.next=7,this.has(t,r);case 7:e.t0=e.sent;case 8:if(!e.t0){e.next=11;break}return e.next=11,this.delete(t,r,!1);case 11:return e.abrupt("return",this.commit(t,r,i,o));case 12:case"end":return e.stop()}},e,this)}));return function(t,r,n,o){return e.apply(this,arguments)}}()},{key:"replicateTo",value:function(e,t,r,n){return new Synchronization(this,e,t,r,_extends({method:"replicateTo"},n)).start()}},{key:"replicateFrom",value:function(e,t,r,n){return new Synchronization(this,e,t,r,_extends({method:"replicateFrom"},n)).start()}},{key:"sync",value:function(e,t,r,n){return new Synchronization(this,e,t,r,_extends({method:"sync"},n)).start()}},{key:"getConflicts",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a=(n=asyncToGenerator(regeneratorRuntime.mark(function e(n,o){var i,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getConflicts({include_docs:!0});case 2:return i=e.sent,e.next=5,Promise.all(i.map(function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(i){var s,c,u,p,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=i.id,c=i.rev,u=i.conflicts,p=i.doc,!r||!r[o]||r[o][s]){e.next=3;break}return e.abrupt("return",null);case 3:if(!t){e.next=8;break}return f=u.map(function(e){return{id:s,rev:e}}),e.next=7,n.getDocuments(f);case 7:u=e.sent;case 8:return t?lively_lang.obj.dissoc(p,["_conflicts"]):p=null,e.abrupt("return",{id:s,rev:c,conflicts:u,kind:o,doc:p});case 10:case"end":return e.stop()}},e,a)}));return function(t){return e.apply(this,arguments)}}()));case 5:return e.t0=Boolean,e.abrupt("return",e.sent.filter(e.t0));case 7:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)});return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.__commitDB,e.t0){e.next=5;break}return e.next=4,this._commitDB();case 4:e.t0=e.sent;case 5:if(o=e.t0,e.t1=this.__versionDB,e.t1){e.next=11;break}return e.next=10,this._versionDB();case 10:e.t1=e.sent;case 11:return i=e.t1,e.next=14,a(i,"versions");case 14:return e.t2=e.sent,e.next=17,a(o,"commits");case 17:return e.next=19,e.sent;case 19:return e.t3=e.sent,e.abrupt("return",{versionConflicts:e.t2,commitConflicts:e.t3});case 21:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"resolveConflict",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.resolved,n=t.delete,o=t.kind,i=t.id,a=void 0,"versions"!==o){e.next=10;break}if(e.t0=this.__versionDB,e.t0){e.next=7;break}return e.next=6,this._versionDB();case 6:e.t0=e.sent;case 7:a=e.t0,e.next=20;break;case 10:if("commits"!==o){e.next=19;break}if(e.t1=this.__commitDB,e.t1){e.next=16;break}return e.next=15,this._commitDB();case 15:e.t1=e.sent;case 16:a=e.t1,e.next=20;break;case 19:throw new Error("Unknown conflict kind: "+o);case 20:return e.next=22,a.set(i,r);case 22:return e.next=24,Promise.all(n.map(function(e){return a.pouchdb.remove(i,e)}));case 24:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getDiff",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_,k,w,D,R,T,B,j,S,C,A,G,O,E,P,L,F=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t,"string"==typeof t&&(n=Database.ensureDB(t+"-commits"),r=Database.ensureDB(t+"-version-graph")),e.t0=this.__commitDB,e.t0){e.next=7;break}return e.next=6,this._commitDB();case 6:e.t0=e.sent;case 7:if(o=e.t0,e.t1=this.__versionDB,e.t1){e.next=13;break}return e.next=12,this._versionDB();case 12:e.t1=e.sent;case 13:return i=e.t1,e.next=16,o.diffWith(n);case 16:return a=e.sent,e.next=19,i.diffWith(r);case 19:return s=e.sent,e.next=22,Promise.all(s.inLeft.map(function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t.id,e.next=3,i.get(t.id);case 3:return e.t1=e.sent,e.abrupt("return",{id:e.t0,doc:e.t1});case 5:case"end":return e.stop()}},e,F)}));return function(t){return e.apply(this,arguments)}}()));case 22:return c=e.sent,e.t2=lively_lang.arr,e.next=26,r.getAll();case 26:return e.t3=e.sent,e.t4=function(e){return e._id},u=e.t2.groupBy.call(e.t2,e.t3,e.t4),e.next=31,Promise.all(s.inRight.map(function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{id:t.id,doc:u[t.id]});case 1:case"end":return e.stop()}},e,F)}));return function(t){return e.apply(this,arguments)}}()));case 31:return p=e.sent,e.next=34,Promise.all(s.changed.map(function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=babelHelpers$1,e.t1={},e.t2=t.left,e.next=5,i.get(t.left.id);case 5:return e.t3=e.sent,e.next=8,r.get(t.right.id);case 8:return e.t4=e.sent,e.t5={docA:e.t3,docB:e.t4},e.abrupt("return",e.t0.extends.call(e.t0,e.t1,e.t2,e.t5));case 11:case"end":return e.stop()}},e,F)}));return function(t){return e.apply(this,arguments)}}()));case 34:return f=e.sent,e.t5=lively_lang.arr,e.next=38,n.getAll();case 38:e.t6=e.sent,e.t7=function(e){return e._id},l=e.t5.groupBy.call(e.t5,e.t6,e.t7),d=[],h=[],m=[],v=!0,y=!1,b=void 0,e.prev=47,x=a.inLeft[Symbol.iterator]();case 49:if(v=(g=x.next()).done){e.next=59;break}return _=g.value,e.t8=d,e.next=54,o.get(_.id);case 54:e.t9=e.sent,e.t8.push.call(e.t8,e.t9);case 56:v=!0,e.next=49;break;case 59:e.next=65;break;case 61:e.prev=61,e.t10=e.catch(47),y=!0,b=e.t10;case 65:e.prev=65,e.prev=66,!v&&x.return&&x.return();case 68:if(e.prev=68,!y){e.next=71;break}throw b;case 71:return e.finish(68);case 72:return e.finish(65);case 73:k=!0,w=!1,D=void 0,e.prev=76,R=a.inRight[Symbol.iterator]();case 78:if(k=(T=R.next()).done){e.next=88;break}return B=T.value,e.t11=h,e.next=83,l[B.id];case 83:e.t12=e.sent,e.t11.push.call(e.t11,e.t12);case 85:k=!0,e.next=78;break;case 88:e.next=94;break;case 90:e.prev=90,e.t13=e.catch(76),w=!0,D=e.t13;case 94:e.prev=94,e.prev=95,!k&&R.return&&R.return();case 97:if(e.prev=97,!w){e.next=100;break}throw D;case 100:return e.finish(97);case 101:return e.finish(94);case 102:j=!0,S=!1,C=void 0,e.prev=105,A=a.changed[Symbol.iterator]();case 107:if(j=(G=A.next()).done){e.next=122;break}return O=G.value,e.t14=m,e.next=112,o.get(O.left.id);case 112:return e.t15=e.sent,e.t14.push.call(e.t14,e.t15),e.t16=m,e.next=117,n.get(O.right.id);case 117:e.t17=e.sent,e.t16.push.call(e.t16,e.t17);case 119:j=!0,e.next=107;break;case 122:e.next=128;break;case 124:e.prev=124,e.t18=e.catch(105),S=!0,C=e.t18;case 128:e.prev=128,e.prev=129,!j&&A.return&&A.return();case 131:if(e.prev=131,!S){e.next=134;break}throw C;case 134:return e.finish(131);case 135:return e.finish(128);case 136:return E=d.map(function(e){return lively_lang.obj.select(e,["_id","name","type"])}),P=h.map(function(e){return lively_lang.obj.select(e,["_id","name","type"])}),L=m.map(function(e){return lively_lang.obj.select(e,["_id","name","type"])}),e.abrupt("return",{changed:f,remote:p,local:c,changedCommitTypeAndNames:L,remoteCommitTypeAndNames:P,localCommitTypeAndNames:E});case 138:case"end":return e.stop()}},e,this,[[47,61,65,73],[66,,68,72],[76,90,94,102],[95,,97,101],[105,124,128,136],[129,,131,135]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],o=[],e.t0=this.__commitDB,e.t0){e.next=6;break}return e.next=5,this._commitDB();case 5:e.t0=e.sent;case 6:return i=e.t0,a={include_docs:!0,startkey:t+"\0"+r+"\0",endkey:t+"\0"+r+""},e.next=10,i.query("nameAndTimestamp_index",a);case 10:for(s=e.sent,c=s.rows,u=!0,p=!1,f=void 0,e.prev=15,l=c[Symbol.iterator]();!(u=(d=l.next()).done);u=!0)h=d.value,(m=h.doc).deleted||m._deleted||!m.content||n.push(this.snapshotResourceFor(m)),o.push(_extends({},m,{_deleted:!0}));e.next=23;break;case 19:e.prev=19,e.t1=e.catch(15),p=!0,f=e.t1;case 23:e.prev=23,e.prev=24,!u&&l.return&&l.return();case 26:if(e.prev=26,!p){e.next=29;break}throw f;case 29:return e.finish(26);case 30:return e.finish(23);case 31:if(e.t2=this.__versionDB,e.t2){e.next=36;break}return e.next=35,this._versionDB();case 35:e.t2=e.sent;case 36:return v=e.t2,e.next=39,v.get(t+"/"+r);case 39:if(y=e.sent,b=y._id,x=y._rev,g={_id:b,_rev:x,_deleted:!0},_){e.next=49;break}return e.next=46,i.setDocuments(o);case 46:return e.next=48,v.setDocuments([g]);case 48:Promise.all(n.map(function(e){return e.remove()}));case 49:return e.abrupt("return",{commits:o,history:g,resources:n});case 50:case"end":return e.stop()}},e,this,[[15,19,23,31],[24,,26,30]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"deleteCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d,h,m=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"HEAD";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=void 0,!t||"string"==typeof t){e.next=5;break}r=t,e.next=15;break;case 5:if(!t){e.next=15;break}if(e.t0=this.__commitDB,e.t0){e.next=11;break}return e.next=10,this._commitDB();case 10:e.t0=e.sent;case 11:return n=e.t0,e.next=14,n.get(t);case 14:r=e.sent;case 15:if(r){e.next=17;break}throw new Error("commit needed!");case 17:if(e.t1=this.__versionDB,e.t1){e.next=22;break}return e.next=21,this._versionDB();case 21:e.t1=e.sent;case 22:if(o=e.t1,e.t2=this.__commitDB,e.t2){e.next=28;break}return e.next=27,this._commitDB();case 27:e.t2=e.sent;case 28:return i=e.t2,s=(a=r).name,c=a.type,a._id,u=r.deleted||r._deleted||!r.content?[]:[this.snapshotResourceFor(r)],p=[_extends({},r,{_deleted:!0})],e.next=37,o.get(c+"/"+s);case 37:if(f=e.sent){e.next=40;break}throw new Error("No history for "+c+"/"+s+"@"+r._id);case 40:if(f.refs[v]){e.next=42;break}throw new Error("Cannot delete commit "+c+"/"+s+"@"+r._id+" b/c it is not where ref "+v+" is pointing!");case 42:if(l=f.history[r._id]||[],d=slicedToArray(l,1),(h=d[0])||!(Object.keys(f.history).length<=1)){e.next=47;break}f._deleted=!0,e.next=53;break;case 47:if(h){e.next=51;break}throw new Error("Cannot delete commit "+c+"/"+s+"@"+r._id+" b/c it has no ancestor but there are still other commits!");case 51:delete f.history[r._id],f.refs[v]=h;case 53:if(m){e.next=60;break}return e.next=56,o.set(c+"/"+s,f);case 56:return e.next=58,i.setDocuments(p);case 58:return e.next=60,Promise.all(u.map(function(e){return e.remove()}));case 60:return e.abrupt("return",{commits:p,history:f,resources:u});case 61:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_commitdb_indexes",get:function(){return[{name:"name_index",version:4,mapFn:'function (doc) { emit(doc.type + "\0" + doc.name); }'},{name:"nameAndTimestamp_index",version:3,mapFn:'function (doc) { emit(doc.type + "\0" + doc.name + "\0" + doc.timestamp + "\0" + doc._id); }'},{name:"nameWithMaxMinTimestamp_index",version:3,mapFn:'function(doc) { emit(doc.type + "\0" + doc.name, doc.timestamp); }',reduceFn:"_stats"},{name:"nameTypeFilter",version:9,filterFn:'function(doc, req) {\n          if (doc._id[0] === "_" || !req || !req.query) return true;\n          if (req.query.onlyIds) return !!req.query.onlyIds[doc._id];\n          if (req.query.onlyTypesAndNames)\n            return !!req.query.onlyTypesAndNames[doc.type + "/" + doc.name];\n          return true;\n        }'},{name:"conflict_index",version:4,mapFn:"function(doc) { if (doc._conflicts) emit(doc._id); }"}]}},{key:"_versiondb_indexes",get:function(){return[{name:"nameTypeFilter",version:3,filterFn:'function(doc, req) {\n          if (doc._id[0] === "_" || !req || !req.query) return true;\n          if (req.query.onlyIds) return !!req.query.onlyIds[doc._id];\n          if (req.query.onlyTypesAndNames) return !!req.query.onlyTypesAndNames[doc._id];\n          return true;\n        }'},{name:"conflict_index",version:4,mapFn:"function(doc) { if (doc._conflicts) emit(doc._id); }"}]}}]),e}(),Synchronization=function(){function Synchronization(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};classCallCheck(this,Synchronization),this.options=_extends({debug:!1,live:!1,method:"sync",replicationFilter:void 0},o),this.state="not started",this.method="",this.fromObjectDB=e,this.remoteCommitDB=t,this.remoteVersionDB=r,this.remoteLocation=n,this.deferred=lively_lang.promise.deferred(),this.conflicts=[],this.changes=[],this.errors=[]}return createClass(Synchronization,[{key:"whenPaused",value:function(){var e=this;return Promise.resolve().then(function(){return lively_lang.promise.waitFor(function(){return e.isPaused||e.isComplete})}).then(function(){return e})}},{key:"waitForIt",value:function(){return this.deferred.promise}},{key:"start",value:function(){return this.isSynchonizing||this._startReplicationAndCopy().catch(function(e){return console.error("Error starting synchronization: ",e)}),this}},{key:"_startReplicationAndCopy",value:function(){var _ref69=asyncToGenerator(regeneratorRuntime.mark(function _callee40(){var _this5=this,fromObjectDB,remoteCommitDB,remoteVersionDB,remoteLocation,_options,debug,_options$live,live,_options$retry,retry,method,replicationFilter,_options$pushDesignDo,pushDesignDocToRemote,versionDB,commitDB,_commitdb_indexes,_versiondb_indexes,fromSnapshotLocation,versionChangeListener,commitChangeListener,commitNameTypeFilter,versionNameTypeFilter,opts,commitOpts,versionOpts,commitReplication,versionReplication,snapshotReplication,commitReplicationState,versionReplicationState,updateState,tryToResolve,snapshotPathFor;return regeneratorRuntime.wrap(function _callee40$(_context41){for(;;)switch(_context41.prev=_context41.next){case 0:if(snapshotPathFor=function(e){return e.content?e.content.slice(0,2)+"/"+e.content.slice(2)+".json":null},tryToResolve=function(e,t){if(t.length||"complete"===commitReplicationState&&"complete"===versionReplicationState&&snapshotReplication.isComplete()){versionChangeListener.cancel();var r=void 0;t.length?(e.state="complete",e.errors=t,commitReplication.cancel(),versionReplication.cancel(),(r=new Error("Synchronization error:\n  "+t.join("\n  "))).errors=t,console.log(e+" errored")):console.log(e+" completed"),r?e.deferred.reject(r):e.deferred.resolve(e)}},updateState=function(e){return"paused"===versionReplicationState&&"paused"===commitReplicationState&&snapshotReplication.copyCalls<=0&&snapshotReplication.copyCallsWaiting<=0?e.state="paused":"complete"===versionReplicationState&&"complete"===commitReplicationState&&snapshotReplication.isComplete()?e.state="complete":e.state="running"},fromObjectDB=this.fromObjectDB,remoteCommitDB=this.remoteCommitDB,remoteVersionDB=this.remoteVersionDB,remoteLocation=this.remoteLocation,_options=this.options,debug=_options.debug,_options$live=_options.live,live=void 0!==_options$live&&_options$live,_options$retry=_options.retry,retry=void 0!==_options$retry&&_options$retry,method=_options.method,replicationFilter=_options.replicationFilter,_options$pushDesignDo=_options.pushDesignDocToRemote,pushDesignDocToRemote=void 0!==_options$pushDesignDo&&_options$pushDesignDo,_context41.t0=fromObjectDB.__versionDB,_context41.t0){_context41.next=22;break}return _context41.next=21,fromObjectDB._versionDB();case 21:_context41.t0=_context41.sent;case 22:if(versionDB=_context41.t0,_context41.t1=fromObjectDB.__commitDB,_context41.t1){_context41.next=28;break}return _context41.next=27,fromObjectDB._commitDB();case 27:_context41.t1=_context41.sent;case 28:if(commitDB=_context41.t1,_commitdb_indexes=fromObjectDB._commitdb_indexes,_versiondb_indexes=fromObjectDB._versiondb_indexes,fromSnapshotLocation=fromObjectDB.snapshotLocation,versionChangeListener=void 0,commitChangeListener=void 0,this.method=method,commitNameTypeFilter=_commitdb_indexes.find(function(e){return"nameTypeFilter"===e.name}),versionNameTypeFilter=_versiondb_indexes.find(function(e){return"nameTypeFilter"===e.name}),!pushDesignDocToRemote){_context41.next=43;break}return console.log("adding commitNameTypeFilter"),_context41.next=40,remoteCommitDB.addDesignDoc(commitNameTypeFilter);case 40:return console.log("adding versionNameTypeFilter"),_context41.next=43,remoteVersionDB.addDesignDoc(versionNameTypeFilter);case 43:return opts={live:live,retry:retry},commitOpts=_extends({},opts),versionOpts=_extends({},opts),replicationFilter&&(commitOpts.filter=eval("("+commitNameTypeFilter.filterFn+")"),commitOpts.query_params=replicationFilter,versionOpts.filter=eval("("+versionNameTypeFilter.filterFn+")"),versionOpts.query_params=replicationFilter),commitReplication=commitDB[method](remoteCommitDB,commitOpts),versionReplication=versionDB[method](remoteVersionDB,versionOpts),snapshotReplication={copyCalls:0,copyCallsWaiting:0,nFilesToCopy:0,nFilesCopied:0,stopped:!1,isComplete:function(){return this.stopped||this.copyCalls<=0&&this.copyCallsWaiting<=0}},commitReplicationState="not started",versionReplicationState="not started",this.versionReplication=versionReplication,this.commitReplication=commitReplication,this.snapshotReplication=snapshotReplication,commitChangeListener=remoteCommitDB.pouchdb.changes({include_docs:!0,live:!0,conflicts:!0}),versionChangeListener=remoteVersionDB.pouchdb.changes({include_docs:!0,live:!0,conflicts:!0}),commitChangeListener.on("change",function(e){var t=e.id,r=e.changes,n=e.doc._conflicts;debug&&console.log("commit changes "+t+":",r,n),n&&(console.log("commit conflict "+t+":",r,n),_this5.conflicts.push({db:"commits",id:t,changes:r,conflicts:n}))}),versionChangeListener.on("change",function(e){var t=e.id,r=e.changes,n=e.doc._conflicts;debug&&console.log("version changes "+t+":",r,n),n&&(console.log("version conflict "+t+":",r,n),_this5.conflicts.push({db:"versions",id:t,changes:r,conflicts:n}))}),commitReplication.on("change",function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,p,f,l,d,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"replicateTo"===method?t={direction:"push",change:t}:"replicateFrom"===method&&(t={direction:"pull",change:t}),n=(r=t).direction,o=r.change,o.ok,i=o.docs,o.errors,console.log(_this5+" "+("push"===n?"send":"received")+" "+i.length+" commits"),e.prev=3,s=[],c=!0,u=!1,p=void 0,e.prev=8,f=i[Symbol.iterator]();case 10:if(c=(l=f.next()).done){e.next=20;break}if(!(d=l.value)._id.startsWith("_")){e.next=14;break}return e.abrupt("continue",17);case 14:_this5.changes.push({direction:n,kind:"commits",id:d._id,type:d.type,name:d.name}),(h=snapshotPathFor(d))&&s.push(h);case 17:c=!0,e.next=10;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(8),u=!0,p=e.t0;case 26:e.prev=26,e.prev=27,!c&&f.return&&f.return();case 29:if(e.prev=29,!u){e.next=32;break}throw p;case 32:return e.finish(29);case 33:return e.finish(26);case 34:if(snapshotReplication.nFilesToCopy+=s.length,!(snapshotReplication.copyCalls>0)){e.next=40;break}return snapshotReplication.copyCallsWaiting++,e.next=39,lively_lang.promise.waitFor(function(){return snapshotReplication.copyCalls<=0});case 39:snapshotReplication.copyCallsWaiting--;case 40:return snapshotReplication.copyCalls++,updateState(_this5),console.log(_this5+" copying "+s.length+" snapshots..."),e.next=45,lively_lang.promise.parallel(s.map(function(e){return function(){var t=("push"===n?fromSnapshotLocation:remoteLocation).join(e),r=("push"===n?remoteLocation:fromSnapshotLocation).join(e);return snapshotReplication.stopped?(console.warn(_this5+" Stopping copying resources b/c synchronization ended ("+snapshotReplication.copyCalls+", "+t.url+" => "+r.url+")"),Promise.resolve()):r.exists().then(function(e){return e?(debug&&console.log("Skip copying to "+r.url+", already exist"),Promise.resolve()):t.exists().then(function(e){return e?(debug&&console.log(_this5+" Copying "+t.url+" => "+r.url),function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return t.copyTo(r).catch(function(t){if(n>=5)throw t;return e(n+1)})}(0).then(function(e){return snapshotReplication.nFilesCopied++,snapshotReplication.stopped||snapshotReplication.nFilesCopied%10!=0||console.log(_this5+" copied "+snapshotReplication.nFilesCopied+" of "+snapshotReplication.nFilesToCopy+" snapshots"),e})):(console.warn("Skip copying "+t.url+", does not exist"),Promise.resolve())})})}}),5);case 45:console.log(_this5+" sending files done"),e.next=53;break;case 48:throw e.prev=48,e.t1=e.catch(3),console.error("error in commitReplication onChange",e.t1),a=e.t1,e.t1;case 53:return e.prev=53,snapshotReplication.copyCalls--,updateState(_this5),tryToResolve(_this5,a?[a]:[]),e.finish(53);case 58:case"end":return e.stop()}},e,_this5,[[3,48,53,58],[8,22,26,34],[27,,29,33]])}));return function(t){return e.apply(this,arguments)}}()).on("paused",function(){commitReplicationState="paused",updateState(_this5),debug&&console.log(_this5+" commit replication paused")}).on("active",function(){commitReplicationState="active",updateState(_this5),debug&&console.log(_this5+" commit replication active")}).on("error",function(e){commitReplicationState="complete",updateState(_this5),console.error(_this5+" commit replication error",e),tryToResolve(_this5,[e])}).on("complete",function(e){commitReplicationState="complete",updateState(_this5);var t="sync"===method?e.push.errors.concat(e.pull.errors):e.errors;tryToResolve(_this5,t)}),versionReplication.on("change",function(e){"replicateTo"===method?e={direction:"push",change:e}:"replicateFrom"===method&&(e={direction:"pull",change:e});var t=e,r=t.direction,n=t.change,o=(n.ok,n.docs);n.errors;debug&&console.log(_this5+" "+("push"===r?"send":"received")+" "+o.length+" histories"),o.forEach(function(e){e._id.startsWith("_")||_this5.changes.push({direction:r,kind:"versions",id:e._id})})}).on("paused",function(){versionReplicationState="paused",updateState(_this5),debug&&console.log(_this5+" version replication paused")}).on("active",function(e){versionReplicationState="active",updateState(_this5),debug&&console.log(_this5+" version replication active",e)}).on("error",function(e){versionReplicationState="complete",updateState(_this5),console.error(_this5+" version replication error",e),tryToResolve(_this5,[e])}).on("complete",function(e){versionReplicationState="complete",updateState(_this5);var t="sync"===method?e.push.errors.concat(e.pull.errors):e.errors;tryToResolve(_this5,t)}),this.state="running",_context41.abrupt("return",this);case 57:case"end":return _context41.stop()}},_callee40,this)}));function _startReplicationAndCopy(){return _ref69.apply(this,arguments)}return _startReplicationAndCopy}()},{key:"safeStop",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("not started"!==this.state&&this.isSynchonizing){e.next=2;break}return e.abrupt("return",this);case 2:return e.next=4,this.whenPaused();case 4:return e.abrupt("return",this.stop());case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){return"not started"!==this.state&&this.isSynchonizing?(this.commitReplication.cancel(),this.versionReplication.cancel(),this.snapshotReplication.stopped=!0,this):this}},{key:"toString",value:function(){var e=this.method;return"Synchronization("+this.state+": "+this.fromObjectDB.name+" "+("sync"===e?"<=>":"replicateTo"===e?"=>":"replicateFrom"===e?"<=":"??")+")"}},{key:"isSynchonizing",get:function(){return this.isPaused||this.isRunning}},{key:"isComplete",get:function(){return"complete"===this.state}},{key:"isRunning",get:function(){return"running"===this.state}},{key:"isPaused",get:function(){return"paused"===this.state}},{key:"changesByTypeAndName",get:function(){var e={push:{},pull:{}};return this.changes.forEach(function(t){var r=t.direction,n=t.id,o=t.kind;if("_"!==n[0]){var i=void 0;if("versions"===o)i=e[r][n]||(e[r][n]=[]);else if("commits"===o){var a=t.type+"/"+t.name;i=e[r][a]||(e[r][a]=[])}i.push(t)}}),e}}]),Synchronization}();function checkArg(e,t,r){if(void 0===t&&"string"==typeof r&&!r.includes("undefined"))throw new Error("parameter "+e+" is undefined");if(null===t&&"string"==typeof r&&!r.includes("null"))throw new Error("parameter "+e+" is null");if("string"==typeof r&&function(){var n=void 0===t?"undefined":_typeof(t),o=t?t.constructor.name:"";if(!r.split("|").some(function(e){return n===e||o===e}))throw new Error('parameter "'+e+'" expected to be of type '+r+" but is "+(o||n))}(),"function"==typeof r){var n=r(t);if(n&&n.error)throw new Error('check of parameter "'+e+'" failed: '+n.error)}}function checkArgs(e,t,r){for(var n in t)checkArg(n,e[n],t[n]);if("function"==typeof r){var o=r(e);if(o&&o.error)throw new Error(o.error)}return e}var ObjectDBInterface={describe:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(a=function(e,t){var r=e.find(function(e){return e.name===t}).node.value.body,n=r.body||[],o=(r.comments||[]).find(function(e){return e.end<n[0].start}),i={name:t,parameters:[],sideEffect:!1,returns:null,description:""};if(o&&o.text.trim()){var a=lively.lang.string.changeIndent(o.text," ",0).split("\n"),s=!0,c=!1,u=void 0;try{for(var p,f=a[Symbol.iterator]();!(s=(p=f.next()).done);s=!0){var l=p.value;if(l.startsWith("ignore-in-doc")){i.description="";break}l.startsWith("side effect:")?i.sideEffect=JSON.parse(l.split(":")[1]):l.startsWith("returns:")?i.returns=l.split(":")[1].trim():i.description+=l+"\n"}}catch(e){c=!0,u=e}finally{try{!s&&f.return&&f.return()}finally{if(c)throw u}}}var d=!0,h=!1,m=void 0;try{for(var v,y=n[Symbol.iterator]();!(d=(v=y.next()).done);d=!0){var b=v.value;if("checkArgs"===lively.lang.Path("declarations.0.init.callee.name").get(b)){var x=lively.lang.Path("declarations.0.id.properties").get(b);x&&(i.parameters=x.map(function(e){return e.key.name}))}}}catch(e){h=!0,m=e}finally{try{!d&&y.return&&y.return()}finally{if(h)throw m}}return i},r.prev=1,t._methodSpecs){r.next=9;break}return r.next=5,lively.modules.module("lively.storage/objectdb.js").source();case 5:n=r.sent,o=lively.ast.parse(n,{withComments:!0}),i=lively.ast.categorizer.findDecls(o),t._methodSpecs=i.filter(function(e){return e.parent&&"ObjectDBInterface"===e.parent.name});case 9:return r.abrupt("return",e?a(t._methodSpecs,e):t._methodSpecs.map(function(e){return a(t._methodSpecs,e.name)}).filter(Boolean));case 12:return r.prev=12,r.t0=r.catch(1),r.abrupt("return","Error in describe "+r.t0);case 15:case"end":return r.stop()}},r,t,[[1,12]])}))()},ensureDB:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",snapshotLocation:"string|Resource"}),o=n.db,i=n.snapshotLocation,t.next=5,ObjectDB.find(o);case 5:if(!t.sent){t.next=8;break}return t.abrupt("return",!1);case 8:return ObjectDB.named(o,{snapshotLocation:i}),t.abrupt("return",!0);case 10:case"end":return t.stop()}},r,t)}))()},destroyDB:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string"}),o=n.db,t.next=4,ObjectDB.find(o);case 4:if(i=t.sent){t.next=7;break}return t.abrupt("return",!1);case 7:return t.next=9,i.destroy();case 9:return t.abrupt("return",!0);case 10:case"end":return t.stop()}},r,t)}))()},fetchCommits:function fetchCommits(args){var _this9=this;return asyncToGenerator(regeneratorRuntime.mark(function _callee45(){var _checkArgs3,dbName,ref,type,typesAndNames,knownCommitIds,includeDeleted,filterFn,db,commitDB,versionDB,versionQueryOpts,refsByTypeAndName,keys,_iteratorNormalCompletion17,_didIteratorError17,_iteratorError17,_iterator17,_step17,_ref73,_type2,name,_ref74,versions,commitIds,_iteratorNormalCompletion18,_didIteratorError18,_iteratorError18,_iterator18,_step18,version,_id,refs,commitId,commits,fn,filteredCommits;return regeneratorRuntime.wrap(function _callee45$(_context46){for(;;)switch(_context46.prev=_context46.next){case 0:return _checkArgs3=checkArgs(args,{db:"string",ref:"string|undefined",type:"string|undefined",typesAndNames:"Array|undefined",knownCommitIds:"object|undefined",includeDeleted:"boolean|undefined",filterFn:"string|undefined"}),dbName=_checkArgs3.db,ref=_checkArgs3.ref,type=_checkArgs3.type,typesAndNames=_checkArgs3.typesAndNames,knownCommitIds=_checkArgs3.knownCommitIds,includeDeleted=_checkArgs3.includeDeleted,filterFn=_checkArgs3.filterFn,_context46.next=10,ObjectDB.find(dbName);case 10:if(db=_context46.sent,ref||(ref="HEAD"),db){_context46.next=14;break}throw new Error("db "+dbName+" does not exist");case 14:if(_context46.t0=db.__commitDB,_context46.t0){_context46.next=19;break}return _context46.next=18,db._commitDB();case 18:_context46.t0=_context46.sent;case 19:if(commitDB=_context46.t0,_context46.t1=db.__versionDB,_context46.t1){_context46.next=25;break}return _context46.next=24,db._versionDB();case 24:_context46.t1=_context46.sent;case 25:if(versionDB=_context46.t1,versionQueryOpts={},refsByTypeAndName={},!typesAndNames){_context46.next=50;break}for(keys=versionQueryOpts.keys=[],_iteratorNormalCompletion17=!0,_didIteratorError17=!1,_iteratorError17=void 0,_context46.prev=32,_iterator17=typesAndNames[Symbol.iterator]();!(_iteratorNormalCompletion17=(_step17=_iterator17.next()).done);_iteratorNormalCompletion17=!0)_ref73=_step17.value,_type2=_ref73.type,name=_ref73.name,_ref74=_ref73.ref,keys.push(_type2+"/"+name),_ref74&&(refsByTypeAndName[_type2+"/"+name]=_ref74);_context46.next=40;break;case 36:_context46.prev=36,_context46.t2=_context46.catch(32),_didIteratorError17=!0,_iteratorError17=_context46.t2;case 40:_context46.prev=40,_context46.prev=41,!_iteratorNormalCompletion17&&_iterator17.return&&_iterator17.return();case 43:if(_context46.prev=43,!_didIteratorError17){_context46.next=46;break}throw _iteratorError17;case 46:return _context46.finish(43);case 47:return _context46.finish(40);case 48:_context46.next=51;break;case 50:type&&(versionQueryOpts.startkey=type+'/\0"',versionQueryOpts.endkey=type+'/"');case 51:return _context46.next=53,versionDB.getAll(versionQueryOpts);case 53:versions=_context46.sent,commitIds=[],_iteratorNormalCompletion18=!0,_didIteratorError18=!1,_iteratorError18=void 0,_context46.prev=58,_iterator18=versions[Symbol.iterator]();case 60:if(_iteratorNormalCompletion18=(_step18=_iterator18.next()).done){_context46.next=73;break}if(version=_step18.value,!version.deleted&&!version._deleted){_context46.next=64;break}return _context46.abrupt("continue",70);case 64:if(_id=version._id,refs=version.refs,!_id.startsWith("_")){_context46.next=67;break}return _context46.abrupt("continue",70);case 67:ref=refsByTypeAndName[_id]||ref,commitId=refs[ref],(commitId&&!knownCommitIds||!knownCommitIds.hasOwnProperty(commitId))&&commitIds.push(commitId);case 70:_iteratorNormalCompletion18=!0,_context46.next=60;break;case 73:_context46.next=79;break;case 75:_context46.prev=75,_context46.t3=_context46.catch(58),_didIteratorError18=!0,_iteratorError18=_context46.t3;case 79:_context46.prev=79,_context46.prev=80,!_iteratorNormalCompletion18&&_iterator18.return&&_iterator18.return();case 82:if(_context46.prev=82,!_didIteratorError18){_context46.next=85;break}throw _iteratorError18;case 85:return _context46.finish(82);case 86:return _context46.finish(79);case 87:return _context46.next=89,db.getCommitsWithIds(commitIds);case 89:if(commits=_context46.sent,includeDeleted||(commits=commits.filter(function(e){return!e.deleted})),!filterFn){_context46.next=107;break}if(_context46.prev=92,fn=eval("("+filterFn+")"),"function"==typeof fn){_context46.next=96;break}throw new Error(filterFn+" does not eval to a function!");case 96:if(filteredCommits=commits.filter(fn),Array.isArray(filteredCommits)){_context46.next=101;break}throw new Error(filterFn+" does not return an array!");case 101:commits=filteredCommits;case 102:_context46.next=107;break;case 104:_context46.prev=104,_context46.t4=_context46.catch(92),console.error("fetchCommits filterFn failed:",_context46.t4);case 107:return _context46.abrupt("return",commits);case 108:case"end":return _context46.stop()}},_callee45,_this9,[[32,36,40,48],[41,,43,47],[58,75,79,87],[80,,82,86],[92,104]])}))()},fetchVersionGraph:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string"}),o=n.db,i=n.type,a=n.name,t.next=6,ObjectDB.find(o);case 6:if(s=t.sent){t.next=9;break}throw new Error("db "+o+" does not exist");case 9:return t.next=11,s.versionGraph(i,a);case 11:return c=t.sent,u=c.refs,p=c.history,t.abrupt("return",{refs:u,history:p});case 15:case"end":return t.stop()}},r,t)}))()},exists:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string",ref:"string|undefined"}),o=n.db,i=n.type,a=n.name,s=n.ref,t.next=7,ObjectDB.find(o);case 7:return c=t.sent,t.next=10,c.versionGraph(i,a);case 10:if(u=t.sent){t.next=13;break}return t.abrupt("return",{exists:!1,commitId:void 0});case 13:if(s=s||"HEAD",p=u.refs[s]){t.next=17;break}return t.abrupt("return",{exists:!1,commitId:void 0});case 17:return t.abrupt("return",{exists:!0,commitId:p});case 18:case"end":return t.stop()}},r,t)}))()},fetchLog:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p,f,l,d,h,m,v,y,b,x,g,_,k;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string|undefined",name:"string|undefined",ref:"string|undefined",commit:"string|undefined",limit:"number|undefined",includeCommits:"boolean|undefined",knownCommitIds:"object|undefined"},function(e){return e.type&&e.name||e.commit?null:{error:"Eiter .type + .name or .commit needed!"}}),o=n.db,i=n.type,a=n.name,s=n.ref,c=n.commit,u=n.limit,p=n.includeCommits,f=n.knownCommitIds,t.next=11,ObjectDB.find(o);case 11:if(l=t.sent,d=s||"HEAD",l){t.next=15;break}throw new Error("db "+o+" does not exist");case 15:if(u||(u=1/0),c||s||(s=d),h=void 0,!c){t.next=28;break}if(h=c,i&&a){t.next=28;break}return t.next=23,l.getCommit(c);case 23:if(m=t.sent){t.next=26;break}throw new Error("fetchLog: specified commit "+c+" but no commit with this id is in the database!");case 26:i=m.type,a=m.name;case 28:return t.next=30,l.versionGraph(i,a);case 30:if(v=t.sent){t.next=33;break}throw new Error("Unknown object "+i+"/"+a);case 33:y=v.refs,b=v.history,h||(h=y[s]),x=h,g=[];case 36:if(!(g.length<u)||g.includes(x)){t.next=45;break}if(g.push(x),(_=b[x])&&_.length){t.next=41;break}return t.abrupt("break",45);case 41:k=slicedToArray(_,1),x=k[0],t.next=36;break;case 45:if(!p){t.next=50;break}return f&&(g=g.filter(function(e){return!f.hasOwnProperty(e)})),t.next=49,l.getCommitsWithIds(g);case 49:g=t.sent;case 50:return t.abrupt("return",g);case 51:case"end":return t.stop()}},r,t)}))()},fetchSnapshot:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p,f;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string|undefined",name:"string|undefined",ref:"string|undefined",commit:"string|undefined"},function(e){return e.type&&e.name||e.commit?null:{error:"Eiter .type + .name or .commit needed!"}}),o=n.db,i=n.type,a=n.name,s=n.ref,c=n.commit,t.next=8,ObjectDB.find(o);case 8:if(u=t.sent,s=s||"HEAD",u){t.next=13;break}throw new Error("db "+o+" does not exist");case 13:if(c){t.next=22;break}return t.next=16,u.versionGraph(i,a);case 16:if(p=t.sent){t.next=19;break}throw new Error("Unknown object "+i+"/"+a);case 19:if(c=p.refs[s]){t.next=22;break}throw new Error("Cannot find commit for ref "+s+" of "+i+"/"+a);case 22:return t.next=24,u.getCommit(c);case 24:if(f=t.sent){t.next=27;break}throw new Error("Cannot find commit "+c);case 27:return t.abrupt("return",u.loadSnapshot(void 0,void 0,f));case 28:case"end":return t.stop()}},r,t)}))()},revert:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string",ref:"string|undefined",toCommitId:"string"}),o=n.db,i=n.type,a=n.name,s=n.ref,c=n.toCommitId,t.next=8,ObjectDB.find(o);case 8:return u=t.sent,s||(s="HEAD"),t.abrupt("return",u.revert(i,a,s,c));case 11:case"end":return t.stop()}},r,t)}))()},commit:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p,f,l;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string",ref:"string|undefined",snapshot:"object|string|undefined",preview:"string|undefined",commitSpec:"object",expectedParentCommit:"string|undefined"}),o=n.db,i=n.type,a=n.name,s=n.ref,c=n.expectedParentCommit,u=n.commitSpec,p=n.snapshot,f=n.preview,t.next=11,ObjectDB.find(o);case 11:return l=t.sent,s||(s="HEAD"),t.abrupt("return",l.commit(i,a,p,u,f,s,c));case 14:case"end":return t.stop()}},r,t)}))()},exportToSpecs:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",nameAndTypes:"Array|undefined",includeDeleted:"boolean|undefined"}),o=n.db,i=n.nameAndTypes,t.next=5,ObjectDB.find(o);case 5:if(a=t.sent){t.next=8;break}throw new Error("db "+o+" does not exist");case 8:return t.abrupt("return",a.exportToSpecs(i));case 9:case"end":return t.stop()}},r,t)}))()},exportToDir:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",url:"string",nameAndTypes:"Array|undefined",copyResources:"boolean|undefined",includeDeleted:"boolean|undefined"}),o=n.db,i=n.url,a=n.nameAndTypes,s=n.copyResources,c=n.includeDeleted,t.next=8,ObjectDB.find(o);case 8:if(u=t.sent,p=void 0,u){t.next=12;break}throw new Error("db "+o+" does not exist");case 12:try{p=lively_resources.resource(i)}catch(e){p=lively_resources.resource(System.baseURL).join(i)}return t.abrupt("return",u.exportToDir(p,a,s,c));case 14:case"end":return t.stop()}},r,t)}))()},importFromDir:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",url:"string",overwrite:"boolean|undefined",copyResources:"boolean|undefined"}),o=n.db,i=n.url,a=n.overwrite,s=n.copyResources,t.next=7,ObjectDB.find(o);case 7:if(c=t.sent,u=void 0,c){t.next=11;break}throw new Error("db "+o+" does not exist");case 11:try{u=lively_resources.resource(i)}catch(e){u=lively_resources.resource(System.baseURL).join(i)}return t.abrupt("return",c.importFromDir(u,a,s));case 13:case"end":return t.stop()}},r,t)}))()},importFromSpecs:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",specs:"object",overwrite:"boolean|undefined",copyResources:"boolean|undefined"}),o=n.db,i=n.specs,a=n.overwrite,s=n.copyResources,t.next=7,ObjectDB.find(o);case 7:if(c=t.sent){t.next=10;break}throw new Error("db "+o+" does not exist");case 10:return t.abrupt("return",c.importFromSpecs(i,a,s));case 11:case"end":return t.stop()}},r,t)}))()},importFromResource:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p,f;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string",url:"string",commitSpec:"object",purgeHistory:"boolean|undefined"}),o=n.db,i=n.type,a=n.name,s=n.url,c=n.commitSpec,u=n.purgeHistory,t.next=9,ObjectDB.find(o);case 9:if(p=t.sent,f=void 0,p){t.next=13;break}throw new Error("db "+o+" does not exist");case 13:try{f=lively_resources.resource(s)}catch(e){f=lively_resources.resource(System.baseURL).join(s)}return t.abrupt("return",p.importFromResource(i,a,f,c,u));case 15:case"end":return t.stop()}},r,t)}))()},delete:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",type:"string",name:"string",dryRun:"boolean|undefined"}),o=n.db,i=n.type,a=n.name,s=n.dryRun,t.next=7,ObjectDB.find(o);case 7:return c=t.sent,t.abrupt("return",c.delete(i,a,void 0===s||s));case 9:case"end":return t.stop()}},r,t)}))()},deleteCommit:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",commit:"string",dryRun:"boolean|undefined"}),o=n.db,i=n.commit,a=n.dryRun,t.next=6,ObjectDB.find(o);case 6:return s=t.sent,t.abrupt("return",s.deleteCommit(i,void 0===a||a));case 8:case"end":return t.stop()}},r,t)}))()},fetchConflicts:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",includeDocs:"boolean|undefined",only:"object|undefined"}),o=n.db,i=n.includeDocs,a=n.only,t.next=6,ObjectDB.find(o);case 6:return s=t.sent,t.abrupt("return",s.getConflicts(i,a));case 8:case"end":return t.stop()}},r,t)}))()},resolveConflict:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",id:"string",kind:"string",delete:"Array",resolved:"object"}),o=n.db,i=n.resolved,a=n.delete,s=n.kind,c=n.id,t.next=8,ObjectDB.find(o);case 8:return u=t.sent,t.abrupt("return",u.resolveConflict({resolved:i,delete:a,kind:s,id:c}));case 10:case"end":return t.stop()}},r,t)}))()},fetchDiff:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",otherDB:"string"}),o=n.db,i=n.otherDB,t.next=5,ObjectDB.find(o);case 5:return a=t.sent,t.abrupt("return",a.getDiff(i));case 7:case"end":return t.stop()}},r,t)}))()},synchronize:function(e){var t=this;return asyncToGenerator(regeneratorRuntime.mark(function r(){var n,o,i,a,s,c,u,p,f,l,d,h,m;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=checkArgs(e,{db:"string",otherDB:"string",otherDBSnapshotLocation:"string|undefined",onlyTypesAndNames:"object|undefined",method:"string|undefined"}),o=n.db,i=n.otherDB,a=n.otherDBSnapshotLocation,s=n.onlyTypesAndNames,c=n.method,t.next=8,ObjectDB.find(o);case 8:return t.sent,a||(a=i.replace(/\/$/,"")+"/snapshots"),c||(c="replicateTo"),t.next=13,ObjectDB.find(o);case 13:return u=t.sent,t.next=16,ObjectDB.named(i,{snapshotLocation:a});case 16:return p=t.sent,t.next=19,p._commitDB();case 19:return f=t.sent,t.next=22,p._versionDB();case 22:return l=t.sent,d=p.snapshotLocation,h={replicationFilter:s?{onlyTypesAndNames:s}:void 0,retry:!0,live:!0},m=u[c](f,l,d,h),t.next=28,m.whenPaused();case 28:return t.next=30,m.safeStop();case 30:return t.next=32,m.waitForIt();case 32:return t.abrupt("return",lively_lang.obj.select(m,["state","method","conflicts","errors","changesByTypeAndName"]));case 33:case"end":return t.stop()}},r,t)}))()}},ObjectDBHTTPInterface=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.location.origin+"/objectdb/";classCallCheck(this,e),this.serverURL=t}return createClass(e,[{key:"_processResponse",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.headers.get("content-type"),e.next=3,t.text();case 3:if(n=e.sent,o=void 0,"application/json"===r)try{o=JSON.parse(n)}catch(e){}if(!(!t.ok||o&&o.error)){e.next=8;break}throw new Error(o&&o.error||n||t.statusText);case 8:return e.abrupt("return",o||n);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_GET",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object.keys(o).map(function(e){var t=o[e];return"object"===(void 0===t?"undefined":_typeof(t))&&(t=JSON.stringify(t)),e+"="+encodeURIComponent(t)}).join("&"),n=this.serverURL+t+"?"+r,e.t0=this,e.next=4,fetch(n);case 4:return e.t1=e.sent,e.abrupt("return",e.t0._processResponse.call(e.t0,e.t1));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_POST",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.serverURL+t,e.t0=this,e.next=4,fetch(r,{method:"POST",body:JSON.stringify(n),headers:{"content-type":"application/json"}});case 4:return e.t1=e.sent,e.abrupt("return",e.t0._processResponse.call(e.t0,e.t1));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"describe",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("describe",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"ensureDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("ensureDB",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"destroyDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("destroyDB",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchCommits",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchCommits",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchVersionGraph",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchVersionGraph",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("exists",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchLog",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchLog",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchSnapshot",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"revert",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("revert",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("commit",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"exportToSpecs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("exportToSpecs",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"exportToDir",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("exportToDir",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromDir",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("importFromDir",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromSpecs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("importFromSpecs",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"importFromResource",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("importFromResource",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("delete",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("deleteCommit",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchConflicts",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchConflicts",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"resolveConflict",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("resolveConflict",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchDiff",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._GET("fetchDiff",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"synchronize",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._POST("synchronize",t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),debug=!1,slashRe=/\//g;function applyExclude(e,t){return!t||("string"==typeof t?!e.url.includes(t):"function"==typeof t?!t(e):!(t instanceof RegExp)||!t.test(e.url))}var StorageDatabase=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,Database),createClass(t,null,[{key:"ensureDB",value:function(e,r){return get$1(t.__proto__||Object.getPrototypeOf(t),"ensureDB",this).call(this,"lively.storage-"+e,r)}}]),t}(),LivelyStorageResource=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"read",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return debug&&console.log("["+this+"] read"),e.next=3,this.db.get(this.pathWithoutQuery());case 3:return t=e.sent,r=t&&t.content,e.abrupt("return",r?"string"==typeof r?r:JSON.stringify(r):"");case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"readJson",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.read();case 2:return t=e.sent,e.abrupt("return","string"==typeof t?JSON.parse(t):t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"write",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(debug&&console.log("["+this+"] write"),t||(t=""),!this.isDirectory()){e.next=4;break}throw new Error("Cannot write into a directory! ("+this.url+")");case 4:return e.next=6,this.db.update(this.pathWithoutQuery(),function(e){if(e&&e.isDirectory)throw new Error(r.url+" already exists and is a directory (cannot write into it!)");var n=Date.now();return e?_extends({},e,{lastModified:n,size:t.length,content:t}):{etag:void 0,type:void 0,contentType:void 0,user:void 0,group:void 0,mode:void 0,lastModified:n,created:n,size:"string"==typeof t?t.length:0,content:t}});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"writeJson",value:function(e){return this.write(e)}},{key:"mkdir",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(debug&&console.log("["+this+"] mkdir"),this.isDirectory()){e.next=3;break}throw new Error("Cannot mkdir a file! ("+this.url+")");case 3:return e.next=5,this.db.get(this.pathWithoutQuery());case 5:if(!(t=e.sent)){e.next=10;break}if(t.isDirectory){e.next=9;break}throw new Error(this.url+" already exists and is a file (cannot mkdir it!)");case 9:return e.abrupt("return",this);case 10:return r=Date.now(),e.next=13,this.db.set(this.pathWithoutQuery(),{etag:void 0,type:void 0,contentType:void 0,user:void 0,group:void 0,mode:void 0,lastModified:r,created:r,isDirectory:!0});case 13:return e.abrupt("return",this);case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(debug&&console.log("["+this+"] exists"),e.t0=this.isRoot(),e.t0){e.next=6;break}return e.next=5,this.db.get(this.pathWithoutQuery());case 5:e.t0=!!e.sent;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return debug&&console.log("["+this+"] remove"),t=this.pathWithoutQuery(),r=this.db,e.next=5,r.docList({startkey:t,endkey:t+""});case 5:return n=e.sent,e.next=8,r.setDocuments(n.map(function(e){return{_id:e.id,_rev:e.rev,_deleted:!0}}));case 8:return e.abrupt("return",this);case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"readProperties",value:function(){return debug&&console.log("["+this+"] readProperties"),this.db.get(this.pathWithoutQuery())}},{key:"dirList",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,i,a,s,c,u,p,f,l=this,d=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(debug&&console.log("["+this+"] dirList"),this.isDirectory()){e.next=3;break}return e.abrupt("return",this.asDirectory().dirList(d,h));case 3:return t=h.exclude,r=this.pathWithoutQuery(),n=[],e.next=8,this.db.getAll({startkey:r,endkey:r+""});case 8:o=e.sent,"infinity"===d&&(d=1/0),i=0;case 11:if(!(i<o.length)){e.next=29;break}if(a=o[i],s=a._id,a.isDirectory,s.startsWith(r)&&r!==s){e.next=15;break}return e.abrupt("continue",26);case 15:if(c=s.slice(r.length),!((c.includes("/")?c.match(slashRe).length+1:1)>d)){e.next=20;break}if("continue"!==function(){var e=l.join(c.split("/").slice(0,d).join("/")+"/");return n.some(function(t){return t.equals(e)})||n.push(e),"continue"}()){e.next=20;break}return e.abrupt("continue",26);case 20:if(u=this.join(c),!t||applyExclude(u,t)){e.next=23;break}return e.abrupt("continue",26);case 23:for(n.push(u),p=["created","lastModified","mode","group","user","contentType","type","etag","size"],{},f=0;f<p.length;f++)u[p[f]]=a[p[f]];case 26:i++,e.next=11;break;case 29:return e.abrupt("return",n);case 30:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"canDealWithJSON",get:function(){return!0}},{key:"db",get:function(){return this._db||(this._db=StorageDatabase.ensureDB(this.host()))}}]),t}(lively_resources.Resource),resourceExtension={name:"lively.storage",matches:function(e){return e.startsWith("lively.storage:")},resourceClass:LivelyStorageResource};lively_resources.registerExtension(resourceExtension),exports.Database=Database,exports.ObjectDB=ObjectDB,exports.ObjectDBInterface=ObjectDBInterface,exports.ObjectDBHTTPInterface=ObjectDBHTTPInterface}(this.lively.storage=this.lively.storage||{},PouchDB,pouchdbAdapterMem,lively.lang,lively.resources)}.call(GLOBAL),"undefined"!=typeof module&&module.exports&&(module.exports=GLOBAL.lively.storage)}();
//LIVELY.GRAPHICS - 60k
!function(){var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;System.global._classRecorder=System.global._classRecorder||{},this.lively=this.lively||{},function(t,e){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n=(function(){function t(t){this.value=t}function e(e){var i,n;function r(i,n){try{var a=e[i](n),o=a.value;o instanceof t?Promise.resolve(o.value).then(function(t){r("next",t)},function(t){r("throw",t)}):s(a.done?"return":"normal",a.value)}catch(t){s("throw",t)}}function s(t,e){switch(t){case"return":i.resolve({value:e,done:!0});break;case"throw":i.reject(e);break;default:i.resolve({value:e,done:!1})}(i=i.next)?r(i.key,i.arg):n=null}this._invoke=function(t,e){return new Promise(function(s,a){var o={key:t,arg:e,resolve:s,reject:a,next:null};n?n=n.next=o:(i=n=o,r(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)});var r={RGB_UPDATED:"RGBUpdated",HSL_UPDATED:"HSLUpdated",HSV_UPDATED:"HSVUpdated",HEX_UPDATED:"HexUpdated",INT_UPDATED:"IntUpdated",UPDATED:"updated"},s={transparent:"rgba(0, 0, 0, 0)",aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370D8",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#D87093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE"},a=function(t){return.5+t<<0},o=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},u=function(t){return l.test(t)?a(2.55*parseInt(t)):t},f=/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i,h=/^hsla?\((\d{1,3}?),\s*(\d{1,3}%),\s*(\d{1,3}%)(,\s*[01]?\.?\d*)?\)$/,c=/^rgba?\((\d{1,3}%?),\s*(\d{1,3}%?),\s*(\d{1,3}%?)(,\s*[01]?\.?\d*)?\)$/,l=/^\d+(\.\d+)*%$/,y=/([0-9a-f])/gi,d=/^#/,v=/^hsla?\((\d{1,3}),\s*(\d{1,3})%,\s*(\d{1,3})%(,\s*([01]?\.?\d*))?\)$/,p=/^rgba?\((\d{1,3}%?),\s*(\d{1,3}%?),\s*(\d{1,3}%?)(,\s*([01]?\.?\d*))?\)$/;function g(t){this._listeners={},this.subscribe(r.RGB_UPDATED,this._RGBUpdated),this.subscribe(r.HEX_UPDATED,this._HEXUpdated),this.subscribe(r.HSL_UPDATED,this._HSLUpdated),this.subscribe(r.HSV_UPDATED,this._HSVUpdated),this.subscribe(r.INT_UPDATED,this._INTUpdated),this.parse(t)}g.prototype._decimal=0,g.prototype._hex="#000000",g.prototype._red=0,g.prototype._green=0,g.prototype._blue=0,g.prototype._hue=0,g.prototype._saturation=0,g.prototype._lightness=0,g.prototype._brightness=0,g.prototype._alpha=1,g.prototype.parse=function(t){if(void 0===t)return this;switch(!0){case isFinite(t):return this.decimal(t),this.output=g.INT,this;case t instanceof g:return this.copy(t),this;default:switch(void 0===t?"undefined":i(t)){case"object":return this.set(t),this;case"string":switch(!0){case s.hasOwnProperty(t):var e=(t=s[t]).replace(d,"");return this.decimal(parseInt(e,16)),this;case f.test(t):return 3==(e=t.replace(d,"")).length&&(e=e.replace(y,"$1$1")),this.decimal(parseInt(e,16)),this;case c.test(t):var n=t.match(p);return this.red(u(n[1])),this.green(u(n[2])),this.blue(u(n[3])),this.alpha(parseFloat(n[5])||1),this.output=(l.test(n[1])?2:1)+(n[5]?2:0),this;case h.test(t):n=t.match(v);return this.hue(parseInt(n[1])),this.saturation(parseInt(n[2])),this.lightness(parseInt(n[3])),this.alpha(parseFloat(n[5])||1),this.output=n[5]?6:5,this}}}return this},g.prototype.clone=function(){return new g(this.decimal())},g.prototype.copy=function(t){return this.set(t.decimal()),this},g.prototype.set=function(t,e){if(1==arguments.length)if("object"==(void 0===t?"undefined":i(t)))for(var n in t)"function"==typeof this[n]&&this[n](t[n]);else isFinite(t)&&this.decimal(t);else"function"==typeof this[t]&&this[t](e);return this},g.prototype.interpolate=function(t,e){return t instanceof g||(t=new g(t)),this._red=a(+this._red+(t._red-this._red)*e),this._green=a(+this._green+(t._green-this._green)*e),this._blue=a(+this._blue+(t._blue-this._blue)*e),this._alpha=a(+this._alpha+(t._alpha-this._alpha)*e),this.broadcast(r.RGB_UPDATED),this.broadcast(r.UPDATED),this},g.prototype._RGB2HSL=function(){var t=this._red/255,e=this._green/255,i=this._blue/255,n=Math.max(t,e,i),r=Math.min(t,e,i),s=(n+r)/2,o=n;if(n==r)return this._hue=0,this._saturation=0,this._lightness=a(100*s),void(this._brightness=a(100*o));var u=n-r,f=u/(s<=.5?n+r:2-n-r),h=(n==t?(e-i)/u+(e<i?6:0):n==e?(i-t)/u+2:(t-e)/u+4)/6;this._hue=a(360*h),this._saturation=a(100*f),this._lightness=a(100*s),this._brightness=a(100*o)},g.prototype._HSL2RGB=function(){var t=this._hue/360,e=this._saturation/100,i=this._lightness/100,n=i<.5?i*(1+e):i+e-i*e,r=2*i-n;this._red=a(255*o(r,n,t+1/3)),this._green=a(255*o(r,n,t)),this._blue=a(255*o(r,n,t-1/3))},g.prototype._HSV2RGB=function(){var t=this._hue/360,e=this._saturation/100,i=this._brightness/100,n=0,r=0,s=0,o=Math.floor(6*t),u=6*t-o,f=i*(1-e),h=i*(1-u*e),c=i*(1-(1-u)*e);switch(o%6){case 0:n=i,r=c,s=f;break;case 1:n=h,r=i,s=f;break;case 2:n=f,r=i,s=c;break;case 3:n=f,r=h,s=i;break;case 4:n=c,r=f,s=i;break;case 5:n=i,r=f,s=h}this._red=a(255*n),this._green=a(255*r),this._blue=a(255*s)},g.prototype._INT2HEX=function(){var t=this._decimal.toString(16);t="000000".substr(0,6-t.length)+t,this._hex="#"+t.toUpperCase()},g.prototype._INT2RGB=function(){this._red=this._decimal>>16,this._green=this._decimal>>8&255,this._blue=255&this._decimal},g.prototype._HEX2INT=function(){this._decimal=parseInt(this._hex,16)},g.prototype._RGB2INT=function(){this._decimal=this._red<<16|this._green<<8&65535|this._blue},g.prototype._RGBUpdated=function(){this._RGB2INT(),this._RGB2HSL(),this._INT2HEX()},g.prototype._HSLUpdated=function(){this._HSL2RGB(),this._RGB2INT(),this._INT2HEX()},g.prototype._HSVUpdated=function(){this._HSV2RGB(),this._RGB2INT(),this._INT2HEX()},g.prototype._HEXUpdated=function(){this._HEX2INT(),this._INT2RGB(),this._RGB2HSL()},g.prototype._INTUpdated=function(){this._INT2RGB(),this._RGB2HSL(),this._INT2HEX()},g.prototype._broadcastUpdate=function(){this.broadcast(Event.UPDATED)},g.prototype.decimal=function(t){return this._handle("_decimal",t,r.INT_UPDATED)},g.prototype.hex=function(t){return this._handle("_hex",t,r.HEX_UPDATED)},g.prototype.red=function(t){return this._handle("_red",t,r.RGB_UPDATED)},g.prototype.green=function(t){return this._handle("_green",t,r.RGB_UPDATED)},g.prototype.blue=function(t){return this._handle("_blue",t,r.RGB_UPDATED)},g.prototype.hue=function(t){return this._handle("_hue",t,r.HSL_UPDATED)},g.prototype.saturation=function(t){return this._handle("_saturation",t,r.HSL_UPDATED)},g.prototype.lightness=function(t){return this._handle("_lightness",t,r.HSL_UPDATED)},g.prototype.brightness=function(t){return this._handle("_brightness",t,r.HSV_UPDATED)},g.prototype.alpha=function(t){return this._handle("_alpha",t)},g.prototype._handle=function(t,e,i){return void 0!==this[t]&&void 0!==e&&(e!=this[t]&&(this[t]=e,i&&this.broadcast(i)),this.broadcast(Event.UPDATED)),this[t]},g.prototype.getHex=function(){return this._hex},g.prototype.getRGB=function(){return"rgb("+[a(this._red),a(this._green),a(this._blue)].join(", ")+")"},g.prototype.getPRGB=function(){return"rgb("+[a(100*this._red/255)+"%",a(100*this._green/255)+"%",a(100*this._blue/255)+"%"].join(", ")+")"},g.prototype.getRGBA=function(){return"rgba("+[a(this._red),a(this._green),a(this._blue),this._alpha].join(", ")+")"},g.prototype.getPRGBA=function(){return"rgba("+[a(100*this._red/255)+"%",a(100*this._green/255)+"%",a(100*this._blue/255)+"%",this._alpha].join(", ")+")"},g.prototype.getHSL=function(){return"hsl("+[a(this._hue),a(this._saturation)+"%",a(this._lightness)+"%"].join(", ")+")"},g.prototype.getHSLA=function(){return"hsla("+[a(this._hue),a(this._saturation)+"%",a(this._lightness)+"%",this._alpha].join(", ")+")"},g.prototype.format=function(t){var e={r:this._red,g:this._green,b:this._blue,h:this._hue,s:this._saturation,l:this._lightness,v:this._brightness,a:this._alpha,x:this._hex,d:this._decimal};for(var i in e)t=t.split("%"+i+"%").join(e[i]);return t},g.prototype.output=0,g.HEX=0,g.RGB=1,g.PRGB=2,g.RGBA=3,g.PRGBA=4,g.HSL=5,g.HSLA=6,g.INT=7,g.prototype.toString=function(){switch(this.output){case 0:return this.getHex();case 1:return this.getRGB();case 2:return this.getPRGB();case 3:return this.getRGBA();case 4:return this.getPRGBA();case 5:return this.getHSL();case 6:return this.getHSLA();case 7:return this._decimal}return this.getHex()},g.prototype._listeners=null,g.prototype._isSubscribed=function(t){return null!=this._listeners[t]},g.prototype.subscribe=function(t,e){this._isSubscribed(t)||(this._listeners[t]=[]),this._listeners[t].push(e)},g.prototype.unsubscribe=function(t,e){if(this._isSubscribed(t))for(var i=this._listeners[t],n=0,r=i.length;n<r;n++)if(i[n]===e)return i.splice(n,1),this.unsubscribe(t,e)},g.prototype.broadcast=function(t,e){if(this._isSubscribed(t))for(var i=this._listeners[t],n=i.length,r=0;r<n;r++)i[r].apply(this,e)},g.prototype.tween=function(t,e){e instanceof g||(e=new g(e));var i=+new Date,n=this;this.broadcast("tweenStart");var r=setInterval(function(){var s=+new Date-i,a=Math.min(1,s/t);n.interpolate(e,a),n.broadcast("tweenProgress"),1==a&&(clearInterval(r),n.broadcast("tweenComplete"))},20);return r},g.prototype.bind=function(t,e){var i=this;this.subscribe("updated",function(){t[e]=i.toString()})},g.random=function(){return new g(a(16777215*Math.random()))},g.bind=function(t,e){var i=new g(t[e]);return i.bind(t,e),i};var b,m,k,x="16px";if(System.get("@system-env").browser)try{var w=_(16)(window.getComputedStyle(document.body).fontSize);w&&"NaN"!==w.slice(0,3)&&(x=w)}catch(t){}function m(t){return b(t)[1]}function k(t){return b(t)[0]}function _(t){return null==t&&(t=t),function(e,i,n,r){var s,a,o;if(null==n&&(n=t),null==r&&(r=n),(s=m(e))===i)return e;if(o=k(e),"px"!==m(n)&&console.warn("Parameter fromContext must resolve to a value in pixel units."),"px"!==m(r)&&console.warn("Parameter toContext must resolve to a value in pixel units."),"px"!==s)if("em"===s)o=k(e)*k(n);else if("rem"===s)o=k(e)*k(t);else{if("ex"!==s)return"ch"===s||"vw"===s||"vh"===s||"vmin"===s?(console.warn(s+" units can't be reliably converted; Returning original value."),e):(console.warn(s+" is an unknown or unsupported length unit; Returning original value."),e);o=k(e)*k(n)*2}if(a=o,"px"!==i)if("em"===i)a=o/k(r);else if("rem"===i)a=o/k(t);else{if("ex"!==i)return"ch"===i||"vw"===i||"vh"===i||"vmin"===i?(console.warn(i+" units can't be reliably converted; Returning original value."),e):(console.warn(i+" is an unknown or unsupported length unit; Returning original value."),e);a=o/k(r)/2}return parseFloat(a.toFixed(5))+i}}var F=_(x);function S(t){return Number(F(t,"px").slice(0,-2))}var T,C,D,R=(T=void 0,C=_classRecorder,D=C.hasOwnProperty("Point")&&"function"==typeof C.Point?C.Point:C.Point=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)},lively.classes.runtime.initializeClass(D,T,[{key:Symbol.for("lively-instance-initialize"),value:function(t,e){this.x=t||0,this.y=e||0}},{key:"isPoint",get:function(){return!0}},{key:"getX",value:function(){return this.x}},{key:"getY",value:function(){return this.y}},{key:"toFixed",value:function(t){return new R(this.x.toFixed(t),this.y.toFixed(t))}},{key:"addPt",value:function(t){return new R(this.x+t.x,this.y+t.y)}},{key:"addXY",value:function(t,e){return new R(this.x+t,this.y+e)}},{key:"midPt",value:function(t){return new R((this.x+t.x)/2,(this.y+t.y)/2)}},{key:"subPt",value:function(t){return new R(this.x-t.x,this.y-t.y)}},{key:"subXY",value:function(t,e){return new R(this.x-t,this.y-e)}},{key:"scaleBy",value:function(t,e){return new R(this.x*t,this.y*(e||t))}},{key:"scaleByPt",value:function(t){return new R(this.x*t.x,this.y*t.y)}},{key:"negated",value:function(){return new R(-this.x,-this.y)}},{key:"inverted",value:function(){return new R(1/this.x,1/this.y)}},{key:"invertedSafely",value:function(){return new R(this.x&&1/this.x,this.y&&1/this.y)}},{key:"lessPt",value:function(t){return this.x<t.x&&this.y<t.y}},{key:"leqPt",value:function(t){return this.x<=t.x&&this.y<=t.y}},{key:"eqPt",value:function(t){return this.x==t.x&&this.y==t.y}},{key:"equals",value:function(t){return this.x==t.x&&this.y==t.y}},{key:"withX",value:function(t){return G(t,this.y)}},{key:"withY",value:function(t){return G(this.x,t)}},{key:"copy",value:function(){return new R(this.x,this.y)}},{key:"minPt",value:function(t,e){return e||(e=new R(0,0)),e.x=Math.min(this.x,t.x),e.y=Math.min(this.y,t.y),e}},{key:"maxPt",value:function(t,e){return e||(e=new R(0,0)),e.x=Math.max(this.x,t.x),e.y=Math.max(this.y,t.y),e}},{key:"random",value:function(){return R.random(this)}},{key:"normalized",value:function(){var t=this.r();return G(this.x/t,this.y/t)}},{key:"fastNormalized",value:function(){var t=this.fastR();return G(this.x/t,this.y/t)}},{key:"dotProduct",value:function(t){return this.x*t.x+this.y*t.y}},{key:"matrixTransform",value:function(t,e){var i=t.a*this.x+t.c*this.y+t.e,n=t.b*this.x+t.d*this.y+t.f;return e?Object.assign(e,{x:i,y:n}):G(i,n)}},{key:"matrixTransformDirection",value:function(t,e){var i=t.a*this.x+t.c*this.y,n=t.b*this.x+t.d*this.y;return e?Object.assign(e,{x:i,y:n}):G(i,n)}},{key:"griddedBy",value:function(t){return G(this.x-this.x%t.x,this.y-this.y%t.y)}},{key:"roundTo",value:function(t){return new R(e.num.roundTo(this.x,t),e.num.roundTo(this.y,t))}},{key:"dist",value:function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}},{key:"distSquared",value:function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i}},{key:"nearestPointOnLineBetween",value:function(t,e){if(t.x==e.x)return G(t.x,this.y);if(t.y==e.y)return G(this.x,t.y);var i=t.x,n=t.y,r=e.x-i,s=e.y-n,a=((this.y-n)/r+(this.x-i)/s)/(r/s+s/r);return G(i+a*r,n+a*s)}},{key:"interpolate",value:function(t,i){return R.polar(e.num.interpolate(t,this.r(),i.r()),e.num.interpolate(t,this.theta(),i.theta()))}},{key:"r",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"fastR",value:function(){for(var t=this.x*this.x+this.y*this.y,e=17,i=0;i<6;i++)e=(e+t/e)/2;return e}},{key:"theta",value:function(){return Math.atan2(this.y,this.x)}},{key:"asRectangle",value:function(){return new A(this.x,this.y,0,0)}},{key:"extent",value:function(t){return new A(this.x,this.y,t.x,t.y)}},{key:"extentAsRectangle",value:function(){return new A(0,0,this.x,this.y)}},{key:"lineTo",value:function(t){return new B(this,t)}},{key:"toTuple",value:function(){return[this.x,this.y]}},{key:"toLiteral",value:function(){return{x:this.x,y:this.y}}},{key:"toString",value:function(){return arguments.length>0&&void 0!==arguments[0]&&!arguments[0]?e.string.format("pt(%10.d,%10.d)",this.x,this.y):e.string.format("pt(%1.f,%1.f)",this.x,this.y)}},{key:"inspect",value:function(){return JSON.stringify(this)}},{key:"__serialize__",value:function(){return{__expr__:this.toString(!1),bindings:{"lively.graphics/geometry-2d.js":["pt"]}}}}],[{key:"ensure",value:function(t){return t instanceof R?t:new R(t.x,t.y)}},{key:"polar",value:function(t,e){return new R(t*Math.cos(e),t*Math.sin(e))}},{key:"random",value:function(t){return new R(e.num.randomSmallerInteger(t.x),e.num.randomSmallerInteger(t.y))}},{key:"fromLiteral",value:function(t){return G(t.x,t.y)}},{key:"fromTuple",value:function(t){return G(t[0],t[1])}}],C,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:118,end:6710})),A=function(t){var i=_classRecorder,n=i.hasOwnProperty("Rectangle")&&"function"==typeof i.Rectangle?i.Rectangle:i.Rectangle=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:"corners",get:function(){return["topLeft","topRight","bottomRight","bottomLeft"]}},{key:"sides",get:function(){return["leftCenter","rightCenter","topCenter","bottomCenter"]}},{key:Symbol.for("lively-instance-initialize"),value:function(t,e,i,n){this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0}},{key:"isRectangle",get:function(){return!0}},{key:"getX",value:function(){return this.x}},{key:"getY",value:function(){return this.y}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"copy",value:function(){return new A(this.x,this.y,this.width,this.height)}},{key:"toFixed",value:function(t){return new A(this.x.toFixed(t),this.y.toFixed(t),this.width.toFixed(t),this.height.toFixed(t))}},{key:"withWidth",value:function(t){return new A(this.x,this.y,t,this.height)}},{key:"withHeight",value:function(t){return new A(this.x,this.y,this.width,t)}},{key:"withX",value:function(t){return new A(t,this.y,this.width,this.height)}},{key:"withY",value:function(t){return new A(this.x,t,this.width,this.height)}},{key:"withExtent",value:function(t){return new A(this.x,this.y,t.x,t.y)}},{key:"withTopLeft",value:function(t){return A.fromAny(t,this.bottomRight())}},{key:"withTopRight",value:function(t){return A.fromAny(this.bottomLeft(),t)}},{key:"withBottomRight",value:function(t){return A.fromAny(t,this.topLeft())}},{key:"withBottomLeft",value:function(t){return A.fromAny(t,this.topRight())}},{key:"withLeftCenter",value:function(t){return new A(t.x,this.y,this.width+(this.x-t.x),this.height)}},{key:"withRightCenter",value:function(t){return new A(this.x,this.y,t.x-this.x,this.height)}},{key:"withTopCenter",value:function(t){return new A(this.x,t.y,this.width,this.height+(this.y-t.y))}},{key:"withBottomCenter",value:function(t){return new A(this.x,this.y,this.width,t.y-this.y)}},{key:"withCenter",value:function(t){return new A(t.x-this.width/2,t.y-this.height/2,this.width,this.height)}},{key:"insetBy",value:function(t){return new A(this.x+t,this.y+t,this.width-2*t,this.height-2*t)}},{key:"insetByPt",value:function(t){return new A(this.x+t.x,this.y+t.y,this.width-2*t.x,this.height-2*t.y)}},{key:"grid",value:function(t,i){var n=this.width/i,r=this.height/t;return e.grid.mapCreate(t,i,function(t,e){return new A(n*e,r*t,n,r)})}},{key:"divide",value:function(t){var e=this;return t.map(function(t){return E(e.x+e.width*t.x,e.y+e.height*t.y,e.width*t.width,e.height*t.height)})}},{key:"toTuple",value:function(){return[this.x,this.y,this.width,this.height]}},{key:"lineTo",value:function(t){var e=this.center(),i=t.center(),n=e.lineTo(i),r=this.lineIntersection(n)[0],s=t.lineIntersection(n)[0];return r&&s&&r.lineTo(s)}},{key:"equals",value:function(t){return!!t&&(this.x==t.x&&this.y==t.y&&this.width==t.width&&this.height==t.height)}},{key:"inspect",value:function(){return JSON.stringify(this)}},{key:"topLeft",value:function(){return new R(this.x,this.y)}},{key:"topRight",value:function(){return new R(this.maxX(),this.y)}},{key:"bottomRight",value:function(){return new R(this.maxX(),this.maxY())}},{key:"bottomLeft",value:function(){return new R(this.x,this.maxY())}},{key:"leftCenter",value:function(){return new R(this.x,this.center().y)}},{key:"rightCenter",value:function(){return new R(this.maxX(),this.center().y)}},{key:"topCenter",value:function(){return new R(this.center().x,this.y)}},{key:"bottomCenter",value:function(){return new R(this.center().x,this.maxY())}},{key:"extent",value:function(){return new R(this.width,this.height)}},{key:"center",value:function(){return new R(this.x+this.width/2,this.y+this.height/2)}},{key:"topEdge",value:function(){return new B(this.topLeft(),this.topRight())}},{key:"bottomEdge",value:function(){return new B(this.bottomLeft(),this.bottomRight())}},{key:"leftEdge",value:function(){return new B(this.topLeft(),this.bottomLeft())}},{key:"rightEdge",value:function(){return new B(this.topRight(),this.bottomRight())}},{key:"edges",value:function(){return[this.topEdge(),this.rightEdge(),this.bottomEdge(),this.leftEdge()]}},{key:"allPoints",value:function(){for(var t=this.x,e=this.y,i=this.width,n=this.height,r=[],s=e;s<e+n;s++)for(var a=t;a<t+i;a++)r.push(G(a,s));return r}},{key:"isNonEmpty",value:function(t){return this.width>0&&this.height>0}},{key:"containsRect",value:function(t){return this.x<=t.x&&this.y<=t.y&&t.maxX()<=this.maxX()&&t.maxY()<=this.maxY()}},{key:"intersects",value:function(t){return this.intersection(t).isNonEmpty()}},{key:"containsPoint",value:function(t){return this.x<=t.x&&t.x<=this.x+this.width&&this.y<=t.y&&t.y<=this.y+this.height}},{key:"translatedBy",value:function(t){return new A(this.x+t.x,this.y+t.y,this.width,this.height)}},{key:"scaleByRect",value:function(t){return new A(this.x+t.x*this.width,this.y+t.y*this.height,t.width*this.width,t.height*this.height)}},{key:"scaleRectIn",value:function(t){return new A((this.x-t.x)/t.width,(this.y-t.y)/t.height,this.width/t.width,this.height/t.height)}},{key:"scaleRectTo",value:function(t){var e,i,n;return this.width>this.height?i=this.width:e=this.height,n=i?t.width/i:t.height/e,this.withExtent(this.extent().scaleBy(n)).withCenter(this.center())}},{key:"expandBy",value:function(t){return this.insetBy(0-t)}},{key:"translateForInclusion",value:function(t){var e=t.x,i=t.y,n=e+t.width,r=i+t.height;return n>this.right()&&(e-=n-this.right()),r>this.bottom()&&(i-=r-this.bottom()),e<this.x&&(e=this.x),i<this.y&&(i=this.y),E(e,i,t.width,t.height)}},{key:"transformRectForInclusion",value:function(t){var e=this.topLeft().maxPt(t.topLeft()),i=e.addPt(t.extent());return E(e,this.bottomRight().minPt(i))}},{key:"insetByRect",value:function(t){return new A(this.x+t.left(),this.y+t.top(),this.width-(t.left()+t.right()),this.height-(t.top()+t.bottom()))}},{key:"outsetByRect",value:function(t){return new A(this.x-t.left(),this.y-t.top(),this.width+(t.left()+t.right()),this.height+(t.top()+t.bottom()))}},{key:"interpolate",value:function(t,e){var i=this.topLeft(),n=this.bottomRight(),r=e.topLeft(),s=e.bottomRight();return A.fromAny(i.interpolate(t,r),n.interpolate(t,s))}},{key:"intersection",value:function(t){var e=Math.max(this.x,t.x),i=Math.max(this.y,t.y),n=Math.min(this.x+this.width,t.x+t.width)-e,r=Math.min(this.y+this.height,t.y+t.height)-i;return new A(e,i,n,r)}},{key:"union",value:function(t){return E(this.topLeft().minPt(t.topLeft()),this.bottomRight().maxPt(t.bottomRight()))}},{key:"lineIntersection",value:function(t){return this.edges().map(function(e){return e.intersection(t)}).filter(function(t){return!!t})}},{key:"dist",value:function(t){var e=this.closestPointToPt(t.center()),i=t.closestPointToPt(e);return e.dist(i)}},{key:"relativeToAbsPoint",value:function(t){return new R(this.x+this.width*t.x,this.y+this.height*t.y)}},{key:"closestPointToPt",value:function(t){return G(Math.min(Math.max(this.x,t.x),this.maxX()),Math.min(Math.max(this.y,t.y),this.maxY()))}},{key:"maxX",value:function(){return this.x+this.width}},{key:"maxY",value:function(){return this.y+this.height}},{key:"realWidth",value:function(){return this.x<0?-this.x+this.width:this.width}},{key:"realHeight",value:function(){return this.y<0?-this.y+this.height:this.height}},{key:"area",value:function(){var t=this.width*this.height;return(this.width<0&&this.height<0?-1:1)*t}},{key:"randomPoint",value:function(){return R.random(G(this.width,this.height)).addPt(this.topLeft())}},{key:"constrainPt",value:function(t){return t.maxPt(this.topLeft()).minPt(this.bottomRight())}},{key:"left",value:function(){return this.x}},{key:"right",value:function(){return this.maxX()}},{key:"top",value:function(){return this.y}},{key:"bottom",value:function(){return this.maxY()}},{key:"toInsetTuple",value:function(){return[this.left(),this.top(),this.right(),this.bottom()]}},{key:"toAttributeValue",value:function(t){var e=[this.left()];return this.top()===this.bottom()&&this.left()===this.right()?this.top()===this.left()&&e.push(this.top()):e=e.concat([this.top(),this.right(),this.bottom()]),e.invoke("roundTo",.01)}},{key:"toLiteral",value:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}}},{key:"partNamed",value:function(t){return this[t].call(this)}},{key:"withPartNamed",value:function(t,e){return this[this.setterName(t)].call(this,e)}},{key:"setterName",value:function(t){return"with"+t[0].toUpperCase()+t.slice(1)}},{key:"partNameNear",value:function(t,e,i){var n=this.partNameNearest(t,e);return e.dist(this.partNamed(n))<i?n:null}},{key:"partNameNearest",value:function(t,e){for(var i=1e99,n=t[0],r=0;r<t.length;r++){n=t[r];var s=e.dist(this.partNamed(n));if(s<i){var a=n;i=s}}return a}},{key:"toString",value:function(){return e.string.format("rect(%s,%s,%s,%s)",this.x,this.y,this.width,this.height)}},{key:"__serialize__",value:function(){return{__expr__:this.toString(),bindings:{"lively.graphics/geometry-2d.js":["rect"]}}}}],[{key:"fromAny",value:function(t,e){return E(t.minPt(e),t.maxPt(e))}},{key:"fromLiteral",value:function(t){return new A(t.x,t.y,t.width,t.height)}},{key:"fromTuple",value:function(t){return new A(t[0],t[1],t[2],t[3])}},{key:"unionPts",value:function(t){for(var e=t[0],i=t[0],n=1;n<t.length;n++)e=e.minPt(t[n]),i=i.maxPt(t[n]);return E(e,i)}},{key:"ensure",value:function(t){return t instanceof A?t:new A(t.x,t.y,t.width,t.height)}},{key:"fromElement",value:function(t){if("function"==typeof t.getBoundingClientRect){var e=t.getBoundingClientRect();return E(e.left,e.top,e.width,e.height)}if("http://www.w3.org/1999/xhtml"==t.namespaceURI){var i=S(t.style.left||"0px"),n=S(t.style.top||"0px"),r=S(t.style.width||"0px"),s=S(t.style.hieght||"0px");return new A(i,n,r,s)}if("http://www.w3.org/2000/svg"==t.namespaceURI)return new A(t.x.baseVal.value,t.y.baseVal.value,t.width.baseVal.value,t.height.baseVal.value);throw new Error("Cannot create Rectangle from "+t)}},{key:"inset",value:function(t,e,i,n){return void 0===e&&(e=t),void 0===i&&(i=t),void 0===n&&(n=e),new A(t,e,i-t,n-e)}}],i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:6720,end:21844})}(void 0),P=function(t){var i=_classRecorder,n=i.hasOwnProperty("Transform")&&"function"==typeof i.Transform?i.Transform:i.Transform=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:"exp",get:function(){return 1e-4}},{key:Symbol.for("lively-instance-initialize"),value:function(t,e,i){if(t)if(t instanceof R){var n=t,r=e||0;void 0===(i=i)&&(i=G(1,1)),this.a=this.ensureNumber(i.x*Math.cos(r)),this.b=this.ensureNumber(i.y*Math.sin(r)),this.c=this.ensureNumber(i.x*-Math.sin(r)),this.d=this.ensureNumber(i.y*Math.cos(r)),this.e=this.ensureNumber(n.x),this.f=this.ensureNumber(n.y),this.a>1&&(this.a=Math.round(this.a*Math.pow(10,2))/Math.pow(10,2)),this.d>1&&(this.d=Math.round(this.d*Math.pow(10,2))/Math.pow(10,2))}else this.fromMatrix(t);else this.a=this.d=1,this.b=this.c=this.e=this.f=0}},{key:"isTransform",get:function(){return!0}},{key:"copy",value:function(){return new P(this)}},{key:"fromMatrix",value:function(t){this.a=this.ensureNumber(t.a),this.b=this.ensureNumber(t.b),this.c=this.ensureNumber(t.c),this.d=this.ensureNumber(t.d),this.e=this.ensureNumber(t.e),this.f=this.ensureNumber(t.f)}},{key:"getRotation",value:function(){var t=e.num.toDegrees(Math.atan2(-this.c,this.a));return Math.abs(t)<this.eps?0:t}},{key:"getScale",value:function(){var t=this.a,e=this.c,i=Math.sqrt(t*t+e*e);return Math.abs(i-1)<this.eps?1:i}},{key:"getScalePoint",value:function(){var t=this.a,e=this.b,i=this.c,n=this.d,r=Math.sqrt(t*t+i*i),s=Math.atan2(-i,t);return G(r,Math.abs(e)>Math.abs(n)?e/Math.sin(s):n/Math.cos(s))}},{key:"getTranslation",value:function(){return G(this.e,this.f)}},{key:"isTranslation",value:function(){return 1==this.a&&0==this.b&&0==this.c&&1==this.d}},{key:"toSVGAttributeValue",value:function(){var t=this.getTranslation(),e="translate("+t.x+","+t.y+")",i=this.getRotation(),n=this.getScalePoint();return 0!=i&&(e+=" rotate("+this.getRotation()+")"),1==n.x&&1==n.y||(e+=" scale("+n.x+","+n.y+")"),e}},{key:"toCSSValue",value:function(t){var e="",i=this.getTranslation();if(e+="translate("+i.x.toFixed(2)+"px,"+i.y.toFixed(2)+"px)",t){var n=t.width/2,r=t.height/2;e+=" translate("+n.toFixed(2)+"px,"+r.toFixed(2)+"px)"}if(0!=this.getRotation()&&(e+=" rotate("+this.getRotation().toFixed(2)+"deg)"),t){n=t.width/2,r=t.height/2;e+=" translate("+(-1*n).toFixed(2)+"px,"+(-1*r).toFixed(2)+"px)"}var s=this.getScalePoint();return 1==s.x&&1==s.y||(e+=" scale("+s.x.toFixed(2)+","+s.y.toFixed(2)+")"),e}},{key:"toCSSTransformString",value:function(){var t=this.getRotation(),e=this.getScale();return"translate("+this.e+"px,"+this.f+"px) rotate("+t+"deg) scale("+e+","+e+")"}},{key:"toString",value:function(){return this.toCSSTransformString()}},{key:"toMatrix",value:function(){return this.copy()}},{key:"transformPoint",value:function(t,e){return t.matrixTransform(this,e)}},{key:"transformDirection",value:function(t,e){return t.matrixTransformDirection(this,e)}},{key:"matrixTransformForMinMax",value:function(t,e,i){var n=this.a*t.x+this.c*t.y+this.e,r=this.b*t.x+this.d*t.y+this.f;n>i.x&&(i.x=n),r>i.y&&(i.y=r),n<e.x&&(e.x=n),r<e.y&&(e.y=r)}},{key:"transformRectToRect",value:function(t){var e=G(1/0,1/0),i=G(-1/0,-1/0);return this.matrixTransformForMinMax(t.topLeft(),e,i),this.matrixTransformForMinMax(t.bottomRight(),e,i),this.isTranslation()||(this.matrixTransformForMinMax(t.topRight(),e,i),this.matrixTransformForMinMax(t.bottomLeft(),e,i)),E(e,i)}},{key:"preConcatenate",value:function(t){var e=this.matrix_||this.toMatrix();return this.a=t.a*e.a+t.c*e.b,this.b=t.b*e.a+t.d*e.b,this.c=t.a*e.c+t.c*e.d,this.d=t.b*e.c+t.d*e.d,this.e=t.a*e.e+t.c*e.f+t.e,this.f=t.b*e.e+t.d*e.f+t.f,this.matrix_=this.toMatrix(),this}},{key:"invert",value:function(){var t=this.copy(),e=1/(t.a*t.d-t.c*t.b);return this.a=t.d*e,this.b=-t.b*e,this.c=-t.c*e,this.d=t.a*e,this.e=(t.c*t.f-t.e*t.d)*e,this.f=-(t.a*t.f-t.b*t.e)*e,this}},{key:"inverse",value:function(){var t=this.matrix_||this.toMatrix(),e=new this.constructor(t);return e.invert(),e}},{key:"ensureNumber",value:function(t){if(isNaN(t))throw new Error("not a number");return t}},{key:"__serialize__",value:function(){return{__expr__:"new Transform({a: "+this.a+", b: "+this.b+", c: "+this.c+", d: "+this.d+", e: "+this.e+", f: "+this.f+"})",bindings:{"lively.graphics/geometry-2d.js":["Transform"]}}}}],void 0,i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:21854,end:29489})}(void 0),B=function(t){var i=_classRecorder,n=i.hasOwnProperty("Line")&&"function"==typeof i.Line?i.Line:i.Line=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:Symbol.for("lively-instance-initialize"),value:function(t,e){this.start=t,this.end=e}},{key:"isLine",get:function(){return!0}},{key:"withStart",value:function(t){return new B(t,this.end)}},{key:"withEnd",value:function(t){return new B(this.start,t)}},{key:"sampleN",value:function(t){t=t||10;for(var e=this.end.subPt(this.start).scaleBy(1/t),i=[],n=0;n<=t;n++)i.push(this.start.addPt(e.scaleBy(n)));return i}},{key:"sample",value:function(t){return this.sampleN(this.length()/t)}},{key:"length",value:function(){return this.start.dist(this.end)}},{key:"equals",value:function(t){return!!t&&(this.start.eqPt(t.start)&&this.end.eqPt(t.end))}},{key:"includesPoint",value:function(t,e){var i=this.start.x,n=this.start.y,r=this.end.x,s=this.end.y,a=t.x,o=t.y,u=(r-i)*(o-n)-(a-i)*(s-n)==0;if(e||!u)return u;var f=Math.min(i,r),h=Math.min(n,s),c=Math.max(i,r),l=Math.max(n,s);return f<=a&&a<=c&&h<=o&&o<=l}},{key:"intersection",value:function(t,i){var n=this.start,r=this.end,s=t.start,a=t.end,o=n.x,u=n.y,f=r.x,h=r.y,c=s.x,l=s.y,y=a.x,d=a.y,v=((o*h-u*f)*(c-y)-(o-f)*(c*d-l*y))/((o-f)*(l-d)-(u-h)*(c-y)),p=((o*h-u*f)*(l-d)-(u-h)*(c*d-l*y))/((o-f)*(l-d)-(u-h)*(c-y));return v===1/0||p===1/0?null:i||e.num.between(v,o,f,1e-4)&&e.num.between(p,u,h,1e-4)&&e.num.between(v,c,y,1e-4)&&e.num.between(p,l,d,1e-4)?G(v,p):null}},{key:"perpendicularLine",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"cc",n=this.start,r=this.toVector(),s=n.addPt(r.scaleBy(t)),a=r.theta()+("cc"===i?-1:1)*Math.PI/2;return new B(s,s.addPt(R.polar(e,a)))}},{key:"toVector",value:function(){var t=this.start;return this.end.subPt(t)}},{key:"toString",value:function(){return e.string.format("Line((%s,%s), (%s,%s))",this.start.x,this.start.y,this.end.x,this.end.y)}},{key:"__serialize__",value:function(){return{__expr__:"Line.fromCoords("+this.start.x+", "+this.start.y+", "+this.end.x+", "+this.end.y+")",bindings:{"lively.graphics/geometry-2d.js":["Line"]}}}}],[{key:"fromCoords",value:function(t,e,i,n){return new B(G(t,e),G(i,n))}}],i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:29498,end:33793})}(void 0);function E(t,e,i,n){var r,s,a,o;return"number"==typeof t?(r=t,s=e,a=i,o=n):(r=t.x,s=t.y,a=e.x-r,o=e.y-s),new A(r,s,a,o)}function G(t,e){return new R(t,e)}function L(t){return Math.floor(255.99*t)}var M=new RegExp("\\s*rgba?\\s*\\(\\s*(\\d+)(%?)\\s*,\\s*(\\d+)(%?)\\s*,\\s*(\\d+)(%?)\\s*(?:,\\s*([0-9\\.]+)\\s*)?\\)\\s*");function H(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.arr.last;return[].concat(n(t),n(new Array(Math.max(i-t.length,0)).fill(r(t))))}var I=function(t){var i=_classRecorder,n=i.hasOwnProperty("ColorHarmony")&&"function"==typeof i.ColorHarmony?i.ColorHarmony:i.ColorHarmony=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:"offsets",value:function(){return null}},{key:"stepCount",value:function(){return 0}},{key:"stepSize",value:function(){return 0}},{key:"name",get:function(){return"Color Harmony"}},{key:"chord",value:function(t){var i=this,n=t.hue,r=t.saturation,s=t.brightness;return(this.offsets()||e.arr.range(0,this.steps()).map(function(t){return t*i.stepSize()})).map(function(t){return q.hsb(n+t%360,r,s)})}}],void 0,i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:558,end:947})}(void 0),N=function(t){var e=_classRecorder,i=e.hasOwnProperty("Complementary")&&"function"==typeof e.Complementary?e.Complementary:e.Complementary=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Complement"}},{key:"steps",value:function(){return 1}},{key:"stepSize",value:function(){return 180}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:956,end:1093})}({referencedAs:"ColorHarmony",value:I}),z=function(t){var e=_classRecorder,i=e.hasOwnProperty("Triadic")&&"function"==typeof e.Triadic?e.Triadic:e.Triadic=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Triadic"}},{key:"steps",value:function(){return 2}},{key:"stepSize",value:function(){return 120}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1102,end:1227})}({referencedAs:"ColorHarmony",value:I}),U=function(t){var e=_classRecorder,i=e.hasOwnProperty("Tetradic")&&"function"==typeof e.Tetradic?e.Tetradic:e.Tetradic=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Tetradic"}},{key:"offsets",value:function(){return[0,60,180,240]}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1236,end:1353})}({referencedAs:"ColorHarmony",value:I}),j=function(t){var e=_classRecorder,i=e.hasOwnProperty("Quadratic")&&"function"==typeof e.Quadratic?e.Quadratic:e.Quadratic=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Quadratic"}},{key:"steps",value:function(){return 3}},{key:"stepSize",value:function(){return 90}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1362,end:1490})}({referencedAs:"ColorHarmony",value:I}),O=function(t){var e=_classRecorder,i=e.hasOwnProperty("Analogous")&&"function"==typeof e.Analogous?e.Analogous:e.Analogous=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Analogous"}},{key:"steps",value:function(){return 5}},{key:"offsets",value:function(){return[-60,-30,0,30,60]}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1499,end:1645})}({referencedAs:"ColorHarmony",value:I}),X=function(t){var e=_classRecorder,i=e.hasOwnProperty("Neutral")&&"function"==typeof e.Neutral?e.Neutral:e.Neutral=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:"name",get:function(){return"Neutral"}},{key:"offsets",value:function(){return[-30,-15,0,15,30]}}],void 0,e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1654,end:1773})}({referencedAs:"ColorHarmony",value:I}),q=function(t){var i=_classRecorder,n=i.hasOwnProperty("Color")&&"function"==typeof i.Color?i.Color:i.Color=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:"isColor",get:function(){return!0}},{key:Symbol.for("lively-instance-initialize"),value:function(t,e,i,n){this.r=t||0,this.g=e||0,this.b=i||0,this.a=n||(0===n?0:1)}},{key:"grayValue",value:function(){return(this.r+this.g+this.b)/3}},{key:"equals",value:function(t){return!!t&&(this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a)}},{key:"darker",value:function(t){var e=this.mixedWith(q.black,.5);return t>1?e.darker(t-1):e}},{key:"lighter",value:function(t){if(0==t)return this;var e=this.mixedWith(q.white,.5);return t>1?e.lighter(t-1):e}},{key:"interpolate",value:function(t,i){return i.isGradient?i.interpolate(1-t,this):(i=e.obj.isArray(i)?i:i.toTuple(),q.fromTuple(this.toTuple().map(function(n,r){return e.num.interpolate(t,n,i[r])})))}},{key:"toString",value:function(){return 1===this.a?"rgb("+L(this.r)+","+L(this.g)+","+L(this.b)+")":this.toRGBAString()}},{key:"toRGBAString",value:function(){function t(t){return Math.floor(255.99*t)}return"rgba("+t(this.r)+","+t(this.g)+","+t(this.b)+","+this.a+")"}},{key:"toHexString",value:function(){function t(t){return Math.floor(255.99*t)}function e(t){for(var e=t;e.length<2;)e="0"+e;return e}return e(t(this.r).toString(16))+e(t(this.g).toString(16))+e(t(this.b).toString(16))}},{key:"toTuple",value:function(){return[this.r,this.g,this.b,this.a]}},{key:"toTuple8Bit",value:function(){return[255*this.r,255*this.g,255*this.b,255*this.a]}},{key:"toHSB",value:function(){var t,e=Math.max(this.r,this.g,this.b),i=Math.min(this.r,this.g,this.b),n=e;return e==i?t=0:e==this.r?t=60*(0+(this.g-this.b)/(e-i)):e==this.g?t=60*(2+(this.b-this.r)/(e-i)):e==this.b&&(t=60*(4+(this.r-this.g)/(e-i))),[t=(t+360)%360,0==e?0:(e-i)/e,n]}},{key:"withA",value:function(t){return new q(this.r,this.g,this.b,t)}},{key:"mixedWith",value:function(t,e){var i=e,n=1-i;return new q(this.r*i+t.r*n,this.g*i+t.g*n,this.b*i+t.b*n,this.a*i+t.a*n)}},{key:"invert",value:function(){return q.rgb(255*(1-this.r),255*(1-this.g),255*(1-this.b))}},{key:"toCSSString",value:function(){return this.toRGBAString()}},{key:"__serialize__",value:function(){return{__expr__:"Color."+this.toString(),bindings:{"lively.graphics/color.js":["Color"]}}}},{key:"toJSExpr",value:function(){return"Color."+(this.name||this.toString())}},{key:"name",get:function(){var t=this,e=q.named;return Object.keys(e).find(function(i){return e[i].equals(t)})}}],[{key:"random",value:function(t,i){return void 0===t&&(t=0),void 0===i&&(i=255),q.rgb(e.num.random(t,i),e.num.random(t,i),e.num.random(t,i))}},{key:"hsb",value:function(t,e,i){var n=e,r=i;if(0==e)return new q(r,r,r);var s=t%360/60,a=Math.floor(s),o=s-a,u=(1-n)*r,f=(1-n*o)*r,h=(1-n*(1-o))*r;switch(a){case 0:return new q(r,h,u);case 1:return new q(f,r,u);case 2:return new q(u,r,h);case 3:return new q(u,f,r);case 4:return new q(h,u,r);case 5:return new q(r,u,f);default:return new q(0,0,0)}}},{key:"wheel",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;return q.wheelHsb(t,0,.9,.7)}},{key:"wheelHsb",value:function(t,e,i,n){for(var r=new Array(t),s=360/Math.max(t,1),a=0;a<t;a++)r[a]=q.hsb(e+a*s,i,n);return r}},{key:"rgb",value:function(t,e,i){return new q(t/255,e/255,i/255)}},{key:"rgbHex",value:function(t){var e=this.parseHex(t);return e&&e[0]>=0&&e[1]>=0&&e[2]>=0?new q(e[0],e[1],e[2]):null}},{key:"rgba",value:function(t,e,i,n){return new q(t/255,e/255,i/255,n)}},{key:"fromLiteral",value:function(t){return new q(t.r,t.g,t.b,t.a)}},{key:"fromTuple",value:function(t){return new q(t[0],t[1],t[2],t[3])}},{key:"fromTuple8Bit",value:function(t){return new q(t[0]/255,t[1]/255,t[2]/255,t[3]/255)}},{key:"fromString",value:function(t){return t&&"none"!==t?this.fromTuple(this.parse(t)):null}},{key:"rgbaRegex",get:function(){return M}},{key:"parse",value:function(t){var e;return t&&"none"!==t?[(e=function(t){var e=new g(t);return{red:e.red()/255,green:e.green()/255,blue:e.blue()/255,alpha:e.alpha()}}(t)).red,e.green,e.blue,e.alpha]:null}},{key:"parseRGB",value:function(t){var e=t.match(this.rgbaRegex);return e?[parseInt(e[1])/(e[2]?100:255),parseInt(e[3])/(e[4]?100:255),parseInt(e[5])/(e[6]?100:255),e[7]?parseFloat(e[7]):1]:null}},{key:"parseHex",value:function(t){for(var e,i,n,r="",s=0;s<t.length;s++){var a=t[s].toLowerCase();"a"!=a&&"b"!=a&&"c"!=a&&"d"!=a&&"e"!=a&&"f"!=a&&"0"!=a&&"1"!=a&&"2"!=a&&"3"!=a&&"4"!=a&&"5"!=a&&"6"!=a&&"7"!=a&&"8"!=a&&"9"!=a||(r+=a)}if(6==r.length)e=r.substring(0,2),i=r.substring(2,4),n=r.substring(4,6);else{if(3!=r.length)return null;e=r.substring(0,1),e+=e,i=r.substring(1,2),i+=i,n=r.substring(2,3),n+=n}return[parseInt(e,16)/255,parseInt(i,16)/255,parseInt(n,16)/255]}},{key:"named",get:function(){return this._named?this._named:this._named={black:new q(0,0,0),almostBlack:q.rgb(64,64,64),white:new q(1,1,1),gray:new q(.8,.8,.8),red:new q(.8,0,0),green:new q(0,.8,0),yellow:new q(.8,.8,0),blue:new q(0,0,.8),purple:new q(1,0,1),magenta:new q(1,0,1),pink:q.rgb(255,30,153),turquoise:q.rgb(0,240,255),tangerine:q.rgb(242,133,0),orange:q.rgb(255,153,0),cyan:q.rgb(0,255,255),brown:q.rgb(182,67,0),limeGreen:q.rgb(51,255,0),darkGray:q.rgb(102,102,102),lightGray:q.rgb(230,230,230),veryLightGray:q.rgb(243,243,243),transparent:q.rgba(0,0,0,0)}}}],i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:1782,end:11241})}(void 0);Object.assign(q,q.named);var V=function(t){var i=_classRecorder,n=i.hasOwnProperty("Gradient")&&"function"==typeof i.Gradient?i.Gradient:i.Gradient=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:Symbol.for("lively-instance-initialize"),value:function(t){this.stops=t?t.map(function(t){return t}):[]}},{key:"equals",value:function(t){return!(!t||!t.isGradient)&&this.toString()==t.toString()}},{key:"getStopsLighter",value:function(t){return e.arr.collect(this.stops,function(e){return{offset:e.offset,color:e.color.lighter(t)}})}},{key:"getStopsDarker",value:function(t){return e.arr.collect(this.stops,function(e){return{offset:e.offset,color:e.color.darker(t)}})}},{key:"isGradient",get:function(){return!0}},{key:"interpolateStops",value:function(t,i){var n=H(this.stops,i.length),r=H(i,this.stops.length),s=[],a=void 0,o=void 0,u=void 0,f=void 0,h=void 0;for(a=0;a<n.length;a++){var c=n[a];o=c.color,f=c.offset;var l=r[a];u=l.color,h=l.offset,s.push({color:o.interpolate(t,u),offset:e.num.interpolate(t,f,h)})}return s}}],[{key:"create",value:function(t){var e=[];for(var i in t)e.push({offset:Number(i),color:t[i]});return new this({stops:e})}},{key:"parse",value:function(t){return t.startsWith("radial-gradient")?W.parse(t):t.startsWith("linear-gradient")?Y.parse(t):q.fromTuple(q.parse(t))}}],i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:11280,end:13069})}(void 0),Y=function(t){var i=_classRecorder,n=i.hasOwnProperty("LinearGradient")&&"function"==typeof i.LinearGradient?i.LinearGradient:i.LinearGradient=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,t,[{key:Symbol.for("lively-instance-initialize"),value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.stops,i=t.vector;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.vector=i}},{key:"type",get:function(){return"linearGradient"}},{key:"vectors",get:function(){return{northsouth:E(G(0,0),G(0,1)),northeast:E(G(1,0),G(0,1)),westeast:E(G(1,0),G(0,0)),southeast:E(G(1,1),G(0,0)),southnorth:E(G(0,1),G(0,0)),southwest:E(G(0,1),G(1,0)),eastwest:E(G(0,0),G(1,0)),northwest:E(G(0,0),G(1,1))}}},{key:"angleToRect",value:function(t){return R.polar(1,t).extentAsRectangle().withCenter(G(.5,.5))}},{key:"vectorAsAngle",value:function(){return this.vector.extent().theta()}},{key:"toString",value:function(){return this.toCSSString()}},{key:"vector",get:function(){return this._vector}},{key:"vector",set:function(t){this._vector=t?"string"==typeof t?this.vectors[t.toLowerCase()]:"number"==typeof t?this.angleToRect(t):t:this.vectors.northsouth}},{key:"lighter",value:function(t){return new this.constructor({stops:this.getStopsLighter(t),vector:this.vector})}},{key:"darker",value:function(){return new this.constructor({stops:this.getStopsDarker(),vector:this.vector})}},{key:"interpolate",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{width:1e3,height:1e3};if(e.isColor&&(e=new Y({vector:this.vector,stops:this.stops.map(function(t){var i=t.offset;return{color:e,offset:i}})})),"radialGradient"==e.type){if(t<.5)return new Y({vector:this.vector.interpolate(t,E(0,0,0,1)),stops:this.interpolateStops(t,e.stops.map(function(t,e){var i=t.color;t.offset;return{color:i,offset:1}}))});if(t>=.5)return new W({stops:this.interpolateStops(t,e.stops),focus:G(.5,0).interpolate(t,e.focus),bounds:E(0,0,100*i.width,2*i.height).interpolate(t,e.bounds)})}return new Y({stops:this.interpolateStops(t,e.stops),vector:this.vector.interpolate(t,e.vector)})}},{key:"toCSSString",value:function(){var t="linear-gradient("+(e.num.toDegrees(this.vectorAsAngle())+90)+"deg,";return t+=this.stops.map(function(t){return t.color.toRGBAString()+" "+(100*t.offset).toFixed()+"%"}).join(","),t+=")"}},{key:"toJSExpr",value:function(){return"new LinearGradient({stops: ["+this.stops.map(function(t){return"{offset: "+t.offset+", color: "+t.color.toJSExpr()+"}"}).join(", ")+"], vector: "+this.vector+"})"}}],[{key:"parse",value:function(t){t.match(/\((.*)\)/)[1].split(",")}}],i,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:13078,end:16213})}({referencedAs:"Gradient",value:V}),W=function(t){var e=_classRecorder,i=e.hasOwnProperty("RadialGradient")&&"function"==typeof e.RadialGradient?e.RadialGradient:e.RadialGradient=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:Symbol.for("lively-instance-initialize"),value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.stops,n=t.focus,r=t.bounds;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(i.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.focus=n||G(.5,.5),this.bounds=r||new A(0,0,20,20)}},{key:"type",get:function(){return"radialGradient"}},{key:"toString",value:function(){return this.toCSSString()}},{key:"lighter",value:function(t){return new this.constructor({stops:this.getStopsLighter(t),focus:this.focus,bounds:this.bounds})}},{key:"darker",value:function(){return new this.constructor({stops:this.getStopsDarker(),focus:this.focus,bounds:this.bounds})}},{key:"interpolate",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{height:1e3,width:1e3};return e.isColor&&(e=new W({vector:this.vector,bounds:this.bounds,stops:this.stops.map(function(t){var i=t.offset;return{color:e,offset:i}})})),"linearGradient"==e.type?e.interpolate(1-t,this,i):new W({bounds:this.bounds.interpolate(t,e.bounds),stops:this.interpolateStops(t,e.stops),focus:this.focus.interpolate(t,e.focus)})}},{key:"toCSSString",value:function(){for(var t=this.focus.scaleBy(100),e=this.bounds.extent(),i="radial-gradient("+e.x/2+"px "+e.y/2+"px at "+t.x+"% "+t.y+"%",n=0;n<this.stops.length;n++)i+=","+this.stops[n].color.toRGBAString()+" "+(100*this.stops[n].offset).toFixed()+"%";return i+=")"}}],[{key:"parse",value:function(t){t.match(/\((.*)\)/)[1].split(",")}}],e,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.graphics",version:"0.1.1"}}},{start:16222,end:17884})}({referencedAs:"Gradient",value:V});t.Complementary=N,t.Triadic=z,t.Tetradic=U,t.Quadratic=j,t.Analogous=O,t.Neutral=X,t.Color=q,t.LinearGradient=Y,t.RadialGradient=W,t.flatDesignColors=["#1abc9c","#e8f8f5","#d1f2eb","#a3e4d7","#76d7c4","#48c9b0","#1abc9c","#17a589","#148f77","#117864","#0e6251","#16a085","#e8f6f3","#d0ece7","#a2d9ce","#73c6b6","#45b39d","#16a085","#138d75","#117a65","#0e6655","#0b5345","#2ecc71","#eafaf1","#d5f5e3","#abebc6","#82e0aa","#58d68d","#2ecc71","#28b463","#239b56","#1d8348","#186a3b","#27ae60","#e9f7ef","#d4efdf","#a9dfbf","#7dcea0","#52be80","#27ae60","#229954","#1e8449","#196f3d","#145a32","#3498db","#ebf5fb","#d6eaf8","#aed6f1","#85c1e9","#5dade2","#3498db","#2e86c1","#2874a6","#21618c","#1b4f72","#2980b9","#eaf2f8","#d4e6f1","#a9cce3","#7fb3d5","#5499c7","#2980b9","#2471a3","#1f618d","#1a5276","#154360","#9b59b6","#f5eef8","#ebdef0","#d7bde2","#c39bd3","#af7ac5","#9b59b6","#884ea0","#76448a","#633974","#512e5f","#8e44ad","#f4ecf7","#e8daef","#d2b4de","#bb8fce","#a569bd","#8e44ad","#7d3c98","#6c3483","#5b2c6f","#4a235a","#34495e","#ebedef","#d6dbdf","#aeb6bf","#85929e","#5d6d7e","#34495e","#2e4053","#283747","#212f3c","#1b2631","#2c3e50","#eaecee","#d5d8dc","#abb2b9","#808b96","#566573","#2c3e50","#273746","#212f3d","#1c2833","#17202a","#f1c40f","#fef9e7","#fcf3cf","#f9e79f","#f7dc6f","#f4d03f","#f1c40f","#d4ac0d","#b7950b","#9a7d0a","#7d6608","#f39c12","#fef5e7","#fdebd0","#fad7a0","#f8c471","#f5b041","#f39c12","#d68910","#b9770e","#9c640c","#7e5109","#e67e22","#fdf2e9","#fae5d3","#f5cba7","#f0b27a","#eb984e","#e67e22","#ca6f1e","#af601a","#935116","#784212","#d35400","#fbeee6","#f6ddcc","#edbb99","#e59866","#dc7633","#d35400","#ba4a00","#a04000","#873600","#6e2c00","#e74c3c","#fdedec","#fadbd8","#f5b7b1","#f1948a","#ec7063","#e74c3c","#cb4335","#b03a2e","#943126","#78281f","#c0392b","#f9ebea","#f2d7d5","#e6b0aa","#d98880","#cd6155","#c0392b","#a93226","#922b21","#7b241c","#641e16","#ecf0f1","#fdfefe","#fbfcfc","#f7f9f9","#f4f6f7","#f0f3f4","#ecf0f1","#d0d3d4","#b3b6b7","#979a9a","#7b7d7d","#bdc3c7","#f8f9f9","#f2f3f4","#e5e7e9","#d7dbdd","#cacfd2","#bdc3c7","#a6acaf","#909497","#797d7f","#626567","#95a5a6","#f4f6f6","#eaeded","#d5dbdb","#bfc9ca","#aab7b8","#95a5a6","#839192","#717d7e","#5f6a6a","#4d5656","#7f8c8d","#f2f4f4","#e5e8e8","#ccd1d1","#b2babb","#99a3a4","#7f8c8d","#707b7c","#616a6b","#515a5a","#424949"],t.materialDesignColors=["#f44336","#ffebee","#ffcdd2","#ef9a9a","#e57373","#ef5350","#f44336","#e53935","#d32f2f","#c62828","#b71c1c","#ff8a80","#ff5252","#ff1744","#d50000","#e91e63","#fce4ec","#f8bbd0","#f48fb1","#f06292","#ec407a","#e91e63","#d81b60","#c2185b","#ad1457","#880e4f","#ff80ab","#ff4081","#f50057","#c51162","#9c27b0","#f3e5f5","#e1bee7","#ce93d8","#ba68c8","#ab47bc","#9c27b0","#8e24aa","#7b1fa2","#6a1b9a","#4a148c","#ea80fc","#e040fb","#d500f9","#aa00ff","#673ab7","#ede7f6","#d1c4e9","#b39ddb","#9575cd","#7e57c2","#673ab7","#5e35b1","#512da8","#4527a0","#311b92","#b388ff","#7c4dff","#651fff","#6200ea","#3f51b5","#e8eaf6","#c5cae9","#9fa8da","#7986cb","#5c6bc0","#3f51b5","#3949ab","#303f9f","#283593","#1a237e","#8c9eff","#536dfe","#3d5afe","#304ffe","#2196f3","#e3f2fd","#bbdefb","#90caf9","#64b5f6","#42a5f5","#2196f3","#1e88e5","#1976d2","#1565c0","#0d47a1","#82b1ff","#448aff","#2979ff","#2962ff","#03a9f4","#e1f5fe","#b3e5fc","#81d4fa","#4fc3f7","#29b6f6","#03a9f4","#039be5","#0288d1","#0277bd","#01579b","#80d8ff","#40c4ff","#00b0ff","#0091ea","#00bcd4","#e0f7fa","#b2ebf2","#80deea","#4dd0e1","#26c6da","#00bcd4","#00acc1","#0097a7","#00838f","#006064","#84ffff","#18ffff","#00e5ff","#00b8d4","#009688","#e0f2f1","#b2dfdb","#80cbc4","#4db6ac","#26a69a","#009688","#00897b","#00796b","#00695c","#004d40","#a7ffeb","#64ffda","#1de9b6","#00bfa5","#4caf50","#e8f5e9","#c8e6c9","#a5d6a7","#81c784","#66bb6a","#4caf50","#43a047","#388e3c","#2e7d32","#1b5e20","#b9f6ca","#69f0ae","#00e676","#00c853","#8bc34a","#f1f8e9","#dcedc8","#c5e1a5","#aed581","#9ccc65","#8bc34a","#7cb342","#689f38","#558b2f","#33691e","#ccff90","#b2ff59","#76ff03","#64dd17","#cddc39","#f9fbe7","#f0f4c3","#e6ee9c","#dce775","#d4e157","#cddc39","#c0ca33","#afb42b","#9e9d24","#827717","#f4ff81","#eeff41","#c6ff00","#aeea00","#ffeb3b","#fffde7","#fff9c4","#fff59d","#fff176","#ffee58","#ffeb3b","#fdd835","#fbc02d","#f9a825","#f57f17","#ffff8d","#ffff00","#ffea00","#ffd600","#ffc107","#fff8e1","#ffecb3","#ffe082","#ffd54f","#ffca28","#ffc107","#ffb300","#ffa000","#ff8f00","#ff6f00","#ffe57f","#ffd740","#ffc400","#ffab00","#ff9800","#fff3e0","#ffe0b2","#ffcc80","#ffb74d","#ffa726","#ff9800","#fb8c00","#f57c00","#ef6c00","#e65100","#ffd180","#ffab40","#ff9100","#ff6d00","#ff5722","#fbe9e7","#ffccbc","#ffab91","#ff8a65","#ff7043","#ff5722","#f4511e","#e64a19","#d84315","#bf360c","#ff9e80","#ff6e40","#ff3d00","#dd2c00","#795548","#efebe9","#d7ccc8","#bcaaa4","#a1887f","#8d6e63","#795548","#6d4c41","#5d4037","#4e342e","#3e2723","#9e9e9e","#fafafa","#f5f5f5","#eeeeee","#e0e0e0","#bdbdbd","#9e9e9e","#757575","#616161","#424242","#212121","#607d8b","#eceff1","#cfd8dc","#b0bec5","#90a4ae","#78909c","#607d8b","#546e7a","#455a64","#37474f","#263238","#ffffff","#000000"],t.webSafeColors=["ccff00","ccff33","ccff66","ccff99","ccffcc","ccffff","ffffff","ffffcc","ffff99","ffff66","ffff33","ffff00","cccc00","cccc33","cccc66","cccc99","cccccc","ccccff","ffccff","ffcccc","ffcc99","ffcc66","ffcc33","ffcc00","cc9900","cc9933","cc9966","cc9999","cc99cc","cc99ff","ff99ff","ff99cc","ff9999","ff9966","ff9933","ff9900","cc6600","cc6633","cc6666","cc6699","cc66cc","cc66ff","ff66ff","ff66cc","ff6699","ff6666","ff6633","ff6600","cc3300","cc3333","cc3366","cc3399","cc33cc","cc33ff","ff33ff","ff33cc","ff3399","ff3366","ff3333","ff3300","cc0000","cc0033","cc0066","cc0099","cc00cc","cc00ff","ff00ff","ff00cc","ff0099","ff0066","ff0033","ff0000","660000","660033","660066","660099","6600cc","6600ff","9900ff","9900cc","990099","990066","990033","990000","663300","663333","663366","663399","6633cc","6633ff","9933ff","9933cc","993399","993366","993333","993300","666600","666633","666666","666699","6666cc","6666ff","9966ff","9966cc","996699","996666","996633","996600","669900","669933","669966","669999","6699cc","6699ff","9999ff","9999cc","999999","999966","999933","999900","66cc00","66cc33","66cc66","66cc99","66cccc","66ccff","99ccff","99cccc","99cc99","99cc66","99cc33","99cc00","66ff00","66ff33","66ff66","66ff99","66ffcc","66ffff","99ffff","99ffcc","99ff99","99ff66","99ff33","99ff00","00ff00","00ff33","00ff66","00ff99","00ffcc","00ffff","33ffff","33ffcc","33ff99","33ff66","33ff33","33ff00","00cc00","00cc33","00cc66","00cc99","00cccc","00ccff","33ccff","33cccc","33cc99","33cc66","33cc33","33cc00","009900","009933","009966","009999","0099cc","0099ff","3399ff","3399cc","339999","339966","339933","339900","006600","006633","006666","006699","0066cc","0066ff","3366ff","3366cc","336699","336666","336633","336600","003300","003333","003366","003399","0033cc","0033ff","3333ff","3333cc","333399","333366","333333","333300","000000","000033","000066","000099","0000cc","0000ff","3300ff","3300cc","330099","330066","330033","330000"],t.Point=R,t.Rectangle=A,t.Transform=P,t.Line=B,t.rect=E,t.pt=G}(this.lively.graphics=this.lively.graphics||{},lively.lang),"undefined"!=typeof module&&module.exports&&(module.exports=t.lively.graphics)}();
//LIVELY.BINDINGS - 14k
!function(){var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;System.global._classRecorder=System.global._classRecorder||{},this.lively=this.lively||{},function(t,e,n){"use strict";function r(t,e,n,r,i){"function"!=typeof n||void 0!==r&&"object"!==(void 0===r?"undefined":o(r))||(i=r,r="call",i||(i={}),i.updater||(i.updater=function(t,e){return t(null,e)}));var s,c=t.getConnectionPoints&&t.getConnectionPoints()||t.connections,u=c&&c[e],l=u&&u.map&&lively.morphic&&lively.morphic.GeometryConnection||u&&u.connectionClassType&&lively.Class.forName(u.connectionClassType)||a;"function"==typeof i?(console.warn("Directly passing a converter function to connect() is deprecated! Use spec object instead!"),s={converter:i}):s=i,u&&(s=lively.lang.obj.merge(u,s));var h=new l(t,e,n,r,s),d=h.getExistingConnection();if(d)return d.resetSpec(),d.init(t,e,n,r,s),d;var p=h.connect();return"function"==typeof t.onConnect&&t.onConnect(e,n,r),u&&u.updateOnConnect&&h.update(t[e]),p}function i(t,e,n,i){null!=t[e]?n[i](t[e]):r(t,e,n,i,{removeAfterUpdate:!0})}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=(function(){function t(t){this.value=t}function e(e){function n(i,o){try{var a=e[i](o),s=a.value;s instanceof t?Promise.resolve(s.value).then(function(t){n("next",t)},function(t){n("throw",t)}):r(a.done?"return":"normal",a.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":i.resolve({value:e,done:!0});break;case"throw":i.reject(e);break;default:i.resolve({value:e,done:!1})}(i=i.next)?n(i.key,i.arg):o=null}var i,o;this._invoke=function(t,e){return new Promise(function(r,a){var s={key:t,arg:e,resolve:r,reject:a,next:null};o?o=o.next=s:(i=o=s,n(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t){var r=_classRecorder,i=r.hasOwnProperty("AttributeConnection")&&"function"==typeof r.AttributeConnection?r.AttributeConnection:r.AttributeConnection=function(t){t&&t[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(i,t,[{key:Symbol.for("lively-instance-initialize"),value:function(t,e,n,r,i){this.init(t,e,n,r,i)}},{key:"init",value:function(t,e,n,r,i){return this.doNotSerialize=["isActive","converter","updater","varMapping"],this.sourceObj=t,this.sourceAttrName=e,this.targetObj=n,this.targetMethodName=r,this.varMapping={source:t,target:n},(i=Object.assign({removeAfterUpdate:!1,forceAttributeConnection:!1,garbageCollect:!0,signalOnAssignment:!0},i)).removeAfterUpdate&&(this.removeAfterUpdate=!0),i.forceAttributeConnection&&(this.forceAttributeConnection=!0),"boolean"==typeof i.garbageCollect&&(this.garbageCollect=i.garbageCollect),"boolean"==typeof i.signalOnAssignment&&(this.signalOnAssignment=i.signalOnAssignment),i.converter&&this.setConverter(i.converter),i.updater&&this.setUpdater(i.updater),i.varMapping&&(this.varMapping=Object.assign(i.varMapping,this.varMapping)),this.getSpec(),this}},{key:"__additionally_serialize__",value:function(t,n,r,i){e.arr.equals(e.arr.without(Object.keys(this.varMapping),"_rev"),["source","target"])?t.props.varMapping&&delete t.props.varMapping:i("varMapping",this.varMapping)}},{key:"__after_deserialize__",value:function(t,e){this.varMapping||(this.varMapping={}),this.varMapping.source=this.sourceObj,this.varMapping.target=this.targetObj,this.connect()}},{key:"onSourceAndTargetRestored",value:function(){this.sourceObj&&this.targetObj&&this.connect()}},{key:"copy",value:function(t){return a.fromLiteral(this.toLiteral(),t)}},{key:"fixInstanceAfterCopyingFromSite",value:function(t,e,n){this.disconnect()}},{key:"clone",value:function(){var t=new this.constructor(this.getSourceObj(),this.getSourceAttrName(),this.getTargetObj(),this.getTargetMethodName(),this.getSpec());return this.dependedBy&&(t.dependedBy=this.dependedBy),t}},{key:"getTargetObj",value:function(){return this.targetObj}},{key:"getSourceObj",value:function(){return this.sourceObj}},{key:"getSourceAttrName",value:function(){return this.sourceAttrName}},{key:"getTargetMethodName",value:function(){return this.targetMethodName}},{key:"getSourceValue",value:function(){return this.getSourceObj()[this.getSourceAttrName()]}},{key:"getPrivateSourceValue",value:function(){return this.sourceObj[this.privateAttrName(this.sourceAttrName)]}},{key:"getConverter",value:function(){return this.converterString?(this.converter||(this.converter=e.Closure.fromSource(this.converterString,this.varMapping).recreateFunc()),this.converter):null}},{key:"setConverter",value:function(t){return delete this.converter,this.converterString=t?String(t):null}},{key:"getUpdater",value:function(){return this.updaterString?(this.updater||(this.updater=e.Closure.fromSource(this.updaterString,this.varMapping).recreateFunc()),this.updater):null}},{key:"setUpdater",value:function(t){return delete this.updater,this.updaterString=t?n.stringifyFunctionWithoutToplevelRecorder(t):null}},{key:"getSpec",value:function(){var t={};return this.updaterString&&(t.updater=this.getUpdater()),this.converterString&&(t.converter=this.getConverter()),this.removeAfterUpdate&&(t.removeAfterUpdate=!0),this.forceAttributeConnection&&(t.forceAttributeConnection=!0),this.hasOwnProperty("garbageCollect")&&(t.garbageCollect=this.garbageCollect),this.hasOwnProperty("signalOnAssignment")&&(t.signalOnAssignment=this.signalOnAssignment),t}},{key:"resetSpec",value:function(){delete this.garbageCollect,delete this.signalOnAssignment,delete this.removeAfterUpdate,delete this.forceAttributeConnection,delete this.converter,delete this.converterString,delete this.updater,delete this.updaterString}},{key:"privateAttrName",value:function(t){return"$$"+t}},{key:"activate",value:function(){this.isActive=!0}},{key:"deactivate",value:function(){delete this.isActive}},{key:"connect",value:function(){var t=this.getExistingConnection();t!==this&&(t&&t.disconnect(),this.addAttributeConnection());var e=this.sourceObj,n=this.sourceAttrName,r=this.forceAttributeConnection,i=e.__lookupSetter__(n),o=e.__lookupGetter__(n),a=!i&&!o&&(this.getSourceValue()||this.getPrivateSourceValue());return"function"!=typeof a||r?this.addSourceObjGetterAndSetter(o,i):a.isWrapped||this.addConnectionWrapper(e,n,a),this}},{key:"disconnect",value:function(){var t=this,e=this.sourceObj;if(!e||!e.attributeConnections)return this.removeSourceObjGetterAndSetter();e.attributeConnections=e.attributeConnections.filter(function(e){return!t.isSimilarConnection(e)});var n=e.attributeConnections.filter(function(e){return t.getSourceAttrName()==e.getSourceAttrName()});return 0==e.attributeConnections.length&&delete e.attributeConnections,0==n.length&&this.removeSourceObjGetterAndSetter(),null}},{key:"update",value:function(t,e){if(this.isActive)return null;var n=this,r=this.getUpdater(),i=this.getConverter(),o=this.targetObj,a=this.targetMethodName;if(!o||!a){var s="Cannot update "+this.toString(t)+" because of no target ("+o+") or targetProp ("+a+") ";return this.isWeakConnection&&this.disconnect(),console.error(s),null}var c=o[a],u=function(e,r,s,u,l,h){var d=[e,r,s,u,l,h];i&&(t=i.call(n,e,r),e=d[0]=t);var p="function"==typeof c?c.apply(o,d):o[a]=e;return n.removeAfterUpdate&&n.disconnect(),p};try{return this.isActive=!0,r?r.call(this,u,t,e):u(t,e)}catch(e){var l=this.sourceObj&&"function"==typeof this.sourceObj.world&&this.sourceObj.world()||this.targetObj&&"function"==typeof this.targetObj.world&&this.targetObj.world();l?l.logError(e,"AttributeConnection>>update: "):console.error("Error when trying to update "+this+" with value "+t+":\n"+e+"\n"+e.stack)}finally{delete this.isActive}return null}},{key:"addSourceObjGetterAndSetter",value:function(t,n){if(!(t&&t.isAttributeConnectionGetter||n&&n.isAttributeConnectionSetter)){var r=this.sourceObj,i=this.sourceAttrName,o=this.privateAttrName(i);r[o]&&console.warn("newAttrName "+o+" already exists.Are there already other connections?"),r.hasOwnProperty("doNotSerialize")||(r.doNotSerialize=[]),e.arr.pushIfNotIncluded(r.doNotSerialize,o),r.hasOwnProperty("doNotCopyProperties")||(r.doNotCopyProperties=[]),e.arr.pushIfNotIncluded(r.doNotCopyProperties,o),t&&r.__defineGetter__(o,t),n&&r.__defineSetter__(o,n),t||n||!r.hasOwnProperty(i)||(r[o]=r[i]),r.__defineSetter__(i,function(t){var e=r[o];return r[o]=t,void 0===r.attributeConnections?(console.error("Sth wrong with sourceObj, has no attributeConnections"),null):(r.attributeConnections.forEach(function(n){n&&n.getSourceAttrName()===i&&n.signalOnAssignment&&n.update(t,e)}),t)}),r.__lookupSetter__(i).isAttributeConnectionSetter=!0,r.__defineGetter__(i,function(){return r[o]}),r.__lookupGetter__(i).isAttributeConnectionGetter=!0}}},{key:"addConnectionWrapper",value:function(t,e,n){if("function"!=typeof n)throw new Error("addConnectionWrapper didnt get a method to wrap");var r=void 0,i=void 0;(i=t.hasOwnProperty(e))?(t[this.privateAttrName(e)]=n,r=function(){return n}):r=function(){return Object.getPrototypeOf(t)[e]},t[e]=function(){if(void 0===this.attributeConnections)throw new Error("[lively.bindings] Something is wrong with connection source object, it has no attributeConnections");for(var t=this.attributeConnections.slice(),n=this[e].originalFunction.apply(this,arguments),r=0;r<t.length;r++){var i=t[r];i.getSourceAttrName()===e&&i.update(arguments[0])}return n},t[e].isOwnProperty=i,t[e].isWrapped=!0,t[e].isConnectionWrapper=!0,Object.defineProperty(t[e],"originalFunction",{get:r}),t[e].toString=function(){return"<Wrapped "+r()+">"}}},{key:"removeSourceObjGetterAndSetter",value:function(){var t=this.sourceAttrName,n=this.privateAttrName(t),r=this.sourceObj;if(r){if(r.__lookupGetter__(t)){if(delete r[t],r.hasOwnProperty(n)){try{r[t]=r[n]}catch(t){}delete r[n]}}else r[t]&&r[t].isConnectionWrapper&&(delete r[t],r[t]||(r[t]=r[t].originalFunction));r.doNotSerialize&&r.doNotSerialize.includes(n)&&(r.doNotSerialize=e.arr.without(r.doNotSerialize,n),0==r.doNotSerialize.length&&delete r.doNotSerialize),r.doNotCopyProperties&&r.doNotCopyProperties.includes(n)&&(r.doNotCopyProperties=e.arr.without(r.doNotCopyProperties,n),0==r.doNotCopyProperties.length&&delete r.doNotCopyProperties)}}},{key:"addAttributeConnection",value:function(){this.sourceObj.attributeConnections||(this.sourceObj.attributeConnections=[]),this.sourceObj.attributeConnections.push(this)}},{key:"getExistingConnection",value:function(){var t=this.sourceObj&&this.sourceObj.attributeConnections;if(!t)return null;for(var e=0,n=t.length;e<n;e++)if(this.isSimilarConnection(t[e]))return t[e];return null}},{key:"isRecursivelyActivated",value:function(){return this.isActive}},{key:"isSimilarConnection",value:function(t){return!(!t||t.constructor!=this.constructor)&&(this.sourceObj==t.sourceObj&&this.sourceAttrName==t.sourceAttrName&&this.targetObj==t.targetObj&&this.targetMethodName==t.targetMethodName)}},{key:"toString",value:function(t){try{return e.string.format("AttributeConnection(%s.%s %s %s.%s)",this.getSourceObj(),this.getSourceAttrName(),t?"--\x3e"+String(t)+"--\x3e":"--\x3e",this.getTargetObj(),this.getTargetMethodName())}catch(t){return"<Error in AttributeConnection>>toString>"}}}],void 0,r,{pathInPackage:function(){return"/index.js"},subscribeToToplevelDefinitionChanges:function(){return function(){}},package:function(){return{name:"lively.bindings",version:"0.1.2"}}},{start:216,end:15964})}(void 0));t.connect=r,t.disconnect=function(t,e,n,r){if("function"!=typeof n||void 0!==r&&"object"!==(void 0===r?"undefined":o(r))||(r="call"),t.attributeConnections){var i=!0,a=!1,s=void 0;try{for(var c,u=t.attributeConnections.slice()[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var l=c.value;l.getSourceAttrName()==e&&l.getTargetObj()===n&&l.getTargetMethodName()==r&&l.disconnect()}}catch(t){a=!0,s=t}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}"function"==typeof t.onDisconnect&&t.onDisconnect(e,n,r)}},t.disconnectAll=function(t){for(var e=void 0;t.attributeConnections&&(e=t.attributeConnections[0]);)e.disconnect()},t.once=function(t,e,n,i,a){return"function"!=typeof n||void 0!==i&&"object"!==(void 0===i?"undefined":o(i))?a=a||{}:(a=i,i="call",(a=a||{})||(a={}),a.updater||(a.updater=function(t,e){return t(null,e)})),a=a||{},a.removeAfterUpdate=!0,r(t,e,n,i,a)},t.signal=function(t,e,n){var r=t.attributeConnections;if(r)for(var i=t[e],o=0,a=r.length;o<a;o++){var s=r[o];s.getSourceAttrName()==e&&s.update(n,i)}},t.noUpdate=function(t,n){var r,i=!1;if(n||"function"!=typeof t||(n=t,i=!0),i){var o=a.prototype;o.isActive||(o.isActive=0),o.isActive++;try{r=n()}finally{o.isActive--,o.isActive<=0&&o.isActive}}else{var s=t.sourceObj,c=t.sourceAttribute,u=t.targetObj,l=t.targetAttribute,h=u&&l?function(t){return t.getSourceAttrName()===c&&u===t.getTargetObj()&&l===t.getTargetMethodName()}:function(t){return t.getSourceAttrName()===c},d=s.attributeConnections&&s.attributeConnections.filter(h);d&&e.arr.invoke(d,"activate");try{r=n()}finally{d&&e.arr.invoke(d,"deactivate")}}return r},t.AttributeConnection=a,t.callWhenNotNull=i,t.callWhenPathNotNull=function(t,e,n,r){for(var o={key:e.pop(),whenDefined:function(t){i(t,this.key,n,r)}};e.length>0;)o={key:e.pop(),next:o,whenDefined:function(t){i(t,this.key,this.next,"whenDefined")}};o.whenDefined(t)}}(this.lively.bindings=this.lively.bindings||{},lively.lang,lively.sourceTransform),"undefined"!=typeof module&&module.exports&&(module.exports=t.lively.bindings)}();
//LIVELY.SERIALIZER - 45k
!function(){var GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(exports,lively_lang,lively_morphic,lively_bindings,semver){"use strict";semver="default"in semver?semver.default:semver;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},asyncGenerator=function(){function e(e){this.value=e}function r(r){var t,i;function n(t,i){try{var o=r[t](i),s=o.value;s instanceof e?Promise.resolve(s.value).then(function(e){n("next",e)},function(e){n("throw",e)}):a(o.done?"return":"normal",o.value)}catch(e){a("throw",e)}}function a(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,r){return new Promise(function(a,o){var s={key:e,arg:r,resolve:a,reject:o,next:null};i?i=i.next=s:(t=i=s,n(e,r))})},"function"!=typeof r.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(r.prototype[Symbol.asyncIterator]=function(){return this}),r.prototype.next=function(e){return this._invoke("next",e)},r.prototype.throw=function(e){return this._invoke("throw",e)},r.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new r(e.apply(this,arguments))}},await:function(r){return new e(r)}}}(),asyncToGenerator=function(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function i(n,a){try{var o=r[n](a),s=o.value}catch(e){return void t(e)}if(!o.done)return Promise.resolve(s).then(function(e){i("next",e)},function(e){i("throw",e)});e(s)}("next")})}},classCallCheck=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(r,t,i){return t&&e(r.prototype,t),i&&e(r,i),r}}(),defineProperty=function(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e},_extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},get$1=function e(r,t,i){null===r&&(r=Function.prototype);var n=Object.getOwnPropertyDescriptor(r,t);if(void 0===n){var a=Object.getPrototypeOf(r);return null===a?void 0:e(a,t,i)}if("value"in n)return n.value;var o=n.get;return void 0!==o?o.call(i):void 0},inherits=function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)},possibleConstructorReturn=function(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r},set$1=function e(r,t,i,n){var a=Object.getOwnPropertyDescriptor(r,t);if(void 0===a){var o=Object.getPrototypeOf(r);null!==o&&e(o,t,i,n)}else if("value"in a&&a.writable)a.value=i;else{var s=a.set;void 0!==s&&s.call(n,i)}return i},slicedToArray=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(t.push(o.value),!r||t.length!==r);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)},knownSymbols,symMatcher;function isPrimitive(e){if(null==e)return!0;var r=void 0===e?"undefined":_typeof(e);return"boolean"===r||"number"===r||"string"===r}Object.defineProperty(Symbol.prototype,"__serialize__",{configurable:!0,value:(knownSymbols=Object.getOwnPropertyNames(Symbol).filter(function(e){return"symbol"===_typeof(Symbol[e])}).reduce(function(e,r){return e.set(Symbol[r],"Symbol."+r)},new Map),symMatcher=/^Symbol\((.*)\)$/,function(){var e="function"==typeof this[Symbol.toPrimitive]?this[Symbol.toPrimitive]():this,r=Symbol.keyFor(e);if(r)return{__expr__:'Symbol.for("'+r+'")'};if(knownSymbols.get(e))return{__expr__:knownSymbols.get(e)};var t=String(e).match(symMatcher);return{__expr__:t?'Symbol("'+t[1]+'")':"Symbol()"}})}),Object.defineProperty(System,"__serialize__",{configurable:!0,value:function(){return{__expr__:"System"}}}),Object.defineProperty(System.global,"__serialize__",{configurable:!0,value:function(){return{__expr__:"System.global"}}}),Object.defineProperty(Map.prototype,"__serialize__",{configurable:!0,value:function(e,r,t){var i=e.add(this),n=i.currentRev,a=i.currentSnapshot,o=a.entries=[],s=0;r[i.id]=a,e.classHelper.addClassInfo(i,this,a);var l=!0,u=!1,c=void 0;try{for(var p,f=this[Symbol.iterator]();!(l=(p=f.next()).done);l=!0){var h=slicedToArray(p.value,2),y=h[0],d=h[1];s++;var v=i.snapshotProperty(i.id,y,t.concat("key",String(s)),r,e),g=i.snapshotProperty(i.id,d,t.concat("value",String(s)),r,e);o.push(v,g)}}catch(e){u=!0,c=e}finally{try{!l&&f.return&&f.return()}finally{if(u)throw c}}return i.asRefForSerializedObjMap(n)}}),Object.defineProperty(Map.prototype,"__deserialize__",{configurable:!0,value:function(e,r,t,i,n){for(var a=e.entries,o=0;o<a.length;o+=2){var s=a[o],l=a[o+1],u=r.recreateProperty("key."+o,s,t,i,n.concat("key",o)),c=r.recreateProperty("value."+o,l,t,i,n.concat("value",o));this.set(u,c)}}}),Object.defineProperty(Set.prototype,"__serialize__",{configurable:!0,value:function(e,r,t){var i=e.add(this),n=i.currentRev,a=i.currentSnapshot,o=a.entries=[],s=0;r[i.id]=a,e.classHelper.addClassInfo(i,this,a);var l=!0,u=!1,c=void 0;try{for(var p,f=this[Symbol.iterator]();!(l=(p=f.next()).done);l=!0){var h=p.value;s++;var y=i.snapshotProperty(i.id,h,t.concat("entry",String(s)),r,e);o.push(y)}}catch(e){u=!0,c=e}finally{try{!l&&f.return&&f.return()}finally{if(u)throw c}}return i.asRefForSerializedObjMap(n)}}),Object.defineProperty(Set.prototype,"__deserialize__",{configurable:!0,value:function(e,r,t,i,n){for(var a=e.entries,o=0;o<a.length;o++){var s=r.recreateProperty("entry."+o,a[o],t,i,n.concat("key",o));this.add(s)}}});var classMetaForSerializationProp="lively.serializer-class-info",moduleMetaInClassProp=Symbol.for("lively-module-meta"),ClassHelper=function(){function e(r){classCallCheck(this,e),this.options=_extends({ignoreClassNotFound:!0},r),this[Symbol.for("lively-instance-restorer")]=!0}return createClass(e,[{key:"classNameProperty",get:function(){return"__LivelyClassName__"}},{key:"sourceModuleNameProperty",get:function(){return"__SourceModuleName__"}}],[{key:"moduleMetaInClassProp",get:function(){return moduleMetaInClassProp}},{key:"classMetaForSerializationProp",get:function(){return classMetaForSerializationProp}}]),createClass(e,[{key:"addClassInfo",value:function(e,r,t){if(r&&r.constructor){var i=r.constructor.name;if(i){var n=r.constructor[moduleMetaInClassProp];("Object"!==i||n)&&(n&&(delete n.lastChange,delete n.lastSuperclassChange),t[classMetaForSerializationProp]={className:i,module:n})}else console.warn("Cannot serialize class info of anonymous class of instance "+r)}}},{key:"restoreIfClassInstance",value:function(e,r){if(r.hasOwnProperty(classMetaForSerializationProp)){var t=r[classMetaForSerializationProp];if(t.className){var i=this.locateClass(t);if(!i||"function"!=typeof i){var n="Trying to deserialize instance of "+JSON.stringify(t)+" but this class cannot be found!";if(!this.options.ignoreClassNotFound)throw new Error(n);return console.error(n),{isClassPlaceHolder:!0,className:t.className}}return i.hasOwnProperty(Symbol.for("lively-instance-superclass"))?new i(this):new i}}}},{key:"locateClass",value:function(e){var r=e.module;if(r){var t=r.pathInPackage;if(r.package&&r.package.name&&"no group"!==r.package.name){var i=System.decanonicalize(r.package.name.replace(/\/*$/,"/"));t=lively_lang.string.joinPath(i,t)}var n=System.get("@lively-env"),a=n.moduleEnv(t)||n.moduleEnv(r.pathInPackage);if(a)return a.recorder[e.className];console.warn("Trying to deserialize instance of class "+e.className+" but the module "+t+" is not yet loaded")}return System.global[e.className]}}],[{key:"sourceModulesInObjRef",value:function(e){var r=[],t=e&&e[classMetaForSerializationProp];return t&&t.module&&r.push(t.module),r}},{key:"sourceModulesIn",value:function(e){var r=[];return Object.keys(e).forEach(function(t){var i=e[t];i&&i[classMetaForSerializationProp]&&r.push(i[classMetaForSerializationProp])}),lively_lang.arr.uniqBy(r,function(e,r){var t=e.module,i=r.module;return!t&&!i||t&&!i||!t&&i?e.className===r.className:e.className===r.className&&t.package.name==i.package.name&&t.package.pathInPackage==i.package.pathInPackage})}}]),e}(),ExpressionSerializer=function(){function ExpressionSerializer(e){classCallCheck(this,ExpressionSerializer);var r=_extends({prefix:"__lv_expr__"},e).prefix;this.prefix=r+":"}return createClass(ExpressionSerializer,[{key:"isSerializedExpression",value:function(e){return 0===e.indexOf(this.prefix)}},{key:"requiredModulesOf__expr__",value:function(e){if(!this.isSerializedExpression(e))return null;var r=this.exprStringDecode(e).bindings;return r?Object.keys(r):null}},{key:"exprStringDecode",value:function(e){for(var r=e.indexOf(":"),t=(e.slice(0,r),e.slice(r+1)),i={},n=!1;t&&t.startsWith("{")&&(r=t.indexOf("}:"))>=0;){n=!0;var a=t.slice(1,r);r=(t=t.slice(r+2)).indexOf(":");var o=t.slice(0,r),s=a.split(",").filter(function(e){return Boolean(e.trim())}).map(function(e){if(!e.includes(":"))return e;var r=e.split(":"),t=slicedToArray(r,2);return{exported:t[0],local:t[1]}});i[o]=s,t=t.slice(r+1)}return{__expr__:t,bindings:n?i:null}}},{key:"exprStringEncode",value:function(e){var r=e.__expr__,t=e.bindings,i=String(r);if(t)for(var n=Object.keys(t),a=0;a<n.length;a++){var o=n[a],s=t[o];Array.isArray(s)&&(s=s.map(function(e){return"string"==typeof e?e:e.exported+":"+e.local}).join(",")),i="{"+s+"}:"+o+":"+i}return this.prefix+i}},{key:"convert__expr__obj",value:function(e){return console.assert("__expr__"in e,"obj has no property __expr__"),this.prefix+e.__expr__}},{key:"__eval__",value:function __eval__(__source__,__boundValues__){return eval(__source__)}},{key:"deserializeExpr",value:function(e){if(!e.startsWith(this.prefix))throw new Error('"'+e+'" is not a serialized expression, missing prefix "'+this.prefix+'"');return this.deserializeExprObj(this.exprStringDecode(e))}},{key:"deserializeExprObj",value:function(e){var r=e.__expr__,t=e.bindings,i={};if(t)for(var n=t?Object.keys(t):[],a=0;a<n.length;a++){var o=n[a],s=t[o],l=System.get(System.decanonicalize(o));if(!l&&lively.FreezerRuntime){var u=lively.FreezerRuntime.fetchStandaloneFor(o);u&&(l=u.exports)}if(!l)throw new Error("[lively.serializer] expression eval: bindings specify to import "+o+" but this module is not loaded!\nSource: "+r);for(var c=0;c<s.length;c++){var p=s[c],f=void 0,h=void 0;"string"==typeof p?(f=p,h=p):"object"===(void 0===p?"undefined":_typeof(p))&&(f=p.local,h=p.exported),i[f]=l[h],r="var "+f+" = __boundValues__."+f+";\n"+r}}return this.__eval__(r,i)}}]),ExpressionSerializer}();function referenceGraph$1(e){Object.keys(e);var r={};for(var t in e)r[t]=referencesOfId(e,t);return r}function isReference(e){return e&&e.__ref__}function referencesOfId(e,r,t){var i=e[r],n=[];for(var a in i.props){var o=i.props[a]||{},s=o.value,l=o.verbatim;Array.isArray(s)?n.push.apply(n,toConsumableArray(referencesInArray(e,s,t&&a))):!l&&s&&isReference(s)&&n.push(t?{key:a,id:s.id}:s.id)}if(i.hasOwnProperty("entries"))for(var u=0;u<i.entries.length;u++){var c=i.entries[u];Array.isArray(c)?n.push.apply(n,toConsumableArray(referencesInArray(e,c,t&&c))):c&&isReference(c)&&n.push(t?{key:c,id:c.id}:c.id)}return n}function referencesInArray(e,r,t){for(var i=[],n=0;n<r.length;n++){var a=r[n];if(Array.isArray(a)){var o=t?t+"["+n+"]":void 0;i.push.apply(i,toConsumableArray(referencesInArray(e,a,o)))}else a&&isReference(a)&&i.push(t?{key:t+"["+n+"]",id:a.id}:a.id)}return i}function classNameOfId(e,r){return(e[r][ClassHelper.classMetaForSerializationProp]||{}).className||"Object"}function findPathFromToId$1(e,r,t){var i,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=void 0===n.showPath||n.showPath,o=n.hasOwnProperty("showClassNames")?n.showClassNames:!a,s=n.hasOwnProperty("showPropNames")?n.showPropNames:a,l=n.hasOwnProperty("hideId")?n.hideId:a,u=[],c={};if(function r(t,n,a){if(!i)if(a>50)alert(""+u);else{if(t===n)return u.push(t),void(i=u.slice());if(!c[t]){c[t]=!0,u.push(t);for(var o=referencesOfId(e,t),s=0;s<o.length;s++)r(o[s],n,a+1);u.pop()}}}(r,t,0),!i)return null;if(!o&&!s)return i;for(var p=[],f=0;f<i.length-1;f++){var h=i[f],y=i[f+1],d=[];if(l||d.push(h),o){var v=(e[h][ClassHelper.classMetaForSerializationProp]||{}).className;d.push(v||"Object")}if(s){var g=referencesOfId(e,h,!0).find(function(e){return e.id===y})||{key:"????"};d.push(g.key)}p.push(d.join(":"))}return a&&(p="."+p.join(".")),p}function lookupPath$1(e,r,t){t=(t=t.replace(/^\./,"")).replace(/\[([^\]])+\]/g,".$1");for(var i=lively_lang.Path(t).parts(),n=e[r],a=0;;){if(a++>1e3)throw"stop";var o=i.shift();if(!o)return n;if(!n.props||!n.props[o])throw new Error("Property "+o+" not found for ref "+JSON.stringify(n));var s=n.props[o].value;if(!s)throw new Error("Property "+o+" has no value");for(;Array.isArray(s);)s=s[i.shift()];if(!s||!s.__ref__)return s;n=e[s.id]}return n}function modifyProperty$1(e,r,t,i){t=(t=t.replace(/^\./,"")).replace(/\[([^\]])+\]/g,".$1");var n=lively_lang.Path(t).parts(),a=e[r],o=n.shift();if(!a.props||!a.props[o])throw new Error("Property "+o+" not found for ref "+JSON.stringify(a));var s=(a.props[o]||{}).value;if(!s)throw new Error("Property "+o+" has no value");if(n.length){var l=lively_lang.Path(n).get(s);lively_lang.Path(n).set(s,i(a,o,l))}else a.props[o].value=i(a,o,s)}function removeUnreachableObjects$1(e,r){var t=lively_lang.arr.withoutAll(Object.keys(r),e),i=referenceGraph$1(r);return e.forEach(function(e){for(var r=lively_lang.graph.subgraphReachableBy(i,e),n=t.length;n--;){t[n]in r&&t.splice(n,1)}}),t.forEach(function(e){return delete r[e]}),t}var defaultExprSerializer=new ExpressionSerializer;function requiredModulesOfSnapshot(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:defaultExprSerializer;e.snapshot&&(e=e.snapshot);for(var t=[],i=0,n=Object.keys(e);i<n.length;i++){var a,o=e[n[i]];if(o.__expr__){var s,l=r.requiredModulesOf__expr__(o.__expr__);l&&(s=t).push.apply(s,toConsumableArray(l))}else{var u=ClassHelper.sourceModulesInObjRef(o);if(u&&u.length&&(a=t).push.apply(a,toConsumableArray(u.map(function(e){return(e.package&&e.package.name||"")+"/"+e.pathInPackage}))),o.props)for(var c=0;c<o.props.length;c++){var p=o.props[c].value;if("string"==typeof p){var f,h=r.requiredModulesOf__expr__(p);h&&(f=t).push.apply(f,toConsumableArray(h))}}}}return t=lively_lang.arr.uniq(t)}var SnapshotInspector=function(){function e(r){classCallCheck(this,e),this.snapshot=r,this.classes={},this.expressions={}}return createClass(e,null,[{key:"forSnapshot",value:function(e){return new this(e).processSnapshot()}},{key:"forPoolAndSnapshot",value:function(e,r){return new this(e).processPool(r)}},{key:"checkForLeaks",value:function(e){(new this).processPool(e).referenceCounts(),(this.classes.AttributeConnection||{}).objects}}]),createClass(e,[{key:"processSnapshot",value:function(){var e=this.snapshot;e.snapshot&&(e=e.snapshot);var r=ObjectPool.fromSnapshot(e);return this.processPool(r)}},{key:"processPool",value:function(e){var r=this.expressions,t=this.classes;return this.pool=e,e.objectRefs().forEach(function(i){var n=i.currentSnapshot,a=(n[ClassHelper.classMetaForSerializationProp]||{}).className,o=Object.keys(n.props);null==a&&(a=o.length>3?"{"+o.slice(0,3).join(", ")+", ...}":"{"+o.join(", ")+"}"),t[a]||(t[a]={count:0,bytes:0,name:a,objects:[]}),t[a].count++,t[a].bytes+=JSON.stringify(n).length,t[a].objects.push([i.id,n]),o.forEach(function(t){var a=n.props[t].value;if(a&&"string"==typeof a&&e.expressionSerializer.isSerializedExpression(a)){var o=e.expressionSerializer.exprStringDecode(a).__expr__,s=r[o];s||(s=r[o]={count:0,bytes:0,name:o,objects:[]}),s.count++,s.bytes+=a.length,s.objects.push([[i.id,t],a])}})}),this}},{key:"explainId",value:function(e){var r=this.snapshot;r.snapshot&&(r=r.snapshot);var t=r[e];if(!t)return null;var i=(t[ClassHelper.classMetaForSerializationProp]||{className:"Object"}).className,n=Object.keys(t.props);return"Object"==i&&(i=n.length>3?"{"+n.slice(0,3).join(", ")+", ...}":"{"+n.join(", ")+"}"),i}},{key:"sorted",value:function(e){var r=this;return lively_lang.arr.sortBy(Object.keys(this[e]).map(function(t){return r[e][t]}),function(e){return isNaN(e.bytes)?0:e.bytes}).reverse()}},{key:"report",value:function(e){var r=[["#bytes","#objs","avg",e]].concat(toConsumableArray(this.sorted(e).map(function(e){return[lively_lang.num.humanReadableByteSize(e.bytes),e.count,lively_lang.num.humanReadableByteSize(e.bytes/e.count),lively_lang.string.truncate(e.name,300)]})));return lively_lang.string.printTable(r,{separator:" | "})}},{key:"toString",value:function(){var e=this.snapshot,r=JSON.stringify(e).length,t=Object.keys(e).length;return lively_lang.string.format("Total: %s (%s objs - %s per obj)",lively_lang.num.humanReadableByteSize(r),t,lively_lang.num.humanReadableByteSize(r/t))+"\nclasses:\n"+this.report("classes")+"\nexpressions:\n"+this.report("expressions")}},{key:"biggestObjectsOfType",value:function(e){return lively_lang.arr.sortBy(this.classes[e].objects.map(function(e){var r=slicedToArray(e,2),t=(r[0],r[1]);return JSON.stringify(t)}),function(e){return e.length}).reverse().map(function(e){return JSON.parse(e)})}},{key:"toCSV",value:function(){var e=["type,size,size in bytes,count,size per object,size perobject in bytes"];return this.sorted("classes").forEach(function(r){e.push([r.name,lively_lang.num.humanReadableByteSize(r.bytes),r.bytes,r.count,lively_lang.num.humanReadableByteSize(r.bytes/r.count),r.bytes/r.count].join(","))}),e.join("\n")}},{key:"findPathFromToId",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this.snapshot;return i.snapshot&&(i=i.snapshot),findPathFromToId$1(i,e,r,t)}},{key:"referenceGraph",value:function(){var e=this.snapshot;return e.snapshot&&(e=e.snapshot),referenceGraph$1(e)}},{key:"referenceCounts",value:function(){var e=lively_lang.graph.invert(this.referenceGraph()),r={};return Object.keys(e).forEach(function(t){return r[t]=e[t].length}),r}},{key:"lookupPath",value:function(e,r){var t=this.snapshot;return t.snapshot&&(t=t.snapshot),lookupPath$1(t,e,r)}},{key:"idsReferencingId",value:function(e){return lively_lang.graph.invert(this.referenceGraph())[e]}},{key:"modifyProperty",value:function(e,r,t){var i=this.snapshot;return i.snapshot&&(i=i.snapshot),modifyProperty$1(i,e,r,t)}},{key:"replaceReferencesTo",value:function(e,r){var t=lively_lang.graph.invert(this.referenceGraph())[e],i=!0,n=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=this.findPathFromToId(l,e);this.modifyProperty(l,u,r)}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}}},{key:"removeUnreachableObjects",value:function(e){var r=this.snapshot;if(e||(e=this.snapshot.id),!e)throw new Error("Cannot find root id");return r.snapshot&&(r=r.snapshot),removeUnreachableObjects$1([e],r)}},{key:"reportAboutObject",value:function(e,r,t){var i=this;r=r||this.referenceGraph();var n=((t=t||lively_lang.graph.invert(r))[e]||[]).map(function(r){return[r,i.findPathFromToId(r,e),i.explainId(r)]}),a=(r[e]||[]).map(function(r){return[r,i.findPathFromToId(e,r),i.explainId(r)]});return e+"\n is a "+this.explainId(e)+" object\n path from root: "+this.findPathFromToId(this.snapshot.id,e)+"\n references \n"+lively_lang.string.indent(lively_lang.string.printTable(a),"  ",2)+"\n referenced by:\n"+lively_lang.string.indent(lively_lang.string.printTable(n),"  ",2)+"\n"}},{key:"reportAboutObjects",value:function(e){var r=this,t=this.referenceGraph(),i=lively_lang.graph.invert(t);return e.map(function(e){return r.reportAboutObject(e,t,i)}).join("\n")}},{key:"rootObjectName",value:function(){var e="";if((r=this.snapshot).snapshot){var r,t=r.id;(r=r.snapshot)[t].props.name&&(e=r[t].props.name.value)}return e}},{key:"openSummary",value:function(){var e=this.rootObjectName();return $world.execCommand("open text window",{content:this.toString(),title:"serialization debug"+(e?" for "+e:""),fontFamily:"monospace"})}},{key:"openConnectionsList",value:function(){var e=this,r=this.rootObjectName(),t=((this.classes.AttributeConnection||{}).objects||[]).map(function(r){var t=slicedToArray(r,2),i=t[0],n=t[1].props,a=n.sourceObj,o=n.sourceAttrName,s=n.targetObj,l=n.targetMethodName;return e.explainId(a.value.id)+"."+o.value+" => "+e.explainId(s.value.id)+"."+l.value+"\n  "+a.value.id+" => "+s.value.id+"\n  connection id: "+i+"\n"}).join("\n");return $world.execCommand("open text window",{content:t,title:"serialized connections"+(r?" for "+r:""),fontFamily:"monospace"})}},{key:"openObjectReport",value:function(){var e=this.snapshot,r=this.rootObjectName();e.snapshot&&(e=e.snapshot),$world.execCommand("open text window",{title:"object report"+(r?" for "+r:""),content:this.reportAboutObjects(Object.keys(e)),fontFamily:"monospace"})}}]),e}(),ObjectGraphVisualizer=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,r);var t=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,_extends({draggable:!0},lively_lang.obj.dissoc(e,["snapshot"]))));return t.state={cy:null,snapshot:e.snapshot},lively_bindings.connect(t,"extent",t,"updateDebounced",{updater:function(e,r,t){return e()}}),t.update(),t}return inherits(r,e),createClass(r,null,[{key:"renderSnapshotAndOpen",value:function(e){var r=this.renderSnapshot(e);return r.openInWindow({title:"object graph visualizer"}),r}},{key:"renderSnapshot",value:function(e){return new this({snapshot:e})}}]),createClass(r,[{key:"cleanup",value:function(){this.html="",this.state.cy&&(this.state.cy.destroy(),this.state.cy=null)}},{key:"update",value:function(){var e=this;this.cleanup(),this.state.snapshot&&this.renderSnapshot(this.state.snapshot).catch(function(r){return e.showError(r)})}},{key:"updateDebounced",value:function(){var e=this;lively_lang.fun.debounceNamed("updateDebounced-"+this.id,100,function(){return e.update()})()}},{key:"renderSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,i,n,a,o,s,l,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.cleanup(),i=new SnapshotInspector(r),n=i.referenceGraph(),lively_lang.graph.invert(n),a=Object.keys(n).filter(function(e){return!!lively_lang.Path("props.submorphs").get(r[e])}),o=Object.keys(n).map(function(e){var t=r[e],n=lively_lang.string.truncate(i.explainId(e),20),o="",s=a.includes(e),l=t["lively.serializer-class-info"]&&t["lively.serializer-class-info"].className;return s&&"ListItemMorph"!==l&&(o="Morph "+l,n+="\n"+(lively_lang.Path("props.name.value").get(t)||"")),{group:"nodes",autounselectify:!0,data:{id:e,parent:void 0,label:n,snapshot:t},classes:o}}),s=lively_lang.arr.flatmap(Object.keys(n),function(e){return n[e].map(function(r){return{group:"edges",data:{source:e,target:r}}})}),e.next=9,System.import("https://cdn.rawgit.com/cytoscape/cytoscape.js/v2.7.15/dist/cytoscape.js");case 9:return l=e.sent,e.next=12,System.import("https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.0.5/cytoscape-cose-bilkent.js");case 12:return u=e.sent,l&&u&&u(l),c=this.state.cy=l((t={container:this.domNode,autoungrabify:!0,layout:{name:"spread"}},defineProperty(t,"layout",{name:"cose-bilkent",idealEdgeLength:50,numIter:2500,nodeRepulsion:45e3,animate:"end"}),defineProperty(t,"style",[{selector:"",style:{"active-bg-color":"#ccc","active-bg-opacity":.333}},{selector:"node",style:defineProperty({padding:10,"background-color":"#999","background-opacity":".5",width:"label",height:20,label:"data(label)","text-valign":"center","text-halign":"center","font-size":"10px",color:"#666",shape:"roundrectangle","text-wrap":"wrap","text-outline-color":"#666","text-outline-width":3,"text-outline-opacity":1},"color","white")},{selector:"node.Morph",style:{width:"label",height:"label","background-color":"#666","background-opacity":".3","font-size":"18px","text-outline-color":"#666","text-outline-width":3,"text-outline-opacity":1}},{selector:"edge",style:{width:4,"line-color":"#666","curve-style":"bezier","target-arrow-shape":"triangle"}},{selector:"edge:selected",style:{"line-color":"blue"}}]),defineProperty(t,"elements",o.concat(s)),t)),this.onDrag=function(e){var r=c.$(":active")[0];if(r){var t=e.positionIn(this),i=t.x,n=t.y;r.renderedPosition("x",i),r.renderedPosition("y",n)}},this.onMouseUp=function(e){var r=c.$("node:active")[0],t=c.$("edge:active")[0];r&&lively_morphic.inspect({id:r.data().id,snapshot:r.data().snapshot}),t&&this.setStatusMessage(i.findPathFromToId(t.data().source,t.data().target))},e.abrupt("return",this);case 18:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},{key:"snapshot",get:function(){return this.state.snapshot},set:function(e){this.state.snapshot=e,this.updateDebounced()}}]),r}(lively_morphic.HTMLMorph),CustomSerializePlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"serializeObject",value:function(e,r,t,i,n){if("function"!=typeof e.__serialize__)return null;var a=e.__serialize__(t,i,n);if(a&&a.hasOwnProperty("__expr__")){var o=t.expressionSerializer.exprStringEncode(a);a=r?o:{__expr__:o}}return a}},{key:"deserializeObject",value:function(e,r,t,i){var n=t.__expr__;return n?e.expressionSerializer.deserializeExpr(n):null}}]),e}(),ClassPlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"additionallySerialize",value:function(e,r,t,i){e.classHelper.addClassInfo(r,r.realObj,t)}},{key:"deserializeObject",value:function(e,r,t,i){return e.classHelper.restoreIfClassInstance(r,t)}}]),e}(),AdditionallySerializePlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"additionallySerialize",value:function(e,r,t,i){var n=r.realObj;n&&"function"==typeof n.__additionally_serialize__&&n.__additionally_serialize__(t,r,e,i)}},{key:"additionallyDeserializeBeforeProperties",value:function(e,r,t,i,n,a,o){"function"==typeof t.__deserialize__&&t.__deserialize__(n,r,a,e,o)}},{key:"additionallyDeserializeAfterProperties",value:function(e,r,t,i,n,a){"function"==typeof t.__after_deserialize__&&t.__after_deserialize__(i,r)}}]),e}(),OnlySerializePropsPlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"propertiesToSerialize",value:function(e,r,t,i){var n=r.realObj;return n&&n.__only_serialize__||null}}]),e}(),DontSerializePropsPlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"propertiesToSerialize",value:function(e,r,t,i){var n=r.realObj;if(!n||!n.__dont_serialize__)return null;for(var a=lively_lang.obj.mergePropertyInHierarchy(n,"__dont_serialize__"),o=[],s=0;s<i.length;s++){var l=i[s];a.includes(l)||o.push(l)}return o}}]),e}(),LivelyClassPropertiesPlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"propertiesToSerialize",value:function(e,r,t,i){var n=r.realObj,a=n.constructor[Symbol.for("lively.classes-properties-and-settings")];if(!a)return null;var o=a.properties,s=a.propertySettings.valueStoreProperty||"_state",l=n[s],u=!!n.__only_serialize__,c=[];if(l){if(u){for(var p=0;p<i.length;p++){var f=i[p],h=o[f];f!==s&&(h&&h&&(h.derived||h.readOnly||h.hasOwnProperty("serialize")&&!h.serialize)||c.push(f))}return c}var y=i.indexOf(s);for(var d in y>-1&&i.splice(y,1),o){var v=o[d],g=i.indexOf(d);v.derived||v.readOnly||v.hasOwnProperty("serialize")&&!v.serialize?g>-1&&i.splice(g,1):-1===g&&c.push(d)}return c.concat(i)}}},{key:"additionallyDeserializeBeforeProperties",value:function(e,r,t,i,n,a,o){var s=t.constructor[Symbol.for("lively.classes-properties-and-settings")];if(!s)return i;var l=s.properties,u=s.propertySettings.valueStoreProperty||"_state";if((i=n.props)[u])return i;i=lively_lang.obj.clone(i),t.hasOwnProperty(u)||t.initializeProperties();t[u];for(var c=lively_lang.obj.sortKeysWithBeforeAndAfterConstraints(l),p=0;p<c.length;p++){var f=c[p];l[f];i.hasOwnProperty(f)&&(r.recreatePropertyAndSetProperty(t,i,f,a,e,o),delete i[f])}return i}}]),e}(),LeakDetectorPlugin=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"afterSerialization",value:function(e,r,t){var i=SnapshotInspector.forPoolAndSnapshot(r,e),n=new Set([].concat(toConsumableArray((i.classes.AttributeConnection||{objects:[]}).objects),toConsumableArray((i.classes["{source, target}"]||{objects:[]}).objects),toConsumableArray((i.classes["{_rev, source, target}"]||{objects:[]}).objects)).map(function(e){return e[0]})),a=i.referenceGraph(),o=lively_lang.graph.invert(a),s=lively_lang.arr.compact(lively_lang.arr.flatten(Object.entries(o).filter(function(e){var t=slicedToArray(e,2),i=t[0],a=t[1];return a.length<3&&r.id!=i&&!n.has(i)&&a.every(function(e){return n.has(e)})}).map(function(r){var t=slicedToArray(r,1)[0],i=lively_lang.graph.subgraphReachableBy(a,t),n=e.resolveToObj(t);if(Object.keys(i).length>1)return lively_lang.arr.compact(o[t].map(function(r){var t=e.resolveToObj(r);if("AttributeConnection"===t.constructor.name)return t})).map(function(e){return{conn:e,obj:n}})})));return s.length>0&&(this.memoryLeaks=s),r}}]),e}(),plugins={livelyClassPropertiesPlugin:new LivelyClassPropertiesPlugin,dontSerializePropsPlugin:new DontSerializePropsPlugin,onlySerializePropsPlugin:new OnlySerializePropsPlugin,additionallySerializePlugin:new AdditionallySerializePlugin,classPlugin:new ClassPlugin,customSerializePlugin:new CustomSerializePlugin},allPlugins=[plugins.customSerializePlugin,plugins.classPlugin,plugins.additionallySerializePlugin,plugins.onlySerializePropsPlugin,plugins.dontSerializePropsPlugin,plugins.livelyClassPropertiesPlugin],debugSerialization=!1,debugDeserialization=!1,ObjectPool=function(){function e(r){classCallCheck(this,e),this.options=_extends({checkForLeaks:!1,ignoreClassNotFound:!0,idPropertyName:"id"},r),this.reset()}return createClass(e,null,[{key:"withDefaultPlugins",value:function(e){return new this(_extends({plugins:allPlugins},e))}},{key:"resolveFromSnapshotAndId",value:function(e,r){return new this(r).resolveFromSnapshotAndId(e)}},{key:"fromSnapshot",value:function(e,r){return new this(r).readSnapshot(e)}},{key:"withObject",value:function(e,r){var t=new this(r);return t.add(e),t}}]),createClass(e,[{key:"reset",value:function(){this.uuidGen=lively_lang.string.newUUID,this._obj_ref_map=new Map,this._id_ref_map={};var e=this.options;this.classHelper=new ClassHelper(e),this.expressionSerializer=new ExpressionSerializer,e.idPropertyName&&(this.idPropertyName=e.idPropertyName),e.uuidGen&&(this.uuidGen=e.uuidGen),e.reinitializeIds&&(this.reinitializeIds=e.reinitializeIds),e.hasOwnProperty("ignoreClassNotFound")&&(this.classHelper.options.ignoreClassNotFound=e.ignoreClassNotFound);var r=this.plugins={serializeObject:[],additionallySerialize:[],propertiesToSerialize:[],deserializeObject:[],additionallyDeserializeBeforeProperties:[],additionallyDeserializeAfterProperties:[],afterDeserialization:[],beforeDeserialization:[],afterSerialization:[],beforeSerialization:[]};e.plugins&&e.plugins.forEach(function(e){"function"==typeof e.serializeObject&&r.serializeObject.push(e),"function"==typeof e.additionallySerialize&&r.additionallySerialize.push(e),"function"==typeof e.propertiesToSerialize&&r.propertiesToSerialize.push(e),"function"==typeof e.deserializeObject&&r.deserializeObject.push(e),"function"==typeof e.additionallyDeserializeBeforeProperties&&r.additionallyDeserializeBeforeProperties.push(e),"function"==typeof e.additionallyDeserializeAfterProperties&&r.additionallyDeserializeAfterProperties.push(e),"function"==typeof e.beforeDeserialization&&r.beforeDeserialization.push(e),"function"==typeof e.afterDeserialization&&r.afterDeserialization.push(e),"function"==typeof e.beforeSerialization&&r.beforeSerialization.push(e),"function"==typeof e.afterSerialization&&r.afterSerialization.push(e)})}},{key:"knowsId",value:function(e){return!!this._id_ref_map[e]}},{key:"refForId",value:function(e){return this._id_ref_map[e]}},{key:"resolveToObj",value:function(e){var r=this._id_ref_map[e];return r?r.realObj:void 0}},{key:"ref",value:function(e){return this._obj_ref_map.get(e)}},{key:"objects",value:function(){return Array.from(this._obj_ref_map.keys())}},{key:"objectRefs",value:function(){return Array.from(this._obj_ref_map.values())}},{key:"internalAddRef",value:function(e){return e.realObj&&this._obj_ref_map.set(e.realObj,e),this._id_ref_map[e.id]=e,e}},{key:"add",value:function(e){var r=this;if(!isPrimitive(e)){if(Array.isArray(e))return e.map(function(e){return r.add(e)});var t=e.__serialization_id_property__||this.idPropertyName;return this.ref(e)||this.internalAddRef(new ObjectRef(e[t]||this.uuidGen(),e,void 0,this.idPropertyName))}}},{key:"snapshot",value:function(e){var r={};this.plugin_beforeSerialization(r,e);for(var t=0,i=Object.keys(this._id_ref_map);t<i.length;t++){this._id_ref_map[i[t]].snapshotObject(r,this)}return r=this.plugin_afterSerialization(r,e),r}},{key:"snapshotObject",value:function(e){var r=this.add(e).id;return{id:r,snapshot:this.snapshot(r)}}},{key:"readSnapshot",value:function(e,r){if(e.hasOwnProperty("id"))throw new Error("readSnapshot expects simple serialized object map, not id-snapshot pair!");if(this.options.skipMigrations)ObjectRef.fromSnapshot(r,e,this,[],this.idPropertyName);else for(var t=0,i=Object.keys(e);t<i.length;t++)this.resolveToObj(i[t])||ObjectRef.fromSnapshot(i[t],e,this,[],this.idPropertyName);return this}},{key:"resolveFromSnapshotAndId",value:function(e){if(!e.hasOwnProperty("id"))throw new Error("idAndSnapshot does not have id");if(!e.hasOwnProperty("snapshot"))throw new Error("idAndSnapshot does not have snapshot");var r=e=this.plugin_beforeDeserialization(e),t=r.id,i=r.snapshot;return this.readSnapshot(i,t),this.plugin_afterDeserialization(e),this.resolveToObj(t)}},{key:"plugin_beforeSerialization",value:function(e,r){for(var t=0;t<this.plugins.beforeSerialization.length;t++){this.plugins.beforeSerialization[t].beforeSerialization(this,e,r)}}},{key:"plugin_afterSerialization",value:function(e,r){for(var t=0;t<this.plugins.afterSerialization.length;t++){var i=this.plugins.afterSerialization[t].afterSerialization(this,e,r);i&&(e=i)}return e}},{key:"plugin_beforeDeserialization",value:function(e){for(var r=0;r<this.plugins.beforeDeserialization.length;r++){var t=this.plugins.beforeDeserialization[r].beforeDeserialization(this,e);t&&(e=t)}return e}},{key:"plugin_afterDeserialization",value:function(e){for(var r=0;r<this.plugins.afterDeserialization.length;r++){this.plugins.afterDeserialization[r].afterDeserialization(this,e)}}},{key:"plugin_serializeObject",value:function(e,r,t,i){for(var n=0;n<this.plugins.serializeObject.length;n++){var a=this.plugins.serializeObject[n].serializeObject(e,r,this,t,i);if(a)return a}}},{key:"plugin_propertiesToSerialize",value:function(e,r,t){for(var i=0;i<this.plugins.propertiesToSerialize.length;i++){var n=this.plugins.propertiesToSerialize[i].propertiesToSerialize(this,e,r,t);n&&(t=n)}return t}},{key:"plugin_additionallySerialize",value:function(e,r,t,i){for(var n=this.plugins.additionallySerialize.length?__additionally_serialize__addObjectFunction(e,r,t,this,i):null,a=0;a<this.plugins.additionallySerialize.length;a++){this.plugins.additionallySerialize[a].additionallySerialize(this,e,r,n)}}},{key:"plugin_deserializeObject",value:function(e,r,t){for(var i=0;i<this.plugins.deserializeObject.length;i++){var n=this.plugins.deserializeObject[i].deserializeObject(this,e,r,t);if(n)return n}}},{key:"plugin_additionallyDeserializeBeforeProperties",value:function(e,r,t,i,n,a){for(var o=0;o<this.plugins.additionallyDeserializeBeforeProperties.length;o++){var s=this.plugins.additionallyDeserializeBeforeProperties[o].additionallyDeserializeBeforeProperties(this,e,r,t,i,n,a);s&&(t=s)}return t}},{key:"plugin_additionallyDeserializeAfterProperties",value:function(e,r,t,i,n){for(var a=0;a<this.plugins.additionallyDeserializeAfterProperties.length;a++){this.plugins.additionallyDeserializeAfterProperties[a].additionallyDeserializeAfterProperties(this,e,r,t,i,n)}}}]),e}();function __additionally_serialize__addObjectFunction(e,r,t,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];return function(a,o){var s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return r.props[a]=s?{key:a,value:o,verbatim:s}:{key:a,value:e.snapshotProperty(e.id,o,n.concat([a]),t,i)}}}var ObjectRef=function(){function e(r,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"id";if(classCallCheck(this,e),this.id=r,this.idPropertyName=n,this.realObj=t,this.snapshotVersions=[],this.snapshots={},i){var a=i.rev||0;this.snapshotVersions.push(a),this.snapshots[a]=i}}return createClass(e,null,[{key:"fromSnapshot",value:function(e,r,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],n=new this(e,void 0,void 0,arguments[4]);return t.internalAddRef(n).recreateObjFromSnapshot(r,t,i)}}]),createClass(e,[{key:"asRefForSerializedObjMap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"????";return{__ref__:!0,id:this.id,rev:e}}},{key:"snapshotObject",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(debugSerialization&&console.log("[serialize] "+t.join(".")),t.length>100)throw new Error("Stopping serializer, encountered a possibly infinit loop: "+t.join("."));var i,n,a=this.id,o=this.realObj,s=this.snapshots;if(!o)return console.error("Cannot marshall object ref "+a+", no real object!"),_extends({},this.asRefForSerializedObjMap(),{isMissing:!0});if(i=o._rev||0,n=this.asRefForSerializedObjMap(i),lively_lang.arr.pushIfNotIncluded(this.snapshotVersions,i),s[i])return e[a]||(e[a]=s[i]),n;var l=void 0===a?"undefined":_typeof(a);if("number"===l&&(a=String(a),l="string"),"string"!==l)throw new Error("Error snapshoting "+o+": id is not a string but "+a+" (serialization path: "+t.join(".")+")");var u=r.plugin_serializeObject(o,!1,e,t);if(u)return s[i]=e[a]=u,n;var c=Object.getOwnPropertyNames(o),p={},f=s[i]=e[a]={rev:i,props:p},h=r.plugin_propertiesToSerialize(this,f,c);h&&(c=h);for(var y=0;y<c.length;y++){var d=c[y];p[d]={key:d,value:this.snapshotProperty(a,o[d],t.concat([d]),e,r)}}return r.plugin_additionallySerialize(this,f,e,t),n}},{key:"snapshotProperty",value:function(e,r,t,i,n){var a=this;if(isPrimitive(r))return r;var o=n.plugin_serializeObject(r,!0,i,t);if(o)return o;if("function"!=typeof r){if(Array.isArray(r))return r.map(function(r,o){return a.snapshotProperty(e,r,t.concat(o),i,n)});var s=n.add(r);return s&&s.isObjectRef?s.snapshotObject(i,n,t):s}}},{key:"recreateObjFromSnapshot",value:function(e,r,t){if(this.realObj)return this;debugDeserialization&&console.log("[deserialize] "+this.id+" (via "+t.join(".")+")");var i=e[this.id];if(!i)return console.error("Cannot recreateObjFromSnapshot ObjectRef "+this.id+" b/c of missing snapshot in snapshot map!"),this;var n=i.rev,a=void 0;if(n=n||0,this.snapshotVersions.push(n),this.snapshots[n]=i,(a=r.plugin_deserializeObject(this,i,t))||(a={}),void 0===a._rev&&"object"===(void 0===a?"undefined":_typeof(a))&&(a._rev=n||0),this.realObj=a,r.internalAddRef(this),!a)return this;var o=i.props,s=r.plugin_additionallyDeserializeBeforeProperties(this,a,o,i,e,t);if(s&&(o=s),o)for(var l in o)this.recreatePropertyAndSetProperty(a,o,l,e,r,t);var u=a.__serialization_id_property__||this.idPropertyName;return r.reinitializeIds&&a.hasOwnProperty(u)&&(a[u]=r.reinitializeIds(this.id,this)),r.plugin_additionallyDeserializeAfterProperties(this,a,i,e,t),this}},{key:"recreatePropertyAndSetProperty",value:function(e,r,t,i,n,a){try{var o=r[t]||{value:"NON EXISTING"},s=o.verbatim,l=o.value;e[t]=s?l:this.recreateProperty(t,l,i,n,a.concat(t))}catch(r){var u;try{u=String(e)}catch(r){u="[some "+e.constructor.name+"]"}if(r.__seen)console.error("Error deserializing property "+t+" of "+u);else{var c=t+" of "+u+" ("+JSON.stringify(l)+")";console.error("Error deserializing property "+c),r.__seen=!0}throw r}}},{key:"recreateProperty",value:function(r,t,i,n,a){var o=this;if("string"==typeof t&&n.expressionSerializer.isSerializedExpression(t))return n.expressionSerializer.deserializeExpr(t);if(isPrimitive(t))return t;if(Array.isArray(t))return t.map(function(e,r){return o.recreateProperty(r,e,i,n,a.concat(r))});var s=t.__serialization_id_property__||this.idPropertyName;return(n.refForId(t[s])||e.fromSnapshot(t[s],i,n,a,this.idPropertyName)).realObj}},{key:"isObjectRef",get:function(){return!0}},{key:"currentSnapshot",get:function(){var e=void 0;return this.snapshotVersions.length?e=lively_lang.arr.last(this.snapshotVersions):(e=0,this.snapshotVersions.push(e)),this.snapshots[e]||(this.snapshots[e]={rev:e,props:{}})}},{key:"currentRev",get:function(){return this.snapshotVersions.length?lively_lang.arr.last(this.snapshotVersions):0}}]),e}(),_name$version$depende={name:"lively.serializer2",version:"0.1.3",dependencies:{"lively.lang":"^1.0.5",semver:"^5.3.0"},devDependencies:{"mocha-es6":"*",rollup:"^0.36.1","rollup-plugin-babel":"^2.6.1","babel-plugin-external-helpers":"^6.8.0","babel-plugin-syntax-object-rest-spread":"^6.13.0","babel-plugin-transform-async-to-generator":"^6.16.0","babel-plugin-transform-object-rest-spread":"^6.16.0","babel-preset-es2015":"^6.16.0","babel-preset-es2015-rollup":"^1.1.1","babel-regenerator-runtime":"^6.5.0","babel-plugin-inline-json-import":"^0.2.1","uglify-es":"^3.3.9"},scripts:{test:"mocha-es6 tests/{test,*-test}.js",build:"node build.js"}},serializerVersion=_name$version$depende.version;function normalizeOptions(e){if((e=_extends({plugins:allPlugins,reinitializeIds:!1,skipMigrations:!0},e)).reinitializeIds&&"function"!=typeof e.reinitializeIds)throw new Error("serializer option 'reinitializeIds' needs to be a function(id, ref) => id");return e}function normalizeMigrations(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return{before:e.filter(function(e){return"function"==typeof e.snapshotConverter}),after:e.filter(function(e){return"function"==typeof e.objectConverter})}}function runMigrations(e,r,t,i){for(var n=0;n<e.length;n++){var a=e[n];try{t=a[r](t,i)}catch(e){console.error("migration "+a.name+" failed:"),console.error(e)}}return t}var majorAndMinorVersionRe=/\.[^\.]+$/;function serialize(e,r){var t=(r=normalizeOptions(r)).objPool||new ObjectPool(r),i="~"+serializerVersion.replace(majorAndMinorVersionRe,""),n=t.snapshotObject(e);return removeUnreachableObjects$1([n.id],n.snapshot),n.requiredVersion=i,n}function deserialize(e,r){r=normalizeOptions(r);var t=e.requiredVersion;return t&&!semver.satisfies(serializerVersion,t)&&console.warn("[lively.serializer deserialization] snapshot requires version "+t+" but serializer has incompatible version "+serializerVersion+". Deserialization might fail...!"),(r.objPool||new ObjectPool(r)).resolveFromSnapshotAndId(e)}function deserializeWithMigrations(e,r,t){t=normalizeOptions(t),r.length&&(t.skipMigrations=!1);var i=t.objPool||(t.objPool=new ObjectPool(t)),n=normalizeMigrations(r),a=n.before,o=n.after,s=void 0;return runMigrations(a,"snapshotConverter",e,i),"function"==typeof t.onDeserializationStart&&(s=t.onDeserializationStart(e,t)),s instanceof Promise?s.then(l):l();function l(){var r=deserialize(e,t);return runMigrations(o,"objectConverter",e,i),r}}function copy(e,r){return deserialize(serialize(e,r),r)}exports.serialize=serialize,exports.deserialize=deserialize,exports.deserializeWithMigrations=deserializeWithMigrations,exports.copy=copy,exports.ExpressionSerializer=ExpressionSerializer,exports.ObjectRef=ObjectRef,exports.ObjectPool=ObjectPool,exports.requiredModulesOfSnapshot=requiredModulesOfSnapshot,exports.removeUnreachableObjects=removeUnreachableObjects$1}(this.lively.serializer2=this.lively.serializer2||{},lively.lang,{HTMLMorph:null},lively.bindings,semver),"undefined"!=typeof module&&module.exports&&(module.exports=GLOBAL.lively.serializer2)}();
//LIVELY.MORPHIC - 1MB
!function(e,t){var n={},r={};!function(n,a){function d(){this._delay=0,this._endDelay=0,this._fill="none",this._iterationStart=0,this._iterations=1,this._duration=0,this._playbackRate=1,this._direction="normal",this._easing="linear",this._easingFunction=_}function e(){return n.isDeprecated("Invalid timing inputs","2016-03-02","TypeError exceptions will be thrown instead.",!0)}function f(e,t,r){var i=new d;return t&&(i.fill="both",i.duration="auto"),"number"!=typeof e||isNaN(e)?void 0!==e&&Object.getOwnPropertyNames(e).forEach(function(t){if("auto"!=e[t]){if(("number"==typeof i[t]||"duration"==t)&&("number"!=typeof e[t]||isNaN(e[t])))return;if("fill"==t&&-1==v.indexOf(e[t]))return;if("direction"==t&&-1==y.indexOf(e[t]))return;if("playbackRate"==t&&1!==e[t]&&n.isDeprecated("AnimationEffectTiming.playbackRate","2014-11-28","Use Animation.playbackRate instead."))return;i[t]=e[t]}}):i.duration=e,i}function i(e,t,n,r){return e<0||e>1||n<0||n>1?_:function(i){function f(e,t,n){return 3*e*(1-n)*(1-n)*n+3*t*(1-n)*n*n+n*n*n}if(i<=0){var o=0;return e>0?o=t/e:!t&&n>0&&(o=r/n),o*i}if(i>=1){var a=0;return n<1?a=(r-1)/(n-1):1==n&&e<1&&(a=(t-1)/(e-1)),1+a*(i-1)}for(var s=0,l=1;s<l;){var c=(s+l)/2,u=f(e,n,c);if(Math.abs(i-u)<1e-5)return f(t,r,c);u<i?s=c:l=c}return f(t,r,c)}}function j(e,t){return function(n){if(n>=1)return 1;var r=1/e;return(n+=t*r)-n%r}}function k(t){C||(C=document.createElement("div").style),C.animationTimingFunction="",C.animationTimingFunction=t;var n=C.animationTimingFunction;if(""==n&&e())throw new TypeError(t+" is not a valid value for easing");return n}function l(e){if("linear"==e)return _;var t=T.exec(e);if(t)return i.apply(this,t.slice(1).map(Number));var n=P.exec(e);return n?j(Number(n[1]),{start:b,middle:x,end:w}[n[2]]):S[e]||_}function o(e,t,n){if(null==t)return A;var r=n.delay+e+n.endDelay;return t<Math.min(n.delay,r)?L:t>=Math.min(n.delay+e,r)?R:E}var v="backwards|forwards|both|none".split("|"),y="reverse|alternate|alternate-reverse".split("|"),_=function(e){return e};d.prototype={_setMember:function(e,t){this["_"+e]=t,this._effect&&(this._effect._timingInput[e]=t,this._effect._timing=n.normalizeTimingInput(this._effect._timingInput),this._effect.activeDuration=n.calculateActiveDuration(this._effect._timing),this._effect._animation&&this._effect._animation._rebuildUnderlyingAnimation())},get playbackRate(){return this._playbackRate},set delay(e){this._setMember("delay",e)},get delay(){return this._delay},set endDelay(e){this._setMember("endDelay",e)},get endDelay(){return this._endDelay},set fill(e){this._setMember("fill",e)},get fill(){return this._fill},set iterationStart(t){if((isNaN(t)||t<0)&&e())throw new TypeError("iterationStart must be a non-negative number, received: "+timing.iterationStart);this._setMember("iterationStart",t)},get iterationStart(){return this._iterationStart},set duration(t){if("auto"!=t&&(isNaN(t)||t<0)&&e())throw new TypeError("duration must be non-negative or auto, received: "+t);this._setMember("duration",t)},get duration(){return this._duration},set direction(e){this._setMember("direction",e)},get direction(){return this._direction},set easing(e){this._easingFunction=l(k(e)),this._setMember("easing",e)},get easing(){return this._easing},set iterations(t){if((isNaN(t)||t<0)&&e())throw new TypeError("iterations must be non-negative, received: "+t);this._setMember("iterations",t)},get iterations(){return this._iterations}};var b=1,x=.5,w=0,S={ease:i(.25,.1,.25,1),"ease-in":i(.42,0,1,1),"ease-out":i(0,0,.58,1),"ease-in-out":i(.42,0,.58,1),"step-start":j(1,b),"step-middle":j(1,x),"step-end":j(1,w)},C=null,M="\\s*(-?\\d+\\.?\\d*|-?\\.\\d+)\\s*",T=new RegExp("cubic-bezier\\("+M+","+M+","+M+","+M+"\\)"),P=/steps\(\s*(\d+)\s*,\s*(start|middle|end)\s*\)/,A=0,L=1,R=2,E=3;n.cloneTimingInput=function c(e){if("number"==typeof e)return e;var t={};for(var n in e)t[n]=e[n];return t},n.makeTiming=f,n.numericTimingToObject=function g(e){return"number"==typeof e&&(e=isNaN(e)?{duration:0}:{duration:e}),e},n.normalizeTimingInput=function h(e,t){return f(e=n.numericTimingToObject(e),t)},n.calculateActiveDuration=function m(e){return Math.abs(function n(e){return 0===e.duration||0===e.iterations?0:e.duration*e.iterations}(e)/e.playbackRate)},n.calculateIterationProgress=function u(e,n,i){var a=o(e,n,i),l=function p(e,t,n,r,i){switch(r){case L:return"backwards"==t||"both"==t?0:null;case E:return n-i;case R:return"forwards"==t||"both"==t?e:null;case A:return null}}(e,i.fill,n,a,i.delay);if(null===l)return null;var c=function q(e,t,n,r,i){var o=i;return 0===e?t!==L&&(o+=n):o+=r/e,o}(i.duration,a,i.iterations,l,i.iterationStart),u=function r(e,t,n,i,o,a){var s=e===1/0?t%1:e%1;return 0!==s||n!==R||0===i||0===o&&0!==a||(s=1),s}(c,i.iterationStart,a,i.iterations,l,i.duration),h=function s(e,t,n,r){return e===R&&t===1/0?1/0:1===n?Math.floor(r)-1:Math.floor(r)}(a,i.iterations,u,c),d=function t(e,n,r){var i=e;if("normal"!==e&&"reverse"!==e){var o=n;"alternate-reverse"===e&&(o+=1),i="normal",o!==1/0&&o%2!=0&&(i="reverse")}return"normal"===i?r:1-r}(i.direction,h,u);return i._easingFunction(d)},n.calculatePhase=o,n.normalizeEasing=k,n.parseEasingFunction=l}(n),function(t,n){function c(e,t){return e in a&&a[e][t]||t}function e(e,t,n){if(!function d(e){return"display"===e||0===e.lastIndexOf("animation",0)||0===e.lastIndexOf("transition",0)}(e)){var o=r[e];if(o)for(var a in i.style[e]=t,o){var s=o[a],l=i.style[s];n[s]=c(s,l)}else n[e]=c(e,t)}}function f(e){var t=[];for(var n in e)if(!(n in["easing","offset","composite"])){var r=e[n];Array.isArray(r)||(r=[r]);for(var i,o=r.length,a=0;a<o;a++)(i={}).offset="offset"in e?e.offset:1==o?1:a/(o-1),"easing"in e&&(i.easing=e.easing),"composite"in e&&(i.composite=e.composite),i[n]=r[a],t.push(i)}return t.sort(function(e,t){return e.offset-t.offset}),t}var r={background:["backgroundImage","backgroundPosition","backgroundSize","backgroundRepeat","backgroundAttachment","backgroundOrigin","backgroundClip","backgroundColor"],border:["borderTopColor","borderTopStyle","borderTopWidth","borderRightColor","borderRightStyle","borderRightWidth","borderBottomColor","borderBottomStyle","borderBottomWidth","borderLeftColor","borderLeftStyle","borderLeftWidth"],borderBottom:["borderBottomWidth","borderBottomStyle","borderBottomColor"],borderColor:["borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"],borderLeft:["borderLeftWidth","borderLeftStyle","borderLeftColor"],borderRadius:["borderTopLeftRadius","borderTopRightRadius","borderBottomRightRadius","borderBottomLeftRadius"],borderRight:["borderRightWidth","borderRightStyle","borderRightColor"],borderTop:["borderTopWidth","borderTopStyle","borderTopColor"],borderWidth:["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"],flex:["flexGrow","flexShrink","flexBasis"],font:["fontFamily","fontSize","fontStyle","fontVariant","fontWeight","lineHeight"],margin:["marginTop","marginRight","marginBottom","marginLeft"],outline:["outlineColor","outlineStyle","outlineWidth"],padding:["paddingTop","paddingRight","paddingBottom","paddingLeft"]},i=document.createElementNS("http://www.w3.org/1999/xhtml","div"),o={thin:"1px",medium:"3px",thick:"5px"},a={borderBottomWidth:o,borderLeftWidth:o,borderRightWidth:o,borderTopWidth:o,fontSize:{"xx-small":"60%","x-small":"75%",small:"89%",medium:"100%",large:"120%","x-large":"150%","xx-large":"200%"},fontWeight:{normal:"400",bold:"700"},outlineWidth:o,textShadow:{none:"0px 0px 0px transparent"},boxShadow:{none:"0px 0px 0px 0px transparent"}};t.convertToArrayForm=f,t.normalizeKeyframes=function g(n){if(null==n)return[];window.Symbol&&Symbol.iterator&&Array.prototype.from&&n[Symbol.iterator]&&(n=Array.from(n)),Array.isArray(n)||(n=f(n));for(var r=n.map(function(n){var r={};for(var i in n){var o=n[i];if("offset"==i){if(null!=o){if(o=Number(o),!isFinite(o))throw new TypeError("Keyframe offsets must be numbers.");if(o<0||o>1)throw new TypeError("Keyframe offsets must be between 0 and 1.")}}else if("composite"==i){if("add"==o||"accumulate"==o)throw{type:DOMException.NOT_SUPPORTED_ERR,name:"NotSupportedError",message:"add compositing is not supported"};if("replace"!=o)throw new TypeError("Invalid composite mode "+o+".")}else o="easing"==i?t.normalizeEasing(o):""+o;e(i,o,r)}return void 0==r.offset&&(r.offset=null),void 0==r.easing&&(r.easing="linear"),r}),i=!0,o=-1/0,a=0;a<r.length;a++){var s=r[a].offset;if(null!=s){if(s<o)throw new TypeError("Keyframes are not loosely sorted by offset. Sort or specify offsets.");o=s}else i=!1}return r=r.filter(function(e){return e.offset>=0&&e.offset<=1}),i||function c(){var e=r.length;null==r[e-1].offset&&(r[e-1].offset=1),e>1&&null==r[0].offset&&(r[0].offset=0);for(var t=0,n=r[0].offset,i=1;i<e;i++){var o=r[i].offset;if(null!=o){for(var a=1;a<i-t;a++)r[t+a].offset=n+(o-n)*a/(i-t);t=i,n=o}}}(),r}}(n),function(e){var t={};e.isDeprecated=function(e,n,r,i){var o=i?"are":"is",a=new Date,s=new Date(n);return s.setMonth(s.getMonth()+3),!(a<s&&(e in t||console.warn("Web Animations: "+e+" "+o+" deprecated and will stop working on "+s.toDateString()+". "+r),t[e]=!0,1))},e.deprecated=function(t,n,r,i){var o=i?"are":"is";if(e.isDeprecated(t,n,r,i))throw new Error(t+" "+o+" no longer supported. "+r)}}(n),function(){if(document.documentElement.animate){var e=document.documentElement.animate([],0),t=!0;if(e&&(t=!1,"play|currentTime|pause|reverse|playbackRate|cancel|finish|startTime|playState".split("|").forEach(function(n){void 0===e[n]&&(t=!0)})),!t)return}!function(t,n,r){n.convertEffectInput=function(r){var i=function d(e){for(var t={},n=0;n<e.length;n++)for(var r in e[n])if("offset"!=r&&"easing"!=r&&"composite"!=r){var i={offset:e[n].offset,easing:e[n].easing,value:e[n][r]};t[r]=t[r]||[],t[r].push(i)}for(var o in t){var a=t[o];if(0!=a[0].offset||1!=a[a.length-1].offset)throw{type:DOMException.NOT_SUPPORTED_ERR,name:"NotSupportedError",message:"Partial keyframes are not supported"}}return t}(t.normalizeKeyframes(r)),o=function e(r){var i=[];for(var o in r)for(var a=r[o],s=0;s<a.length-1;s++){var l=s,c=s+1,u=a[l].offset,h=a[c].offset,d=u,p=h;0==s&&(d=-1/0,0==h&&(c=l)),s==a.length-2&&(p=1/0,1==u&&(l=c)),i.push({applyFrom:d,applyTo:p,startOffset:a[l].offset,endOffset:a[c].offset,easingFunction:t.parseEasingFunction(a[l].easing),property:o,interpolation:n.propertyInterpolation(o,a[l].value,a[c].value)})}return i.sort(function(e,t){return e.startOffset-t.startOffset}),i}(i);return function(e,t){if(null!=t)o.filter(function(e){return t>=e.applyFrom&&t<e.applyTo}).forEach(function(r){var i=t-r.startOffset,o=r.endOffset-r.startOffset,a=0==o?0:r.easingFunction(i/o);n.apply(e,r.property,r.interpolation(a))});else for(var r in i)"offset"!=r&&"easing"!=r&&"composite"!=r&&n.clear(e,r)}}}(n,r),function(t,n,r){function d(e){return e.replace(/-(.)/g,function(e,t){return t.toUpperCase()})}function e(e,t,n){i[n]=i[n]||[],i[n].push([e,t])}var i={};n.addPropertiesHandler=function f(t,n,r){for(var i=0;i<r.length;i++)e(t,n,d(r[i]))};var o={backgroundColor:"transparent",backgroundPosition:"0% 0%",borderBottomColor:"currentColor",borderBottomLeftRadius:"0px",borderBottomRightRadius:"0px",borderBottomWidth:"3px",borderLeftColor:"currentColor",borderLeftWidth:"3px",borderRightColor:"currentColor",borderRightWidth:"3px",borderSpacing:"2px",borderTopColor:"currentColor",borderTopLeftRadius:"0px",borderTopRightRadius:"0px",borderTopWidth:"3px",bottom:"auto",clip:"rect(0px, 0px, 0px, 0px)",color:"black",fontSize:"100%",fontWeight:"400",height:"auto",left:"auto",letterSpacing:"normal",lineHeight:"120%",marginBottom:"0px",marginLeft:"0px",marginRight:"0px",marginTop:"0px",maxHeight:"none",maxWidth:"none",minHeight:"0px",minWidth:"0px",opacity:"1.0",outlineColor:"invert",outlineOffset:"0px",outlineWidth:"3px",paddingBottom:"0px",paddingLeft:"0px",paddingRight:"0px",paddingTop:"0px",right:"auto",strokeDasharray:"none",strokeDashoffset:"0px",textIndent:"0px",textShadow:"0px 0px 0px transparent",top:"auto",transform:"",verticalAlign:"0px",visibility:"visible",width:"auto",wordSpacing:"normal",zIndex:"auto"};n.propertyInterpolation=function g(e,r,a){var s=e;/-/.test(e)&&!t.isDeprecated("Hyphenated property names","2016-03-22","Use camelCase instead.",!0)&&(s=d(e)),"initial"!=r&&"initial"!=a||("initial"==r&&(r=o[s]),"initial"==a&&(a=o[s]));for(var l=r==a?[]:i[s],c=0;l&&c<l.length;c++){var u=l[c][0](r),h=l[c][0](a);if(void 0!==u&&void 0!==h){var p=l[c][1](u,h);if(p){var f=n.Interpolation.apply(null,p);return function(e){return 0==e?r:1==e?a:f(e)}}}}return n.Interpolation(!1,!0,function(e){return e?a:r})}}(n,r),function(e,t,n){t.KeyframeEffect=function(n,r,i,o){var a,s=function d(t){var n=e.calculateActiveDuration(t),r=function(r){return e.calculateIterationProgress(n,r,t)};return r._totalDuration=t.delay+n+t.endDelay,r}(e.normalizeTimingInput(i)),l=t.convertEffectInput(r),c=function(){l(n,a)};return c._update=function(e){return null!==(a=s(e))},c._clear=function(){l(n,null)},c._hasSameTarget=function(e){return n===e},c._target=n,c._totalDuration=s._totalDuration,c._id=o,c}}(n,r),function(t,n){function d(e,t,n){n.enumerable=!0,n.configurable=!0,Object.defineProperty(e,t,n)}function e(e){this._element=e,this._surrogateStyle=document.createElementNS("http://www.w3.org/1999/xhtml","div").style,this._style=e.style,this._length=0,this._isAnimatedProperty={},this._updateSvgTransformAttr=function c(e,t){return!(!t.namespaceURI||-1==t.namespaceURI.indexOf("/svg"))&&(r in e||(e[r]=/Trident|MSIE|IEMobile|Edge|Android 4/i.test(e.navigator.userAgent)),e[r])}(window,e),this._savedTransformAttr=null;for(var t=0;t<this._style.length;t++){var n=this._style[t];this._surrogateStyle[n]=this._style[n]}this._updateIndices()}function f(t){if(!t._webAnimationsPatchedStyle){var n=new e(t);try{d(t,"style",{get:function(){return n}})}catch(n){t.style._set=function(e,n){t.style[e]=n},t.style._clear=function(e){t.style[e]=""}}t._webAnimationsPatchedStyle=t.style}}var r="_webAnimationsUpdateSvgTransformAttr",i={cssText:1,length:1,parentRule:1},o={getPropertyCSSValue:1,getPropertyPriority:1,getPropertyValue:1,item:1,removeProperty:1,setProperty:1},a={removeProperty:1,setProperty:1};for(var s in e.prototype={get cssText(){return this._surrogateStyle.cssText},set cssText(e){for(var t={},n=0;n<this._surrogateStyle.length;n++)t[this._surrogateStyle[n]]=!0;this._surrogateStyle.cssText=e,this._updateIndices();for(n=0;n<this._surrogateStyle.length;n++)t[this._surrogateStyle[n]]=!0;for(var r in t)this._isAnimatedProperty[r]||this._style.setProperty(r,this._surrogateStyle.getPropertyValue(r))},get length(){return this._surrogateStyle.length},get parentRule(){return this._style.parentRule},_updateIndices:function(){for(;this._length<this._surrogateStyle.length;)Object.defineProperty(this,this._length,{configurable:!0,enumerable:!1,get:function(e){return function(){return this._surrogateStyle[e]}}(this._length)}),this._length++;for(;this._length>this._surrogateStyle.length;)this._length--,Object.defineProperty(this,this._length,{configurable:!0,enumerable:!1,value:void 0})},_set:function(e,n){this._style[e]=n,this._isAnimatedProperty[e]=!0,this._updateSvgTransformAttr&&"transform"==t.unprefixedPropertyName(e)&&(null==this._savedTransformAttr&&(this._savedTransformAttr=this._element.getAttribute("transform")),this._element.setAttribute("transform",t.transformToSvgMatrix(n)))},_clear:function(e){this._style[e]=this._surrogateStyle[e],this._updateSvgTransformAttr&&"transform"==t.unprefixedPropertyName(e)&&(this._savedTransformAttr?this._element.setAttribute("transform",this._savedTransformAttr):this._element.removeAttribute("transform"),this._savedTransformAttr=null),delete this._isAnimatedProperty[e]}},o)e.prototype[s]=function(e,t){return function(){var n=this._surrogateStyle[e].apply(this._surrogateStyle,arguments);return t&&(this._isAnimatedProperty[arguments[0]]||this._style[e].apply(this._style,arguments),this._updateIndices()),n}}(s,s in a);for(var l in document.documentElement.style)l in i||l in o||function(t){d(e.prototype,t,{get:function(){return this._surrogateStyle[t]},set:function(e){this._surrogateStyle[t]=e,this._updateIndices(),this._isAnimatedProperty[t]||(this._style[t]=e)}})}(l);t.apply=function(e,n,r){f(e),e.style._set(t.propertyName(n),r)},t.clear=function(e,n){e._webAnimationsPatchedStyle&&e.style._clear(t.propertyName(n))}}(r),function(e){window.Element.prototype.animate=function(t,n){var r="";return n&&n.id&&(r=n.id),e.timeline._play(e.KeyframeEffect(this,t,n,r))}}(r),function(e,t){r.Interpolation=function(e,t,n){return function(r){return n(function c(e,t,n){if("number"==typeof e&&"number"==typeof t)return e*(1-n)+t*n;if("boolean"==typeof e&&"boolean"==typeof t)return n<.5?e:t;if(e.length==t.length){for(var r=[],i=0;i<e.length;i++)r.push(c(e[i],t[i],n));return r}throw"Mismatched interpolation arguments "+e+":"+t}(e,t,r))}}}(),function(e,t){var n=function(){function a(e,t){for(var n=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],r=0;r<4;r++)for(var i=0;i<4;i++)for(var o=0;o<4;o++)n[r][i]+=t[r][o]*e[o][i];return n}return function c(e,t,n,r,i){for(var o=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],s=0;s<4;s++)o[s][3]=i[s];for(s=0;s<3;s++)for(var l=0;l<3;l++)o[3][s]+=e[l]*o[l][s];var c=r[0],u=r[1],h=r[2],d=r[3],p=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];p[0][0]=1-2*(u*u+h*h),p[0][1]=2*(c*u-h*d),p[0][2]=2*(c*h+u*d),p[1][0]=2*(c*u+h*d),p[1][1]=1-2*(c*c+h*h),p[1][2]=2*(u*h-c*d),p[2][0]=2*(c*h-u*d),p[2][1]=2*(u*h+c*d),p[2][2]=1-2*(c*c+u*u),o=a(o,p);var f=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(n[2]&&(f[2][1]=n[2],o=a(o,f)),n[1]&&(f[2][1]=0,f[2][0]=n[0],o=a(o,f)),n[0]&&(f[2][0]=0,f[1][0]=n[0],o=a(o,f)),s=0;s<3;s++)for(l=0;l<3;l++)o[s][l]*=t[s];return function b(e){return 0==e[0][2]&&0==e[0][3]&&0==e[1][2]&&0==e[1][3]&&0==e[2][0]&&0==e[2][1]&&1==e[2][2]&&0==e[2][3]&&0==e[3][2]&&1==e[3][3]}(o)?[o[0][0],o[0][1],o[1][0],o[1][1],o[3][0],o[3][1]]:o[0].concat(o[1],o[2],o[3])}}();e.composeMatrix=n,e.quat=function d(t,n,r){var i=e.dot(t,n),o=[];if(1===(i=function c(e,t,n){return Math.max(Math.min(e,n),t)}(i,-1,1)))o=t;else for(var a=Math.acos(i),s=1*Math.sin(r*a)/Math.sqrt(1-i*i),l=0;l<4;l++)o.push(t[l]*(Math.cos(r*a)-i*s)+n[l]*s);return o}}(r),function(e,t,n){e.sequenceNumber=0;t.Animation=function(t){this.id="",t&&t._id&&(this.id=t._id),this._sequenceNumber=e.sequenceNumber++,this._currentTime=0,this._startTime=null,this._paused=!1,this._playbackRate=1,this._inTimeline=!0,this._finishedFlag=!0,this.onfinish=null,this._finishHandlers=[],this._effect=t,this._inEffect=this._effect._update(0),this._idle=!0,this._currentTimePending=!1},t.Animation.prototype={_ensureAlive:function(){this.playbackRate<0&&0===this.currentTime?this._inEffect=this._effect._update(-1):this._inEffect=this._effect._update(this.currentTime),this._inTimeline||!this._inEffect&&this._finishedFlag||(this._inTimeline=!0,t.timeline._animations.push(this))},_tickCurrentTime:function(e,t){e!=this._currentTime&&(this._currentTime=e,this._isFinished&&!t&&(this._currentTime=this._playbackRate>0?this._totalDuration:0),this._ensureAlive())},get currentTime(){return this._idle||this._currentTimePending?null:this._currentTime},set currentTime(e){e=+e,isNaN(e)||(t.restart(),this._paused||null==this._startTime||(this._startTime=this._timeline.currentTime-e/this._playbackRate),this._currentTimePending=!1,this._currentTime!=e&&(this._idle&&(this._idle=!1,this._paused=!0),this._tickCurrentTime(e,!0),t.applyDirtiedAnimation(this)))},get startTime(){return this._startTime},set startTime(e){e=+e,isNaN(e)||this._paused||this._idle||(this._startTime=e,this._tickCurrentTime((this._timeline.currentTime-this._startTime)*this.playbackRate),t.applyDirtiedAnimation(this))},get playbackRate(){return this._playbackRate},set playbackRate(e){if(e!=this._playbackRate){var n=this.currentTime;this._playbackRate=e,this._startTime=null,"paused"!=this.playState&&"idle"!=this.playState&&(this._finishedFlag=!1,this._idle=!1,this._ensureAlive(),t.applyDirtiedAnimation(this)),null!=n&&(this.currentTime=n)}},get _isFinished(){return!this._idle&&(this._playbackRate>0&&this._currentTime>=this._totalDuration||this._playbackRate<0&&this._currentTime<=0)},get _totalDuration(){return this._effect._totalDuration},get playState(){return this._idle?"idle":null==this._startTime&&!this._paused&&0!=this.playbackRate||this._currentTimePending?"pending":this._paused?"paused":this._isFinished?"finished":"running"},_rewind:function(){if(this._playbackRate>=0)this._currentTime=0;else{if(!(this._totalDuration<1/0))throw new DOMException("Unable to rewind negative playback rate animation with infinite duration","InvalidStateError");this._currentTime=this._totalDuration}},play:function(){this._paused=!1,(this._isFinished||this._idle)&&(this._rewind(),this._startTime=null),this._finishedFlag=!1,this._idle=!1,this._ensureAlive(),t.applyDirtiedAnimation(this)},pause:function(){this._isFinished||this._paused||this._idle?this._idle&&(this._rewind(),this._idle=!1):this._currentTimePending=!0,this._startTime=null,this._paused=!0},finish:function(){this._idle||(this.currentTime=this._playbackRate>0?this._totalDuration:0,this._startTime=this._totalDuration-this.currentTime,this._currentTimePending=!1,t.applyDirtiedAnimation(this))},cancel:function(){this._inEffect&&(this._inEffect=!1,this._idle=!0,this._paused=!1,this._isFinished=!0,this._finishedFlag=!0,this._currentTime=0,this._startTime=null,this._effect._update(null),t.applyDirtiedAnimation(this))},reverse:function(){this.playbackRate*=-1,this.play()},addEventListener:function(e,t){"function"==typeof t&&"finish"==e&&this._finishHandlers.push(t)},removeEventListener:function(e,t){if("finish"==e){var n=this._finishHandlers.indexOf(t);n>=0&&this._finishHandlers.splice(n,1)}},_fireEvents:function(e){if(this._isFinished){if(!this._finishedFlag){var t=new function(e,t,n){this.target=e,this.currentTime=t,this.timelineTime=n,this.type="finish",this.bubbles=!1,this.cancelable=!1,this.currentTarget=e,this.defaultPrevented=!1,this.eventPhase=Event.AT_TARGET,this.timeStamp=Date.now()}(this,this._currentTime,e),n=this._finishHandlers.concat(this.onfinish?[this.onfinish]:[]);setTimeout(function(){n.forEach(function(e){e.call(t.target,t)})},0),this._finishedFlag=!0}}else this._finishedFlag=!1},_tick:function(e,t){this._idle||this._paused||(null==this._startTime?t&&(this.startTime=e-this._currentTime/this.playbackRate):this._isFinished||this._tickCurrentTime((e-this._startTime)*this.playbackRate)),t&&(this._currentTimePending=!1,this._fireEvents(e))},get _needsTick(){return this.playState in{pending:1,running:1}||!this._finishedFlag},_targetAnimations:function(){var e=this._effect._target;return e._activeAnimations||(e._activeAnimations=[]),e._activeAnimations},_markTarget:function(){var e=this._targetAnimations();-1===e.indexOf(this)&&e.push(this)},_unmarkTarget:function(){var e=this._targetAnimations(),t=e.indexOf(this);-1!==t&&e.splice(t,1)}}}(n,r),function(t,n,r){function d(t){var n=o;o=[],t<p.currentTime&&(t=p.currentTime),p._animations.sort(e),p._animations=h(t,!0,p._animations)[0],n.forEach(function(e){e[1](t)}),g(),void 0}function e(e,t){return e._sequenceNumber-t._sequenceNumber}function f(){this._animations=[],this.currentTime=window.performance&&performance.now?performance.now():0}function g(){c.forEach(function(e){e()}),c.length=0}function h(e,t,r){u=!0,l=!1,n.timeline.currentTime=e,s=!1;var i=[],o=[],a=[],h=[];return r.forEach(function(n){n._tick(e,t),n._inEffect?(o.push(n._effect),n._markTarget()):(i.push(n._effect),n._unmarkTarget()),n._needsTick&&(s=!0);var r=n._inEffect||n._needsTick;n._inTimeline=r,r?a.push(n):h.push(n)}),c.push.apply(c,i),c.push.apply(c,o),s&&requestAnimationFrame(function(){}),u=!1,[a,h]}var i=window.requestAnimationFrame,o=[],a=0;window.requestAnimationFrame=function(e){var t=a++;return 0==o.length&&i(d),o.push([t,e]),t},window.cancelAnimationFrame=function(e){o.forEach(function(t){t[0]==e&&(t[1]=function(){})})},f.prototype={_play:function(e){e._timing=t.normalizeTimingInput(e.timing);var r=new n.Animation(e);return r._idle=!1,r._timeline=this,this._animations.push(r),n.restart(),n.applyDirtiedAnimation(r),r}};var s=!1,l=!1;n.restart=function(){return s||(s=!0,requestAnimationFrame(function(){}),l=!0),l},n.applyDirtiedAnimation=function(t){if(!u){t._markTarget();var r=t._targetAnimations();r.sort(e),h(n.timeline.currentTime,!1,r.slice())[1].forEach(function(e){var t=p._animations.indexOf(e);-1!==t&&p._animations.splice(t,1)}),g()}};var c=[],u=!1,p=new f;n.timeline=p}(n,r),function(t,n){function c(e,t){for(var n=0,r=0;r<e.length;r++)n+=e[r]*t[r];return n}function d(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],e[0]*t[4]+e[4]*t[5]+e[8]*t[6]+e[12]*t[7],e[1]*t[4]+e[5]*t[5]+e[9]*t[6]+e[13]*t[7],e[2]*t[4]+e[6]*t[5]+e[10]*t[6]+e[14]*t[7],e[3]*t[4]+e[7]*t[5]+e[11]*t[6]+e[15]*t[7],e[0]*t[8]+e[4]*t[9]+e[8]*t[10]+e[12]*t[11],e[1]*t[8]+e[5]*t[9]+e[9]*t[10]+e[13]*t[11],e[2]*t[8]+e[6]*t[9]+e[10]*t[10]+e[14]*t[11],e[3]*t[8]+e[7]*t[9]+e[11]*t[10]+e[15]*t[11],e[0]*t[12]+e[4]*t[13]+e[8]*t[14]+e[12]*t[15],e[1]*t[12]+e[5]*t[13]+e[9]*t[14]+e[13]*t[15],e[2]*t[12]+e[6]*t[13]+e[10]*t[14]+e[14]*t[15],e[3]*t[12]+e[7]*t[13]+e[11]*t[14]+e[15]*t[15]]}function e(e){var t=e.rad||0;return((e.deg||0)/360+(e.grad||0)/400+(e.turn||0))*(2*Math.PI)+t}function f(t){switch(t.t){case"rotatex":var n=e(t.d[0]);return[1,0,0,0,0,Math.cos(n),Math.sin(n),0,0,-Math.sin(n),Math.cos(n),0,0,0,0,1];case"rotatey":n=e(t.d[0]);return[Math.cos(n),0,-Math.sin(n),0,0,1,0,0,Math.sin(n),0,Math.cos(n),0,0,0,0,1];case"rotate":case"rotatez":n=e(t.d[0]);return[Math.cos(n),Math.sin(n),0,0,-Math.sin(n),Math.cos(n),0,0,0,0,1,0,0,0,0,1];case"rotate3d":var r=t.d[0],i=t.d[1],o=t.d[2],a=(n=e(t.d[3]),r*r+i*i+o*o);if(0===a)r=1,i=0,o=0;else if(1!==a){var s=Math.sqrt(a);r/=s,i/=s,o/=s}var l=Math.sin(n/2),c=l*Math.cos(n/2),u=l*l;return[1-2*(i*i+o*o)*u,2*(r*i*u+o*c),2*(r*o*u-i*c),0,2*(r*i*u-o*c),1-2*(r*r+o*o)*u,2*(i*o*u+r*c),0,2*(r*o*u+i*c),2*(i*o*u-r*c),1-2*(r*r+i*i)*u,0,0,0,0,1];case"scale":return[t.d[0],0,0,0,0,t.d[1],0,0,0,0,1,0,0,0,0,1];case"scalex":return[t.d[0],0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];case"scaley":return[1,0,0,0,0,t.d[0],0,0,0,0,1,0,0,0,0,1];case"scalez":return[1,0,0,0,0,1,0,0,0,0,t.d[0],0,0,0,0,1];case"scale3d":return[t.d[0],0,0,0,0,t.d[1],0,0,0,0,t.d[2],0,0,0,0,1];case"skew":var h=e(t.d[0]),d=e(t.d[1]);return[1,Math.tan(d),0,0,Math.tan(h),1,0,0,0,0,1,0,0,0,0,1];case"skewx":n=e(t.d[0]);return[1,0,0,0,Math.tan(n),1,0,0,0,0,1,0,0,0,0,1];case"skewy":n=e(t.d[0]);return[1,Math.tan(n),0,0,0,1,0,0,0,0,1,0,0,0,0,1];case"translate":return[1,0,0,0,0,1,0,0,0,0,1,0,r=t.d[0].px||0,i=t.d[1].px||0,0,1];case"translatex":return[1,0,0,0,0,1,0,0,0,0,1,0,r=t.d[0].px||0,0,0,1];case"translatey":return[1,0,0,0,0,1,0,0,0,0,1,0,0,i=t.d[0].px||0,0,1];case"translatez":return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,o=t.d[0].px||0,1];case"translate3d":return[1,0,0,0,0,1,0,0,0,0,1,0,r=t.d[0].px||0,i=t.d[1].px||0,o=t.d[2].px||0,1];case"perspective":return[1,0,0,0,0,1,0,0,0,0,1,t.d[0].px?-1/t.d[0].px:0,0,0,0,1];case"matrix":return[t.d[0],t.d[1],0,0,t.d[2],t.d[3],0,0,0,0,1,0,t.d[4],t.d[5],0,1];case"matrix3d":return t.d}}function g(e){return 0===e.length?[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]:e.map(f).reduce(d)}var r=function(){function a(e){return e[0][0]*e[1][1]*e[2][2]+e[1][0]*e[2][1]*e[0][2]+e[2][0]*e[0][1]*e[1][2]-e[0][2]*e[1][1]*e[2][0]-e[1][2]*e[2][1]*e[0][0]-e[2][2]*e[0][1]*e[1][0]}function f(e){var t=g(e);return[e[0]/t,e[1]/t,e[2]/t]}function g(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function h(e,t,n,r){return[n*e[0]+r*t[0],n*e[1]+r*t[1],n*e[2]+r*t[2]]}return function j(t){var n=[t.slice(0,4),t.slice(4,8),t.slice(8,12),t.slice(12,16)];if(1!==n[3][3])return null;for(var r=[],o=0;o<4;o++)r.push(n[o].slice());for(o=0;o<3;o++)r[o][3]=0;if(0===a(r))return null;var s,l=[];n[0][3]||n[1][3]||n[2][3]?(l.push(n[0][3]),l.push(n[1][3]),l.push(n[2][3]),l.push(n[3][3]),s=function e(t,n){for(var r=[],i=0;i<4;i++){for(var o=0,a=0;a<4;a++)o+=t[a]*n[a][i];r.push(o)}return r}(l,function d(e){return[[e[0][0],e[1][0],e[2][0],e[3][0]],[e[0][1],e[1][1],e[2][1],e[3][1]],[e[0][2],e[1][2],e[2][2],e[3][2]],[e[0][3],e[1][3],e[2][3],e[3][3]]]}(function b(e){for(var t=1/a(e),n=e[0][0],r=e[0][1],i=e[0][2],o=e[1][0],s=e[1][1],l=e[1][2],c=e[2][0],u=e[2][1],h=e[2][2],d=[[(s*h-l*u)*t,(i*u-r*h)*t,(r*l-i*s)*t,0],[(l*c-o*h)*t,(n*h-i*c)*t,(i*o-n*l)*t,0],[(o*u-s*c)*t,(c*r-n*u)*t,(n*s-r*o)*t,0]],p=[],f=0;f<3;f++){for(var g=0,m=0;m<3;m++)g+=e[3][m]*d[m][f];p.push(g)}return p.push(1),d.push(p),d}(r)))):s=[0,0,0,1];var u=n[3].slice(0,3),p=[];p.push(n[0].slice(0,3));var m=[];m.push(g(p[0])),p[0]=f(p[0]);var v=[];p.push(n[1].slice(0,3)),v.push(c(p[0],p[1])),p[1]=h(p[1],p[0],1,-v[0]),m.push(g(p[1])),p[1]=f(p[1]),v[0]/=m[1],p.push(n[2].slice(0,3)),v.push(c(p[0],p[2])),p[2]=h(p[2],p[0],1,-v[1]),v.push(c(p[1],p[2])),p[2]=h(p[2],p[1],1,-v[2]),m.push(g(p[2])),p[2]=f(p[2]),v[1]/=m[2],v[2]/=m[2];var y=function i(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]}(p[1],p[2]);if(c(p[0],y)<0)for(o=0;o<3;o++)m[o]*=-1,p[o][0]*=-1,p[o][1]*=-1,p[o][2]*=-1;var _,x,w=p[0][0]+p[1][1]+p[2][2]+1;return w>1e-4?(_=.5/Math.sqrt(w),x=[(p[2][1]-p[1][2])*_,(p[0][2]-p[2][0])*_,(p[1][0]-p[0][1])*_,.25/_]):p[0][0]>p[1][1]&&p[0][0]>p[2][2]?x=[.25*(_=2*Math.sqrt(1+p[0][0]-p[1][1]-p[2][2])),(p[0][1]+p[1][0])/_,(p[0][2]+p[2][0])/_,(p[2][1]-p[1][2])/_]:p[1][1]>p[2][2]?(_=2*Math.sqrt(1+p[1][1]-p[0][0]-p[2][2]),x=[(p[0][1]+p[1][0])/_,.25*_,(p[1][2]+p[2][1])/_,(p[0][2]-p[2][0])/_]):(_=2*Math.sqrt(1+p[2][2]-p[0][0]-p[1][1]),x=[(p[0][2]+p[2][0])/_,(p[1][2]+p[2][1])/_,.25*_,(p[1][0]-p[0][1])/_]),[u,m,v,x,s]}}();t.dot=c,t.makeMatrixDecomposition=function h(e){return[r(g(e))]},t.transformListToMatrix=g}(r),function(t){function b(e,t){var n=e.exec(t);if(n)return[n=e.ignoreCase?n[0].toLowerCase():n[0],t.substr(n.length)]}function c(e,t){var n=e(t=t.replace(/^\s*/,""));if(n)return[n[0],n[1].replace(/^\s*/,"")]}function j(e,t,n,r,i){for(var o=[],a=[],s=[],l=function f(e,t){for(var n=e,r=t;n&&r;)n>r?n%=r:r%=n;return e*t/(n+r)}(r.length,i.length),c=0;c<l;c++){var u=t(r[c%r.length],i[c%i.length]);if(!u)return;o.push(u[0]),a.push(u[1]),s.push(u[2])}return[o,a,function(t){var r=t.map(function(e,t){return s[t](e)}).join(n);return e?e(r):r}]}t.consumeToken=b,t.consumeTrimmed=c,t.consumeRepeated=function d(e,t,n){e=c.bind(null,e);for(var r=[];;){var i=e(n);if(!i)return[r,n];if(r.push(i[0]),!(i=b(t,n=i[1]))||""==i[1])return[r,n];n=i[1]}},t.consumeParenthesised=function e(t,n){for(var r=0,i=0;i<n.length&&(!/\s|,/.test(n[i])||0!=r);i++)if("("==n[i])r++;else if(")"==n[i]&&(0==--r&&i++,r<=0))break;var o=t(n.substr(0,i));return void 0==o?void 0:[o,n.substr(i)]},t.ignore=function g(e){return function(t){var n=e(t);return n&&(n[0]=void 0),n}},t.optional=function h(e,t){return function(n){return e(n)||[t,n]}},t.consumeList=function i(e,n){for(var r=[],i=0;i<e.length;i++){var o=t.consumeTrimmed(e[i],n);if(!o||""==o[0])return;void 0!==o[0]&&r.push(o[0]),n=o[1]}if(""==n)return r},t.mergeNestedRepeated=j.bind(null,null),t.mergeWrappedNestedRepeated=j,t.mergeList=function k(e,t,n){for(var r=[],i=[],o=[],a=0,s=0;s<n.length;s++)if("function"==typeof n[s]){var l=n[s](e[a],t[a++]);r.push(l[0]),i.push(l[1]),o.push(l[2])}else!function(e){r.push(!1),i.push(!1),o.push(function(){return n[e]})}(s);return[r,i,function(e){for(var t="",n=0;n<e.length;n++)t+=o[n](e[n]);return t}]}}(r),function(t){function b(e){var n={inset:!1,lengths:[],color:null},r=t.consumeRepeated(function c(e){var r;return(r=t.consumeToken(/^inset/i,e))?(n.inset=!0,r):(r=t.consumeLengthOrPercent(e))?(n.lengths.push(r[0]),r):(r=t.consumeColor(e))?(n.color=r[0],r):void 0},/^/,e);if(r&&r[0].length)return[n,r[1]]}var n=function e(n,r,i,o){function f(e){return{inset:e,color:[0,0,0,0],lengths:[{px:0},{px:0},{px:0},{px:0}]}}for(var a=[],s=[],l=0;l<i.length||l<o.length;l++){var c=i[l]||f(o[l].inset),u=o[l]||f(i[l].inset);a.push(c),s.push(u)}return t.mergeNestedRepeated(n,r,a,s)}.bind(null,function d(e,n){for(;e.lengths.length<Math.max(e.lengths.length,n.lengths.length);)e.lengths.push({px:0});for(;n.lengths.length<Math.max(e.lengths.length,n.lengths.length);)n.lengths.push({px:0});if(e.inset==n.inset&&!!e.color==!!n.color){for(var r,i=[],o=[[],0],a=[[],0],s=0;s<e.lengths.length;s++){var l=t.mergeDimensions(e.lengths[s],n.lengths[s],2==s);o[0].push(l[0]),a[0].push(l[1]),i.push(l[2])}if(e.color&&n.color){var c=t.mergeColors(e.color,n.color);o[1]=c[0],a[1]=c[1],r=c[2]}return[o,a,function(t){for(var n=e.inset?"inset ":" ",o=0;o<i.length;o++)n+=i[o](t[0][o])+" ";return r&&(n+=r(t[1])),n}]}},", ");t.addPropertiesHandler(function c(e){var n=t.consumeRepeated(b,/^,/,e);if(n&&""==n[1])return n[0]},n,["box-shadow","text-shadow"])}(r),function(t,n){function c(e){return e.toFixed(3).replace(/0+$/,"").replace(/\.$/,"")}function d(e,t,n){return Math.min(t,Math.max(e,n))}function e(e){if(/^\s*[-+]?(\d*\.)?\d+\s*$/.test(e))return Number(e)}function i(e,t){return function(n,r){return[n,r,function(n){return c(d(e,t,n))}]}}function j(t){var n=t.trim().split(/\s*[\s,]\s*/);if(0!==n.length){for(var r=[],i=0;i<n.length;i++){var o=e(n[i]);if(void 0===o)return;r.push(o)}return r}}t.clamp=d,t.addPropertiesHandler(j,function k(e,t){if(e.length==t.length)return[e,t,function(e){return e.map(c).join(" ")}]},["stroke-dasharray"]),t.addPropertiesHandler(e,i(0,1/0),["border-image-width","line-height"]),t.addPropertiesHandler(e,i(0,1),["opacity","shape-image-threshold"]),t.addPropertiesHandler(e,function g(e,t){if(0!=e)return i(0,1/0)(e,t)},["flex-grow","flex-shrink"]),t.addPropertiesHandler(e,function h(e,t){return[e,t,function(e){return Math.round(d(1,1/0,e))}]},["orphans","widows"]),t.addPropertiesHandler(e,function l(e,t){return[e,t,Math.round]},["z-index"]),t.parseNumber=e,t.parseNumberList=j,t.mergeNumbers=function f(e,t){return[e,t,c]},t.numberToString=c}(r),function(e,t){r.addPropertiesHandler(String,function c(e,t){if("visible"==e||"visible"==t)return[0,1,function(n){return n<=0?e:n>=1?t:"visible"}]},["visibility"])}(),function(e,t){function c(e){e=e.trim(),r.fillStyle="#000",r.fillStyle=e;var t=r.fillStyle;if(r.fillStyle="#fff",r.fillStyle=e,t==r.fillStyle){r.fillRect(0,0,1,1);var n=r.getImageData(0,0,1,1).data;r.clearRect(0,0,1,1);var i=n[3]/255;return[n[0]*i,n[1]*i,n[2]*i,i]}}function d(t,n){return[t,n,function(t){function c(e){return Math.max(0,Math.min(255,e))}if(t[3])for(var n=0;n<3;n++)t[n]=Math.round(c(t[n]/t[3]));return t[3]=e.numberToString(e.clamp(0,1,t[3])),"rgba("+t.join(",")+")"}]}var n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");n.width=n.height=1;var r=n.getContext("2d");e.addPropertiesHandler(c,d,["background-color","border-bottom-color","border-left-color","border-right-color","border-top-color","color","fill","flood-color","lighting-color","outline-color","stop-color","stroke","text-decoration-color"]),e.consumeColor=e.consumeParenthesised.bind(null,c),e.mergeColors=d}(r),function(t,n){function c(t){function b(){var e=r.exec(t);n=e?e[0]:void 0}function d(){if("("!==n)return function c(){var e=Number(n);return b(),e}();b();var e=f();return")"!==n?NaN:(b(),e)}function e(){for(var e=d();"*"===n||"/"===n;){var t=n;b();var r=d();"*"===t?e*=r:e/=r}return e}function f(){for(var t=e();"+"===n||"-"===n;){var r=n;b();var i=e();"+"===r?t+=i:t-=i}return t}var n,r=/([\+\-\w\.]+|[\(\)\*\/])/g;return b(),f()}function d(e,t){if("0"==(t=t.trim().toLowerCase())&&"px".search(e)>=0)return{px:0};if(/^[^(]*$|^calc/.test(t)){var n={};t=(t=t.replace(/calc\(/g,"(")).replace(e,function(e){return n[e]=null,"U"+e});for(var r="U("+e.source+")",i=t.replace(/[-+]?(\d*\.)?\d+([Ee][-+]?\d+)?/g,"N").replace(new RegExp("N"+r,"g"),"D").replace(/\s[+-]\s/g,"O").replace(/\s/g,""),o=[/N\*(D)/g,/(N|D)[*\/]N/g,/(N|D)O\1/g,/\((N|D)\)/g],a=0;a<o.length;)o[a].test(i)?(i=i.replace(o[a],"$1"),a=0):a++;if("D"==i){for(var s in n){var l=c(t.replace(new RegExp("U"+s,"g"),"").replace(new RegExp(r,"g"),"*0"));if(!isFinite(l))return;n[s]=l}return n}}}function e(e,t){return f(e,t,!0)}function f(e,n,r){var i,o=[];for(i in e)o.push(i);for(i in n)o.indexOf(i)<0&&o.push(i);return e=o.map(function(t){return e[t]||0}),n=o.map(function(e){return n[e]||0}),[e,n,function(e){var n=e.map(function(n,i){return 1==e.length&&r&&(n=Math.max(n,0)),t.numberToString(n)+o[i]}).join(" + ");return e.length>1?"calc("+n+")":n}]}var r="px|em|ex|ch|rem|vw|vh|vmin|vmax|cm|mm|in|pt|pc",i=d.bind(null,new RegExp(r,"g")),o=d.bind(null,new RegExp(r+"|%","g")),a=d.bind(null,/deg|rad|grad|turn/g);t.parseLength=i,t.parseLengthOrPercent=o,t.consumeLengthOrPercent=t.consumeParenthesised.bind(null,o),t.parseAngle=a,t.mergeDimensions=f;var s=t.consumeParenthesised.bind(null,i),l=t.consumeRepeated.bind(void 0,s,/^/),u=t.consumeRepeated.bind(void 0,l,/^,/);t.consumeSizePairList=u;var h=t.mergeNestedRepeated.bind(void 0,e," "),p=t.mergeNestedRepeated.bind(void 0,h,",");t.mergeNonNegativeSizePair=h,t.addPropertiesHandler(function(e){var t=u(e);if(t&&""==t[1])return t[0]},p,["background-size"]),t.addPropertiesHandler(o,e,["border-bottom-width","border-image-width","border-left-width","border-right-width","border-top-width","flex-basis","font-size","height","line-height","max-height","max-width","outline-width","width"]),t.addPropertiesHandler(o,f,["border-bottom-left-radius","border-bottom-right-radius","border-top-left-radius","border-top-right-radius","bottom","left","letter-spacing","margin-bottom","margin-left","margin-right","margin-top","min-height","min-width","outline-offset","padding-bottom","padding-left","padding-right","padding-top","perspective","right","shape-margin","stroke-dashoffset","text-indent","top","vertical-align","word-spacing"])}(r),function(t,n){function c(e){return t.consumeLengthOrPercent(e)||t.consumeToken(/^auto/,e)}function d(e){var n=t.consumeList([t.ignore(t.consumeToken.bind(null,/^rect/)),t.ignore(t.consumeToken.bind(null,/^\(/)),t.consumeRepeated.bind(null,c,/^,/),t.ignore(t.consumeToken.bind(null,/^\)/))],e);if(n&&4==n[0].length)return n[0]}var r=t.mergeWrappedNestedRepeated.bind(null,function f(e){return"rect("+e+")"},function e(n,r){return"auto"==n||"auto"==r?[!0,!1,function(e){var i=e?n:r;if("auto"==i)return"auto";var o=t.mergeDimensions(i,i);return o[2](o[0])}]:t.mergeDimensions(n,r)},", ");t.parseBox=d,t.mergeBoxes=r,t.addPropertiesHandler(d,r,["clip"])}(r),function(t,n){function c(e){return function(t){var n=0;return e.map(function(e){return e===r?t[n++]:e})}}function d(e){return e}function e(e){if("none"==(e=e.toLowerCase().trim()))return[];for(var n,r=/\s*(\w+)\(([^)]*)\)/g,i=[],l=0;n=r.exec(e);){if(n.index!=l)return;l=n.index+n[0].length;var c=n[1],u=s[c];if(!u)return;var h=n[2].split(","),d=u[0];if(d.length<h.length)return;for(var p=[],f=0;f<d.length;f++){var g,m=h[f],v=d[f];if(void 0===(g=m?{A:function(e){return"0"==e.trim()?a:t.parseAngle(e)},N:t.parseNumber,T:t.parseLengthOrPercent,L:t.parseLength}[v.toUpperCase()](m):{a:a,n:p[0],t:o}[v]))return;p.push(g)}if(i.push({t:c,d:p}),r.lastIndex==e.length)return i}}function f(e){return e.toFixed(6).replace(".000000","")}function g(e,n){if(e.decompositionPair!==n){e.decompositionPair=n;var r=t.makeMatrixDecomposition(e)}if(n.decompositionPair!==e){n.decompositionPair=e;var i=t.makeMatrixDecomposition(n)}return null==r[0]||null==i[0]?[[!1],[!0],function(t){return t?n[0].d:e[0].d}]:(r[0].push(0),i[0].push(1),[r,i,function(e){var n=t.quat(r[0][3],i[0][3],e[5]);return t.composeMatrix(e[0],e[1],e[2],n,e[4]).map(f).join(",")}])}function h(e){return e.replace(/[xy]/,"")}function i(e){return e.replace(/(x|y|z|3d)?$/,"3d")}var r=null,o={px:0},a={deg:0},s={matrix:["NNNNNN",[r,r,0,0,r,r,0,0,0,0,1,0,r,r,0,1],d],matrix3d:["NNNNNNNNNNNNNNNN",d],rotate:["A"],rotatex:["A"],rotatey:["A"],rotatez:["A"],rotate3d:["NNNA"],perspective:["L"],scale:["Nn",c([r,r,1]),d],scalex:["N",c([r,1,1]),c([r,1])],scaley:["N",c([1,r,1]),c([1,r])],scalez:["N",c([1,1,r])],scale3d:["NNN",d],skew:["Aa",null,d],skewx:["A",null,c([r,a])],skewy:["A",null,c([a,r])],translate:["Tt",c([r,r,o]),d],translatex:["T",c([r,o,o]),c([r,o])],translatey:["T",c([o,r,o]),c([o,r])],translatez:["L",c([o,o,r])],translate3d:["TTL",d]};t.addPropertiesHandler(e,function j(e,n){var r=t.makeMatrixDecomposition&&!0,o=!1;if(!e.length||!n.length){e.length||(o=!0,e=n,n=[]);for(var a=0;a<e.length;a++){var l=e[a].t,c=e[a].d,u="scale"==l.substr(0,5)?1:0;n.push({t:l,d:c.map(function(e){if("number"==typeof e)return u;var t={};for(var n in e)t[n]=u;return t})})}}var d=function(e,t){return"perspective"==e&&"perspective"==t||("matrix"==e||"matrix3d"==e)&&("matrix"==t||"matrix3d"==t)},p=[],f=[],m=[];if(e.length!=n.length){if(!r)return;p=[(k=g(e,n))[0]],f=[k[1]],m=[["matrix",[k[2]]]]}else for(a=0;a<e.length;a++){var v=e[a].t,y=n[a].t,_=e[a].d,b=n[a].d,x=s[v],w=s[y];if(d(v,y)){if(!r)return;var k=g([e[a]],[n[a]]);p.push(k[0]),f.push(k[1]),m.push(["matrix",[k[2]]])}else{if(v==y)l=v;else if(x[2]&&w[2]&&h(v)==h(y))l=h(v),_=x[2](_),b=w[2](b);else{if(!x[1]||!w[1]||i(v)!=i(y)){if(!r)return;p=[(k=g(e,n))[0]],f=[k[1]],m=[["matrix",[k[2]]]];break}l=i(v),_=x[1](_),b=w[1](b)}for(var S=[],C=[],M=[],T=0;T<_.length;T++)k=("number"==typeof _[T]?t.mergeNumbers:t.mergeDimensions)(_[T],b[T]),S[T]=k[0],C[T]=k[1],M.push(k[2]);p.push(S),f.push(C),m.push([l,M])}}if(o){var P=p;p=f,f=P}return[p,f,function(e){return e.map(function(e,t){var n=e.map(function(e,n){return m[t][1][n](e)}).join(",");return"matrix"==m[t][0]&&16==n.split(",").length&&(m[t][0]="matrix3d"),m[t][0]+"("+n+")"}).join(" ")}]},["transform"]),t.transformToSvgMatrix=function(n){var r=t.transformListToMatrix(e(n));return"matrix("+f(r[0])+" "+f(r[1])+" "+f(r[4])+" "+f(r[5])+" "+f(r[12])+" "+f(r[13])+")"}}(r),function(e){function c(t){return t=100*Math.round(t/100),400===(t=e.clamp(100,900,t))?"normal":700===t?"bold":String(t)}e.addPropertiesHandler(function b(e){var t=Number(e);if(!(isNaN(t)||t<100||t>900||t%100!=0))return t},function d(e,t){return[e,t,c]},["font-weight"])}(r),function(t){function b(e){var t={};for(var n in e)t[n]=-e[n];return t}function c(e){return t.consumeToken(/^(left|center|right|top|bottom)\b/i,e)||t.consumeLengthOrPercent(e)}function d(e,r){var i=t.consumeRepeated(c,/^/,r);if(i&&""==i[1]){var o=i[0];if(o[0]=o[0]||"center",o[1]=o[1]||"center",3==e&&(o[2]=o[2]||{px:0}),o.length==e){if(/top|bottom/.test(o[0])||/left|right/.test(o[1])){var a=o[0];o[0]=o[1],o[1]=a}if(/left|right|center|Object/.test(o[0])&&/top|bottom|center|Object/.test(o[1]))return o.map(function(e){return"object"==typeof e?e:n[e]})}}}function e(e){var r=t.consumeRepeated(c,/^/,e);if(r){for(var i=r[0],o=[{"%":50},{"%":50}],a=0,s=!1,l=0;l<i.length;l++){var u=i[l];"string"==typeof u?(s=/bottom|right/.test(u),o[a={left:0,right:0,center:a,top:1,bottom:1}[u]]=n[u],"center"==u&&a++):(s&&((u=b(u))["%"]=(u["%"]||0)+100),o[a]=u,a++,s=!1)}return[o,r[1]]}}var n={left:{"%":0},center:{"%":50},right:{"%":100},top:{"%":0},bottom:{"%":100}},r=t.mergeNestedRepeated.bind(null,t.mergeDimensions," ");t.addPropertiesHandler(d.bind(null,3),r,["transform-origin"]),t.addPropertiesHandler(d.bind(null,2),r,["perspective-origin"]),t.consumePosition=e,t.mergeOffsetList=r;var i=t.mergeNestedRepeated.bind(null,r,", ");t.addPropertiesHandler(function f(n){var r=t.consumeRepeated(e,/^,/,n);if(r&&""==r[1])return r[0]},i,["background-position","object-position"])}(r),function(e){var t=e.consumeParenthesised.bind(null,e.parseLengthOrPercent),n=e.consumeRepeated.bind(void 0,t,/^/),r=e.mergeNestedRepeated.bind(void 0,e.mergeDimensions," "),i=e.mergeNestedRepeated.bind(void 0,r,",");e.addPropertiesHandler(function b(r){var i=e.consumeToken(/^circle/,r);if(i&&i[0])return["circle"].concat(e.consumeList([e.ignore(e.consumeToken.bind(void 0,/^\(/)),t,e.ignore(e.consumeToken.bind(void 0,/^at/)),e.consumePosition,e.ignore(e.consumeToken.bind(void 0,/^\)/))],i[1]));var o=e.consumeToken(/^ellipse/,r);if(o&&o[0])return["ellipse"].concat(e.consumeList([e.ignore(e.consumeToken.bind(void 0,/^\(/)),n,e.ignore(e.consumeToken.bind(void 0,/^at/)),e.consumePosition,e.ignore(e.consumeToken.bind(void 0,/^\)/))],o[1]));var a=e.consumeToken(/^polygon/,r);return a&&a[0]?["polygon"].concat(e.consumeList([e.ignore(e.consumeToken.bind(void 0,/^\(/)),e.optional(e.consumeToken.bind(void 0,/^nonzero\s*,|^evenodd\s*,/),"nonzero,"),e.consumeSizePairList,e.ignore(e.consumeToken.bind(void 0,/^\)/))],a[1])):void 0},function c(t,n){if(t[0]===n[0])return"circle"==t[0]?e.mergeList(t.slice(1),n.slice(1),["circle(",e.mergeDimensions," at ",e.mergeOffsetList,")"]):"ellipse"==t[0]?e.mergeList(t.slice(1),n.slice(1),["ellipse(",e.mergeNonNegativeSizePair," at ",e.mergeOffsetList,")"]):"polygon"==t[0]&&t[1]==n[1]?e.mergeList(t.slice(2),n.slice(2),["polygon(",t[1],i,")"]):void 0},["shape-outside"])}(r),function(e,t){function c(e,t){t.concat([e]).forEach(function(t){t in document.documentElement.style&&(n[e]=t),r[t]=e})}var n={},r={};c("transform",["webkitTransform","msTransform"]),c("transformOrigin",["webkitTransformOrigin"]),c("perspective",["webkitPerspective"]),c("perspectiveOrigin",["webkitPerspectiveOrigin"]),e.propertyName=function(e){return n[e]||e},e.unprefixedPropertyName=function(e){return r[e]||e}}(r)}(),function(){if(void 0===document.createElement("div").animate([]).oncancel){if(window.performance&&performance.now)var e=function(){return performance.now()};else e=function(){return Date.now()};var t=window.Element.prototype.animate;window.Element.prototype.animate=function(n,r){var i=t.call(this,n,r);i._cancelHandlers=[],i.oncancel=null;var o=i.cancel;i.cancel=function(){o.call(this);var t=new function(e,t,n){this.target=e,this.currentTime=t,this.timelineTime=n,this.type="cancel",this.bubbles=!1,this.cancelable=!1,this.currentTarget=e,this.defaultPrevented=!1,this.eventPhase=Event.AT_TARGET,this.timeStamp=Date.now()}(this,null,e()),n=this._cancelHandlers.concat(this.oncancel?[this.oncancel]:[]);setTimeout(function(){n.forEach(function(e){e.call(t.target,t)})},0)};var a=i.addEventListener;i.addEventListener=function(e,t){"function"==typeof t&&"cancel"==e?this._cancelHandlers.push(t):a.call(this,e,t)};var s=i.removeEventListener;return i.removeEventListener=function(e,t){if("cancel"==e){var n=this._cancelHandlers.indexOf(t);n>=0&&this._cancelHandlers.splice(n,1)}else s.call(this,e,t)},i}}}(),function(e){var t=document.documentElement,n=null,r=!1;try{var i="0"==getComputedStyle(t).getPropertyValue("opacity")?"1":"0";(n=t.animate({opacity:[i,i]},{duration:1})).currentTime=0,r=getComputedStyle(t).getPropertyValue("opacity")==i}catch(e){}finally{n&&n.cancel()}if(!r){var o=window.Element.prototype.animate;window.Element.prototype.animate=function(t,n){return window.Symbol&&Symbol.iterator&&Array.prototype.from&&t[Symbol.iterator]&&(t=Array.from(t)),Array.isArray(t)||null===t||(t=e.convertToArrayForm(t)),o.call(this,t,n)}}}(n),t.true={}}(0,function(){return this}()),function(){!function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):this.bowser=t()}(0,function(){function t(t){function n(e){var n=t.match(e);return n&&n.length>1&&n[1]||""}var i,o=n(/(ipod|iphone|ipad)/i).toLowerCase(),a=!/like android/i.test(t)&&/android/i.test(t),s=/nexus\s*[0-6]\s*/i.test(t),l=!s&&/nexus\s*[0-9]+/i.test(t),c=/CrOS/.test(t),u=/silk/i.test(t),h=/sailfish/i.test(t),d=/tizen/i.test(t),p=/(web|hpw)os/i.test(t),f=/windows phone/i.test(t),g=!f&&/windows/i.test(t),m=!o&&!u&&/macintosh/i.test(t),v=!a&&!h&&!d&&!p&&/linux/i.test(t),y=n(/edge\/(\d+(\.\d+)?)/i),_=n(/version\/(\d+(\.\d+)?)/i),b=/tablet/i.test(t),x=!b&&/[^-]mobi/i.test(t),w=/xbox/i.test(t);/opera|opr|opios/i.test(t)?i={name:"Opera",opera:e,version:_||n(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(t)?i={name:"Opera Coast",coast:e,version:_||n(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/yabrowser/i.test(t)?i={name:"Yandex Browser",yandexbrowser:e,version:_||n(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(t)?i={name:"UC Browser",ucbrowser:e,version:n(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(t)?i={name:"Maxthon",maxthon:e,version:n(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(t)?i={name:"Epiphany",epiphany:e,version:n(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(t)?i={name:"Puffin",puffin:e,version:n(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(t)?i={name:"Sleipnir",sleipnir:e,version:n(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(t)?i={name:"K-Meleon",kMeleon:e,version:n(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:f?(i={name:"Windows Phone",windowsphone:e},y?(i.msedge=e,i.version=y):(i.msie=e,i.version=n(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(t)?i={name:"Internet Explorer",msie:e,version:n(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:c?i={name:"Chrome",chromeos:e,chromeBook:e,chrome:e,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/chrome.+? edge/i.test(t)?i={name:"Microsoft Edge",msedge:e,version:y}:/vivaldi/i.test(t)?i={name:"Vivaldi",vivaldi:e,version:n(/vivaldi\/(\d+(\.\d+)?)/i)||_}:h?i={name:"Sailfish",sailfish:e,version:n(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?i={name:"SeaMonkey",seamonkey:e,version:n(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(t)?(i={name:"Firefox",firefox:e,version:n(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(i.firefoxos=e)):u?i={name:"Amazon Silk",silk:e,version:n(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(t)?i={name:"PhantomJS",phantom:e,version:n(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(t)?i={name:"SlimerJS",slimer:e,version:n(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?i={name:"BlackBerry",blackberry:e,version:_||n(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:p?(i={name:"WebOS",webos:e,version:_||n(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(i.touchpad=e)):/bada/i.test(t)?i={name:"Bada",bada:e,version:n(/dolfin\/(\d+(\.\d+)?)/i)}:d?i={name:"Tizen",tizen:e,version:n(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||_}:/qupzilla/i.test(t)?i={name:"QupZilla",qupzilla:e,version:n(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||_}:/chromium/i.test(t)?i={name:"Chromium",chromium:e,version:n(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||_}:/chrome|crios|crmo/i.test(t)?i={name:"Chrome",chrome:e,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:a?i={name:"Android",version:_}:/safari|applewebkit/i.test(t)?(i={name:"Safari",safari:e},_&&(i.version=_)):o?(i={name:"iphone"==o?"iPhone":"ipad"==o?"iPad":"iPod"},_&&(i.version=_)):i=/googlebot/i.test(t)?{name:"Googlebot",googlebot:e,version:n(/googlebot\/(\d+(\.\d+))/i)||_}:{name:n(/^(.*)\/(.*) /),version:function r(e){var n=t.match(e);return n&&n.length>1&&n[2]||""}(/^(.*)\/(.*) /)},!i.msedge&&/(apple)?webkit/i.test(t)?(/(apple)?webkit\/537\.36/i.test(t)?(i.name=i.name||"Blink",i.blink=e):(i.name=i.name||"Webkit",i.webkit=e),!i.version&&_&&(i.version=_)):!i.opera&&/gecko\//i.test(t)&&(i.name=i.name||"Gecko",i.gecko=e,i.version=i.version||n(/gecko\/(\d+(\.\d+)?)/i)),i.msedge||!a&&!i.silk?o?(i[o]=e,i.ios=e):m?i.mac=e:w?i.xbox=e:g?i.windows=e:v&&(i.linux=e):i.android=e;var k="";i.windowsphone?k=n(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):o?k=(k=n(/os (\d+([_\s]\d+)*) like mac os x/i)).replace(/[_\s]/g,"."):a?k=n(/android[ \/-](\d+(\.\d+)*)/i):i.webos?k=n(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):i.blackberry?k=n(/rim\stablet\sos\s(\d+(\.\d+)*)/i):i.bada?k=n(/bada\/(\d+(\.\d+)*)/i):i.tizen&&(k=n(/tizen[\/\s](\d+(\.\d+)*)/i)),k&&(i.osversion=k);var S=k.split(".")[0];return b||l||"ipad"==o||a&&(3==S||S>=4&&!x)||i.silk?i.tablet=e:(x||"iphone"==o||"ipod"==o||a||s||i.blackberry||i.webos||i.bada)&&(i.mobile=e),i.msedge||i.msie&&i.version>=10||i.yandexbrowser&&i.version>=15||i.vivaldi&&i.version>=1||i.chrome&&i.version>=20||i.firefox&&i.version>=20||i.safari&&i.version>=6||i.opera&&i.version>=10||i.ios&&i.osversion&&i.osversion.split(".")[0]>=6||i.blackberry&&i.version>=10.1||i.chromium&&i.version>=20?i.a=e:i.msie&&i.version<10||i.chrome&&i.version<20||i.firefox&&i.version<20||i.safari&&i.version<6||i.opera&&i.version<10||i.ios&&i.osversion&&i.osversion.split(".")[0]<6||i.chromium&&i.version<20?i.c=e:i.x=e,i}function r(e){return e.split(".").length}function i(e,t){var n,r=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(n=0;n<e.length;n++)r=t(e[n]);return r}function s(e){for(var t=Math.max(r(e[0]),r(e[1])),n=i(e,function(e){var n=t-r(e);return i((e+=new Array(n+1).join(".0")).split("."),function(e){return new Array(20-e.length).join("0")+e}).reverse()});--t>=0;){if(n[0][t]>n[1][t])return 1;if(n[0][t]!==n[1][t])return-1;if(0===t)return 0}}function o(e,n,r){var i=a;"string"==typeof n&&(r=n,n=void 0),void 0===n&&(n=!1),r&&(i=t(r));var o=""+i.version;for(var l in e)if(e.hasOwnProperty(l)&&i[l])return s([o,e[l]])<0;return n}var e=!0,a=t("undefined"!=typeof navigator?navigator.userAgent:"");return a.test=function(e){for(var t=0;t<e.length;++t){var n=e[t];if("string"==typeof n&&n in a)return!0}return!1},a.isUnsupportedBrowser=o,a.compareVersions=s,a.check=function u(e,t,n){return!o(e,t,n)},a._detect=t,a}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.virtualDom=e()}}(function(){return function e(t,n,r){function s(o,a){if(!n[o]){if(!t[o]){var l="function"==typeof require&&require;if(!a&&l)return l(o,!0);if(i)return i(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[o]={exports:{}};t[o][0].call(u.exports,function(e){var n=t[o][1][e];return s(n||e)},u,u.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(e,t,n){var r=e("./vdom/create-element.js");t.exports=r},{"./vdom/create-element.js":15}],2:[function(e,t,n){var r=e("./vtree/diff.js");t.exports=r},{"./vtree/diff.js":35}],3:[function(e,t,n){var r=e("./virtual-hyperscript/index.js");t.exports=r},{"./virtual-hyperscript/index.js":22}],4:[function(e,t,n){var r=e("./diff.js"),i=e("./patch.js"),o=e("./h.js"),a=e("./create-element.js"),s=e("./vnode/vnode.js"),l=e("./vnode/vtext.js");t.exports={diff:r,patch:i,h:o,create:a,VNode:s,VText:l}},{"./create-element.js":1,"./diff.js":2,"./h.js":3,"./patch.js":13,"./vnode/vnode.js":31,"./vnode/vtext.js":33}],5:[function(e,t,n){t.exports=function split(e){var t=String.prototype.split,n=/()??/.exec("")[1]===e;return function(r,i,o){if("[object RegExp]"!==Object.prototype.toString.call(i))return t.call(r,i,o);var a,s,l,c,u=[],h=(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.extended?"x":"")+(i.sticky?"y":""),d=0;i=new RegExp(i.source,h+"g");for(r+="",n||(a=new RegExp("^"+i.source+"$(?!\\s)",h)),o=o===e?-1>>>0:o>>>0;(s=i.exec(r))&&!((l=s.index+s[0].length)>d&&(u.push(r.slice(d,s.index)),!n&&s.length>1&&s[0].replace(a,function(){for(var t=1;t<arguments.length-2;t++)arguments[t]===e&&(s[t]=e)}),s.length>1&&s.index<r.length&&Array.prototype.push.apply(u,s.slice(1)),c=s[0].length,d=l,u.length>=o));)i.lastIndex===s.index&&i.lastIndex++;return d===r.length?!c&&i.test("")||u.push(""):u.push(r.slice(d)),u.length>o?u.slice(0,o):u}}()},{}],6:[function(e,t,n){},{}],7:[function(e,t,n){"use strict";e("individual/one-version")("ev-store","7");var r="__EV_STORE_KEY@7";t.exports=function EvStore(e){var t=e[r];t||(t=e[r]={});return t}},{"individual/one-version":9}],8:[function(e,t,n){(function(e){"use strict";var n="undefined"!=typeof window?window:void 0!==e?e:{};t.exports=function Individual(e,t){if(e in n)return n[e];return n[e]=t,t}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],9:[function(e,t,n){"use strict";var r=e("./index.js");t.exports=function OneVersion(e,t,n){var i="__INDIVIDUAL_ONE_VERSION_"+e,o=r(i+"_ENFORCE_SINGLETON",t);if(o!==t)throw new Error("Can only have one copy of "+e+".\nYou already have version "+o+" installed.\nThis means you cannot install version "+t);return r(i,n)}},{"./index.js":8}],10:[function(e,t,n){(function(n){var r=void 0!==n?n:"undefined"!=typeof window?window:{},i=e("min-document");if("undefined"!=typeof document)t.exports=document;else{var o=r["__GLOBAL_DOCUMENT_CACHE@4"];o||(o=r["__GLOBAL_DOCUMENT_CACHE@4"]=i),t.exports=o}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"min-document":6}],11:[function(e,t,n){"use strict";t.exports=function isObject(e){return"object"==typeof e&&null!==e}},{}],12:[function(e,t,n){var r=Array.isArray,i=Object.prototype.toString;t.exports=r||function isArray(e){return"[object Array]"===i.call(e)}},{}],13:[function(e,t,n){var r=e("./vdom/patch.js");t.exports=r},{"./vdom/patch.js":18}],14:[function(e,t,n){var r=e("is-object"),i=e("../vnode/is-vhook.js");function removeProperty(e,t,n,r){if(r){var o=r[t];if(i(o))o.unhook&&o.unhook(e,t,n);else if("attributes"===t)for(var a in o)e.removeAttribute(a);else if("style"===t)for(var s in o)e.style[s]="";else e[t]="string"==typeof o?"":null}}function patchObject(e,t,n,i,o){var a=n?n[i]:void 0;if("attributes"!==i)if(a&&r(a)&&getPrototype(a)!==getPrototype(o))e[i]=o;else{r(e[i])||(e[i]={});var s="style"===i?"":void 0;for(var l in o){var c=o[l];e[i][l]=void 0===c?s:c}}else for(var u in o){var h=o[u];void 0===h?e.removeAttribute(u):e.setAttribute(u,h)}}function getPrototype(e){return Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__?e.__proto__:e.constructor?e.constructor.prototype:void 0}t.exports=function applyProperties(e,t,n){for(var o in t){var a=t[o];void 0===a?removeProperty(e,o,a,n):i(a)?(removeProperty(e,o,a,n),a.hook&&a.hook(e,o,n?n[o]:void 0)):r(a)?patchObject(e,t,n,o,a):e[o]=a}}},{"../vnode/is-vhook.js":26,"is-object":11}],15:[function(e,t,n){var r=e("global/document"),i=e("./apply-properties"),o=e("../vnode/is-vnode.js"),a=e("../vnode/is-vtext.js"),s=e("../vnode/is-widget.js"),l=e("../vnode/handle-thunk.js");t.exports=function createElement(e,t){var n=t&&t.document||r;var c=t?t.warn:null;e=l(e).a;if(s(e))return e.init();if(a(e))return n.createTextNode(e.text);if(!o(e))return c&&c("Item is not a valid virtual dom node",e),null;var u=null===e.namespace?n.createElement(e.tagName):n.createElementNS(e.namespace,e.tagName);var h=e.properties;i(u,h);var d=e.children;for(var p=0;p<d.length;p++){var f=createElement(d[p],t);f&&u.appendChild(f)}return u}},{"../vnode/handle-thunk.js":24,"../vnode/is-vnode.js":27,"../vnode/is-vtext.js":28,"../vnode/is-widget.js":29,"./apply-properties":14,"global/document":10}],16:[function(e,t,n){var r={};function indexInRange(e,t,n){if(0===e.length)return!1;for(var r,i,o=0,a=e.length-1;o<=a;){if(i=e[r=(a+o)/2>>0],o===a)return i>=t&&i<=n;if(i<t)o=r+1;else{if(!(i>n))return!0;a=r-1}}return!1}function ascending(e,t){return e>t?1:-1}t.exports=function domIndex(e,t,n,i){return n&&0!==n.length?(n.sort(ascending),function recurse(e,t,n,i,o){i=i||{};if(e){indexInRange(n,o,o)&&(i[o]=e);var a=t.children;if(a)for(var s=e.childNodes,l=0;l<t.children.length;l++){o+=1;var c=a[l]||r,u=o+(c.count||0);indexInRange(n,o,u)&&recurse(s[l],c,n,i,o),o=u}}return i}(e,t,n,i,0)):{}}},{}],17:[function(e,t,n){var r=e("./apply-properties"),i=e("../vnode/is-widget.js"),o=e("../vnode/vpatch.js"),a=e("./update-widget");function destroyWidget(e,t){"function"==typeof t.destroy&&i(t)&&t.destroy(e)}t.exports=function applyPatch(e,t,n){var i=e.type,s=e.vNode,l=e.patch;switch(i){case o.REMOVE:return function removeNode(e,t){var n=e.parentNode;n&&n.removeChild(e);return destroyWidget(e,t),null}(t,s);case o.INSERT:return function insertNode(e,t,n){var r=n.render(t,n);e&&e.appendChild(r);return e}(t,l,n);case o.VTEXT:return function stringPatch(e,t,n,r){var i;if(3===e.nodeType)e.replaceData(0,e.length,n.text),i=e;else{var o=e.parentNode;i=r.render(n,r),o&&i!==e&&o.replaceChild(i,e)}return i}(t,0,l,n);case o.WIDGET:return function widgetPatch(e,t,n,r){var i,o=a(t,n);i=o?n.update(t,e)||e:r.render(n,r);var s=e.parentNode;s&&i!==e&&s.replaceChild(i,e);o||destroyWidget(e,t);return i}(t,s,l,n);case o.VNODE:return function vNodePatch(e,t,n,r){var i=e.parentNode,o=r.render(n,r);i&&o!==e&&i.replaceChild(o,e);return o}(t,0,l,n);case o.ORDER:return function reorderChildren(e,t){for(var n,r,i,o=e.childNodes,a={},s=0;s<t.removes.length;s++)r=t.removes[s],n=o[r.from],r.key&&(a[r.key]=n),e.removeChild(n);for(var l=o.length,c=0;c<t.inserts.length;c++)i=t.inserts[c],n=a[i.key],e.insertBefore(n,i.to>=l++?null:o[i.to])}(t,l),t;case o.PROPS:return r(t,l,s.properties),t;case o.THUNK:return function replaceRoot(e,t){e&&t&&e!==t&&e.parentNode&&e.parentNode.replaceChild(t,e);return t}(t,n.patch(t,l,n));default:return t}}},{"../vnode/is-widget.js":29,"../vnode/vpatch.js":32,"./apply-properties":14,"./update-widget":19}],18:[function(e,t,n){var r=e("global/document"),i=e("x-is-array"),o=e("./create-element"),a=e("./dom-index"),s=e("./patch-op");function patchRecursive(e,t,n){var i=function patchIndices(e){var t=[];for(var n in e)"a"!==n&&t.push(Number(n));return t}(t);if(0===i.length)return e;var o=a(e,t.a,i),s=e.ownerDocument;n.document||s===r||(n.document=s);for(var l=0;l<i.length;l++){var c=i[l];e=applyPatch(e,o[c],t[c],n)}return e}function applyPatch(e,t,n,r){if(!t)return e;var o;if(i(n))for(var a=0;a<n.length;a++)o=s(n[a],t,r),t===e&&(e=o);else o=s(n,t,r),t===e&&(e=o);return e}t.exports=function patch(e,t,n){n=n||{};n.patch=n.patch&&n.patch!==patch?n.patch:patchRecursive;n.render=n.render||o;return n.patch(e,t,n)}},{"./create-element":15,"./dom-index":16,"./patch-op":17,"global/document":10,"x-is-array":12}],19:[function(e,t,n){var r=e("../vnode/is-widget.js");t.exports=function updateWidget(e,t){if(r(e)&&r(t))return"name"in e&&"name"in t?e.id===t.id:e.init===t.init;return!1}},{"../vnode/is-widget.js":29}],20:[function(e,t,n){"use strict";var r=e("ev-store");function EvHook(e){if(!(this instanceof EvHook))return new EvHook(e);this.value=e}t.exports=EvHook,EvHook.prototype.hook=function(e,t){r(e)[t.substr(3)]=this.value},EvHook.prototype.unhook=function(e,t){r(e)[t.substr(3)]=void 0}},{"ev-store":7}],21:[function(e,t,n){"use strict";function SoftSetHook(e){if(!(this instanceof SoftSetHook))return new SoftSetHook(e);this.value=e}t.exports=SoftSetHook,SoftSetHook.prototype.hook=function(e,t){e[t]!==this.value&&(e[t]=this.value)}},{}],22:[function(e,t,n){"use strict";var r=e("x-is-array"),i=e("../vnode/vnode.js"),o=e("../vnode/vtext.js"),a=e("../vnode/is-vnode"),s=e("../vnode/is-vtext"),l=e("../vnode/is-widget"),c=e("../vnode/is-vhook"),u=e("../vnode/is-thunk"),d=e("./parse-tag.js"),p=e("./hooks/soft-set-hook.js"),f=e("./hooks/ev-hook.js");function isChild(e){return a(e)||s(e)||l(e)||u(e)}function errorString(e){try{return JSON.stringify(e,null,"    ")}catch(t){return String(e)}}t.exports=function h(e,t,n){var a,s,l,u,h=[];!n&&function isChildren(e){return"string"==typeof e||r(e)||isChild(e)}(t)&&(n=t,s={});a=d(e,s=s||t||{}),s.hasOwnProperty("key")&&(l=s.key,s.key=void 0);s.hasOwnProperty("namespace")&&(u=s.namespace,s.namespace=void 0);"INPUT"!==a||u||!s.hasOwnProperty("value")||void 0===s.value||c(s.value)||(s.value=p(s.value));(function transformProperties(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];if(c(n))continue;"ev-"===t.substr(0,3)&&(e[t]=f(n))}})(s),void 0!==n&&null!==n&&function addChild(e,t,n,i){if("string"==typeof e)t.push(new o(e));else if("number"==typeof e)t.push(new o(String(e)));else if(isChild(e))t.push(e);else{if(!r(e)){if(null===e||void 0===e)return;throw function UnexpectedVirtualElement(e){var t=new Error;return t.type="virtual-hyperscript.unexpected.virtual-element",t.message="Unexpected virtual child passed to h().\nExpected a VNode / Vthunk / VWidget / string but:\ngot:\n"+errorString(e.foreignObject)+".\nThe parent vnode is:\n"+errorString(e.parentVnode),t.foreignObject=e.foreignObject,t.parentVnode=e.parentVnode,t}({foreignObject:e,parentVnode:{tagName:n,properties:i}})}for(var a=0;a<e.length;a++)addChild(e[a],t,n,i)}}(n,h,a,s);return new i(a,s,h,l,u)}},{"../vnode/is-thunk":25,"../vnode/is-vhook":26,"../vnode/is-vnode":27,"../vnode/is-vtext":28,"../vnode/is-widget":29,"../vnode/vnode.js":31,"../vnode/vtext.js":33,"./hooks/ev-hook.js":20,"./hooks/soft-set-hook.js":21,"./parse-tag.js":23,"x-is-array":12}],23:[function(e,t,n){"use strict";var r=e("browser-split"),i=/([\.#]?[a-zA-Z0-9\u007F-\uFFFF_:-]+)/,o=/^\.|#/;t.exports=function parseTag(e,t){if(!e)return"DIV";var n,a,s,l,c=!t.hasOwnProperty("id"),u=r(e,i),h=null;o.test(u[1])&&(h="DIV");for(l=0;l<u.length;l++)(a=u[l])&&(s=a.charAt(0),h?"."===s?(n=n||[]).push(a.substring(1,a.length)):"#"===s&&c&&(t.id=a.substring(1,a.length)):h=a);n&&(t.className&&n.push(t.className),t.className=n.join(" "));return t.namespace?h:h.toUpperCase()}},{"browser-split":5}],24:[function(e,t,n){var r=e("./is-vnode"),i=e("./is-vtext"),o=e("./is-widget"),a=e("./is-thunk");function renderThunk(e,t){var n=e.vnode;if(n||(n=e.vnode=e.render(t)),!(r(n)||i(n)||o(n)))throw new Error("thunk did not return a valid node");return n}t.exports=function handleThunk(e,t){var n=e,r=t;a(t)&&(r=renderThunk(t,e));a(e)&&(n=renderThunk(e,null));return{a:n,b:r}}},{"./is-thunk":25,"./is-vnode":27,"./is-vtext":28,"./is-widget":29}],25:[function(e,t,n){t.exports=function isThunk(e){return e&&"Thunk"===e.type}},{}],26:[function(e,t,n){t.exports=function isHook(e){return e&&("function"==typeof e.hook&&!e.hasOwnProperty("hook")||"function"==typeof e.unhook&&!e.hasOwnProperty("unhook"))}},{}],27:[function(e,t,n){var r=e("./version");t.exports=function isVirtualNode(e){return e&&"VirtualNode"===e.type&&e.version===r}},{"./version":30}],28:[function(e,t,n){var r=e("./version");t.exports=function isVirtualText(e){return e&&"VirtualText"===e.type&&e.version===r}},{"./version":30}],29:[function(e,t,n){t.exports=function isWidget(e){return e&&"Widget"===e.type}},{}],30:[function(e,t,n){t.exports="2"},{}],31:[function(e,t,n){var r=e("./version"),i=e("./is-vnode"),o=e("./is-widget"),a=e("./is-thunk"),s=e("./is-vhook");t.exports=VirtualNode;var l={},c=[];function VirtualNode(e,t,n,r,u){this.tagName=e,this.properties=t||l,this.children=n||c,this.key=null!=r?String(r):void 0,this.namespace="string"==typeof u?u:null;var h,d=n&&n.length||0,p=0,f=!1,g=!1,m=!1;for(var v in t)if(t.hasOwnProperty(v)){var y=t[v];s(y)&&y.unhook&&(h||(h={}),h[v]=y)}for(var _=0;_<d;_++){var b=n[_];i(b)?(p+=b.count||0,!f&&b.hasWidgets&&(f=!0),!g&&b.hasThunks&&(g=!0),m||!b.hooks&&!b.descendantHooks||(m=!0)):!f&&o(b)?"function"==typeof b.destroy&&(f=!0):!g&&a(b)&&(g=!0)}this.count=d+p,this.hasWidgets=f,this.hasThunks=g,this.hooks=h,this.descendantHooks=m}VirtualNode.prototype.version=r,VirtualNode.prototype.type="VirtualNode"},{"./is-thunk":25,"./is-vhook":26,"./is-vnode":27,"./is-widget":29,"./version":30}],32:[function(e,t,n){var r=e("./version");function VirtualPatch(e,t,n){this.type=Number(e),this.vNode=t,this.patch=n}VirtualPatch.NONE=0,VirtualPatch.VTEXT=1,VirtualPatch.VNODE=2,VirtualPatch.WIDGET=3,VirtualPatch.PROPS=4,VirtualPatch.ORDER=5,VirtualPatch.INSERT=6,VirtualPatch.REMOVE=7,VirtualPatch.THUNK=8,t.exports=VirtualPatch,VirtualPatch.prototype.version=r,VirtualPatch.prototype.type="VirtualPatch"},{"./version":30}],33:[function(e,t,n){var r=e("./version");function VirtualText(e){this.text=String(e)}t.exports=VirtualText,VirtualText.prototype.version=r,VirtualText.prototype.type="VirtualText"},{"./version":30}],34:[function(e,t,n){var r=e("is-object"),i=e("../vnode/is-vhook");function getPrototype(e){return Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__?e.__proto__:e.constructor?e.constructor.prototype:void 0}t.exports=function diffProps(e,t){var n;for(var o in e){o in t||((n=n||{})[o]=void 0);var a=e[o],s=t[o];if(a!==s)if(r(a)&&r(s))if(getPrototype(s)!==getPrototype(a))(n=n||{})[o]=s;else if(i(s))(n=n||{})[o]=s;else{var l=diffProps(a,s);l&&((n=n||{})[o]=l)}else(n=n||{})[o]=s}for(var c in t)c in e||((n=n||{})[c]=t[c]);return n}},{"../vnode/is-vhook":26,"is-object":11}],35:[function(e,t,n){var r=e("x-is-array"),i=e("../vnode/vpatch"),o=e("../vnode/is-vnode"),a=e("../vnode/is-vtext"),s=e("../vnode/is-widget"),l=e("../vnode/is-thunk"),c=e("../vnode/handle-thunk"),u=e("./diff-props");function diff(e,t){var n={a:e};return walk(e,t,n,0),n}function walk(e,t,n,r){if(e!==t){var c=n[r],h=!1;if(l(e)||l(t))thunks(e,t,n,r);else if(null==t)s(e)||(clearState(e,n,r),c=n[r]),c=appendPatch(c,new i(i.REMOVE,e,t));else if(o(t))if(o(e))if(e.tagName===t.tagName&&e.namespace===t.namespace&&e.key===t.key){var d=u(e.properties,t.properties);d&&(c=appendPatch(c,new i(i.PROPS,e,d))),c=function diffChildren(e,t,n,r,a){for(var s=e.children,l=function reorder(e,t){var n=keyIndex(t),r=n.keys,i=n.free;if(i.length===t.length)return{children:t,moves:null};var o=keyIndex(e),a=o.keys;if(o.free.length===e.length)return{children:t,moves:null};for(var s=[],l=0,c=i.length,u=0,h=0;h<e.length;h++){var d,p=e[h];p.key?r.hasOwnProperty(p.key)?(d=r[p.key],s.push(t[d])):(d=h-u++,s.push(null)):l<c?(d=i[l++],s.push(t[d])):(d=h-u++,s.push(null))}for(var f=l>=i.length?t.length:i[l],g=0;g<t.length;g++){var m=t[g];m.key?a.hasOwnProperty(m.key)||s.push(m):g>=f&&s.push(m)}for(var v,y=s.slice(),_=0,b=[],x=[],w=0;w<t.length;){var k=t[w];for(v=y[_];null===v&&y.length;)b.push(remove(y,_,null)),v=y[_];v&&v.key===k.key?(_++,w++):k.key?(v&&v.key&&r[v.key]!==w+1?(b.push(remove(y,_,v.key)),(v=y[_])&&v.key===k.key?_++:x.push({key:k.key,to:w})):x.push({key:k.key,to:w}),w++):v&&v.key&&b.push(remove(y,_,v.key))}for(;_<y.length;)v=y[_],b.push(remove(y,_,v&&v.key));if(b.length===u&&!x.length)return{children:s,moves:null};return{children:s,moves:{removes:b,inserts:x}}}(s,t.children),c=l.children,u=s.length,h=c.length,d=u>h?u:h,p=0;p<d;p++){var f=s[p],g=c[p];a+=1,f?walk(f,g,n,a):g&&(r=appendPatch(r,new i(i.INSERT,null,g))),o(f)&&f.count&&(a+=f.count)}l.moves&&(r=appendPatch(r,new i(i.ORDER,e,l.moves)));return r}(e,t,n,c,r)}else c=appendPatch(c,new i(i.VNODE,e,t)),h=!0;else c=appendPatch(c,new i(i.VNODE,e,t)),h=!0;else a(t)?a(e)?e.text!==t.text&&(c=appendPatch(c,new i(i.VTEXT,e,t))):(c=appendPatch(c,new i(i.VTEXT,e,t)),h=!0):s(t)&&(s(e)||(h=!0),c=appendPatch(c,new i(i.WIDGET,e,t)));c&&(n[r]=c),h&&clearState(e,n,r)}}function clearState(e,t,n){!function unhook(e,t,n){if(o(e)){if(e.hooks&&(t[n]=appendPatch(t[n],new i(i.PROPS,e,function undefinedKeys(e){var t={};for(var n in e)t[n]=void 0;return t}(e.hooks)))),e.descendantHooks||e.hasThunks)for(var r=e.children,a=r.length,s=0;s<a;s++){var c=r[s];unhook(c,t,n+=1),o(c)&&c.count&&(n+=c.count)}}else l(e)&&thunks(e,null,t,n)}(e,t,n),function destroyWidgets(e,t,n){if(s(e))"function"==typeof e.destroy&&(t[n]=appendPatch(t[n],new i(i.REMOVE,e,null)));else if(o(e)&&(e.hasWidgets||e.hasThunks))for(var r=e.children,a=r.length,c=0;c<a;c++){var u=r[c];destroyWidgets(u,t,n+=1),o(u)&&u.count&&(n+=u.count)}else l(e)&&thunks(e,null,t,n)}(e,t,n)}function thunks(e,t,n,r){var o=c(e,t),a=diff(o.a,o.b);(function hasPatches(e){for(var t in e)if("a"!==t)return!0;return!1})(a)&&(n[r]=new i(i.THUNK,null,a))}function remove(e,t,n){return e.splice(t,1),{from:t,key:n}}function keyIndex(e){for(var t={},n=[],r=e.length,i=0;i<r;i++){var o=e[i];o.key?t[o.key]=i:n.push(i)}return{keys:t,free:n}}function appendPatch(e,t){return e?(r(e)?e.push(t):e=[e,t],e):t}t.exports=diff},{"../vnode/handle-thunk":24,"../vnode/is-thunk":25,"../vnode/is-vnode":27,"../vnode/is-vtext":28,"../vnode/is-widget":29,"../vnode/vpatch":32,"./diff-props":34,"x-is-array":12}]},{},[4])(4)}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).vdomParser=e()}}(function(){return function e(t,n,r){function s(o,a){if(!n[o]){if(!t[o]){var l="function"==typeof require&&require;if(!a&&l)return l(o,!0);if(i)return i(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[o]={exports:{}};t[o][0].call(u.exports,function(e){var n=t[o][1][e];return s(n||e)},u,u.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(e,t,n){"use strict";var r,i=e("virtual-dom/vnode/vnode"),o=e("virtual-dom/vnode/vtext"),a=e("./property-map"),s=e("./namespace-map"),l="http://www.w3.org/1999/xhtml";function createNode(e,t){return 3===e.nodeType?function createVirtualTextNode(e){return new o(e.nodeValue)}(e):1===e.nodeType||9===e.nodeType?function createVirtualDomNode(e,t){var n=e.namespaceURI!==l?e.namespaceURI:null,r=t&&e.getAttribute(t)?e.getAttribute(t):null;return new i(e.tagName,function createProperties(e){var t,n,r={};if(!e.hasAttributes())return r;e.namespaceURI&&e.namespaceURI!==l&&(t=e.namespaceURI);for(var i=0;i<e.attributes.length;i++)(n="style"==e.attributes[i].name?createStyleProperty(e):t?createPropertyNS(e.attributes[i]):createProperty(e.attributes[i])).ns?r[n.name]={namespace:n.ns,value:n.value}:n.isAttr?(r.attributes||(r.attributes={}),r.attributes[n.name]=n.value):r[n.name]=n.value;return r}(e),function createChildren(e,t){for(var n=[],r=0;r<e.childNodes.length;r++)n.push(createNode(e.childNodes[r],t));return n}(e,t),r,n)}(e,t):new o("")}function createProperty(e){var t,n,r;return 0===(t=a[e.name]?a[e.name]:e.name).indexOf("data-")||0===t.indexOf("aria-")?(n=e.value,r=!0):n=e.value,{name:t,value:n,isAttr:r||!1}}function createPropertyNS(e){return{name:e.name,value:e.value,ns:s[e.name]||""}}function createStyleProperty(e){for(var t=e.style,n={},r=0;r<t.length;++r){var i=t.item(r);n[i]=String(t[i]),n[i].indexOf("url")>-1&&(n[i]=n[i].replace(/\"/g,""))}return{name:"style",value:n}}t.exports=function parser(e,t){if(!e)return createNode(document.createTextNode(""));if("string"==typeof e){if(!("DOMParser"in window))throw new Error("DOMParser is not available, so parsing string to DOM node is not possible.");var n=(r=r||new DOMParser).parseFromString(e,"text/html");e=n.body.firstChild?n.getElementsByTagName("body")[0].firstChild:n.head.firstChild&&("TITLE"!==n.head.firstChild.tagName||n.title)?n.head.firstChild:n.firstChild&&"HTML"!==n.firstChild.tagName?n.firstChild:document.createTextNode("")}if("object"!=typeof e||!e||!e.nodeType)throw new Error("invalid dom node",e);return createNode(e,t)}},{"./namespace-map":2,"./property-map":10,"virtual-dom/vnode/vnode":8,"virtual-dom/vnode/vtext":9}],2:[function(e,t,n){"use strict";var r="http://www.w3.org/1999/xlink",i="http://www.w3.org/XML/1998/namespace",o={about:null,"accent-height":null,accumulate:null,additive:null,"alignment-baseline":null,alphabetic:null,amplitude:null,"arabic-form":null,ascent:null,attributeName:null,attributeType:null,azimuth:null,bandwidth:null,baseFrequency:null,baseProfile:null,"baseline-shift":null,bbox:null,begin:null,bias:null,by:null,calcMode:null,"cap-height":null,class:null,clip:null,"clip-path":null,"clip-rule":null,clipPathUnits:null,color:null,"color-interpolation":null,"color-interpolation-filters":null,"color-profile":null,"color-rendering":null,content:null,contentScriptType:null,contentStyleType:null,cursor:null,cx:null,cy:null,d:null,datatype:null,defaultAction:null,descent:null,diffuseConstant:null,direction:null,display:null,divisor:null,"dominant-baseline":null,dur:null,dx:null,dy:null,edgeMode:null,editable:null,elevation:null,"enable-background":null,end:null,"ev:event":"http://www.w3.org/2001/xml-events",event:null,exponent:null,externalResourcesRequired:null,fill:null,"fill-opacity":null,"fill-rule":null,filter:null,filterRes:null,filterUnits:null,"flood-color":null,"flood-opacity":null,focusHighlight:null,focusable:null,"font-family":null,"font-size":null,"font-size-adjust":null,"font-stretch":null,"font-style":null,"font-variant":null,"font-weight":null,format:null,from:null,fx:null,fy:null,g1:null,g2:null,"glyph-name":null,"glyph-orientation-horizontal":null,"glyph-orientation-vertical":null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:null,height:null,"horiz-adv-x":null,"horiz-origin-x":null,"horiz-origin-y":null,id:null,ideographic:null,"image-rendering":null,in:null,in2:null,initialVisibility:null,intercept:null,k:null,k1:null,k2:null,k3:null,k4:null,kernelMatrix:null,kernelUnitLength:null,kerning:null,keyPoints:null,keySplines:null,keyTimes:null,lang:null,lengthAdjust:null,"letter-spacing":null,"lighting-color":null,limitingConeAngle:null,local:null,"marker-end":null,"marker-mid":null,"marker-start":null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:null,mediaTime:null,method:null,min:null,mode:null,name:null,"nav-down":null,"nav-down-left":null,"nav-down-right":null,"nav-left":null,"nav-next":null,"nav-prev":null,"nav-right":null,"nav-up":null,"nav-up-left":null,"nav-up-right":null,numOctaves:null,observer:null,offset:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,"overline-position":null,"overline-thickness":null,"panose-1":null,path:null,pathLength:null,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,playbackOrder:null,"pointer-events":null,points:null,pointsAtX:null,pointsAtY:null,pointsAtZ:null,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:null,r:null,radius:null,refX:null,refY:null,rel:null,"rendering-intent":null,repeatCount:null,repeatDur:null,requiredExtensions:null,requiredFeatures:null,requiredFonts:null,requiredFormats:null,resource:null,restart:null,result:null,rev:null,role:null,rotate:null,rx:null,ry:null,scale:null,seed:null,"shape-rendering":null,slope:null,snapshotTime:null,spacing:null,specularConstant:null,specularExponent:null,spreadMethod:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,"stop-color":null,"stop-opacity":null,"strikethrough-position":null,"strikethrough-thickness":null,string:null,stroke:null,"stroke-dasharray":null,"stroke-dashoffset":null,"stroke-linecap":null,"stroke-linejoin":null,"stroke-miterlimit":null,"stroke-opacity":null,"stroke-width":null,surfaceScale:null,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:null,tableValues:null,target:null,targetX:null,targetY:null,"text-anchor":null,"text-decoration":null,"text-rendering":null,textLength:null,timelineBegin:null,title:null,to:null,transform:null,transformBehavior:null,type:null,typeof:null,u1:null,u2:null,"underline-position":null,"underline-thickness":null,unicode:null,"unicode-bidi":null,"unicode-range":null,"units-per-em":null,"v-alphabetic":null,"v-hanging":null,"v-ideographic":null,"v-mathematical":null,values:null,version:null,"vert-adv-y":null,"vert-origin-x":null,"vert-origin-y":null,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,"word-spacing":null,"writing-mode":null,x:null,"x-height":null,x1:null,x2:null,xChannelSelector:null,"xlink:actuate":r,"xlink:arcrole":r,"xlink:href":r,"xlink:role":r,"xlink:show":r,"xlink:title":r,"xlink:type":r,"xml:base":i,"xml:id":i,"xml:lang":i,"xml:space":i,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null};t.exports=o},{}],3:[function(e,t,n){t.exports=function isThunk(e){return e&&"Thunk"===e.type}},{}],4:[function(e,t,n){t.exports=function isHook(e){return e&&("function"==typeof e.hook&&!e.hasOwnProperty("hook")||"function"==typeof e.unhook&&!e.hasOwnProperty("unhook"))}},{}],5:[function(e,t,n){var r=e("./version");t.exports=function isVirtualNode(e){return e&&"VirtualNode"===e.type&&e.version===r}},{"./version":7}],6:[function(e,t,n){t.exports=function isWidget(e){return e&&"Widget"===e.type}},{}],7:[function(e,t,n){t.exports="2"},{}],8:[function(e,t,n){var r=e("./version"),i=e("./is-vnode"),o=e("./is-widget"),a=e("./is-thunk"),s=e("./is-vhook");t.exports=VirtualNode;var l={},c=[];function VirtualNode(e,t,n,r,u){this.tagName=e,this.properties=t||l,this.children=n||c,this.key=null!=r?String(r):void 0,this.namespace="string"==typeof u?u:null;var h,d=n&&n.length||0,p=0,f=!1,g=!1,m=!1;for(var v in t)if(t.hasOwnProperty(v)){var y=t[v];s(y)&&y.unhook&&(h||(h={}),h[v]=y)}for(var _=0;_<d;_++){var b=n[_];i(b)?(p+=b.count||0,!f&&b.hasWidgets&&(f=!0),!g&&b.hasThunks&&(g=!0),m||!b.hooks&&!b.descendantHooks||(m=!0)):!f&&o(b)?"function"==typeof b.destroy&&(f=!0):!g&&a(b)&&(g=!0)}this.count=d+p,this.hasWidgets=f,this.hasThunks=g,this.hooks=h,this.descendantHooks=m}VirtualNode.prototype.version=r,VirtualNode.prototype.type="VirtualNode"},{"./is-thunk":3,"./is-vhook":4,"./is-vnode":5,"./is-widget":6,"./version":7}],9:[function(e,t,n){var r=e("./version");function VirtualText(e){this.text=String(e)}t.exports=VirtualText,VirtualText.prototype.version=r,VirtualText.prototype.type="VirtualText"},{"./version":7}],10:[function(e,t,n){"use strict";t.exports={abbr:"abbr",accept:"accept","accept-charset":"acceptCharset",accesskey:"accessKey",action:"action",allowfullscreen:"allowFullScreen",allowtransparency:"allowTransparency",alt:"alt",async:"async",autocomplete:"autoComplete",autofocus:"autoFocus",autoplay:"autoPlay",cellpadding:"cellPadding",cellspacing:"cellSpacing",challenge:"challenge",charset:"charset",checked:"checked",cite:"cite",class:"className",cols:"cols",colspan:"colSpan",command:"command",content:"content",contenteditable:"contentEditable",contextmenu:"contextMenu",controls:"controls",coords:"coords",crossorigin:"crossOrigin",data:"data",datetime:"dateTime",default:"default",defer:"defer",dir:"dir",disabled:"disabled",download:"download",draggable:"draggable",dropzone:"dropzone",enctype:"encType",for:"htmlFor",form:"form",formaction:"formAction",formenctype:"formEncType",formmethod:"formMethod",formnovalidate:"formNoValidate",formtarget:"formTarget",frameBorder:"frameBorder",headers:"headers",height:"height",hidden:"hidden",high:"high",href:"href",hreflang:"hrefLang","http-equiv":"httpEquiv",icon:"icon",id:"id",inputmode:"inputMode",ismap:"isMap",itemid:"itemId",itemprop:"itemProp",itemref:"itemRef",itemscope:"itemScope",itemtype:"itemType",kind:"kind",label:"label",lang:"lang",list:"list",loop:"loop",manifest:"manifest",max:"max",maxlength:"maxLength",media:"media",mediagroup:"mediaGroup",method:"method",min:"min",minlength:"minLength",multiple:"multiple",muted:"muted",name:"name",novalidate:"noValidate",open:"open",optimum:"optimum",pattern:"pattern",ping:"ping",placeholder:"placeholder",poster:"poster",preload:"preload",radiogroup:"radioGroup",readonly:"readOnly",rel:"rel",required:"required",role:"role",rows:"rows",rowspan:"rowSpan",sandbox:"sandbox",scope:"scope",scoped:"scoped",scrolling:"scrolling",seamless:"seamless",selected:"selected",shape:"shape",size:"size",sizes:"sizes",sortable:"sortable",span:"span",spellcheck:"spellCheck",src:"src",srcdoc:"srcDoc",srcset:"srcSet",start:"start",step:"step",style:"style",tabindex:"tabIndex",target:"target",title:"title",translate:"translate",type:"type",typemustmatch:"typeMustMatch",usemap:"useMap",value:"value",width:"width",wmode:"wmode",wrap:"wrap"}},{}]},{},[1])(1)});var GLOBAL="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;GLOBAL.bezier={default:function(){var e={};return function(t){"object"==typeof exports&&void 0!==e?e.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).BezierEasing=t()}(function(){return function f(e,t,n){function c(i,o){if(!t[i]){if(!e[i]){var a="function"==typeof require&&require;if(!o&&a)return a(i,!0);if(r)return r(i,!0);var s=new Error("Cannot find module '"+i+"'");throw s.code="MODULE_NOT_FOUND",s}var l=t[i]={exports:{}};e[i][0].call(l.exports,function(t){return c(e[i][1][t]||t)},l,l.exports,f,e,t,n)}return t[i].exports}for(var r="function"==typeof require&&require,i=0;i<n.length;i++)c(n[i]);return c}({1:[function(e,n,r){var i=4,o=1e-7,a=10,c="function"==typeof Float32Array;function t(e,t){return 1-3*t+3*e}function f(e,t){return 3*t-6*e}function u(e){return 3*e}function l(e,n,r){return((t(n,r)*e+f(n,r))*e+u(n))*e}function p(e,n,r){return 3*t(n,r)*e*e+2*f(n,r)*e+u(n)}function s(e){return e}n.exports=function(e,n,r,u){if(!(0<=e&&e<=1&&0<=r&&r<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===n&&r===u)return s;for(var h=c?new Float32Array(11):new Array(11),d=0;d<11;++d)h[d]=l(.1*d,e,r);return function(s){return 0===s?0:1===s?1:l(function t(n){for(var s=0,c=1;10!==c&&h[c]<=n;++c)s+=.1;var u=s+(n-h[--c])/(h[c+1]-h[c])*.1,d=p(u,e,r);return.001<=d?function(e,t,n,r){for(var o=0;o<i;++o){var a=p(t,n,r);if(0===a)return t;t-=(l(t,n,r)-e)/a}return t}(n,u,e,r):0===d?u:function(e,t,n,r,i){for(var s,c,u=0;0<(s=l(c=t+(n-t)/2,r,i)-e)?n=c:t=c,Math.abs(s)>o&&++u<a;);return c}(n,s,s+.1,e,r)}(s),n,u)}}},{}]},{},[1])(1)}),e}().exports},function(){var e,t,n={};e=this,t=function(t){"use strict";function n(e){return 10===e||13===e||8232===e||8233===e||32===e||9===e||11===e||12===e||160===e||e>=5760&&re.indexOf(e)>=0}function r(e){return e>=48&&e<=57}function i(e){return e>=48&&e<=57||43===e||45===e||46===e}function o(e){for(;e.index<e.max&&n(e.path.charCodeAt(e.index));)e.index++}function s(e){var t,n=e.index,i=n,o=e.max,a=!1,s=!1,l=!1,c=!1;if(i>=o)e.err="SvgPath: missed param (at pos "+i+")";else if(43!==(t=e.path.charCodeAt(i))&&45!==t||(t=++i<o?e.path.charCodeAt(i):0),r(t)||46===t){if(46!==t){if(a=48===t,t=++i<o?e.path.charCodeAt(i):0,a&&i<o&&t&&r(t))return void(e.err="SvgPath: numbers started with `0` such as `09` are ilegal (at pos "+n+")");for(;i<o&&r(e.path.charCodeAt(i));)i++,s=!0;t=i<o?e.path.charCodeAt(i):0}if(46===t){for(c=!0,i++;r(e.path.charCodeAt(i));)i++,l=!0;t=i<o?e.path.charCodeAt(i):0}if(101===t||69===t){if(c&&!s&&!l)return void(e.err="SvgPath: invalid float exponent (at pos "+i+")");if(43!==(t=++i<o?e.path.charCodeAt(i):0)&&45!==t||i++,!(i<o&&r(e.path.charCodeAt(i))))return void(e.err="SvgPath: invalid float exponent (at pos "+i+")");for(;i<o&&r(e.path.charCodeAt(i));)i++}e.index=i,e.param=parseFloat(e.path.slice(n,i))+0}else e.err="SvgPath: param should start with 0..9 or `.` (at pos "+i+")"}function h(e){var t,n;n=(t=e.path[e.segmentStart]).toLowerCase();var r=e.data;if("m"===n&&r.length>2&&(e.result.push([t,r[0],r[1]]),r=r.slice(2),n="l",t="m"===t?"l":"L"),"r"===n)e.result.push([t].concat(r));else for(;r.length>=ne[n]&&(e.result.push([t].concat(r.splice(0,ne[n]))),ne[n]););}function u(t){var n,r,a,l=t.max;if(t.segmentStart=t.index,function e(t){switch(32|t){case 109:case 122:case 108:case 104:case 118:case 99:case 115:case 113:case 116:case 97:case 114:return!0}return!1}(t.path.charCodeAt(t.index)))if(r=ne[t.path[t.index].toLowerCase()],t.index++,o(t),t.data=[],r){for(n=!1;;){for(a=r;a>0;a--){if(s(t),t.err.length)return;t.data.push(t.param),o(t),n=!1,t.index<l&&44===t.path.charCodeAt(t.index)&&(t.index++,o(t),n=!0)}if(!n){if(t.index>=t.max)break;if(!i(t.path.charCodeAt(t.index)))break}}h(t)}else h(t);else t.err="SvgPath: bad command "+t.path[t.index]+" (at pos "+t.index+")"}function c(e,t){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],e[0]*t[4]+e[2]*t[5]+e[4],e[1]*t[4]+e[3]*t[5]+e[5]]}function f(){if(!(this instanceof f))return new f;this.queue=[],this.cache=null}function l(e,t,n,r){var i=e*r-t*n<0?-1:1,o=(e*n+t*r)/(Math.sqrt(e*e+t*t)*Math.sqrt(e*e+t*t));return o>1&&(o=1),o<-1&&(o=-1),i*Math.acos(o)}function p(e,t,n,r,i,o,a,s,c,u){var h=u*(e-n)/2+c*(t-r)/2,d=-c*(e-n)/2+u*(t-r)/2,p=a*a,f=s*s,g=h*h,m=d*d,v=p*f-p*m-f*g;v<0&&(v=0),v/=p*m+f*g;var y=(v=Math.sqrt(v)*(i===o?-1:1))*a/s*d,_=v*-s/a*h,b=u*y-c*_+(e+n)/2,x=c*y+u*_+(t+r)/2,w=(h-y)/a,k=(d-_)/s,S=(-h-y)/a,C=(-d-_)/s,M=l(1,0,w,k),T=l(w,k,S,C);return 0===o&&T>0&&(T-=ce),1===o&&T<0&&(T+=ce),[b,x,M,T]}function g(e,t){var n=4/3*Math.tan(t/4),r=Math.cos(e),i=Math.sin(e),o=Math.cos(e+t),a=Math.sin(e+t);return[r,i,r-i*n,i+r*n,o+a*n,a-o*n,o,a]}function v(e,t,n){if(!(this instanceof v))return new v(e,t,n);this.rx=e,this.ry=t,this.ax=n}function x(e){if(!(this instanceof x))return new x(e);var t=ie(e);this.segments=t.segments,this.err=t.err,this.__stack=[]}function d(e,t,n,r,i,o,a,s){this.a={x:e,y:t},this.b={x:n,y:r},this.c={x:i,y:o},this.d={x:a,y:s},null!==a&&void 0!==a&&null!==s&&void 0!==s?(this.getArcLength=_,this.getPoint=L,this.getDerivative=M):(this.getArcLength=A,this.getPoint=b,this.getDerivative=m),this.init()}function m(e,t,n){return{x:2*(1-n)*(e[1]-e[0])+2*n*(e[2]-e[1]),y:2*(1-n)*(t[1]-t[0])+2*n*(t[2]-t[1])}}function M(e,t,n){return b([3*(e[1]-e[0]),3*(e[2]-e[1]),3*(e[3]-e[2])],[3*(t[1]-t[0]),3*(t[2]-t[1]),3*(t[3]-t[2])],n)}function w(e,t,n,r,i){for(var o=1,a=e/t,s=(e-n(r,i,a))/t;o>.001;){var l=n(r,i,a+s),c=n(r,i,a-s),u=Math.abs(e-l)/t,h=Math.abs(e-c)/t;u<o?(o=u,a+=s):h<o?(o=h,a-=s):s/=2}return a}function b(e,t,n){return{x:(1-n)*(1-n)*e[0]+2*(1-n)*n*e[1]+n*n*e[2],y:(1-n)*(1-n)*t[0]+2*(1-n)*n*t[1]+n*n*t[2]}}function L(e,t,n){return{x:(1-n)*(1-n)*(1-n)*e[0]+3*(1-n)*(1-n)*n*e[1]+3*(1-n)*n*n*e[2]+n*n*n*e[3],y:(1-n)*(1-n)*(1-n)*t[0]+3*(1-n)*(1-n)*n*t[1]+3*(1-n)*n*n*t[2]+n*n*n*t[3]}}function A(e,t,n){void 0===n&&(n=1);var r=e[0]-2*e[1]+e[2],i=t[0]-2*t[1]+t[2],o=2*e[1]-2*e[0],a=2*t[1]-2*t[0],s=4*(r*r+i*i),l=4*(r*o+i*a),c=o*o+a*a;if(0===s)return n*Math.sqrt(Math.pow(e[2]-e[0],2)+Math.pow(t[2]-t[0],2));var u=l/(2*s),h=n+u,d=c/s-u*u;return Math.sqrt(s)/2*(h*Math.sqrt(h*h+d)-u*Math.sqrt(u*u+d)+d*Math.log(Math.abs((h+Math.sqrt(h*h+d))/(u+Math.sqrt(u*u+d)))))}function q(e,t){return be[e][t]}function k(e,t,n){var r,i,o,a=n.length-1;if(0===a)return 0;if(0===e){for(i=0,o=0;o<=a;o++)i+=q(a,o)*Math.pow(1-t,a-o)*Math.pow(t,o)*n[o];return i}for(r=new Array(a),o=0;o<a;o++)r[o]=a*(n[o+1]-n[o]);return k(e-1,t,r)}function P(e,t,n){var r=k(1,n,e),i=k(1,n,t),o=r*r+i*i;return Math.sqrt(o)}function _(e,t,n){var r,i,o,a;for(void 0===n&&(n=1),r=n/2,i=0,o=0;o<20;o++)a=r*ye[20][o]+r,i+=_e[20][o]*P(e,t,a);return r*i}function E(e,t,n,r){var i=e*n+t*r;return i>1&&(i=1),i<-1&&(i=-1),(e*r-t*n<0?-1:1)*Math.acos(i)}function C(e,t){var n=4/3*Math.tan(t/4),r=Math.cos(e),i=Math.sin(e),o=Math.cos(e+t),a=Math.sin(e+t);return[r,i,r-i*n,i+r*n,o+a*n,a-o*n,o,a]}function Z(e,t,n,r,i,o,a,s,l){var c=0,u=[],h=[];we(e,t,n,r,i,o,a,s,l).forEach(function(e){var t=new ve(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]),n=t.getTotalLength();c+=n,u.push(n),h.push(t)}),this.length=c,this.partialLengths=u,this.curves=h}function T(e,t,n,r){this.x0=e,this.x1=t,this.y0=n,this.y1=r}function F(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function z(e,t,n){return[e[0]+(t[0]-e[0])*n,e[1]+(t[1]-e[1])*n]}function I(e,t,n){var r=e.map(function(e,n){return function V(e,t){return function(n){return e.map(function(e,r){return e+n*(t[r]-e)})}}(e,t[n])});return function(e){var t=r.map(function(t){return t(e)});return n?H(t):t}}function X(e){return"number"==typeof e&&isFinite(e)}function Y(e){return function G(e){for(var t=0;t<e.length-2;t++){var n=e[t],r=e[t+1],i=e[t+2];if(n[0]*(r[1]-i[1])+r[0]*(i[1]-n[1])+i[0]*(n[1]-r[1]))return!0}return!1}(e)?ee(e):[(e[0][0]+e[e.length-1][0])/2,(e[0][1]+e[e.length-1][1])/2]}function O(e){return new de(e).abs()}function D(e){return e.toString().split("M").map(function(e,t){return e=e.trim(),t&&e?"M"+e:e}).filter(function(e){return e})}function H(e){return"M"+e.join("L")+"Z"}function Q(e,t){var n=O(e);return function U(e){var t=e.segments||[],n=[];if(!t.length||"M"!==t[0][0])return!1;for(var r=0;r<t.length;r++){var i=t[r],o=i[0],a=i[1],s=i[2];if("M"===o&&r||"Z"===o)break;if("M"===o||"L"===o)n.push([a,s]);else if("H"===o)n.push([a,n[n.length-1][1]]);else{if("V"!==o)return!1;n.push([n[n.length-1][0],a])}}return!!n.length&&{ring:n}}(n)||function R(e,t){var n,r,i=D(e)[0],o=[],a=3;if(!i)throw new TypeError(Me);r=function B(e){if("undefined"!=typeof window&&window&&window.document)try{var t=window.document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttributeNS(null,"d",e),t}catch(e){}return Ce(e)}(i),n=r.getTotalLength(),t&&X(t)&&t>0&&(a=Math.max(a,Math.ceil(n/t)));for(var s=0;s<a;s++){var l=r.getPointAtLength(n*s/a);o.push([l.x,l.y])}return{ring:o,skipBisect:!0}}(n,t)}function W(e,t){for(var n=e.length+t,r=te(e)/t,i=0,o=0,a=r/2;e.length<n;){var s=e[i],l=e[(i+1)%e.length],c=F(s,l);a<=o+c?(e.splice(i+1,0,c?z(s,l,(a-o)/c):s.slice(0)),a+=r):(o+=c,i++)}}function J(e,t){var n,r;if("string"==typeof e){var i=Q(e,t);e=i.ring,r=i.skipBisect}else if(!Array.isArray(e))throw new TypeError(Me);if(!function K(e){return e.every(function(e){return Array.isArray(e)&&e.length>=2&&X(e[0])&&X(e[1])})}(n=e.slice(0)))throw new TypeError(Me);return n.length>1&&function j(e,t){return F(e,t)<1e-9}(n[0],n[n.length-1])&&n.pop(),V(n)>0&&n.reverse(),!r&&t&&X(t)&&t>0&&function $(e,t){void 0===t&&(t=1/0);for(var n=0;n<e.length;n++)for(var r=e[n],i=n===e.length-1?e[0]:e[n+1];F(r,i)>t;)i=z(r,i,.5),e.splice(n+1,0,i)}(n,t),n}function tt(e,t,n){var r;return W(e,(r=e.length-t.length)<0?-1*r:0),W(t,r>0?r:0),Pe(e,t),I(e,t,n)}function nt(e,t,n){n=n||2;var r,i,o,a,s,l,c,u=t&&t.length,h=u?t[0]*n:e.length,d=et(e,0,h,n,!0),p=[];if(!d)return p;if(u&&(d=function ut(e,t,n,r){var i,o,a,s,l,c=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,s=i<o-1?t[i+1]*r:e.length,(l=et(e,a,s,r,!1))===l.next&&(l.steiner=!0),c.push(xt(l));for(c.sort(ct),i=0;i<c.length;i++)ft(c[i],n),n=rt(n,n.next);return n}(e,t,d,n)),e.length>80*n){r=o=e[0],i=a=e[1];for(var f=n;f<h;f+=n)s=e[f],l=e[f+1],s<r&&(r=s),l<i&&(i=l),s>o&&(o=s),l>a&&(a=l);c=Math.max(o-r,a-i)}return it(d,p,n,r,i,c),p}function et(e,t,n,r,i){var o,a;if(i===Et(e,t,n,r)>0)for(o=t;o<n;o+=r)a=kt(o,e[o],e[o+1],a);else for(o=n-r;o>=t;o-=r)a=kt(o,e[o],e[o+1],a);return a&&Mt(a,a.next)&&(Pt(a),a=a.next),a}function rt(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!Mt(r,r.next)&&0!==mt(r.prev,r,r.next))r=r.next;else{if(Pt(r),(r=t=r.prev)===r.next)return null;n=!0}}while(n||r!==t);return t}function it(e,t,n,r,i,o,a){if(e){!a&&o&&function pt(e,t,n,r){var i=e;do{null===i.z&&(i.z=vt(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function gt(e){var t,n,r,i,o,a,s,l,c=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,r=n,s=0,t=0;t<c&&(s++,r=r.nextZ);t++);for(l=c;s>0||l>0&&r;)0===s?(i=r,r=r.nextZ,l--):0!==l&&r?n.z<=r.z?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,l--):(i=n,n=n.nextZ,s--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,c*=2}while(a>1);return e}(i)}(e,r,i,o);for(var s,l,c=e;e.prev!==e.next;)if(s=e.prev,l=e.next,o?ot(e,r,i,o):at(e))t.push(s.i/n),t.push(e.i/n),t.push(l.i/n),Pt(e),e=l.next,c=l.next;else if((e=l)===c){a?1===a?it(e=st(e,t,n),t,n,r,i,o,2):2===a&&ht(e,t,n,r,i,o):it(rt(e),t,n,r,i,o,1);break}}}function at(e){var t=e.prev,n=e,r=e.next;if(mt(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(yt(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&mt(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function ot(e,t,n,r){var i=e.prev,o=e,a=e.next;if(mt(i,o,a)>=0)return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,l=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,c=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,u=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,h=vt(s,l,t,n,r),d=vt(c,u,t,n,r),p=e.nextZ;p&&p.z<=d;){if(p!==e.prev&&p!==e.next&&yt(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&mt(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=e.prevZ;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&yt(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&mt(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function st(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!Mt(i,o)&&wt(i,r,r.next,o)&&Lt(i,o)&&Lt(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),Pt(r),Pt(r.next),r=e=o),r=r.next}while(r!==e);return r}function ht(e,t,n,r,i,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&dt(a,s)){var l=qt(a,s);return a=rt(a,a.next),l=rt(l,l.next),it(a,t,n,r,i,o),void it(l,t,n,r,i,o)}s=s.next}a=a.next}while(a!==e)}function ct(e,t){return e.x-t.x}function ft(e,t){if(t=function lt(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===a)return n.prev;var l,c=n,u=n.x,h=n.y,d=1/0;for(r=n.next;r!==c;)i>=r.x&&r.x>=u&&yt(o<h?i:a,o,u,h,o<h?a:i,o,r.x,r.y)&&((l=Math.abs(o-r.y)/(i-r.x))<d||l===d&&r.x>n.x)&&Lt(r,e)&&(n=r,d=l),r=r.next;return n}(e,t)){var n=qt(t,e);rt(n,n.next)}}function vt(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function xt(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function yt(e,t,n,r,i,o,a,s){return(i-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(r-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function dt(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function bt(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&wt(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&Lt(e,t)&&Lt(t,e)&&function At(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)}function mt(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Mt(e,t){return e.x===t.x&&e.y===t.y}function wt(e,t,n,r){return!!(Mt(e,t)&&Mt(n,r)||Mt(e,r)&&Mt(n,t))||mt(e,t,n)>0!=mt(e,t,r)>0&&mt(n,r,e)>0!=mt(n,r,t)>0}function Lt(e,t){return mt(e.prev,e,e.next)<0?mt(e,t,e.next)>=0&&mt(e,e.prev,t)>=0:mt(e,t,e.prev)<0||mt(e,e.next,t)<0}function qt(e,t){var n=new _t(e.i,e.x,e.y),r=new _t(t.i,t.x,t.y),i=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function kt(e,t,n,r){var i=new _t(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Pt(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function _t(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Et(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function St(e,t){var n=t.id,r=t.bbox,i=null==t.properties?{}:t.properties,o=Ct(e,t);return null==n&&null==r?{type:"Feature",properties:i,geometry:o}:null==r?{type:"Feature",id:n,properties:i,geometry:o}:{type:"Feature",id:n,bbox:r,properties:i,geometry:o}}function Ct(t,n){function e(e,t){t.length&&t.pop();for(var n=c[e<0?~e:e],r=0,i=n.length;r<i;++r)t.push(l(n[r],r));e<0&&Ee(t,i)}function r(e){return l(e)}function i(t){for(var n=[],r=0,i=t.length;r<i;++r)e(t[r],n);return n.length<2&&n.push(n[0]),n}function a(e){for(var t=i(e);t.length<4;)t.push(t[0]);return t}function o(e){return e.map(a)}var l=Re(t.transform),c=t.arcs;return function s(e){var t,n=e.type;switch(n){case"GeometryCollection":return{type:n,geometries:e.geometries.map(s)};case"Point":t=r(e.coordinates);break;case"MultiPoint":t=e.coordinates.map(r);break;case"LineString":t=i(e.arcs);break;case"MultiLineString":t=e.arcs.map(i);break;case"Polygon":t=o(e.arcs);break;case"MultiPolygon":t=e.arcs.map(o);break;default:return null}return{type:n,coordinates:t}}(n)}function Tt(t,n){function r(e){e.forEach(function(t){t.forEach(function(t){(o[t=t<0?~t:t]||(o[t]=[])).push(e)})}),a.push(e)}function i(e){return function Zt(e){for(var t,n=-1,r=e.length,i=e[r-1],o=0;++n<r;)t=i,i=e[n],o+=t[0]*i[1]-t[1]*i[0];return Math.abs(o)}(Ct(t,{type:"Polygon",arcs:[e]}).coordinates[0])}var o={},a=[],s=[];return n.forEach(function e(t){switch(t.type){case"GeometryCollection":t.geometries.forEach(e);break;case"Polygon":r(t.arcs);break;case"MultiPolygon":t.arcs.forEach(r)}}),a.forEach(function(e){if(!e._){var t=[],n=[e];for(e._=1,s.push(t);e=n.pop();)t.push(e),e.forEach(function(e){e.forEach(function(e){o[e<0?~e:e].forEach(function(e){e._||(e._=1,n.push(e))})})})}}),a.forEach(function(e){delete e._}),{type:"MultiPolygon",arcs:s.map(function(e){var n,r=[];if(e.forEach(function(e){e.forEach(function(e){e.forEach(function(e){o[e<0?~e:e].length<2&&r.push(e)})})}),(n=(r=ze(t,r)).length)>1)for(var a,s,l=1,c=i(r[0]);l<n;++l)(a=i(r[l]))>c&&(s=r[0],r[0]=r[l],r[l]=s,c=a);return r})}}function Yt(e,t,n){void 0===n&&(n={});var r=n.maxSegmentLength;void 0===r&&(r=10);var i=n.string;void 0===i&&(i=!0);var o=n.single;void 0===o&&(o=!1);var a=J(e,r);a.length<t.length+2&&W(a,t.length+2-a.length);var s,l=Be(a,t.length),c=t.map(function(e){return J(e,r)}),u="string"==typeof e&&e;return o&&!t.every(function(e){return"string"==typeof e})||(s=t.slice(0)),Dt(l,c,{match:!0,string:i,single:o,t0:u,t1:s})}function Dt(e,t,n){void 0===n&&(n={});var r=n.string,i=n.single,o=n.t0,a=n.t1,s=n.match,l=s?Ne(e,t):e.map(function(e,t){return t}),c=l.map(function(n,i){return tt(e[n],t[i],r)});if(s&&Array.isArray(o)&&(o=l.map(function(e){return o[e]})),i&&r&&(Array.isArray(o)&&(o=o.join(" ")),Array.isArray(a)&&(a=a.join(" "))),i){var u=r?function(e){return c.map(function(t){return t(e)}).join(" ")}:function(e){return c.map(function(t){return t(e)})};return r&&(o||a)?function(e){return e<1e-4&&o||1-e<1e-4&&a||u(e)}:u}return r?(o=Array.isArray(o)?o.map(function(e){return"string"==typeof e&&e}):[],a=Array.isArray(a)?a.map(function(e){return"string"==typeof e&&e}):[],c.map(function(e,t){return o[t]||a[t]?function(n){return n<1e-4&&o[t]||1-n<1e-4&&a[t]||e(n)}:e})):c}function Ht(e,t,n,r,i){return Rt(function Bt(e,t,n){return function(r){var i=Y(r),o=te(r.concat([r[0]])),a=Math.atan2(r[0][1]-i[1],r[0][0]-i[0]),s=0;return r.map(function(i,l){var c;return l&&(s+=F(i,r[l-1])),c=a+2*Math.PI*(o?s/o:l/r.length),[Math.cos(c)*n+e,Math.sin(c)*n+t]})}}(e,t,n),r,function Jt(e,t,n){var r=e-n+","+t,i="A"+n+","+n+",0,1,1,";return"M"+r+i+(e+n)+","+t+i+r+"Z"}(e,t,n),2*Math.PI*n,i)}function Qt(e,t,n,r,i,o){return Rt(function Wt(e,t,n,r){return function(i){var o=Y(i),a=te(i.concat([i[0]])),s=Math.atan2(i[0][1]-o[1],i[0][0]-o[0]),l=0;s<0&&(s=2*Math.PI+s);var c=s/(2*Math.PI);return i.map(function(o,s){s&&(l+=F(o,i[s-1]));var u=function $t(e){return e<=1/8?[1,.5+4*e]:e<=3/8?[1.5-4*e,1]:e<=5/8?[0,2.5-4*e]:e<=7/8?[4*e-2.5,0]:[1,4*e-3.5]}((c+(a?l/a:s/i.length))%1);return[e+u[0]*n,t+u[1]*r]})}}(e,t,n,r),i,function Kt(e,t,n,r){var i=e+n,o=t+r;return"M"+e+","+t+"L"+i+","+t+"L"+i+","+o+"L"+e+","+o+"Z"}(e,t,n,r),2*n+2*r,o)}function Rt(e,t,n,r,i){void 0===i&&(i={});var o=i.maxSegmentLength;void 0===o&&(o=10);var a=i.string;void 0===a&&(a=!0);var s,l,c=J(t,o);return X(r)&&c.length<r/o&&W(c,Math.ceil(r/o-c.length)),s=e(c),l=I(s,c,a),a?function(e){return e<1e-4?n:l(e)}:l}var V=function(e){for(var t,n=-1,r=e.length,i=e[r-1],o=0;++n<r;)t=i,i=e[n],o+=t[1]*i[0]-t[0]*i[1];return o/2},ee=function(e){for(var t,n,r=-1,i=e.length,o=0,a=0,s=e[i-1],l=0;++r<i;)t=s,s=e[r],l+=n=t[0]*s[1]-s[0]*t[1],o+=(t[0]+s[0])*n,a+=(t[1]+s[1])*n;return[o/(l*=3),a/l]},te=function(e){for(var t,n,r=-1,i=e.length,o=e[i-1],a=o[0],s=o[1],l=0;++r<i;)t=a,n=s,t-=a=(o=e[r])[0],n-=s=o[1],l+=Math.sqrt(t*t+n*n);return l},ne={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},re=[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279],ie=function(e){var t=new function a(e){this.index=0,this.path=e,this.max=e.length,this.result=[],this.param=0,this.err="",this.segmentStart=0,this.data=[]}(e),n=t.max;for(o(t);t.index<n&&!t.err.length;)u(t);return t.err.length?t.result=[]:t.result.length&&("mM".indexOf(t.result[0][0])<0?(t.err="SvgPath: string should start with `M` or `m`",t.result=[]):t.result[0][0]="M"),{err:t.err,segments:t.result}};f.prototype.matrix=function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&1===e[3]&&0===e[4]&&0===e[5]?this:(this.cache=null,this.queue.push(e),this)},f.prototype.translate=function(e,t){return 0===e&&0===t||(this.cache=null,this.queue.push([1,0,0,1,e,t])),this},f.prototype.scale=function(e,t){return 1===e&&1===t||(this.cache=null,this.queue.push([e,0,0,t,0,0])),this},f.prototype.rotate=function(e,t,n){var r,i,o;return 0!==e&&(this.translate(t,n),r=e*Math.PI/180,i=Math.cos(r),o=Math.sin(r),this.queue.push([i,o,-o,i,0,0]),this.cache=null,this.translate(-t,-n)),this},f.prototype.skewX=function(e){return 0!==e&&(this.cache=null,this.queue.push([1,0,Math.tan(e*Math.PI/180),1,0,0])),this},f.prototype.skewY=function(e){return 0!==e&&(this.cache=null,this.queue.push([1,Math.tan(e*Math.PI/180),0,1,0,0])),this},f.prototype.toArray=function(){var e=this;if(this.cache)return this.cache;if(!this.queue.length)return this.cache=[1,0,0,1,0,0],this.cache;if(this.cache=this.queue[0],1===this.queue.length)return this.cache;for(var t=1;t<this.queue.length;t++)e.cache=c(e.cache,e.queue[t]);return this.cache},f.prototype.calc=function(e,t,n){var r;return this.queue.length?(this.cache||(this.cache=this.toArray()),[e*(r=this.cache)[0]+t*r[2]+(n?0:r[4]),e*r[1]+t*r[3]+(n?0:r[5])]):[e,t]};var oe=f,ae={matrix:!0,scale:!0,rotate:!0,translate:!0,skewX:!0,skewY:!0},se=/\s*(matrix|translate|scale|rotate|skewX|skewY)\s*\(\s*(.+?)\s*\)[\s,]*/,le=/[\s,]+/,ce=2*Math.PI,ue=Math.PI/180;v.prototype.transform=function(e){var t=Math.cos(this.ax*ue),n=Math.sin(this.ax*ue),r=[this.rx*(e[0]*t+e[2]*n),this.rx*(e[1]*t+e[3]*n),this.ry*(-e[0]*n+e[2]*t),this.ry*(-e[1]*n+e[3]*t)],i=r[0]*r[0]+r[2]*r[2],o=r[1]*r[1]+r[3]*r[3],a=((r[0]-r[3])*(r[0]-r[3])+(r[2]+r[1])*(r[2]+r[1]))*((r[0]+r[3])*(r[0]+r[3])+(r[2]-r[1])*(r[2]-r[1])),s=(i+o)/2;if(a<1e-10*s)return this.rx=this.ry=Math.sqrt(s),this.ax=0,this;var l=r[0]*r[1]+r[2]*r[3],c=s+(a=Math.sqrt(a))/2,u=s-a/2;return this.ax=Math.abs(l)<1e-10&&Math.abs(c-o)<1e-10?90:180*Math.atan(Math.abs(l)>Math.abs(c-o)?(c-i)/l:l/(c-o))/Math.PI,this.ax>=0?(this.rx=Math.sqrt(c),this.ry=Math.sqrt(u)):(this.ax+=90,this.rx=Math.sqrt(u),this.ry=Math.sqrt(c)),this},v.prototype.isDegenerate=function(){return this.rx<1e-10*this.ry||this.ry<1e-10*this.rx};var he=v;x.prototype.__matrix=function(e){var t,n=this;e.queue.length&&this.iterate(function(r,i,o,a){var s,l,c,u;switch(r[0]){case"v":l=0===(s=e.calc(0,r[1],!0))[0]?["v",s[1]]:["l",s[0],s[1]];break;case"V":l=(s=e.calc(o,r[1],!1))[0]===e.calc(o,a,!1)[0]?["V",s[1]]:["L",s[0],s[1]];break;case"h":l=0===(s=e.calc(r[1],0,!0))[1]?["h",s[0]]:["l",s[0],s[1]];break;case"H":l=(s=e.calc(r[1],a,!1))[1]===e.calc(o,a,!1)[1]?["H",s[0]]:["L",s[0],s[1]];break;case"a":case"A":var h=e.toArray(),d=he(r[1],r[2],r[3]).transform(h);if(h[0]*h[3]-h[1]*h[2]<0&&(r[5]=r[5]?"0":"1"),s=e.calc(r[6],r[7],"a"===r[0]),"A"===r[0]&&r[6]===o&&r[7]===a||"a"===r[0]&&0===r[6]&&0===r[7]){l=["a"===r[0]?"l":"L",s[0],s[1]];break}l=d.isDegenerate()?["a"===r[0]?"l":"L",s[0],s[1]]:[r[0],d.rx,d.ry,d.ax,r[4],r[5],s[0],s[1]];break;case"m":u=i>0,l=["m",(s=e.calc(r[1],r[2],u))[0],s[1]];break;default:for(l=[c=r[0]],u=c.toLowerCase()===c,t=1;t<r.length;t+=2)s=e.calc(r[t],r[t+1],u),l.push(s[0],s[1])}n.segments[i]=l},!0)},x.prototype.__evaluateStack=function(){var e,t;if(this.__stack.length){if(1===this.__stack.length)return this.__matrix(this.__stack[0]),void(this.__stack=[]);for(e=oe(),t=this.__stack.length;--t>=0;)e.matrix(this.__stack[t].toArray());this.__matrix(e),this.__stack=[]}},x.prototype.toString=function(){var e,t,n=this,r=[];this.__evaluateStack();for(var i=0;i<this.segments.length;i++)t=n.segments[i][0],e=i>0&&"m"!==t&&"M"!==t&&t===n.segments[i-1][0],r=r.concat(e?n.segments[i].slice(1):n.segments[i]);return r.join(" ").replace(/ ?([achlmqrstvz]) ?/gi,"$1").replace(/ \-/g,"-").replace(/zm/g,"z m")},x.prototype.translate=function(e,t){return this.__stack.push(oe().translate(e,t||0)),this},x.prototype.scale=function(e,t){return this.__stack.push(oe().scale(e,t||0===t?t:e)),this},x.prototype.rotate=function(e,t,n){return this.__stack.push(oe().rotate(e,t||0,n||0)),this},x.prototype.skewX=function(e){return this.__stack.push(oe().skewX(e)),this},x.prototype.skewY=function(e){return this.__stack.push(oe().skewY(e)),this},x.prototype.matrix=function(e){return this.__stack.push(oe().matrix(e)),this},x.prototype.transform=function(e){return e.trim()?(this.__stack.push(function(e){var t,n,r=new oe;return e.split(se).forEach(function(e){if(e.length){if(void 0!==ae[e])return void(t=e);switch(n=e.split(le).map(function(e){return+e||0}),t){case"matrix":return void(6===n.length&&r.matrix(n));case"scale":return void(1===n.length?r.scale(n[0],n[0]):2===n.length&&r.scale(n[0],n[1]));case"rotate":return void(1===n.length?r.rotate(n[0],0,0):3===n.length&&r.rotate(n[0],n[1],n[2]));case"translate":return void(1===n.length?r.translate(n[0],0):2===n.length&&r.translate(n[0],n[1]));case"skewX":return void(1===n.length&&r.skewX(n[0]));case"skewY":return void(1===n.length&&r.skewY(n[0]))}}}),r}(e)),this):this},x.prototype.round=function(e){var t,n=0,r=0,i=0,o=0;return e=e||0,this.__evaluateStack(),this.segments.forEach(function(a){var s=a[0].toLowerCase()===a[0];switch(a[0]){case"H":case"h":return s&&(a[1]+=i),i=a[1]-a[1].toFixed(e),void(a[1]=+a[1].toFixed(e));case"V":case"v":return s&&(a[1]+=o),o=a[1]-a[1].toFixed(e),void(a[1]=+a[1].toFixed(e));case"Z":case"z":return i=n,void(o=r);case"M":case"m":return s&&(a[1]+=i,a[2]+=o),i=a[1]-a[1].toFixed(e),o=a[2]-a[2].toFixed(e),n=i,r=o,a[1]=+a[1].toFixed(e),void(a[2]=+a[2].toFixed(e));case"A":case"a":return s&&(a[6]+=i,a[7]+=o),i=a[6]-a[6].toFixed(e),o=a[7]-a[7].toFixed(e),a[1]=+a[1].toFixed(e),a[2]=+a[2].toFixed(e),a[3]=+a[3].toFixed(e+2),a[6]=+a[6].toFixed(e),void(a[7]=+a[7].toFixed(e));default:return t=a.length,s&&(a[t-2]+=i,a[t-1]+=o),i=a[t-2]-a[t-2].toFixed(e),o=a[t-1]-a[t-1].toFixed(e),void a.forEach(function(t,n){n&&(a[n]=+a[n].toFixed(e))})}}),this},x.prototype.iterate=function(e,t){var n,r,i,o=this.segments,a={},s=!1,l=0,c=0,u=0,h=0;if(t||this.__evaluateStack(),o.forEach(function(t,n){var r=e(t,n,l,c);Array.isArray(r)&&(a[n]=r,s=!0);var i=t[0]===t[0].toLowerCase();switch(t[0]){case"m":case"M":return l=t[1]+(i?l:0),c=t[2]+(i?c:0),u=l,void(h=c);case"h":case"H":return void(l=t[1]+(i?l:0));case"v":case"V":return void(c=t[1]+(i?c:0));case"z":case"Z":return l=u,void(c=h);default:l=t[t.length-2]+(i?l:0),c=t[t.length-1]+(i?c:0)}}),!s)return this;for(i=[],n=0;n<o.length;n++)if(void 0!==a[n])for(r=0;r<a[n].length;r++)i.push(a[n][r]);else i.push(o[n]);return this.segments=i,this},x.prototype.abs=function(){return this.iterate(function(e,t,n,r){var i,o=e[0],a=o.toUpperCase();if(o!==a)switch(e[0]=a,o){case"v":return void(e[1]+=r);case"a":return e[6]+=n,void(e[7]+=r);default:for(i=1;i<e.length;i++)e[i]+=i%2?n:r}},!0),this},x.prototype.rel=function(){return this.iterate(function(e,t,n,r){var i,o=e[0],a=o.toLowerCase();if(o!==a&&(0!==t||"M"!==o))switch(e[0]=a,o){case"V":return void(e[1]-=r);case"A":return e[6]-=n,void(e[7]-=r);default:for(i=1;i<e.length;i++)e[i]-=i%2?n:r}},!0),this},x.prototype.unarc=function(){return this.iterate(function(e,t,n,r){var i,o,a,s=[],l=e[0];return"A"!==l&&"a"!==l?null:("a"===l?(o=n+e[6],a=r+e[7]):(o=e[6],a=e[7]),0===(i=function(e,t,n,r,i,o,a,s,l){var c=Math.sin(l*ce/360),u=Math.cos(l*ce/360),h=u*(e-n)/2+c*(t-r)/2,d=-c*(e-n)/2+u*(t-r)/2;if(0===h&&0===d)return[];if(0===a||0===s)return[];a=Math.abs(a),s=Math.abs(s);var f=h*h/(a*a)+d*d/(s*s);f>1&&(a*=Math.sqrt(f),s*=Math.sqrt(f));var m=p(e,t,n,r,i,o,a,s,c,u),v=[],y=m[2],_=m[3],b=Math.max(Math.ceil(Math.abs(_)/(ce/4)),1);_/=b;for(var x=0;x<b;x++)v.push(g(y,_)),y+=_;return v.map(function(e){for(var t=0;t<e.length;t+=2){var n=e[t+0],r=e[t+1],i=u*(n*=a)-c*(r*=s),o=c*n+u*r;e[t+0]=i+m[0],e[t+1]=o+m[1]}return e})}(n,r,o,a,e[4],e[5],e[1],e[2],e[3])).length?[["a"===e[0]?"l":"L",e[6],e[7]]]:(i.forEach(function(e){s.push(["C",e[2],e[3],e[4],e[5],e[6],e[7]])}),s))}),this},x.prototype.unshort=function(){var e,t,n,r,i,o=this.segments;return this.iterate(function(a,s,l,c){var u,h=a[0],d=h.toUpperCase();s&&("T"===d?(u="t"===h,"Q"===(n=o[s-1])[0]?(e=n[1]-l,t=n[2]-c):"q"===n[0]?(e=n[1]-n[3],t=n[2]-n[4]):(e=0,t=0),r=-e,i=-t,u||(r+=l,i+=c),o[s]=[u?"q":"Q",r,i,a[1],a[2]]):"S"===d&&(u="s"===h,"C"===(n=o[s-1])[0]?(e=n[3]-l,t=n[4]-c):"c"===n[0]?(e=n[3]-n[5],t=n[4]-n[6]):(e=0,t=0),r=-e,i=-t,u||(r+=l,i+=c),o[s]=[u?"c":"C",r,i,a[1],a[2],a[3],a[4]]))}),this};var de=x,pe={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},fe=/([astvzqmhlc])([^astvzqmhlc]*)/gi,ge=function(e){var t=[];return e.replace(fe,function(e,n,r){var i=n.toLowerCase();for(r=function y(e){var t=e.match(me);return t?t.map(Number):[]}(r),"m"===i&&r.length>2&&(t.push([n].concat(r.splice(0,2))),i="l",n="m"===n?"l":"L");r.length>=0;){if(r.length===pe[i])return r.unshift(n),t.push(r);if(r.length<pe[i])throw new Error("malformed path data");t.push([n].concat(r.splice(0,pe[i])))}}),t},me=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi,ve=function(e,t,n,r,i,o,a,s){return new d(e,t,n,r,i,o,a,s)};d.prototype={constructor:d,init:function(){this.length=this.getArcLength([this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y])},getTotalLength:function(){return this.length},getPointAtLength:function(e){var t=w(e,this.length,this.getArcLength,[this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y]);return this.getPoint([this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y],t)},getTangentAtLength:function(e){var t=w(e,this.length,this.getArcLength,[this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y]),n=this.getDerivative([this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y],t),r=Math.sqrt(n.x*n.x+n.y*n.y);return r>0?{x:n.x/r,y:n.y/r}:{x:0,y:0}},getPropertiesAtLength:function(e){var t,n=w(e,this.length,this.getArcLength,[this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y]),r=this.getDerivative([this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y],n),i=Math.sqrt(r.x*r.x+r.y*r.y);t=i>0?{x:r.x/i,y:r.y/i}:{x:0,y:0};var o=this.getPoint([this.a.x,this.b.x,this.c.x,this.d.x],[this.a.y,this.b.y,this.c.y,this.d.y],n);return{x:o.x,y:o.y,tangentX:t.x,tangentY:t.y}}};var ye=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],_e=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],be=[[1],[1,1],[1,2,1],[1,3,3,1]],xe=2*Math.PI,we=function(e,t,n,r,i,o,a,s,l){var c=Math.sin(i*xe/360),u=Math.cos(i*xe/360),h=u*(e-s)/2+c*(t-l)/2,d=-c*(e-s)/2+u*(t-l)/2;if(0===h&&0===d)return[];if(0===n||0===r)return[];n=Math.abs(n),r=Math.abs(r);var p=h*h/(n*n)+d*d/(r*r);p>1&&(n*=Math.sqrt(p),r*=Math.sqrt(p));var f=function S(e,t,n,r,i,o,a,s,l,c){var u=c*(e-n)/2+l*(t-r)/2,h=-l*(e-n)/2+c*(t-r)/2,d=a*a,p=s*s,f=u*u,g=h*h,m=d*p-d*g-p*f;m<0&&(m=0),m/=d*g+p*f;var v=(m=Math.sqrt(m)*(i===o?-1:1))*a/s*h,y=m*-s/a*u,_=c*v-l*y+(e+n)/2,b=l*v+c*y+(t+r)/2,x=(u-v)/a,w=(h-y)/s,k=(-u-v)/a,S=(-h-y)/s,C=E(1,0,x,w),M=E(x,w,k,S);return 0===o&&M>0&&(M-=xe),1===o&&M<0&&(M+=xe),[_,b,C,M]}(e,t,s,l,o,a,n,r,c,u),g=[],m=f[2],v=f[3],y=Math.max(Math.ceil(Math.abs(v)/(xe/4)),1);v/=y;for(var _=0;_<y;_++)g.push(C(m,v)),m+=v;return g.map(function(e){for(var t=0;t<e.length;t+=2){var i=e[t+0],o=e[t+1],a=u*(i*=n)-c*(o*=r),s=c*i+u*o;e[t+0]=a+f[0],e[t+1]=s+f[1]}return e})},ke=function(e,t,n,r,i,o,a,s,l){return new Z(e,t,n,r,i,o,a,s,l)};Z.prototype={constructor:Z,init:function(){},getTotalLength:function(){return this.length},getPointAtLength:function(e){e<0?e=0:e>this.length&&(e=this.length);for(var t=this.partialLengths.length-1;this.partialLengths[t]>=e&&this.partialLengths[t]>0;)t--;t<this.partialLengths.length-1&&t++;for(var n=0,r=0;r<t;r++)n+=this.partialLengths[r];return this.curves[t].getPointAtLength(e-n)},getTangentAtLength:function(e){e<0?e=0:e>this.length&&(e=this.length);for(var t=this.partialLengths.length-1;this.partialLengths[t]>=e&&this.partialLengths[t]>0;)t--;t<this.partialLengths.length-1&&t++;for(var n=0,r=0;r<t;r++)n+=this.partialLengths[r];return this.curves[t].getTangentAtLength(e-n)},getPropertiesAtLength:function(e){var t=this.getTangentAtLength(e),n=this.getPointAtLength(e);return{x:n.x,y:n.y,tangentX:t.x,tangentY:t.y}}};var Se=function(e,t,n,r){return new T(e,t,n,r)};T.prototype.getTotalLength=function(){return Math.sqrt(Math.pow(this.x0-this.x1,2)+Math.pow(this.y0-this.y1,2))},T.prototype.getPointAtLength=function(e){var t=e/Math.sqrt(Math.pow(this.x0-this.x1,2)+Math.pow(this.y0-this.y1,2)),n=(this.x1-this.x0)*t,r=(this.y1-this.y0)*t;return{x:this.x0+n,y:this.y0+r}},T.prototype.getTangentAtLength=function(){var e=Math.sqrt((this.x1-this.x0)*(this.x1-this.x0)+(this.y1-this.y0)*(this.y1-this.y0));return{x:(this.x1-this.x0)/e,y:(this.y1-this.y0)/e}},T.prototype.getPropertiesAtLength=function(e){var t=this.getPointAtLength(e),n=this.getTangentAtLength();return{x:t.x,y:t.y,tangentX:n.x,tangentY:n.y}};var Ce=function(e){function n(e){if(!e)return null;for(var o,a=ge(e),s=[0,0],l=[0,0],c=0;c<a.length;c++)"M"===a[c][0]?(s=[a[c][1],a[c][2]],i.push(null)):"m"===a[c][0]?(s=[a[c][1]+s[0],a[c][2]+s[1]],i.push(null)):"L"===a[c][0]?(t+=Math.sqrt(Math.pow(s[0]-a[c][1],2)+Math.pow(s[1]-a[c][2],2)),i.push(new Se(s[0],a[c][1],s[1],a[c][2])),s=[a[c][1],a[c][2]]):"l"===a[c][0]?(t+=Math.sqrt(Math.pow(a[c][1],2)+Math.pow(a[c][2],2)),i.push(new Se(s[0],a[c][1]+s[0],s[1],a[c][2]+s[1])),s=[a[c][1]+s[0],a[c][2]+s[1]]):"H"===a[c][0]?(t+=Math.abs(s[0]-a[c][1]),i.push(new Se(s[0],a[c][1],s[1],s[1])),s[0]=a[c][1]):"h"===a[c][0]?(t+=Math.abs(a[c][1]),i.push(new Se(s[0],s[0]+a[c][1],s[1],s[1])),s[0]=a[c][1]+s[0]):"V"===a[c][0]?(t+=Math.abs(s[1]-a[c][1]),i.push(new Se(s[0],s[0],s[1],a[c][1])),s[1]=a[c][1]):"v"===a[c][0]?(t+=Math.abs(a[c][1]),i.push(new Se(s[0],s[0],s[1],s[1]+a[c][1])),s[1]=a[c][1]+s[1]):"z"===a[c][0]||"Z"===a[c][0]?(t+=Math.sqrt(Math.pow(a[0][1]-s[0],2)+Math.pow(a[0][2]-s[1],2)),i.push(new Se(s[0],a[0][1],s[1],a[0][2])),s=[a[0][1],a[0][2]]):"C"===a[c][0]?(o=new ve(s[0],s[1],a[c][1],a[c][2],a[c][3],a[c][4],a[c][5],a[c][6]),t+=o.getTotalLength(),s=[a[c][5],a[c][6]],i.push(o)):"c"===a[c][0]?(o=new ve(s[0],s[1],s[0]+a[c][1],s[1]+a[c][2],s[0]+a[c][3],s[1]+a[c][4],s[0]+a[c][5],s[1]+a[c][6]),t+=o.getTotalLength(),s=[a[c][5]+s[0],a[c][6]+s[1]],i.push(o)):"S"===a[c][0]?(o=c>0&&["C","c","S","s"].indexOf(a[c-1][0])>-1?new ve(s[0],s[1],2*s[0]-a[c-1][a[c-1].length-4],2*s[1]-a[c-1][a[c-1].length-3],a[c][1],a[c][2],a[c][3],a[c][4]):new ve(s[0],s[1],s[0],s[1],a[c][1],a[c][2],a[c][3],a[c][4]),t+=o.getTotalLength(),s=[a[c][3],a[c][4]],i.push(o)):"s"===a[c][0]?(o=c>0&&["C","c","S","s"].indexOf(a[c-1][0])>-1?new ve(s[0],s[1],s[0]+o.d.x-o.c.x,s[1]+o.d.y-o.c.y,s[0]+a[c][1],s[1]+a[c][2],s[0]+a[c][3],s[1]+a[c][4]):new ve(s[0],s[1],s[0],s[1],s[0]+a[c][1],s[1]+a[c][2],s[0]+a[c][3],s[1]+a[c][4]),t+=o.getTotalLength(),s=[a[c][3]+s[0],a[c][4]+s[1]],i.push(o)):"Q"===a[c][0]?(o=new ve(s[0],s[1],a[c][1],a[c][2],a[c][3],a[c][4]),t+=o.getTotalLength(),i.push(o),s=[a[c][3],a[c][4]],l=[a[c][1],a[c][2]]):"q"===a[c][0]?(o=new ve(s[0],s[1],s[0]+a[c][1],s[1]+a[c][2],s[0]+a[c][3],s[1]+a[c][4]),t+=o.getTotalLength(),l=[s[0]+a[c][1],s[1]+a[c][2]],s=[a[c][3]+s[0],a[c][4]+s[1]],i.push(o)):"T"===a[c][0]?(o=c>0&&["Q","q","T","t"].indexOf(a[c-1][0])>-1?new ve(s[0],s[1],2*s[0]-l[0],2*s[1]-l[1],a[c][1],a[c][2]):new Se(s[0],a[c][1],s[1],a[c][2]),i.push(o),t+=o.getTotalLength(),l=[2*s[0]-l[0],2*s[1]-l[1]],s=[a[c][1],a[c][2]]):"t"===a[c][0]?(o=c>0&&["Q","q","T","t"].indexOf(a[c-1][0])>-1?new ve(s[0],s[1],2*s[0]-l[0],2*s[1]-l[1],s[0]+a[c][1],s[1]+a[c][2]):new Se(s[0],s[0]+a[c][1],s[1],s[1]+a[c][2]),t+=o.getTotalLength(),l=[2*s[0]-l[0],2*s[1]-l[1]],s=[a[c][1]+s[0],a[c][2]+s[0]],i.push(o)):"A"===a[c][0]?(o=new ke(s[0],s[1],a[c][1],a[c][2],a[c][3],a[c][4],a[c][5],a[c][6],a[c][7]),t+=o.getTotalLength(),s=[a[c][6],a[c][7]],i.push(o)):"a"===a[c][0]&&(o=new ke(s[0],s[1],a[c][1],a[c][2],a[c][3],a[c][4],a[c][5],s[0]+a[c][6],s[1]+a[c][7]),t+=o.getTotalLength(),s=[s[0]+a[c][6],s[1]+a[c][7]],i.push(o)),r.push(t);return n}var t=0,r=[],i=[];n.getTotalLength=function(){return t},n.getPointAtLength=function(e){var t=o(e);return i[t.i].getPointAtLength(t.fraction)},n.getTangentAtLength=function(e){var t=o(e);return i[t.i].getTangentAtLength(t.fraction)},n.getPropertiesAtLength=function(e){var t=o(e);return i[t.i].getPropertiesAtLength(t.fraction)};var o=function(e){e<0?e=0:e>t&&(e=t);for(var n=r.length-1;r[n]>=e&&r[n]>0;)n--;return{fraction:e-r[++n-1],i:n}};return n(e)},Me='All shapes must be supplied as arrays of [x, y] points or an SVG path string (https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d).\nExample valid ways of supplying a shape would be:\n[[0, 0], [10, 0], [10, 10]]\n"M0,0 L10,0 L10,10Z"\n',Te="flubber.all() expects two arrays of equal length as arguments. Each element in both arrays should be an array of [x, y] points or an SVG path string (https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d).",Pe=function(e,t){for(var n,r,i,o=e.length,a=1/0,s=0;s<o;s++)!function(i){r=0,t.forEach(function(t,n){var a=F(e[(i+n)%o],t);r+=a*a}),r<a&&(a=r,n=i)}(s);n&&(i=e.splice(0,n),e.splice.apply(e,[e.length,0].concat(i)))},Ae=nt;nt.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(Et(e,0,o,n));if(i)for(var s=0,l=t.length;s<l;s++){var c=t[s]*n,u=s<l-1?t[s+1]*n:e.length;a-=Math.abs(Et(e,c,u,n))}var h=0;for(s=0;s<r.length;s+=3){var d=r[s]*n,p=r[s+1]*n,f=r[s+2]*n;h+=Math.abs((e[d]-e[f])*(e[p+1]-e[d+1])-(e[d]-e[p])*(e[f+1]-e[d+1]))}return 0===a&&0===h?0:Math.abs((h-a)/a)},nt.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n};var Le=function(e){return e},Re=function(e){if(null==e)return Le;var t,n,r=e.scale[0],i=e.scale[1],o=e.translate[0],a=e.translate[1];return function(e,s){s||(t=n=0);var l=2,c=e.length,u=new Array(c);for(u[0]=(t+=e[0])*r+o,u[1]=(n+=e[1])*i+a;l<c;)u[l]=e[l],++l;return u}},Ee=function(e,t){for(var n,r=e.length,i=r-t;i<--r;)n=e[i],e[i++]=e[r],e[r]=n},Oe=function(e,t){return"GeometryCollection"===t.type?{type:"FeatureCollection",features:t.geometries.map(function(t){return St(e,t)})}:St(e,t)},ze=function(t,n){function e(e){var n,r=t.arcs[e<0?~e:e],i=r[0];return t.transform?(n=[0,0],r.forEach(function(e){n[0]+=e[0],n[1]+=e[1]})):n=r[r.length-1],e<0?[n,i]:[i,n]}function r(e,t){for(var n in e){var r=e[n];delete t[r.start],delete r.start,delete r.end,r.forEach(function(e){i[e<0?~e:e]=1}),s.push(r)}}var i={},o={},a={},s=[],l=-1;return n.forEach(function(e,r){var i,o=t.arcs[e<0?~e:e];o.length<3&&!o[1][0]&&!o[1][1]&&(i=n[++l],n[l]=e,n[r]=i)}),n.forEach(function(t){var n,r,i=e(t),s=i[0],l=i[1];if(n=a[s])if(delete a[n.end],n.push(t),n.end=l,r=o[l]){delete o[r.start];var c=r===n?n:n.concat(r);o[c.start=n.start]=a[c.end=r.end]=c}else o[n.start]=a[n.end]=n;else if(n=o[l])if(delete o[n.start],n.unshift(t),n.start=s,r=a[s]){delete a[r.end];var u=r===n?n:r.concat(n);o[u.start=r.start]=a[u.end=n.end]=u}else o[n.start]=a[n.end]=n;else o[(n=[t]).start=s]=a[n.end=l]=n}),r(a,o),r(o,a),n.forEach(function(e){i[e<0?~e:e]||s.push([e])}),s},De=function(e,t){for(var n=0,r=e.length;n<r;){var i=n+r>>>1;e[i]<t?n=i+1:r=i}return n},Ie=function(t){function n(e,t){e.forEach(function(e){e<0&&(e=~e);var n=i[e];n?n.push(t):i[e]=[t]})}function e(e,t){e.forEach(function(e){n(e,t)})}var i={},o=t.map(function(){return[]}),a={LineString:n,MultiLineString:e,Polygon:e,MultiPolygon:function(t,n){t.forEach(function(t){e(t,n)})}};for(var s in t.forEach(function r(e,t){"GeometryCollection"===e.type?e.geometries.forEach(function(e){r(e,t)}):e.type in a&&a[e.type](e.arcs,t)}),i)for(var l=i[s],c=l.length,u=0;u<c;++u)for(var h=u+1;h<c;++h){var d,p=l[u],f=l[h];(d=o[p])[s=De(d,f)]!==f&&d.splice(s,0,f),(d=o[f])[s=De(d,p)]!==p&&d.splice(s,0,p)}return o},Fe=function(e,t){return e<t?-1:e>t?1:e>=t?0:NaN},je=function(e){return 1===e.length&&(e=function Ft(e){return function(t,n){return Fe(e(t),n)}}(e)),{left:function(t,n,r,i){for(null==r&&(r=0),null==i&&(i=t.length);r<i;){var o=r+i>>>1;e(t[o],n)<0?r=o+1:i=o}return r},right:function(t,n,r,i){for(null==r&&(r=0),null==i&&(i=t.length);r<i;){var o=r+i>>>1;e(t[o],n)>0?i=o:r=o+1}return r}}},Be=(je(Fe).right,Math.sqrt(50),Math.sqrt(10),Math.sqrt(2),function(e,t){return function jt(e,t){for(var n=e.objects.triangles.geometries,r=je(function(e){return e.area}).left;n.length>t;)!function(){var t=n[0],i=Ie(n)[0][0],o=n[i],a=Tt(e,[t,o]);a.area=t.area+o.area,a.type="Polygon",a.arcs=a.arcs[0],n.splice(i,1),n.shift(),n.splice(r(n,a.area),0,a)}();if(t>n.length)throw new RangeError("Can't collapse topology into "+t+" pieces.");return Oe(e,e.objects.triangles).features.map(function(e){return e.geometry.coordinates[0].pop(),e.geometry.coordinates[0]})}(function zt(e,t){var n={},r={type:"Topology",objects:{triangles:{type:"GeometryCollection",geometries:[]}},arcs:[]};return e.forEach(function(e){var i=[];e.forEach(function(e,o){var a=e[0]<e[1]?e.join(","):e[1]+","+e[0],s=e.map(function(e){return t[e]});a in n?i.push(~n[a]):(i.push(n[a]=r.arcs.length),r.arcs.push(s))}),r.objects.triangles.geometries.push({type:"Polygon",area:Math.abs(V(e.map(function(e){return t[e[0]]}))),arcs:[i]})}),r.objects.triangles.geometries.sort(function(e,t){return e.area-t.area}),r}(function It(e){for(var t=Ae(e.reduce(function(e,t){return e.concat([t[0]],[t[1]])},[])),n=[],r=0,i=t.length;r<i;r+=3)n.push([[t[r],t[r+1]],[t[r+1],t[r+2]],[t[r+2],t[r]]]);return n}(e),e),t)}),Ne=function(e,t){return e.length>8?e.map(function(e,t){return t}):function Vt(e,t,n){var i=1/0,o=e.map(function(e,t){return t});return function r(e,t,a){void 0===t&&(t=[]),void 0===a&&(a=0);for(var s=0;s<e.length;s++){var l=e.splice(s,1),c=n[l[0]][t.length];a+c<i&&(e.length?r(e.slice(),t.concat(l),a+c):(i=a+c,o=t.concat(l))),e.length&&e.splice(s,0,l[0])}}(o),o}(e,0,e.map(function(e){return t.map(function(t){return function Xt(e,t){var n=F(Y(e),Y(t));return n*n}(e,t)})}))};t.interpolate=function(e,t,n){void 0===n&&(n={});var r=n.maxSegmentLength;void 0===r&&(r=10);var i=n.string;void 0===i&&(i=!0);var o=tt(J(e,r),J(t,r),i);return!i||"string"!=typeof e&&"string"!=typeof t?o:function(n){return n<1e-4&&"string"==typeof e?e:1-n<1e-4&&"string"==typeof t?t:o(n)}},t.separate=Yt,t.combine=function Gt(e,t,n){void 0===n&&(n={});var r=n.maxSegmentLength;void 0===r&&(r=10);var i=n.string;void 0===i&&(i=!0);var o=n.single;void 0===o&&(o=!1);var a=Yt(t,e,{maxSegmentLength:r,string:i,single:o});return o?function(e){return a(1-e)}:a.map(function(e){return function(t){return e(1-t)}})},t.interpolateAll=function Ot(e,t,n){void 0===n&&(n={});var r=n.maxSegmentLength;void 0===r&&(r=10);var i=n.string;void 0===i&&(i=!0);var o=n.single;if(void 0===o&&(o=!1),!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length||!e.length)throw new TypeError(Te);var a,s,l=function(e){return J(e,r)},c=e.map(l),u=t.map(l);return o?(e.every(function(e){return"string"==typeof e})&&(a=e.slice(0)),t.every(function(e){return"string"==typeof e})&&(s=t.slice(0))):(a=e.slice(0),s=t.slice(0)),Dt(c,u,{string:i,single:o,t0:a,t1:s,match:!1})},t.splitPathString=function N(e){return D(O(e))},t.toPathString=H,t.fromCircle=Ht,t.toCircle=function Nt(e,t,n,r,i){var o=Ht(t,n,r,e,i);return function(e){return o(1-e)}},t.fromRect=Qt,t.toRect=function Ut(e,t,n,r,i,o){var a=Qt(t,n,r,i,e,o);return function(e){return a(1-e)}},Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof n&&"undefined"!=typeof module?t(n):"function"==typeof define&&define.amd?define(["exports"],t):t(e.flubber=e.flubber||{})}(),System.global._classRecorder={},this.lively=this.lively||{},function(exports,lively_graphics,bowser,lively_lang,lively_bindings,vdom,parser,lively_morphic,flubber,Bezier,webAnimationsJs,lively_notifications,LoadingIndicator,lively_serializer2,lively_resources,lively_storage,lively_modules,lively_halos_dragGuides_js,lively_halos,lively_components_prompts_js,lively_halos_markers_js,lively_ide_styling_gradientEditor_js,Halo,lively_ide_serviceWorker_js,lively_components,lively_components_buttons_js,lively_components_canvas_js,lively_halos_layout_js,lively_components_widgets_js,lively_components_list_js){"use strict";bowser="default"in bowser?bowser.default:bowser;var vdom__default="default"in vdom?vdom.default:vdom;parser="default"in parser?parser.default:parser,Bezier="default"in Bezier?Bezier.default:Bezier,LoadingIndicator="default"in LoadingIndicator?LoadingIndicator.default:LoadingIndicator;var Halo__default="default"in Halo?Halo.default:Halo;function parseURLQuery(){if("undefined"==typeof document||!document.location)return{};var e=(document.location.hash||document.location.search).slice(1),t=e&&e.split("&"),n={};if(t)for(var r=0;r<t.length;r++){var i=t[r].split("="),o=i[0],a=!0;if(i.length>1&&(a=decodeURIComponent(i.slice(1).join("="))).match(/^(true|false|null|[0-9"[{].*)$/))try{a=JSON.parse(a)}catch(e){"["===a[0]&&(a=a.slice(1,-1).split(","))}n[o]=a}return n}"undefined"!=typeof $world&&$world.withAllSubmorphsDo(function(e){return e.hasOwnProperty("_cachedKeyhandlers")&&(e._cachedKeyhandlers=null)});var config$1={onloadURLQuery:parseURLQuery(),defaultShadow:{fast:!0,distance:18,blur:30,color:lively_graphics.Color.black.withA(.2),spread:0},undoLevels:20,halosEnabled:!0,altClickDefinesThat:!0,verboseLogging:!0,maxStatusMessages:5,repeatClickInterval:250,longClick:{minDur:500,maxDur:1e3,maxDist:2},showTooltipsAfter:.8,users:{authServerURL:"https://auth.lively-next.org",autoLoginAsGuest:!1},ide:{workerEnabled:!1,js:{ignoredPackages:["lively.web","no group",function(e){return e.includes("lively.morphic/objectdb")||e.includes("lively.next-node_modules")||e.includes("node_modules")||e.includes("custom-npm-modules")||e.includes("mocha-es6")||e.includes("test-resources/es6")}]},modes:{aliases:{sh:"shell",markdown:"md",javascript:"js",htmlmixed:"html",haskell:"hs",python:"py"}}},globalKeyBindings:[{keys:{mac:"Meta-Z",win:"Ctrl-Z"},command:"undo"},{keys:{mac:"Meta-Shift-Z",win:"Ctrl-Shift-Z"},command:"redo"},{keys:"Alt-X",command:"run command"},{keys:{mac:"Meta-S",win:"Ctrl-S"},command:"save world"},{keys:"Meta-Shift-L s a v e",command:"save this world"},{keys:"Meta-H",command:"show halo for focused morph"},{keys:"Meta-Shift-L C O P Y",command:"copy morph"},{keys:"Alt-M",command:"select morph"},{keys:"Escape",command:"escape"},{keys:{win:"Ctrl-Escape",mac:"Meta-Escape"},command:"close active window or morph"},{keys:"Alt-Shift-C",command:"toggle minimize active window"},{keys:{mac:"Meta-Shift-L W S",win:"Ctrl-Shift-L W S"},command:"search workspaces"},{keys:{mac:"Meta-O",win:"Ctrl-O"},command:"open status message of focused morph"},{keys:{win:"Ctrl-K",mac:"Meta-K"},command:{command:"open workspace",onlyWhenFocused:!1,args:{askForMode:!0}}},{keys:"Alt-Shift-1",command:{command:"open shell terminal",onlyWhenFocused:!1}},{keys:{win:"Ctrl-B",mac:"Meta-B"},command:{command:"open browser",onlyWhenFocused:!1}},{keys:{win:"Ctrl-P",mac:"Meta-P"},command:{command:"open PartsBin",onlyWhenFocused:!0}},{keys:"Alt-T",command:{command:"choose and browse module",onlyWhenFocused:!1}},{keys:"Alt-Shift-T",command:{command:"choose and browse package resources",onlyWhenFocused:!1}},{keys:"Ctrl-X D",command:"open file browser"},{keys:"Ctrl-X Ctrl-F",command:"open file"},{keys:{win:"Ctrl-Shift-F",mac:"Meta-Shift-F"},command:{command:"open code search",onlyWhenFocused:!1}},{keys:"Left",command:{command:"move or resize halo target",args:{what:"move",direction:"left",offset:1}}},{keys:"Right",command:{command:"move or resize halo target",args:{what:"move",direction:"right",offset:1}}},{keys:"Up",command:{command:"move or resize halo target",args:{what:"move",direction:"up",offset:1}}},{keys:"Down",command:{command:"move or resize halo target",args:{what:"move",direction:"down",offset:1}}},{keys:"Meta-Left",command:{command:"move or resize halo target",args:{what:"move",direction:"left",offset:10}}},{keys:"Meta-Right",command:{command:"move or resize halo target",args:{what:"move",direction:"right",offset:10}}},{keys:"Meta-Up",command:{command:"move or resize halo target",args:{what:"move",direction:"up",offset:10}}},{keys:"Meta-Down",command:{command:"move or resize halo target",args:{what:"move",direction:"down",offset:10}}},{keys:"Alt-Left",command:{command:"move or resize halo target",args:{what:"move",direction:"left",offset:100}}},{keys:"Alt-Right",command:{command:"move or resize halo target",args:{what:"move",direction:"right",offset:100}}},{keys:"Alt-Up",command:{command:"move or resize halo target",args:{what:"move",direction:"up",offset:100}}},{keys:"Alt-Down",command:{command:"move or resize halo target",args:{what:"move",direction:"down",offset:100}}},{keys:"Shift-Left",command:{command:"move or resize halo target",args:{what:"resize",direction:"left",offset:1}}},{keys:"Shift-Right",command:{command:"move or resize halo target",args:{what:"resize",direction:"right",offset:1}}},{keys:"Shift-Up",command:{command:"move or resize halo target",args:{what:"resize",direction:"up",offset:1}}},{keys:"Shift-Down",command:{command:"move or resize halo target",args:{what:"resize",direction:"down",offset:1}}},{keys:"Meta-Shift-Left",command:{command:"move or resize halo target",args:{what:"resize",direction:"left",offset:10}}},{keys:"Meta-Shift-Right",command:{command:"move or resize halo target",args:{what:"resize",direction:"right",offset:10}}},{keys:"Meta-Shift-Up",command:{command:"move or resize halo target",args:{what:"resize",direction:"up",offset:10}}},{keys:"Meta-Shift-Down",command:{command:"move or resize halo target",args:{what:"resize",direction:"down",offset:10}}},{keys:"Alt-Shift-Left",command:{command:"move or resize halo target",args:{what:"resize",direction:"left",offset:100}}},{keys:"Alt-Shift-Right",command:{command:"move or resize halo target",args:{what:"resize",direction:"right",offset:100}}},{keys:"Alt-Shift-Up",command:{command:"move or resize halo target",args:{what:"resize",direction:"up",offset:100}}},{keys:"Alt-Shift-Down",command:{command:"move or resize halo target",args:{what:"resize",direction:"down",offset:100}}},{keys:{win:"Ctrl-`|Alt-`",mac:"Meta-1"},command:"window switcher"},{keys:{mac:"Meta-Shift-L R E S 1",win:"Ctrl-Shift-L R E S 1"},command:{command:"resize active window",args:{how:"col1"}}},{keys:{mac:"Meta-Shift-L R E S 2",win:"Ctrl-Shift-L R E S 2"},command:{command:"resize active window",args:{how:"col2"}}},{keys:{mac:"Meta-Shift-L R E S 3",win:"Ctrl-Shift-L R E S 3"},command:{command:"resize active window",args:{how:"col3"}}},{keys:{mac:"Meta-Shift-L R E S 4",win:"Ctrl-Shift-L R E S 4"},command:{command:"resize active window",args:{how:"col4"}}},{keys:{mac:"Meta-Shift-L R E S 5",win:"Ctrl-Shift-L R E S 5"},command:{command:"resize active window",args:{how:"col5"}}},{keys:{mac:"Meta-Shift-L R E S Alt-1",win:"Ctrl-Shift-L R E S Alt-1"},command:{command:"resize active window",args:{how:"quadrant1"}}},{keys:{mac:"Meta-Shift-L R E S Alt-2",win:"Ctrl-Shift-L R E S Alt-2"},command:{command:"resize active window",args:{how:"quadrant2"}}},{keys:{mac:"Meta-Shift-L R E S Alt-3",win:"Ctrl-Shift-L R E S Alt-3"},command:{command:"resize active window",args:{how:"quadrant3"}}},{keys:{mac:"Meta-Shift-L R E S Alt-4",win:"Ctrl-Shift-L R E S Alt-4"},command:{command:"resize active window",args:{how:"quadrant4"}}},{keys:{mac:"Meta-Shift-L R E S Alt-5",win:"Ctrl-Shift-L R E S Alt-5"},command:{command:"resize active window",args:{how:"quadrant5"}}},{keys:{mac:"Meta-Shift-L R E S Alt-6",win:"Ctrl-Shift-L R E S Alt-6"},command:{command:"resize active window",args:{how:"quadrant6"}}},{keys:{mac:"Meta-Shift-L R E S Alt-7",win:"Ctrl-Shift-L R E S Alt-7"},command:{command:"resize active window",args:{how:"quadrant7"}}},{keys:{mac:"Meta-Shift-L R E S Alt-8",win:"Ctrl-Shift-L R E S Alt-8"},command:{command:"resize active window",args:{how:"quadrant8"}}},{keys:{mac:"Meta-Shift-L R E S Alt-9",win:"Ctrl-Shift-L R E S Alt-9"},command:{command:"resize active window",args:{how:"quadrant9"}}},{keys:{mac:"Meta-Shift-L R E S Alt-0",win:"Ctrl-Shift-L R E S Alt-0"},command:{command:"resize active window",args:{how:"quadrant0"}}},{keys:{mac:"Meta-Shift-L R E S C",win:"Ctrl-Shift-L R E S C"},command:{command:"resize active window",args:{how:"center"}}},{keys:{mac:"Meta-Shift-L R E S L",win:"Ctrl-Shift-L R E S L"},command:{command:"resize active window",args:{how:"left"}}},{keys:{mac:"Meta-Shift-L R E S R",win:"Ctrl-Shift-L R E S R"},command:{command:"resize active window",args:{how:"right"}}},{keys:{mac:"Meta-Shift-L R E S F",win:"Ctrl-Shift-L R E S F"},command:{command:"resize active window",args:{how:"full"}}},{keys:{mac:"Meta-Shift-L R E S T",win:"Ctrl-Shift-L R E S T"},command:{command:"resize active window",args:{how:"top"}}},{keys:{mac:"Meta-Shift-L R E S H T",win:"Ctrl-Shift-L R E S H T"},command:{command:"resize active window",args:{how:"halftop"}}},{keys:{mac:"Meta-Shift-L R E S B",win:"Ctrl-Shift-L R E S B"},command:{command:"resize active window",args:{how:"bottom"}}},{keys:{mac:"Meta-Shift-L R E S H B",win:"Ctrl-Shift-L R E S H B"},command:{command:"resize active window",args:{how:"halfbottom"}}},{keys:{mac:"Meta-Shift-L R E S Escape",win:"Ctrl-Shift-L R E S Escape"},command:{command:"resize active window",args:{how:"reset"}}}],text:{basicFontItems:["Sans-serif","serif","Monospace","Arial Black","Arial Narrow","Comic Sans MS","Garamond","Tahoma","Trebuchet MS","Verdana","custom..."],cursorBlinkPeriod:.5,useSoftTabs:!0,tabWidth:2,markStackSize:16,undoLevels:50,clipboardBufferLength:100,useMultiSelect:!0,undoGroupDelay:600,defaultKeyBindings:[{keys:{mac:"Meta-C",win:"Ctrl-C"},command:{command:"clipboard copy",passEvent:!0}},{keys:"Ctrl-W",command:{command:"manual clipboard copy",args:{delete:!0}}},{keys:"Alt-W",command:"manual clipboard copy"},{keys:"Ctrl-Y",command:"manual clipboard paste"},{keys:"Alt-Y",command:{command:"manual clipboard paste",args:{killRingCycleBack:!0}}},{keys:{mac:"Meta-X",win:"Ctrl-X"},command:{command:"clipboard cut",passEvent:!0}},{keys:{mac:"Meta-V",win:"Ctrl-V"},command:{command:"clipboard paste",passEvent:!0}},{keys:{mac:"Meta-Z|Ctrl-Shift--|Ctrl-x u",win:"Ctrl-Z|Ctrl-Shift--|Ctrl-x u"},command:"text undo"},{keys:{mac:"Meta-Shift-Z",win:"Ctrl-Shift-Z"},command:"text redo"},{keys:{mac:"Meta-A|Ctrl-X H",win:"Ctrl-A|Ctrl-X H"},command:"select all"},{keys:{mac:"Meta-D",win:"Ctrl-D"},command:"doit"},{keys:{mac:"Meta-Shift-L X B"},command:"eval all"},{keys:{mac:"Meta-P",win:"Ctrl-P"},command:"printit"},{keys:{mac:"Meta-I",win:"Ctrl-I"},command:"print inspectit"},{keys:{mac:"Meta-Shift-I",win:"Ctrl-Shift-I"},command:"inspectit"},{keys:{mac:"Meta-Shift-E",win:"Ctrl-Shift-E"},command:"editit"},{keys:{mac:"Meta-Shift-U",win:"Ctrl-Shift-U"},command:"undefine variable"},{keys:"Backspace",command:"delete backwards"},{keys:{win:"Delete",mac:"Delete|Ctrl-D"},command:"delete"},{keys:{win:"Left",mac:"Left|Ctrl-B"},command:"go left"},{keys:{win:"Right",mac:"Right|Ctrl-F"},command:"go right"},{keys:{win:"Up",mac:"Up|Ctrl-P"},command:"go up"},{keys:{win:"Down",mac:"Down|Ctrl-N"},command:"go down"},{keys:"Shift-Left",command:"select left"},{keys:"Shift-Right",command:"select right"},{keys:"Shift-Up",command:"select up"},{keys:"Shift-Down",command:"select down"},{keys:{win:"Ctrl-Right",mac:"Alt-Right|Alt-F"},command:"goto word right"},{keys:{win:"Ctrl-Left",mac:"Alt-Left|Alt-B"},command:"goto word left"},{keys:{win:"Ctrl-Shift-Right",mac:"Alt-Shift-Right|Alt-Shift-F"},command:{command:"goto word right",args:{select:!0}}},{keys:{win:"Ctrl-Shift-Left",mac:"Alt-Shift-Left|Alt-Shift-B"},command:{command:"goto word left",args:{select:!0}}},{keys:"Alt-Backspace",command:"delete word left"},{keys:"Alt-D",command:"delete word right"},{keys:"Alt-Ctrl-K",command:"delete word right"},{keys:"Alt-Shift-2",command:"select word right"},{keys:"Ctrl-X Ctrl-X",command:"reverse selection"},{keys:{win:"Ctrl-Shift-L",mac:"Meta-L"},command:"select line"},{keys:{win:"Shift-Home",mac:"Shift-Home|Ctrl-Shift-A"},command:{command:"goto line start",args:{select:!0}}},{keys:{win:"Home",mac:"Home|Ctrl-A"},command:{command:"goto line start",args:{select:!1}}},{keys:{win:"Shift-End",mac:"Shift-End|Ctrl-Shift-E"},command:{command:"goto line end",args:{select:!0}}},{keys:{win:"End",mac:"End|Ctrl-E"},command:{command:"goto line end",args:{select:!1}}},{keys:"Ctrl-C J",command:{command:"join line",args:{withLine:"before"}}},{keys:"Ctrl-C Shift-J",command:{command:"join line",args:{withLine:"after"}}},{keys:{win:"Ctrl-Shift-D",mac:"Meta-Shift-D|Ctrl-C P"},command:"duplicate line or selection"},{keys:{win:"Ctrl-Backspace",mac:"Meta-Backspace"},command:"delete left until beginning of line"},{keys:"Ctrl-K",command:"delete emtpy line or until end of line"},{keys:{win:"Ctrl-Alt-Up|Ctrl-Alt-P",mac:"Ctrl-Meta-Up|Ctrl-Meta-P"},command:"move lines up"},{keys:{win:"Ctrl-Alt-Down|Ctrl-Alt-N",mac:"Ctrl-Meta-Down|Ctrl-Meta-N"},command:"move lines down"},{keys:{win:"PageDown",mac:"PageDown|Ctrl-V"},command:"goto page down"},{keys:{win:"PageUp",mac:"PageUp|Alt-V"},command:"goto page up"},{keys:{win:"Shift-PageDown",mac:"Shift-PageDown"},command:"goto page down and select"},{keys:{win:"Shift-PageUp",mac:"Shift-PageUp"},command:"goto page up and select"},{keys:"Alt-Ctrl-,",command:"move cursor to screen top in 1/3 steps"},{keys:"Alt-Ctrl-.",command:"move cursor to screen bottom in 1/3 steps"},{keys:{win:"Alt-Left",mac:"Meta-Left"},command:"goto matching left"},{keys:{win:"Alt-Shift-Left",mac:"Meta-Shift-Left"},command:{command:"goto matching left",args:{select:!0}}},{keys:{win:"Alt-Right",mac:"Meta-Right"},command:"goto matching right"},{keys:{win:"Alt-Shift-Right",mac:"Meta-Shift-Right"},command:{command:"goto matching right",args:{select:!0}}},{keys:"Alt-Ctrl-B",command:"goto matching left"},{keys:"Alt-Ctrl-F",command:"goto matching right"},{keys:"Ctrl-Up",command:"goto paragraph above"},{keys:"Ctrl-Down",command:"goto paragraph below"},{keys:{win:"Ctrl-Shift-Home",mac:"Meta-Shift-Up"},command:{command:"goto start",args:{select:!0}}},{keys:{win:"Ctrl-Shift-End",mac:"Meta-Shift-Down"},command:{command:"goto end",args:{select:!0}}},{keys:{win:"Ctrl-Home",mac:"Meta-Up|Meta-Home|Alt-Shift-,"},command:"goto start"},{keys:{win:"Ctrl-End",mac:"Meta-Down|Meta-End|Alt-Shift-."},command:"goto end"},{keys:"Ctrl-L",command:"realign top-bottom-center"},{keys:{win:"Ctrl-Shift-L",mac:"Ctrl-Shift-L|Alt-G G"},command:"goto line"},{keys:"Enter",command:"newline"},{keys:"Space",command:{command:"insertstring",args:{string:" ",undoGroup:!0}}},{keys:"Tab",command:{command:"tab - snippet expand or indent"}},{keys:{win:"Ctrl-]",mac:"Meta-]"},command:"indent"},{keys:{win:"Ctrl-[",mac:"Meta-["},command:"outdent"},{keys:{win:"Ctrl-Enter",mac:"Meta-Enter"},command:{command:"insert line",args:{where:"below"}}},{keys:"Shift-Enter",command:{command:"insert line",args:{where:"above"}}},{keys:"Ctrl-O",command:"split line"},{keys:{mac:"Ctrl-X Ctrl-T"},command:"transpose chars"},{keys:{mac:"Ctrl-C Ctrl-U"},command:"uppercase"},{keys:{mac:"Ctrl-C Ctrl-L"},command:"lowercase"},{keys:{mac:"Meta-Shift-L W t"},command:"remove trailing whitespace"},{keys:{mac:"Ctrl-Space"},command:"toggle active mark"},{keys:{mac:"Meta-Shift-L M O D E"},command:"change editor mode"},{keys:{mac:"Meta-Shift-L L T"},command:"toggle line wrapping"},{keys:"Esc|Ctrl-G",command:"cancel input"},{keys:{win:"Ctrl-/",mac:"Meta-/"},command:"toggle comment"},{keys:{win:"Alt-Ctrl-/",mac:"Alt-Meta-/|Alt-Meta-"},command:"toggle block comment"},{keys:"Meta-Shift-L /  D",command:"comment box"},{keys:{windows:"Ctrl-.",mac:"Meta-."},command:"[IyGotoChar] activate"},{keys:{windows:"Ctrl-,",mac:"Meta-,"},command:{command:"[IyGotoChar] activate",args:{backwards:!0}}},{keys:{mac:"Alt-Shift-Space|Alt-Space|Meta-Shift-P",win:"Ctrl-Space|Ctrl-Shift-P"},command:"text completion"},{keys:"|Alt-/",command:"text completion first match"},{keys:"Alt-Q",command:"fit text to column"},{keys:{win:"Ctrl-F|Ctrl-G|F3",mac:"Meta-F|Meta-G|Ctrl-S"},command:"search in text"},{keys:{win:"Ctrl-Shift-F|Ctrl-Shift-G",mac:"Meta-Shift-F|Meta-Shift-G|Ctrl-R"},command:{command:"search in text",args:{backwards:!0}}},{keys:"Ctrl-Shift-/|Ctrl-C Ctrl-Shift-,",command:"[multi select] all like this"},{keys:"Alt-Ctrl-P",command:"[multi select] add cursor above"},{keys:"Alt-Ctrl-N",command:"[multi select] add cursor below"},{keys:"Ctrl-Shift-,",command:"[multi select] more like this backward"},{keys:"Ctrl-Shift-.",command:"[multi select] more like this forward"},{keys:{mac:"Meta-Shift-,"},command:"[multi select] goto previous focused cursor"},{keys:{mac:"Meta-Shift-."},command:"[multi select] goto next focused cursor"},{keys:"Ctrl-Shift-;",command:"[multi select] remove focused cursor"},{keys:"Alt-Ctrl-A",command:"[multi select] align cursors"},{keys:"Ctrl-X R",command:"[multi select] create rectangular selection"},{keys:{win:"Shift-Ctrl-S|Ctrl-Alt-Space",mac:"Ctrl-Command-space|Ctrl-Alt-Space"},command:"contractRegion"},{keys:{win:"Shift-Ctrl-E|Ctrl-Shift-Space",mac:"Shift-Command-Space|Ctrl-Shift-Space"},command:"expandRegion"},{keys:"Ctrl-Alt-h",command:"markDefun"},{keys:"Ctrl-Alt-d|Ctrl-Alt-Down",command:"forwardDownSexp"},{keys:"Ctrl-Alt-u|Ctrl-Alt-Up",command:"backwardUpSexp"},{keys:"Ctrl-Alt-b|Ctrl-Alt-Left",command:"backwardSexp"},{keys:"Ctrl-Alt-f|Ctrl-Alt-Right",command:"forwardSexp"},{keys:"Alt-.",command:"selectDefinition"},{keys:"Ctrl-Shift-'",command:"selectSymbolReferenceOrDeclaration"},{keys:"Ctrl-Shift-[",command:"selectSymbolReferenceOrDeclarationPrev"},{keys:"Ctrl-Shift-]",command:"selectSymbolReferenceOrDeclarationNext"},{keys:{win:"Ctrl-=",mac:"Meta-="},command:"increase font size"},{keys:{win:"Ctrl--",mac:"Meta--"},command:"decrease font size"},{keys:"Alt-K",command:"set link of selection"},{keys:"Alt-O",command:"set doit of selection"},{keys:{mac:"Meta-\\",wind:"Ctrl-\\"},command:"reset text style"},{keys:{mac:"Meta-Shift-L T U I",win:"Ctrl-Shift-L T U I"},command:"open text attribute controls"},{keys:{mac:"Meta-Shift-L T D",win:"Ctrl-Shift-L T D"},command:"[todo] toggle todo marker"},{keys:{mac:"Meta-Shift-L D A T E",win:"Ctrl-Shift-L D A T E"},command:"insert date"},{keys:"Ctrl-C Ctrl-I",command:"change string inflection"},{keys:"Alt-Shift-4",command:"spell check word"},{keys:"Alt-Shift-\\",command:"[shell] run shell command on region"},{keys:"Alt-Shift-;",command:"run code on text morph"},{keys:{mac:"Meta-Shift-L O P E N",win:"Ctrl-Shift-L O P E N"},command:"open file at cursor"},{keys:"Meta-F1",command:"report token at cursor"}]},codeEditor:{defaultTheme:"default",collapseSelection:!1,search:{maxCharsPerLine:1e4,fastHighlightLineCount:4e3,showTextMap:!0},defaultStyle:{fontFamily:"Monaco, Inconsolata, monospace",padding:lively_graphics.Rectangle.inset(4,2,4,2),fontSize:12,clipMode:"auto"},modes:{text:{style:{}}}},systemBrowser:{fixUndeclaredVarsOnSave:!0},objectEditor:{fixUndeclaredVarsOnSave:!0},remotes:{server:System.get("@system-env").browser?document.location.origin+"/eval":null}};function styleProps(e){var t={};return addFill(e,t),addTransform(e,t),addTransformOrigin(e,t),addDisplay(e,t),addExtentStyle(e,t),addBorder(e,t),addBorderRadius(e,t),addShadowStyle(e,t),null!=e.opacity&&(t.opacity=e.opacity),e.draggable&&!e.isWorld&&(t["touch-action"]="none"),t}function addTransform(e,t){var n=e.position,r=e.origin,i=e.scale,o=e.rotation,a=Math.round(n.x-r.x),s=Math.round(n.y-r.y),l=e.isImage&&!(e.owner.isPath&&"visible"!=e.owner.clipMode);t.transform=(l?"translate3d("+a+"px, "+s+"px, 0px)":"translate("+a+"px, "+s+"px)")+"rotate("+o.toFixed(2)+"rad) scale("+i.toFixed(2)+","+i.toFixed(2)+")"}function addTransformOrigin(e,t){var n=e.origin;n&&(t.transformOrigin=n.x+"px "+n.y+"px")}function addDisplay(e,t){var n=e.visible;null!=n&&(t.display=n?"":"none")}function addBorderRadius(e,t){var n=e.borderRadiusLeft,r=e.borderRadiusRight,i=e.borderRadiusBottom,o=e.borderRadiusTop;t.borderRadius=o+"px "+o+"px "+i+"px "+i+"px / "+n+"px "+r+"px "+r+"px "+n+"px"}function addBorder(e,t){var n=e.borderWidthLeft,r=e.borderColorLeft,i=e.borderStyleLeft,o=e.borderWidthRight,a=e.borderColorRight,s=e.borderStyleRight,l=e.borderColor,c=e.borderWidthBottom,u=e.borderColorBottom,h=e.borderStyleBottom,d=e.borderWidthTop,p=e.borderColorTop,f=e.borderStyleTop;t["border-left-style"]=""+i,t["border-right-style"]=""+s,t["border-bottom-style"]=""+h,t["border-top-style"]=""+f,t["border-left-width"]=n+"px",t["border-right-width"]=o+"px",t["border-bottom-width"]=c+"px",t["border-top-width"]=d+"px",t["border-top-color"]=p?p.toString():"transparent",t["border-right-color"]=a?a.toString():"transparent",t["border-bottom-color"]=u?u.toString():"transparent",t["border-left-color"]=r?r.toString():"transparent",l&&l.isGradient&&(t["border-image"]=l.toString())}function addFill(e,t){var n=e.fill;n?n.isGradient?t.backgroundImage=n.toString():t.background=n.toString():t.background=lively_graphics.Color.transparent.toString()}function addExtentStyle(e,t){var n=e.extent;t.width=n.x+"px",t.height=n.y+"px"}function shadowCss(e){return e.dropShadow?e.dropShadow.toFilterCss():""}function addShadowStyle(e,t){if(e.isSvgMorph||e.isImage)t.filter=shadowCss(e);else{var n=e.dropShadow;n&&n.fast||n&&n.inset?t.boxShadow=n?n.toCss():"none":t.filter=n?n.toFilterCss():"none"}}function addSvgAttributes(e,t){var n=e.width,r=e.height;e.borderWidth;return t.width=n||1,t.height=r||1,t.viewBox=[0,0,n||1,r||1].join(" "),t}function getSvgVertices(e){var t=void 0,n=void 0,r=void 0,i="";if(e.length>0){var o=(r=e[0]).position,a=o.x,s=o.y;i=i+"M "+(t=a)+" "+(n=s)+" "}for(var l=1;l<e.length-1;l++){var c=e[l],u=c.position,h=u.x,d=u.y,p=c.isSmooth,f=c.controlPoints,g=f.previous;f.next;i=p?i+"C "+(t+r.controlPoints.next.x)+" "+(n+r.controlPoints.next.y)+" "+(h+g.x)+" "+(d+g.y)+" "+h+" "+d+" ":i+"L "+h+" "+d+" ",r=c,t=h,n=d}if(e.length>0){var m=e[e.length-1],v=(p=m.isSmooth,m.x),y=m.y;g=m.controlPoints.previous;i=p?i+"C "+(t+r.controlPoints.next.x)+" "+(n+r.controlPoints.next.y)+" "+(v+g.x)+" "+(y+g.y)+" "+v+" "+y:i+"L "+v+" "+y}return i}function addPathAttributes(e,t){var n=e.id,r=e.vertices,i=e.fill,o=e.borderColor,a=e.borderWidth;return r.length&&(t.d=getSvgVertices(r)),addSvgBorderStyle(e,t),t["stroke-width"]=a.valueOf(),t["paint-order"]="stroke",t.fill=i?i.isGradient?"url(#gradient-fill"+n+")":i.toString():"transparent",t.stroke=o.valueOf().isGradient?"url(#gradient-borderColor"+n+")":o.valueOf().toString(),t}function addSvgBorderStyle(e,t){var n=e.borderStyle.valueOf();if("dashed"===n){var r=e.borderWidth.valueOf();t["stroke-dasharray"]=1.61*r+" "+r}else if("dotted"===n){var i=e.borderWidth.valueOf();t["stroke-dasharray"]="1 "+2*i,t["stroke-linecap"]="round",t["stroke-linejoin"]="round"}return t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jsx=(REACT_ELEMENT_TYPE="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103,function createRawReactElement(e,t,n,r){var i=e&&e.defaultProps,o=arguments.length-3;if(t||0===o||(t={}),t&&i)for(var a in i)void 0===t[a]&&(t[a]=i[a]);else t||(t=i||{});if(1===o)t.children=r;else if(o>1){for(var s=Array(o),l=0;l<o;l++)s[l]=arguments[l+3];t.children=s}return{$$typeof:REACT_ELEMENT_TYPE,type:e,key:void 0===n?null:""+n,ref:null,props:t,_owner:null}}),REACT_ELEMENT_TYPE,asyncIterator=function(e){if("function"==typeof Symbol){if(Symbol.asyncIterator){var t=e[Symbol.asyncIterator];if(null!=t)return t.call(e)}if(Symbol.iterator)return e[Symbol.iterator]()}throw new TypeError("Object is not async iterable")},asyncGenerator=function(){function AwaitValue(e){this.value=e}function AsyncGenerator(e){var t,n;function resume(t,n){try{var r=e[t](n),i=r.value;i instanceof AwaitValue?Promise.resolve(i.value).then(function(e){resume("next",e)},function(e){resume("throw",e)}):settle(r.done?"return":"normal",r.value)}catch(e){settle("throw",e)}}function settle(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?resume(t.key,t.arg):n=null}this._invoke=function send(e,r){return new Promise(function(i,o){var a={key:e,arg:r,resolve:i,reject:o,next:null};n?n=n.next=a:(t=n=a,resume(e,r))})},"function"!=typeof e.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(AsyncGenerator.prototype[Symbol.asyncIterator]=function(){return this}),AsyncGenerator.prototype.next=function(e){return this._invoke("next",e)},AsyncGenerator.prototype.throw=function(e){return this._invoke("throw",e)},AsyncGenerator.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new AsyncGenerator(e.apply(this,arguments))}},await:function(e){return new AwaitValue(e)}}}(),asyncGeneratorDelegate=function(e,t){var n={},r=!1;function pump(n,i){return r=!0,i=new Promise(function(t){t(e[n](i))}),{done:!1,value:t(i)}}return"function"==typeof Symbol&&Symbol.iterator&&(n[Symbol.iterator]=function(){return this}),n.next=function(e){return r?(r=!1,e):pump("next",e)},"function"==typeof e.throw&&(n.throw=function(e){if(r)throw r=!1,e;return pump("throw",e)}),"function"==typeof e.return&&(n.return=function(e){return pump("return",e)}),n},asyncToGenerator=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function step(r,i){try{var o=t[r](i),a=o.value}catch(e){return void n(e)}if(!o.done)return Promise.resolve(a).then(function(e){step("next",e)},function(e){step("throw",e)});e(a)}("next")})}},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&defineProperties(e.prototype,t),n&&defineProperties(e,n),e}}(),defineEnumerableProperties=function(e,t){for(var n in t){var r=t[n];r.configurable=r.enumerable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,n,r)}return e},defaults=function(e,t){for(var n=Object.getOwnPropertyNames(t),r=0;r<n.length;r++){var i=n[r],o=Object.getOwnPropertyDescriptor(t,i);o&&o.configurable&&void 0===e[i]&&Object.defineProperty(e,i,o)}return e},defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},get$1=function get$1(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:get$1(i,t,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},_instanceof=function(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?t[Symbol.hasInstance](e):e instanceof t},interopRequireDefault=function(e){return e&&e.__esModule?e:{default:e}},interopRequireWildcard=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},newArrowCheck=function(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")},objectDestructuringEmpty=function(e){if(null==e)throw new TypeError("Cannot destructure undefined")},objectWithoutProperties=function(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},selfGlobal="undefined"==typeof global?self:global,set$1=function set$1(e,t,n,r){var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var o=Object.getPrototypeOf(e);null!==o&&set$1(o,t,n,r)}else if("value"in i&&i.writable)i.value=n;else{var a=i.set;void 0!==a&&a.call(r,n)}return n},slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function sliceIterator(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),slicedToArrayLoose=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){for(var n,r=[],i=e[Symbol.iterator]();!(n=i.next()).done&&(r.push(n.value),!t||r.length!==t););return r}throw new TypeError("Invalid attempt to destructure non-iterable instance")},taggedTemplateLiteral=function(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))},taggedTemplateLiteralLoose=function(e,t){return e.raw=t,e},temporalRef=function(e,t,n){if(e===n)throw new ReferenceError(t+" is not defined - temporal dead zone");return e},temporalUndefined={},toArray=function(e){return Array.isArray(e)?e:Array.from(e)},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},babelHelpers$1=Object.freeze({jsx:jsx,asyncIterator:asyncIterator,asyncGenerator:asyncGenerator,asyncGeneratorDelegate:asyncGeneratorDelegate,asyncToGenerator:asyncToGenerator,classCallCheck:classCallCheck,createClass:createClass,defineEnumerableProperties:defineEnumerableProperties,defaults:defaults,defineProperty:defineProperty,get:get$1,inherits:inherits,interopRequireDefault:interopRequireDefault,interopRequireWildcard:interopRequireWildcard,newArrowCheck:newArrowCheck,objectDestructuringEmpty:objectDestructuringEmpty,objectWithoutProperties:objectWithoutProperties,possibleConstructorReturn:possibleConstructorReturn,selfGlobal:selfGlobal,set:set$1,slicedToArray:slicedToArray,slicedToArrayLoose:slicedToArrayLoose,taggedTemplateLiteral:taggedTemplateLiteral,taggedTemplateLiteralLoose:taggedTemplateLiteralLoose,temporalRef:temporalRef,temporalUndefined:temporalUndefined,toArray:toArray,toConsumableArray:toConsumableArray,typeof:_typeof,extends:_extends,instanceof:_instanceof}),defaultCSS="\n\n/*-=- html fixes -=-*/\n\nhtml {\n  overflow: visible;\n}\n\ntextarea.lively-text-input.debug {\n  z-index: 20 !important;\n  opacity: 1 !important;\n  background: rgba(0,255,0,0.5) !important;\n}\n\n.no-html-select {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.hiddenScrollbar::-webkit-scrollbar {\n  /* This is the magic bit */\n  display: none;\n}\n\n\n/*-=- generic morphic -=-*/\n\n.Morph {\n  outline: none;\n  /*for aliasing issue in chrome: http://stackoverflow.com/questions/6492027/css-transform-jagged-edges-in-chrome*/\n  /* -webkit-backface-visibility: hidden; */\n\n  /*include border size in extent of element*/\n  box-sizing: border-box;\n\n  /*don't use dom selection on morphs*/\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.Morph img {\n  -moz-user-select: none;\n}\n\n.Tooltip {\n  z-index: 3;\n}\n\n.Hand {\n  z-index: 1;\n}\n\n/*-=- halos -=-*/\n\n.Halo {\n  z-index: 2;\n}\n\n.ProportionalLayoutHalo, .FlexLayoutHalo, .GridLayoutHalo, .TilingLayoutHalo {\n  z-index: auto;\n}\n\n.HaloItem:not(.NameHaloItem) {\n  /*FIXME: we shouldn't need to hardcode the size...*/\n  line-height: 24px !important;\n  text-align: center;\n  vertical-align: middle;\n}\n\n.halo-mesh {\n  background-color:transparent;\n  background-image: linear-gradient(rgba(0,0,0,.1) 2px, transparent 2px),\n  linear-gradient(90deg, rgba(0,0,0,.1) 2px, transparent 2px),\n  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);\n  background-size:100px 100px, 100px 100px, 10px 10px, 10px 10px;\n  background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;\n}\n\n/*-=- text -=-*/\n\n.center-text {\n  text-align: center;\n}\n\n.v-center-text {\n  position: relative;\n  top: 50%;\n}\n\ndiv.text-layer span {\n  line-height: normal;\n}\n\n/*-=- text -=-*/\n\n.Label span {\n  white-space: pre;\n  float: left;\n  -moz-user-select: none;\n}\n\n.Text .annotation {\n  text-align: right;\n  position: absolute;\n  right: 0;\n}\n\n.Label .annotation {\n/*  vertical-align: middle;\n  height: 100%;*/\n  /*vertical align*/\n  float: right;\n  position: relative;\n  top: 50%;\n  text-align: right;\n}\n\n.truncated-text {\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n/*-=- input elements -=-*/\n\ninput::-webkit-input-placeholder {\n  color: rgb(202, 202, 202);\n}\ninput::-moz-placeholder {\n  color: rgb(202, 202, 202);\n}\ninput:-ms-input-placeholder {\n  color: rgb(202, 202, 202);\n}\ninput:-moz-placeholder {\n  color: rgb(202, 202, 202);\n}\ninput:placeholder {\n  color: rgb(202, 202, 202);\n}\n\n/*-=- input elements -=-*/\n.Morph svg .path-point {\n  cursor: move; /* fallback if grab cursor is unsupported */\n  cursor: grab;\n  cursor: -moz-grab;\n  cursor: -webkit-grab;\n  fill: red;\n}\n\n",ShadowObject=(superclass=void 0,__lively_classholder__=_classRecorder,__lively_class__=__lively_classholder__.hasOwnProperty("ShadowObject")&&"function"==typeof __lively_classholder__.ShadowObject?__lively_classholder__.ShadowObject:__lively_classholder__.ShadowObject=function ShadowObject(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)},lively.classes.runtime.initializeClass(__lively_class__,superclass,[{key:Symbol.for("lively-instance-initialize"),value:function ShadowObject_initialize_(e){lively_lang.obj.isBoolean(e)&&(e=config$1.defaultShadow);var t=e,n=t.rotation,r=t.distance,i=t.blur,o=t.color,a=t.morph,s=t.inset,l=t.spread,c=t.fast;this.rotation=lively_lang.obj.isNumber(n)?n:45,this.distance=lively_lang.obj.isNumber(r)?r:2,this.blur=lively_lang.obj.isNumber(i)?i:6,this.inset=s||!1,this.spread=l||0,this.color=o||lively_graphics.Color.gray.darker(),this.morph=a,this.fast=c}},{key:"distance",get:function get(){return this._distance}},{key:"blur",get:function get(){return this._blur}},{key:"rotation",get:function get(){return this._rotation}},{key:"color",get:function get(){return this._color}},{key:"inset",get:function get(){return this._inset}},{key:"inset",set:function set(e){this._inset=e,this.morph&&(this.morph.dropShadow=this)}},{key:"distance",set:function set(e){this._distance=e,this.morph&&(this.morph.dropShadow=this)}},{key:"blur",set:function set(e){this._blur=e,this.morph&&(this.morph.dropShadow=this)}},{key:"rotation",set:function set(e){this._rotation=e,this.morph&&(this.morph.dropShadow=this)}},{key:"color",set:function set(e){this._color=e,this.morph&&(this.morph.dropShadow=this)}},{key:"isShadowObject",get:function get(){return!0}},{key:"toCss",value:function ShadowObject_toCss_(){var e=this.distance,t=this.rotation,n=this.color,r=this.inset,i=this.blur,o=this.spread,a=lively_graphics.Point.polar(e,lively_lang.num.toRadians(t)),s=a.x,l=a.y;return(r?"inset":"")+" "+n.toString()+" "+s+"px "+l+"px "+i+"px "+o+"px"}},{key:"toJson",value:function ShadowObject_toJson_(){return lively_lang.obj.select(this,["rotation","distance","blur","color","inset","spread"])}},{key:"toFilterCss",value:function ShadowObject_toFilterCss_(){var e=this.distance,t=this.rotation,n=this.blur,r=this.color,i=(this.spread,lively_graphics.Point.polar(e,lively_lang.num.toRadians(t)));return"drop-shadow("+i.x+"px "+i.y+"px "+(n=bowser.chrome?n/3:n/2)+"px "+r.toString()+")"}}],void 0,__lively_classholder__,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3399,end:5779})),superclass,__lively_classholder__,__lively_class__;function defaultStyle(e){e.opacity;var t=e.reactsToPointer,n=e.nativeCursor,r=e.clipMode,i=styleProps(e),o=e._animationQueue.maskedProps("css");return"backgroundImage"in o&&delete i.background,"visible"!==r&&(i.overflow=r,i["-webkit-overflow-scrolling"]="touch",i["overflow-anchor"]="none"),Object.assign(i,o),i.position="absolute",i["pointer-events"]=t?"auto":"none",i.cursor=n,i}function MorphAfterRenderHook(e,t){this.morph=e,this.renderer=t}function Animation(e){this.morph=e}function SvgAnimation(e,t){this.morph=e,this.type=t}function defaultAttributes(e,t){return{animation:new Animation(e),key:e.id,id:e.id,className:(e.hideScrollbars?e.styleClasses.concat("hiddenScrollbar"):e.styleClasses).join(" "),draggable:!1,"morph-after-render-hook":new MorphAfterRenderHook(e,t)}}function svgAttributes(e){var t=new SvgAnimation(e,"svg"),n={};return addSvgAttributes(e,n),Object.assign(n,e._animationQueue.maskedProps("svg")),{animation:t,attributes:n}}function pathAttributes(e){var t=new SvgAnimation(e,"path"),n={};return addPathAttributes(e,n),Object.assign(n,e._animationQueue.maskedProps("path")),{animation:t,attributes:n}}function renderGradient(e,t,n){var r=n=n.valueOf(),i=r.bounds,o=r.focus,a=r.vector,s=r.stops,l=t.x,c=t.y,u={namespace:"http://www.w3.org/2000/svg",attributes:{id:"gradient-"+e,gradientUnits:"userSpaceOnUse",r:"50%"}};if(a&&(u.attributes.gradientTransform="rotate("+lively_lang.num.toDegrees(a.extent().theta())+", "+l/2+", "+c/2+")"),o&&i){var h=i.width,d=i.height,p=o.x,f=o.y;u.attributes.gradientTransform="matrix(\n"+h/l+", 0, 0, "+d/c+",\n"+(l/2-h/l*(l/2)+p*l-l/2)+",\n"+(c/2-d/c*(c/2)+f*c-c/2)+")"}return vdom.h(n.type,u,s.map(function(e){return vdom.h("stop",{namespace:"http://www.w3.org/2000/svg",attributes:{offset:100*e.offset+"%","stop-opacity":e.color.a,"stop-color":e.color.withA(1).toString()}})}))}function initDOMState(e,t){e.rootNode.appendChild(e.domNode),e.ensureDefaultCSS().then(function(){return lively_lang.promise.delay(500)}).then(function(){return t.env.fontMetric&&t.env.fontMetric.reset()}).then(function(){return t.withAllSubmorphsDo(function(e){if(e.isText||e.isLabel){var t=(e.metadata||{}).serializationInfo;if(t&&t.recoveredTextBounds)return;e.forceRerender()}})}).catch(function(e){return console.error(e)})}function renderMorph(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.env.renderer;return vdom.create(e.render(t),t.domEnvironment)}function renderRootMorph(e,t){if(e.needsRerender()){var n=!1,r=t.domNode,i=t.renderMap.get(e)||r&&(n=!0)&&parser(r)||t.render(e),o=t.render(e);n&&(i.key=o.key);var a=vdom.diff(i,o);(r=r||(t.domNode=vdom.create(i,t.domEnvironment))).parentNode||initDOMState(t,e),vdom.patch(r,a),t.renderFixedMorphs(o.fixedMorphs,e)}}MorphAfterRenderHook.prototype.hook=function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=!!e.parentNode;if(o&&(this.morph._submorphOrderChanged&&this.morph.submorphs.length?(this.morph._submorphOrderChanged=!1,this.updateScrollOfSubmorphs(this.morph,this.renderer)):this.morph.isClip()&&this.updateScroll(this.morph,e)),o||i>3)return this.morph._rendering=!1,void this.morph.onAfterRender(e);i++,setTimeout(function(){return r.hook(e,t,n,i)},20*i)},MorphAfterRenderHook.prototype.updateScroll=function(e,t,n){var r=this,i=e.env.eventDispatcher.eventState.scroll.interactiveScrollInProgress;if(t&&i)return i.then(function(){return r.updateScroll(e,t,!0)});if(t){var o=function(){var r=e.scroll,i=r.x,o=r.y;if(e._animationQueue.animations.find(function(e){return e.animatedProps.scroll}))return{v:void 0};t.scrollTop!==o&&(t.scrollTop=o),t.scrollLeft!==i&&(t.scrollLeft=i),!n&&requestAnimationFrame(function(){t.scrollTop!==o&&(t.scrollTop=o),t.scrollLeft!==i&&(t.scrollLeft=i)},e.id)}();if("object"===(void 0===o?"undefined":_typeof(o)))return o.v}},MorphAfterRenderHook.prototype.updateScrollOfSubmorphs=function(e,t){var n=this;e.submorphs.forEach(function(e){e.isClip()&&n.updateScroll(e,t.getNodeForMorph(e)),n.updateScrollOfSubmorphs(e,t)})},Animation.prototype.hook=function(e){this.morph._animationQueue.startAnimationsFor(e)},SvgAnimation.prototype.hook=function(e){this.morph._animationQueue.startSvgAnimationsFor(e,this.type)};var easings={inQuad:"cubic-bezier(0.550,  0.085, 0.680, 0.530)",inCubic:"cubic-bezier(0.550,  0.055, 0.675, 0.190)",inQuart:"cubic-bezier(0.895,  0.030, 0.685, 0.220)",inQuint:"cubic-bezier(0.755,  0.050, 0.855, 0.060)",inSine:"cubic-bezier(0.470,  0.000, 0.745, 0.715)",inExpo:"cubic-bezier(0.950,  0.050, 0.795, 0.035)",inCirc:"cubic-bezier(0.600,  0.040, 0.980, 0.335)",inBack:"cubic-bezier(0.600, -0.280, 0.735, 0.045)",outQuad:"cubic-bezier(0.250,  0.460, 0.450, 0.940)",outCubic:"cubic-bezier(0.215,  0.610, 0.355, 1.000)",outQuart:"cubic-bezier(0.165,  0.840, 0.440, 1.000)",outQuint:"cubic-bezier(0.230,  1.000, 0.320, 1.000)",outSine:"cubic-bezier(0.390,  0.575, 0.565, 1.000)",outExpo:"cubic-bezier(0.190,  1.000, 0.220, 1.000)",outCirc:"cubic-bezier(0.075,  0.820, 0.165, 1.000)",outBack:"cubic-bezier(0.175,  0.885, 0.320, 1.275)",inOutQuad:"cubic-bezier(0.455,  0.030, 0.515, 0.955)",inOutCubic:"cubic-bezier(0.645,  0.045, 0.355, 1.000)",inOutQuart:"cubic-bezier(0.770,  0.000, 0.175, 1.000)",inOutQint:"cubic-bezier(0.860,  0.000, 0.070, 1.000)",inOutSine:"cubic-bezier(0.445,  0.050, 0.550, 0.950)",inOutExpo:"cubic-bezier(1.000,  0.000, 0.000, 1.000)",inOutCirc:"cubic-bezier(0.785,  0.135, 0.150, 0.860)",inOutBack:"cubic-bezier(0.680, -0.550, 0.265, 1.550)"};function stringToEasing(easingString){return lively_lang.obj.isFunction(easingString)?easingString:Bezier.apply(void 0,toConsumableArray(eval("(["+easingString.match(/\((.*)\)/)[1]+"])")))}var AnimationQueue=function(e){var t=_classRecorder,n=t.hasOwnProperty("AnimationQueue")&&"function"==typeof t.AnimationQueue?t.AnimationQueue:t.AnimationQueue=function AnimationQueue(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function AnimationQueue_initialize_(e){this.morph=e,this.animations=[]}},{key:"maskedProps",value:function AnimationQueue_maskedProps_(e){return this.animations.length>0?lively_lang.obj.merge(this.animations.map(function(t){return t.getAnimationProps(e)[0]})):{}}},{key:"animationsActive",get:function get(){return!0}},{key:"registerAnimation",value:function AnimationQueue_registerAnimation_(e){var t=this,n=new PropertyAnimation(this,this.morph,e);return this.morph.makeDirty(),this.morph.withMetaDo({animation:n},function(){var e=n.affectsMorph&&t.animations.find(function(e){return e.equals(n)});if(!e){var r=void 0;return(r=t.animations.find(function(e){return e.canMerge(n)}))?(r.mergeWith(n),r):(n.assignProps(),t.animations.push(n),n)}return e})}},{key:"startAnimationsFor",value:function AnimationQueue_startAnimationsFor_(e){for(var t=0;t<this.animations.length;t++){this.animations[t].start(e)}}},{key:"startSvgAnimationsFor",value:function AnimationQueue_startSvgAnimationsFor_(e,t){this.animations.forEach(function(n){return n.startSvg(e,t)})}},{key:"removeAnimation",value:function AnimationQueue_removeAnimation_(e){lively_lang.arr.remove(this.animations,e)}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2444,end:3712})}(void 0),PropertyAnimation=function(e){var t=_classRecorder,n=t.hasOwnProperty("PropertyAnimation")&&"function"==typeof t.PropertyAnimation?t.PropertyAnimation:t.PropertyAnimation=function PropertyAnimation(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function PropertyAnimation_initialize_(e,t,n){var r,i;this.queue=e,this.morph=t,t.isPath&&n.fill&&(r=t.fill,i=n.fill,n.customTween=lively_lang.fun.compose(function(e){return t.fill=r.interpolate(e,i),e},n.customTween||function(e){}),delete n.fill,t.fill=r),this.config=this.convertBounds(n),this.needsAnimation={svg:t.isSvgMorph,path:t.isPath},this.capturedProperties=lively_lang.obj.select(this.morph,this.propsToCapture)}},{key:"propsToCapture",get:function get(){return["fill","origin"]}},{key:"asPromise",value:function PropertyAnimation_asPromise_(){var e=this;return this._promise||(this._promise=new Promise(function(t,n){e.resolveCallback=function(){e.onFinish(e),e.subAnimations?e.subAnimations.then(t):t(e.morph)}}))}},{key:"finish",value:function PropertyAnimation_finish_(e){var t=this;this.config.scale&&this.morph.whenRendered().then(function(){return t.morph.withAllSubmorphsDo(function(e){return e.isText&&e.invalidateTextLayout(!0,!0)})}),this.needsAnimation[e]=!1,lively_lang.arr.any(Object.values(this.needsAnimation),Boolean)||(this.queue.removeAnimation(this),this.resolveCallback?this.resolveCallback():this.onFinish())}},{key:"convertBounds",value:function PropertyAnimation_convertBounds_(e){var t=e.bounds,n=e.origin,r=e.rotation,i=e.scale;e.layout,e.fill,n=n||this.morph.origin,r=r||this.morph.rotation,i=i||this.morph.scale;return t?Object.assign({},lively_lang.obj.dissoc(e,["bounds"]),{origin:n,rotation:r,scale:i,position:t.topLeft().addPt(n),extent:t.extent()}):e}},{key:"equals",value:function PropertyAnimation_equals_(e){return lively_lang.obj.equals(this.animatedProps,e.animatedProps)}},{key:"canMerge",value:function PropertyAnimation_canMerge_(e){return this.easing==e.easing&&this.duration==e.duration}},{key:"mergeWith",value:function PropertyAnimation_mergeWith_(e){var t=this.config.customTween;Object.assign(this.morph,e.animatedProps),Object.assign(this.config,e.config),this.config.customTween=function customTween(n){t&&t(n),e.customTween&&e.config.customTween(n)},this.afterProps=this.gatherAnimationProps()}},{key:"affectsMorph",get:function get(){var e=this;return!!this.config.customTween||lively_lang.properties.any(this.animatedProps,function(t,n){return!lively_lang.obj.equals(t[n],e.morph[n])})}},{key:"animatedProps",get:function get(){return lively_lang.obj.dissoc(this.config,["easing","onFinish","duration"])}},{key:"easing",get:function get(){return this.config.easing||easings.inOutQuad}},{key:"onFinish",get:function get(){return this.config.onFinish||function(){}}},{key:"setonFinish",value:function PropertyAnimation_setonFinish_(e){this.config.onFinish=e}},{key:"duration",get:function get(){return this.config.duration||1e3}},{key:"getChangedProps",value:function PropertyAnimation_getChangedProps_(e,t){var n=[];for(var r in e)lively_lang.obj.equals(t[r],e[r])&&n.push(r);return[lively_lang.obj.dissoc(e,n),lively_lang.obj.dissoc(t,n)]}},{key:"getAnimationProps",value:function PropertyAnimation_getAnimationProps_(e){var t=this.getChangedProps(this.beforeProps[e],this.afterProps[e]),n=slicedToArray(t,2),r=n[0],i=n[1],o=this.capturedProperties,a=o.fill,s=(o.dropShadow,this.config),l=s.fill;s.dropShadow;this.morph.isPolygon&&"css"==e&&(a=l=!1,delete r.background,delete i.background,delete r.backgroundImage,delete i.backgroundImage),"none"==r.filter&&i.boxShadow&&(delete r.filter,r.boxShadow="none"),"none"==i.filter&&r.boxShadow&&(delete i.filter,i.boxShadow="none"),a&&l&&(a.isGradient||l.isGradient)&&(this.tweenGradient=this.interpolate("gradient",a,l));var c=!0,u=!1,h=void 0;try{for(var d,p=lively_lang.arr.union(lively_lang.obj.keys(r),lively_lang.obj.keys(i))[Symbol.iterator]();!(c=(d=p.next()).done);c=!0){var f=d.value;!f in r&&(r[f]=i[f]),!f in i&&(i[f]=r[f])}}catch(e){u=!0,h=e}finally{try{!c&&p.return&&p.return()}finally{if(u)throw h}}return[!lively_lang.obj.isEmpty(r)&&r,!lively_lang.obj.isEmpty(i)&&i]}},{key:"gatherAnimationProps",value:function PropertyAnimation_gatherAnimationProps_(){var e=this.morph,t=e.isSvgMorph,n=e.isPath,r=e.isPolygon,i={};return i.css=styleProps(this.morph),t&&(i.svg=addSvgAttributes(e,{})),n&&(i.path=addPathAttributes(e,{})),r&&(i.polygon=addPathAttributes(e,{})),i}},{key:"assignProps",value:function PropertyAnimation_assignProps_(){var e=this.morph.styleClasses;this.beforeProps=this.gatherAnimationProps(),Object.assign(this.morph,this.animatedProps),this.afterProps=this.gatherAnimationProps(),this.config.styleClasses&&(this.morph._animatedStyleClasses={removed:lively_lang.arr.withoutAll(e,this.morph.styleClasses),added:lively_lang.arr.withoutAll(this.morph.styleClasses,e),animation:this})}},{key:"interpolate",value:function PropertyAnimation_interpolate_(e,t,n){var r=this;switch(e){case"scrollTop":case"scrollLeft":return function(e){return lively_lang.num.interpolate(e,t,n)};case"d":return flubber.interpolate(t,n);case"stroke-width":return function(e){return lively_lang.num.interpolate(e,t,n)};case"stroke":return function(e){return lively_graphics.Color.fromString(t).interpolate(e,lively_graphics.Color.fromString(n),r.morph.bounds())};case"gradient":return function(e){return t.interpolate(e,n,r.morph.bounds())};case"fill":return t=lively_graphics.Color.fromString(t),n=lively_graphics.Color.fromString(n),function(e){return t.interpolate(e,n)}}}},{key:"startSvg",value:function PropertyAnimation_startSvg_(e,t){var n=this;this.needsAnimation[t]&&function(){n.needsAnimation[t]=!1;var r=n.getAnimationProps(t),i=slicedToArray(r,2),o=i[0],a=i[1],s={},l=stringToEasing(n.easing);for(var c in o)s[c]=n.interpolate(c,o[c],a[c]);var u=void 0;requestAnimationFrame(function draw(r){var i;if(u||(u=r),(i=r-u)/n.duration>1)return n.finish(t);for(var o in s)s[o]&&e.setAttribute(o,s[o](l(i/n.duration)));requestAnimationFrame(draw)})}()}},{key:"start",value:function PropertyAnimation_start_(e){if(!this.active){this.active=!0;var t=this.getAnimationProps("css"),n=slicedToArray(t,2),r=n[0],i=n[1];if(this.tween(e,r,i),this.config.origin){var o=this.capturedProperties.origin,a=this.config.origin;this.tween(e.childNodes[0],{transform:"translate3d("+o.x+"px, "+o.y+"px, 0px)"},{transform:"translate3d("+a.x+"px, "+a.y+"px, 0px)"})}}}},{key:"tween",value:function PropertyAnimation_tween_(e,t,n){var r,i,o=this,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=this.animatedProps.scroll,l=this.config.customTween,c=!1,u=function onComplete(){a&&(o.finish("css"),o.morph.makeDirty())};l&&(r=void 0,i=stringToEasing(o.easing),requestAnimationFrame(function draw(e){var t,n;if(r||(r=e),t=e-r,n=Math.min(1,t/o.duration),o.morph.dontRecordChangesWhile(function(){return l(i(n))}),n>=1)return o.finish("css");requestAnimationFrame(draw)}),c=!0),s&&function(){var t=void 0,n=o.morph.env.eventDispatcher.eventState,r=lively_lang.promise.deferred(),i=r.promise,a=r.resolve,l=o.interpolate("scrollLeft",e.scrollTop,s.x),u=o.interpolate("scrollTop",e.scrollTop,s.y),h=stringToEasing(o.easing);i.debounce=function(){},requestAnimationFrame(function draw(r){var i,s;if(t||(t=r),i=r-t,s=Math.min(1,i/o.duration),e.scrollTop=u(h(s)),e.scrollLeft=l(h(s)),i/o.duration>=1)return n.scroll.interactiveScrollInProgress=null,a(),o.finish("css");requestAnimationFrame(draw)}),c=!0}(),this.tweenGradient&&!this.morph.isPolygon?function(){var r=void 0,i=stringToEasing(o.easing);delete t.backgroundImage,delete n.backgroundImage,delete t.background,delete n.background,requestAnimationFrame(function draw(t){var n;if(r||(r=t),(n=t-r)/o.duration>=1)return o.finish("css");e.style.setProperty("background-image",o.tweenGradient(i(n/o.duration))),requestAnimationFrame(draw)}),c=!0}():this.tweenGradient&&(c=!0),t&&n&&function(){var r={},i={};for(var a in t)r[lively_lang.string.camelize(a)]=t[a];for(var s in n)i[lively_lang.string.camelize(s)]=n[s];var l=e.animate([r,i],{duration:o.duration,easing:o.easing,fill:"forwards",composite:"replace"});l.onfinish=function(){u(),setTimeout(function(){return l.cancel()},200)},c=!0}(),c||u()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3721,end:15180})}(void 0),createDOMEnvironment_browser=(_ref=asyncToGenerator(regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function _callee$(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=IFramedDomEnvironment,e.next=3,createIFrame(document.body);case 3:return e.t1=e.sent,e.abrupt("return",new e.t0(e.t1));case 5:case"end":return e.stop()}},_callee,this)})),function createDOMEnvironment_browser(){return _ref.apply(this,arguments)}),_ref;function cumulativeOffset(e){var t=0,n=0;do{t+=e.offsetTop||0,n+=e.offsetLeft||0,e=e.offsetParent}while(e);return{top:t,left:n}}function createIFrame(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"about:blank",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new lively_graphics.Rectangle(0,0,700,700);return new Promise(function(r,i){if(!e)throw new Error("Need parent element!");var o=document.createElement("iframe");o.style.position="absolute",o.style.top=n.top()+"px",o.style.left=n.left()+"px",o.style.width=n.width+"px",o.style.height=n.height+"px",o.src=t;var a=!1;o.onload=function(e){a=!0,o.onload=null,r(o)},lively_lang.promise.waitFor(1e3,function(){return!!a}).catch(function(e){return i(new Error("iframe load timeout"))}),e.appendChild(o)})}function requestAnimationFramePolyfill(e){for(var t=0,n=["ms","moz","webkit","o"],r=0;r<n.length&&!e.requestAnimationFrame;++r)e.requestAnimationFrame=e[n[r]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[r]+"CancelAnimationFrame"]||e[n[r]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(n,r){var i=Date.now(),o=Math.max(0,16-(i-t)),a=e.setTimeout(function(){n(i+o)},o);return t=i+o,a}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)})}function createDOMEnvironment_node(){System.decanonicalize("lively.morphic/").replace(/file:\/\//,"");var e=System._nodeRequire("jsdom"),t=e.createVirtualConsole().sendTo(console);return new Promise(function(n,r){e.env("<div></div>",["https://code.jquery.com/pep/0.4.1/pep.js"],{virtualConsole:t},function(e,t){return e?r(e):n(new DomEnvironment(t,t.document,function(){return t.close()}))})})}function createDOMEnvironment(){return System.get("@system-env").browser?createDOMEnvironment_browser():createDOMEnvironment_node()}var DomEnvironment=function(e){var t=_classRecorder,n=t.hasOwnProperty("DomEnvironment")&&"function"==typeof t.DomEnvironment?t.DomEnvironment:t.DomEnvironment=function DomEnvironment(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function DomEnvironment_initialize_(e,t,n){requestAnimationFramePolyfill(e),this.window=e,this.document=t,this.destroyFn=n}},{key:"destroy",value:function DomEnvironment_destroy_(){"function"==typeof this.destroyFn&&this.destroyFn()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3027,end:3321})}(void 0),IFramedDomEnvironment=function(e){var t=_classRecorder,n=t.hasOwnProperty("IFramedDomEnvironment")&&"function"==typeof t.IFramedDomEnvironment?t.IFramedDomEnvironment:t.IFramedDomEnvironment=function IFramedDomEnvironment(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function IFramedDomEnvironment_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e.contentWindow,e.contentWindow.document,function(){e.contentWindow&&e.contentWindow.close(),e.parentNode&&e.parentNode.removeChild(e)}),this.iframe=e}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3323,end:3667})}({referencedAs:"DomEnvironment",value:DomEnvironment}),_defaultEnv;function defaultDOMEnv(){return _defaultEnv||(_defaultEnv=System.get("@system-env").browser?new DomEnvironment(window,document):createDOMEnvironment())}function setCSSDef(e,t,n){lively_lang.arr.from(e.childNodes).forEach(function(t){return e.removeChild(t)});var r=n.createTextNode(t);return e.styleSheet?e.styleSheet.cssText=r.nodeValue:e.appendChild(r),e}function addCSSDef(e,t,n){var r=n.createElement("style");return r.type="text/css",e&&r.setAttribute("id",e),setCSSDef(r,t,n),n.head.appendChild(r),r}function addOrChangeCSSDeclaration(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"lively-css",t=arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:document,r=n.getElementById(e);return r?setCSSDef(r,t,n):addCSSDef(e,t,n)}function addOrChangeLinkedCSS(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:document,r=n.getElementById(e);if(r||((r=n.createElement("link")).type="text/css",r.rel="stylesheet",r.setAttribute("id",e),n.head.appendChild(r)),r.getAttribute("href")!==t){r.setAttribute("href",t);var i=!1;return r.onload=function(){return i=!0},lively_lang.promise.waitFor(function(){return!!i&&r})}return Promise.resolve()}var hyperscriptFnForDocument=function(){new WeakMap;return function hyperscriptFnForDocument(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.document;return h_dom;function h_dom(t,n,r){var i=n||void 0;void 0===r&&(r=n,i=void 0);var o=[],a=t.split(".");if(a.length>1){t=a.shift();for(var s=0;s<a.length;s++){var l,c=a[s];(l=c.indexOf("#"))>-1&&(c.slice(l+1),c=c.slice(0,l)),o.push(c)}}var u=t.split("#");u.length>1&&(t=u[0],u[1]);var h=e.createElement(t);if(i){for(var d in i)"style"!==d&&"dataset"!==d&&(h[d]=i[d]);var p=i.style;if(p)for(var f in p)h.style[f]=p[f];var g=i.dataset;if(g)if(h.dataset)for(var m in g)h.dataset[m]=g[m];else for(var m in g)h.setAttribute("data-"+m,g[m])}if(r||(r=""),"string"==typeof r)h.appendChild(e.createTextNode(r));else if(Array.isArray(r))for(s=0;s<r.length;s++){var v=r[s];h.appendChild("string"==typeof v?e.createTextNode(v):v)}else h.appendChild("string"==typeof r?e.createTextNode(r):r);return h}}}(),svgNs="http://www.w3.org/2000/svg",Renderer=function(e){var t=_classRecorder,n=t.hasOwnProperty("Renderer")&&"function"==typeof t.Renderer?t.Renderer:t.Renderer=function Renderer(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Renderer_initialize_(e,t,n){if(!e||!e.isMorph)throw new Error("Trying to initialize renderer with an invalid world morph: "+e);if(!(t&&"nodeType"in t))throw new Error("Trying to initialize renderer with an invalid root node: "+t);if(!n){var r=t.ownerDocument;n={window:System.global,document:r}}this.worldMorph=e,e._renderer=this,this.rootNode=t,this.domNode=null,this.domEnvironment=n,this.renderMap=new WeakMap,this.fixedMorphNodeMap=new Map,this.renderWorldLoopProcess=null,this.renderWorldLoopLater=null,this.requestAnimationFrame=n.window.requestAnimationFrame.bind(n.window)}},{key:"clear",value:function Renderer_clear_(){this.stopRenderWorldLoop(),this.domNode&&this.domNode.parentNode.removeChild(this.domNode),this.domNode=null,this.renderMap=new WeakMap}},{key:"ensureDefaultCSS",value:function Renderer_ensureDefaultCSS_(){var e=this;return lively_lang.promise.waitFor(3e3,function(){return e.domNode.ownerDocument}).then(function(e){return Promise.all([addOrChangeCSSDeclaration("lively-morphic-css",defaultCSS,e),addOrChangeLinkedCSS("lively-font-awesome","/lively.morphic/assets/font-awesome/css/font-awesome.css",e),addOrChangeLinkedCSS("lively-font-inconsolata","/lively.morphic/assets/inconsolata/inconsolata.css",e)])})}},{key:"startRenderWorldLoop",value:function Renderer_startRenderWorldLoop_(){var e=this;return this.renderWorldLoopProcess=this.requestAnimationFrame(function(){return e.startRenderWorldLoop()}),this.renderStep()}},{key:"stopRenderWorldLoop",value:function Renderer_stopRenderWorldLoop_(){this.domEnvironment.window.cancelAnimationFrame(this.renderWorldLoopProcess),this.renderWorldLoopProcess=null,this.domEnvironment.window.cancelAnimationFrame(this.renderWorldLoopLater),this.renderWorldLoopLater=null}},{key:"renderLater",value:function Renderer_renderLater_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;this.renderWorldLoopLaterCounter=t,this.renderWorldLoopLater||(this.renderWorldLoopLater=this.requestAnimationFrame(function(){e.renderWorldLoopLater=null,e.renderWorldLoopLaterCounter>0&&e.renderLater(e.renderWorldLoopLaterCounter-1);try{e.renderStep()}catch(e){console.error("Error rendering morphs:",e)}}))}},{key:"renderStep",value:function Renderer_renderStep_(){return this.worldMorph.renderAsRoot(this),this}},{key:"getNodeForMorph",value:function Renderer_getNodeForMorph_(e){var t="#"+lively_lang.string.regExpEscape(e.id),n=this.domNode&&this.domNode.querySelector(t);if(n)return n;var r=!0,i=!1,o=void 0;try{for(var a,s=this.fixedMorphNodeMap.values()[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){if(n=a.value.querySelector(t))return n}}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return null}},{key:"getMorphForNode",value:function Renderer_getMorphForNode_(e){return this.worldMorph?this.worldMorph.withAllSubmorphsDetect(function(t){return t.id===e.id}):null}},{key:"render",value:function Renderer_render_(e){if(!e.needsRerender()){var t=this.renderMap.get(e);if(t)return t}e.aboutToRender(this);var n=e.render(this);return this.renderMap.set(e,n),n}},{key:"renderAsFixed",value:function Renderer_renderAsFixed_(e){var t=this.render(e);return t.properties.style.position="fixed",t}},{key:"renderFixedMorphs",value:function Renderer_renderFixedMorphs_(e,t){var n=this.domNode,r=this.fixedMorphNodeMap;if((e.length||r.size)&&n&&n.parentNode){var i=!0,o=!1,a=void 0;try{for(var s,l=r[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var c=slicedToArray(s.value,2),u=c[0],h=c[1];e.includes(u)||(h.parentNode.removeChild(h),r.delete(u))}}catch(e){o=!0,a=e}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}var d=!0,p=!1,f=void 0;try{for(var g,m=e[Symbol.iterator]();!(d=(g=m.next()).done);d=!0){u=g.value;var v=this.renderMap.get(u)||this.renderAsFixed(u),y=this.renderAsFixed(u),_=vdom.diff(v,y),b=r.get(u);b||(b=vdom.create(v,this.domEnvironment),r.set(u,b)),b.parentNode||n.parentNode.appendChild(b),vdom.patch(b,_)}}catch(e){p=!0,f=e}finally{try{!d&&m.return&&m.return()}finally{if(p)throw f}}}}},{key:"renderMorph",value:function Renderer_renderMorph_(e){var t=this.renderSubmorphs(e);return vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:defaultStyle(e)}),t)}},{key:"renderSubmorphs",value:function Renderer_renderSubmorphs_(e){return this.renderSelectedSubmorphs(e,e.submorphs)}},{key:"renderSelectedSubmorphs",value:function Renderer_renderSelectedSubmorphs_(e,t){for(var n=e.borderWidthLeft,r=e.borderWidthTop,i=e.origin,o=i.x,a=i.y,s=t.length-1,l=new Array(s+1);s>=0;s--)l[s]=this.render(t[s]);return vdom.h("div",{style:Object.assign({position:"absolute",transform:"translate("+(o-(e.isPath?0:n))+"px,"+(a-(e.isPath?0:r))+"px)"},e.isPolygon?Object.assign({height:"100%",width:"100%",overflow:e.clipMode},"visible"!==e.clipMode?defineProperty({},navigator.userAgent.includes("AppleWebKit")?"-webkit-clip-path":"clip-path","url(#clipPath"+e.id+")"):{}):{})},l)}},{key:"renderWorld",value:function Renderer_renderWorld_(e){for(var t=e.submorphs,n=[],r=[],i=0;i<t.length;i++){var o=t[i];o.hasFixedPosition?r.push(o):n.push(o)}var a=this.renderSelectedSubmorphs(e,n),s=vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:defaultStyle(e)}),a);return s.fixedMorphs=r,s}},{key:"renderImage",value:function Renderer_renderImage_(e){var t=e.imageUrl;if(t.startsWith("data:")){var n=t.indexOf(","),r=t.substring(5,n).split(";"),i=slicedToArray(r,2),o=i[0],a=i[1],s=t.substring(n+1);"base64"!==a&&(t=lively_lang.string.createDataURI(s,o))}return vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:defaultStyle(e)}),[vdom.h("img",{src:t,draggable:!1,style:{"pointer-events":"none",position:"absolute",left:0,width:"100%",height:"100%"}}),this.renderSubmorphs(e)])}},{key:"renderCanvas",value:function Renderer_renderCanvas_(e){var t=function CanvasHook(){};return t.prototype.hook=function(t,n,r){var i=e._canvas!==t;e.afterRender(t,i)},vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:defaultStyle(e)}),[vdom.h("canvas",{width:e.width,height:e.height,style:{"pointer-events":"none",position:"absolute"},canvasHook:new t}),this.renderSubmorphs(e)])}},{key:"renderCheckBox",value:function Renderer_renderCheckBox_(e){return vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:defaultStyle(e)}),[vdom.h("input",{type:"checkbox",checked:e.checked,disabled:!e.active,draggable:!1,style:{"pointer-events":"none",width:"15px",height:"15px",position:"absolute"}}),this.renderSubmorphs(e)])}},{key:"renderPath",value:function Renderer_renderPath_(e){e.id;var t=e.startMarker,n=e.endMarker,r=e.showControlPoints,i=(e.origin,getSvgVertices(e.vertices)),o=vdom.h("path",Object.assign({namespace:svgNs,id:"svg"+e.id},pathAttributes(e))),a=[vdom.h("clipPath",{namespace:svgNs,id:"clipPath"+e.id},vdom.h("path",{namespace:svgNs,attributes:{d:i,fill:"white"}}))];t&&(t.id||(t.id="start-marker"),o.properties.attributes["marker-start"]="url(#"+e.id+"-"+t.id+")",(a=[]).push(this._renderPath_Marker(e,t))),n&&(n.id||(n.id="end-marker"),o.properties.attributes["marker-end"]="url(#"+e.id+"-"+n.id+")",a||(a=[]),a.push(this._renderPath_Marker(e,n)));var s=void 0;return r&&(s=vdom.h("g",{namespace:svgNs},this._renderPath_ControlPoints(e))),this.renderSvgMorph(e,o,a,s)}},{key:"_renderPath_ControlPoints",value:function Renderer__renderPath_ControlPoints_(e,t){var n=e.vertices,r=e.borderWidth,i=e.showControlPoints,o=e._controlPointDrag,a=0==r?6:r+2,s="red",l=[];if("object"===(void 0===i?"undefined":_typeof(i))){var c=i.radius,u=i.fill;u&&(s=String(u)),"number"==typeof c&&(a=c)}if(n.length){var h=0,d=void 0,p=void 0,f=void 0,g=n[0],m=g.x,v=g.y,y=g.controlPoints.next,_=o&&o.maybeMerge&&o.maybeMerge.includes(h);for(d=m,p=v,l.push(circ(d,p,h,_)),f=y,h=1;h<n.length-1;h++){var b=n[h],x=b.isSmooth,w=b.x,k=b.y,S=b.controlPoints,C=S.previous,M=S.next,T=o&&o.maybeMerge&&o.maybeMerge.includes(h);x?l.push(circ(w,k,h,T),circ(d+f.x,p+f.y,h-1,!1,"control-2",!0),circ(w+C.x,k+C.y,h,!1,"control-1",!0)):l.push(circ(w,k,h,T)),d=w,p=k,f=M}var P=n[n.length-1],A=(x=P.isSmooth,P.x),L=P.y,R=(C=P.controlPoints.previous,o&&o.maybeMerge&&o.maybeMerge.includes(h));x?l.push(circ(A,L,h,R),circ(d+f.x,p+f.y,h-1,!1,"control-2",!0),circ(A+C.x,L+C.y,h,!1,"control-1",!0)):l.push(circ(A,L,h,R))}return l;function circ(e,t,n,r,i,o){var l=r?12:Math.min(8,Math.max(3,a)),c="path-point path-point-"+n,u=r?"orange":s;return"string"==typeof i&&(c+="-"+i),o&&(l=Math.max(3,Math.ceil(l/2))),o?vdom.h("circle",{namespace:svgNs,style:{fill:"white","stroke-width":2,stroke:u},attributes:{class:c,cx:e,cy:t,r:l}}):vdom.h("circle",{namespace:svgNs,style:{fill:u},attributes:{class:c,cx:e,cy:t,r:l}})}}},{key:"_renderPath_Marker",value:function Renderer__renderPath_Marker_(e,t){return function specTo_h_svg(t){var n=t.tagName,r=t.id,i=t.children,o=t.style,a=i?i.map(specTo_h_svg):void 0;r&&(r=e.id+"-"+r);return vdom.h(n,{namespace:svgNs,id:r,style:o,attributes:lively_lang.obj.dissoc(t,["tagName","id","children","style"])},a)}(t)}},{key:"renderSvgMorph",value:function Renderer_renderSvgMorph_(e,t,n){var r,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=defaultStyle(e),a=o.position,s=o.filter,l=o.display,c=o.opacity,u=o.transform,h=o.transformOrigin,d=o.cursor,p=(o.overflow,svgAttributes(e)),f=e.innerBounds(),g=f.width,m=f.height,v=void 0,y=[];(e.fill&&e.fill.isGradient&&(v||(v=[]),v.push(renderGradient("fill"+e.id,e.extent,e.fill))),e.borderColor&&e.borderColor.valueOf().isGradient&&(v||(v=[]),v.push(renderGradient("borderColor"+e.id,e.extent,e.borderColor))),n&&n.length)&&(v||(v=[]),(r=v).push.apply(r,toConsumableArray(n)));return y.push(t),v&&y.push(vdom.h("defs",{namespace:svgNs},v)),vdom.h("div",Object.assign({},defaultAttributes(e,this),{style:{transform:u,transformOrigin:h,position:a,opacity:c,cursor:d,width:g+"px",height:m+"px",display:l,filter:s,"pointer-events":e.reactsToPointer?"auto":"none"}}),[vdom.h("svg",Object.assign({namespace:svgNs,version:"1.1",style:{position:"absolute",overflow:"visible"}},p),y),this.renderSubmorphs(e),vdom.h("svg",Object.assign({namespace:svgNs,version:"1.1",style:{position:"absolute",overflow:"visible"}},p),i)])}},{key:"renderPreview",value:function Renderer_renderPreview_(e,t){var n=t.width,r=void 0===n?100:n,i=t.height,o=void 0===i?100:i,a=t.center,s=void 0===a||a,l=t.asNode,c=void 0!==l&&l,u=(t.includeStyles,t.disableScroll,e.borderWidthLeft,e.borderWidthTop,e.borderWidthBottom,e.borderWidthRight,e.scale),h=e.position,d=e.origin,p=e.rotation,f=r,g=o,m=Math.max(.1,1/u),v=new lively_graphics.Transform(h.negated(),0,lively_graphics.pt(m,m)).transformRectToRect(e.bounds()),y=v.width,_=v.height,b=Math.max(.1,Math.min(f/y,g/_)),x=renderMorph(e),w=new lively_graphics.Transform(v.topLeft().negated().scaleBy(b).subPt(d),p,lively_graphics.pt(b,b));if(s){var k=w.transformRectToRect(e.extent.extentAsRectangle()),S=k.width<f?(f-k.width)/2:0,C=k.height<g?(g-k.height)/2:0;w=w.preConcatenate(new lively_graphics.Transform(lively_graphics.pt(S,C)))}return x.style.transform=w.toCSSTransformString(),x.style.pointerEvents="",lively_lang.tree.prewalk(x,function(e){if("string"==typeof e.className){var t=e.className.split(" ").map(function(e){return e.trim()}).filter(Boolean);t.includes("Morph")&&(e.className=lively_lang.arr.withoutAll(t,["morph","Morph"]).join(" "),e.id="")}},function(e){return Array.from(e.childNodes)}),c?x:x.outerHTML}}],[{key:"default",value:function Renderer_default_(){return this._default||new this}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:560,end:17505})}(void 0),FontDetector=function(e){var t=_classRecorder,n=t.hasOwnProperty("FontDetector")&&"function"==typeof t.FontDetector?t.FontDetector:t.FontDetector=function FontDetector(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function FontDetector_initialize_(e){this.document=e,this.prepared=!1,this.defaultWidth={},this.defaultHeight={},this.baseFonts=["monospace","sans-serif","serif"],this.span=null}},{key:"prepare",value:function FontDetector_prepare_(){var e=this.defaultWidth,t=this.defaultHeight,n=this.baseFonts,r=this.document.getElementsByTagName("body")[0],i=this.span=this.document.createElement("span");for(var o in i.style.fontSize="72px",i.innerHTML="mmmmmmmmmmlli",n)i.style.fontFamily=n[o],r.appendChild(i),e[n[o]]=i.offsetWidth,t[n[o]]=i.offsetHeight,r.removeChild(i);this.prepared=!0}},{key:"isFontSupported",value:function FontDetector_isFontSupported_(e){this.prepared||this.prepare();var t=this.defaultWidth,n=this.defaultHeight,r=this.baseFonts,i=this.span,o=this.document.body;try{for(var a in o.appendChild(i),r){if(i.style.fontFamily=e+","+r[a],i.offsetWidth!=t[r[a]]||i.offsetHeight!=n[r[a]])return!0}return!1}finally{o.removeChild(i)}}}],[{key:"fonts",get:function get(){return fonts}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:15,end:2530})}(void 0),fonts=[{name:"serif",type:"default"},{name:"sans-serif",type:"default"},{name:"monospace",type:"default"},{name:"Adobe Jenson",type:"serif"},{name:"Albertus",type:"serif"},{name:"Aldus",type:"serif"},{name:"Alexandria",type:"serif"},{name:"Algerian",type:"serif"},{name:"American Typewriter",type:"serif"},{name:"Antiqua",type:"serif"},{name:"Arno",type:"serif"},{name:"Aster",type:"serif"},{name:"Aurora",type:"serif"},{name:"News 706",type:"serif"},{name:"Baskerville",type:"serif"},{name:"Bell",type:"serif"},{name:"Belwe Roman",type:"serif"},{name:"Bembo",type:"serif"},{name:"Berkeley Old Style",type:"serif"},{name:"Bernhard Modern",type:"serif"},{name:"Bodoni",type:"serif"},{name:"Book Antiqua",type:"serif"},{name:"Bookman",type:"serif"},{name:"Bulmer",type:"serif"},{name:"Caledonia",type:"serif"},{name:"Californian FB",type:"serif"},{name:"Calisto MT",type:"serif"},{name:"Cambria",type:"serif"},{name:"Capitals",type:"serif"},{name:"Cartier",type:"serif"},{name:"Caslon",type:"serif"},{name:"Wyld",type:"serif"},{name:"Caslon Antique / Fifteenth Century",type:"serif"},{name:"Catull",type:"serif"},{name:"Centaur",type:"serif"},{name:"Century Old Style",type:"serif"},{name:"Century Schoolbook",type:"serif"},{name:"New Century Schoolbook",type:"serif"},{name:"Century Schoolbook Infant",type:"serif"},{name:"Charis SIL",type:"serif"},{name:"Charter (typeface)",type:"serif"},{name:"Cheltenham",type:"serif"},{name:"Clearface",type:"serif"},{name:"Cochin",type:"serif"},{name:"Colonna",type:"serif"},{name:"Computer Modern",type:"serif"},{name:"Concrete Roman",type:"serif"},{name:"Constantia",type:"serif"},{name:"Cooper Black",type:"serif"},{name:"Copperplate Gothic",type:"serif"},{name:"Corona",type:"serif"},{name:"News 705",type:"serif"},{name:"DejaVu Serif",type:"serif"},{name:"Didot",type:"serif"},{name:"Droid Serif",type:"serif"},{name:"Elephant",type:"serif"},{name:"Emerson",type:"serif"},{name:"Excelsior",type:"serif"},{name:"News 702",type:"serif"},{name:"Fairfield",type:"serif"},{name:"FF Scala",type:"serif"},{name:"Footlight",type:"serif"},{name:"FreeSerif",type:"serif"},{name:"Friz Quadrata",type:"serif"},{name:"Garamond",type:"serif"},{name:"Gentium",type:"serif"},{name:"Georgia",type:"serif"},{name:"Gloucester",type:"serif"},{name:"Goudy",type:"serif"},{name:"Granjon",type:"serif"},{name:"High Tower Text",type:"serif"},{name:"Hoefler Text",type:"serif"},{name:"Imprint",type:"serif"},{name:"Ionic No. 5",type:"serif"},{name:"News 701",type:"serif"},{name:"ITC Benguiat",type:"serif"},{name:"Janson",type:"serif"},{name:"Jokerman",type:"serif"},{name:"Joanna",type:"serif"},{name:"Korinna",type:"serif"},{name:"Lexicon",type:"serif"},{name:"Liberation Serif",type:"serif"},{name:"Linux Libertine",type:"serif"},{name:"Literaturnaya",type:"serif"},{name:"Lucida Bright",type:"serif"},{name:"Melior",type:"serif"},{name:"Memphis",type:"serif"},{name:"Miller",type:"serif"},{name:"Minion",type:"serif"},{name:"Modern",type:"serif"},{name:"Mona Lisa",type:"serif"},{name:"Mrs Eaves",type:"serif"},{name:"MS Serif",type:"serif"},{name:"New York",type:"serif"},{name:"Nimbus Roman",type:"serif"},{name:"NPS Rawlinson Roadway",type:"serif"},{name:"OCR A Extended",type:"serif"},{name:"Palatino",type:"serif"},{name:"Book Antiqua",type:"serif"},{name:"Perpetua",type:"serif"},{name:"Plantin",type:"serif"},{name:"Playbill",type:"serif"},{name:"Primer",type:"serif"},{name:"Renault",type:"serif"},{name:"Requiem",type:"serif"},{name:"Rotis Serif",type:"serif"},{name:"Sabon",type:"serif"},{name:"Sistina",type:"serif"},{name:"Souvenir",type:"serif"},{name:"XITS",type:"serif"},{name:"Sylfaen",type:"serif"},{name:"Times New Roman",type:"serif"},{name:"Times",type:"serif"},{name:"Torino",type:"serif"},{name:"Trajan",type:"serif"},{name:"Trinit",type:"serif"},{name:"Trump Mediaeval",type:"serif"},{name:"Utopia",type:"serif"},{name:"Vera Serif",type:"serif"},{name:"Wide Latin",type:"serif"},{name:"Windsor",type:"serif"},{name:"XITS",type:"serif"},{name:"Playfair Display",type:"serif",isGoogleFont:!0},{name:"Cormorant",type:"serif",isGoogleFont:!0},{name:"Eczar",type:"serif",isGoogleFont:!0},{name:"Alegreya",type:"serif",isGoogleFont:!0},{name:"Lora",type:"serif",isGoogleFont:!0},{name:"Source Serif Pro",type:"serif",isGoogleFont:!0},{name:"Roboto Slab",type:"serif",isGoogleFont:!0},{name:"BioRhyme",type:"serif",isGoogleFont:!0},{name:"Libre Baskerville",type:"serif",isGoogleFont:!0},{name:"Crimson Text",type:"serif",isGoogleFont:!0},{name:"Old Standard TT",type:"serif",isGoogleFont:!0},{name:"Domine",type:"serif",isGoogleFont:!0},{name:"Bitter",type:"serif",isGoogleFont:!0},{name:"Gentium Basic",type:"serif",isGoogleFont:!0},{name:"PT Serif",type:"serif",isGoogleFont:!0},{name:"Cardo",type:"serif",isGoogleFont:!0},{name:"Neuton",type:"serif",isGoogleFont:!0},{name:"Arvo",type:"serif",isGoogleFont:!0},{name:"Merriweather",type:"serif",isGoogleFont:!0},{name:"Alexandria",type:"slab serif"},{name:"American Typewriter",type:"slab serif"},{name:"Archer",type:"slab serif"},{name:"Athens",type:"slab serif"},{name:"Candida",type:"slab serif"},{name:"Cholla Slab",type:"slab serif"},{name:"City",type:"slab serif"},{name:"Clarendon",type:"slab serif"},{name:"Concrete Roman",type:"slab serif"},{name:"Courier",type:"slab serif"},{name:"Egyptienne",type:"slab serif"},{name:"Guardian Egyptian",type:"slab serif"},{name:"Ionic No. 5",type:"slab serif"},{name:"Lexia",type:"slab serif"},{name:"Memphis",type:"slab serif"},{name:"Nilland",type:"slab serif"},{name:"Roboto Slab",type:"slab serif"},{name:"Rockwell",type:"slab serif"},{name:"Schadow",type:"slab serif"},{name:"Serifa",type:"slab serif"},{name:"Skeleton Antique",type:"slab serif"},{name:"Sreda",type:"slab serif"},{name:"Swift",type:"slab serif"},{name:"Tower",type:"slab serif"},{name:"Agency FB",type:"sans-serif"},{name:"Akzidenz-Grotesk",type:"sans-serif"},{name:"Andal Sans",type:"sans-serif"},{name:"Antique Olive",type:"sans-serif"},{name:"Arial",type:"sans-serif"},{name:"Arial Unicode MS",type:"sans-serif"},{name:"Avant Garde Gothic",type:"sans-serif"},{name:"Avenir",type:"sans-serif"},{name:"Bank Gothic",type:"sans-serif"},{name:"Bauhaus",type:"sans-serif"},{name:"Bell Centennial",type:"sans-serif"},{name:"Bell Gothic",type:"sans-serif"},{name:"Benguiat Gothic",type:"sans-serif"},{name:"Berlin Sans",type:"sans-serif"},{name:"Brandon Grotesque",type:"sans-serif"},{name:"Calibri",type:"sans-serif"},{name:"Casey",type:"sans-serif"},{name:"Century Gothic",type:"sans-serif"},{name:"Charcoal",type:"sans-serif"},{name:"Chicago",type:"sans-serif"},{name:"Clearview",type:"sans-serif"},{name:"Comic Sans",type:"sans-serif"},{name:"Compacta",type:"sans-serif"},{name:"Corbel",type:"sans-serif"},{name:"DejaVu Sans",type:"sans-serif"},{name:"DIN",type:"sans-serif"},{name:"Dotum",type:"sans-serif"},{name:"Droid Sans",type:"sans-serif"},{name:"Dyslexie",type:"sans-serif"},{name:"Ecofont",type:"sans-serif"},{name:"Eras",type:"sans-serif"},{name:"Esseltub",type:"sans-serif"},{name:"Espy Sans",type:"sans-serif"},{name:"Eurocrat",type:"sans-serif"},{name:"Eurostile",type:"sans-serif"},{name:"Square 721",type:"sans-serif"},{name:"FF Dax",type:"sans-serif"},{name:"FF Meta",type:"sans-serif"},{name:"FF Scala Sans",type:"sans-serif"},{name:"Fira Sans",type:"sans-serif"},{name:"Folio",type:"sans-serif"},{name:"Franklin Gothic",type:"sans-serif"},{name:"FreeSans",type:"sans-serif"},{name:"Frutiger",type:"sans-serif"},{name:"Futura",type:"sans-serif"},{name:"Geneva",type:"sans-serif"},{name:"Gill Sans",type:"sans-serif"},{name:"Gill Sans Schoolbook",type:"sans-serif"},{name:"Gotham",type:"sans-serif"},{name:"Haettenschweiler",type:"sans-serif"},{name:"Handel Gothic",type:"sans-serif"},{name:"Hei",type:"sans-serif"},{name:"Helvetica",type:"sans-serif"},{name:"Helvetica Neue",type:"sans-serif"},{name:"Swiss 721",type:"sans-serif"},{name:"Highway Gothic",type:"sans-serif"},{name:"Hobo",type:"sans-serif"},{name:"Impact",type:"sans-serif"},{name:"Industria",type:"sans-serif"},{name:"Interstate",type:"sans-serif"},{name:"Johnston/New Johnston",type:"sans-serif"},{name:"Kabel",type:"sans-serif"},{name:"Klavika",type:"sans-serif"},{name:"Lexia Readable",type:"sans-serif"},{name:"Liberation Sans",type:"sans-serif"},{name:"Linux Biolinum",type:"sans-serif"},{name:"Lucida Sans",type:"sans-serif"},{name:"Lucida Grande",type:"sans-serif"},{name:"Lucida Sans Unicode",type:"sans-serif"},{name:"Lydian",type:"sans-serif"},{name:"Meiryo",type:"sans-serif"},{name:"Meta",type:"sans-serif"},{name:"Microgramma",type:"sans-serif"},{name:"Modern",type:"sans-serif"},{name:"Motorway",type:"sans-serif"},{name:"Arial",type:"sans-serif"},{name:"Myriad",type:"sans-serif"},{name:"Neutraface",type:"sans-serif"},{name:"Neuzeit S",type:"sans-serif"},{name:"News Gothic",type:"sans-serif"},{name:"Nimbus Sans L",type:"sans-serif"},{name:"Open Sans",type:"sans-serif"},{name:"Optima",type:"sans-serif"},{name:"Paris",type:"sans-serif"},{name:"Product Sans",type:"sans-serif"},{name:"Proxima Nova",type:"sans-serif"},{name:"Russian Federation",type:"sans-serif"},{name:"Rail Alphabet",type:"sans-serif"},{name:"Roboto",type:"sans-serif"},{name:"Rotis Sans",type:"sans-serif"},{name:"Segoe UI",type:"sans-serif"},{name:"Skia",type:"sans-serif"},{name:"Source Sans Pro",type:"sans-serif"},{name:"Sweden Sans",type:"sans-serif"},{name:"Syntax",type:"sans-serif"},{name:"Tahoma",type:"sans-serif"},{name:"Template Gothic",type:"sans-serif"},{name:"Thesis Sans",type:"sans-serif"},{name:"Tiresias",type:"sans-serif"},{name:"Trade Gothic",type:"sans-serif"},{name:"Transport",type:"sans-serif"},{name:"Trebuchet MS",type:"sans-serif"},{name:"Twentieth Century (Tw Cen MT)",type:"sans-serif"},{name:"Ubuntu",type:"sans-serif"},{name:"Univers",type:"sans-serif"},{name:"Zurich",type:"sans-serif"},{name:"Vera Sans",type:"sans-serif"},{name:"Verdana",type:"sans-serif"},{name:"Work Sans",type:"sans-serif",isGoogleFont:!0},{name:"Rubik",type:"sans-serif",isGoogleFont:!0},{name:"Libre Franklin",type:"sans-serif",isGoogleFont:!0},{name:"Fira Sans",type:"sans-serif",isGoogleFont:!0},{name:"Alegreya Sans",type:"sans-serif",isGoogleFont:!0},{name:"Chivo",type:"sans-serif",isGoogleFont:!0},{name:"Source Sans Pro",type:"sans-serif",isGoogleFont:!0},{name:"Roboto",type:"sans-serif",isGoogleFont:!0},{name:"Poppins",type:"sans-serif",isGoogleFont:!0},{name:"Archivo Narrow",type:"sans-serif",isGoogleFont:!0},{name:"Karla",type:"sans-serif",isGoogleFont:!0},{name:"Montserrat",type:"sans-serif",isGoogleFont:!0},{name:"Rajdhani",type:"sans-serif",isGoogleFont:!0},{name:"PT Sans",type:"sans-serif",isGoogleFont:!0},{name:"Lato",type:"sans-serif",isGoogleFont:!0},{name:"Open Sans",type:"sans-serif",isGoogleFont:!0},{name:"Cabin",type:"sans-serif",isGoogleFont:!0},{name:"Raleway",type:"sans-serif",isGoogleFont:!0},{name:"Nyala",type:"semi-serif"},{name:"Rotis Semi Serif",type:"semi-serif"},{name:"Easyreading",type:"semi-serif"},{name:"Andal Mono",type:"monospace"},{name:"Arial",type:"monospace"},{name:"Bitstream Vera (Vera Sans Mono)",type:"monospace"},{name:"Consolas",type:"monospace"},{name:"Courier",type:"monospace"},{name:"Courier New",type:"monospace"},{name:"DejaVu Sans Mono",type:"monospace"},{name:"Droid Sans Mono",type:"monospace"},{name:"Everson Mono",type:"monospace"},{name:"Fixed",type:"monospace"},{name:"Fixedsys",type:"monospace"},{name:"Fixedsys Excelsior",type:"monospace"},{name:"HyperFont",type:"monospace"},{name:"Inconsolata",type:"monospace"},{name:"Letter Gothic",type:"monospace"},{name:"Liberation Mono",type:"monospace"},{name:"Lucida Console",type:"monospace"},{name:"Lucida Sans Typewriter",type:"monospace"},{name:"Lucida Typewriter",type:"monospace"},{name:"Menlo",type:"monospace"},{name:"MICR",type:"monospace"},{name:"Monaco",type:"monospace"},{name:"Monospace",type:"monospace"},{name:"MS Gothic",type:"monospace"},{name:"MS Mincho",type:"monospace"},{name:"Nimbus Mono L",type:"monospace"},{name:"OCR-A",type:"monospace"},{name:"OCR-B",type:"monospace"},{name:"PragmataPro",type:"monospace"},{name:"Prestige Elite",type:"monospace"},{name:"ProFont",type:"monospace"},{name:"Proggy programming fonts",type:"monospace"},{name:"SimHei",type:"monospace"},{name:"SimSun",type:"monospace"},{name:"Source Code Pro",type:"monospace"},{name:"Terminal",type:"monospace"},{name:"Trixie",type:"monospace"},{name:"Ubuntu Mono",type:"monospace"},{name:"Vera Sans Mono (Bitstream Vera)",type:"monospace"},{name:"Space Mono",type:"monospace",isGoogleFont:!0},{name:"Inconsolata",type:"monospace",isGoogleFont:!0},{name:"Anonymous Pro",type:"monospace",isGoogleFont:!0},{name:"Balloon",type:"script"},{name:"Brush Script",type:"script"},{name:"Choc",type:"script"},{name:"Dom Casual",type:"script"},{name:"Mistral",type:"script"},{name:"Papyrus",type:"script"},{name:"Segoe Script",type:"script"},{name:"Utopia",type:"script"},{name:"Coronet",type:"script"},{name:"Curlz",type:"script"},{name:"Gravura",type:"script"},{name:"Script",type:"script"},{name:"Wiesbaden Swing",type:"script"},{name:"American Scribe",type:"script"},{name:"AMS Euler",type:"script"},{name:"Apple Chancery",type:"script"},{name:"Forte",type:"script"},{name:"French Script",type:"script"},{name:"ITC Zapf Chancery",type:"script"},{name:"Kuenstler Script",type:"script"},{name:"Monotype Corsiva",type:"script"},{name:"Old English Text MT",type:"script"},{name:"Zapfino",type:"script"},{name:"Andy",type:"handwriting"},{name:"Ashley Script",type:"handwriting"},{name:"Czanne",type:"handwriting"},{name:"Chalkboard",type:"handwriting"},{name:"Comic Sans MS",type:"handwriting"},{name:"Dom Casual",type:"handwriting"},{name:"Kristen",type:"handwriting"},{name:"Lucida Handwriting",type:"handwriting"},{name:"Bastard",type:"blackletter"},{name:"Breitkopf Fraktur",type:"blackletter"},{name:"Cloister Black",type:"blackletter"},{name:"Fette Fraktur",type:"blackletter"},{name:"Fletcher",type:"blackletter"},{name:"Fraktur",type:"blackletter"},{name:"Lucida Blackletter",type:"blackletter"},{name:"Old English Text",type:"blackletter"},{name:"Schwabacher",type:"blackletter"},{name:"Aharoni",type:"non-latin"},{name:"Aparajita",type:"non-latin"},{name:"Arial",type:"non-latin"},{name:"Calibri",type:"non-latin"},{name:"Chandas",type:"non-latin"},{name:"Gadugi",type:"non-latin"},{name:"Grecs du roi",type:"non-latin"},{name:"Javanese script",type:"non-latin"},{name:"Japanese Gothic",type:"non-latin"},{name:"Jomolhari",type:"non-latin"},{name:"Kiran",type:"non-latin"},{name:"Kochi",type:"non-latin"},{name:"Koren",type:"non-latin"},{name:"Kruti Dev",type:"non-latin"},{name:"Malgun Gothic",type:"non-latin"},{name:"Meiryo",type:"non-latin"},{name:"Microsoft JhengHei",type:"non-latin"},{name:"Microsoft YaHei",type:"non-latin"},{name:"Minch",type:"non-latin"},{name:"Ming",type:"non-latin"},{name:"Mona",type:"non-latin"},{name:"MS Gothic",type:"non-latin"},{name:"Nastaliq Navees",type:"non-latin"},{name:"Porson",type:"non-latin"},{name:"Segoe UI Symbol",type:"non-latin"},{name:"Shruti",type:"non-latin"},{name:"SimSun",type:"non-latin"},{name:"Sylfaen",type:"non-latin"},{name:"Tahoma",type:"non-latin"},{name:"Tengwar",type:"non-latin"},{name:"Tibetan Machine Uni",type:"non-latin"},{name:"Wilson Greek",type:"non-latin"},{name:"SMP",type:"unicode"},{name:"Microsoft Office",type:"unicode"},{name:"Bitstream Cyberbit",type:"unicode"},{name:"DejaVu fonts",type:"unicode"},{name:"Charis SIL",type:"unicode"},{name:"BMP",type:"unicode"},{name:"SMP",type:"unicode"},{name:"Code2002",type:"unicode"},{name:"DejaVu fonts",type:"unicode"},{name:"IPA",type:"unicode"},{name:"Everson Mono",type:"unicode"},{name:"Windows",type:"unicode"},{name:"Fixedsys Excelsior",type:"unicode"},{name:"FreeFont",type:"unicode"},{name:"Gentium",type:"unicode"},{name:"GNU Unifont",type:"unicode"},{name:"Georgia Ref",type:"unicode"},{name:"Microsoft Office",type:"unicode"},{name:"Junicode",type:"unicode"},{name:"Mac OS 8.5",type:"unicode"},{name:"macOS",type:"unicode"},{name:"ISO 8859-x",type:"unicode"},{name:"MS Gothic",type:"unicode"},{name:"MS Mincho",type:"unicode"},{name:"Nimbus Sans Global",type:"unicode"},{name:"Noto",type:"unicode"},{name:"Fabrizio Schiavi",type:"unicode"},{name:"Squarish Sans CT",type:"unicode"},{name:"XITS",type:"unicode"},{name:"Titus Cyberbit Basic",type:"unicode"},{name:"Verdana Ref",type:"unicode"},{name:"XITS",type:"unicode"},{name:"Apple Symbols",type:"symbol"},{name:"Asana-Math",type:"symbol"},{name:"Blackboard bold",type:"symbol"},{name:"Bookshelf Symbol 7",type:"symbol"},{name:"Cambria Math",type:"symbol"},{name:"Computer Modern",type:"symbol"},{name:"Lucida Math",type:"symbol"},{name:"Marlett",type:"symbol"},{name:"Symbol",type:"symbol"},{name:"Webdings",type:"symbol"},{name:"Wingdings",type:"symbol"},{name:"Wingdings 2",type:"symbol"},{name:"Wingdings 3",type:"symbol"},{name:"Zapf Dingbats",type:"symbol"},{name:"Ad Lib",type:"decorative"},{name:"Allegro",type:"decorative"},{name:"Andreas",type:"decorative"},{name:"Arnold Bcklin",type:"decorative"},{name:"Astur",type:"decorative"},{name:"Banco",type:"decorative"},{name:"Bauhaus",type:"decorative"},{name:"Braggadocio",type:"decorative"},{name:"Broadway",type:"decorative"},{name:"Caslon Antique",type:"decorative"},{name:"Cooper Black",type:"decorative"},{name:"Curlz",type:"decorative"},{name:"Ellington",type:"decorative"},{name:"Exocet",type:"decorative"},{name:"FIG Script",type:"decorative"},{name:"Forte",type:"decorative"},{name:"Gabriola",type:"decorative"},{name:"Horizon",type:"decorative"},{name:"Jim Crow",type:"decorative"},{name:"Lo-Type",type:"decorative"},{name:"Neuland",type:"decorative"},{name:"Peignot",type:"decorative"},{name:"San Francisco",type:"decorative"},{name:"Stencil",type:"decorative"},{name:"Umbra",type:"decorative"},{name:"Westminster",type:"decorative"},{name:"Willow",type:"decorative"},{name:"Windsor",type:"decorative"},{name:"Lithos",type:"mimicry"},{name:"Skia",type:"mimicry"},{name:"3x3",type:"misc"},{name:"Compatil",type:"misc"},{name:"Generis",type:"misc"},{name:"Grasset",type:"misc"},{name:"LED",type:"misc"},{name:"Luxi",type:"misc"},{name:"System",type:"misc"}],FontMetric=function(e){var t=_classRecorder,n=t.hasOwnProperty("FontMetric")&&"function"==typeof t.FontMetric?t.FontMetric:t.FontMetric=function FontMetric(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function FontMetric_initialize_(){this.charMap={},this.cachedBoundsInfo={},this.element=null,this.isProportionalCache={}}},{key:"reset",value:function FontMetric_reset_(e){var t,n;this.element&&(n=this.element.parentNode,t=this.element.ownerDocument),this.uninstall(),this.charMap={},this.cachedBoundsInfo={},t&&n&&this.install(t,n,e)}},{key:"install",value:function FontMetric_install_(e,t,n){this.element=e.createElement("div"),this.element.name="fontMetric",this.setMeasureNodeStyles(this.element.style,!0),t.appendChild(this.element),this._domMeasure=(new DOMTextMeasure).install(e,t,n)}},{key:"uninstall",value:function FontMetric_uninstall_(){this.element&&(this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this._domMeasure&&this._domMeasure.uninstall())}},{key:"setMeasureNodeStyles",value:function FontMetric_setMeasureNodeStyles_(e,t){e.width=e.height="auto",e.left=e.top="0px",e.visibility="hidden",e.position="absolute",e.whiteSpace="pre",e.font="inherit",e.overflow=t?"hidden":"visible"}},{key:"measure",value:function FontMetric_measure_(e,t){var n,r,i=e.fontFamily,o=e.fontSize,a=e.fontWeight,s=e.fontStyle,l=e.textDecoration,c=e.textStyleClasses,u=e.transform,h=this.element;u&&(u=u.inverse()),h.textContent=t,Object.assign(h.style,{fontFamily:i,fontWeight:a,fontStyle:s,textDecoration:l,transform:u,fontSize:o+"px"}),h.className=c?c.join(" "):"";try{var d=h.getBoundingClientRect();n=d.width,r=d.height}catch(e){return{width:0,height:0}}return{height:r,width:n}}},{key:"charBoundsFor",value:function FontMetric_charBoundsFor_(e,t){var n=t.length,r=new Array(n),i=this.cachedBoundsInfo,o=i.bounds,a=i.str,s=i.style;if(!this.isProportional(e.fontFamily))for(var l=this.sizeFor(e,"x",!0),c=this.sizeFor(e,"xx",!0).width-l.width,u=l.height,h=0,d=0;d<n;d++)h=c*d,r[d]={x:h,y:0,width:c,height:u};else{for(var p=o&&lively_lang.obj.equals(s,e),f=!e.fixedCharacterSpacing,g=0,m=0;g<n;g++){var v=void 0,y=void 0,_=t[g];if(f)if(p=p&&_===a[g]){var b=o[g];v=b.width,y=b.height}else{var x=t.substr(0,g+1),w=this.measure(e,x);v=w.width,y=w.height,v-=m}else{var k=this.sizeFor(e,_);v=k.width,y=k.height}r[g]={x:m,y:0,width:v,height:y},m+=v}f&&(this.cachedBoundsInfo={bounds:r,str:t,style:e})}return r}},{key:"isProportional",value:function FontMetric_isProportional_(e){if(this.isProportionalCache.hasOwnProperty(e))return this.isProportionalCache[e];var t={fontFamily:e,fontSize:12},n=this.sizeFor(t,"w").width,r=this.sizeFor(t,"i").width;return this.isProportionalCache[e]=n!==r}},{key:"sizeFor",value:function FontMetric_sizeFor_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.fontFamily,i=e.fontSize,o=e.fontWeight,a=e.fontStyle,s=e.textDecoration,l=e.textStyleClasses,c={fontFamily:r,fontSize:i,fontWeight:o,fontStyle:a,textDecoration:s,textStyleClasses:l};if(!n&&t.length>1)return this.measure(c,t);var u=[r,i,o,a,s,l?l.join(" "):""].join("-");return this.charMap[u]||(this.charMap[u]={}),this.charMap[u][t]||(this.charMap[u][t]=this.measure(c,t)),this.charMap[u][t]}},{key:"defaultLineHeight",value:function FontMetric_defaultLineHeight_(e){return this.sizeFor(e," ").height}},{key:"isFontSupported",value:function FontMetric_isFontSupported_(e){return(this.fontDetector||(this.fontDetector=new FontDetector(this.element.ownerDocument))).isFontSupported(e)}},{key:"defaultCharExtent",value:function FontMetric_defaultCharExtent_(e,t,n){return this._domMeasure.defaultCharExtent(e,t,n)}},{key:"manuallyComputeCharBoundsOfLine",value:function FontMetric_manuallyComputeCharBoundsOfLine_(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];var n=arguments[4],r=arguments[5],i=arguments[6];return this._domMeasure.computeCharBBoxes(e,t,0,0,n,r,i,this)}},{key:"manuallyComputeBoundsOfLines",value:function FontMetric_manuallyComputeBoundsOfLines_(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];var n=arguments[4],r=arguments[5],i=arguments[6];return this._domMeasure.computeBBoxesOfLines(e,t,0,0,n,r,i)}}],[{key:"default",value:function FontMetric_default_(){if(!this._fontMetric)throw new Error("FontMetric has not yet been initialized!");return this._fontMetric}},{key:"initDefault",value:function FontMetric_initDefault_(e){if(!this._fontMetric){if(!e&&"undefined"==typeof document)throw new Error("Cannot initialize FontMetric without document");e||(e={document:document}),this._fontMetric=this.forDOMEnv(e)}return this._fontMetric}},{key:"removeDefault",value:function FontMetric_removeDefault_(){this._fontMetric&&(this._fontMetric.uninstall(),this._fontMetric=null)}},{key:"forDOMEnv",value:function FontMetric_forDOMEnv_(e){var t=e.document,n=new FontMetric;return n.install(t,t.body),n}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:290,end:6770})}(void 0);function textlayerNodeForFontMeasure(e){var t=e.viewState,n=t.text_layer_node,r=t.fontmetric_text_layer_node;return n&&(n.className.includes("newtext-text-layer")||(e.viewState.text_layer_node=n=n.parentNode.querySelector(".newtext-text-layer.actual"))),r&&(r.className.includes("newtext-text-layer")||(e.viewState.fontmetric_text_layer_node=r=null)),n&&!r&&n.parentNode&&(r=e.viewState.fontmetric_text_layer_node=n.parentNode.querySelector(".newtext-text-layer.font-measure")),r}var extendingChars=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function isExtendingChar(e){return e.charCodeAt(0)>=768&&extendingChars.test(e)}var DOMTextMeasure=function(e){var t=_classRecorder,n=t.hasOwnProperty("DOMTextMeasure")&&"function"==typeof t.DOMTextMeasure?t.DOMTextMeasure:t.DOMTextMeasure=function DOMTextMeasure(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"reset",value:function DOMTextMeasure_reset_(){var e,t;return this.element&&(t=this.element.parentNode,e=this.element.ownerDocument),this.uninstall(),e&&t&&this.install(e,t),this}},{key:"install",value:function DOMTextMeasure_install_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.debug=n,this.maxLineBBoxCacheCount=n?1:3e3,this.lineBBoxCacheCount=0,this.lineBBoxCache={},this.maxTextlayerNodeCacheCount=n?1:30,this.textlayerNodeCacheCount=0,this.textlayerNodeCache={},this.defaultCharWidthHeightCache={},this.doc=e;var r=this.element=e.createElement("div");return r.className="dom-measure"+(n?" debug":""),this.setMeasureNodeStyles(r.style,!0),t.appendChild(r),this}},{key:"uninstall",value:function DOMTextMeasure_uninstall_(){var e=this.element;e&&(e.parentNode&&e.parentNode.removeChild(e),this.element=null)}},{key:"setMeasureNodeStyles",value:function DOMTextMeasure_setMeasureNodeStyles_(e,t){e.width=e.height="auto",this.debug||(e.left=e.top="0px",e.visibility="hidden"),e.position="absolute",e.whiteSpace="pre",e.font="inherit",e.overflow=t&&!this.debug?"hidden":"visible"}},{key:"generateStyleKey",value:function DOMTextMeasure_generateStyleKey_(e){var t=e.defaultTextStyle;return[t.fontFamily,t.fontSize,t.fontWeight,t.fontStyle,t.textDecoration,t.textStyleClasses,e.paddingLeft,e.paddingRight,e.paddingTop,e.paddingBottom,e.width,e.height,e.clipMode,e.lineWrapping,e.textAlign].join("-")}},{key:"defaultCharExtent",value:function DOMTextMeasure_defaultCharExtent_(e,t,n){var r=this,i=this.generateStyleKey(t),o=this.defaultCharWidthHeightCache[i];if(void 0!==o&&(0!==o.height||0!==o.width))return o;var a=this.doc,s="abcdefghijklmnopqrstufwxyz ABCDEFGHIJKLMNOPQRSTUFWXYZ 1234567890 {}[];,./<>?'\"!@#$%^&*()-=_+";return this.withTextLayerNodeDo(e,n,t,i,function(e){var t=a.createElement("span");t.className="line",t.style.whiteSpace="pre",e.appendChild(t),t.textContent=s;var n=t.getBoundingClientRect().width,o=a.createElement("span");o.className="line",o.style.whiteSpace="pre",e.appendChild(o),o.textContent="H\ne\nll\no";var l=o.getBoundingClientRect().height;return e.removeChild(t),e.removeChild(o),r.defaultCharWidthHeightCache[i]={width:n/s.length,height:Math.ceil(l/4)}})}},{key:"computeBBoxesOfLines",value:function DOMTextMeasure_computeBBoxesOfLines_(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],o=this,a=arguments[5],s=arguments[6],l=this.generateStyleKey(i),c=new Array(t.length),u=!0,h=0;h<t.length;h++){var d=!t[h].textAttributes.length&&this.lineBBoxCache[l+"_"+t[h].text];d&&d.height&&d.width?c[h]=d:u=!1}return u?c:this.withTextLayerNodeDo(e,a,i,l,function(e,i,a){for(var c=new Array(t.length),u=new Array(t.length),h=(o.doc,0);h<t.length;h++)if(!u[h]){var d=s(t[h]);d.style.display="inline-block",e.appendChild(d),c[h]=d}for(var p=0;p<c.length;p++)if(!u[p]){var f=c[p],g=f.getBoundingClientRect(),m=g.left,v=g.top,y=g.width,_=g.height;o.lineBBoxCache[l+"_"+t[p].text]=u[p]={x:m-f.offsetLeft+n-i,y:v-f.offsetTop+r-a,width:y,height:_}}for(var b=0;b<c.length;b++)e.removeChild(c[b]);return u})}},{key:"computeCharBBoxes",value:function DOMTextMeasure_computeCharBBoxes_(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],o=arguments[5],a=this,s=arguments[6],l=arguments[7];return this.withTextLayerNodeDo(e,o,i,this.generateStyleKey(i),function(c,u,h){var d=s(t),p=(c.appendChild(d),a.doc,t.stringSize>1e4&&charBoundsOfBigMonospacedLine(e,l,t,d,n,r,i,o)||charBoundsOfLine(t,d,n-u,r-h));return a.debug||d.parentNode.removeChild(d),p})}},{key:"withTextLayerNodeDo",value:function DOMTextMeasure_withTextLayerNodeDo_(e,t,n,r,i){var o,a,s=this.doc,l=this.textlayerNodeCache,c=this.element,u=textlayerNodeForFontMeasure(e);if(u||(u=l[r]),!u){this.textlayerNodeCacheCount++,(u=l[r]=t(n,[])).id=r;var h=n.width,d=n.clipMode;if(n.width||n.clipMode&&"visible"!==n.clipMode){var p=s.createElement("div");p.style.position="absolute",d&&(p.style.overflow=d),h&&(p.style.width=h+"px"),p.id=r,p.appendChild(u),c.appendChild(p)}else c.appendChild(u)}var f=e.getGlobalTransform().inverse();e.env.renderer&&e.env.renderer.getNodeForMorph(e)&&(1!=f.getScale()||0!=f.getRotation())&&(f.e=f.f=0,u.style.transform=f.toString());var g=u.getBoundingClientRect();o=g.left,a=g.top;try{return i(u,o,a)}finally{if(u.style.transform="",!this.debug&&this.textlayerNodeCacheCount>this.maxTextlayerNodeCacheCount){for(var m=Math.ceil(this.maxTextlayerNodeCacheCount/2),v=void 0;m--&&(v=c.childNodes[0]);)l[v.id]=null,c.removeChild(v);this.textlayerNodeCacheCount=this.textlayerNodeCacheCount-m}}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:10424,end:18786})}(void 0),GLOBAL="undefined"!=typeof System?System.global:window||global||self||void 0,getComputedFontFamily="function"==typeof GLOBAL.getComputedStyle?function(e){return GLOBAL.getComputedStyle(e).fontFamily}:function(){return""},getComputedMarginLeft="function"==typeof GLOBAL.getComputedStyle?function(e){return parseInt(GLOBAL.getComputedStyle(e).marginLeft)||0}:function(){return 0};function charBoundsOfBigMonospacedLine(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments[6],s=arguments[7],l=n.text.length;if(l<500||t.isProportional(getComputedFontFamily(r)))return null;var c=1/0,u=a.defaultTextStyle;if(a.lineWrapping){var h=r.getBoundingClientRect();c=h.width,h.height}for(var d=t._domMeasure.defaultCharExtent(e,{defaultTextStyle:u},s),p=d.width,f=d.height,g=i,m=o,v=new Array(l),y=0;y<l;y++)g+p>c&&(g=0,m+=f),v[y]={x:g,y:m,width:p,height:f},g+=p;return v}function charBoundsOfLine(e,t){var n,r,i,o,a,s,l,c,u,h=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,p=t.ELEMENT_NODE,f=t.TEXT_NODE,g=(t.childNodes,t.ownerDocument),m=[],v=0;if(t)if(t.className.includes("line"))h-=t.offsetLeft,d-=t.offsetTop,u=t.childNodes[0];else{u=t.getElementsByClassName("line")[0].childNodes[0];h=h-t.offsetLeft+getComputedMarginLeft(t),d-=t.offsetTop}else u=null;for(u||(c=u=g.createElement("br"),t.appendChild(c));u&&!(v>1/0);){if((n="BR"!==u.tagName&&u.nodeType===p&&u.childNodes[0]||u).nodeType===f)for(var y=n.length,_=0;_<y;_++){var b=measureCharInner(g,n,_,"right");r=b.left,i=b.top,o=b.width,a=b.height,s=r+h,l=i+d,m[v++]={x:s,y:l,width:o,height:a}}else{if(u.nodeType!==p)throw new Error("Cannot deal with node "+u);var x=u.getBoundingClientRect();r=x.left,i=x.top,o=x.width,a=x.height,s=r+h,l=i+d,m[v++]={x:s,y:l,width:o,height:a}}u=u.nextSibling}return c&&c.parentNode.removeChild(c),m}function measureCharInner(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"left",i=void 0,o=n,a=n+1;if(3==t.nodeType)for(var s=0;s<4&&(!(i=getUsefulRect(range(e,t,o,a).getClientRects(),r)).left&&!i.right&&0!=o);s++)a=o,o-=1;return i}function range(e,t,n,r,i){var o=e.createRange();return o.setEnd(i||t,r),o.setStart(t,n),o}function getUsefulRect(e,t){var n={left:0,right:0,top:0,bottom:0};if("left"==t)for(var r=0;r<e.length&&(n=e[r]).left==n.right;r++);else for(var i=e.length-1;i>=0&&(n=e[i]).left==n.right;i--);return n}function signalBindings(e,t,n){var r=e.attributeConnections;if(r){r=r.slice();for(var i=0;i<r.length;i++)r[i].sourceAttrName===t&&r[i].update(n)}}function informMorph(e,t,n){try{n.onChange(t),signalBindings(n,"change",t);for(var r=n.owner;r;)r.onSubmorphChange(t,n),r=r.owner}catch(e){console.error("Error in informMorph: "+e.stack)}}var Change=function(e){var t=_classRecorder,n=t.hasOwnProperty("Change")&&"function"==typeof t.Change?t.Change:t.Change=function Change(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Change_initialize_(e){this.target=e,this.group=null}},{key:"type",get:function get(){return"abstract change"}},{key:"apply",value:function Change_apply_(){throw new Error("Not yet implemented")}},{key:"reverseApply",value:function Change_reverseApply_(){throw new Error("Not yet implemented")}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:766,end:1016})}(void 0),GroupChange=function(e){var t=_classRecorder,n=t.hasOwnProperty("GroupChange")&&"function"==typeof t.GroupChange?t.GroupChange:t.GroupChange=function GroupChange(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function GroupChange_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.changes=[]}},{key:"consumesChanges",value:function GroupChange_consumesChanges_(){return!0}},{key:"addChange",value:function GroupChange_addChange_(e){this.changes.push(e),e.group=this}},{key:"apply",value:function GroupChange_apply_(){return this.changes.slice().forEach(function(e){return e.apply()}),this}},{key:"reverseApply",value:function GroupChange_reverseApply_(){return this.changes.slice().reverse().forEach(function(e){return e.reverseApply()}),this}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1025,end:1448})}({referencedAs:"Change",value:Change}),ValueChange=function(e){var t=_classRecorder,n=t.hasOwnProperty("ValueChange")&&"function"==typeof t.ValueChange?t.ValueChange:t.ValueChange=function ValueChange(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"type",get:function get(){return"setter"}},{key:Symbol.for("lively-instance-initialize"),value:function ValueChange_initialize_(e,t,r,i){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.prop=t,this.value=r,this.prevValue=null,this.meta=i}},{key:"apply",value:function ValueChange_apply_(){var e=this.target,t=this.prop,n=this.value;e[t]=n}},{key:"reverseApply",value:function ValueChange_reverseApply_(){var e=this.target,t=this.prop,n=this.prevValue;e[t]=n}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1457,end:1866})}({referencedAs:"Change",value:Change}),MethodCallChange=function(e){var t=_classRecorder,n=t.hasOwnProperty("MethodCallChange")&&"function"==typeof t.MethodCallChange?t.MethodCallChange:t.MethodCallChange=function MethodCallChange(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"type",get:function get(){return"method-call"}},{key:Symbol.for("lively-instance-initialize"),value:function MethodCallChange_initialize_(e,t,r,i,o){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.selector=t,this.args=r,this.undo=i,this.meta=o}},{key:"apply",value:function MethodCallChange_apply_(){var e=this.target,t=this.selector,n=this.args;e[t].apply(e,n)}},{key:"reverseApply",value:function MethodCallChange_reverseApply_(){if(this.undo)if("function"==typeof this.undo)this.undo();else{var e=this.undo,t=e.target,n=e.selector,r=e.args;t[n].apply(t,r)}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1875,end:2448})}({referencedAs:"GroupChange",value:GroupChange}),ChangeManager=function(e){var t=_classRecorder,n=t.hasOwnProperty("ChangeManager")&&"function"==typeof t.ChangeManager?t.ChangeManager:t.ChangeManager=function ChangeManager(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function ChangeManager_initialize_(){this.reset()}},{key:"reset",value:function ChangeManager_reset_(){this.changes=[],this.changeRecordedListeners=[],this.revision=0,this.changeRecordersPerMorph=new WeakMap,this.changeRecorders={},this.changeGroupStack=[],this.defaultMeta={},this.metaStack=[]}},{key:"changesFor",value:function ChangeManager_changesFor_(e){return this.changes.filter(function(t){return t.target===e})}},{key:"apply",value:function ChangeManager_apply_(e,t){t.apply()}},{key:"doWithValueChangeMeta",value:function ChangeManager_doWithValueChangeMeta_(e,t,n){this.defaultMeta=e,this.metaStack.push(e);var r=n(t);return this.metaStack.pop(),this.defaultMeta=lively_lang.arr.last(this.metaStack)||{},r}},{key:"addValueChange",value:function ChangeManager_addValueChange_(e,t,n,r){var i=new ValueChange(e,t,n,Object.assign({},this.defaultMeta,{},r));return this._record(e,i)}},{key:"addMethodCallChangeDoing",value:function ChangeManager_addMethodCallChangeDoing_(e,t,n){var r=e.target,i=e.selector,o=e.args,a=e.undo;a||(a=function undo(){return console.warn("No undo recorded for "+r+"."+i)});var s=new MethodCallChange(r,i,o,a,this.defaultMeta);return t.groupChangesWhile(s,n),s}},{key:"_record",value:function ChangeManager__record_(e,t){lively_bindings.signal(this,"changeRecorded",t),t.hasOwnProperty("value")&&(t.prevValue=e._morphicState[t.prop],e._morphicState[t.prop]=t.value),e.makeDirty();var n=lively_lang.arr.last(this.changeGroupStack);return n&&n.consumesChanges()?n.addChange(t):(this.changes.push(t),e._rev=++this.revision,this.informChangeListeners(t)),informMorph(this,t,e),t}},{key:"groupChangesWhile",value:function ChangeManager_groupChangesWhile_(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];t||(t=new GroupChange(e)),this.changeGroupStack.push(t);try{return n(),lively_lang.arr.remove(this.changeGroupStack,t),r?this._record(e,t):t}catch(e){throw lively_lang.arr.remove(this.changeGroupStack,t),e}}},{key:"dontRecordChangesWhile",value:function ChangeManager_dontRecordChangesWhile_(e,t){return this.groupChangesWhile(e,void 0,t,!1)}},{key:"recordChangesWhile",value:function ChangeManager_recordChangesWhile_(e,t){var n=this.changes.length;e();var r=this.changes.slice(n,this.changes.length);return t?r.filter(t):r}},{key:"addChangeListener",value:function ChangeManager_addChangeListener_(e){lively_lang.arr.pushIfNotIncluded(this.changeRecordedListeners,e)}},{key:"removeChangeListener",value:function ChangeManager_removeChangeListener_(e){lively_lang.arr.remove(this.changeRecordedListeners,e)}},{key:"informChangeListeners",value:function ChangeManager_informChangeListeners_(e){this.changeRecordedListeners.forEach(function(t){return t(e)})}},{key:"recordChangesStart",value:function ChangeManager_recordChangesStart_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=lively_lang.obj.newKeyIn(this.changeRecorders,t+"__change_recorder_"+Date.now()),r=e?function(t){return e(t)&&i.changes.push(t)}:function(e){return i.changes.push(e)},i=this.changeRecorders[n]={id:n,filter:e,changes:[],listener:r};return this.addChangeListener(r),i}},{key:"recordChangesStop",value:function ChangeManager_recordChangesStop_(e){if(!(e in this.changeRecorders))return[];var t=this.changeRecorders[e],n=t.changes,r=t.listener;return delete this.changeRecorders[e],this.removeChangeListener(r),n}},{key:"recordChangesStartForMorph",value:function ChangeManager_recordChangesStartForMorph_(e,t){var n=this.recordChangesStart(t,e.id),r=this.changeRecordersPerMorph.get(e);return r||(r=[],this.changeRecordersPerMorph.set(e,r)),r.push(n.id),n}},{key:"recordChangesStopForMorph",value:function ChangeManager_recordChangesStopForMorph_(e,t){var n=this.changeRecordersPerMorph.get(e);if(!n||!n.length)return console.warn("Cannot endMorphChangeRecorder for morph "+e+": recorder not found"),[];var r=t;return t?lively_lang.arr.remove(n,r):r=n.pop(),this.recordChangesStop(r)}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2458,end:7498})}(void 0),Undo=function(e){var t=_classRecorder,n=t.hasOwnProperty("Undo")&&"function"==typeof t.Undo?t.Undo:t.Undo=function Undo(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Undo_initialize_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.name=e,this.targets=t,this.recorder=null,this.changes=null,this.timestamp=null,this.no=n}},{key:"recorded",value:function Undo_recorded_(){return!!this.changes}},{key:"isRecording",value:function Undo_isRecording_(){return!!this.recorder}},{key:"startRecording",value:function Undo_startRecording_(e){var t=this;if(this.recorded()||this.isRecording())throw new Error("Undo already recorded / recording");if(!this.targets.length)throw new Error("Undo has no target morphs");this.timestamp=Date.now();var n=this.targets[0];return this.recorder=n.recordChangesStart(function(n){var r=n.target;return!r.isUsedAsEpiMorph()&&(!!t.targets.some(function(e){return e===r||e.isAncestorOf(r)})&&("function"!=typeof e||e(n)))}),this}},{key:"stopRecording",value:function Undo_stopRecording_(){this.name;var e=this.recorder,t=e.id,n=(e.changes,slicedToArray(this.targets,1)[0]);this.changes=n.recordChangesStop(t),this.targets=null,this.recorder=null}},{key:"apply",value:function Undo_apply_(){if(!this.recorded())throw new Error("Cannot apply undo that has no changes recorded yet");return this.changes.slice().forEach(function(e){return e.apply()}),this}},{key:"reverseApply",value:function Undo_reverseApply_(){if(!this.recorded())throw new Error("Cannot reverseApply undo that has no changes recorded yet");return this.changes.slice().reverse().forEach(function(e){return e.reverseApply()}),this}},{key:"addTarget",value:function Undo_addTarget_(e){lively_lang.arr.pushIfNotIncluded(this.targets,e)}},{key:"addUndos",value:function Undo_addUndos_(e){(e=lively_lang.arr.sortBy(e.concat(this).filter(function(e){return e.recorded()}),function(e){return e.no})).length&&(this.changes=lively_lang.arr.flatmap(e,function(e){return e.changes}),this.timestamp=e[0].timestamp,this.no=e[0].no,this.name=e.map(function(e){return e.name}).join("-"))}},{key:"toString",value:function Undo_toString_(){var e=this.name,t=this.changes,n=this.no,r=this.isRecording(),i=t.length?"\n  "+t.map(function(e){var t=e.selector,n=e.args,r=e.prop,i=e.value,o=e.target;return t?o+"."+t+"("+n.map(printArg)+")":o+"."+r+" = "+printArg(i)}).join("\n  "):"no changes";return"Undo("+n+":"+e+" "+(r?"RECORDING ":"")+i+")"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:54,end:2487})}(void 0);function printArg(e){return lively_lang.obj.inspect(e,{maxDepth:1}).replace(/\n/g,"").replace(/\s+/g," ")}var UndoManager=function(e){var t=_classRecorder,n=t.hasOwnProperty("UndoManager")&&"function"==typeof t.UndoManager?t.UndoManager:t.UndoManager=function UndoManager(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function UndoManager_initialize_(e){this.reset(),this.filter=e}},{key:"reset",value:function UndoManager_reset_(){this.undos=[],this.redos=[],this.undoInProgress=null,this.applyCount=0,this.counter=0,this.grouping={current:[],debounce:null,debouncedCanceled:!1,debounceTime:31}}},{key:"group",value:function UndoManager_group_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.groupLaterCancel(),e&&this.undos.includes(e)&&(this.grouping.current=lively_lang.arr.uniq(this.undos.slice(this.undos.indexOf(e)).concat(this.grouping.current))),this.grouping.current.length){var t=this.grouping.current.slice(1);this.grouping.current[0].addUndos(t),this.undos=lively_lang.arr.withoutAll(this.undos,t),this.grouping.current=[]}}},{key:"ensureNewGroup",value:function UndoManager_ensureNewGroup_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"new undo group";return this.group(),this.undoStart(e,t),this.undoStop()}},{key:"groupLaterCancel",value:function UndoManager_groupLaterCancel_(){var e=this.grouping;e.debounce&&(e.debouncedCanceled=!0,this.grouping=Object.assign({},e,{debounce:null,debouncedCanceled:!1}))}},{key:"groupLater",value:function UndoManager_groupLater_(e){var t=this,n=this.grouping;(n.debounce||(n.debounce=lively_lang.fun.debounce(e||n.debounceTime,function(){n.debounce=null,n.debouncedCanceled||t.group()})))()}},{key:"undoStart",value:function UndoManager_undoStart_(e,t){if(!this.applyCount){if(!this.undoInProgress)return this.undoInProgress=new Undo(t,[e],this.counter++).startRecording(this.filter);console.warn("There is already an undo recorded")}}},{key:"undoStop",value:function UndoManager_undoStop_(){var e=this.undoInProgress;return e?(e.stopRecording(),this.undoInProgress=null,this.undos.push(e),this.grouping.current.push(e),this.redos.length&&(this.redos.length=0),e):null}},{key:"undo",value:function UndoManager_undo_(){this.undoStop();var e=this.undos.pop();if(e){lively_lang.arr.remove(this.grouping.current,e),this.redos.unshift(e),this.applyCount++;try{e.reverseApply()}finally{this.applyCount--}return e}}},{key:"redo",value:function UndoManager_redo_(){this.undoStop();var e=this.redos.shift();if(e){this.undos.push(e),this.applyCount++;try{e.apply()}finally{this.applyCount--}return e}}},{key:"toString",value:function UndoManager_toString_(){var e=0===this.undos.length?"":"\n  "+(this.undos.length>20?"...\n  ":"")+this.undos.slice(-20).join("\n  "),t=!!this.undoInProgress;return"UndoManager("+this.undos.length+" undos, "+this.redos.length+" redos, "+(t?", UNDO IN PROGRESS":"")+e+")"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2619,end:5662})}(void 0),placeholderValue="",placeholderRe=new RegExp("","g"),TextInput=function(e){var t=_classRecorder,n=t.hasOwnProperty("TextInput")&&"function"==typeof t.TextInput?t.TextInput:t.TextInput=function TextInput(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TextInput_initialize_(e){this.eventDispatcher=e,this.domState={rootNode:null,textareaNode:null,eventHandlers:[],isInstalled:!1},this.inputState={composition:null,manualCopy:null,manualPaste:null,positionChangedTime:0,scrollLeftWhenChanged:0,scrollTopWhenChanged:0}}},{key:"install",value:function TextInput_install_(e){var t=this,n=this.domState,r=n.isInstalled,i=n.rootNode;if(r){if(i===e)return;this.uninstall()}n.isInstalled=!0,n.rootNode=e,e.tabIndex=1;var o=e.ownerDocument,a=n.textareaNode=o.createElement("textarea");return a.setAttribute("style","\n      position: absolute;\n      /*extent cannot be 0, input won't work correctly in Chrome 52.0*/\n      width: 20px; height: 20px;\n      z-index: 0;\n      opacity: 1;\n      background: transparent;\n      -moz-appearance: none;\n      appearance: none;\n      border: none;\n      resize: none;\n      outline: none;\n      overflow: hidden;\n      font: inherit;\n      padding: 0 1px;\n      margin: 0 -1px;\n      text-indent: -1em;\n      -ms-user-select: text;\n      -moz-user-select: text;\n      -webkit-user-select: text;\n      user-select: text;\n      /*with pre-line chrome inserts &nbsp; instead of space*/\n      white-space: pre!important;"),(bowser.tablet||bowser.mobile)&&a.setAttribute("x-palm-disable-auto-cap",!0),a.setAttribute("wrap","off"),a.setAttribute("autocorrect","off"),a.setAttribute("autocapitalize","off"),a.setAttribute("spellcheck",!1),a.className="lively-text-input",a.value="",e.insertBefore(a,e.firstChild),(bowser.tablet||bowser.mobile)&&(a.setAttribute("disabled",!0),a.style.setProperty("transform","scale(0)")),n.eventHandlers=[{type:"focusin",node:e,fn:function fn(e){return t.onRootNodeFocus(e)},capturing:!0},{type:"focusin",node:n.textareaNode,fn:function fn(e){return t.onTextAreaFocus(e)},capturing:!0},{type:"blur",node:n.textareaNode,fn:function fn(e){return t.onTextAreaBlur(e)},capturing:!0},{type:"keydown",node:n.textareaNode,fn:function fn(e){return t.eventDispatcher.dispatchDOMEvent(e)},capturing:!1},{type:"keyup",node:n.textareaNode,fn:function fn(e){return t.eventDispatcher.dispatchDOMEvent(e)},capturing:!1},{type:"cut",node:n.textareaNode,fn:function fn(e){return t.eventDispatcher.dispatchDOMEvent(e)},capturing:!1},{type:"copy",node:n.textareaNode,fn:function fn(e){return t.inputState.manualCopy?t.inputState.manualCopy.onEvent(e):t.eventDispatcher.dispatchDOMEvent(e)},capturing:!1},{type:"paste",node:n.textareaNode,fn:function fn(e){return t.inputState.manualPaste?t.inputState.manualPaste.onEvent(e):t.eventDispatcher.dispatchDOMEvent(e)},capturing:!1},{type:"compositionstart",node:n.textareaNode,fn:function fn(e){return t.onCompositionStart(e)},capturing:!1},{type:"compositionend",node:n.textareaNode,fn:function fn(e){return t.onCompositionEnd(e)},capturing:!1},{type:"compositionupdate",node:n.textareaNode,fn:function fn(e){return t.onCompositionUpdate(e)},capturing:!1},{type:"input",node:n.textareaNode,fn:function fn(e){return t.onInput(e)},capturing:!1}],n.eventHandlers.forEach(function(e){var t=e.type,n=e.node,r=e.fn,i=e.capturing;return n.addEventListener(t,r,i)}),this}},{key:"uninstall",value:function TextInput_uninstall_(){var e=this.domState;e.isInstalled=!1,e.eventHandlers.forEach(function(e){var t=e.node,n=e.type,r=e.fn,i=e.capturing;return t.removeEventListener(n,r,i)});var t=e.textareaNode;return t&&t.parentNode&&t.parentNode.removeChild(t),e.rootNode=null,this}},{key:"resetValue",value:function TextInput_resetValue_(){var e=this.domState.textareaNode;e&&(e.value=placeholderValue)}},{key:"readValue",value:function TextInput_readValue_(){var e=this.domState.textareaNode;return e?e.value.replace(placeholderRe,""):""}},{key:"focus",value:function TextInput_focus_(e,t){var n=this.domState.textareaNode;n&&((bowser.tablet||bowser.mobile)&&(e&&e.isText&&!e.readOnly?n.removeAttribute("disabled"):e&&!e.isText&&n.setAttribute("disabled",!0)),n.ownerDocument.activeElement!==n&&n.focus(),bowser.firefox&&Promise.resolve().then(function(){return n.ownerDocument.activeElement!==n&&n.focus()}),e&&e.isText&&e.focusable?(n.focus(),this.ensureBeingAtCursorOfText(e)):t&&this.ensureBeingInVisibleBoundsOfWorld(t))}},{key:"blur",value:function TextInput_blur_(){var e=this.domState.textareaNode;(bowser.tablet||bowser.mobile)&&e.setAttribute("disabled",!0),e&&e.blur()}},{key:"doCopyWithMimeTypes",value:function TextInput_doCopyWithMimeTypes_(e){var t=this;return this.execCommand("manualCopy",function(){var n=t.domState.textareaNode,r=function h$$1(t){n.removeEventListener("copy",h$$1),t.preventDefault(),e.forEach(function(e){var n=e.data,r=e.type;return t.clipboardData.setData(r,n)})};setTimeout(function(){return n.removeEventListener("copy",r)},300),n.addEventListener("copy",r),n.value="",n.select(),n.ownerDocument.execCommand("copy")})}},{key:"doCopy",value:function TextInput_doCopy_(e){var t=this;return this.execCommand("manualCopy",function(){var n=t.domState.textareaNode;n.value=e,n.select(),n.ownerDocument.execCommand("copy")})}},{key:"doPaste",value:function TextInput_doPaste_(){var e=this;return this.execCommand("manualPaste",function(){var t=e.domState.textareaNode;t.value="",t.select(),t.ownerDocument.execCommand("paste")})}},{key:"execCommand",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t){var n,r,i;return regeneratorRuntime.wrap(function _callee$(o){for(;;)switch(o.prev=o.next){case 0:if(this.domState.isInstalled){o.next=2;break}throw new Error("Cannot copy to clipboard  input helper is not installed into DOM!");case 2:if(!(n=this.inputState)[e]){o.next=11;break}return o.prev=4,o.next=7,n[e].promise;case 7:o.next=11;break;case 9:o.prev=9,o.t0=o.catch(4);case 11:return r=lively_lang.promise.deferred(),i=!1,n[e]={onEvent:function onEvent(t){i||(n[e]=null,i=!0,r.resolve(t))},promise:r.promise},t(),o.prev=14,o.next=17,lively_lang.promise.waitFor(1e3,function(){return i});case 17:o.next=24;break;case 19:o.prev=19,o.t1=o.catch(14),n[e]=null,i=!0,r.reject(o.t1);case 24:return o.abrupt("return",r.promise);case 25:case"end":return o.stop()}},_callee,this,[[4,9],[14,19]])}));return function TextInput_execCommand_(t,n){return e.apply(this,arguments)}}()},{key:"onTextAreaBlur",value:function TextInput_onTextAreaBlur_(e){var t=this;setTimeout(function(){var e=t.domState||{},n=e.textareaNode,r=e.rootNode;r&&document.activeElement===r&&!bowser.mobile&&!bowser.tablet&&n&&n.focus()})}},{key:"onTextAreaFocus",value:function TextInput_onTextAreaFocus_(e){}},{key:"onRootNodeFocus",value:function TextInput_onRootNodeFocus_(e){var t=this.domState||{},n=t.textareaNode,r=t.rootNode;e.target!==n&&e.target!==r||this.focus(),this.inputState.composition=null}},{key:"onInput",value:function TextInput_onInput_(e){var t,n=this;this.inputState.composition||(e.data||(t=n.readValue(),e.__defineGetter__("data",function(){return t})),this.resetValue(),this.eventDispatcher.dispatchDOMEvent(e))}},{key:"onCompositionStart",value:function TextInput_onCompositionStart_(e){this.inputState.composition={},this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onCompositionUpdate",value:function TextInput_onCompositionUpdate_(e){var t=this.inputState.composition,n=this.readValue();t.lastValue!==n&&(t.lastValue=n,this.eventDispatcher.dispatchDOMEvent(e))}},{key:"onCompositionEnd",value:function TextInput_onCompositionEnd_(e){this.inputState.composition=null,this.eventDispatcher.dispatchDOMEvent(e)}},{key:"setPosition",value:function TextInput_setPosition_(e){var t=(this.domState||{}).textareaNode;t&&(t.style.left=e.x+"px",t.style.top=e.y+"px")}},{key:"ensureBeingInVisibleBoundsOfWorld",value:function TextInput_ensureBeingInVisibleBoundsOfWorld_(e){this.setPosition(e.visibleBounds().center())}},{key:"ensureBeingAtCursorOfText",value:function TextInput_ensureBeingAtCursorOfText_(e){var t=e.world();if(t){var n=e.whatsVisible,r=n.startRow,i=n.endRow,o=e.cursorPosition,a=o.row,s=o.column;a=Math.max(r,Math.min(a,i));var l=e.charBoundsFromTextPosition({row:a,column:s}).topLeft(),c=t.visibleBounds().insetBy(10).constrainPt(e.worldPoint(l.subPt(e.scroll)));this.inputState.positionChangedTime=Date.now(),this.inputState.scrollLeftWhenChanged=document.documentElement.scrollLeft,this.inputState.scrollTopWhenChanged=document.documentElement.scrollTop,this.setPosition(c)}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:185,end:11714})}(void 0),KillRing=function(e){var t=_classRecorder,n=t.hasOwnProperty("KillRing")&&"function"==typeof t.KillRing?t.KillRing:t.KillRing=function KillRing(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function KillRing_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.size=e,this.buffer=[],this.pointer=-1}},{key:"isCycling",value:function KillRing_isCycling_(){return this.pointer!==this.buffer.length-1}},{key:"add",value:function KillRing_add_(e){var t=this.buffer;return t.push(e),this.size&&t.length>this.size&&t.splice(0,t.length-this.size),this.pointer=this.buffer.length-1,e}},{key:"yank",value:function KillRing_yank_(){return this.buffer[this.pointer]||""}},{key:"back",value:function KillRing_back_(){return this.pointer=(this.pointer<=0?this.buffer.length:this.pointer)-1,this.yank()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:51,end:614})}(void 0),letterRe=/[a-z]/i;function computeHashIdOfEvent(e){var t=e.key,n=e.ctrlKey,r=e.altKey,i=e.shiftKey,o=e.metaKey,a=0|(n?1:0)|(r?2:0)|(i?4:0)|(o?8:0);return 0===a&&!canonicalizeFunctionKey(t)&&t&&letterRe.test(t)&&(a=-1),a}var KEY_MODS=function(){for(var e={control:1,ctrl:1,alt:2,option:2,shift:4,super:8,win:8,meta:8,command:8,cmd:8},t=["alt","ctrl","meta","shift"],n=Math.pow(2,t.length);n--;)e[n]=t.filter(function(t){return n&e[t]}).join("-")+"-";return e[0]="",e[-1]="input-",e}(),isNumber=(numberRe=/^[0-9]+$/,function(e){return numberRe.test(e)}),numberRe;function isModifier(e){return!isNumber(e)&&(e=e.replace(/-$/,"").toLowerCase(),lively_lang.arr.withoutAll(Object.keys(KEY_MODS),["","input-"]).includes(e))}var FUNCTION_KEYS=["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"];function canonicalizeFunctionKey(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down";break;case"esc":e="escape";break;case"return":e="enter"}return FUNCTION_KEYS.includes(e)?lively_lang.string.capitalize(e):""}function decodeKeyIdentifier(e,t){var n=e&&e.replace(/u\+?([\d\w]{4})/gi,function unicodeReplacer(e,t){return String.fromCharCode(parseInt(t,16))});return"Command"!==n&&"Cmd"!==n||(n="Meta")," "===n&&(n="Space"),8===t&&(n="Backspace"),n}function identifyKeyFromCode(e){var t=e.code;if("string"!=typeof t)return null;if(t.startsWith("Key"))return t.slice(3);if(t.startsWith("Numpad"))return t;if(t.startsWith("Digit"))return t.slice(5);if(t.startsWith("Arrow"))return t.slice(5);if(t.match(/^F[0-9]{1-2}$/))return t;switch(t){case"Insert":case"Home":case"PageUp":case"PageDown":return t;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Equal":return"=";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";"}return null}function dedasherize(e){for(var t=[];;){var n=e.indexOf("-");if(-1===n)return e&&t.push(e),t;0===n?(t.push(e[0]),e=e.slice(2)):(t.push(e.slice(0,n)),e=e.slice(n+1))}}var Keys={computeHashIdOfEvent:computeHashIdOfEvent,keyComboToEventSpec:function keyComboToEventSpec(e,t){var n=Object.assign({_isLivelyKeyEventSpec:!0,keyCombo:"",key:"",ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1},t),r=dedasherize(e),i={shift:"shiftKey",control:"ctrlKey",ctrl:"ctrlKey",alt:"altKey",meta:"metaKey",command:"metaKey",cmd:"metaKey"};if("input"===r[0]&&2===r.length)return n.keyCombo=e,n.key=r[1],n;for(var o=r.length-1;o>=0;o--){var a=i[r[o].toLowerCase()];a&&(r.splice(o,1),n.isModified=!0,n[a]=!0)}if(!r.length)return n.keyCombo=Keys.eventToKeyCombo(n),n.key=lively_lang.arr.last(dedasherize(n.keyCombo)),n.onlyModifiers=!0,n;r.length>1&&console.warn('Strange key "'+e+'" encountered in keyComboToEventSpec, parsing probably failed');var s=lively_lang.arr.last(r),l=canonicalizeFunctionKey(s);return l?(n.isFunctionKey=!0,n.key=l):n.isModified?n.key=lively_lang.string.capitalize(s):n.key=s,n.keyCombo=Keys.eventToKeyCombo(n),n},eventToKeyCombo:function eventToKeyCombo(e,t){var n=Object.assign({ignoreModifiersIfNoCombo:!1,ignoreKeys:[]},t),r=(n.ignoreModifiersIfNoCombo,n.ignoreKeys,e.key),i=e.data,o=e.keyIdentifier;if("string"==typeof i)return"input-"+i;if(!r&&o&&(r=decodeKeyIdentifier(o,e.which||e.keyCode),e.key=r=r[e.shiftKey?"toUpperCase":"toLowerCase"](),isModifier(r)))return lively_lang.string.capitalize(r);var a=KEY_MODS[computeHashIdOfEvent(e)];if("input-"===a)return a+r;e.code&&(r=identifyKeyFromCode(e)||r);var s=!r||isModifier(r)?a.replace(/-$/,""):a+r;return s.match(/\s$/)&&(s=s.replace(/\s$/,"Space")),s.replace(/(^|-)([a-z])/g,function(e,t,n){return t+n.toUpperCase()})},canonicalizeKeyCombo:function canonicalizeKeyCombo(e){return Keys.eventToKeyCombo(Keys.keyComboToEventSpec(e))},canonicalizeEvent:function canonicalizeEvent(e){return e._isLivelyKeyEventSpec?e:Keys.keyComboToEventSpec(Keys.eventToKeyCombo(e))}},pointerEvents=["pointerover","pointerenter","pointerout","pointerleave","pointerdown","pointermove","pointerup","pointercancel","gotpointercapture","lostpointercapture"],mouseEvents=["mouseover","mouseenter","mousedown","mousemove","mouseup","mouseout","mouseleave","click","dblclick","contextmenu","mousewheel"],keyboardEvents=["keydown","keyup","keypress"],keyLikeEvents=keyboardEvents.concat("input","compositionstart","compositionupdate","compositionend"),Event=function(e){var t=_classRecorder,n=t.hasOwnProperty("Event")&&"function"==typeof t.Event?t.Event:t.Event=function Event(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Event_initialize_(e,t,n,r,i,o,a){this.type=e,this.domEvt=t,this.dispatcher=n,this.targetMorphs=r,this.hand=i,this.halo=o,this.layoutHalo=a,this.stopped=!1,this._keyCombo=void 0,this.onDispatchCallbacks=[],this.onAfterDispatchCallbacks=[],this.onStopCallbacks=[]}},{key:"onDispatch",value:function Event_onDispatch_(e){return this.onDispatchCallbacks.push(e),this}},{key:"onAfterDispatch",value:function Event_onAfterDispatch_(e){return this.onAfterDispatchCallbacks.push(e),this}},{key:"onStop",value:function Event_onStop_(e){return this.onStopCallbacks.push(e),this}},{key:"data",get:function get(){return this.domEvt.data}},{key:"world",get:function get(){return this.dispatcher.world}},{key:"state",get:function get(){return this.dispatcher.eventState}},{key:"keyInputState",get:function get(){return this.state.keyInputState}},{key:"isMouseEvent",value:function Event_isMouseEvent_(){return pointerEvents.includes(this.type)||mouseEvents.includes(this.type)}},{key:"isKeyboardEvent",value:function Event_isKeyboardEvent_(){return!this.isMouseEvent()&&keyboardEvents.includes(this.type)}},{key:"stop",value:function Event_stop_(){this.stopped=!0,this.domEvt&&"function"==typeof this.domEvt.stopPropagation&&this.domEvt.stopPropagation(),this.domEvt&&"function"==typeof this.domEvt.preventDefault&&this.domEvt.preventDefault(),this.onStopCallbacks.forEach(function(e){return e()})}},{key:"targetMorph",get:function get(){return this.targetMorphs[0]}},{key:"timestamp",get:function get(){return this.domEvt.timeStamp}},{key:"position",get:function get(){if(!this.domEvt)return lively_graphics.pt(0,0);for(var e=this.domEvt.target;e&&e.id!==this.world.id;)e=e.parentNode;if(!e){var t=this.domEvt.target;e=(t.nodeType===t.DOCUMENT_NODE?t:t.ownerDocument).getElementById(this.world.id)}if(!e)return console.error("event position: cannot find world node for determining the position!"),lively_graphics.pt(0,0);var n=cumulativeOffset(e),r=n.left,i=n.top,o=this.domEvt,a=o.pageX,s=o.pageY,l=lively_graphics.pt((a||0)-r,(s||0)-i);return 1!==this.world.scale&&(l=l.scaleBy(1/this.world.scale)),l}},{key:"startPosition",get:function get(){return this.state.clickedOnPosition}},{key:"pressure",get:function get(){return this.domEvt?this.domEvt.pressure:.5}},{key:"positionIn",value:function Event_positionIn_(e){return e.localize(this.position)}},{key:"isClickTarget",value:function Event_isClickTarget_(e){var t=this.state.clickedOnMorph;return t&&(e===t||e.isAncestorOf(t))}},{key:"leftMouseButtonPressed",value:function Event_leftMouseButtonPressed_(){return!!this.domEvt&&1&(this.domEvt.buttons||0)}},{key:"rightMouseButtonPressed",value:function Event_rightMouseButtonPressed_(){return bowser.firefox,3===this.domEvt.which||2===this.domEvt.buttons}},{key:"middleMouseButtonPressed",value:function Event_middleMouseButtonPressed_(){return!!this.domEvt&&4&(this.domEvt.buttons||0)}},{key:"isCommandKey",value:function Event_isCommandKey_(){var e=this.domEvt;if(!e)return!1;var t=!1;return bowser.mac||(t=t||e.ctrlKey),(bowser.tablet||bowser.tablet)&&(t=t||!1),t||e.metaKey||"Meta"===e.keyIdentifier}},{key:"isShiftDown",value:function Event_isShiftDown_(){return this.domEvt&&!!this.domEvt.shiftKey}},{key:"isCtrlDown",value:function Event_isCtrlDown_(){return this.domEvt&&!!this.domEvt.ctrlKey}},{key:"isAltDown",value:function Event_isAltDown_(){return this.domEvt&&!!this.domEvt.altKey}},{key:"keyCombo",get:function get(){return this._keyCombo||(this._keyCombo=Keys.eventToKeyCombo(this.domEvt))}},{key:"keyCombo",set:function set(e){return this._keyCombo=e}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:956,end:4962})}(void 0),KeyEvent=function(e){var t=_classRecorder,n=t.hasOwnProperty("KeyEvent")&&"function"==typeof t.KeyEvent?t.KeyEvent:t.KeyEvent=function KeyEvent(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function KeyEvent_initialize_(e,t,r,i,o,a,s){console.assert(keyLikeEvents.includes(e),"not a keyboard event: "+e),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e,t,r,i,o,a,s),Object.assign(this,Keys.canonicalizeEvent(t))}},{key:"isKeyEvent",get:function get(){return!0}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:4972,end:5341})}({referencedAs:"Event",value:Event}),SimulatedDOMEvent=function(e){var t=_classRecorder,n=t.hasOwnProperty("SimulatedDOMEvent")&&"function"==typeof t.SimulatedDOMEvent?t.SimulatedDOMEvent:t.SimulatedDOMEvent=function SimulatedDOMEvent(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SimulatedDOMEvent_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.position){var t=e,n=t.position,r=n.x,i=n.y;t.target;(e=lively_lang.obj.dissoc(e,["position"])).pageX=r,e.pageY=i}!e.hasOwnProperty("pointerId")&&mouseEvents.concat(pointerEvents).includes(e.type)&&(e=Object.assign({},e,{pointerId:1})),Object.assign(this,Object.assign({type:void 0,target:void 0,pageX:void 0,pageY:void 0,pointerId:void 0,pointerType:"mouse",buttons:0,keyCode:void 0,keyString:"",keyIdentifier:void 0,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1,stopped:!1},e))}},{key:"preventDefault",value:function SimulatedDOMEvent_preventDefault_(){this.defaultPrevented=!0}},{key:"stopPropagation",value:function SimulatedDOMEvent_stopPropagation_(){this.propagationStopped=!0}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:5350,end:6246})}(void 0),domEventsWeListenTo=[{type:"pointerdown",capturing:!1},{type:"pointerup",capturing:!1},{type:"pointermove",capturing:!1,passive:!1},{type:"pointerover",capturing:!1,passive:!1},{type:"pointerout",capturing:!1,passive:!1},{type:"contextmenu",capturing:!1},{type:"scroll",capturing:!0,passive:!1},{type:"wheel",capturing:!1,passive:!1},{type:"drag",capturing:!1},{type:"dragstart",capturing:!1},{type:"dragend",capturing:!1},{type:"dragover",capturing:!1},{type:"dragenter",capturing:!1},{type:"dragleave",capturing:!1},{type:"drop",capturing:!1}],eventsCausingImmediateRender=new Set(["pointerdown","pointerup","keydown","keyup","input"]),globalDomEventsWeListenTo=[{type:"resize",capturing:!1,morphMethod:"onWindowResize"},{type:"orientationchange",capturing:!1,morphMethod:"onWindowResize"},{type:"scroll",capturing:!1,passive:!1,morphMethod:"onWindowScroll"},{type:"beforeunload",capturing:!1,passive:!1,morphMethod:"onBeforeUnload"}],typeToMethodMap={pointerdown:"onMouseDown",pointerup:"onMouseUp",pointermove:"onMouseMove",longclick:"onLongClick",hoverin:"onHoverIn",hoverout:"onHoverOut",morphicdrag:"onDrag",morphicdragstart:"onDragStart",morphicdragend:"onDragEnd",grab:"onGrab",morphicdrop:"onDrop",morphicdrophoverin:"onDropHoverIn",morphicdrophoverout:"onDropHoverOut",morphicdrophoverupdate:"onDropHoverUpdate",keydown:"onKeyDown",keyup:"onKeyUp",input:"onTextInput",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd",blur:"onBlur",focus:"onFocus",contextmenu:"onContextMenu",cut:"onCut",copy:"onCopy",paste:"onPaste",scroll:"onScroll",wheel:"onMouseWheel",drag:"onNativeDrag",dragstart:"onNativeDragstart",dragend:"onNativeDragend",dragover:"onNativeDragover",dragenter:"onNativeDragenter",dragleave:"onNativeDragleave",drop:"onNativeDrop"},focusTargetingEvents=["keydown","keyup","keypress","input","compositionstart","compositionupdate","compositionend","cut","copy","paste"];function dragStartEvent(e,t,n,r,i,o,a){var s=new Event("morphicdragstart",e,t,[n],i,o,a).onDispatch(function(){r.draggedMorph=n,r.dragStartMorphPosition=n.position,r.dragStartPosition=s.position,r.lastDragPosition=s.position,r.dragDelta=lively_graphics.pt(0,0),r.absDragDelta=lively_graphics.pt(0,0)}).onStop(function(){r.draggedMorph=null,t.schedule(dragEndEvent(e,t,n,r,i,o,a))});return s}function dragEvent(e,t,n,r,i,o,a){var s=new Event("morphicdrag",e,t,[r.draggedMorph],i,o,a).onDispatch(function(){r.dragDelta=(r.draggedMorph.owner||t.world).getInverseTransform().transformDirection(s.position.subPt(r.lastDragPosition)),r.absDragDelta=s.position.subPt(r.clickedOnPosition)}).onAfterDispatch(function(){return r.lastDragPosition=s.position}).onStop(function(){r.draggedMorph=null,t.schedule(dragEndEvent(e,t,n,r,i,o,a))});return s}function dragEndEvent(e,t,n,r,i,o,a){var s=r.draggedMorph||n,l=new Event("morphicdragend",e,t,[s],i,o,a).onDispatch(function(){r.dragDelta=(s.owner||t.world).getInverseTransform().transformDirection(l.position.subPt(r.lastDragPosition)),r.absDragDelta=l.position.subPt(r.clickedOnPosition)}).onAfterDispatch(function(){r.draggedMorph=null,r.lastDragPosition=null,r.dragDelta=lively_graphics.pt(0,0),r.absDragDelta=lively_graphics.pt(0,0),r.dragStartMorphPosition=null,r.dragStartPosition=null});return l}function focusEvents(e,t){var n=e.eventState;if(n.focusedMorph===t)return[];var r=[];return n.focusedMorph&&r.push(new Event("blur",null,this,[n.focusedMorph],null,null,null).onDispatch(function(){return n.focusedMorph=null})),r.push(new Event("focus",null,this,[t],null,null,null).onDispatch(function(){return n.focusedMorph=t})),r}var EventDispatcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("EventDispatcher")&&"function"==typeof t.EventDispatcher?t.EventDispatcher:t.EventDispatcher=function EventDispatcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function EventDispatcher_initialize_(e,t){this.activations=0,this.emitter=e,this.keyInputHelper=null,this.world=t,this.installed=!1,this.handlerFunctions=[],this.killRing=new KillRing(config$1.text.clipboardBufferLength),this.nodeMorphMap=new WeakMap,this.timestampBase=lively_lang.Path("performance.timing.navigationStart").get(e)||0,this.resetState()}},{key:"resetState",value:function EventDispatcher_resetState_(){this.eventState={timeOfLastActivity:0,focusedMorph:null,clickedOnPosition:null,clickedOnMorph:null,clickCount:0,prevClick:null,draggedMorph:null,dragDelta:null,absDragDelta:null,lastDragPosition:null,dragStartMorphPosition:null,dragStartPosition:null,hover:{hoveredOverMorphs:[],unresolvedPointerOut:!1},scroll:{interactiveScrollInProgress:null},keyInputState:null,pressedKeys:{},html5Drag:{},dropHoverTarget:null},this.resetKeyInputState()}},{key:"resetKeyInputState",value:function EventDispatcher_resetKeyInputState_(){this.eventState.keyInputState={keyChain:"",count:void 0}}},{key:"focusMorph",value:function EventDispatcher_focusMorph_(e){var t=this;this.keyInputHelper&&this.keyInputHelper.focus(e,this.world),focusEvents(this,e).forEach(function(e){return t.dispatchEvent(e)})}},{key:"isMorphFocused",value:function EventDispatcher_isMorphFocused_(e){return this.eventState.focusedMorph===e}},{key:"isKeyPressed",value:function EventDispatcher_isKeyPressed_(e){return Object.keys(this.eventState.pressedKeys).map(function(e){return e.toLowerCase()}).includes(e.toLowerCase())}},{key:"whenIdle",value:function EventDispatcher_whenIdle_(){var e=this;return lively_lang.promise.waitFor(function(){return 0===e.activations})}},{key:"install",value:function EventDispatcher_install_(e){var t=this;if(this.installed)return this;this.installed=!0;var n=this.emitter,r=System.global;return domEventsWeListenTo.forEach(function(e){var r=e.type,i=e.capturing,o=function fn(e){return t.dispatchDOMEvent(e)};t.handlerFunctions.push({node:n,type:r,fn:o,capturing:i});var a=i;n.addEventListener(r,o,a)}),r.addEventListener&&globalDomEventsWeListenTo.forEach(function(e){var n=e.type,i=e.capturing,o=e.morphMethod,a=function fn(e){return t.dispatchDOMEvent(e,t.world,o)};t.handlerFunctions.push({node:r,type:n,fn:a,capturing:i});var s=i;r.addEventListener(n,a,s)}),this.keyInputHelper=new TextInput(this).install(e),(bowser.ios||bowser.firefox)&&e.setAttribute("touch-action","none"),this}},{key:"uninstall",value:function EventDispatcher_uninstall_(){this.installed=!1;var e=this.handlerFunctions;return e.forEach(function(e){var t=e.node,n=e.type,r=e.fn,i=e.capturing;t.removeEventListener(n,r,i)}),e.length=0,this.keyInputHelper&&this.keyInputHelper.uninstall(),this.keyInputHelper=null,this}},{key:"processDOMEvent",value:function EventDispatcher_processDOMEvent_(e,t){var n=this,r=e.type,i=this.eventState,o=[t].concat(t.ownerChain()),a="touch"===e.pointerType,s=e.pointerId,l="number"==typeof s?this.world.handForPointerId(s):this.world.firstHand,c=s&&!a?this.world.haloForPointerId(s):null,u=s&&!a?this.world.layoutHaloForPointerId(s):null,h=new(keyLikeEvents.includes(r)?KeyEvent:Event)(r,e,this,o,l,c,u),d=[h],p=[];switch(r){case"keydown":i.pressedKeys[h.key]=!0;break;case"keyup":"Meta"===h.key?i.pressedKeys={}:delete i.pressedKeys[h.key];break;case"click":var f=this.processDOMEvent(Object.assign({},e,{type:"pointerdown"}),t).events,g=this.processDOMEvent(Object.assign({},e,{type:"pointerup"}),t).events;d=f.concat(g);break;case"pointerdown":e.target.setPointerCapture,h.onDispatch(function(){n.focusMorph(t),i.clickedOnMorph=t,i.clickedOnPosition=h.position,i.downTimeStamp=e.timeStamp;var r=!1,o=0;if(i.prevClick){var a=i.prevClick,s=a.clickedOnMorph,l=(a.clickedOnPosition,a.clickedAtTime),c=a.clickCount,u=Date.now()-l;r=s===t&&u<config$1.repeatClickInterval,o=c}i.clickCount=r?o+1:1});break;case"pointerup":h.onAfterDispatch(function(){var t=i.clickedOnMorph,r=i.clickedOnPosition,d=i.clickCount,p=Date.now();i.prevClick={clickedOnMorph:t,clickedOnPosition:r,clickedAtTime:p,clickCount:d},i.clickedOnMorph=null,i.clickCount=0,a&&n.world.removeHandForPointerId(s);var f=e.timeStamp-i.downTimeStamp,g=i.clickedOnPosition.dist(h.position),m=config$1.longClick,v=m.maxDist,y=m.minDur,_=m.maxDur;if(g<v&&f>=y&&f<=_){var b=new Event("longclick",e,n,o,l,c,u);n.schedule(b)}}),i.draggedMorph&&(d.push(dragEndEvent(e,this,t,i,l,c,u)),h.targetMorphs=[this.world]),l.carriesMorphs()&&(i.dropHoverTarget?(d.push(new Event("morphicdrophoverout",e,this,[i.dropHoverTarget],l,c,u)),t=i.dropHoverTarget,i.dropHoverTarget=null):t=l.findDropTarget(h.position,l.grabbedMorphs),l.isAncestorOf(t)&&(t=this.world),d.push(new Event("morphicdrop",e,this,[t],l,c,u)),h.targetMorphs=[this.world]);break;case"pointermove":if(l.carriesMorphs()){h.targetMorphs=[this.world];var m=l.findDropTarget(h.position,l.grabbedMorphs)||this.world;i.dropHoverTarget===m?d.push(new Event("morphicdrophoverupdate",e,this,[m],l,c,u)):(i.dropHoverTarget&&d.push(new Event("morphicdrophoverout",e,this,[i.dropHoverTarget],l,c,u)),i.dropHoverTarget=m,d.push(new Event("morphicdrophoverin",e,this,[m],l,c,u)))}else if(i.draggedMorph)h.targetMorphs=[this.world],d.push(dragEvent(e,this,t,i,l,c,u));else if(i.clickedOnMorph&&i.clickedOnPosition&&i.clickedOnMorph.draggable&&!i.draggedMorph&&!l.carriesMorphs()){var v=i.clickedOnPosition.dist(h.position),y=i.clickedOnMorph;v>y.dragTriggerDistance&&(y.grabbable?d.push(new Event("grab",e,this,[y],l,c,u)):y.draggable&&d.push(dragStartEvent(e,this,y,i,l,c,u)),h.targetMorphs=[this.world])}break;case"pointerover":i.hover.unresolvedPointerOut&&(i.hover.unresolvedPointerOut=!1);var _=[t].concat(t.ownerChain()).reverse(),b=lively_lang.arr.withoutAll(i.hover.hoveredOverMorphs,_).map(function(t){return new Event("hoverout",e,n,[t],l,c,u).onDispatch(function(){return lively_lang.arr.remove(i.hover.hoveredOverMorphs,t)})}),x=lively_lang.arr.withoutAll(_,i.hover.hoveredOverMorphs).map(function(t){return new Event("hoverin",e,n,[t],l,c,u).onDispatch(function(){return lively_lang.arr.pushIfNotIncluded(i.hover.hoveredOverMorphs,t)})});d=b.concat(x);break;case"pointerout":d=[],i.hover.unresolvedPointerOut=!0,p.push(function(){if(i.hover.unresolvedPointerOut)return Promise.all(i.hover.hoveredOverMorphs.map(function(t){return n.schedule(new Event("hoverout",e,n,[t],l,c,u).onAfterDispatch(function(){return lively_lang.arr.remove(i.hover.hoveredOverMorphs,t)}))}))});break;case"blur":d=[new Event(r,e,this,[t],l,c,u).onDispatch(function(){return i.focusedMorph=null})];break;case"focus":d=focusEvents(this,t);break;case"scroll":d=[new Event(r,e,this,[t],l,c,u).onDispatch(function(){if(!!!i.scroll.interactiveScrollInProgress){var n=lively_lang.promise.deferred(),r=n.promise,o=n.resolve,a="Firefox"==bowser.name?500:250;i.scroll.interactiveScrollInProgress=r,r.debounce=lively_lang.fun.debounce(a,function(){i.scroll.interactiveScrollInProgress=null,o()})}i.scroll.interactiveScrollInProgress.debounce();var s=e.target,l=s.scrollLeft,c=s.scrollTop,u=t.scroll,h=u.x,d=u.y;h===l&&d===c||(t.scroll=lively_graphics.pt(l,c))})];break;case"input":case"compositionstart":case"compositionupdate":case"compositionend":t.isText?h.targetMorphs=[t]:d=[];break;case"drag":case"dragstart":case"dragend":case"dragover":case"dragenter":case"dragleave":case"drop":"drop"!==r&&"dragover"!==r||e.preventDefault()}return{events:d,later:p}}},{key:"schedule",value:function EventDispatcher_schedule_(e){var t=this;return this.activations++,Promise.resolve().then(function(){return t.dispatchEvent(e)}).then(function(){return t.activations--},function(e){throw t.activations--,e})}},{key:"dispatchEvent",value:function EventDispatcher_dispatchEvent_(e,t){if(!(t=t||typeToMethodMap[e.type]))throw new Error("dispatchEvent: "+e.type+" not yet supported!");var n;e.onDispatchCallbacks.forEach(function(e){return e()}),this.activations++;for(var r=e.targetMorphs.length-1;r>=0;r--){try{e.targetMorphs[r][t](e)}catch(i){(n=new Error("Error in event handler "+e.targetMorphs[r]+"."+t+": "+(i.stack||i))).originalError=i,void 0!==this.world?this.world.logError(n):console.error(n)}if(n||e.stopped)break}if(this.activations--,e.onAfterDispatchCallbacks.forEach(function(e){return e()}),n)throw n}},{key:"dispatchDOMEvent",value:function EventDispatcher_dispatchDOMEvent_(e,t,n){var r=this,i=this.world,o=this.eventState,a=this.nodeMorphMap,s=e.timeStamp,l=e.type;if(o.timeOfLastActivity=this.timestampBase+s,!t&&focusTargetingEvents.includes(l))t=o.focusedMorph||i;else if(!t){for(var c=e.target;;){var u=c.className||"";if("string"!=typeof u&&"baseVal"in u&&(u=u.baseVal),u&&u.includes("Morph"))break;if(!(c=c.parentNode))return}if(!(t=a.get(c))){var h=c.id;(t=i.withAllSubmorphsDetect(function(e){return e.id===h}))&&a.set(c,t)}}if(t){var d=this.processDOMEvent(e,t),p=d.events;d.later.map(function(e){return r.activations++,lively_lang.promise.delay(0).then(e).then(function(){return r.activations--},function(e){throw r.activations--,e})}),p.forEach(function(e){return r.dispatchEvent(e,n)}),i&&i.needsRerender()&&eventsCausingImmediateRender.has(l)&&i.env.renderer.renderLater()}}},{key:"simulateDOMEvents",value:function EventDispatcher_simulateDOMEvents_(){for(var e=this.emitter.document||this.emitter.ownerDocument,t=[],n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];var o=!0,a=!1,s=void 0;try{for(var l,c=r[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value,h=u,d=h.target,p=h.position,f=h.type;if(focusTargetingEvents.includes(f)){if(!this.keyInputHelper.domState.textareaNode)throw new Error("Cannot simulate event of type "+f+", no keyInputHelper installed!");u=Object.assign({},u,{target:this.keyInputHelper.textareaNode})}if(d||(d=p?this.world.morphsContainingPoint(p)[0]:this.world),d.isMorph&&(u=Object.assign({},u,{target:e.getElementById(d.id)})),u.position){var g=cumulativeOffset(e.getElementById(this.world.id)),m=g.left,v=g.top;u.position=u.position.addXY(m,v)}"scroll"===f&&("scrollLeft"in u||"scrollTop"in u)&&(u.target.scrollLeft=u.scrollLeft||0,u.target.scrollTop=u.scrollTop||0);var y=new SimulatedDOMEvent(u);t.push(y),this.dispatchDOMEvent(y)}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}return t}},{key:"doCopy",value:function EventDispatcher_doCopy_(e){return this.keyInputHelper.doCopy(e)}},{key:"doCopyWithMimeTypes",value:function EventDispatcher_doCopyWithMimeTypes_(e){return this.keyInputHelper.doCopyWithMimeTypes(e)}},{key:"doPaste",value:function EventDispatcher_doPaste_(){return this.keyInputHelper.doPaste()}},{key:"cancelGrab",value:function EventDispatcher_cancelGrab_(e,t){var n=this,r=[],i=this.eventState;i.clickedOnMorph=null,i.dropHoverTarget&&(r.push(new Event("morphicdrophoverout",t.domEvt,this,[i.dropHoverTarget],e,null,null)),i.dropHoverTarget=null),r.forEach(function(e){return n.dispatchEvent(e)})}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:7592,end:28919})}(void 0),MorphicEnv=function(e){var t=_classRecorder,n=t.hasOwnProperty("MorphicEnv")&&"function"==typeof t.MorphicEnv?t.MorphicEnv:t.MorphicEnv=function MorphicEnv(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function MorphicEnv_initialize_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:defaultDOMEnv();this.initialized=!1,this.fontMetric=null,this.renderer=null,this.eventDispatcher=null,this.world=null,this.systemChangeHandlers=null,this.objPool=null,this.synchronizer=null,this.changeManager=new ChangeManager,this.undoManager=new UndoManager,this.installSystemChangeHandlers(),this.whenRenderedRequesters=new Map,this.whenRenderedTickingProcess=null,"function"==typeof t.then?this._waitForDOMEnv=t.then(function(t){e._waitForDOMEnv=null,e.initWithDOMEnv(t),e.initialized=!0}).catch(function(e){return console.error("Error initializing MorphicEnv with dom env: "+e.stack)}):(this.initWithDOMEnv(t),this.initialized=!0)}},{key:"isDefault",value:function MorphicEnv_isDefault_(){return this.constructor.default()===this}},{key:"initWithDOMEnv",value:function MorphicEnv_initWithDOMEnv_(e){this.domEnv=e,this.fontMetric=FontMetric.forDOMEnv(e)}},{key:"uninstallWorldRelated",value:function MorphicEnv_uninstallWorldRelated_(){this.renderer&&this.renderer.clear(),this.eventDispatcher&&this.eventDispatcher.uninstall(),this.world&&this.world.suspendSteppingAll()}},{key:"uninstall",value:function MorphicEnv_uninstall_(){var e=this;return this._waitForDOMEnv?this._waitForDOMEnv.then(function(){return e.uninstall()}):(this.deleteHistory(),this.uninstallWorldRelated(),this.fontMetric&&(this.fontMetric.uninstall(),this.fontMetric=null),this.domEnv&&this.whenRenderedTickingProcess&&(this.domEnv.window.cancelAnimationFrame(this.whenRenderedTickingProcess),this.whenRenderedTickingProcess=null),this.whenRenderedRequesters=new Map,this.domEnv&&this.domEnv.destroy(),this.initialized=!1,Promise.resolve())}},{key:"setWorld",value:function MorphicEnv_setWorld_(e){var t=this;return this._waitForDOMEnv?this._waitForDOMEnv.then(function(){return t.setWorld(e)}):this.setWorldRenderedOn(e,this.domEnv.document.body)}},{key:"setWorldRenderedOn",value:function MorphicEnv_setWorldRenderedOn_(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!e||!e.isWorld)throw new Error("world object does not look like a morphic world");return this._waitForDOMEnv?this._waitForDOMEnv.then(function(){return n.setWorldRenderedOn(e,t,r)}):(this.deleteHistory(),this.uninstallWorldRelated(),this.world=e,this.renderer=new Renderer(e,t,this.domEnv),this.renderer.domNode=r,this.eventDispatcher=new EventDispatcher(this.domEnv.window,e).install(t),e.resumeSteppingAll(),this.isDefault()&&(this.domEnv.window.$world=e),e.focus(),e.makeDirty(),this.renderer.renderLater(),e.whenRendered().then(function(){return n}))}},{key:"installSystemChangeHandlers",value:function MorphicEnv_installSystemChangeHandlers_(){var e=this;if(!this.systemChangeHandlers){var t=this.systemChangeHandlers={};t["lively.modules/moduleloaded"]=[lively_notifications.subscribe("lively.modules/moduleloaded",function(t){return e.getTargetsFor("onModuleLoaded").forEach(function(e){return e.onModuleLoaded(t)})})],t["lively.modules/modulechanged"]=[lively_notifications.subscribe("lively.modules/modulechanged",function(t){return e.getTargetsFor("onModuleChanged").forEach(function(e){return e.onModuleChanged(t)})})],t["lively.partsbin/partpublished"]=[lively_notifications.subscribe("lively.partsbin/partpublished",function(t){return e.getTargetsFor("onPartPublished").forEach(function(e){return e.onPartPublished(t)})})],t["lively.user/userchanged"]=[lively_notifications.subscribe("lively.user/userchanged",function(t){return e.getTargetsFor("onUserChanged").forEach(function(e){return e.onUserChanged(t)})})]}}},{key:"uninstallSystemChangeHandlers",value:function MorphicEnv_uninstallSystemChangeHandlers_(){var e=this.systemChangeHandlers;e&&(this.systemChangeHandlers=null,Object.keys(e).forEach(function(t){return e[t].forEach(function(e){return lively_notifications.unsubscribe(t,e)})}))}},{key:"getTargetsFor",value:function MorphicEnv_getTargetsFor_(e){var t=this.world,n=[];if(!t||!t.submorphs)return n;"function"==typeof t[e]&&n.push(t);var r=!0,i=!1,o=void 0;try{for(var a,s=t.submorphs[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var l=a.value;"function"==typeof l[e]&&n.push(l),l.isWindow&&l.targetMorph&&"function"==typeof l.targetMorph[e]&&n.push(l.targetMorph)}}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}},{key:"cleanupCaches",value:function MorphicEnv_cleanupCaches_(){this.world.withAllSubmorphsDo(function(e){return e._pathDependants=e._pathDependants.filter(function(e){return e.world()})})}},{key:"deleteHistory",value:function MorphicEnv_deleteHistory_(){var e=this.changeManager,t=this.world,n=this.fontMetric;e&&(e.changes.length=0),t&&t.withAllSubmorphsDo(function(e){return e.undoManager&&e.undoManager.reset()}),n&&n.reset()}},{key:"printStatus",value:function MorphicEnv_printStatus_(){var e=this.changeManager,t=this.world,n=(this.fontMetric,0),r=0;return t&&t.withAllSubmorphsDo(function(e){e.undoManager&&(n++,r+=e.undoManager.undos.length+e.undoManager.redos.length)}),e.changes.length+" changes recorded\n"+n+" morphs with undos\n"+r+" undo changes"}},{key:"updateWhenRenderedRequests",value:function MorphicEnv_updateWhenRenderedRequests_(){var e=this,t=this.whenRenderedRequesters,n=0,r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var l=slicedToArray(a.value,2),c=l[0],u=l[1],h=u.maxAttempts,d=(u.currentAttempt,u.resolve),p=u.reject;c._dirty||c._rendering?++u.currentAttempt>h?(t.delete(c),p(new Error("Failed to wait for whenRendered of "+c+" (tried "+h+"x)"))):n++:(t.delete(c),d(c))}}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}this.whenRenderedTickingProcess=n?this.domEnv.window.requestAnimationFrame(function(){return e.updateWhenRenderedRequests()}):null}},{key:"whenRendered",value:function MorphicEnv_whenRendered_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,r=this.whenRenderedRequesters,i=this.whenRenderedTickingProcess,o=r.get(e);if(!o){var a=void 0,s=void 0,l=new Promise(function(e,t){a=e,s=t});r.set(e,o={maxAttempts:n,currentAttempt:0,resolve:a,reject:s,promise:l})}return i||(this.whenRenderedTickingProcess=this.domEnv.window.requestAnimationFrame(function(){return t.updateWhenRenderedRequests()})),o.promise}}],[{key:"reset",value:function MorphicEnv_reset_(){for(;;){var e=this.popDefault();if(!e)break;try{e.uninstall()}catch(e){console.error("Error uninstalling MorphicEnv: "+(e.stack||e))}}}},{key:"default",value:function MorphicEnv_default_(){var e=this.envs;return e.length||this.pushDefault(new this),e[e.length-1]}},{key:"pushDefault",value:function MorphicEnv_pushDefault_(e){return this.envs.push(e),e}},{key:"popDefault",value:function MorphicEnv_popDefault_(){return this.envs.pop()}},{key:"envs",get:function get(){return this._envs||(this._envs=[])}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:406,end:8262})}(void 0);function printArg$1(e){return lively_lang.obj.inspect(e,{maxDepth:1}).replace(/\n/g,"").replace(/\s+/g," ")}var CommandHandler=function(e){var t=_classRecorder,n=t.hasOwnProperty("CommandHandler")&&"function"==typeof t.CommandHandler?t.CommandHandler:t.CommandHandler=function CommandHandler(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function CommandHandler_initialize_(){this.history=[],this.maxHistorySize=1e3}},{key:"addToHistory",value:function CommandHandler_addToHistory_(e){this.history.push(e),this.history.length>this.maxHistorySize&&this.history.splice(0,this.history.length-this.maxHistorySize)}},{key:"printHistory",value:function CommandHandler_printHistory_(){return this.history.map(this.printCommand).join("\n")}},{key:"printCommand",value:function CommandHandler_printCommand_(e){var t=e.name,n=e.target.string,r=e.args,i=e.count,o=e.evt,a=e.keyCombo;return'"'+t+'" '+(o?o+" ":"")+(a?a+" ":"")+(r?printArg$1(r):"")+("number"==typeof i?" x"+i:"")+" "+n}},{key:"lookupCommand",value:function CommandHandler_lookupCommand_(e,t){var n,r;return e?("string"==typeof e&&(n=e),"string"==typeof e.command&&(n=e.command),e.exec&&(n=(r=e).name),r||(r=t.commands.find(function(e){return e.name===n})),{name:n,command:r}):{}}},{key:"exec",value:function CommandHandler_exec_(e,t,n,r,i){var o=this,a=this.lookupCommand(e,t)||{},s=a.name,l=a.command;if(!l)return console.warn("Cannot find command "+(s||e)),null;if(s){var c=void 0,u=void 0;i&&(c=i.type,i.isKeyEvent&&(u=i.keyCombo)),this.addToHistory({name:s,target:{string:String(t),id:t.id},args:n,count:r,time:Date.now(),evt:c,keyCombo:u})}var h,d=t.world();if(this.progressIndicator&&this.progressIndicator.remove(),"string"==typeof l.progressIndicator&&(this.progressIndicator=LoadingIndicator.open(l.progressIndicator)),"function"==typeof l.exec)try{h=l.exec(t,n,l.handlesCount?r:void 0,i)}catch(e){h=e;var p="Error in interactive command "+s+": "+(e.stack||e);d?d.logError(p):console.error(p)}else console.error("command "+s+" has no exec function!");return h&&"function"==typeof h.catch?(h.catch(function(e){var t="Error in interactive command "+s+": "+e+"\n"+(e.stack||e);throw d?d.logError(t):console.error(t),e}),this.progressIndicator&&lively_lang.promise.finally(h,function(){return o.progressIndicator.remove()})):this.progressIndicator&&this.progressIndicator.remove(),h&&"number"==typeof r&&r>1&&!l.handlesCount&&(h="function"==typeof h.then?h.then(function(){return o.exec(l,t,n,r-1,i,null)}):this.exec(l,t,n,r-1,i,null)),h}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:242,end:3620})}(void 0),simulateKeys=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t){var n,r,i,o,a,s,l,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{keyChain:void 0,count:void 0};return regeneratorRuntime.wrap(function _callee$(u){for(;;)switch(u.prev=u.next){case 0:n=1===t.length?[t]:t.split(/ /g).map(ensureSpaces),r=!0,i=!1,o=void 0,u.prev=4,a=n[Symbol.iterator]();case 6:if(r=(s=a.next()).done){u.next=13;break}return l=s.value,u.next=10,simulateKey(e,l,c);case 10:r=!0,u.next=6;break;case 13:u.next=19;break;case 15:u.prev=15,u.t0=u.catch(4),i=!0,o=u.t0;case 19:u.prev=19,u.prev=20,!r&&a.return&&a.return();case 22:if(u.prev=22,!i){u.next=25;break}throw o;case 25:return u.finish(22);case 26:return u.finish(19);case 27:case"end":return u.stop()}},_callee,this,[[4,15,19,27],[20,,22,26]])}));return function simulateKeys(t,n){return e.apply(this,arguments)}}();function ensureSpaces(e){return e.length?e:" "}function invokeKeyHandlers(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t=Keys.canonicalizeEvent(t),i=r.keyCombo,o=r.key,a=r.data,s=void 0,l=!1,c=e.keyhandlers,u=t.keyInputState||{},h=i.startsWith("input-"),d=!1,p=u.count,f=u.keyChain||"",g=!1;if(!c||n&&h)return!1;for(var m=c.length;m--;)if((s=c[m].eventCommandLookup(e,t))&&s.command){var v=s,y=v.command,_=v.args,b=v.passEvent,x=v.count,w=v.keyChain,k=v.onlyWhenFocused;if(g=!0,p=x,f=w,d="null"===y,k){var S=e.world();if(S&&S.focusedMorph&&S.focusedMorph!==e)continue}if(!(l=!d&&e.execCommand(y,_,x,t))||h&&"insertstring"===y||b||"function"!=typeof t.stop||t.stop(),l||d)break}if(!l&&!d&&h&&e.onTextInput&&!f){var C=u.count;l=e.execCommand("insertstring",{string:a||o,undoGroup:config$1.text.undoGroupDelay},C,t)}return g&&("function"==typeof t.onAfterDispatch?t.onAfterDispatch(function(){u.count=l?void 0:p,u.keyChain=l?"":f}):(u.count=l?void 0:p,u.keyChain=l?"":f)),l&&!d}function simulateKey(e,t,n){return invokeKeyHandlers(e,Object.assign({},Keys.keyComboToEventSpec(t),{keyInputState:n}))}function bowserOS(){return bowser.mac?"mac":bowser.windows?"windows":bowser.windowsphone?"windowsphone":bowser.linux?"linux":bowser.chromeos?"chromeos":bowser.android?"android":bowser.ios?"ios":bowser.blackberry?"blackberry":bowser.firefoxos?"firefoxos":bowser.webos?"webos":bowser.bada?"bada":bowser.tizen?"tizen":bowser.sailfish?"sailfish":"unknown"}function findKeysForPlatform(e,t){if("string"==typeof e)return e;if(!e||"object"!==(void 0===e?"undefined":_typeof(e)))return null;switch(t){case"ios":return e.ios||e.mac;case"mac":return e.mac||e.ios;case"win":case"windows":case"windowsphone":return e.win||e.windows;case"linux":return e.linux||e.win||e.windows;case"chromeos":return e.chromeos||e.linux||e.win||e.windows;case"android":return e.android||e.linux||e.win||e.windows;default:return e.linux||e.win||e.windows}}var regexps={meta:/Meta|Cmd|Command/gi,alt:/Alt/gi,ctrl:/Ctrl|Control/gi,tab:/Tab/gi,enter:/Enter|Return/gi,shift:/Shift/gi,backspace:/Backspace/gi,delete:/del(ete)?/gi,left:/left/gi,right:/right/gi,up:/up/gi,down:/down/gi,keySpacer:/([^-])-/g,seqSpacer:/([^\s])\s/g},KeyHandler=function(e){var t=_classRecorder,n=t.hasOwnProperty("KeyHandler")&&"function"==typeof t.KeyHandler?t.KeyHandler:t.KeyHandler=function KeyHandler(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function KeyHandler_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bowserOS();this.platform=e,this.keyBindings={}}},{key:"eventCommandLookup",value:function KeyHandler_eventCommandLookup_(e,t){var n=t.keyCombo,r=t.keyInputState;return this.lookup(n,r)}},{key:"lookup",value:function KeyHandler_lookup_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keyChain:void 0,count:void 0};e=Keys.canonicalizeKeyCombo(e);var r=n.keyChain||"",i=n.count;if(!r&&e.startsWith("Ctrl-")){var o=e.match(/^Ctrl-([0-9]+)/);if(o)return{command:"null",count:parseInt(("number"==typeof i?i:"")+o[1])};if("Ctrl-U"===e)return{command:"null",count:4,keyChain:"Ctrl-U"}}var a=[e];if(!c&&e.startsWith("input-")){var s=e.replace(/^(input-)(.*)$/,function(e,t,n){return t+n.toUpperCase()}),l=e.replace(/^(input-)(.*)$/,function(e,t,n){return t+n.toLowerCase()});a.push(s,l)}var c=a.map(function(e){return t.keyBindings[e]})[0];if(r){var u=a.find(function(e){return t.keyBindings[r+" "+e]});u&&(r+=" "+u,c=this.keyBindings[r]||c)}if(c&&"chainKeys"===c){var h={command:"null",keyChain:r=r||e};return void 0!==i&&(h.count=i),h}if(c){h="object"===(void 0===c?"undefined":_typeof(c))?Object.assign({},c):{command:c};return void 0!==i&&(h.count=i),h}}},{key:"bindKey",value:function KeyHandler_bindKey_(e,t){var n=this;if("object"==(void 0===e?"undefined":_typeof(e))&&e&&!Array.isArray(e)&&(e=findKeysForPlatform(e,this.platform)),e){if("function"==typeof t)return this.addCommand({exec:t,bindKey:e,name:t.name||e});(Array.isArray(e)?e:e.includes("|")?e.split("|"):[e]).forEach(function(e){var r="";if(-1!=e.indexOf(" ")){var i=e.split(/\s+/);e=i.pop(),i.forEach(function(e){var t=Keys.canonicalizeKeyCombo(e);r+=(r?" ":"")+t,n.addCommandToBinding(r,"chainKeys")}),r+=" "}n.addCommandToBinding(r+Keys.canonicalizeKeyCombo(e),t)}),this.cleanupUnusedKeyChains()}}},{key:"unbindKey",value:function KeyHandler_unbindKey_(e){this.bindKey(e,null)}},{key:"cleanupUnusedKeyChains",value:function KeyHandler_cleanupUnusedKeyChains_(){var e=this,t=Object.keys(this.keyBindings),n=t.filter(function(t){return"chainKeys"===e.keyBindings[t]});(n=lively_lang.arr.sortBy(n,function(e){return e.length}).reverse()).forEach(function(r){t.some(function(e){return r!==e&&e.startsWith(r)})||(delete e.keyBindings[r],lively_lang.arr.remove(t,r),lively_lang.arr.remove(n,r))})}},{key:"addCommand",value:function KeyHandler_addCommand_(e){return e&&e.bindKey?this.addCommandToBinding(e.bindKey,e):void 0}},{key:"addCommandToBinding",value:function KeyHandler_addCommandToBinding_(e,t){var n=this;"chainKeys"===this.keyBindings[e]&&"chainKeys"!=t&&Object.keys(this.keyBindings).forEach(function(t){t.startsWith(e)&&delete n.keyBindings[t]}),t?this.keyBindings[e]=t:delete this.keyBindings[e],"chainKeys"!==t&&this.cleanupUnusedKeyChains()}}],[{key:"invokeKeyHandlers",value:function KeyHandler_invokeKeyHandlers_(e,t){return invokeKeyHandlers(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2])}},{key:"simulateKeys",value:function KeyHandler_simulateKeys_(e,t,n){return simulateKeys(e,t,n)}},{key:"withBindings",value:function KeyHandler_withBindings_(e,t){var n=new this(t);return e.forEach(function(e){var t=e.command,r=e.keys;return n.bindKey(r,t)}),n}},{key:"prettyCombo",value:function KeyHandler_prettyCombo_(e){var t=this._prettyCombos||(this._prettyCombos={});return this._prettyCombos[e]?t[e]:t[e]=e.replace(regexps.meta,"").replace(regexps.alt,"").replace(regexps.ctrl,"").replace(regexps.tab,"").replace(regexps.enter,"").replace(regexps.shift,"").replace(regexps.backspace,"").replace(regexps.delete,"").replace(regexps.left,"").replace(regexps.right,"").replace(regexps.up,"").replace(regexps.down,"").replace(regexps.keySpacer,"$1").replace(regexps.seqSpacer,"$1-")}},{key:"generateCommandToKeybindingMap",value:function KeyHandler_generateCommandToKeybindingMap_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i={},o={};return(n?e.commandsIncludingOwners:e.commands.map(function(t){return{command:t,target:e}})).map(function(e){var n=e.target,a=e.command,s=function commandsToKeysFor(e){if(o[e.id])return o[e.id];var t=i[e.id]||(i[e.id]=e.keyCommandMap);return o[e.id]=lively_lang.arr.groupBy(Object.keys(t),function(e){return t[e].name})}(n)[a.name];return{keys:s,target:n,command:a,prettyKeys:s&&r?s.map(function(e){return t.prettyCombo(e)}):null}})}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:6164,end:13033})}(void 0),Script=function(e){var t=_classRecorder,n=t.hasOwnProperty("Script")&&"function"==typeof t.Script?t.Script:t.Script=function Script(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Script_initialize_(){this.suspended=!1,this.stopped=!0,this.tickTime=null,this.type=null,this.currentTimeout=null}},{key:"__additionally_serialize__",value:function Script___additionally_serialize___(e,t,n){e.props.suspended.value=!0}},{key:"isScript",get:function get(){return!0}},{key:"global",get:function get(){return System.global}},{key:"execute",value:function Script_execute_(){throw new Error("subclass responsibility")}},{key:"tick",value:function Script_tick_(){try{this.execute()}catch(e){return void console.error("Error executing script "+this+": "+e+"\n"+e.stack)}this.stopped||this.startTicking(this.tickTime)}},{key:"startTicking",value:function Script_startTicking_(e){this.stopped=!1,this.tickTime=e,this.type="number"==typeof e?"setTimeout":"requestAnimationFrame",this.currentTimeout="setTimeout"===this.type?this.global.setTimeout(this.tick.bind(this),e):this.global.requestAnimationFrame(this.tick.bind(this))}},{key:"stop",value:function Script_stop_(){var e="setTimeout"===this.type?"clearTimeout":"cancelAnimationFrame";this.global[e](this.currentTimeout),this.stopped=!0}},{key:"resume",value:function Script_resume_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.tickTime;this.suspended&&(this.suspended=!1,this.startTicking(this.tickTime=e))}},{key:"suspend",value:function Script_suspend_(){this.stop(),this.suspended=!0}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:19,end:1360})}(void 0),TargetScript=function(e){var t=_classRecorder,n=t.hasOwnProperty("TargetScript")&&"function"==typeof t.TargetScript?t.TargetScript:t.TargetScript=function TargetScript(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TargetScript_initialize_(e,t,r){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this),this.target=e,this.selector=t,this.args=r||[]}},{key:"execute",value:function TargetScript_execute_(){"function"==typeof this.target[this.selector]&&this.target[this.selector].apply(this.target,this.args)}},{key:"equals",value:function TargetScript_equals_(e){return e.isScript&&this.target==e.target&&this.selector==e.selector}},{key:"toString",value:function TargetScript_toString_(){return"Script("+this.target+">>"+this.selector+"("+this.args.join(",")+"))"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1362,end:1906})}({referencedAs:"Script",value:Script}),FunctionScript=function(e){var t=_classRecorder,n=t.hasOwnProperty("FunctionScript")&&"function"==typeof t.FunctionScript?t.FunctionScript:t.FunctionScript=function FunctionScript(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function FunctionScript_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this),this.callback=e}},{key:"execute",value:function FunctionScript_execute_(){this.callback()}},{key:"equals",value:function FunctionScript_equals_(e){return e.isScript&&this.callback==e.callback}},{key:"toString",value:function FunctionScript_toString_(){return"Script("+this.callback.toString().replace(/\n/g,"").slice(0,40)+"...)"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1908,end:2242})}({referencedAs:"Script",value:Script}),morphicDBs=morphicDBs||(morphicDBs=new Map),defaultServerURL=("undefined"!=typeof document?document.location.origin:"http://localhost:9001")+"/objectdb/",MorphicDB=function(e){var t=_classRecorder,n=t.hasOwnProperty("MorphicDB")&&"function"==typeof t.MorphicDB?t.MorphicDB:t.MorphicDB=function MorphicDB(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function MorphicDB_initialize_(e,t){var n=t.snapshotLocation,r=t.serverURL;this.name=e,this.serverURL=r,this.snapshotLocation=n||e+"/snapshots/",this.httpDB=new lively_storage.ObjectDBHTTPInterface(r),this._initialized=!1}},{key:"__serialize__",value:function MorphicDB___serialize___(){var e=this.name,t=this.serverURL;return{__expr__:'MorphicDB.named("'+e+'", {snapshotLocation: "'+this.snapshotLocation+'", serverURL: "'+t+'"})',bindings:{"lively.morphic/morphicdb.js":[{exported:"default",local:"MorphicDB"}]}}}},{key:"initializeIfNecessary",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function _callee$(e){for(;;)switch(e.prev=e.next){case 0:if(!this._initialized){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.ensureDB();case 4:this._initialized=!0;case 5:case"end":return e.stop()}},_callee,this)}));return function MorphicDB_initializeIfNecessary_(){return e.apply(this,arguments)}}()},{key:"snapshotResourceFor",value:function MorphicDB_snapshotResourceFor_(e){var t=e.content.slice(0,2),n=e.content.slice(2);return lively_resources.resource(System.decanonicalize(this.snapshotLocation)).join(t+"/"+n+".json")}},{key:"ensureDB",value:function MorphicDB_ensureDB_(){var e=this.name,t=this.snapshotLocation;return this.httpDB.ensureDB({db:e,snapshotLocation:t})}},{key:"destroyDB",value:function MorphicDB_destroyDB_(){this._initialized=!1;var e=this.name;return this.httpDB.destroyDB({db:e})}},{key:"latestCommits",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(){var e,t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"world",i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.initializeIfNecessary();case 2:return e=this.name,t="HEAD",n={},o.abrupt("return",this.httpDB.fetchCommits({db:e,type:r,ref:t,knownCommitIds:n,includeDeleted:i}));case 4:case"end":return o.stop()}},_callee2,this)}));return function MorphicDB_latestCommits_(){return e.apply(this,arguments)}}()},{key:"fetchCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e,t,n){var r,i;return regeneratorRuntime.wrap(function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.initializeIfNecessary();case 2:return r=[{type:e,name:t,ref:n}],o.next=5,this.httpDB.fetchCommits({db:this.name,ref:n,type:e,typesAndNames:r});case 5:return i=o.sent,o.abrupt("return",i[0]);case 7:case"end":return o.stop()}},_callee3,this)}));return function MorphicDB_fetchCommit_(t,n,r){return e.apply(this,arguments)}}()},{key:"fetchSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e,t,n,r){var i,o,a=arguments;return regeneratorRuntime.wrap(function _callee4$(s){for(;;)switch(s.prev=s.next){case 0:return i=e,1===a.length&&i.type&&i.name&&(e=i.type,t=i.name,n=i._id),s.next=4,this.initializeIfNecessary();case 4:return o=this.name,s.abrupt("return",this.httpDB.fetchSnapshot({db:o,type:e,name:t,ref:r,commit:n}));case 6:case"end":return s.stop()}},_callee4,this)}));return function MorphicDB_fetchSnapshot_(t,n,r,i){return e.apply(this,arguments)}}()},{key:"exists",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee5(e,t,n){var r;return regeneratorRuntime.wrap(function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.initializeIfNecessary();case 2:return r=this.name,i.abrupt("return",this.httpDB.exists({db:r,type:e,name:t,ref:n}));case 4:case"end":return i.stop()}},_callee5,this)}));return function MorphicDB_exists_(t,n,r){return e.apply(this,arguments)}}()},{key:"history",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee6(e,t){var n;return regeneratorRuntime.wrap(function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.initializeIfNecessary();case 2:return n=this.name,r.abrupt("return",this.httpDB.fetchVersionGraph({db:n,type:e,name:t}));case 4:case"end":return r.stop()}},_callee6,this)}));return function MorphicDB_history_(t,n){return e.apply(this,arguments)}}()},{key:"log",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee7(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments[3];return regeneratorRuntime.wrap(function _callee7$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.initializeIfNecessary();case 2:return n=this.name,o.abrupt("return",this.httpDB.fetchLog({db:n,commit:e,limit:t,includeCommits:r,knownCommitIds:i}));case 4:case"end":return o.stop()}},_callee7,this)}));return function MorphicDB_log_(t,n){return e.apply(this,arguments)}}()},{key:"revert",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e,t,n){var r,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"HEAD";return regeneratorRuntime.wrap(function _callee8$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.initializeIfNecessary();case 2:return r=this.name,o.abrupt("return",this.httpDB.revert({db:r,type:e,name:t,toCommitId:n,ref:i}));case 4:case"end":return o.stop()}},_callee8,this)}));return function MorphicDB_revert_(t,n,r){return e.apply(this,arguments)}}()},{key:"snapshotAndCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee9(e,t,n,r,i,o,a){var s,l;return regeneratorRuntime.wrap(function _callee9$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,createMorphSnapshot(n,r);case 2:return s=c.sent,c.next=5,this.commit(e,t,s,i,o,a);case 5:return l=c.sent,n.changeMetaData("commit",lively_lang.obj.dissoc(l,["preview"]),!0,!1),c.abrupt("return",l);case 8:case"end":return c.stop()}},_callee9,this)}));return function MorphicDB_snapshotAndCommit_(t,n,r,i,o,a,s){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee10(e,t,n,r,i,o){var a,s,l=arguments;return regeneratorRuntime.wrap(function _callee10$(c){for(;;)switch(c.prev=c.next){case 0:return a=e,1===l.length&&a.type&&a.name&&(e=a.type,t=a.name,n=a.snapshot||a.content,r=lively_lang.obj.dissoc(a,["snapshot","_rev","_id","ancestors","deleted"]),o=a._id),c.next=4,this.initializeIfNecessary();case 4:return s=this.name,c.abrupt("return",this.httpDB.commit({db:s,type:e,name:t,ref:i,expectedParentCommit:o,commitSpec:r,snapshot:n}));case 6:case"end":return c.stop()}},_callee10,this)}));return function MorphicDB_commit_(t,n,r,i,o,a){return e.apply(this,arguments)}}()},{key:"load",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee11(e,t,n,r,i){var o,a,s,l,c,u;return regeneratorRuntime.wrap(function _callee11$(h){for(;;)switch(h.prev=h.next){case 0:if(o=void 0,"object"===(void 0===e?"undefined":_typeof(e))?r=e:o=e,a=r){h.next=9;break}return h.next=6,this.fetchCommit(o,t,i);case 6:a=h.sent,h.next=15;break;case 9:if("string"!=typeof a){h.next=15;break}return h.next=12,this.log(a,1,!0);case 12:s=h.sent,l=slicedToArray(s,1),a=l[0];case 15:return h.next=17,this.fetchSnapshot(void 0,void 0,a._id);case 17:return c=h.sent,h.next=20,loadMorphFromSnapshot$$1(c,n);case 20:return(u=h.sent).changeMetaData("commit",lively_lang.obj.dissoc(a,["preview"]),!0,!1),h.abrupt("return",u);case 23:case"end":return h.stop()}},_callee11,this)}));return function MorphicDB_load_(t,n,r,i,o){return e.apply(this,arguments)}}()},{key:"fetchDiff",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee12(e){var t;return regeneratorRuntime.wrap(function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.initializeIfNecessary();case 2:return t=this.name,n.abrupt("return",this.httpDB.fetchDiff({db:t,otherDB:e}));case 4:case"end":return n.stop()}},_callee12,this)}));return function MorphicDB_fetchDiff_(t){return e.apply(this,arguments)}}()},{key:"fetchConflicts",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee13(e,t){var n;return regeneratorRuntime.wrap(function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.initializeIfNecessary();case 2:return n=this.name,r.abrupt("return",this.httpDB.fetchConflicts({db:n,includeDocs:e,only:t}));case 4:case"end":return r.stop()}},_callee13,this)}));return function MorphicDB_fetchConflicts_(t,n){return e.apply(this,arguments)}}()},{key:"resolveConflict",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee14(e){var t;return regeneratorRuntime.wrap(function _callee14$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.initializeIfNecessary();case 2:return t=this.name,n.abrupt("return",this.httpDB.resolveConflict(Object.assign({db:t},e)));case 4:case"end":return n.stop()}},_callee14,this)}));return function MorphicDB_resolveConflict_(t){return e.apply(this,arguments)}}()},{key:"synchronize",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee15(e){var t,n=e.method,r=e.otherDB,i=e.otherDBSnapshotLocation,o=e.onlyTypesAndNames;return regeneratorRuntime.wrap(function _callee15$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializeIfNecessary();case 2:return t=this.name,e.abrupt("return",this.httpDB.synchronize({db:t,method:n,otherDB:r,otherDBSnapshotLocation:i,onlyTypesAndNames:o}));case 4:case"end":return e.stop()}},_callee15,this)}));return function MorphicDB_synchronize_(t){return e.apply(this,arguments)}}()},{key:"softDelete",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee16(e,t,n,r,i){return regeneratorRuntime.wrap(function _callee16$(o){for(;;)switch(o.prev=o.next){case 0:return o.abrupt("return",this.commit(e,t,void 0,n,r,i));case 1:case"end":return o.stop()}},_callee16,this)}));return function MorphicDB_softDelete_(t,n,r,i,o){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee17(e,t){var n,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return regeneratorRuntime.wrap(function _callee17$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.initializeIfNecessary();case 2:return n=this.name,i.abrupt("return",this.httpDB.delete({db:n,type:e,name:t,dryRun:r}));case 4:case"end":return i.stop()}},_callee17,this)}));return function MorphicDB_delete_(t,n){return e.apply(this,arguments)}}()},{key:"deleteCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee18(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function _callee18$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.initializeIfNecessary();case 2:return t=this.name,r.abrupt("return",this.httpDB.deleteCommit({db:t,commit:e,dryRun:n}));case 4:case"end":return r.stop()}},_callee18,this)}));return function MorphicDB_deleteCommit_(t){return e.apply(this,arguments)}}()},{key:"codeSearchInPackages",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee19(e){var t,n,r,i,o,a,s,l,c,u,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"part",d=arguments[2],p=arguments[3];return regeneratorRuntime.wrap(function _callee19$(f){for(;;)switch(f.prev=f.next){case 0:return f.next=2,this.latestCommits(h);case 2:t=f.sent,n=[],r=0,"function"==typeof p&&(t=t.filter(p)),i=!0,o=!1,a=void 0,f.prev=9,s=t[Symbol.iterator]();case 11:if(i=(l=s.next()).done){f.next=21;break}return c=l.value,"function"==typeof d&&d(c.name,r++,t.length),f.next=16,this._textSearchInSnapshotOfCommit(e,c);case 16:(u=f.sent).length&&n.push.apply(n,toConsumableArray(u));case 18:i=!0,f.next=11;break;case 21:f.next=27;break;case 23:f.prev=23,f.t0=f.catch(9),o=!0,a=f.t0;case 27:f.prev=27,f.prev=28,!i&&s.return&&s.return();case 30:if(f.prev=30,!o){f.next=33;break}throw a;case 33:return f.finish(30);case 34:return f.finish(27);case 35:return f.abrupt("return",n);case 36:case"end":return f.stop()}},_callee19,this,[[9,23,27,35],[28,,30,34]])}));return function MorphicDB_codeSearchInPackages_(t){return e.apply(this,arguments)}}()},{key:"_textSearchInSnapshotOfCommit",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee20(e,t,n){var r,i;return regeneratorRuntime.wrap(function _callee20$(o){for(;;)switch(o.prev=o.next){case 0:if(r=t._id,o.t0=n,o.t0){o.next=6;break}return o.next=5,this.fetchSnapshot(void 0,void 0,r);case 5:o.t0=o.sent;case 6:return i=o.t0,o.abrupt("return",new SnapshotPackageHelper(i).textSearch(e,t));case 8:case"end":return o.stop()}},_callee20,this)}));return function MorphicDB__textSearchInSnapshotOfCommit_(t,n,r){return e.apply(this,arguments)}}()}],[{key:"default",get:function get(){return this.named("lively.morphic/objectdb/morphicdb",{serverURL:defaultServerURL})}},{key:"named",value:function MorphicDB_named_(e,t){var n=morphicDBs.get(e);if(n)return n;if(!t.serverURL)throw new Error("Needs serverURL!");var r=new this(e,t);return morphicDBs.set(e,r),r}},{key:"wellKnownMorphicDBs",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee21(){var e,t,n,r=this;return regeneratorRuntime.wrap(function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:return e=lively_storage.Database.ensureDB("lively.morphic/morphicdb/well-known-morphic-dbs"),i.next=3,e.getAll();case 3:return t=i.sent,(n=t.reduce(function(e,t){var n=t._id,i=t.name,o=t.serverURL,a=t.snapshotLocation;return Object.assign(e,defineProperty({},n,r.named(i,{serverURL:o,snapshotLocation:a})))},{})).default||(n.default=this.default),i.abrupt("return",n);case 7:case"end":return i.stop()}},_callee21,this)}));return function MorphicDB_wellKnownMorphicDBs_(){return e.apply(this,arguments)}}()},{key:"addWellKnownMorphicDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee22(e,t){var n,r,i,o;return regeneratorRuntime.wrap(function _callee22$(a){for(;;)switch(a.prev=a.next){case 0:return n=t.name,r=t.snapshotLocation,i=t.serverURL,o=lively_storage.Database.ensureDB("lively.morphic/morphicdb/well-known-morphic-dbs"),a.next=3,o.set(e,{name:n,snapshotLocation:r,serverURL:i});case 3:case"end":return a.stop()}},_callee22,this)}));return function MorphicDB_addWellKnownMorphicDB_(t,n){return e.apply(this,arguments)}}()},{key:"removeWellKnownMorphicDB",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee23(e){var t;return regeneratorRuntime.wrap(function _callee23$(n){for(;;)switch(n.prev=n.next){case 0:return t=lively_storage.Database.ensureDB("lively.morphic/morphicdb/well-known-morphic-dbs"),n.next=3,t.remove(e);case 3:case"end":return n.stop()}},_callee23,this)}));return function MorphicDB_removeWellKnownMorphicDB_(t){return e.apply(this,arguments)}}()}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:885,end:9265})}(void 0),SnapshotPackageHelper=function(e){var t=_classRecorder,n=t.hasOwnProperty("SnapshotPackageHelper")&&"function"==typeof t.SnapshotPackageHelper?t.SnapshotPackageHelper:t.SnapshotPackageHelper=function SnapshotPackageHelper(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SnapshotPackageHelper_initialize_(e){this.snapshot=e}},{key:"textSearch",value:function SnapshotPackageHelper_textSearch_(e,t){var n=this,r=e&&e instanceof RegExp,i=[];if(!e)return i;var o=!0,a=!1,s=void 0;try{for(var l,c=function _loop(){var o=l.value,a=o.get(n.snapshot),s=lively_lang.string.lineIndexComputer(a),c=lively_lang.string.lineRanges(a);if(r){var u=lively_lang.string.reMatches(a,e);u.length&&i.push.apply(i,toConsumableArray(u.map(function(e){return Object.assign(e,{commit:t,file:o})})))}else for(var h=0,d=0;(h=a.indexOf(e))>=0;){var p,f=h+d,g=f+e.length,m=s(f),v=(p=a).slice.apply(p,toConsumableArray(c[m]));i.push({match:e,start:f,end:g,length:e.length,line:m,lineString:v,commit:t,file:o}),d+=h+e.length,a=a.slice(h+e.length)}},u=this.filesInPackages()[Symbol.iterator]();!(o=(l=u.next()).done);o=!0)c()}catch(e){a=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(a)throw s}}return i}},{key:"filesInPackages",value:function SnapshotPackageHelper_filesInPackages_(){var e=[];for(var t in this.snapshot.packages)collectFiles(this.snapshot.packages[t],[t],t,null,e);return e;function collectFiles(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];if(e["package.json"]&&"string"==typeof e["package.json"])try{var o=JSON.parse(e["package.json"]);r={url:n,path:t,name:o.name||lively_lang.arr.last(t)}}catch(e){}var a=[];for(var s in e)"string"==typeof e[s]?i.push({path:t.concat(s),url:lively_lang.string.joinPath(n,s),package:r,get:function get(e){return lively_lang.Path(this.path).get(e.packages)},set:function set(e,t){lively_lang.Path(this.path).set(e.packages,t)}}):a.push(s);return a.forEach(function(o){return collectFiles(e[o],t.concat(o),lively_lang.string.joinPath(n,o),r,i)}),i}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:9275,end:12284})}(void 0),loadPart=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var t,n,r,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return t=o.morphicDB||MorphicDB.default,a.next=3,t.load("part","string"==typeof e?e:e.name,o,"string"==typeof e?void 0:e);case 3:return(n=a.sent).isWindow&&n.targetMorph&&(r=n.targetMorph,(i=n.metadata&&n.metadata.commit)&&r.changeMetaData("commit",i,!0,!1)),a.abrupt("return",n);case 6:case"end":return a.stop()}},_callee,this)}));return function loadPart(t){return e.apply(this,arguments)}}(),savePart=(_ref2=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e,t,n,r,i,o){var a,s,l,c,u,h=this;return regeneratorRuntime.wrap(function _callee3$(d){for(;;)switch(d.prev=d.next){case 0:if(d.prev=0,!e.isMorph){d.next=5;break}return d.delegateYield(regeneratorRuntime.mark(function _callee2(){var t,n,r,i,o,s;return regeneratorRuntime.wrap(function _callee2$(l){for(;;)switch(l.prev=l.next){case 0:t=[],e.withAllSubmorphsDo(function(e){"function"==typeof e.beforePublish&&t.push(e)}),n=!0,r=!1,i=void 0,l.prev=5,o=t[Symbol.iterator]();case 7:if(n=(s=o.next()).done){l.next=14;break}return a=s.value,l.next=11,a.beforePublish();case 11:n=!0,l.next=7;break;case 14:l.next=20;break;case 16:l.prev=16,l.t0=l.catch(5),r=!0,i=l.t0;case 20:l.prev=20,l.prev=21,!n&&o.return&&o.return();case 23:if(l.prev=23,!r){l.next=26;break}throw i;case 26:return l.finish(23);case 27:return l.finish(20);case 28:case"end":return l.stop()}},_callee2,h,[[5,16,20,28],[21,,23,27]])})(),"t0",3);case 3:d.next=8;break;case 5:if("function"!=typeof e.beforePublish){d.next=8;break}return d.next=8,e.beforePublish(t,e);case 8:d.next=14;break;case 10:d.prev=10,d.t1=d.catch(0),s="Error in beforePublish of "+e+"\n"+d.t1.stack,"function"==typeof e.world&&e.world()?e.world().logError(new Error(s)):console.error(s);case 14:return l=Object.assign({previewWidth:100,previewHeight:100,previewType:"png"},n),c=n.morphicDB||MorphicDB.default,d.next=18,c.snapshotAndCommit("part",t,e,l,r,i,o);case 18:return u=d.sent,lively_notifications.emit("lively.partsbin/partpublished",u),d.abrupt("return",u);case 21:case"end":return d.stop()}},_callee3,this,[[0,10]])})),function savePart(e,t,n,r,i,o){return _ref2.apply(this,arguments)}),_ref2,interactivelySavePart=(_ref3=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k,S,C,M,T,P,A,L,R,E,O,z,D,I,F,j,B,N,W,H,V,G,q,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee4$($){for(;;)switch($.prev=$.next){case 0:if(t=U.showPublishDialog,n=void 0===t||t,r=U.notifications,i=void 0===r||r,o=U.loadingIndicator,a=void 0===o||o,s=U.preferWindow,l=void 0===s||s,c=void 0,u=void 0,h=e,d=e.world()||e.env.world,p=e.name,f=[],g="",m=lively_lang.Path("metadata.commit").get(e)||lively_lang.Path("metadata.commit").get(h),v=U.morphicDB||MorphicDB.default,m||(m={type:"part",name:e.name,author:d.getCurrentUser(),tags:[],description:"no description"}),!n){$.next=23;break}return $.t0=d,$.next=8,loadPart("publish part dialog");case 8:return $.t1=$.sent,$.t2={part:e},$.next=12,$.t0.openPrompt.call($.t0,$.t1,$.t2);case 12:if(y=$.sent,_=y.db,b=y.commit){$.next=17;break}return $.abrupt("return",null);case 17:_&&(U.morphicDB=v=_),p=b.name,f=b.tags,g=b.description,$.next=24;break;case 23:m&&(p=(x=m).name,f=x.tags,g=x.description);case 24:if(!a){$.next=28;break}return w=LoadingIndicator.open("saving "+p+"..."),$.next=28,lively_lang.promise.delay(80);case 28:if($.prev=28,k="HEAD",S=m?m.name:e.name,C=void 0,S===p){$.next=46;break}return $.next=33,v.exists("part",p);case 33:if(M=$.sent,T=M.exists,P=M.commitId,!T){$.next=43;break}return $.next=39,d.confirm('A part "'+p+'" already exists, overwrite?');case 39:if($.sent){$.next=42;break}return $.abrupt("return",null);case 42:C=P;case 43:h.name=p,$.next=47;break;case 46:C=m?m._id:void 0;case 47:return l&&!e.isWindow&&(A=e.getWindow())&&A.targetMorph===e&&(e=A,u=A.metadata,c=!0),L={author:e.world().getCurrentUser(),message:"published",tags:f,description:g},$.next=51,savePart(e,p,U,L,k,C);case 51:return R=$.sent,c&&(h.metadata?h.metadata.commit=A.metadata.commit:h.metadata={commit:A.metadata.commit},A.metadata=u),i&&e.setStatusMessage("saved part "+p),$.abrupt("return",R);case 57:if($.prev=57,$.t3=$.catch(28),E=$.t3.message.match(/Trying to store "([^\"]+)" on top of expected version ([^\s]+) but ref HEAD is of version ([^\s\!]+)/)||[],O=slicedToArray(E,4),O[0],O[1],z=O[2],D=O[3],!z||!D){$.next=77;break}return $.next=63,v.log(D,1,!0);case 63:return I=$.sent,F=slicedToArray(I,1),j=F[0],B=j.author.name,N=j.timestamp,W="The current version of part "+p+" is not the most recent!\nA newer version by "+B+" was saved on "+lively_lang.date.format(new Date(N),"yyyy-mm-dd HH:MM")+". Overwrite?",$.next=71,d.confirm(W);case 71:if($.sent){$.next=74;break}return $.abrupt("return",null);case 74:return H=lively_lang.obj.dissoc(j,["preview"]),h.changeMetaData("commit",H,!0,!1),$.abrupt("return",interactivelySavePart(h,Object.assign({},U,{morphicDB:v,showPublishDialog:!1})));case 77:if(V=$.t3.message.match(/Trying to store "([^\"]+)" on top of expected version ([^\s]+) but no version entry exists/)||[],G=slicedToArray(V,3),G[0],G[1],!G[2]){$.next=87;break}return q="Part "+p+" no longer exist in the object database.\nDo you still want to publish it?",$.next=82,d.confirm(q);case 82:if($.sent){$.next=85;break}return $.abrupt("return",null);case 85:return h.changeMetaData("commit",null,!0,!1),$.abrupt("return",interactivelySavePart(h,Object.assign({},U,{morphicDB:v,showPublishDialog:!1})));case 87:throw console.error($.t3),i&&d.logError("Error saving part: "+$.t3),$.t3;case 90:return $.prev=90,w&&w.remove(),$.finish(90);case 93:case"end":return $.stop()}},_callee4,this,[[28,57,90,93]])})),function interactivelySavePart(e){return _ref3.apply(this,arguments)}),_ref3,saveObjectToPartsbinFolder=(_ref15=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e,t){var n,r,i,o,a,s=this,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function _callee8$(c){for(;;)switch(c.prev=c.next){case 0:if((l=Object.assign({preferWindow:!0},l)).preferWindow&&(n=e.getWindow(),e=n&&n.targetMorph===e?n:e),c.prev=2,!e.isMorph){c.next=7;break}return c.delegateYield(regeneratorRuntime.mark(function _callee7(){var t,n,i,o,a,l;return regeneratorRuntime.wrap(function _callee7$(s){for(;;)switch(s.prev=s.next){case 0:t=[],e.withAllSubmorphsDo(function(e){"function"==typeof e.beforePublish&&t.push(e)}),n=!0,i=!1,o=void 0,s.prev=5,a=t[Symbol.iterator]();case 7:if(n=(l=a.next()).done){s.next=14;break}return r=l.value,s.next=11,r.beforePublish();case 11:n=!0,s.next=7;break;case 14:s.next=20;break;case 16:s.prev=16,s.t0=s.catch(5),i=!0,o=s.t0;case 20:s.prev=20,s.prev=21,!n&&a.return&&a.return();case 23:if(s.prev=23,!i){s.next=26;break}throw o;case 26:return s.finish(23);case 27:return s.finish(20);case 28:case"end":return s.stop()}},_callee7,s,[[5,16,20,28],[21,,23,27]])})(),"t0",5);case 5:c.next=10;break;case 7:if("function"!=typeof e.beforePublish){c.next=10;break}return c.next=10,e.beforePublish(t,e);case 10:c.next=16;break;case 12:c.prev=12,c.t1=c.catch(2),i="Error in beforePublish of "+e+"\n"+c.t1.stack,"function"==typeof e.world&&e.world()?e.world().logError(new Error(i)):console.error(i);case 16:return c.next=18,lively_resources.resource(l.partsbinFolder).ensureExistance();case 18:return o=lively_resources.resource(l.partsbinFolder).join(t+".json"),c.next=21,createMorphSnapshot(e,l);case 21:return a=c.sent,c.next=24,o.write(JSON.stringify(a,null,2));case 24:return c.abrupt("return",{partName:t,url:o.url});case 25:case"end":return c.stop()}},_callee8,this,[[2,12]])})),function saveObjectToPartsbinFolder(e,t){return _ref15.apply(this,arguments)}),_ref15,loadObjectFromPartsbinFolder=(_ref16=asyncToGenerator(regeneratorRuntime.mark(function _callee9(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee9$(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",loadPart(e,t));case 1:case"end":return n.stop()}},_callee9,this)})),function loadObjectFromPartsbinFolder(e){return _ref16.apply(this,arguments)}),_ref16,SnapshotEditor=function(e){var t=_classRecorder,n=t.hasOwnProperty("SnapshotEditor")&&"function"==typeof t.SnapshotEditor?t.SnapshotEditor:t.SnapshotEditor=function SnapshotEditor(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SnapshotEditor_initialize_(e,t,n){this.commit=e,this.snapshot=t,this._db=n}},{key:"db",get:function get(){return this._db||MorphicDB.default}},{key:"saveModifiedSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee10(e,t){var n,r,i,o;return regeneratorRuntime.wrap(function _callee10$(a){for(;;)switch(a.prev=a.next){case 0:if(r=(n=e)._id,i=n.name,o=n.type,r){a.next=3;break}throw new Error("No id of commit, cannot save!");case 3:return a.next=5,this.db.commit(o,i,t,e,void 0,r);case 5:return e=a.sent,this.commit=e,this.snapshot=t,a.abrupt("return",e);case 9:case"end":return a.stop()}},_callee10,this)}));return function SnapshotEditor_saveModifiedSnapshot_(t,n){return e.apply(this,arguments)}}()},{key:"interactivelySaveModifiedSnapshot",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee12(e,t){var n,r,i,o,a;return regeneratorRuntime.wrap(function _callee12$(s){for(;;)switch(s.prev=s.next){case 0:return n=lively_lang.promise.deferred(),r=n.promise,i=n.resolve,o=n.reject,a=this,Object.assign(buildCommitEditor(),{commit:Object.assign({},this.commit,{},e),cancel:function cancel(){(this.getWindow()||this).remove(),o("canceled")},accept:function accept(){var e=this;return asyncToGenerator(regeneratorRuntime.mark(function _callee11(){var n;return regeneratorRuntime.wrap(function _callee11$(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,a.saveModifiedSnapshot(e.commit,t);case 3:n=r.sent,(e.getWindow()||e).remove(),i(e.commit=n),r.next=12;break;case 8:r.prev=8,r.t0=r.catch(0),e.showError(r.t0),o(r.t0);case 12:case"end":return r.stop()}},_callee11,e,[[0,8]])}))()}}).openInWindow({title:"commit"}),s.abrupt("return",r);case 3:case"end":return s.stop()}},_callee12,this)}));return function SnapshotEditor_interactivelySaveModifiedSnapshot_(t,n){return e.apply(this,arguments)}}()},{key:"interactivelyEditMetadata",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee13(e){var t;return regeneratorRuntime.wrap(function _callee13$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.interactivelySaveModifiedSnapshot(this.commit,this.snapshot);case 2:return t=n.sent,"function"==typeof e&&e({commit:t,snapshot:this.snapshot}),n.abrupt("return",t);case 5:case"end":return n.stop()}},_callee13,this)}));return function SnapshotEditor_interactivelyEditMetadata_(t){return e.apply(this,arguments)}}()},{key:"interactivelyEditSnapshotJSON",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee16(e){var t,n,r,i,o,a,s,l,c=this;return regeneratorRuntime.wrap(function _callee16$(u){for(;;)switch(u.prev=u.next){case 0:return t=this.commit,n=this.snapshot,i=(r=t)._id,o=r.name,a=r.type,r.author,s=void 0,u.next=10,System.import("lively.ide/text-editor.js");case 10:l=u.sent,l.default.openURL("<"+a+"/"+o+">",{historyId:"object-serialization-debugger-editor",customSaveAction:function(){var r=asyncToGenerator(regeneratorRuntime.mark(function _callee14(r){var o,a,l;return regeneratorRuntime.wrap(function _callee14$(u){for(;;)switch(u.prev=u.next){case 0:if(u.t0=n,u.t0){u.next=5;break}return u.next=4,c.db.fetchSnapshot(void 0,void 0,i);case 4:u.t0=u.sent;case 5:if(o=u.t0,JSON.stringify(o,null,2)===s){u.next=13;break}return u.next=10,$world.confirm("Content change since loading, save anyway");case 10:if(u.sent){u.next=13;break}return u.abrupt("return",{saved:!1,message:"canceled"});case 13:return a=JSON.parse(r.ui.contentText.textString),u.next=16,c.interactivelySaveModifiedSnapshot(c.commit,a);case 16:return t=u.sent,n=a,s=r.ui.contentText.textString,l={saved:!0,snapshot:a,commit:t},"function"==typeof e&&e(l),u.abrupt("return",l);case 22:case"end":return u.stop()}},_callee14,c)}));return function customSaveAction(e){return r.apply(this,arguments)}}(),customLoadContentAction:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee15(e,t){var r;return regeneratorRuntime.wrap(function _callee15$(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=n,e.t0){e.next=5;break}return e.next=4,c.db.fetchSnapshot(void 0,void 0,i);case 4:e.t0=e.sent;case 5:return r=e.t0,e.abrupt("return",{content:s=JSON.stringify(r,null,2),url:a+"/"+o+".json"});case 7:case"end":return e.stop()}},_callee15,c)}));return function customLoadContentAction(t,n){return e.apply(this,arguments)}}()});case 13:case"end":return u.stop()}},_callee16,this)}));return function SnapshotEditor_interactivelyEditSnapshotJSON_(t){return e.apply(this,arguments)}}()},{key:"interactivelyEditPackageCode",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee17(e){var t,n,r,i,o,a,s,l,c;return regeneratorRuntime.wrap(function _callee17$(u){for(;;)switch(u.prev=u.next){case 0:if(t=this.commit,n=this.snapshot,r=t._id,t.author,t.name,t.type,u.t0=n,u.t0){u.next=11;break}return u.next=10,this.db.fetchSnapshot(void 0,void 0,r);case 10:u.t0=u.sent;case 11:return i=u.t0,o=new SnapshotPackageHelper(i).filesInPackages(),a=o.map(function(e){return{isListItem:!0,string:e.url,value:e}}),u.next=16,$world.filterableListPrompt("select file to edit",a,{historyId:"object-serialization-debugger-hist"});case 16:if(s=u.sent,l=slicedToArray(s.selected,1),c=l[0]){u.next=21;break}return u.abrupt("return");case 21:return u.abrupt("return",this.interactivelyEditFileInSnapshotPackage(c,e));case 22:case"end":return u.stop()}},_callee17,this)}));return function SnapshotEditor_interactivelyEditPackageCode_(t){return e.apply(this,arguments)}}()},{key:"interactivelyEditFileInSnapshotPackage",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee19(e,t,n){var r,i,o,a,s,l,c,u,h,d,p=this;return regeneratorRuntime.wrap(function _callee19$(f){for(;;)switch(f.prev=f.next){case 0:if(r=this.snapshot,i=this.commit,o=i._id,i.author,a=i.name,s=i.type,f.t0=r,f.t0){f.next=11;break}return f.next=10,this.db.fetchSnapshot(void 0,void 0,o);case 10:f.t0=f.sent;case 11:return l=f.t0,c=e.get(l),f.next=15,System.import("lively.ide/text-editor.js");case 15:return u=f.sent,h=u.default,d=h.openURL("<"+s+"/"+a+" - "+e.path.slice(1).join("/")+">",{historyId:"interactivelyEditFileInSnapshotPackage-hist",customSaveAction:function(){var n=asyncToGenerator(regeneratorRuntime.mark(function _callee18(n){var r;return regeneratorRuntime.wrap(function _callee18$(i){for(;;)switch(i.prev=i.next){case 0:if(e.get(l)===c){i.next=7;break}return i.next=4,$world.confirm("Content change since loading, save anyway");case 4:if(i.sent){i.next=7;break}return i.abrupt("return",{saved:!1,message:"canceled"});case 7:return e.set(l,n.ui.contentText.textString),i.next=10,p.interactivelySaveModifiedSnapshot(p.commit,l);case 10:return p.commit=i.sent,r={commit:p.commit,snapshot:l,saved:!0},"function"==typeof t&&t(r),i.abrupt("return",r);case 14:case"end":return i.stop()}},_callee18,p)}));return function customSaveAction(e){return n.apply(this,arguments)}}(),customLoadContentAction:function customLoadContentAction(t,n){return{content:e.get(l),url:e.url}}}),n&&d.whenRendered().then(function(){return d.lineNumber=n.row}),f.abrupt("return",d);case 20:case"end":return f.stop()}},_callee19,this)}));return function SnapshotEditor_interactivelyEditFileInSnapshotPackage_(t,n,r){return e.apply(this,arguments)}}()}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:9274,end:14184})}(void 0);function buildCommitEditor(e){var t={type:"input",extent:lively_graphics.pt(420,24),fixedWidth:!0,fixedHeight:!0,padding:lively_graphics.Rectangle.inset(4,4),border:{color:lively_graphics.Color.gray,width:1}};return Object.assign(lively_morphic.morph({extent:lively_graphics.pt(420,24),layout:new lively_morphic.VerticalLayout({resizeSubmorphs:!0,spacing:3}),submorphs:[Object.assign({},t,{name:"name input",placeholder:"name"}),Object.assign({},t,{name:"type input",placeholder:"type"}),Object.assign({},t,{name:"timestamp input",placeholder:"timestamp"}),{layout:new lively_morphic.VerticalLayout({resizeSubmorphs:!0,spacing:3}),submorphs:[Object.assign({},t,{name:"author.name input",placeholder:"author name"}),Object.assign({},t,{name:"author.email input",placeholder:"author email"}),Object.assign({},t,{name:"author.realm input",placeholder:"author realm"})]},Object.assign({},t,{name:"tags input",placeholder:"tags"}),Object.assign({},t,{height:70,name:"description input",type:"text"}),Object.assign({},t,{height:70,name:"message input",type:"text"}),Object.assign({},t,{height:70,name:"metadata input",type:"text"}),{layout:new lively_morphic.HorizontalLayout({spacing:3,direction:"centered"}),submorphs:[{type:"button",name:"ok button",label:"OK"},{type:"button",name:"cancel button",label:"Cancel"}]}],name:"commit editor",get ui(){return{metadataInput:this.get("metadata input"),messageInput:this.get("message input"),descriptionInput:this.get("description input"),tagsInput:this.get("tags input"),authorRealmInput:this.get("author.realm input"),authorEmailInput:this.get("author.email input"),authorNameInput:this.get("author.name input"),timestampInput:this.get("timestamp input"),typeInput:this.get("type input"),nameInput:this.get("name input"),cancelButton:this.get("cancel button"),okButton:this.get("ok button")}},set commit(e){this._commit=e;var t=e.name,n=e.type,r=e.timestamp,i=e.author,o=e.tags,a=e.description,s=e.metadata,l=this.ui,c=l.nameInput,u=l.typeInput,h=l.timestampInput,d=l.authorNameInput,p=l.authorEmailInput,f=l.authorRealmInput,g=l.tagsInput,m=l.descriptionInput,v=l.messageInput,y=l.metadataInput;c.input=t,u.input=n,h.input=String(new Date(r)),d.input=i.name,p.input=i.email,f.input=i.realm,g.input=o.join(" "),m.textString=a,v.textString="",y.textString=s?JSON.stringify(s,null,2):""},get commit(){var e=this._commit;if(!e)throw new Error("commit editor does not have a _commit object");var t=this.ui,n=t.nameInput,r=t.typeInput,i=(t.timestampInput,t.authorNameInput),o=t.authorEmailInput,a=t.authorRealmInput,s=t.tagsInput,l=t.descriptionInput,c=t.messageInput,u=t.metadataInput,h=n.input,d=r.input;if(e.name!==h)throw new Error("name does not match _commit.name: "+h+" vs "+e.name);if(e.type!==d)throw new Error("type does not match _commit.type: "+d+" vs "+e.type);return e.author.name=i.input,e.author.email=o.input,e.author.realm=a.input,e.tags=s.input.split(" ").map(function(e){return e.trim()}).filter(Boolean),e.description=l.textString,e.message=c.textString,e.metadata=u.textString?JSON.parse(u.textString):null,e},onLoad:function onLoad(){lively_bindings.connect(this.ui.okButton,"fire",this,"accept"),lively_bindings.connect(this.ui.cancelButton,"fire",this,"cancel")},accept:function accept(){},cancel:function cancel(){}}),e)}var loadLocalConfig=(_ref5=asyncToGenerator(regeneratorRuntime.mark(function _callee5(){var e;return regeneratorRuntime.wrap(function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return e=lively.modules.module("localconfig.js"),t.prev=1,t.next=4,lively_resources.resource(e.id).exists();case 4:if(!t.sent){t.next=7;break}return t.next=7,e.reload({resetEnv:!1,reloadDeps:!1});case 7:t.next=13;break;case 9:t.prev=9,t.t0=t.catch(1),console.error("Error loading localconfig:",t.t0),"undefined"!=typeof $world&&$world.showError("Error loading localconfig.js: "+t.t0);case 13:case"end":return t.stop()}},_callee5,this,[[1,9]])})),function loadLocalConfig(){return _ref5.apply(this,arguments)}),_ref5,setupLivelyShell=(_ref6=asyncToGenerator(regeneratorRuntime.mark(function _callee6(e){var t,n,r,i,o;return regeneratorRuntime.wrap(function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,lively.modules.importPackage("lively.shell");case 2:return a.next=4,lively.modules.module("lively.shell/client-command.js").load();case 4:return t=a.sent,n=t.default,a.next=8,lively.modules.module("lively.shell/client-resource.js").load();case 8:r=a.sent,i=r.resourceExtension,o=e.l2lClient,n.installLively2LivelyServices(o),i.resourceClass.defaultL2lClient=o,lively_resources.registerExtension(i),console.log("[lively] lively.shell setup");case 15:case"end":return a.stop()}},_callee6,this)})),function setupLivelyShell(e){return _ref6.apply(this,arguments)}),_ref6,setupLively2Lively=(_ref9=asyncToGenerator(regeneratorRuntime.mark(function _callee7(e){var t,n,r,i,o;return regeneratorRuntime.wrap(function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:return t=e.getCurrentUser(),n={world:e.name},t&&(n.userToken=t.token,n.userRealm=t.realm),a.next=4,lively.modules.importPackage("lively.2lively");case 4:return a.next=6,lively.modules.module("lively.2lively/client.js").load();case 6:return r=a.sent,i=r.default,a.next=10,i.forLivelyInBrowser(n);case 10:return o=a.sent,console.log("[lively] lively2lively client created "+o),o._onUserChange?reportWorldLoad(e,t):(o._onUserChange=function(e){if(o.isOnline()&&e.user){var t=e.user,n=t.token,r=t.realm;o.info=Object.assign({},o.info,{userToken:n,userRealm:r}),o.unregister().then(function(){return o.register()}).then(function(){return console.log("re-registered after user change")})}},lively.notifications.subscribe("lively.user/userchanged",o._onUserChange,System),o.once("registered",function(){reportWorldLoad(e,t)}),o.on("registered",function(){var t=e.get("user flap");t&&t.updateNetworkIndicator(o)}),o.on("connected",function(){var t=e.get("user flap");t&&t.updateNetworkIndicator(o)}),o.on("reconnecting",function(){var t=e.get("user flap");t&&t.updateNetworkIndicator(o)}),o.on("disconnected",function(){var t=e.get("user flap");t&&t.updateNetworkIndicator(o)})),a.abrupt("return",o);case 14:case"end":return a.stop()}},_callee7,this)})),function setupLively2Lively(e){return _ref9.apply(this,arguments)}),_ref9;function pathForBrowserHistory(e,t){(t=t.trim())&&"?"!==t||(t="");return"/worlds/"+(e=e.replace(/\.json$/,"").replace(/%20/g," "))+t}var loadWorldFromURL=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t,n){var r,i;return regeneratorRuntime.wrap(function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return r=e.isResource?e:lively.resources.resource(System.decanonicalize(e)),i=r.nameWithoutExt(),o.abrupt("return",loadWorldFromDB(i,void 0,t,n));case 2:case"end":return o.stop()}},_callee,this)}));return function loadWorldFromURL(t,n,r){return e.apply(this,arguments)}}(),loadWorldFromCommit=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e,t,n){var r,i,o;return regeneratorRuntime.wrap(function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return r=MorphicDB.default,a.next=3,r.load("world",void 0,n,e);case 3:return i=a.sent,o="undefined"!=typeof document?document.location.search:"",n=Object.assign({pathForBrowserHistory:pathForBrowserHistory(i.name,o)},n),a.abrupt("return",loadWorld(i,t,n));case 7:case"end":return a.stop()}},_callee2,this)}));return function loadWorldFromCommit(t,n,r){return e.apply(this,arguments)}}(),loadWorldFromDB=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e,t,n,r){var i,o,a;return regeneratorRuntime.wrap(function _callee3$(s){for(;;)switch(s.prev=s.next){case 0:return i=MorphicDB.default,s.next=3,i.load("world",e,r,void 0,t||void 0);case 3:return o=s.sent,a="undefined"!=typeof document?document.location.search:"",r=Object.assign({pathForBrowserHistory:pathForBrowserHistory(e,a)},r),s.abrupt("return",loadWorld(o,n,r));case 7:case"end":return s.stop()}},_callee3,this)}));return function loadWorldFromDB(t,n,r,i){return e.apply(this,arguments)}}(),loadWorld=(_ref4=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e,t){var n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function _callee4$(x){for(;;)switch(x.prev=x.next){case 0:if(n=b.env,r=b.verbose,i=void 0===r||r,o=b.localconfig,a=void 0===o||o,s=b.l2l,l=void 0===s||s,c=b.shell,u=void 0===c||c,h=b.worldLoadDialog,d=void 0!==h&&h,p=b.initializeGlobalStyleSheets,f=void 0===p||p,g=b.showUserFlap,m=void 0===g?void 0===e.showsUserFlap||e.showsUserFlap:g,n=n||(t?t.env:MorphicEnv.default()),v=n.domEnv.document||document,y=v.getElementById("dom-loading-indicator"),x.prev=4,x.t0=l,!x.t0){x.next=10;break}return x.next=9,setupLively2Lively(e);case 9:x.t0=x.sent;case 10:if(!(_=x.t0)||!u){x.next=14;break}return x.next=14,setupLivelyShell({l2lClient:_});case 14:return i&&y&&(y.style.display=""),x.next=17,n.setWorld(e);case 17:if(x.t1=a,!x.t1){x.next=21;break}return x.next=21,loadLocalConfig();case 21:return f&&e.whenRendered().then(function(){return e.propertiesAndPropertySettings().properties.styleSheets.initialize.call(e)}),d&&e.execCommand("load world"),b.pathForBrowserHistory&&window.history.pushState({},"lively.next",b.pathForBrowserHistory),e.showsUserFlap=m,t&&t.onUnload(),x.abrupt("return",e);case 29:if(x.prev=29,x.t2=x.catch(4),console.error("Error loading world: ",x.t2),!t){x.next=36;break}return x.next=35,n.setWorld(t);case 35:t.showError(x.t2);case 36:throw x.t2;case 37:return x.prev=37,y&&(y.style.display="none"),x.finish(37);case 40:case"end":return x.stop()}},_callee4,this,[[4,29,37,40]])})),function loadWorld(e,t){return _ref4.apply(this,arguments)}),_ref4,interactivelySaveWorld=(_ref11=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e,t){var n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k,S,C,M,T,P,A,L,R,E,O,z;return regeneratorRuntime.wrap(function _callee8$(D){for(;;)switch(D.prev=D.next){case 0:if(t=Object.assign({showSaveDialog:!0,useExpectedCommit:!0,errorOnMissingExpectedCommit:!1,confirmOverwrite:!0},t),n=e.name,r=[],i="",o=lively_lang.Path("metadata.commit").get(e),a=t.morphicdb||MorphicDB.default,!t.showSaveDialog){D.next=20;break}return D.next=5,loadObjectFromPartsbinFolder("save world dialog");case 5:return s=D.sent,D.next=8,e.openPrompt(s,{targetWorld:e});case 8:if(l=D.sent,c=l.commit,(u=l.db)&&(a=u),n=(h=c||{}).name,r=h.tags,i=h.description,n){D.next=18;break}return D.abrupt("return",null);case 18:D.next=21;break;case 20:o&&(n=o.name,r=o.tags,i=o.description);case 21:return d=LoadingIndicator.open("saving "+n+"..."),D.next=24,lively_lang.promise.delay(80);case 24:if(D.prev=24,p={previewWidth:200,previewHeight:200,previewType:"png"},f="HEAD",g=o?o.name:e.name,m=void 0,!t.useExpectedCommit){D.next=44;break}if(g===n||!t.confirmOverwrite){D.next=43;break}return D.next=30,a.exists("world",n);case 30:if(v=D.sent,y=v.exists,_=v.commitId,!y){D.next=40;break}return D.next=36,e.confirm('A world "'+n+'" already exists, overwrite?',{styleClasses:["Halo"],fill:lively_graphics.Color.rgba(0,0,0,.8)});case 36:if(D.sent){D.next=39;break}return D.abrupt("return",null);case 39:m=_;case 40:e.name=n,D.next=44;break;case 43:m=o?o._id:void 0;case 44:return b={author:e.getCurrentUser(),message:"world save",tags:r,description:i},D.next=47,a.snapshotAndCommit("world",n,e,p,b,f,m);case 47:return x=D.sent,window.history&&(w="undefined"!=typeof document?document.location.search:"",k=pathForBrowserHistory(n,w),window.history.pushState({},"lively.next",k)),e.setStatusMessage("saved world "+n),e.get("world-list")&&e.get("world-list").onWorldSaved(n),D.abrupt("return",x);case 54:if(D.prev=54,D.t0=D.catch(24),!D.t0.message.includes("but no version entry exists")||t.errorOnMissingExpectedCommit){D.next=58;break}return D.abrupt("return",interactivelySaveWorld(e,Object.assign({},t,{morphicdb:a,useExpectedCommit:!1,showSaveDialog:!1})));case 58:if(S=D.t0.message.match(/Trying to store "([^\"]+)" on top of expected version ([^\s]+) but ref HEAD is of version ([^\s\!]+)/)||[],C=slicedToArray(S,4),C[0],C[1],M=C[2],T=C[3],!M||!T){D.next=75;break}return D.next=62,a.log(T,1,!0);case 62:if(P=D.sent,A=slicedToArray(P,1),L=A[0],R=!0,!t.confirmOverwrite){D.next=71;break}return E=L.author.name,O=L.timestamp,z="The current version of world "+n+" is not the most recent!\nA newer version by "+E+" was saved on "+lively_lang.date.format(new Date(O),"yyyy-mm-dd HH:MM")+". Overwrite?",D.next=70,e.confirm(z);case 70:R=D.sent;case 71:if(R){D.next=73;break}return D.abrupt("return",null);case 73:return e.changeMetaData("commit",lively_lang.obj.dissoc(L,["preview"]),!0,!1),D.abrupt("return",interactivelySaveWorld(e,Object.assign({},t,{morphicdb:a,showSaveDialog:!1})));case 75:console.error(D.t0),e.logError("Error saving world: "+D.t0);case 77:return D.prev=77,d.remove(),D.finish(77);case 80:case"end":return D.stop()}},_callee8,this,[[24,54,77,80]])})),function interactivelySaveWorld(e,t){return _ref11.apply(this,arguments)}),_ref11;function reportWorldLoad(e,t){var n=t?t.name+" ("+(t.token||"").slice(0,5)+")":"---";fetch("/report-world-load",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n+" logged in at "+e.name+" ["+window._livelyLoadId+"]"})}).catch(function(e){return console.warn("report-world-load failed: "+e)})}var migrations=[{date:"2017-04-08",name:"Text and Label textAndAttributes format change",description:"\nChanging the format from\n  [[string1, attr1_1, attr1_2], [string2, attr2_1, attr2_2], ...]\nto\n  [string1, attr1, string2, attr2, ...].\n    ",snapshotConverter:function snapshotConverter(e){var t=e.snapshot;for(var n in t){var r=t[n],i=r.props&&r.props.textAndAttributes;if(i){var o=i.value;if(Array.isArray(o)){if(o.length&&"string"!=typeof o[0]){o=[].concat.apply([],o);for(var a=0;a<o.length;a+=2){o[a];var s=o[a+1];s&&Array.isArray(s)&&(o[a+1]=Object.assign.apply(Object,[{}].concat(toConsumableArray(s))))}r.props.textAndAttributes=Object.assign({},i,{value:o})}}else console.warn("object migrator found textAndAttributes field but it is not an Array!")}}return e}},{date:"2017-04-29",name:"Window button fix",description:'\nA recent change in the structure of windows, that now adds a "button wrapper"\nmorph breaks old windows without it.\n',objectConverter:function objectConverter(e,t){e.snapshot;var n=e.id,r=t.refForId(n).realObj;return r&&r.isMorph&&r.withAllSubmorphsDo(function(e){e.isWindow&&(e.submorphs.some(function(e){return"button wrapper"===e.name})&&e.get("button wrapper").submorphs.some(function(e){return"window menu button"===e.name})||e.fixControls(),e.minimizedBounds=null,lively_bindings.disconnectAll(e.get("minimize")),lively_bindings.connect(e.get("minimize"),"onMouseDown",e,"minimized",{updater:function updater(e){e(!this.targetObj.minimized)}}))}),e}},{date:"2017-05-03",name:"Style Sheet Status Fix",description:"\nState management of the style sheets has changes substantially, moving all of the style sheets that are being applied to the world.\n",snapshotConverter:function snapshotConverter(e){var t=e.id,n=e.snapshot;for(var r in n){var i=n[r].props;i&&i.styleSheets&&(i.styleSheets.value||(i.styleSheets.value=[]),i.styleSheets.value=i.styleSheets.value&&i.styleSheets.value.filter(function(e){var t=n[e.id],r=t.props.rules,i=n[r.value.id];return!(t.props.styledMorphs||"lively.serializer-class-info"in i)}))}return lively_serializer2.removeUnreachableObjects([t],n),e}},{date:"2017-05-22",name:"Removal of ChromeTheme and GithubTheme",description:"\nFor now only a simple default theme...\n",snapshotConverter:function snapshotConverter(e){var t=e.snapshot;for(var n in t){var r=t[n],i=r["lively.serializer-class-info"];i&&("ChromeTheme"===i.className||"GithubTheme"===i.className?(i.className="DefaultTheme",i.module.pathInPackage="ide/themes/default.js"):"JavaScriptTokenizer"===i.className&&delete r["lively.serializer-class-info"])}return e}},{date:"2017-06-20",name:"Unwrapped Style Sheet Props",description:"Style Sheets now store foldable props in their nested format.",objectConverter:function objectConverter(e,t){var n=e.id,r=(e.snapshot,t.refForId(n).realObj);return r&&r.isMorph&&r.withAllSubmorphsDo(function(e){e.styleSheets&&e.styleSheets.length>0&&e.styleSheets.forEach(function(e){for(var t in lively_lang.obj.dissoc(e.rules,["_rev"]))e.rules[t]=e.unwrapFoldedProps(e.rules[t])})}),e}},{date:"2017-07-13",name:"Renamed style-rules.js to style-sheets.js",snapshotConverter:function snapshotConverter(e){var t=e.snapshot;for(var n in t){var r=t[n]["lively.serializer-class-info"];r&&("StyleSheet"===r.className&&(r.module.pathInPackage="style-sheets.js"))}return e}},{date:"2017-07-26",name:"components, ide, and halo extraction",snapshotConverter:function snapshotConverter(e){var t=e.snapshot,n=e.packages,r=n&&n["local://lively-object-modules/"]||{},i=[["lively.morphic/halo","lively.halos"],["lively.morphic/components/markers.js","lively.halos"],["lively.morphic/components/icons.js","lively.morphic"],["lively.morphic/components/loading-indicator.js","lively.components",function(e){return"{"+e+"}"}],["lively.morphic/components","lively.components"],["lively.components/markers.js","lively.halos"],["lively.morphic/ide","lively.ide"],["lively.morphic/text/ui.js","lively.ide",null,"text/ui.js"]];for(var o in r){var a=r[o]["index.js"],s=!0,l=!1,c=void 0;try{for(var u,h=i[Symbol.iterator]();!(s=(u=h.next()).done);s=!0){var d=slicedToArray(u.value,3),p=d[0],f=d[1],g=d[2];if(g){var m=new RegExp('(import\\s)(.*)(\\sfrom \\"'+p+")","g"),v=m.exec(a);v&&(a=a.replace(m,"import "+g(v[2])+'from "'+f))}else{var y=new RegExp(p,"g");a=a.replace(y,f)}}}catch(e){l=!0,c=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw c}}r[o]["index.js"]=a}for(var _ in t){var b=t[_]["lively.serializer-class-info"];if(b&&b.module){var x=b.module.package.name+"/"+b.module.pathInPackage,w=!0,k=!1,S=void 0;try{for(var C,M=i[Symbol.iterator]();!(w=(C=M.next()).done);w=!0){var T=slicedToArray(C.value,4),P=(p=T[0],f=T[1],T[2],T[3]);if(x.includes(p)){b.module.package.name=f,b.module.package.version="0.1.0",b.module.pathInPackage=P||x.substring(x.indexOf(p)+p.length+1)||"index.js";break}}}catch(e){k=!0,S=e}finally{try{!w&&M.return&&M.return()}finally{if(k)throw S}}}}return e}},{date:"2017-10-16",name:"change scroll implementation of list items",objectConverter:function objectConverter(e,t){var n=!0,r=!1,i=void 0;try{for(var o,a=t.objectRefs()[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value.realObj;s.isList&&"function"==typeof s.initializeSubmorphs&&s.initializeSubmorphs()}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return e}},{date:"2017-10-30",name:"change implementation of tree",snapshotConverter:function snapshotConverter(e){var t=e.snapshot;for(var n in t){var r=t[n],i=r["lively.serializer-class-info"];i&&i.module&&("Tree"==i.className&&r.props.submorphs&&(r.props.submorphs.value=[]),"TreeNode"==i.className&&delete t[n],"InspectorTreeData"==i.className&&delete t[n],["PropertyNode","InspectionNode","MorphNode","FoldedNode"].includes(i.className)&&(i.module.pathInPackage="js/inspector/context.js"),"nodeItemContainer"==r.props.name&&delete t[n])}return e}}],resourceToJSON=(_ref8=asyncToGenerator(regeneratorRuntime.mark(function _callee6(e,t){var n,r,i,o,a,s,l,c;return regeneratorRuntime.wrap(function _callee6$(u){for(;;)switch(u.prev=u.next){case 0:if(e.isDirectory()){u.next=7;break}return u.next=3,e.read();case 3:return t[e.name()]=u.sent,u.abrupt("return",t);case 7:return n=t[e.name()]={},u.next=10,e.dirList();case 10:r=u.sent,i=!0,o=!1,a=void 0,u.prev=14,s=r[Symbol.iterator]();case 16:if(i=(l=s.next()).done){u.next=23;break}return c=l.value,u.next=20,resourceToJSON(c,n);case 20:i=!0,u.next=16;break;case 23:u.next=29;break;case 25:u.prev=25,u.t0=u.catch(14),o=!0,a=u.t0;case 29:u.prev=29,u.prev=30,!i&&s.return&&s.return();case 32:if(u.prev=32,!o){u.next=35;break}throw a;case 35:return u.finish(32);case 36:return u.finish(29);case 37:return u.abrupt("return",t);case 38:case"end":return u.stop()}},_callee6,this,[[14,25,29,37],[30,,32,36]])})),function resourceToJSON(e,t){return _ref8.apply(this,arguments)}),_ref8;function normalizeOptions(e){return(e=Object.assign({reinitializeIds:!1},e)).reinitializeIds&&(e.reinitializeIds="function"==typeof e.reinitializeIds?e.reinitializeIds:function(e,t){return t.realObj.isMorph?newMorphId$$1(t.realObj.constructor):null}),e}function serializeMorph(e,t){return lively_serializer2.serialize(e,normalizeOptions(t))}function deserializeMorph(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return lively_serializer2.deserializeWithMigrations(e,t.migrations||migrations,normalizeOptions(t))}function copyMorph(e){return deserializeMorph(serializeMorph(e),{migrations:migrations,reinitializeIds:!0})}var objectScriptingEnabled=!1,createMorphSnapshot=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee5(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x=this,w=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee5$(k){for(;;)switch(k.prev=k.next){case 0:if(t=System.get("@system-env").node,n=w.addPreview,r=void 0===n?!t:n,i=w.previewWidth,o=void 0===i?100:i,a=w.previewHeight,s=void 0===a?100:a,l=w.previewType,c=void 0===l?"png":l,u=w.testLoad,h=void 0===u||u,d=w.addPackages,p=void 0===d||d,f=serializeMorph(e),!p){k.next=4;break}return k.delegateYield(regeneratorRuntime.mark(function _callee4(){var e,t,n,r,i,o,a,s,l,c,u,h;return regeneratorRuntime.wrap(function _callee4$(d){for(;;)switch(d.prev=d.next){case 0:for(o in e=f.packages={},t=f.snapshot,n=[],r={},i=!0,t)if((a=t[o]["lively.serializer-class-info"])&&a.module&&a.module.package&&(s=lively_modules.getPackage(a.module.package.name)).address.startsWith("local://")&&n.push(s),(l=t[o].props.metadata)&&(c=void 0,l.value&&l.value.__ref__?(u=t[l.value.id]).props.externalPackages&&(c=u.props.externalPackages.value):c=l.externalPackages,c))for(i=!0,h=0;h<c.length;h++)r[c[h]]=!0;return i&&(f.packagesToRegister=Object.keys(r)),d.next=5,Promise.all(n.map(function(){var t=asyncToGenerator(regeneratorRuntime.mark(function _callee3(t){var n,r;return regeneratorRuntime.wrap(function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:return n=lively_resources.resource(t.address).asDirectory(),i.next=3,resourceToJSON(n,{});case 3:r=i.sent,e[n.parent().url]||(e[n.parent().url]={}),Object.assign(e[n.parent().url],r);case 6:case"end":return i.stop()}},_callee3,x)}));return function(e){return t.apply(this,arguments)}}()));case 5:case"end":return d.stop()}},_callee4,x)})(),"t0",4);case 4:if(!r){k.next=24;break}return k.next=7,System.import("lively.morphic/rendering/morph-to-image.js");case 7:return g=k.sent,m=g.renderMorphToDataURI,v=o||e.width,y=s||e.height,_=c||"png",k.prev=12,k.next=15,m(e,{width:v,height:y,type:_});case 15:f.preview=k.sent,k.next=24;break;case 18:return k.prev=18,k.t1=k.catch(12),console.error("Error generating morph preview: "+k.t1),k.next=23,m(new Morph({fill:e.fill,width:v,height:y}),{width:v,height:y,type:_});case 23:f.preview=k.sent;case 24:if(f.preview||(f.preview=""),!h){k.next=37;break}return k.prev=26,k.next=29,loadMorphFromSnapshot$$1(f);case 29:if((b=k.sent)&&b.isMorph){k.next=32;break}throw new Error("reloading snapshot does not create a morph!");case 32:k.next=37;break;case 34:throw k.prev=34,k.t2=k.catch(26),new Error("Error snapshotting morph: Cannot recreate morph from snapshot!\n"+k.t2.stack);case 37:return k.abrupt("return",f);case 38:case"end":return k.stop()}},_callee5,this,[[12,18],[26,34]])}));return function createMorphSnapshot(t){return e.apply(this,arguments)}}();function loadMorphFromSnapshot$$1(e,t){return deserializeMorph(e,Object.assign({reinitializeIds:!0,ignoreClassNotFound:!1,onDeserializationStart:loadPackagesAndModulesOfSnapshot,migrations:migrations},t))}function findPackagesInFileSpec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=[];if(e.hasOwnProperty("package.json")){var r=t.slice(1).reduceRight(function(e,t){return e.join(t)},lively_resources.resource(t[0])).url;n.push({files:e,url:r})}for(var i in e)"object"===_typeof(e[i])&&n.push.apply(n,toConsumableArray(findPackagesInFileSpec(e[i],t.concat(i))));return n}function packagesOfSnapshot(e){return findPackagesInFileSpec(e.packages)}var loadPackagesAndModulesOfSnapshot=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee7(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w;return regeneratorRuntime.wrap(function _callee7$(k){for(;;)switch(k.prev=k.next){case 0:if(!e.packagesToRegister){k.next=33;break}t=!0,n=!1,r=void 0,k.prev=4,i=e.packagesToRegister[Symbol.iterator]();case 6:if(t=(o=i.next()).done){k.next=19;break}return a=o.value,k.prev=8,k.next=11,lively_modules.registerPackage(a);case 11:k.next=16;break;case 13:k.prev=13,k.t0=k.catch(8),console.error("Failed to register package "+a);case 16:t=!0,k.next=6;break;case 19:k.next=25;break;case 21:k.prev=21,k.t1=k.catch(4),n=!0,r=k.t1;case 25:k.prev=25,k.prev=26,!t&&i.return&&i.return();case 28:if(k.prev=28,!n){k.next=31;break}throw r;case 31:return k.finish(28);case 32:return k.finish(25);case 33:if(!e.packages){k.next=86;break}s=packagesOfSnapshot(e),l=!0,c=!1,u=void 0,k.prev=38,h=s[Symbol.iterator]();case 40:if(l=(d=h.next()).done){k.next=72;break}if(p=d.value,f=p.files,g=p.url,m=lively_modules.lookupPackage(g),!(v=m&&m.pkg)){k.next=55;break}if(y=v.version,_=JSON.parse(f["package.json"]),b=_.version,k.prev=46,!(b&&y&&lively_modules.semver.lte(b,y,!0))){k.next=50;break}return console.log("[load morph] Package "+g+" is loaded in version "+y+" which is newer than "+b+". Will NOT load older variant."),k.abrupt("continue",69);case 50:k.next=55;break;case 52:k.prev=52,k.t2=k.catch(46),console.warn("Error in package version comparison: ",k.t2);case 55:return k.next=57,lively_resources.createFiles(g,f);case 57:return k.sent,k.next=60,lively_modules.ensurePackage(g);case 60:return v=k.sent,k.next=63,v.reload({forgetEnv:!1,forgetDeps:!1});case 63:return k.next=65,System.import("lively.classes/object-classes.js");case 65:x=k.sent,w=x.default,(objectScriptingEnabled=!!w)&&w.withId(v.name);case 69:l=!0,k.next=40;break;case 72:k.next=78;break;case 74:k.prev=74,k.t3=k.catch(38),c=!0,u=k.t3;case 78:k.prev=78,k.prev=79,!l&&h.return&&h.return();case 81:if(k.prev=81,!c){k.next=84;break}throw u;case 84:return k.finish(81);case 85:return k.finish(78);case 86:return k.next=88,Promise.all(lively_serializer2.requiredModulesOfSnapshot(e).map(function(e){return(System.get(e)?null:System.import(e)).catch(function(t){return console.error("Error loading "+e,t)})}));case 88:case"end":return k.stop()}},_callee7,this,[[4,21,25,33],[8,13],[26,,28,32],[38,74,78,86],[46,52],[79,,81,85]])}));return function loadPackagesAndModulesOfSnapshot(t){return e.apply(this,arguments)}}(),SizzleExpression=function(e){var t=_classRecorder,n=t.hasOwnProperty("SizzleExpression")&&"function"==typeof t.SizzleExpression?t.SizzleExpression:t.SizzleExpression=function SizzleExpression(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SizzleExpression_initialize_(e,t){this.matchStacks={},this.context=t,this.compileRule(e)}},{key:"compileRule",value:function SizzleExpression_compileRule_(e){this.compiledRule=[];var t=!0,n=!1,r=void 0;try{for(var i,o=e.split(" ")[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var a=i.value;this.compiledRule.push(this.createMatcher(a))}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}lively_lang.arr.any(this.compiledRule,function(e){return!e})&&(this.compileError=!0)}},{key:"createMatcher",value:function SizzleExpression_createMatcher_(e){return lively_lang.arr.findAndGet([ClassMatcher,NameMatcher,IdMatcher],function(t){return t.create(e)})}},{key:"reset",value:function SizzleExpression_reset_(){this.active=!1,this.matchStacks={}}},{key:"startMatching",value:function SizzleExpression_startMatching_(){this.animated=!1,this.active=!0}},{key:"matches",value:function SizzleExpression_matches_(e){if(this.context==e&&this.startMatching(),!this.active)return!1;var t=e.owner&&this.matchStacks[e.owner.id]||{idx:0},n=t.idx,r=t.revoked,i=t.applied,o=t.animated,a=this.compiledRule[n].matches(e);return a.applied||a.revoked?(a.revoked=a.revoked||r,a.applied=!a.revoked&&(a.applied||i),a.animated=a.animated||o,n<this.compiledRule.length-1?void(this.matchStacks[e.id]=Object.assign({idx:n+1},a)):(this.matchStacks[e.id]=Object.assign({idx:n},a),a)):(this.matchStacks[e.id]={idx:n,revoked:r,applied:i,animated:o},!1)}}],[{key:"compile",value:function SizzleExpression_compile_(e,t){return new this(e,t)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:68,end:1822})}(void 0),Matcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("Matcher")&&"function"==typeof t.Matcher?t.Matcher:t.Matcher=function Matcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Matcher_initialize_(e,t){this.token=t,this.description=e}},{key:"matches",value:function Matcher_matches_(e){return!1}}],[{key:"characterEncoding",get:function get(){return"(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+"}},{key:"create",value:function Matcher_create_(e){var t;if(t=this.appliesTo(e))return new this(e,t)}},{key:"appliesTo",value:function Matcher_appliesTo_(e){return!1}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1824,end:2246})}(void 0),NameMatcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("NameMatcher")&&"function"==typeof t.NameMatcher?t.NameMatcher:t.NameMatcher=function NameMatcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"matches",value:function NameMatcher_matches_(e){return{applied:e.name==this.token,revoked:!1,animated:!1}}}],[{key:"appliesTo",value:function NameMatcher_appliesTo_(e){var t;return this.re||(this.re=new RegExp("^\\[name=['\"]?("+this.characterEncoding+")['\"]?\\]")),(t=this.re.exec(e))&&t[1]}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2248,end:2636})}({referencedAs:"Matcher",value:Matcher}),ClassMatcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("ClassMatcher")&&"function"==typeof t.ClassMatcher?t.ClassMatcher:t.ClassMatcher=function ClassMatcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"matches",value:function ClassMatcher_matches_(e){var t=e._animatedStyleClasses||{removed:[],added:[]},n=t.removed,r=(t.added,t.animation),i=lively_lang.arr.every(this.token,function(t){return e.styleClasses.includes(t)});return{applied:i,revoked:!i&&lively_lang.arr.every(this.token,function(t){return[].concat(toConsumableArray(e.styleClasses),toConsumableArray(n)).includes(t)}),animated:r}}}],[{key:"appliesTo",value:function ClassMatcher_appliesTo_(e){var t=!0,n=[];for(this.re||(this.re=new RegExp("^\\.("+this.characterEncoding+")"));t;)(t=this.re.exec(e))&&(n.push(t[1]),e=e.replace(t[0],""));return!!(lively_lang.string.empty(e)&&n.length>0)&&n}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2638,end:3569})}({referencedAs:"Matcher",value:Matcher}),IdMatcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("IdMatcher")&&"function"==typeof t.IdMatcher?t.IdMatcher:t.IdMatcher=function IdMatcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"matches",value:function IdMatcher_matches_(e){return{applied:e.id==this.token,revoked:!1,animated:!1}}}],[{key:"appliesTo",value:function IdMatcher_appliesTo_(e){this.re||(this.re=new RegExp("^#("+this.characterEncoding+")"));var t=this.re.exec(e);return t&&t[1]}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3571,end:3923})}({referencedAs:"Matcher",value:Matcher}),Sizzle=function(e){var t=_classRecorder,n=t.hasOwnProperty("Sizzle")&&"function"==typeof t.Sizzle?t.Sizzle:t.Sizzle=function Sizzle(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Sizzle_initialize_(e){this.context=e,this.cachedExpressions={}}},{key:"fetchExpressionFor",value:function Sizzle_fetchExpressionFor_(e){var t=this.cachedExpressions[e];return t||(this.cachedExpressions[e]=t=SizzleExpression.compile(e,this.context)),t}},{key:"matches",value:function Sizzle_matches_(e,t){return this.fetchExpressionFor(e).matches(t)}},{key:"select",value:function Sizzle_select_(e){var t=this.fetchExpressionFor(e);return this.context.withAllSubmorphsSelect(function(e){return t.matches(e)})}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3932,end:4478})}(void 0),SizzleVisitor=function(e){var t=_classRecorder,n=t.hasOwnProperty("SizzleVisitor")&&"function"==typeof t.SizzleVisitor?t.SizzleVisitor:t.SizzleVisitor=function SizzleVisitor(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SizzleVisitor_initialize_(e){this.rootMorph=e,this.expressionCache={}}},{key:"deleteFromCache",value:function SizzleVisitor_deleteFromCache_(e){var t=this;e.withAllSubmorphsDo(function(e){delete t.expressionCache[e.id]})}},{key:"retrieveExpressions",value:function SizzleVisitor_retrieveExpressions_(e){throw Error("Not yet implemented!")}},{key:"visitMorph",value:function SizzleVisitor_visitMorph_(e,t){throw Error("Not yet implemented!")}},{key:"getChildren",value:function SizzleVisitor_getChildren_(e){throw Error("Not yet implemented!")}},{key:"visit",value:function SizzleVisitor_visit_(e){var t=this;if(!e)for(var n in e=this.rootMorph,this.morphExpressions=[],this.expressionCache)for(var r in this.expressionCache[n])this.expressionCache[n][r].reset();var i=this.retrieveExpressions(e),o={apply:[],revoke:[]};i&&this.morphExpressions.push([e,i]);var a=!0,s=!1,l=void 0;try{for(var c,u=function _loop(){var n=slicedToArray(c.value,2),r=n[0],i=n[1],a=t.expressionCache[r.id]||{};lively_lang.obj.isArray(i)?i.forEach(function(n){return t.matchExpressions(r,e,n,a,o)}):t.matchExpressions(r,e,i,a,o),t.expressionCache[r.id]=a},h=this.morphExpressions[Symbol.iterator]();!(a=(c=h.next()).done);a=!0)u()}catch(e){s=!0,l=e}finally{try{!a&&h.return&&h.return()}finally{if(s)throw l}}this.getChildren(e).forEach(function(e){t.visit(e)}),this.visitMorph(e,o),i&&this.morphExpressions.pop()}},{key:"matchExpressions",value:function SizzleVisitor_matchExpressions_(e,t,n,r,i){for(var o in n){var a=void 0,s=void 0,l=r[o]||SizzleExpression.compile(o,e);l.compileError||((a=l.matches(t)||{}).applied&&i.apply.push(s=n[o]),a.revoked&&i.revoke.push(s=n[o]),a.animated&&(s.animated=a.animated)),r[o]=l}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:4753,end:8704})}(void 0),StylingVisitor=function(e){var t=_classRecorder,n=t.hasOwnProperty("StylingVisitor")&&"function"==typeof t.StylingVisitor?t.StylingVisitor:t.StylingVisitor=function StylingVisitor(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function StylingVisitor_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.retainedProps={}}},{key:"retrieveExpressions",value:function StylingVisitor_retrieveExpressions_(e){return!(e.styleSheets.length<1)&&e.styleSheets.map(function(e){return e.applicableRules()})}},{key:"visitMorph",value:function StylingVisitor_visitMorph_(e,t){if(e._wantsStyling){var n,r=this.retainedProps[e.id]||{},i={};e._appliedRules=[];var o=!0,a=!1,s=void 0;try{for(var l,c=t.apply[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value,h=u.styleSheet,d=u.rule,p=u.animated;e._appliedRules.push([h,d]),n=h.applyRule(d,e,p),Object.assign(i,n),r=Object.assign({},n,{},r)}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}var f=!0,g=!1,m=void 0;try{for(var v,y=t.revoke[Symbol.iterator]();!(f=(v=y.next()).done);f=!0){var _=v.value,b=(h=_.styleSheet,d=_.rule,p=_.animated,lively_lang.obj.dissoc(lively_lang.obj.select(r,lively_lang.obj.keys(h.rules[d])),lively_lang.obj.keys(i)));p?e.animate(Object.assign({},b,{duration:p.duration,easing:p.easing})):Object.assign(e,b),Object.assign(i,b)}}catch(e){g=!0,m=e}finally{try{!f&&y.return&&y.return()}finally{if(g)throw m}}var x=lively_lang.obj.dissoc(r,lively_lang.obj.keys(i));Object.assign(e,x),r=lively_lang.obj.dissoc(r,lively_lang.obj.keys(x)),delete e._animatedStyleClasses,e._styledProps=i,this.retainedProps[e.id]=r,e._wantsStyling=!1}}},{key:"getChildren",value:function StylingVisitor_getChildren_(e){return e.submorphs.filter(function(e){return e.needsRerender()})}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:8713,end:10943})}({referencedAs:"SizzleVisitor",value:SizzleVisitor}),defaultCommandHandler=new CommandHandler;function newMorphId$$1(e){return("function"==typeof e?e.name:"string"==typeof e?e.toLowerCase():"")+"_"+lively_lang.string.newUUID().replace(/-/g,"_")}function generateUnfolded(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["top","left","right","bottom"],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"core",r={},i=!0,o=!1,a=void 0;try{for(var s,l=function _loop(){var t=s.value;r[e+lively_lang.string.capitalize(t)]={group:n,derived:!0,generated:!0,after:[e],get:function get(){return this.getProperty(e)[t]},set:function set(n){this[e]=Object.assign({},this.getProperty(e),defineProperty({},t,n))}}},c=t[Symbol.iterator]();!(i=(s=c.next()).done);i=!0)l()}catch(e){o=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw a}}return r}var Morph=function(e){var t=_classRecorder,n=t.hasOwnProperty("Morph")&&"function"==typeof t.Morph?t.Morph:t.Morph=function Morph(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Morph_initialize_(e){e||(e={});var t=e.env||MorphicEnv.default();this._env=t,this._rev=t.changeManager.revision,this._owner=null,this._dirty=!0,this._rendering=!1,this._submorphOrderChanged=!1,this._id=newMorphId$$1(this.constructor.name),this._animationQueue=new AnimationQueue(this),this._cachedPaths={},this._pathDependants=[],this._tickingScripts=[],this.initializeProperties(e),e.bounds&&this.setBounds(e.bounds);var n=Object.getOwnPropertyDescriptors(e),r={},i={env:!0,type:!0,submorphs:!0,bounds:!0,layout:!0},o=this.propertiesAndPropertySettings().properties;for(var a in n)a in i||a in o||(r[a]=n[a]);Object.defineProperties(this,r),e.layout&&(this.layout=e.layout),"function"==typeof this.onLoad&&this.onLoad()}},{key:"__serialization_id_property__",get:function get(){return"_id"}},{key:"__deserialize__",value:function Morph___deserialize___(e,t){this._env=MorphicEnv.default(),this._rev=e.rev,this._owner=null,this._dirty=!0,this._rendering=!1,this._submorphOrderChanged=!1,this._id=t.id,this._animationQueue=new AnimationQueue(this),this._cachedPaths={},this._pathDependants=[],this._tickingScripts=[],this.initializeProperties()}},{key:"__after_deserialize__",value:function Morph___after_deserialize___(){if(this.resumeStepping(),"function"==typeof this.onLoad)try{this.onLoad()}catch(e){console.error("[lively.morphic] "+this+".onLoad() error: "+e.stack)}}},{key:"__only_serialize__",get:function get(){var e=this.defaultProperties,t=this.propertiesAndPropertySettings().properties,n=["_tickingScripts","attributeConnections"];for(var r in t){var i=t[r];i.readOnly||i.derived||lively_lang.obj.equals(this[r],e[r])||i.hasOwnProperty("serialize")&&!i.serialize||n.push(r)}return n}},{key:"__additionally_serialize__",value:function Morph___additionally_serialize___(e,t,n,r){var i=e.props.submorphs;if(i&&!this.isEpiMorph)for(var o=(i=i.value).length;o--;){var a=i[o].id;n.refForId(a).realObj.isEpiMorph&&lively_lang.arr.removeAt(i,o)}for(var s=["borderColor","borderWidth","borderStyle","borderRadius"],l=0;l<s.length;l++){var c=s[l];e.props[c]={key:c,verbatim:!0,value:lively_lang.obj.extract(this[c],["top","right","bottom","left"],function(e,t){return t&&t.isColor?t.toTuple():t})}}}},{key:"isMorph",get:function get(){return!0}},{key:"id",get:function get(){return this._id}},{key:"env",get:function get(){return this._env}},{key:"spec",value:function Morph_spec_(){var e=this.defaultProperties,t=this.propertiesAndPropertySettings().properties,n={submorphs:!0},r={};for(var i in t){var o=t[i];o.readOnly||o.derived||this[i]===e[i]||this[i]&&"function"==typeof this[i].equals&&this[i].equals(e[i])||o.hasOwnProperty("serialize")&&!o.serialize||i in n||(r[i]=this[i])}return this.submorphs.length&&(r.submorphs=this.submorphs.map(function(e){return e.spec()})),r.type=this.constructor.name.toLowerCase(),r}},{key:"printSpec",value:function Morph_printSpec_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e=e||this.spec();var n={name:!0,type:!0,submorphs:!0},r="  ".repeat(t+1),i="  ".repeat(t)+"{\n"+r+'name: "'+e.name+'",\n'+r+'type: "'+e.type+'",\n';for(var o in e)n[o]||(i=i+""+r+o+": "+lively_lang.string.print(e[o])+",\n");if(e.submorphs){i+=r+"submorphs: [\n";var a=!0,s=!1,l=void 0;try{for(var c,u=e.submorphs[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var h=c.value;i+=this.printSpec(h,t+1)}}catch(e){s=!0,l=e}finally{try{!a&&u.return&&u.return()}finally{if(s)throw l}}i+="]\n"}return i+="  ".repeat(t)+"}\n"}},{key:"defaultProperties",get:function get(){var e=this.constructor,t=e[Symbol.for("lively-instance-superclass")];if(!e._morphicDefaultPropertyValues||e._morphicDefaultPropertyValues==(t&&t._morphicDefaultPropertyValues)){var n=this.constructor._morphicDefaultPropertyValues={},r=this.propertiesAndPropertySettings().properties;for(var i in r){var o=r[i];if(o.hasOwnProperty("defaultValue")){var a=o.defaultValue;Array.isArray(a)&&(a=a.slice()),n[i]=a}}}return this.constructor._morphicDefaultPropertyValues}},{key:"defaultProperty",value:function Morph_defaultProperty_(e){return this.defaultProperties[e]}},{key:"getProperty",value:function Morph_getProperty_(e){return this._morphicState[e]}},{key:"setProperty",value:function Morph_setProperty_(e,t,n){return this.addValueChange(e,t,n)}},{key:"changeMetaData",value:function Morph_changeMetaData_(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=this.metadata;i||(i={}),lively_lang.Path(e).withParentAndKeyDo(i,!0,function(e,i){e[i]=r?Object.assign({},e[i],{},t):t;var o=e.__dont_serialize__;n?o&&o.includes(i)&&(lively_lang.arr.remove(o,i),0===o.length&&delete e.__dont_serialize__):(o||(o=e.__dont_serialize__=[]),lively_lang.arr.pushIfNotIncluded(o,i))}),this.metadata=i}},{key:"installFont",value:function Morph_installFont_(e,t){this.installedFonts[e]=t,addOrChangeCSSDeclaration(this.id+"-"+e,'@import url("'+this.installedFonts[e]+'");')}},{key:"uninstallFont",value:function Morph_uninstallFont_(e){delete this.installedFonts[e];var t=document.getElementById(this.id+"-"+e);t&&t.remove()}},{key:"ensureInstalledFonts",value:function Morph_ensureInstalledFonts_(e,t){var n=!0,r=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value,l=document.getElementById(this.id+"-"+s);l&&l.remove()}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}var c=!0,u=!1,h=void 0;try{for(var d,p=t[Symbol.iterator]();!(c=(d=p.next()).done);c=!0){var f=d.value;addOrChangeCSSDeclaration(this.id+"-"+f,'@import url("'+this.installedFonts[f]+'");')}}catch(e){u=!0,h=e}finally{try{!c&&p.return&&p.return()}finally{if(u)throw h}}}},{key:"toString",value:function Morph_toString_(){return"<"+this.constructor.name+" - "+(this.name?this.name:this.id)+">"}},{key:"edit",value:function Morph_edit_(e){return this.env.world.execCommand("open object editor",Object.assign({className:this.constructor.name},e,{target:this}))}},{key:"inspect",value:function Morph_inspect_(e){return this.env.world.execCommand("open object inspector",Object.assign({},e,{target:this}))}},{key:"livelyCustomInspect",value:function Morph_livelyCustomInspect_(){var e={_id:!0,_owner:!0},t={},n=this.propertiesAndPropertySettings().properties,r=[];for(var i in n)e[i]||n[i].derived&&!n[i].showInInspector||(t[i]=!0,r.push({key:i,value:this[i]}));r.push({key:"id",value:this.id}),r.push({key:"owner",value:this.owner}),r=r.sort(function(e,t){var n=e.key.toLowerCase(),r=t.key.toLowerCase();return n<r?-1:n===r?0:1});if(this.attributeConnections){var o=!0,a=!1,s=void 0;try{for(var l,c=this.attributeConnections[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;e[(u.sourceAttrName,""+u.sourceAttrName)]=!0}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}}Object.assign(t,e);var h=!0,d=!1,p=void 0;try{for(var f,g=["attributeConnections","_animationQueue","_morphicState","_dirty","doNotCopyProperties","doNotSerialize","_env","_cachedPaths","_pathDependants","_rendering","_rev","_submorphOrderChanged","_tickingScripts","_transform","_invTransform","_styleSheetProps","_renderer","_tooltipViewer","layout"][Symbol.iterator]();!(h=(f=g.next()).done);h=!0){var m=f.value;m in this&&(t[m]=!0,r.push({key:m,value:this[m],keyString:"[internal] "+m}))}}catch(e){d=!0,p=e}finally{try{!h&&g.return&&g.return()}finally{if(d)throw p}}for(var v in this)!t[v]&&this.hasOwnProperty(v)&&r.unshift({key:v,value:this[v],keyString:"[UNKNOWN PROPERTY] "+v});return{sort:!1,includeDefault:!1,properties:r}}},{key:"show",value:function Morph_show_(){return lively_halos.show(this)}},{key:"setStatusMessage",value:function Morph_setStatusMessage_(e,t,n,r){var i=this.world();return r=Object.assign({maxLines:7},r),i?i.setStatusMessageFor(this,e,t,n,r):console.log(e)}},{key:"showError",value:function Morph_showError_(e){var t=this.world();return t?t.showErrorFor(this,e):console.error(e)}},{key:"onChange",value:function Morph_onChange_(e){var t=e.meta&&e.meta.animation,n=e.prop,r=e.value;"position"===n||"rotation"===n||"scale"===n||"origin"===n||"reactsToPointer"===n?(this.onBoundsChanged(this.bounds()),this.updateTransform(defineProperty({},n,r))):"extent"==n?this.onBoundsChanged(this.bounds()):"layout"==n&&(t?r&&r.attachAnimated(t.duration,this,t.easing):r&&r.attach()),this.layout&&this.layout.onChange(e)}},{key:"onBoundsChanged",value:function Morph_onBoundsChanged_(e){var t=this;lively_bindings.signal(this,"bounds",e),[].concat(toConsumableArray(e.corners),toConsumableArray(e.sides)).forEach(function(n){lively_bindings.signal(t,n,e.partNamed(n))})}},{key:"onSubmorphChange",value:function Morph_onSubmorphChange_(e,t){this.layout&&this.layout.onSubmorphChange(t,e)}},{key:"changes",get:function get(){return this.env.changeManager.changesFor(this)}},{key:"applyChange",value:function Morph_applyChange_(e){this.env.changeManager.apply(this,e)}},{key:"addValueChange",value:function Morph_addValueChange_(e,t,n){return this.env.changeManager.addValueChange(this,e,t,n)}},{key:"addMethodCallChangeDoing",value:function Morph_addMethodCallChangeDoing_(e,t){return this.env.changeManager.addMethodCallChangeDoing(e,this,t)}},{key:"groupChangesWhile",value:function Morph_groupChangesWhile_(e,t){return this.env.changeManager.groupChangesWhile(this,e,t)}},{key:"dontRecordChangesWhile",value:function Morph_dontRecordChangesWhile_(e){return this.env.changeManager.dontRecordChangesWhile(this,e)}},{key:"recordChangesWhile",value:function Morph_recordChangesWhile_(e,t){return this.env.changeManager.recordChangesWhile(e,t)}},{key:"recordChangesStart",value:function Morph_recordChangesStart_(e){return this.env.changeManager.recordChangesStartForMorph(this,e)}},{key:"recordChangesStop",value:function Morph_recordChangesStop_(e){return this.env.changeManager.recordChangesStopForMorph(this,e)}},{key:"withMetaDo",value:function Morph_withMetaDo_(e,t){return this.env.changeManager.doWithValueChangeMeta(e,this,t)}},{key:"undoStart",value:function Morph_undoStart_(e){return this.env.undoManager.undoStart(this,e)}},{key:"undoStop",value:function Morph_undoStop_(e){return this.env.undoManager.undoStop(this,e)}},{key:"undoInProgress",get:function get(){return this.env.undoManager.undoInProgress}},{key:"animate",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var t;return regeneratorRuntime.wrap(function _callee$(n){for(;;)switch(n.prev=n.next){case 0:if(t=this._animationQueue.registerAnimation(e),this._animationQueue.animationsActive){n.next=4;break}return t&&t.finish(),n.abrupt("return",Promise.resolve(this));case 4:if(!t){n.next=8;break}return n.next=7,t.asPromise();case 7:return n.abrupt("return",n.sent);case 8:return n.abrupt("return",Promise.resolve(this));case 9:case"end":return n.stop()}},_callee,this)}));return function Morph_animate_(t){return e.apply(this,arguments)}}()},{key:"isClip",value:function Morph_isClip_(){return"visible"!==this.clipMode}},{key:"scrollExtent",get:function get(){return(this.submorphs.length?this.innerBounds().union(this.submorphBounds()):this.innerBounds()).extent().addPt(this.scrollbarOffset)}},{key:"scrollBounds",value:function Morph_scrollBounds_(){var e=this.scroll,t=e.x,n=e.y,r=this.scrollExtent,i=r.x,o=r.y;return new lively_graphics.Rectangle(t,n,i,o)}},{key:"scrollDown",value:function Morph_scrollDown_(e){this.scroll=this.scroll.addXY(0,e)}},{key:"scrollUp",value:function Morph_scrollUp_(e){this.scrollDown(50*-e)}},{key:"scrollLeft",value:function Morph_scrollLeft_(e){this.scroll=this.scroll.addXY(e,0)}},{key:"scrollRight",value:function Morph_scrollRight_(e){this.scrollLeft(-e)}},{key:"scrollPageDown",value:function Morph_scrollPageDown_(){this.scrollDown(this.height)}},{key:"scrollPageUp",value:function Morph_scrollPageUp_(){this.scrollUp(this.height)}},{key:"addStyleClass",value:function Morph_addStyleClass_(e){this.styleClasses=lively_lang.arr.uniq(this.styleClasses.concat(e))}},{key:"removeStyleClass",value:function Morph_removeStyleClass_(e){this.styleClasses=this.styleClasses.filter(function(t){return t!=e})}},{key:"adjustOrigin",value:function Morph_adjustOrigin_(e){var t=this.origin,n=this.globalBounds().topLeft();this.origin=e,this.submorphs.forEach(function(n){return n.position=n.position.subPt(e.subPt(t))});var r=this.globalBounds().topLeft(),i=n.subPt(r);this.globalPosition=this.globalPosition.addPt(i)}},{key:"setBounds",value:function Morph_setBounds_(e){this.extent=e.extent(),this.position=e.topLeft().addPt(this.origin)}},{key:"innerBounds",value:function Morph_innerBounds_(){var e=this.extent,t=e.x,n=e.y;return lively_graphics.rect(0,0,t,n)}},{key:"relativeBounds",value:function Morph_relativeBounds_(e){e=e||this.world();var t=this.origin.negated().extent(this.extent);return t=e?this.transformRectToMorph(e,t):this.getGlobalTransform().transformRectToRect(t),this.isClip()||this.submorphs.forEach(function(n){t=t.union(n.relativeBounds(e))}),t}},{key:"bounds",value:function Morph_bounds_(){return this.relativeBounds(this.owner)}},{key:"relativeSubmorphBounds",value:function Morph_relativeSubmorphBounds_(){var e=this.innerBounds();return this.submorphs.map(function(t){var n=t.bounds(),r=n.width,i=n.height,o=n.x,a=n.y;return lively_graphics.rect(o/e.width,a/e.height,r/e.width,i/e.height)})}},{key:"globalBounds",value:function Morph_globalBounds_(){return this.relativeBounds(this.world())}},{key:"submorphBounds",value:function Morph_submorphBounds_(){return this.submorphs.length<1?this.innerBounds():this.submorphs.map(function(e){return e.bounds()}).reduce(function(e,t){return e.union(t)})}},{key:"fitToSubmorphs",value:function Morph_fitToSubmorphs_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:lively_graphics.Rectangle.inset(0),t=this.submorphs;if(t.length){var n=t.reduce(function(e,t){return e.union(t.bounds())},t[0].bounds()),r=n.top()-e.top(),i=n.left()-e.left();this.moveBy(lively_graphics.pt(i,r)),lively_lang.arr.invoke(this.submorphs,"moveBy",lively_graphics.pt(-i,-r)),this.extent=lively_graphics.pt(n.width+e.left()+e.right(),n.height+e.top()+e.bottom())}}},{key:"align",value:function Morph_align_(e,t){return this.moveBy(t.subPt(e))}},{key:"moveBy",value:function Morph_moveBy_(e){return this.position=this.position.addPt(e),this}},{key:"rotateBy",value:function Morph_rotateBy_(e){this.rotation+=e}},{key:"resizeBy",value:function Morph_resizeBy_(e){this.extent=this.extent.addPt(e)}},{key:"snap",value:function Morph_snap_(e){this.position=this.position.roundTo(e||1)}},{key:"isEpiMorph",get:function get(){return this.getProperty("epiMorph")}},{key:"isUsedAsEpiMorph",value:function Morph_isUsedAsEpiMorph_(){for(var e=this;e;){if(e.isEpiMorph)return!0;e=e.owner}return!1}},{key:"replaceWith",value:function Morph_replaceWith_(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this===e||!e)return e;if(this===e.owner)return e.replaceWith(this),e;var r=this.owner,i=this.submorphs,o=this.getTransform().copy(),a="number"==typeof t?t:r?r.submorphs.indexOf(this):-1,s=e.owner,l=lively_lang.arr.without(e.submorphs,this),c=e.getTransform().copy(),u=s?s.submorphs.indexOf(e):-1;return r&&this.remove(),s&&e.remove(),n&&(this.submorphs=[],e.submorphs=[]),r===e?(s&&s.addMorphAt(this,u),n&&(this.submorphs=l.slice(0,a).concat(e).concat(l.slice(a)),e.submorphs=i)):(r&&r.addMorphAt(e,a),s&&s.addMorphAt(this,u),n&&(e.submorphs=i,this.submorphs=l)),e.setTransform(o),this.setTransform(c),e}},{key:"addMorphAt",value:function Morph_addMorphAt_(e,t){var n=this;if(!e||"object"!==(void 0===e?"undefined":_typeof(e)))throw new Error(e+" cannot be added as a submorph to "+this);if(e.isMorph){if(e.isAncestorOf(this))return this.env.world.logError(new Error("addMorph: Circular relationships between morphs not allowed\ntried to add "+e+" to "+this)),null;if(e===this)return this.env.world.logError(new Error("addMorph: Trying to add itself as a submorph: "+this)),null}e.isMorph||(e=morph$2(e));var r=this.submorphs.indexOf(e);if(!(r>-1&&r===t))return this.addMethodCallChangeDoing({target:this,selector:"addMorphAt",args:[e,t],undo:{target:this,selector:"removeMorph",args:[e]}},function(){var i,o=e.owner,a=n.submorphs;o&&o!==n&&(i=e.transformForNewOwner(n),e.remove()),e._env!==n._env&&(e._env=n._env),t=Math.min(a.length,Math.max(0,t)),r>-1&&(a.splice(r,1),r<t&&t--),a.splice(t,0,e),e._owner=n,e._cachedPaths={},i&&e.setTransform(i),e.requestStyling(),n._morphicState.submorphs=a,n._submorphOrderChanged=!0,n.makeDirty(),e.resumeSteppingAll(),e.withAllSubmorphsDo(function(e){return e.onOwnerChanged(n)})}),e}},{key:"addMorph",value:function Morph_addMorph_(e,t){var n=this.submorphs,r=t?n.indexOf(t):-1,i=-1===r?n.length:r;return this.addMorphAt(e,i)}},{key:"addMorphBack",value:function Morph_addMorphBack_(e){var t=e===this.submorphs[0]?this.submorphs[1]:this.submorphs[0];return this.addMorph(e,t)}},{key:"removeMorph",value:function Morph_removeMorph_(e){var t=this.submorphs.indexOf(e);-1!==t&&((this.getProperty("submorphs")||[]).splice(t,1),this.addMethodCallChangeDoing({target:this,selector:"removeMorph",args:[e],undo:{target:this,selector:"addMorphAt",args:[e,t]}},function(){e.suspendSteppingAll(),e._owner=null}),this._pathDependants=lively_lang.arr.withoutAll(this._pathDependants,e._pathDependants))}},{key:"remove",value:function Morph_remove_(){var e=this;return this.ownerChain().forEach(function(t){t._stylingVisitor&&t._stylingVisitor.deleteFromCache(e)}),this.owner&&this.owner.removeMorph(this),this._cachedPaths={},this._pathDependants.forEach(function(e){return e._cachedPaths={}}),this._pathDependants=[],this.withAllSubmorphsDo(function(e){return e.onOwnerChanged(null)}),this}},{key:"onOwnerChanged",value:function Morph_onOwnerChanged_(e){}},{key:"fadeOut",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return regeneratorRuntime.wrap(function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.animate({opacity:0,duration:e,easing:easings.outQuad});case 2:this.remove(),this.opacity=1;case 4:case"end":return t.stop()}},_callee2,this)}));return function Morph_fadeOut_(){return e.apply(this,arguments)}}()},{key:"fadeIn",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return regeneratorRuntime.wrap(function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return this.opacity=0,this.animate({opacity:1,duration:e}),t.abrupt("return",this);case 3:case"end":return t.stop()}},_callee3,this)}));return function Morph_fadeIn_(){return e.apply(this,arguments)}}()},{key:"fadeIntoWorld",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$world.visibleBounds().center(),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return regeneratorRuntime.wrap(function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:return e=new Morph({opacity:0,scale:0,fill:lively_graphics.Color.transparent}),t=this.env.world,e.openInWorld(),e.addMorph(this),this.position=e.extent.scaleBy(.5),e.center=n,e.scale=.8,i.next=8,e.animate({opacity:1,scale:1,duration:r});case 8:return t.addMorph(this),e.remove(),i.abrupt("return",this);case 11:case"end":return i.stop()}},_callee4,this)}));return function Morph_fadeIntoWorld_(){return e.apply(this,arguments)}}()},{key:"removeAllMorphs",value:function Morph_removeAllMorphs_(){this.submorphs=[]}},{key:"bringToFront",value:function Morph_bringToFront_(){return this.owner&&lively_lang.arr.last(this.owner.submorphs)!==this&&this.owner.addMorph(this),this}},{key:"owner",get:function get(){return this._owner}},{key:"withAllSubmorphsDetect",value:function Morph_withAllSubmorphsDetect_(e){if(e(this))return this;var t=!0,n=!1,r=void 0;try{for(var i,o=this.submorphs[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var a=i.value.withAllSubmorphsDetect(e);if(a)return a}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}},{key:"withAllSubmorphsDo",value:function Morph_withAllSubmorphsDo_(e){var t=[e(this)],n=!0,r=!1,i=void 0;try{for(var o,a=this.submorphs[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;lively_lang.arr.pushAll(t,s.withAllSubmorphsDo(e))}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return t}},{key:"withAllSubmorphsSelect",value:function Morph_withAllSubmorphsSelect_(e){var t=[];return this.withAllSubmorphsDo(function(n){return e(n)&&t.push(n)}),t}},{key:"ownerChain",value:function Morph_ownerChain_(){return this.owner?[this.owner].concat(this.owner.ownerChain()):[]}},{key:"world",value:function Morph_world_(){return this.owner?this.owner.world():null}},{key:"getWindow",value:function Morph_getWindow_(){return this.isWindow?this:this.ownerChain().find(function(e){return e.isWindow})}},{key:"openInWorldNear",value:function Morph_openInWorldNear_(e,t){var n=t||this.world()||this.env.world;return n?(this.center=e,this.setBounds(n.visibleBounds().insetBy(5).translateForInclusion(this.bounds())),this.openInWorld(this.position)):this}},{key:"openInWorldNearHand",value:function Morph_openInWorldNearHand_(e){var t=e||this.world()||this.env.world,n=t.firstHand?t.firstHand.position:lively_graphics.pt(0,0);return t?this.openInWorldNear(n):void 0}},{key:"openInWorld",value:function Morph_openInWorld_(e,t){var n=t||this.world()||this.env.world;return n?(e?this.position=e:(this.center=n.visibleBounds().center(),this.snap()),n.addMorph(this),this):(console.warn("Cannot open morph "+this+", world morph not found;"),this)}},{key:"openInHand",value:function Morph_openInHand_(e){e||(e=(this.world()||this.env.world).firstHand);e.grab(this),this.center=lively_graphics.pt(0,0)}},{key:"openInWindow",value:function Morph_openInWindow_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{title:this.name,name:"window for "+this.name,world:null};return(e.world||this.world()||this.env.world).openInWindow(this,lively_lang.obj.dissoc(e,["world"]))}},{key:"isAncestorOf",value:function Morph_isAncestorOf_(e){for(var t=e.owner;t;){if(t===this)return!0;t=t.owner}return!1}},{key:"morphsContainingPoint",value:function Morph_morphsContainingPoint_(e,t){if(t||(t=[]),!this.fullContainsWorldPoint(e))return t;for(var n=this.submorphs.length-1;n>=0;n--)this.submorphs[n].morphsContainingPoint(e,t);return this.innerBoundsContainsWorldPoint(e)&&t.push(this),t}},{key:"morphBeneath",value:function Morph_morphBeneath_(e){var t=this.world()||this.owner;if(!t)return null;var n=t.morphsContainingPoint(e);return n[n.indexOf(this)+1]}},{key:"transformTillMorph",value:function Morph_transformTillMorph_(e){if("down"==(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"up"))return e.transformTillMorph(this,"up").inverse();for(var t=new lively_graphics.Transform,n=this;n&&n!=e;n=n.owner){var r=n,i=r.origin,o=r.scroll;0===i.x&&0===i.y||t.preConcatenate(new lively_graphics.Transform(n.origin)),t.preConcatenate(n.getTransform()),n!=this&&(0===o.x&&0===o.y||!n.owner||t.preConcatenate(new lively_graphics.Transform(o.negated()))),n.hasFixedPosition&&n.owner&&t.preConcatenate(new lively_graphics.Transform(n.owner.scroll))}return t}},{key:"localize",value:function Morph_localize_(e){var t=this.world(),n=e.x,r=e.y;return t?t.transformPointToMorph(this,lively_graphics.pt(n,r)):e}},{key:"worldPoint",value:function Morph_worldPoint_(e){var t=this.world(),n=e.x,r=e.y;return t?this.transformPointToMorph(t,lively_graphics.pt(n,r)):e.addPt(this.position)}},{key:"transformToMorph",value:function Morph_transformToMorph_(e){var t=this.getGlobalTransform(),n=e.getGlobalTransform().inverse();t.preConcatenate(n);var r=e.scroll;return 0===r.x&&0===r.y||!e.owner||t.preConcatenate(new lively_graphics.Transform(r)),t}},{key:"transformPointToMorph",value:function Morph_transformPointToMorph_(e,t){var n=!0,r=!1,i=void 0;try{for(var o,a=this.pathToMorph(e)[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=slicedToArray(o.value,2),l=s[0],c=s[1];this!=c&&"up"==l&&(t.x-=c.scroll.x,t.y-=c.scroll.y,c.hasFixedPosition&&c.owner&&c.owner.owner&&(t.x+=c.owner.scroll.x,t.y+=c.owner.scroll.y)),this.applyTransform(l,c,t),this!=c&&"down"==l&&(t.x+=c.scroll.x,t.y+=c.scroll.y,c.hasFixedPosition&&c.owner&&c.owner.owner&&(t.x-=c.owner.scroll.x,t.y-=c.owner.scroll.y))}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return t}},{key:"transformRectToMorph",value:function Morph_transformRectToMorph_(e,t){var n,r,i,o,a=this;return[n=t.topLeft(),r=t.topRight(),i=t.bottomRight(),o=t.bottomLeft()].forEach(function(t){return a.transformPointToMorph(e,t)}),lively_graphics.Rectangle.unionPts([n,r,i,o])}},{key:"applyTransform",value:function Morph_applyTransform_(e,t,n){"up"==e?(n.x+=t.origin.x,n.y+=t.origin.y,n.matrixTransform(t.getTransform(),n)):(n.matrixTransform(t.getInverseTransform(),n),n.x-=t.origin.x,n.y-=t.origin.y)}},{key:"_addPathDependant",value:function Morph__addPathDependant_(e){this._pathDependants.includes(e)||this._pathDependants.push(e)}},{key:"pathToMorph",value:function Morph_pathToMorph_(e){var t;if(t=this._cachedPaths[e.id])return t;var n=this.closestCommonAncestor(e)||this,r=this,i=[],o=[];for(n._addPathDependant(this);r&&r!=n;)o.push(["up",r]),r._addPathDependant(this),r=r.owner;for(r=e;r&&r!=n;)i.push(["down",r]),r._addPathDependant(this),r=r.owner;return this._cachedPaths[e.id]=t=[].concat(o,toConsumableArray(i.reverse())),t}},{key:"closestCommonAncestor",value:function Morph_closestCommonAncestor_(e){return lively_lang.arr.intersect([this].concat(toConsumableArray(this.ownerChain())),[e].concat(toConsumableArray(e.ownerChain())))[0]}},{key:"transformForNewOwner",value:function Morph_transformForNewOwner_(e){return new lively_graphics.Transform(this.transformToMorph(e))}},{key:"localizePointFrom",value:function Morph_localizePointFrom_(e,t){var n=e.x,r=e.y;try{return t.transformPointToMorph(this,lively_graphics.pt(n,r))}catch(e){return console.warn("problem "+e+" in localizePointFrom"),lively_graphics.pt}}},{key:"getGlobalTransform",value:function Morph_getGlobalTransform_(){return this.transformTillMorph(this.world())}},{key:"globalPosition",get:function get(){return this.worldPoint(lively_graphics.pt(0,0))}},{key:"globalPosition",set:function set(e){return this.position=this.owner?this.owner.localize(e):e}},{key:"ensureToBeInWorldBounds",value:function Morph_ensureToBeInWorldBounds_(){var e=this.world();if(e){var t=this.globalBounds(),n=e.innerBounds().translateForInclusion(t).topLeft().subPt(t.topLeft());this.moveBy(n)}}},{key:"getTransform",value:function Morph_getTransform_(){return this._transform||this.updateTransform(),this._transform}},{key:"getInverseTransform",value:function Morph_getInverseTransform_(){return this._invTransform||this.updateTransform(),this._invTransform}},{key:"updateTransform",value:function Morph_updateTransform_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.position,n=e.scale,r=e.origin,i=e.rotation,o=this._transform||new lively_graphics.Transform,a=this._invTransform||new lively_graphics.Transform;t=t||this.position,r=r||this.origin,n=n||this.scale,i=i||this.rotation,o.a=n*Math.cos(i),o.b=n*Math.sin(i),o.c=n*-Math.sin(i),o.d=n*Math.cos(i),o.e=o.a*-r.x+o.c*-r.y+t.x,o.f=o.b*-r.x+o.d*-r.y+t.y;var s=o.a,l=o.b,c=o.c,u=o.d,h=o.e,d=o.f,p=1/(s*u-c*l);a.a=u*p,a.b=-l*p,a.c=-c*p,a.d=s*p,a.e=(c*d-h*u)*p,a.f=-(s*d-l*h)*p,this._transform=o,this._invTransform=a}},{key:"setTransform",value:function Morph_setTransform_(e){this.position=e.getTranslation(),this.rotation=lively_lang.num.toRadians(e.getRotation()),this.scale=e.getScalePoint().x,this.updateTransform(this)}},{key:"fullContainsWorldPoint",value:function Morph_fullContainsWorldPoint_(e){return this.fullContainsPoint(null==this.owner?e:this.owner.localize(e))}},{key:"fullContainsPoint",value:function Morph_fullContainsPoint_(e){return this.bounds().containsPoint(e)}},{key:"innerBoundsContainsWorldPoint",value:function Morph_innerBoundsContainsWorldPoint_(e){return this.innerBoundsContainsPoint(this.localize(e))}},{key:"innerBoundsContainsPoint",value:function Morph_innerBoundsContainsPoint_(e){return this.innerBounds().containsPoint(e.addPt(this.origin).subPt(this.scroll))}},{key:"get",value:function Morph_get_(e){if(!e)return null;try{return this.getSubmorphNamed(e)||this.getNameTest(this,e)&&this||this.getOwnerOrOwnerSubmorphNamed(e)}catch(e){if(e.constructor==RangeError&&"Maximum call stack size exceeded"==e.message)throw new Error("'get' failed due to a stack overflow. The most\nlikely source of the problem is using 'get' as part of\ntoString, because 'get' calls 'getOwnerOrOwnerSubmorphNamed', which\ncalls 'toString' on this. Try using 'getSubmorphNamed' instead,\nwhich only searches in this' children.\nOriginal error:\n"+e.stack);throw e}}},{key:"getNameTest",value:function Morph_getNameTest_(e,t){if(lively_lang.obj.isRegExp(t)){if(t.test(e.name)||t.test(String(e)))return!0}else if(e.name===t||String(e)===t)return!0;return!1}},{key:"getAllNamed",value:function Morph_getAllNamed_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!this._morphicState||!this.submorphs.length)return t;for(var n=0;n<this.submorphs.length;n++){var r=this.submorphs[n];this.getNameTest(r,e)&&t.push(r)}for(var i=0;i<this.submorphs.length;i++)this.submorphs[i].getAllNamed(e,t);return t}},{key:"getSubmorphNamed",value:function Morph_getSubmorphNamed_(e){if(!this._morphicState||!this.submorphs.length)return null;for(var t=0;t<this.submorphs.length;t++){var n=this.submorphs[t];if(this.getNameTest(n,e))return n}for(var r=0;r<this.submorphs.length;r++){var i=this.submorphs[r].getSubmorphNamed(e);if(i)return i}return null}},{key:"getSubmorphsByStyleClassName",value:function Morph_getSubmorphsByStyleClassName_(e){return this.withAllSubmorphsSelect(function(t){return t.styleClasses.includes(e)})}},{key:"getOwnerNamed",value:function Morph_getOwnerNamed_(e){return this.ownerChain().find(function(t){return t.name===e})}},{key:"getOwnerOrOwnerSubmorphNamed",value:function Morph_getOwnerOrOwnerSubmorphNamed_(e){var t=this.owner;if(!t)return null;if(t.name===e)return t;for(var n=0;n<t.submorphs.length;n++){var r=t.submorphs[n];if(r!==this){if(this.getNameTest(r,e))return r;var i=r.getSubmorphNamed(e);if(i)return i}}return this.owner.getOwnerOrOwnerSubmorphNamed(e)}},{key:"getMorphWithId",value:function Morph_getMorphWithId_(e){return this.withAllSubmorphsDetect(function(t){var n=t.id;return e===n})}},{key:"generateReferenceExpression",value:function Morph_generateReferenceExpression_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.world(),n=e.maxLength,r=void 0===n?10:n,i=e.fromMorph,o=void 0===i?t:i;if(o===this)return"this";var a=t===o?"$world":"this";if(!(t||this.name&&o.get(this.name)===this))return"morph";var s=lively.vm,l=function makeReferenceExpressionListFor(e){var t,n=e.name,r=e.ownerChain(),i=e.owner,l=e.world();e===o&&(t=[a]);l===e&&(t=["$world"]);if(!t&&n&&i){if(i===l&&1===lively_lang.arr.count(lively_lang.arr.pluck(l.submorphs,"name"),n)&&(t=['$world.get("'+n+'")']),!t&&i!=l)for(var c=r.length-1;c--;)if(1===r[c].getAllNamed(n).length){t=[].concat(toConsumableArray(makeReferenceExpressionListFor(r[c])),['get("'+n+'")']);break}if(!t){var u=[].concat(toConsumableArray(makeReferenceExpressionListFor(i)),['get("'+n+'")']);s.syncEval(u.join("."),{context:o}).value===e&&(t=u)}}t||(t=[a+'.getMorphById("'+e.id+'")']);return t}(this);return l.length>r?'$world.getMorphWithId("'+this.id+'")':l.join(".")}},{key:"setMirrored",value:function Morph_setMirrored_(e){e?this.removeStyleClass("hidden-in-mirror"):this.addStyleClass("hidden-in-mirror")}},{key:"isMirrored",value:function Morph_isMirrored_(){return this.styleClasses.indexOf("hidden-in-mirror")>=0}},{key:"dragTriggerDistance",get:function get(){return 0}},{key:"onMouseDown",value:function Morph_onMouseDown_(e){var t=this;this===e.targetMorph&&setTimeout(function(){!t.grabbable||e.state.draggedMorph||e.state.clickedOnMorph!==t||e.hand.carriesMorphs()||e.hand.grab(t)},800)}},{key:"onMouseUp",value:function Morph_onMouseUp_(e){}},{key:"onMouseMove",value:function Morph_onMouseMove_(e){}},{key:"onLongClick",value:function Morph_onLongClick_(e){}},{key:"addKeyBindings",value:function Morph_addKeyBindings_(e){var t=this;this.addMethodCallChangeDoing({target:this,selector:"addKeyBindings",args:[e],undo:null},function(){var n;t._keybindings||(t._keybindings=[]),t._cachedKeyhandlers=null,(n=t._keybindings).unshift.apply(n,toConsumableArray(e))})}},{key:"keybindings",get:function get(){return this._keybindings||[]}},{key:"keybindings",set:function set(e){return this._cachedKeyhandlers=null,this._keybindings=e}},{key:"keyhandlers",get:function get(){return this._cachedKeyhandlers||(this._cachedKeyhandlers=[KeyHandler.withBindings(this.keybindings)])}},{key:"keyCommandMap",get:function get(){var e=this.keyhandlers[0].platform;return this.keybindings.reduce(function(t,n){var r=findKeysForPlatform(n.keys,e),i=n.command,o="string"==typeof i?i:i.command||i.name;return"string"!=typeof r?t:r.split("|").reduce(function(e,t){return Object.assign(e,defineProperty({},t,{name:o,command:i,prettyKeys:KeyHandler.prettyCombo(t)}))},t)},{})}},{key:"keysForCommand",value:function Morph_keysForCommand_(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.keyCommandMap,r=Object.keys(n).find(function(t){return n[t].name===e});return r&&t?n[r].prettyKeys:r}},{key:"simulateKeys",value:function Morph_simulateKeys_(e){return KeyHandler.simulateKeys(this,e)}},{key:"onKeyDown",value:function Morph_onKeyDown_(e){KeyHandler.invokeKeyHandlers(this,e,!1)&&e.stop()}},{key:"onKeyUp",value:function Morph_onKeyUp_(e){}},{key:"onContextMenu",value:function Morph_onContextMenu_(e){var t=this;e.targetMorph===this&&(e.stop(),Promise.resolve(this.menuItems()).then(function(n){return t.openMenu(n,e)}).catch(function(e){return $world.logError(e)}))}},{key:"openMenu",value:function Morph_openMenu_(e,t){var n=this.world();return e&&e.length&&n?n.openWorldMenu(t,e):null}},{key:"menuItems",value:function Morph_menuItems_(){var e=this,t=this.world(),n=[],r=this;function menuItemsForMorphsBeneathMe(e){var n=this,i=t.morphsContainingPoint(r.worldPoint(lively_graphics.pt(0,0)));i.pop();var o=i.indexOf(r);return(i=i.slice(o+1)).map(function(t){return[String(t),e.bind(n,t)]})}this.reset&&"function"==typeof this.reset&&n.push(["Reset",function(){e.reset()}]),n.push(["Publish...",function(){return e.interactivelyPublish()}]),n.push(["Open in...",[["Window",function(){e.openInWindow()}]]]),n.push(["Add morph to...",{getItems:menuItemsForMorphsBeneathMe.bind(this,function(e){return e.addMorph(r)})}]),n.push(["Get halo on...",{getItems:menuItemsForMorphsBeneathMe.bind(this,function(e){return e.world().showHaloFor(e)})}]),this.owner&&this.owner.submorphs.length>1&&n.push(["Arrange morph",[["Bring to front",function(){return e.owner.addMorph(e)}],["Send to back",function(){return e.owner.addMorphBack(e)}]]]),this.submorphs.length&&n.push(["Select all submorphs",function(){return e.world().showHaloFor(e.submorphs.slice())}]);var i=[];this.startSteppingScripts?i.push(["Start stepping",function(){r.startSteppingScripts()}]):i.push(["Start stepping",asyncToGenerator(regeneratorRuntime.mark(function _callee5(){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k,S,C,M,T,P,A,L,R;return regeneratorRuntime.wrap(function _callee5$(E){for(;;)switch(E.prev=E.next){case 0:return t=[],E.next=3,lively.vm.completions.getCompletions(function(){return e},"");case 3:n=E.sent,r=n.completions,i=!0,o=!1,a=void 0,E.prev=8,s=r[Symbol.iterator]();case 10:if(i=(l=s.next()).done){E.next=46;break}c=l.value,u=slicedToArray(c,2),h=u[0],d=u[1],p=!0,f=!1,g=void 0,E.prev=16,m=d[Symbol.iterator]();case 18:if(p=(v=m.next()).done){E.next=29;break}if(!(y=v.value).startsWith("_")&&!y.startsWith("$")){E.next=22;break}return E.abrupt("continue",26);case 22:if(_=y.match(/^([^\(]+)\(?([^\)]+)?\)?$/)||[],b=slicedToArray(_,3),b[0],x=b[1],w=b[2],x&&"function"==typeof e[x]){E.next=25;break}return E.abrupt("continue",26);case 25:t.push({isListItem:!0,string:h+" "+y,value:{selector:x,args:w}});case 26:p=!0,E.next=18;break;case 29:E.next=35;break;case 31:E.prev=31,E.t0=E.catch(16),f=!0,g=E.t0;case 35:E.prev=35,E.prev=36,!p&&m.return&&m.return();case 38:if(E.prev=38,!f){E.next=41;break}throw g;case 41:return E.finish(38);case 42:return E.finish(35);case 43:i=!0,E.next=10;break;case 46:E.next=52;break;case 48:E.prev=48,E.t1=E.catch(8),o=!0,a=E.t1;case 52:E.prev=52,E.prev=53,!i&&s.return&&s.return();case 55:if(E.prev=55,!o){E.next=58;break}throw a;case 58:return E.finish(55);case 59:return E.finish(52);case 60:return E.next=62,$world.filterableListPrompt("Select method to start",t,{requester:e,historyId:"lively.morphic-start-stepping-chooser"});case 62:if(k=E.sent,S=slicedToArray(k.selected,1),C=S[0]){E.next=67;break}return E.abrupt("return");case 67:return E.next=69,$world.prompt("Steptime in ms (how of the method will be called)?",{input:100});case 69:if(M=E.sent,M=Number(M),!isNaN(M)){E.next=73;break}return E.abrupt("return");case 73:if(T=[M,C.selector],!C.args){E.next=88;break}return P={targetModule:"lively://lively.morphic-stepping-args/eval.js"},E.next=78,$world.editPrompt("Arguments to pass",{input:"["+C.args+"]",mode:"js",evalEnvironment:P});case 78:return A=E.sent,E.next=81,lively.vm.runEval(A,P);case 81:if(L=E.sent,R=L.value,!L.isError){E.next=87;break}return $world.inform("Error evaluating the arguments: "+R),E.abrupt("return");case 87:Array.isArray(R)&&T.push.apply(T,toConsumableArray(R));case 88:e.startStepping.apply(e,T);case 89:case"end":return E.stop()}},_callee5,e,[[8,48,52,60],[16,31,35,43],[36,,38,42],[53,,55,59]])}))]),0!=this.tickingScripts.length&&i.push(["Stop stepping",function(){return r.stopStepping()}]),0!=i.length&&n.push(["Stepping",i]);var o=["Morphic properties",[]];n.push(o);var a=Icon.textAttribute("check-square-o"),s=Icon.textAttribute("square-o");s[1].paddingRight="7px",Object.assign(a[1],{paddingRight:"5px",float:"none",display:"inline"}),["grabbable","draggable","acceptsDrops","halosEnabled"].forEach(function(t){return o[1].push([[].concat(toConsumableArray(e[t]?a:s),[t,{float:"none"}]),function(){return e[t]=!e[t]}])}),n.push(["Fit to submorphs",asyncToGenerator(regeneratorRuntime.mark(function _callee6(){var t,n,r;return regeneratorRuntime.wrap(function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,e.world().prompt("Padding around submorphs:",{input:"Rectangle.inset(5)",historyId:"lively.morphic-fit-to-submorphs-padding-hist",requester:e});case 2:if("string"==typeof(t=i.sent)){i.next=5;break}return i.abrupt("return");case 5:return i.next=7,lively.vm.runEval(t,{topLevelVarRecorder:{Rectangle:lively_graphics.Rectangle}});case 7:n=i.sent,r=n.value,t=r&&r.isRectangle?r:lively_graphics.Rectangle.inset(0),e.undoStart("fitToSubmorphs"),e.fitToSubmorphs(t),e.undoStop("fitToSubmorphs");case 13:case"end":return i.stop()}},_callee6,e)}))]);var l=this.connectionMenuItems();l&&n.push(["connections...",l]);var c=this.connectMenuItems();return c&&n.push(["connect...",c]),n}},{key:"connectionMenuItems",value:function Morph_connectionMenuItems_(){var e=this;return this.attributeConnections&&this.attributeConnections.length?this.attributeConnections.map(function(t){return[String(t),[["show",asyncToGenerator(regeneratorRuntime.mark(function _callee7(){var n;return regeneratorRuntime.wrap(function _callee7$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/fabrik.js");case 2:n=e.sent,(0,n.interactivelyShowConnection)(t);case 5:case"end":return e.stop()}},_callee7,e)}))],["edit",asyncToGenerator(regeneratorRuntime.mark(function _callee8(){var n;return regeneratorRuntime.wrap(function _callee8$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/fabrik.js");case 2:n=e.sent,(0,n.interactivelyReEvaluateConnection)(t);case 5:case"end":return e.stop()}},_callee8,e)}))],["disconnect",function(){t.disconnect(),$world.setStatusMessage("disconnected "+t)}]]]}):null}},{key:"sourceDataBindings",value:function Morph_sourceDataBindings_(){var e=this.propertiesAndPropertySettings().properties,t=lively_lang.arr.groupByKey(Object.keys(e).map(function(t){var n=Object.assign({name:t},e[t]);return n.group&&n.group.startsWith("_")?null:n}).filter(Boolean),"group"),n=["core","geometry","interaction","styling","layouting"],r=[];return n.forEach(function(e){return r.push(t[e])}),lively_lang.arr.withoutAll(t.keys(),n).forEach(function(e){return r.push(t[e])}),r}},{key:"targetDataBindings",value:function Morph_targetDataBindings_(){for(var e=[],t=this;t!==Object.prototype;){var n=t===this?String(this):t.constructor.name,r=null,i=Object.getOwnPropertyDescriptors(t),o=Object.getPrototypeOf(t);for(var a in i){var s=i[a].value;if("function"==typeof s&&s!==t.constructor&&(!a.startsWith("$")&&!a.startsWith("_"))){r||(r=[]);var l=lively.lang.fun.argumentNames(s);r.push({group:n+" methods",signature:a+"("+l.join(", ")+")",name:a})}}r&&e.push(r),t=o}return this.sourceDataBindings().concat(e)}},{key:"connectMenuItems",value:function Morph_connectMenuItems_(e){var t=this,n=this.sourceDataBindings(),r=this.world(),i=n.map(function(n){return[n[0].group||"uncategorized",n.map(function(n){return[n.name,e?function(){return e(n.name,t,n)}:asyncToGenerator(regeneratorRuntime.mark(function _callee9(){var e;return regeneratorRuntime.wrap(function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,System.import("lively.ide/fabrik.js");case 2:e=r.sent,(0,e.interactiveConnectGivenSource)(t,n.name);case 5:case"end":return r.stop()}},_callee9,t)}))]})]});return r&&i.push(["custom...",e?function(){return e("custom...",t,null)}:asyncToGenerator(regeneratorRuntime.mark(function _callee10(){var e,n,i;return regeneratorRuntime.wrap(function _callee10$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,System.import("lively.ide/fabrik.js");case 2:return e=o.sent,n=e.interactiveConnectGivenSource,o.next=6,r.prompt("Enter custom connection point",{requester:t,historyId:"lively.morphic-custom-connection-points",useLastInput:!0});case 6:(i=o.sent)&&n(t,i);case 8:case"end":return o.stop()}},_callee10,t)}))]),i}},{key:"onCut",value:function Morph_onCut_(e){}},{key:"onCopy",value:function Morph_onCopy_(e){}},{key:"onPaste",value:function Morph_onPaste_(e){}},{key:"onDragStart",value:function Morph_onDragStart_(e){this.undoStart("drag-move");var t=e.state,n=t.dragStartMorphPosition,r=t.absDragDelta;this.position=n.addPt(r)}},{key:"onDragEnd",value:function Morph_onDragEnd_(e){this.undoStop("drag-move"),lively_halos_dragGuides_js.removeSnapToGuidesOf&&lively_halos_dragGuides_js.removeSnapToGuidesOf(this)}},{key:"onDrag",value:function Morph_onDrag_(e){var t=e.state,n=t.dragStartMorphPosition,r=t.absDragDelta;this.position=n.addPt(r),lively_halos_dragGuides_js.showAndSnapToGuides&&lively_halos_dragGuides_js.showAndSnapToGuides(this,e.isCtrlDown(),e.isCtrlDown())}},{key:"onGrab",value:function Morph_onGrab_(e){if(e.isShiftDown()){var t=this.copy();t.position=this.transformPointToMorph(e.hand,lively_graphics.pt(0,0)),e.hand.grab(t)}else e.hand.grab(this)}},{key:"onDrop",value:function Morph_onDrop_(e){e.hand.dropMorphsOn(this)}},{key:"wantsToBeDroppedOn",value:function Morph_wantsToBeDroppedOn_(e){return!0}},{key:"onDropHoverIn",value:function Morph_onDropHoverIn_(e){}},{key:"onDropHoverUpdate",value:function Morph_onDropHoverUpdate_(e){}},{key:"onDropHoverOut",value:function Morph_onDropHoverOut_(e){}},{key:"onBeingDroppedOn",value:function Morph_onBeingDroppedOn_(e,t){t.addMorph(this)}},{key:"onHoverIn",value:function Morph_onHoverIn_(e){}},{key:"onHoverOut",value:function Morph_onHoverOut_(e){}},{key:"onScroll",value:function Morph_onScroll_(e){}},{key:"onMouseWheel",value:function Morph_onMouseWheel_(e){}},{key:"onNativeDrop",value:function Morph_onNativeDrop_(e){}},{key:"onNativeDragleave",value:function Morph_onNativeDragleave_(e){}},{key:"onNativeDragenter",value:function Morph_onNativeDragenter_(e){}},{key:"onNativeDragover",value:function Morph_onNativeDragover_(e){}},{key:"onNativeDragend",value:function Morph_onNativeDragend_(e){}},{key:"onNativeDragstart",value:function Morph_onNativeDragstart_(e){}},{key:"onNativeDrag",value:function Morph_onNativeDrag_(e){}},{key:"focus",value:function Morph_focus_(){var e=this.env.eventDispatcher;e&&e.focusMorph(this)}},{key:"onFocus",value:function Morph_onFocus_(e){}},{key:"onBlur",value:function Morph_onBlur_(e){}},{key:"isFocused",value:function Morph_isFocused_(){var e=this.env.eventDispatcher;return e&&e.isMorphFocused(this)}},{key:"exportToJSON",value:function Morph_exportToJSON_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{keepFunctions:!0},n=Object.keys(this._morphicState).reduce(function(t,n){var r=e[n];return"submorphs"===n&&(r=r.map(function(e){return e.exportToJSON()})),t[n]=r,t},{});return n.name||(n.name=this.name),n._id=this._id,n.type=this.constructor,t.keepFunctions&&Object.keys(this).forEach(function(t){return"function"==typeof e[t]&&(n[t]=e[t])}),n}},{key:"initFromJSON",value:function Morph_initFromJSON_(e){return this._env=MorphicEnv.default(),this._rev=0,this._owner=null,this._dirty=!0,this._rendering=!1,this._submorphOrderChanged=!1,this._id=newMorphId$$1(this.constructor.name),this._animationQueue=new AnimationQueue(this),this._cachedPaths={},this._pathDependants=[],this._tickingScripts=[],this.initializeProperties(),Object.assign(this,e),this}},{key:"copyViaJSON",value:function Morph_copyViaJSON_(){var e=this.exportToJSON();return lively_lang.tree.prewalk(e,function(e){return e._id=newMorphId$$1(e.type)},function(e){return e.submorphs}),e.name=e.name.replace(/copy( [0-9]+)?$/,function(e,t){return"copy "+(t&&t.trim()?Number(t)+1:"1")}),morph$2(Object.assign({attributeConnections:[]},e))}},{key:"copy",value:function Morph_copy_(){return copyMorph(this)}},{key:"interactivelyPublish",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee11(){var e,t,n,r;return regeneratorRuntime.wrap(function _callee11$(i){for(;;)switch(i.prev=i.next){case 0:return e=this.world()||this.env.world,i.prev=1,i.next=4,System.import("lively.morphic/partsbin.js");case 4:return t=i.sent,n=t.interactivelySavePart,i.next=8,n(this,{notifications:!1,loadingIndicator:!0});case 8:r=i.sent,e.setStatusMessage(r?"Published "+this+" as "+r.name:"Failed to publish part "+this,r?lively_graphics.Color.green:lively_graphics.Color.red),i.next=15;break;case 12:i.prev=12,i.t0=i.catch(1),"canceled"!=i.t0&&e.showError(i.t0);case 15:case"end":return i.stop()}},_callee11,this,[[1,12]])}));return function Morph_interactivelyPublish_(){return e.apply(this,arguments)}}()},{key:"makeDirty",value:function Morph_makeDirty_(){this._dirty=!0,this.owner&&this.owner.makeDirty()}},{key:"needsRerender",value:function Morph_needsRerender_(){return this._dirty}},{key:"aboutToRender",value:function Morph_aboutToRender_(e){this._dirty=!1,this._rendering=!0}},{key:"onAfterRender",value:function Morph_onAfterRender_(e){}},{key:"whenRendered",value:function Morph_whenRendered_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return this.env.whenRendered(this,e).then(function(){return!0}).catch(function(){return!1})}},{key:"render",value:function Morph_render_(e){return e.renderMorph(this)}},{key:"applyLayoutIfNeeded",value:function Morph_applyLayoutIfNeeded_(){if(this._dirty){for(var e in this.submorphs)this.submorphs[e].applyLayoutIfNeeded();this.layout&&!this.layout.manualUpdate&&this.layout.forceLayout()}}},{key:"requestStyling",value:function Morph_requestStyling_(){this.withAllSubmorphsDo(function(e){e._wantsStyling=!0,e.makeDirty()})}},{key:"renderAsRoot",value:function Morph_renderAsRoot_(e){var t=this;return this.dontRecordChangesWhile(function(){var e=t._stylingVisitor;e||(e=t._stylingVisitor=new StylingVisitor(t)),e.visit(),t.applyLayoutIfNeeded()}),renderRootMorph(this,e)}},{key:"renderPreview",value:function Morph_renderPreview_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.env.renderer).renderPreview(this,e)}},{key:"startStepping",value:function Morph_startStepping_(){var e=Array.from(arguments),t="number"==typeof e[0]?e.shift():null,n=e.shift(),r=new TargetScript(this,n,e);return this.removeEqualScripts(r),this._tickingScripts.push(r),r.startTicking(t),r}},{key:"tickingScripts",get:function get(){return this._tickingScripts}},{key:"stopStepping",value:function Morph_stopStepping_(){lively_lang.arr.invoke(this._tickingScripts,"stop"),this._tickingScripts.length=[]}},{key:"stopSteppingScriptNamed",value:function Morph_stopSteppingScriptNamed_(e){var t=this._tickingScripts.filter(function(t){return t.selector===e});this.stopScripts(t)}},{key:"stopScripts",value:function Morph_stopScripts_(e){lively_lang.arr.invoke(e,"stop"),this._tickingScripts=lively_lang.arr.withoutAll(this._tickingScripts,e)}},{key:"suspendStepping",value:function Morph_suspendStepping_(){this._tickingScripts&&lively_lang.arr.invoke(this._tickingScripts,"suspend")}},{key:"suspendSteppingAll",value:function Morph_suspendSteppingAll_(){this.withAllSubmorphsDo(function(e){return e.suspendStepping()})}},{key:"resumeStepping",value:function Morph_resumeStepping_(){lively_lang.arr.invoke(this._tickingScripts,"resume")}},{key:"resumeSteppingAll",value:function Morph_resumeSteppingAll_(){this.withAllSubmorphsDo(function(e){return lively_lang.arr.invoke(e._tickingScripts,"resume")})}},{key:"removeEqualScripts",value:function Morph_removeEqualScripts_(e){this.stopScripts(this._tickingScripts.filter(function(t){return t.equals(e)}))}},{key:"commands",get:function get(){return this._commands||[]}},{key:"commands",set:function set(e){this._commands&&this.removeCommands(this._commands),this.addCommands(e)}},{key:"commandsIncludingOwners",get:function get(){return lively_lang.arr.flatmap([this].concat(this.ownerChain()),function(e){return lively_lang.arr.sortByKey(e.commands,"name").map(function(t){return{target:e,command:t}})})}},{key:"addCommands",value:function Morph_addCommands_(e){var t=this;this.addMethodCallChangeDoing({target:this,selector:"addCommands",args:[e],undo:{target:this,selector:"removeCommands",args:[e]}},function(){t.removeCommands(e),t._commands=(t._commands||[]).concat(e)})}},{key:"removeCommands",value:function Morph_removeCommands_(e){var t=this;this.addMethodCallChangeDoing({target:this,selector:"removeCommands",args:[e],undo:{target:this,selector:"addCommands",args:[e]}},function(){var n=e.map(function(e){return"string"==typeof e?e:e.name}),r=(t._commands||[]).filter(function(e){var t=e.name;return!n.includes(t)});r.length?t._commands=r:delete t._commands})}},{key:"commandHandler",get:function get(){return this._commandHandler||defaultCommandHandler}},{key:"lookupCommand",value:function Morph_lookupCommand_(e){var t=this.commandHandler.lookupCommand(e,this);return t&&t.command?t:null}},{key:"execCommand",value:function Morph_execCommand_(e,t,n,r){return this.commandHandler.exec(e,this,t,n,r)}}],[{key:"propertySettings",get:function get(){return{defaultGetter:function defaultGetter(e){return this.getProperty(e)},defaultSetter:function defaultSetter(e,t){this.setProperty(e,t)},valueStoreProperty:"_morphicState"}}},{key:"properties",get:function get(){return Object.assign({name:{group:"core",initialize:function initialize(e){if(!e){var t=this.constructor.name;e=(lively_lang.string.startsWithVowel(t)?"an":"a")+t}this.name=e}},draggable:{group:"interaction",isStyleProp:!0,defaultValue:!0},grabbable:{group:"interaction",isStyleProp:!0,defaultValue:!1,set:function set(e){e&&!this.draggable&&(this.draggable=!0),this.setProperty("grabbable",e)}},acceptsDrops:{group:"interaction",isStyleProp:!0,defaultValue:!0},dropShadow:{group:"styling",type:"Shadow",isStyleProp:!0,defaultValue:null,set:function set(e){e&&!e.isShadowObject&&((e=new ShadowObject(e)).morph=this),this.setProperty("dropShadow",e)}},tooltip:{group:"core",defaultValue:null},focusable:{group:"interaction",defaultValue:!0},nativeCursor:{group:"interaction",type:"Enum",values:["auto","default","none","context-menu","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","no-drop","not-allowed","e-resize","n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize","w-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","col-resize","row-resize","all-scroll","zoom-in","zoom-out","grab","grabbing"],isStyleProp:!0,defaultValue:"auto"},halosEnabled:{group:"interaction",isStyleProp:!0,defaultValue:!!config$1.halosEnabled},reactsToPointer:{group:"interaction",isStyleProp:!0,defaultValue:!0},position:{group:"geometry",type:"Point",isStyleProp:!0,defaultValue:lively_graphics.pt(0,0)},origin:{group:"geometry",type:"Point",isStyleProp:!0,defaultValue:lively_graphics.pt(0,0)},extent:{group:"geometry",type:"Point",isStyleProp:!0,defaultValue:lively_graphics.pt(10,10),set:function set(e){var t=this.extent;if(this.setProperty("extent",e),!this.origin.equals(lively_graphics.pt(0,0))){var n=lively_graphics.pt(e.x/t.x,e.y/t.y);this.adjustOrigin(this.origin.scaleByPt(n))}}},width:{group:"geometry",derived:!0,after:["extent"],before:["submorphs"],get:function get(){return this.extent.x},set:function set(e){return this.extent=lively_graphics.pt(e,this.extent.y)}},height:{group:"geometry",derived:!0,after:["extent"],before:["submorphs"],get:function get(){return this.extent.y},set:function set(e){return this.extent=lively_graphics.pt(this.extent.x,e)}},left:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().left()},set:function set(e){return this.moveBy(lively_graphics.pt(e-this.left),0)}},right:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().right()},set:function set(e){return this.moveBy(lively_graphics.pt(e-this.right),0)}},top:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().top()},set:function set(e){return this.moveBy(lively_graphics.pt(0,e-this.top))}},bottom:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().bottom()},set:function set(e){return this.moveBy(lively_graphics.pt(0,e-this.bottom))}},center:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().center()},set:function set(e){return this.align(this.center,e)}},topLeft:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().topLeft()},set:function set(e){return this.align(this.topLeft,e)}},topRight:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().topRight()},set:function set(e){return this.align(this.topRight,e)}},bottomRight:{group:"geometry",derived:!0,after:["extent","layout"],get:function get(){return this.bounds().bottomRight()},set:function set(e){return this.align(this.bottomRight,e)}},bottomLeft:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().bottomLeft()},set:function set(e){return this.align(this.bottomLeft,e)}},bottomCenter:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().bottomCenter()},set:function set(e){return this.align(this.bottomCenter,e)}},topCenter:{group:"geometry",derived:!0,after:["extent","submorphs","layout"],get:function get(){return this.bounds().topCenter()},set:function set(e){return this.align(this.topCenter,e)}},leftCenter:{group:"geometry",derived:!0,after:["extent","submorphs"],get:function get(){return this.bounds().leftCenter()},set:function set(e){return this.align(this.leftCenter,e)}},rightCenter:{group:"geometry",derived:!0,after:["extent","submorphs"],get:function get(){return this.bounds().rightCenter()},set:function set(e){return this.align(this.rightCenter,e)}},rotation:{group:"geometry",type:"Number",isFloat:!0,isStyleProp:!0,defaultValue:0},scale:{group:"geometry",type:"Number",min:0,isFloat:!0,isStyleProp:!0,defaultValue:1},hasFixedPosition:{group:"geometry",doc:"When morph is submorph of world hasFixedPosition == true will keep the morph at the same position relative to top left of the browser window. This means, when the world is scrolled, the morph keeps its place.",defaultValue:!1},opacity:{group:"styling",type:"Number",min:0,max:1,isStyleProp:!0,defaultValue:1},fill:{group:"styling",type:"ColorGradient",isStyleProp:!0,defaultValue:lively_graphics.Color.white},visible:{group:"styling",isStyleProp:!0,defaultValue:!0,set:function set(e){e||this.makeDirty(),this.setProperty("visible",e)}},submorphs:{group:"core",defaultValue:[],after:["isLayoutable","origin","position","rotation","scale"],get:function get(){return(this.getProperty("submorphs")||[]).concat()},set:function set(e){var t=this,n=this.layout,r=n&&n.isEnabled();r&&n.disable(),this.submorphs.forEach(function(t){return e.includes(t)||t.remove()}),e.forEach(function(e,n){return t.submorphs[n]!==e&&t.addMorph(e,t.submorphs[n])}),r&&n.enable()}},clipMode:{group:"styling",type:"Enum",values:["visible","hidden","scroll","auto"],isStyleProp:!0,defaultValue:"visible",set:function set(e){this.setProperty("clipMode",e),this.isClip()||(this.scroll=lively_graphics.pt(0,0))}},scroll:{group:"geometry",defaultValue:lively_graphics.pt(0,0),after:["clipMode","submorphs"],type:"Point",set:function set(e){var t=e.x,n=e.y;if(this.isClip()){var r=this.scrollExtent.subPt(this.extent),i=r.x,o=r.y;t=Math.max(0,Math.min(i,t)),n=Math.max(0,Math.min(o,n)),this.setProperty("scroll",lively_graphics.pt(t,n)),this.makeDirty()}}},scrollbarOffset:{group:"styling",defaultValue:lively_graphics.pt(15,15)},styleClasses:{group:"styling",isStyleProp:!0,defaultValue:["morph"],get:function get(){return this.constructor.styleClasses.concat(this.getProperty("styleClasses"))},set:function set(e){this.setProperty("styleClasses",lively_lang.arr.withoutAll(e,this.constructor.styleClasses)),this.requestStyling()}},layout:{group:"layouting",isStyleProp:!0,type:"Layout",after:["submorphs","extent","origin","position","isLayoutable","styleSheets"],set:function set(e){e&&(e.container=this),this.setProperty("layout",e)}},isLayoutable:{group:"layouting",isStyleProp:!0,defaultValue:!0},borderLeft:{group:"styling",isStyleProp:!0,derived:!0,after:["borderStyleLeft","borderWidthLeft","borderColorLeft"],get:function get(){return{style:this.borderStyleLeft,width:this.borderWidthLeft,color:this.borderColorLeft}},set:function set(e){"style"in e&&(this.borderStyleLeft=e.style),"width"in e&&(this.borderWidthLeft=e.width),"color"in e&&(this.borderColorLeft=e.color),"radius"in e&&(this.borderRadiusLeft=e.radius)}},borderRight:{group:"styling",isStyleProp:!0,derived:!0,after:["borderStyleRight","borderWidthRight","borderColorRight"],get:function get(){return{style:this.borderStyleRight,width:this.borderWidthRight,color:this.borderColorRight}},set:function set(e){"style"in e&&(this.borderStyleRight=e.style),"width"in e&&(this.borderWidthRight=e.width),"color"in e&&(this.borderColorRight=e.color),"radius"in e&&(this.borderRadiusRight=e.radius)}},borderBottom:{group:"styling",isStyleProp:!0,derived:!0,after:["borderStyleBottom","borderWidthBottom","borderColorBottom"],get:function get(){return{style:this.borderStyleBottom,width:this.borderWidthBottom,color:this.borderColorBottom}},set:function set(e){"style"in e&&(this.borderStyleBottom=e.style),"width"in e&&(this.borderWidthBottom=e.width),"color"in e&&(this.borderColorBottom=e.color),"radius"in e&&(this.borderRadiusBottom=e.radius)}},borderTop:{group:"styling",isStyleProp:!0,derived:!0,after:["borderStyleTop","borderWidthTop","borderColorTop"],get:function get(){return{style:this.borderStyleTop,width:this.borderWidthTop,color:this.borderColorTop}},set:function set(e){"style"in e&&(this.borderStyleTop=e.style),"width"in e&&(this.borderWidthTop=e.width),"color"in e&&(this.borderColorTop=e.color),"radius"in e&&(this.borderRadiusTop=e.radius)}},borderWidth:{group:"styling",isStyleProp:!0,type:"Number",foldable:["top","left","right","bottom"],min:0,defaultValue:{top:0,bottom:0,left:0,right:0,valueOf:function valueOf(){return 0}},get:function get(){var e=this.getProperty("borderWidth");return Object.assign({},e,{valueOf:function valueOf(){return e.left}})},set:function set(e){lively_lang.obj.isNumber(e)&&(e={left:e,right:e,top:e,bottom:e});this.setProperty("borderWidth",e)}}},generateUnfolded("borderWidth",void 0,"styling"),{borderRadius:{group:"styling",isStyleProp:!0,type:"Number",min:0,foldable:["top","left","right","bottom"],defaultValue:{top:0,bottom:0,right:0,left:0,valueOf:function valueOf(){return 0}},get:function get(){var e=this.getProperty("borderRadius");return Object.assign({},e,{valueOf:function valueOf(){return e.left}})},set:function set(e){(e||(e=0),lively_lang.obj.isNumber(e))&&(e={left:e,right:e,top:e,bottom:e});e.isRectangle&&(e={left:e.left(),right:e.right(),top:e.top(),bottom:e.bottom()}),this.setProperty("borderRadius",e)}}},generateUnfolded("borderRadius",void 0,"styling"),{borderStyle:{group:"styling",isStyleProp:!0,type:"Enum",foldable:["top","left","right","bottom"],values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset"],defaultValue:{top:"solid",left:"solid",bottom:"solid",right:"solid",valueOf:function valueOf(){return"solid"}},get:function get(){var e=this.getProperty("borderStyle");return Object.assign({},e,{valueOf:function valueOf(){return e.left}})},set:function set(e){lively_lang.obj.isString(e)&&(e={left:e,right:e,top:e,bottom:e});this.setProperty("borderStyle",e)}}},generateUnfolded("borderStyle",void 0,"styling"),{borderColor:{group:"styling",isStyleProp:!0,type:"Color",foldable:["top","left","right","bottom"],defaultValue:{top:lively_graphics.Color.white,left:lively_graphics.Color.white,bottom:lively_graphics.Color.white,right:lively_graphics.Color.white,valueOf:function valueOf(){return lively_graphics.Color.white}},get:function get(){var e=this.getProperty("borderColor");return Object.assign({},e,{valueOf:function valueOf(){return e.left}})},set:function set(e){e||(e=lively_graphics.Color.white),e.isColor&&(e={top:e,left:e,right:e,bottom:e}),this.setProperty("borderColor",e?lively_lang.obj.extract(e,["top","left","right","bottom"],function(e,t){return lively_lang.obj.isArray(t)?lively_graphics.Color.fromTuple(t):t}):e)}}},generateUnfolded("borderColor",void 0,"styling"),{border:{group:"styling",isStyleProp:!0,derived:!0,after:["borderStyle","borderWidth","borderColor"],get:function get(){var e=this;return{get style(){return e.borderStyle},set style(t){e.borderStyle=t},get width(){return e.borderWidth},set width(t){e.borderWidth=t},get color(){return e.borderColor},set color(t){e.borderColor=t},get borderRadius(){return e.borderRadius},set borderRadius(t){e.borderRadius=t}}},set:function set(e){"style"in e&&(this.borderStyle=e.style),"width"in e&&(this.borderWidth=e.width),"color"in e&&(this.borderColor=e.color),"radius"in e&&(this.borderRadius=e.radius)}},styleSheets:{group:"styling",before:["submorphs"],type:"StyleSheets",defaultValue:[],set:function set(e){var t=this;lively_lang.obj.isArray(e)||(e=[e]),this.setProperty("styleSheets",e),e.forEach(function(e){e.context=t}),this.requestStyling()}},styleProperties:{group:"styling",derived:!0,readOnly:!0,get:function get(){var e=this.propertiesAndPropertySettings().properties,t=[];for(var n in e)e[n].isStyleProp&&t.push(n);return t}},style:{group:"styling",derived:!0,readOnly:!0,get:function get(){for(var e=this.styleProperties,t={},n=0;n<e.length;n++){var r=e[n];t[r]=this[r]}return t}},epiMorph:{group:"core",doc:"epi morphs are 'transient' morphs, i.e. meta objects that should not be serialized like halo items, menus, etc.",defaultValue:!1},respondsToVisibleWindow:{group:"interaction",doc:"Morphs will respond to changes in visible window and a call will be made to the morph's relayout function, supplying the event generated",defaultValue:!1},installedFonts:{doc:"custom fonts can be installed from a respective morph, and are then kept as part of this morph's state in order to be loaded again the next time the it is cold loaded. (i.e. deserialization of a part)",defaultValue:{},set:function set(e){var t=lively_lang.arr.without(lively_lang.obj.keys(this.installedFonts||{}),"_rev"),n=lively_lang.arr.without(lively_lang.obj.keys(e||{}),"_rev");this.setProperty("installedFonts",e),this.ensureInstalledFonts(t,n)}},metadata:{group:"core"}})}},{key:"styleClasses",get:function get(){if(this.hasOwnProperty("_styclassNames"))return this._styleClasses;for(var e=this,t=[];e&&e!==Object;)t.push(e.name),e=e[Symbol.for("lively-instance-superclass")];return this._styleClasses=t}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1930,end:85941})}(void 0),Ellipse=function(e){var t=_classRecorder,n=t.hasOwnProperty("Ellipse")&&"function"==typeof t.Ellipse?t.Ellipse:t.Ellipse=function Ellipse(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,void 0,[{key:"properties",get:function get(){return{borderRadius:{get:function get(){return{top:this.borderRadiusTop,right:this.borderRadiusRight,left:this.borderRadiusLeft,bottom:this.borderRadiusBottom}}},borderRadiusLeft:{get:function get(){return this.height},set:function set(){}},borderRadiusRight:{get:function get(){return this.height},set:function set(){}},borderRadiusTop:{get:function get(){return this.width},set:function set(){}},borderRadiusBottom:{get:function get(){return this.width},set:function set(){}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:85951,end:86623})}({referencedAs:"Morph",value:Morph}),Triangle=function(e){var t=_classRecorder,n=t.hasOwnProperty("Triangle")&&"function"==typeof t.Triangle?t.Triangle:t.Triangle=function Triangle(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Triangle_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.update()}},{key:"onChange",value:function Triangle_onChange_(e){("extent"==e.prop||"direction"==e.prop||"fill"==e.prop&&e.value)&&this.update(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onChange",this).call(this,e)}},{key:"update",value:function Triangle_update_(){var e,t=this.extent,n=t.x,r=t.y;n!=r&&(this.extent=lively_graphics.pt(Math.max(n,r),Math.max(n,r))),this.origin=lively_graphics.pt(n/2,r/2);var i=this.triangleFill=this.fill||this.triangleFill;this.fill=null;var o,a,s,l={width:n/2,style:"solid",color:i},c={width:r/2,style:"solid",color:lively_graphics.Color.transparent};switch(this.direction){case"down":o="borderLeft",a="borderRight",s="borderTop";break;case"up":o="borderLeft",a="borderRight",s="borderBottom";break;case"left":o="borderBottom",a="borderTop",s="borderRight";break;case"right":o="borderBottom",a="borderTop",s="borderLeft"}Object.assign(this,(defineProperty(e={},o,c),defineProperty(e,a,c),defineProperty(e,s,l),e))}}],[{key:"properties",get:function get(){return{direction:{defaultValue:"up"},triangleFill:{after:["fill"],initialize:function initialize(){this.triangleFill=this.fill}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:86632,end:88047})}({referencedAs:"Morph",value:Morph}),Image=function(e){var t=_classRecorder,n=t.hasOwnProperty("Image")&&"function"==typeof t.Image?t.Image:t.Image=function Image(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"__deserialize__",value:function Image___deserialize___(e,t){this._isDeserializing=!0,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__deserialize__",this).call(this,e,t)}},{key:"__after_deserialize__",value:function Image___after_deserialize___(e,t){delete this._isDeserializing,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__after_deserialize__",this).call(this,e,t)}},{key:"isImage",get:function get(){return!0}},{key:"ratio",get:function get(){var e=this.naturalExtent;return e.x/e.y}},{key:"setWidthKeepingRatio",value:function Image_setWidthKeepingRatio_(e){this.width=e,this.height=e/this.ratio}},{key:"setHeightKeepingRatio",value:function Image_setHeightKeepingRatio_(e){this.width=this.ratio*e,this.height=e}},{key:"loadUrl",value:function Image_loadUrl_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.autoResize,r=this.autoResize;return this.autoResize=n,this.imageUrl=e,lively_lang.promise.finally(this.whenLoaded(),function(){return t.autoResize=r})}},{key:"whenLoaded",value:function Image_whenLoaded_(){var e=this;return this.isLoaded?Promise.resolve(this):new Promise(function(t,n){var r=e.imageUrl;e.imageElement(function(i){e.imageUrl!==r&&n(new Error("url changed ("+r+" => "+e.imageUrl+")")),e.naturalExtent=lively_graphics.pt(i.width,i.height),e.isLoaded=!0,t(e)})})}},{key:"determineNaturalExtent",value:function Image_determineNaturalExtent_(){var e=this;return this.whenLoaded().then(function(){return e.naturalExtent})}},{key:"render",value:function Image_render_(e){return e.renderImage(this)}},{key:"clear",value:function Image_clear_(){return this.loadUrl("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",!1)}},{key:"imageElement",value:function Image_imageElement_(e){var t=this;return new Promise(function(n,r){var i=t.env.domEnv.document.createElement("img");i.onload=function(){n(i),"function"==typeof e&&e(i)},i.src=t.imageUrl})}},{key:"canvasElementAndContext",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee12(){var e,t,n,r;return regeneratorRuntime.wrap(function _callee12$(i){for(;;)switch(i.prev=i.next){case 0:return e=this.env.domEnv.document,i.next=3,this.imageElement();case 3:return t=i.sent,n=e.createElement("canvas"),r=n.getContext("2d"),n.width=t.width,n.height=t.height,r.drawImage(t,0,0,t.width,t.height),i.abrupt("return",{canvas:n,ctx:r,image:t});case 10:case"end":return i.stop()}},_callee12,this)}));return function Image_canvasElementAndContext_(){return e.apply(this,arguments)}}()},{key:"imageData",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee13(e){var t,n,r,i,o,a,s,l;return regeneratorRuntime.wrap(function _callee13$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,this.canvasElementAndContext();case 2:return t=c.sent,n=t.ctx,r=t.image,e||(e=lively_graphics.rect(0,0,r.width,r.height)),o=(i=e).x,a=i.y,s=i.width,l=i.height,console.log(o,a),c.abrupt("return",n.getImageData(o,a,s,l));case 9:case"end":return c.stop()}},_callee13,this)}));return function Image_imageData_(t){return e.apply(this,arguments)}}()},{key:"pixelAt",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee14(e){return regeneratorRuntime.wrap(function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.imageData(e.extent(lively_graphics.pt(1,1)));case 2:return t.abrupt("return",t.sent.data);case 3:case"end":return t.stop()}},_callee14,this)}));return function Image_pixelAt_(t){return e.apply(this,arguments)}}()},{key:"colorAt",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee15(e){return regeneratorRuntime.wrap(function _callee15$(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=lively_graphics.Color,t.next=3,this.pixelAt(e);case 3:return t.t1=t.sent,t.abrupt("return",t.t0.fromTuple8Bit.call(t.t0,t.t1));case 5:case"end":return t.stop()}},_callee15,this)}));return function Image_colorAt_(t){return e.apply(this,arguments)}}()},{key:"loadArrayBuffer",value:function Image_loadArrayBuffer_(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=new Uint8Array(e),n=new Blob([t],{type:"image/jpeg"}),r=(window.URL||window.webkitURL).createObjectURL(n);this.imageUrl=r,this.makeDirty()}},{key:"convertToBase64",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee16(){var e,t,n,r,i,o,a;return regeneratorRuntime.wrap(function _callee16$(s){for(;;)switch(s.prev=s.next){case 0:return e=this.imageUrl,"jpg"===(t=e.slice(e.lastIndexOf(".")+1,e.length).toLowerCase())?t="jpeg":"svg"===t&&(t="svg+xml"),["gif","jpeg","png","tiff","svg+xml"].includes(t)||(t="gif"),e.startsWith("http")||(e=location.origin+"/"+e),s.next=7,System.import("lively.ide/shell/shell-interface");case 7:return n=s.sent,r=n.runCommand,i='curl --silent "'+e+'" | openssl base64',s.next=12,r(i).whenDone();case 12:return o=s.sent,a=o.stdout,s.abrupt("return",this.loadUrl("data:image/"+t+";base64,"+a,!1));case 15:case"end":return s.stop()}},_callee16,this)}));return function Image_convertToBase64_(){return e.apply(this,arguments)}}()},{key:"downloadImage",value:function Image_downloadImage_(){var e,t=this.imageUrl;if(t.match(/^data:image/)){e=this.name||"image-from-lively";var n=t.match(/image\/([^;]+)/);n&&n[1]&&(e+="."+n[1])}else e||(e=lively_lang.arr.last(t.split("/")));var r=document.createElement("a");r.download=e,r.href=t,r.click()}},{key:"convertTo",value:function Image_convertTo_(e,t){t||(t=1);var n=this.canvasElementAndContext(),r=n.ctx,i=n.canvas,o=n.image,a=this.width,s=this.height;return i.width=o.width,i.height=o.height,r.drawImage(o,0,0,a,s),this.loadUrl(i.toDataURL(e,t),!1)}},{key:"resampleImageToFitBounds",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee17(){var e,t,n,r,i,o,a,s,l;return regeneratorRuntime.wrap(function _callee17$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,this.canvasElementAndContext();case 2:return e=c.sent,t=e.ctx,n=e.canvas,r=e.image,i=this.width,o=this.height,a=r.width,s=r.height,n.width=a,n.height=s,t.drawImage(r,0,0,i,o),l=t.getImageData(0,0,a,s),n.width=i,n.height=o,t.putImageData(l,0,0),c.abrupt("return",this.loadUrl(n.toDataURL(),!1));case 18:case"end":return c.stop()}},_callee17,this)}));return function Image_resampleImageToFitBounds_(){return e.apply(this,arguments)}}()},{key:"crop",value:function Image_crop_(e){var t=this.canvasElementAndContext(),n=t.ctx,r=t.canvas,i=t.image,o=(this.width,this.height,this.innerBounds()),a=i.width,s=i.height,l=o.intersection(e),c=new lively_graphics.Rectangle(l.x/o.width,l.y/o.height,l.width/o.width,l.height/o.height),u=new lively_graphics.Rectangle(0,0,a,s).divide([c]),h=slicedToArray(u,1)[0];r.width=a,r.height=s,n.drawImage(i,0,0,a,s);var d=n.getImageData(h.x,h.y,h.width,h.height);return r.width=h.width,r.height=h.height,n.putImageData(d,0,0),this.loadUrl(r.toDataURL(),!1)}},{key:"interactivelyChangeImageURL",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee18(){var e;return regeneratorRuntime.wrap(function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.world().prompt("Enter image url",{historyId:"lively.morphic-image-url-inputs",input:this.imageUrl.startsWith("data:")?"":this.imageUrl,requester:this});case 2:"string"==typeof(e=t.sent)&&(this.imageUrl=e);case 4:case"end":return t.stop()}},_callee18,this)}));return function Image_interactivelyChangeImageURL_(){return e.apply(this,arguments)}}()},{key:"menuItems",value:function Image_menuItems_(){var e=this,t=lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"menuItems",this).call(this);return t.unshift(["change image url...",function(){return e.interactivelyChangeImageURL()}],["resize image to its real image size",function(){return e.extent=e.naturalExtent}],["resample image to fit current bounds",function(){return e.resampleImageToFitBounds()}],{isDivider:!0}),t}}],[{key:"properties",get:function get(){return{imageUrl:{isStyleProp:!0,after:["extent","autoResize"],defaultValue:System.decanonicalize("lively.morphic/lively-web-logo-small.svg"),set:function set(e){var t=this;this.isLoaded=!1,this.setProperty("imageUrl",e),this.setProperty("naturalExtent",null);var n=this.autoResize&&!this._isDeserializing;this.whenLoaded().then(function(){t.imageUrl===e&&(t.isLoaded=!0,n&&(t.extent=t.naturalExtent))})}},fill:{defaultValue:lively_graphics.Color.transparent},naturalExtent:{defaultValue:null},isLoaded:{defaultValue:!1,serialize:!1},autoResize:{defaultValue:!1}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:88056,end:96709})}({referencedAs:"Morph",value:Morph}),PathPoint=function(e){var t=_classRecorder,n=t.hasOwnProperty("PathPoint")&&"function"==typeof t.PathPoint?t.PathPoint:t.PathPoint=function PathPoint(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function PathPoint_initialize_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.path=e,this._isSmooth=t.isSmooth||!1,this.x=t.position?t.position.x:t.x||0,this.y=t.position?t.position.y:t.y||0,this._controlPoints=t.controlPoints}},{key:"__dont_serialize__",get:function get(){return["attributeConnections","$$controlPoints","$$position","doNotCopyProperties","doNotSerialize"]}},{key:"isPathPoint",get:function get(){return!0}},{key:"isSmooth",get:function get(){return this._isSmooth||!1}},{key:"isSmooth",set:function set(e){this._isSmooth!==e&&(this._isSmooth=e,this.adaptControlPoints(e))}},{key:"position",get:function get(){return lively_graphics.pt(this.x,this.y)}},{key:"position",set:function set(e){var t=e.x,n=e.y;this.x=t,this.y=n,this.path.makeDirty()}},{key:"moveBy",value:function PathPoint_moveBy_(e){return this.position=this.position.addPt(e),this.path.onVertexChanged(this),this}},{key:"copy",value:function PathPoint_copy_(){var e=new lively_serializer2.ExpressionSerializer;return new PathPoint(this.path,e.deserializeExprObj(this.__serialize__()))}},{key:"__serialize__",value:function PathPoint___serialize___(){return{__expr__:("({\n         position: "+this.position.toString(!1)+",\n         isSmooth: "+this.isSmooth+",\n         controlPoints: {\n           next: "+this.controlPoints.next.toString(!1)+",\n           previous: "+this.controlPoints.previous.toString(!1)+"\n         }\n      })").replace(/[\n|\s]/g,""),bindings:{"lively.graphics/geometry-2d.js":["pt"]}}}},{key:"controlPoints",get:function get(){return this._controlPoints||{next:lively_graphics.pt(0,0),previous:lively_graphics.pt(0,0)}}},{key:"controlPoints",set:function set(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.next,n=e.previous;this._controlPoints={next:t?lively_graphics.Point.fromLiteral(t):lively_graphics.pt(0,0),previous:n?lively_graphics.Point.fromLiteral(n):lively_graphics.pt(0,0)},this.path.makeDirty()}},{key:"moveNextControlPoint",value:function PathPoint_moveNextControlPoint_(e){this.moveControlPoint("next",e)}},{key:"movePreviousControlPoint",value:function PathPoint_movePreviousControlPoint_(e){this.moveControlPoint("previous",e)}},{key:"moveControlPoint",value:function PathPoint_moveControlPoint_(e,t){var n,r=(r=this.controlPoints[e])?r.addPt(t):t,i="next"==e?"previous":"next",o=this.controlPoints[i];this.isSmooth&&(o=r.negated().normalized().scaleBy(o.r())),this.controlPoints=(defineProperty(n={},e,r),defineProperty(n,i,o),n),this.path.onVertexChanged(this)}},{key:"pointOnLine",value:function PathPoint_pointOnLine_(e,t,n,r){var i=lively_graphics.pt(e.x,e.y),o=lively_graphics.pt(t.x,t.y),a=o.subPt(i),s=a.scaleBy(1/a.r()),l=o.subPt(n).dotProduct(s);return o.subPt(s.scaleBy(Math.max(1,Math.min(l,a.r())))).addXY(r,r)}},{key:"nextVertex",get:function get(){return this.path.vertexAfter(this)}},{key:"previousVertex",get:function get(){return this.path.vertexBefore(this)}},{key:"adaptControlPoints",value:function PathPoint_adaptControlPoints_(e){var t=this.nextVertex,n=this.previousVertex,r=this.position,i=this.path,o=i.vertices,a=o.indexOf(this),s=0===a,l=a===o.length-1,c=n?n.position:r,u=t?t.position:r;if(e){var h=this.pointOnLine(c,u,r,i.borderWidth);this.controlPoints={previous:s?lively_graphics.pt(0,0):h.subPt(u),next:h.subPt(c)}}else this.controlPoints={previous:s?lively_graphics.pt(0,0):c.subPt(r).scaleBy(.5),next:l?lively_graphics.pt(0,0):u.subPt(r).scaleBy(.5)};i.onVertexChanged(this)}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:96718,end:100436})}(void 0),Path=function(e){var t=_classRecorder,n=t.hasOwnProperty("Path")&&"function"==typeof t.Path?t.Path:t.Path=function Path(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Path_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,Object.assign({},lively_lang.obj.dissoc(e,"origin"))),this.adjustOrigin(e.origin||this.origin),this.position=e.position||this.position,this.updateBounds(this.vertices)}},{key:"__after_deserialize__",value:function Path___after_deserialize___(e,t){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__after_deserialize__",this).call(this,e,t),this.updateBounds(this.vertices)}},{key:"__additionally_serialize__",value:function Path___additionally_serialize___(e,t,r,i){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__additionally_serialize__",this).call(this,e,t,r,i);var o=this.borderColor.valueOf();o&&(e.props.borderColor={key:"borderColor",value:r.expressionSerializer.exprStringEncode({__expr__:o.toJSExpr(),bindings:{"lively.graphics/geometry-2d.js":["pt","rect"],"lively.graphics/color.js":["Color",o.constructor.name]}})})}},{key:"isPath",get:function get(){return!0}},{key:"isSvgMorph",get:function get(){return!0}},{key:"onVertexChanged",value:function Path_onVertexChanged_(e){this.makeDirty(),this.updateBounds(this.vertices)}},{key:"copyVertices",value:function Path_copyVertices_(){return this.vertices.map(function(e){return e.copy()})}},{key:"updateBounds",value:function Path_updateBounds_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.vertices;if(e.length&&!this._adjustingVertices){this._adjustingVertices=!0;var t=this.origin,n=this.extent,r=n.x,i=n.y,o=t.x/r,a=t.y/i,s=[];e.forEach(function(t,n){var r=t.isSmooth,i=t.position,o=t.controlPoints||{},a=o.next,l=o.previous;s.push(i),r&&n>0&&n<e.length-1&&s.push(i.addPt(a),i.addPt(l))});var l=lively_graphics.Rectangle.unionPts(s),c=lively_graphics.pt(l.width*o,l.height*a),u=l.topLeft();e.forEach(function(e){return e.moveBy(u.negated())}),this.moveBy(this.getTransform().transformDirection(u)),this.extent=l.extent(),this.origin=c,this._adjustingVertices=!1}}},{key:"onChange",value:function Path_onChange_(e){var t=e.prop,r=e.value,i=e.prevValue,o=this._adjustingVertices,a=this._adjustingOrigin;"extent"==t&&r&&i&&!o&&this.adjustVertices(r.scaleByPt(i.inverted())),(!a&&"vertices"===t||"borderWidthLeft"===t)&&this.updateBounds("vertices"==t?r:this.vertices),o||"origin"!==t||this.updateBounds(this.vertices),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onChange",this).call(this,e)}},{key:"vertexBefore",value:function Path_vertexBefore_(e){var t=this.vertices.indexOf(e)-1;return this.vertices[t>=0?t:this.vertices.length-1]}},{key:"vertexAfter",value:function Path_vertexAfter_(e){var t=this.vertices.indexOf(e)+1;return this.vertices[t>this.vertices.length-1?0:t]}},{key:"adjustVertices",value:function Path_adjustVertices_(e){var t=this,n=this.vertices;n&&n.forEach(function(n){var r=n.controlPoints,i=r.next,o=r.previous;i=i.scaleByPt(e),o=o.scaleByPt(e),n.position=n.position.addPt(t.origin).scaleByPt(e).subPt(t.origin),n.controlPoints={next:i,previous:o}})}},{key:"adjustOrigin",value:function Path_adjustOrigin_(e){this._adjustingOrigin=!0;var t=this.vertices,r=this.origin;t.forEach(function(t){return t.position=r.subPt(e).addXY(t.x,t.y)}),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"adjustOrigin",this).call(this,e),this._adjustingOrigin=!1}},{key:"addVertex",value:function Path_addVertex_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.vertices,r="number"==typeof t?t:t&&t.isPathPoint?n.indexOf(t):void 0;"number"==typeof r&&r>-1?n.splice(r,0,e):n.push(e),this.vertices=n}},{key:"addVertexCloseTo",value:function Path_addVertexCloseTo_(e){var t=this.verticesCloseTo(e),n=t.closest,r=n.length,i=n.vertex,o=t.next,a=this.findClosestPointOnPath(e,10,3),s=a.length,l=a.point,c=s<=r?i:o?o.vertex:null;return this.addVertex(l,c)}},{key:"render",value:function Path_render_(e){return e.renderPath(this)}},{key:"_pathNode",get:function get(){var e=this.env.renderer.getNodeForMorph(this);return e&&e.querySelector("#svg"+lively_lang.string.regExpEscape(this.id))}},{key:"verticesCloseTo",value:function Path_verticesCloseTo_(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.vertices,r=[],i=1/0,o=-1,a=0;a<n.length;a++){var s=n[a].position.dist(e);r.push(s),s>=i||(i=s,o=a)}var l=0===o?null:{index:o-1,vertex:n[o-1]},c=o===n.length-1?null:{index:o+1,vertex:n[o+1]},u={index:o,vertex:n[o]};if(t){var h=this._pathNode;if(l){var d=this.findClosestPointOnPath(l.vertex.position,6,3,h).length;l.length=d}if(c){var p=this.findClosestPointOnPath(c.vertex.position,6,3,h).length;c.length=p}var f=this.findClosestPointOnPath(u.vertex.position,6,3,h).length;u.length=f}return{previous:l,next:c,closest:u}}},{key:"findClosestPointOnPath",value:function Path_findClosestPointOnPath_(e,t,n,r){if(!r){var i=this.env.renderer.getNodeForMorph(this);r=i&&i.querySelector("#svg"+lively_lang.string.regExpEscape(this.id))}return r?function findClosestPointOnPath(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3;var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:e.getTotalLength();var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;var s=function samplePathPoints(e,t,n,r){var i=[],o=(n-t)/(r-1),a=0;for(i.push([lively_graphics.Point.ensure(e.getPointAtLength(t)),t,a]),a=1;a<r-1;a++){var s=t+a*o;i.push([lively_graphics.Point.ensure(e.getPointAtLength(s)),s,a])}return i.push([lively_graphics.Point.ensure(e.getPointAtLength(n)),n,a]),i}(e,o,i,n),l=1/0,c=-1;var u=!0;var h=!1;var d=void 0;try{for(var p,f=s[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=slicedToArray(p.value,3),m=g[0],v=(g[1],g[2]),y=t.dist(m);y>=l||(l=y,c=v)}}catch(e){h=!0,d=e}finally{try{!u&&f.return&&f.return()}finally{if(h)throw d}}if(a>=r){var _=slicedToArray(s[c],2),b=_[0],x=_[1];return{point:b,length:x}}i=s[Math.max(0,c-1)][1];o=s[Math.min(s.length-1,c+1)][1];return findClosestPointOnPath(e,t,n,r,i,o,a+1)}(r,e,t,n):{length:0,point:e}}},{key:"onDragStart",value:function Path_onDragStart_(e){var t=e.domEvt.target,r=lively_lang.Path("attributes.class.value").get(t);if(!r||!r.includes("path-point"))return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onDragStart",this).call(this,e);var i=r.match(/path-point-([0-9]+)(?:-control-([0-9]+))?$/),o=slicedToArray(i,3),a=(o[0],o[1]),s=o[2];this._controlPointDrag={marker:t,n:Number(a)},void 0!==s&&(this._controlPointDrag.ctrlN=Number(s))}},{key:"onDrag",value:function Path_onDrag_(e){if(!this._controlPointDrag)return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onDrag",this).call(this,e);var t=this._controlPointDrag,r=(t.target,t.n),i=t.ctrlN,o=this.vertices,a=o[r];if(a){var s=this.getInverseTransform().transformDirection(e.state.dragDelta);if(void 0===i){a.moveBy(s);var l=o[r-1],c=o[r+1];l&&l.position.dist(a.position)<10?this._controlPointDrag.maybeMerge=[r-1,r]:c&&c.position.dist(a.position)<10?this._controlPointDrag.maybeMerge=[r,r+1]:this._controlPointDrag.maybeMerge=void 0}else 1===i?a.movePreviousControlPoint(s):2===i&&a.moveNextControlPoint(s)}}},{key:"onDragEnd",value:function Path_onDragEnd_(e){var t=this.vertices,n=this._controlPointDrag;if(n){var r=n.maybeMerge;if(delete this._controlPointDrag,r){var i=slicedToArray(r,2),o=i[0],a=i[1],s=t[o],l=t[a];s.controlPoints.next=l.controlPoints.next,t.splice(a,1),this.vertices=t}}}},{key:"onMouseDown",value:function Path_onMouseDown_(e){2===e.state.clickCount&&this.addVertexCloseTo(this.localize(e.position))}},{key:"menuItems",value:function Path_menuItems_(){var e=this,t=Icon.textAttribute("check-square-o"),r=Icon.textAttribute("square-o");return r[1].paddingRight="7px",t[1].paddingRight="5px",[[[].concat(toConsumableArray(this.showControlPoints?t:r),[" control points"]),function(){return e.showControlPoints=!e.showControlPoints}],[[].concat(toConsumableArray(this.isSmooth?t:r),[" smooth"]),function(){return e.isSmooth=!e.isSmooth}],{isDivider:!0}].concat(toConsumableArray(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"menuItems",this).call(this)))}}],[{key:"properties",get:function get(){return{borderColor:{isStyleProp:!0,type:"ColorGradient",foldable:["top","left","right","bottom"],set:function set(e){e||(e=lively_graphics.Color.white),(e.isColor||e.isGradient)&&(e={top:e,left:e,right:e,bottom:e}),this.setProperty("borderColor",lively_lang.obj.extract(e,["top","left","right","bottom"],function(e,t){return lively_lang.obj.isArray(t)?lively_graphics.Color.fromTuple(t):t}))}},showControlPoints:{defaultValue:!1},vertices:{defaultValue:[],after:["isSmooth","borderWidth"],before:["extent","origin"],type:"Vertices",set:function set(e){var t=this,n=this.isSmooth;this._adjustingVertices=!0,e=e.map(function(e){return e.isPathPoint?Object.assign(e,{path:t}):new PathPoint(t,Object.assign({isSmooth:n},e))}),this.setProperty("vertices",e),this._adjustingVertices=!1,this.updateBounds(e)}},startMarker:{defaultValue:null,type:"Object"},endMarker:{defaultValue:null,type:"Object"},isSmooth:{defaultValue:!1,type:"Boolean",set:function set(e){this.setProperty("isSmooth",e),this.vertices&&(this._adjustingVertices=!0,this.vertices.forEach(function(t){return t.isSmooth=e}),this._adjustingVertices=!1,this.updateBounds(this.vertices))}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:100445,end:112576})}({referencedAs:"Morph",value:Morph}),Polygon=function(e){var t=_classRecorder,n=t.hasOwnProperty("Polygon")&&"function"==typeof t.Polygon?t.Polygon:t.Polygon=function Polygon(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Polygon_initialize_(e){if(!(e.vertices&&e.vertices.length>2))throw new Error("A polygon requires 3 or more vertices!");lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e)}},{key:"isPolygon",get:function get(){return!0}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:112585,end:112839})}({referencedAs:"Path",value:Path}),LineMorph=function(e){var t=_classRecorder,n=t.hasOwnProperty("LineMorph")&&"function"==typeof t.LineMorph?t.LineMorph:t.LineMorph=function LineMorph(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"isPolygon",get:function get(){return!0}},{key:"update",value:function LineMorph_update_(){if(!this._isUpdating){this._isUpdating=!0;var e=this.line,t=this.height,n=e.toVector();this.setProperty("position",this.position.addPt(e.perpendicularLine(0,t,"cc").toVector())),this.width=n.fastR(),this.rotation=n.theta(),this.vec=n,this._isUpdating=!1}}}],[{key:"properties",get:function get(){return{borderWidth:{defaultValue:0},fill:{defaultValue:lively_graphics.Color.black},height:{defaultValue:1},line:{defaultValue:lively_graphics.Line.fromCoords(0,0,0,0),set:function set(e){this.setProperty("line",e),this.update(e)}},start:{derived:!0,after:["line"],get:function get(e){return this.line.start},set:function set(e){this.line=this.line.withStart(e)}},end:{derived:!0,after:["line"],get:function get(e){return this.line.end},set:function set(e){this.line=this.line.withEnd(e)}},position:{derived:!0,after:["line"],get:function get(e){return this.start},set:function set(e){var t=e.subPt(this.start),n=this.rotation;this.line=new lively_graphics.Line(e,this.end.addPt(t)),this.rotation=n}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:112848,end:114289})}({referencedAs:"Morph",value:Morph}),TooltipViewer=function(e){var t=_classRecorder,n=t.hasOwnProperty("TooltipViewer")&&"function"==typeof t.TooltipViewer?t.TooltipViewer:t.TooltipViewer=function TooltipViewer(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TooltipViewer_initialize_(e){this.currentMorph=e}},{key:"__dont_serialize__",get:function get(){return["currentTooltip","currentMorph"]}},{key:"notPartOfCurrentTooltip",value:function TooltipViewer_notPartOfCurrentTooltip_(e){return!e.ownerChain().includes(this.currentMorph)}},{key:"invalidatesCurrentTooltip",value:function TooltipViewer_invalidatesCurrentTooltip_(e){return e.tooltip||this.notPartOfCurrentTooltip(e)}},{key:"mouseMove",value:function TooltipViewer_mouseMove_(e){var t=e.targetMorph,n=e.hand;this.currentMorph!==t&&this.invalidatesCurrentTooltip(t)&&(this.hoverOutOfMorph(this.currentMorph),this.hoverIntoMorph(t,n),this.currentMorph=t)}},{key:"mouseDown",value:function TooltipViewer_mouseDown_(e){e.targetMorph;this.currentTooltip&&this.currentTooltip.remove(),this.currentTooltip=null}},{key:"hoverIntoMorph",value:function TooltipViewer_hoverIntoMorph_(e,t){this.clearScheduledTooltip(),this.currentTooltip?this.showTooltipFor(e,t):this.scheduleTooltipFor(e,t)}},{key:"hoverOutOfMorph",value:function TooltipViewer_hoverOutOfMorph_(e){var t=this;this.currentTooltip;this.currentTooltip&&this.currentTooltip.softRemove(function(e){return t.currentTooltip==e&&(t.currentTooltip=null)})}},{key:"scheduleTooltipFor",value:function TooltipViewer_scheduleTooltipFor_(e,t){var n=this;this.timer=setTimeout(function(){return n.showTooltipFor(e,t)},1e3*config$1.showTooltipsAfter)}},{key:"clearScheduledTooltip",value:function TooltipViewer_clearScheduledTooltip_(){clearTimeout(this.timer)}},{key:"showTooltipFor",value:function TooltipViewer_showTooltipFor_(e,t){if(e.tooltip&&e.world()){this.currentTooltip&&this.currentTooltip.remove();var n=t?t.position.addXY(10,7):e.globalBounds().bottomRight();this.currentTooltip=new Tooltip({position:n,description:e.tooltip}),e.world().addMorph(this.currentTooltip)}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:130,end:1916})}(void 0),Tooltip=function(e){var t=_classRecorder,n=t.hasOwnProperty("Tooltip")&&"function"==typeof t.Tooltip?t.Tooltip:t.Tooltip=function Tooltip(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"softRemove",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){return regeneratorRuntime.wrap(function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.animate({opacity:0});case 2:e&&e(this),this.remove();case 4:case"end":return t.stop()}},_callee,this)}));return function Tooltip_softRemove_(t){return e.apply(this,arguments)}}()}],[{key:"styleSheet",get:function get(){return new StyleSheet({".Tooltip":{draggable:!1,fill:lively_graphics.Color.black.withA(.5),borderRadius:4,fontColor:lively_graphics.Color.white,layout:new HorizontalLayout({spacing:5})},".Tooltip .Label":{fontColor:lively_graphics.Color.white}})}},{key:"properties",get:function get(){return{description:{after:["submorphs"],derived:!0,get:function get(){return slicedToArray(this.submorphs,1)[0].value},set:function set(e){var t=slicedToArray(this.submorphs,1)[0];t.fixedWidth=e.length>40,t.value=e}},submorphs:{initialize:function initialize(){this.submorphs=[new Label({width:200})]}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1925,end:3016})}({referencedAs:"Morph",value:Morph}),uploadFile=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t,n){var r;return regeneratorRuntime.wrap(function _callee$(n){for(;;)switch(n.prev=n.next){case 0:if(!t.startsWith("image/")){n.next=5;break}return n.next=3,fileReadAsDataURL(e);case 3:return r=n.sent,n.abrupt("return",new lively_morphic.Image({imageUrl:r,autoResize:!0,name:e.name}));case 5:return n.abrupt("return",null);case 6:case"end":return n.stop()}},_callee,this)}));return function uploadFile(t,n,r){return e.apply(this,arguments)}}();function fileReadAsDataURL(e){return new Promise(function(t,n){var r=new FileReader;r.onload=function(e){return t(e.target.result)},r.readAsDataURL(e)})}var _this=void 0,commands=[{name:"undo",exec:function exec(e){return(!e.focusedMorph||e.focusedMorph===e||!e.focusedMorph.undoManager)&&(e.env.undoManager.undo(),!0)}},{name:"redo",exec:function exec(e){return(!e.focusedMorph||e.focusedMorph===e||!e.focusedMorph.undoManager)&&(e.env.undoManager.redo(),!0)}},{name:"run command",handlesCount:!0,exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t,n){var r,i,o,a,s,l;return regeneratorRuntime.wrap(function _callee$(c){for(;;)switch(c.prev=c.next){case 0:return r=e.focusedMorph||e,i=KeyHandler.generateCommandToKeybindingMap(r,!0).map(function(e){var t=e.prettyKeys,n=e.target,r=e.command.name;return{isListItem:!0,value:e,label:[""+n.constructor.name,{fontSize:"80%",textStyleClasses:["v-center-text"],paddingRight:"10px"},""+r,null],annotation:[t?t.join(", "):"",{fontSize:"80%",textStyleClasses:["truncated-text"],maxWidth:140}]}}),c.next=3,e.filterableListPrompt("Run command",i,{historyId:"lively.morphic-run command",extent:lively_graphics.pt(700,900),prompt:e._cachedRunCommandPrompt});case 3:return o=c.sent,a=o.prompt,s=slicedToArray(o.selected,1),l=s[0],e._cachedRunCommandPrompt=a,c.abrupt("return",!l||l.target.execCommand(l.command,t,n));case 9:case"end":return c.stop()}},_callee,_this)}));return function exec(t,n,r){return e.apply(this,arguments)}}()},{name:"show command history",exec:function exec(e,t){var n=e.commandHandler,r=lively_lang.arr.sortBy(n.history,function(e){return-e.time}).map(function(e){return{isListItem:!0,string:n.printCommand(e),value:e}});return $world.editListPrompt("select commands",r,{multiSelect:!0}),!0}},{name:"show halo for focused morph",exec:function exec(e){var t=e.focusedMorph;return e.showHaloFor(t.getWindow()||t,e.firstHand.pointerId),!0}},{name:"copy morph",exec:function exec(e){var t=e.focusedMorph;if(!t||t===e)return $world.setStatusMessage("no morph selected"),!0;var n=t.getWindow()||t,r=n.copy();return r.openInWorld(n.globalPosition.addXY(10,10)),r.isWindow&&r.activate(),r}},{name:"select morph",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var t,n,r,i,o,a,s,l,c,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{root:e,justReturn:!1,filterFn:null,prependItems:[],prompt:null};return regeneratorRuntime.wrap(function _callee2$(h){for(;;)switch(h.prev=h.next){case 0:return t=u.filterFn||function(){return!0},n=0,h.next=4,System.import("lively.classes/object-classes.js");case 4:return r=h.sent,i=r.default,o=lively_lang.arr.compact(lively_lang.tree.map(u.root||e,function(e,r){if(!t(e))return null;var o=!!i.lookupPackageForObject(e);return{isListItem:!0,label:[""+String(++n)+"".repeat(r),{fontSize:"80%",textStyleClasses:["v-center-text"],paddingRight:"10px"},""+e,{fontWeight:o?"bolder":"normal",fontStyle:o?"normal":"italic",fontFamily:"Inconsolata",fontSize:16},o?" [Object Class]":"",{opacity:.5}],value:e}},function(e){return t(e)?e.submorphs:[]})),a=["show halo","open object editor","open object inspector"],h.next=10,e.filterableListPrompt(u.prompt||"Choose morph",(u.prependItems||[]).concat(o),{historyId:"lively.morphic-select morph",onSelection:function onSelection(e){_this.lastSelectionHalo&&_this.lastSelectionHalo.remove(),e&&e.show&&(_this.lastSelectionHalo=e.show())},selectedAction:"show halo",actions:a});case 10:if(s=h.sent,l=s.selected,c=s.action,!u.justReturn){h.next=15;break}return h.abrupt("return",l);case 15:return l.forEach(function(t){c===a[0]?e.showHaloFor(t):c===a[1]?e.execCommand("open object editor",{target:t}):c===a[2]&&e.execCommand("open object inspector",{target:t})}),h.abrupt("return",l);case 17:case"end":return h.stop()}},_callee2,_this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"escape",exec:function exec(e,t,n,r){var i=e.env.eventDispatcher.eventState;i.menu&&i.menu.remove();var o=e.halos();o.forEach(function(e){return e.remove()}),e.hands.forEach(function(e){return e.cancelGrab(!0,r)});var a=lively_lang.arr.last(o)&&lively_lang.arr.last(o).target||e.focusedMorph||e;return a.focus(),a.isText&&a.selection.disableMultiSelect&&a.selection.disableMultiSelect(),!1}},{name:"move or resize halo target",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{direction:"left",offset:1,what:"move"},n=e.halos()[0];if(!n||n.changingName)return!1;var r=t.direction,i=t.offset,o=t.what,a=n.target;switch(i=i||1,r){case"left":a["move"===o?"left":"width"]-=i;break;case"right":a["move"===o?"left":"width"]+=i;break;case"up":a["move"===o?"top":"height"]-=i;break;case"down":a["move"===o?"top":"height"]+=i}return n.alignWithTarget(),!0}},{name:"resize to fit window",exec:function exec(e){return delete e._cachedWindowBounds,e.extent=lively.FreezerRuntime?e.windowBounds().extent():e.windowBounds().union(e.submorphBounds()).extent(),!0}},{name:"resize manually",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var t,n,r,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:if(t=void 0,n=void 0,r=e.windowBounds(),i=e.bounds(),a.t0=Number,a.t1=o.width,a.t1){a.next=7;break}return a.next=6,e.prompt("Enter world width",{input:Math.max(i.width,r.width)});case 6:a.t1=a.sent;case 7:if(a.t2=a.t1,"number"!=typeof(t=(0,a.t0)(a.t2))){a.next=18;break}if(a.t3=Number,a.t4=o.height,a.t4){a.next=16;break}return a.next=15,e.prompt("Enter world height",{input:Math.max(i.height,r.height)});case 15:a.t4=a.sent;case 16:a.t5=a.t4,n=(0,a.t3)(a.t5);case 18:return"number"!=typeof t||isNaN(t)||"number"!=typeof n||isNaN(n)||(e.extent=lively_graphics.pt(t,n)),a.abrupt("return",!0);case 20:case"end":return a.stop()}},_callee3,_this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"resize windows to fit visible world bounds",exec:function exec(e){var t=e.getWindows().filter(function(e){return!e.minimized});if(!t.length)return!0;var n=e.visibleBounds(),r=t.reduce(function(e,t){return t.bounds().union(e)},new lively_graphics.Rectangle(0,0,0,0)),i=n.width/r.width,o=n.height/r.height;return t.forEach(function(e){var t=e.bounds(),n=t.x,r=t.y,a=t.width,s=t.height;e.setBounds(new lively_graphics.Rectangle(n*i,r*o,a*i,s*o))}),!0}},{name:"window switcher",exec:(_ref7=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var t,n,r,i,o;return regeneratorRuntime.wrap(function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:if(!(t=e.activePrompt())||"lively.morphic-window switcher"!==t.historyId){a.next=4;break}return t.focus(),a.abrupt("return",t.get("list").execCommand("select down"));case 4:return n=e.submorphs.filter(function(e){return e.isWindow}).reverse().map(function(e){return{isListItem:!0,string:e.title||String(e),value:e}}),a.next=7,e.filterableListPrompt("Choose window",n,{preselect:1,historyId:"lively.morphic-window switcher",onSelection:function onSelection(e){return e&&e.show()},width:1*e.visibleBounds().extent().x/3,itemPadding:lively_graphics.Rectangle.inset(4)});case 7:return r=a.sent,i=slicedToArray(r.selected,1),(o=i[0])&&o.activate(),a.abrupt("return",!0);case 12:case"end":return a.stop()}},_callee4,_this)})),function exec(e){return _ref7.apply(this,arguments)})},{name:"close active window or morph",exec:function exec(e){var t=e.focusedMorph;if(!t)return!0;var n=t.getWindow();(e.undoStart("window close"),n)?n.close():(lively_lang.arr.last(lively_lang.arr.without(t.ownerChain(),e)).remove(),(n=e.activeWindow())&&n.activate());return e.undoStop("window close"),!0}},{name:"toggle minimize active window",exec:function exec(e){var t=e.activeWindow();return t&&t.toggleMinimize(),!0}},{name:"open status message of focused morph",exec:function exec(e){var t=e.focusedMorph,n=t?e.visibleStatusMessagesFor(t):[],r=slicedToArray(n,1)[0];return r&&(r.expand(),r.focus()),r||!0}},{name:"resize active window",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee6(e){var t,n,r,i,o,a,s,l,c,u,h=(t=asyncToGenerator(regeneratorRuntime.mark(function _callee5(){var t,n,r;return regeneratorRuntime.wrap(function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,e.filterableListPrompt("How to resize the window?",["full","fullscreen","center","right","left","bottom","top","shrinkWidth","growWidth","shrinkHeight","growHeight","col1","col2","col3","col4","col5","reset"]);case 2:return t=i.sent,n=slicedToArray(t.selected,1),r=n[0],i.abrupt("return",r);case 6:case"end":return i.stop()}},_callee5,this)})),function askForHow(){return t.apply(this,arguments)}),d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{how:null,window:null};return regeneratorRuntime.wrap(function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:if(u=function resizeBounds(e,t){switch(e){case"full":case"fullscreen":return o;case"col1":case"left":return c.withTopLeft(o.topLeft());case"col2":return c.withTopLeft(o.topCenter().scaleByPt(lively_graphics.pt(.333,1))).withWidth(l);case"col3":case"center":return c.withCenter(o.center());case"col4":return c.translatedBy(o.topCenter().withY(0));case"col5":case"right":return c.translatedBy(lively_graphics.pt(o.width-l,0));case"top":return o.divide([lively_graphics.rect(0,0,1,.5)])[0];case"bottom":return o.divide([lively_graphics.rect(0,.5,1,.5)])[0];case"halftop":return t.withY(o.top()).withHeight(t.height/2);case"halfbottom":return t.withHeight(o.height/2).withY(o.top()+o.height/2);case"reset":return i.normalBounds||lively_graphics.pt(500,400).extentAsRectangle().withCenter(t.center());case"quadrant1":return resizeBounds("halftop",resizeBounds("col1",t));case"quadrant2":return resizeBounds("halftop",resizeBounds("col2",t));case"quadrant3":return resizeBounds("halftop",resizeBounds("col3",t));case"quadrant4":return resizeBounds("halftop",resizeBounds("col4",t));case"quadrant5":return resizeBounds("halftop",resizeBounds("col5",t));case"quadrant6":return resizeBounds("halfbottom",resizeBounds("col1",t));case"quadrant7":return resizeBounds("halfbottom",resizeBounds("col2",t));case"quadrant8":return resizeBounds("halfbottom",resizeBounds("col3",t));case"quadrant9":return resizeBounds("halfbottom",resizeBounds("col4",t));case"quadrant0":return resizeBounds("halfbottom",resizeBounds("col5",t));default:return t}},n=d.window,r=d.how,i=n||e.activeWindow()){t.next=4;break}return t.abrupt("return");case 4:if(o=e.visibleBounds().insetBy(20),a=i.bounds(),i._normalBounds||(i._normalBounds=a),s=700,l=Math.min(s,Math.max(1e3,o.width/3)),c=o.withWidth(l),r){t.next=11;break}return t.next=10,h();case 10:r=t.sent;case 11:if(r){t.next=13;break}return t.abrupt("return");case 13:return"reset"===r&&delete i.normalBounds,i.setBounds(u(r,r.startsWith("half")?a:o)),t.abrupt("return",!0);case 16:case"end":return t.stop()}},_callee6,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"[recovery] show last object editor saves",exec:function exec(e,t){return e.execCommand("[recovery] show last doits",Object.assign({},t,{title:"logged ObjectEditor save",logAccessFn:function logAccessFn(){return JSON.parse(localStorage["oe helper"]).saves}}))}},{name:"[recovery] show last doits",description:"browse a list of your last doits",exec:(_ref14=asyncToGenerator(regeneratorRuntime.mark(function _callee7(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee7$(v){for(;;)switch(v.prev=v.next){case 0:(t=m.logAccessFn)||(t=function logAccessFn(){return JSON.parse(localStorage["lively.next-js-ide-doitlog"])}),n=void 0;try{n=t()}catch(e){}if(n){v.next=7;break}return v.abrupt("return",e.inform("no log yet"));case 7:return r=lively_lang.arr.sortBy(n.map(function(e,t){var n="string"==typeof e?e:e.source,r="string"==typeof e?t:e.time||t;return{time:r,source:n,printedTime:lively_lang.date.format(new Date(r),"yy-mm-dd HH:MM")}}),function(e){return-e.time}),i=r.map(function(e,t){return{isListItem:!0,string:"["+e.printedTime+"] "+e.source.slice(0,100).replace(/\n/g,"").trim(),value:e}}),v.next=11,e.filterableListPrompt("select doit code",i,{multiSelect:!0});case 11:if(o=v.sent,!(a=o.selected).length){v.next=35;break}for(s=[],l=!0,c=!1,u=void 0,v.prev=18,h=a[Symbol.iterator]();!(l=(d=h.next()).done);l=!0)p=d.value,f=p.source,g=p.printedTime,s.push("// "+g+"\n"+f);v.next=26;break;case 22:v.prev=22,v.t0=v.catch(18),c=!0,u=v.t0;case 26:v.prev=26,v.prev=27,!l&&h.return&&h.return();case 29:if(v.prev=29,!c){v.next=32;break}throw u;case 32:return v.finish(29);case 33:return v.finish(26);case 34:return v.abrupt("return",e.execCommand("open workspace",Object.assign({title:"logged doits",mode:"js"},m,{content:s.join("\n\n")})));case 35:return v.abrupt("return",!0);case 36:case"end":return v.stop()}},_callee7,_this,[[18,22,26,34],[27,,29,33]])})),function exec(e){return _ref14.apply(this,arguments)})},{name:"open workspace",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e){var t,n,r,i,o,a,s,l,c,u,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},d=(arguments[2],arguments[3]);return regeneratorRuntime.wrap(function _callee8$(p){for(;;)switch(p.prev=p.next){case 0:if(!(t=d&&e.relayCommandExecutionToFocusedMorph(d))){p.next=3;break}return p.abrupt("return",t);case 3:if(n=h.language||h.mode||"javascript",r={javascript:"lively.ide/js/workspace.js",shell:"lively.ide/shell/workspace.js",html:"lively.ide/html/workspace.js",py:"lively.ide/py/workspace.js",md:"lively.ide/md/workspace.js",sql:"lively.ide/sql/workspace.js",text:null},i=Object.keys(config$1.ide.modes.aliases).reduce(function(e,t){return Object.assign(e,defineProperty({},config$1.ide.modes.aliases[t],t))},{}),!h.askForMode){p.next=13;break}return o=Object.keys(r).concat("javascript console"),p.next=8,e.filterableListPrompt("Open workspace for...",o);case 8:if(a=p.sent,s=slicedToArray(a.selected,1),n=s[0]){p.next=13;break}return p.abrupt("return",!0);case 13:if("javascript console"!==n){p.next=15;break}return p.abrupt("return",e.execCommand("open console",h));case 15:if(h=Object.assign({content:""},h,{mode:n,language:n}),l=r[h.language]||r[i[h.language]],"text"!==n&&l){p.next=19;break}return p.abrupt("return",e.execCommand("open text window",Object.assign({},config$1.codeEditor.modes.text,{},h)));case 19:return p.next=21,System.import(l);case 21:return c=p.sent,u=c.default,p.abrupt("return",new u({title:h.title||h.language+" workspace",center:e.center,content:h.content,target:h.target,systemInterface:h.systemInterface||h.backend}).activate());case 24:case"end":return p.stop()}},_callee8,_this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"open console",exec:(_ref19=asyncToGenerator(regeneratorRuntime.mark(function _callee9(e){var t;arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function _callee9$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,loadObjectFromPartsbinFolder("Console");case 2:return t=e.sent,e.abrupt("return",t.openInWorldNearHand());case 4:case"end":return e.stop()}},_callee9,_this)})),function exec(e){return _ref19.apply(this,arguments)})},{name:"open shell workspace",exec:function exec(e,t){return e.execCommand("open workspace",Object.assign({},t,{language:"shell"}))}},{name:"open shell terminal",exec:(_ref20=asyncToGenerator(regeneratorRuntime.mark(function _callee10(e,t){var n,r;return regeneratorRuntime.wrap(function _callee10$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/shell/terminal.js");case 2:return n=e.sent,r=n.default,e.abrupt("return",r.open(t).openInWorldNearHand());case 5:case"end":return e.stop()}},_callee10,_this)})),function exec(e,t){return _ref20.apply(this,arguments)})},{name:"open text window",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.title,r=t.extent,i=t.content,o=t.mode,a=t.name,s=t.rangesAndStyles;n=n||"text window",i=i||"",r=r||lively_graphics.pt(500,400),a=a||"text workspace";var l="string"==typeof i?[i,null]:i,c=new Text(Object.assign({padding:lively_graphics.Rectangle.inset(3)},lively_lang.obj.dissoc(t,["title","content"]),{textAndAttributes:l,clipMode:"auto",name:a,extent:r}));return s&&c.setTextAttributesWithSortedRanges(s),o&&c.changeEditorMode(o),e.openInWindow(c,{title:n}).activate()}},{name:"merge and open in window",exec:(_ref22=asyncToGenerator(regeneratorRuntime.mark(function _callee11(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{a:"",b:"",format:null,extent:lively_graphics.pt(500,600)};return regeneratorRuntime.wrap(function _callee11$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,loadObjectFromPartsbinFolder("text merger");case 2:return t=e.sent,e.abrupt("return",t.targetMorph.open(n.a,n.b,n));case 4:case"end":return e.stop()}},_callee11,_this)})),function exec(e){return _ref22.apply(this,arguments)})},{name:"diff and open in window",exec:(_ref23=asyncToGenerator(regeneratorRuntime.mark(function _callee13(e){var t,n,r,i,o,a,s,l,c,u=(t=asyncToGenerator(regeneratorRuntime.mark(function _callee12(t,n,r){var i,a,c,u,h,d,p,f,g,m,v,y;return regeneratorRuntime.wrap(function _callee12$(_){for(;;)switch(_.prev=_.next){case 0:if(i=r.format,a=null,"patch"!==i){_.next=12;break}return u=r.headerA,h=r.headerB,d=r.filenameA,p=r.filenameB,f=r.context,c=[s.createTwoFilesPatch(d||"a",p||"b",t,n,u,h,"number"==typeof f?{context:f}:void 0),{}],_.next=7,System.import("lively.ide/diff/editor-plugin.js");case 7:g=_.sent,m=g.default,a=new m,_.next=14;break;case 12:l=s[i](t,n,r),c=lively_lang.arr.flatmap(l,function(e){e.count;var t=e.value,n=e.added;return[t,e.removed?{fontWeight:"normal",textDecoration:"line-through",fontColor:lively_graphics.Color.red}:n?{fontWeight:"bold",textDecoration:"",fontColor:lively_graphics.Color.green}:{fontWeight:"normal",textDecoration:"",fontColor:lively_graphics.Color.darkGray}]});case 14:return v=e.execCommand("open text window",r),y=v.targetMorph,v.extent=o||lively_graphics.pt(300,200).maxPt(y.textBounds().extent()),y.textAndAttributes=c,a&&y.addPlugin(a),_.abrupt("return",y);case 19:case"end":return _.stop()}},_callee12,this)})),function diffInWindow(e,n,r){return t.apply(this,arguments)}),h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{a:"",b:"",format:null,extent:lively_graphics.pt(500,600)};return regeneratorRuntime.wrap(function _callee13$(e){for(;;)switch(e.prev=e.next){case 0:return c=function findFormat(e,t){if((lively_lang.obj.isPrimitive(e)||e instanceof RegExp||lively_lang.obj.isPrimitive(t)||t instanceof RegExp)&&(e=String(e),t=String(t)),"string"!=typeof e||"string"!=typeof t)try{return JSON.stringify(e),JSON.stringify(t),{format:"diffJson",a:e,b:t}}catch(n){e=String(e),t=String(t)}return{format:"diffLines",a:e,b:t}},n=h.a,r=h.b,i=h.format,o=h.extent,i?(n=String(n),r=String(r)):(a=c(n,r),n=a.a,r=a.b,i=a.format),e.next=5,System.import("jsdiff",System.decanonicalize("lively.morphic"));case 5:return s=e.sent,e.next=8,u(n,r,Object.assign({fontFamily:"monospace"},h,{format:i}));case 8:return l=e.sent,e.abrupt("return",l);case 10:case"end":return e.stop()}},_callee13,_this)})),function exec(e){return _ref23.apply(this,arguments)})},{name:"merge workspaces",exec:function exec(e,t){return e.execCommand("diff workspace",Object.assign({},t,{merge:!0}))}},{name:"diff workspaces",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee16(e){var t,n,r,i,o,a,s,l=(t=asyncToGenerator(regeneratorRuntime.mark(function _callee14(e,t){var n;return regeneratorRuntime.wrap(function _callee14$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,loadObjectFromPartsbinFolder("text merger");case 2:return n=r.sent,r.abrupt("return",n.targetMorph.open(e.textString,t.textString));case 4:case"end":return r.stop()}},_callee14,this)})),function doMerge(e,n){return t.apply(this,arguments)}),c=(n=asyncToGenerator(regeneratorRuntime.mark(function _callee15(t,n){var r,i,o,a;return regeneratorRuntime.wrap(function _callee15$(n){for(;;)switch(n.prev=n.next){case 0:return r=t.map(function(e){return{isListItem:!0,value:e,string:e.name||String(e)}}),n.next=3,e.filterableListPrompt("choose text: ",r,{onSelection:function onSelection(e){return e&&e.show()}});case 3:return i=n.sent,o=slicedToArray(i.selected,1),a=o[0],n.abrupt("return",a);case 7:case"end":return n.stop()}},_callee15,this)})),function selectMorph(e,t){return n.apply(this,arguments)}),u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee16$(t){for(;;)switch(t.prev=t.next){case 0:if(s=function doDiff(t,n){var r=t.pluginFind(function(e){return e.evalEnvironment}),i=r&&r.evalEnvironment.targetModule||"no file",o=n.pluginFind(function(e){return e.evalEnvironment}),a=o&&o.evalEnvironment.targetModule||"no file";return e.execCommand("diff and open in window",{a:t.textString,b:n.textString,filenameA:i,filenameB:a})},r=u.editor1,i=u.editor2,o=u.merge,r&&i||(a=e.withAllSubmorphsSelect(function(e){return e.isText&&!e.isInputLine&&!e.isUsedAsEpiMorph()}).reverse()),r){t.next=7;break}return t.next=6,c(a);case 6:r=t.sent;case 7:if(r){t.next=9;break}return t.abrupt("return",e.setStatusMessage("Canceled"));case 9:if(i){t.next=13;break}return t.next=12,c(lively_lang.arr.without(a,r));case 12:i=t.sent;case 13:if(i){t.next=15;break}return t.abrupt("return",e.setStatusMessage("Canceled"));case 15:return t.abrupt("return",o?l(r,i):s(r,i));case 16:case"end":return t.stop()}},_callee16,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"search workspaces",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee17(){var e,t,n,r,i,o,a,s;return regeneratorRuntime.wrap(function _callee17$(l){for(;;)switch(l.prev=l.next){case 0:return s=function findWindowOrMorphWithStrings(e){return $world.withAllSubmorphsDo(function(t){if(t.isWindow&&t.minimized&&t.targetMorph&&t.targetMorph.isText&&(t=t.targetMorph),!t.textString)return null;if(!t.isText)return null;if(t.isUsedAsEpiMorph())return null;var n=t.textString.toLowerCase();return e.every(function(e){return n.includes(e)})?t:null}).filter(Boolean)},a=function morphsToCandidates(e,t){return e.map(function(e){var n=e.world()?e.getWindow():$world.withAllSubmorphsDetect(function(e){return e.isWindow&&e.targetMorph===morph}),r=0,i=lively.lang.string.lines(e.textString).find(function(e,n){return e=e.toLowerCase(),r=n,t.every(function(t){return e.includes(t)})}),o=n?n.title:e.toString();return i?{isListItem:!0,string:o+" | "+i,value:{window:n,morph:e,row:r}}:null}).filter(Boolean)},l.next=4,$world.filterableListPrompt("search workspaces",[],{historyId:"lively.morphic-ide-search-workspaces-hist",customize:function customize(e){e.getSubmorphNamed("list").updateFilter=function(){var e=this.parseInput();if(!(e.input.length<3)){var t=s(e.lowercasedTokens);this.listMorph.items=a(t,e.lowercasedTokens)}}}});case 4:if(e=l.sent,t=slicedToArray(e.selected,1),!(n=t[0])){l.next=13;break}return r=n.morph,i=n.window,o=n.row,i&&(i.minimized&&i.toggleMinimize(),i.activate()),(i||r).show(),this.cursorPosition={row:o,column:0},l.abrupt("return",r);case 13:return l.abrupt("return",null);case 14:case"end":return l.stop()}},_callee17,this)}));return function exec(){return e.apply(this,arguments)}}()},{name:"open PartsBin",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee18(e){var t,n,r;return regeneratorRuntime.wrap(function _callee18$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.morphic/partsbin.js");case 2:return t=e.sent,n=t.loadPart,e.next=6,n("PartsBin");case 6:return(r=e.sent).openInWorldNearHand(),r.targetMorph.selectedCategory="*basics*",r.focus(),e.abrupt("return",r);case 11:case"end":return e.stop()}},_callee18,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"load object from PartsBin",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee19(e){var t,n,r,i,o,a,s,l,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee19$(e){for(;;)switch(e.prev=e.next){case 0:if(t=void 0,n=c.name,r=c.open,i=void 0===r||r,!n){e.next=11;break}return e.next=4,System.import("lively.morphic/partsbin.js");case 4:return o=e.sent,a=o.loadObjectFromPartsbinFolder,e.next=8,a(n);case 8:t=e.sent,e.next=18;break;case 11:return e.next=13,System.import("lively.morphic/partsbin.js");case 13:return s=e.sent,l=s.interactivelyLoadObjectFromPartsBinFolder,e.next=17,l();case 17:t=e.sent;case 18:return t&&i&&t.openInWorldNearHand(),e.abrupt("return",t);case 20:case"end":return e.stop()}},_callee19,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"open object drawer",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee20(e){var t,n;return regeneratorRuntime.wrap(function _callee20$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.components/object-drawer.js");case 2:return t=e.sent,n=t.default,e.abrupt("return",(new n).openInWorldNearHand());case 5:case"end":return e.stop()}},_callee20,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"open object editor",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee21(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{target:null,selectedClass:null,selectedMethod:null,evalEnvironment:null};return regeneratorRuntime.wrap(function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:if(r.target){i.next=3;break}return e.setStatusMessage("No target for ObjectEditor"),i.abrupt("return",null);case 3:return i.next=5,System.import("lively.ide/js/objecteditor/index.js");case 5:return t=i.sent,n=t.ObjectEditor,i.next=9,n.open(r);case 9:return i.abrupt("return",i.sent);case 10:case"end":return i.stop()}},_callee21,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"open object inspector",exec:(_ref42=asyncToGenerator(regeneratorRuntime.mark(function _callee22(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{target:null};return regeneratorRuntime.wrap(function _callee22$(n){for(;;)switch(n.prev=n.next){case 0:if(t.target){n.next=3;break}return e.setStatusMessage("no target for Inspector"),n.abrupt("return",null);case 3:return n.abrupt("return",exports.inspect(t.target));case 4:case"end":return n.stop()}},_callee22,_this)})),function exec(e){return _ref42.apply(this,arguments)})},{name:"inspect server",exec:(_ref43=asyncToGenerator(regeneratorRuntime.mark(function _callee23(e){var t,n,r,i,o,a;return regeneratorRuntime.wrap(function _callee23$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/js/inspector.js");case 2:return t=e.sent,n=t.default,e.next=6,System.import("lively-system-interface");case 6:return r=e.sent,i=r.serverInterfaceFor,o=i(System.baseURL+"eval"),a={format:"esm",context:"global",targetModule:"lively://world_do_it_"+Date.now(),sourceURL:"inspect-server_"+Date.now(),systemInterface:o},e.next=12,o.runEval('\n           import LivelyServer from "lively.server/server.js";\n           const server = LivelyServer.servers.values().next();\n        ',a);case 12:n.openInWindow({remoteTarget:{code:"server",evalEnvironment:a}});case 13:case"end":return e.stop()}},_callee23,_this)})),function exec(e){return _ref43.apply(this,arguments)})},{name:"open scene graph inspector",exec:(_ref46=asyncToGenerator(regeneratorRuntime.mark(function _callee24(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{target:null};return regeneratorRuntime.wrap(function _callee24$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,loadObjectFromPartsbinFolder("scene graph inspector");case 2:return(t=r.sent).targetMorph=n.target||e,r.abrupt("return",t.openInWindow({title:"morph graph"}));case 5:case"end":return r.stop()}},_callee24,_this)})),function exec(e){return _ref46.apply(this,arguments)})},{name:"open browser",progressIndicator:"opening browser...",exec:(_ref47=asyncToGenerator(regeneratorRuntime.mark(function _callee25(e){var t,n,r,i,o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{packageName:"lively.morphic",moduleName:"morph.js"},s=(arguments[2],arguments[3]);return regeneratorRuntime.wrap(function _callee25$(l){for(;;)switch(l.prev=l.next){case 0:if(!(t=s&&e.relayCommandExecutionToFocusedMorph(s))){l.next=3;break}return l.abrupt("return",t);case 3:return l.next=5,System.import("lively.ide/js/browser/index.js");case 5:return n=l.sent,r=n.default,i=lively_lang.obj.select(a,["packageName","moduleName","textPosition","codeEntity","systemInterface"]),l.next=10,r.browse(i,{extent:lively_graphics.pt(700,600)});case 10:return(o=l.sent).getWindow().activate(),l.abrupt("return",o);case 13:case"end":return l.stop()}},_callee25,_this)})),function exec(e){return _ref47.apply(this,arguments)})},{name:"choose and browse package resources",progressIndicator:"browsing resources...",exec:(_ref49=asyncToGenerator(regeneratorRuntime.mark(function _callee26(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{browser:null,systemInterface:null},k=(arguments[2],arguments[3]);return regeneratorRuntime.wrap(function _callee26$(S){for(;;)switch(S.prev=S.next){case 0:if(!(t=k&&e.relayCommandExecutionToFocusedMorph(k))){S.next=3;break}return S.abrupt("return",t);case 3:return n=(n=w.browser||e.focusedMorph&&e.focusedMorph.ownerChain().find(function(e){return e.isBrowser}))&&n.isBrowser?n.getWindow():null,S.next=7,System.import("lively-system-interface");case 7:return r=S.sent,i=r.localInterface,o=w&&w.systemInterface?w.systemInterface:n?n.systemInterface:i,S.next=12,o.getPackages({excluded:config$1.ide.js.ignoredPackages});case 12:a=S.sent,s=[],l=!0,c=!1,u=void 0,S.prev=17,h=regeneratorRuntime.mark(function _loop(){var e,t;return regeneratorRuntime.wrap(function _loop$(n){for(;;)switch(n.prev=n.next){case 0:return e=p.value,(t=(lively_lang.Path("lively.ide.exclude").get(e)||[]).map(function(e){return e.includes("*")?new RegExp(e.replace(/\*/g,".*")):e})).push(".git","node_modules",".module_cache"),n.t0=s.push,n.t1=s,n.t2=babelHelpers$1,n.next=8,o.resourcesOfPackage(e,t);case 8:n.t3=function(e){var n=e.url;return!n.endsWith("/")&&!t.some(function(e){return e instanceof RegExp?e.test(n):n.includes(e)})},n.t4=function(e,t){return e.isLoaded&&!t.isLoaded?-1:!e.isLoaded&&t.isLoaded?1:e.nameInPackage.toLowerCase()<t.nameInPackage.toLowerCase()?-1:e.nameInPackage.toLowerCase()==t.nameInPackage.toLowerCase()?0:1},n.t5=function(t){return{isListItem:!0,string:"["+e.name+"] "+t.nameInPackage+(t.isLoaded?"":" [not loaded]"),value:t}},n.t6=n.sent.filter(n.t3).sort(n.t4).map(n.t5),n.t7=n.t2.toConsumableArray.call(n.t2,n.t6),n.t0.apply.call(n.t0,n.t1,n.t7);case 14:case"end":return n.stop()}},_loop,_this)}),d=a[Symbol.iterator]();case 20:if(l=(p=d.next()).done){S.next=25;break}return S.delegateYield(h(),"t0",22);case 22:l=!0,S.next=20;break;case 25:S.next=31;break;case 27:S.prev=27,S.t1=S.catch(17),c=!0,u=S.t1;case 31:S.prev=31,S.prev=32,!l&&d.return&&d.return();case 34:if(S.prev=34,!c){S.next=37;break}throw u;case 37:return S.finish(34);case 38:return S.finish(31);case 39:return S.next=41,e.filterableListPrompt("Choose module to open",s,{historyId:"lively.morphic-choose and browse package resources",requester:n,width:700,multiSelect:!0,fuzzy:"value.shortName"});case 41:return f=S.sent,g=f.selected,m=lively_lang.arr.partition(g,function(e){return e.url.match(/\.js(on)?/)}),v=slicedToArray(m,2),y=v[0],_=v[1],S.next=49,System.import("lively.ide/js/browser/index.js");case 49:return b=S.sent,x=b.default,S.next=53,Promise.all(y.map(function(e){var t={packageName:e.package,moduleName:e.url};return x.browse(t,n,o).then(function(e){return e.activate()})}));case 53:if(!_.length){S.next=56;break}return S.next=56,Promise.all(_.map(function(t){var n=t.url;return e.execCommand("open file",{url:n})}));case 56:return S.abrupt("return",!0);case 57:case"end":return S.stop()}},_callee26,_this,[[17,27,31,39],[32,,34,38]])})),function exec(e){return _ref49.apply(this,arguments)})},{name:"choose and browse module",progressIndicator:"browsing module...",handlesCount:!0,exec:(_ref55=asyncToGenerator(regeneratorRuntime.mark(function _callee28(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k,S,C=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{browser:void 0,systemInterface:void 0},M=arguments[2];return regeneratorRuntime.wrap(function _callee28$(T){for(;;)switch(T.prev=T.next){case 0:if(C.browser){T.next=4;break}if(t=e.focusedMorph,!((n=t&&t.getWindow())&&n.targetMorph&&n.targetMorph.isFileBrowser)){T.next=4;break}return T.abrupt("return",n.targetMorph.execCommand("find file and select",C,M));case 4:return r=C.browser||t&&t.ownerChain().find(function(e){return e.isBrowser}),T.next=7,System.import("lively.ide/js/browser/index.js");case 7:return i=T.sent,o=i.default,T.next=11,System.import("lively-system-interface");case 11:return a=T.sent,s=a.localInterface,l=C&&C.systemInterface?C.systemInterface:r?r.systemInterface:s,T.next=16,l.getPackages();case 16:c=T.sent,u=[],h=!0,d=!1,p=void 0,T.prev=21,f=c[Symbol.iterator]();case 23:if(h=(g=f.next()).done){T.next=57;break}m=g.value,v=(v=lively_lang.Path("lively.ide.exclude").get(m)||[]).map(function(e){return e.includes("*")?new RegExp(e.replace(/\*/g,".*")):e}),y=!0,_=!1,b=void 0,T.prev=30,x=function _loop2(){var e=k.value;if(v.some(function(t){return t instanceof RegExp?t.test(e.name):e.name.includes(t)}))return"continue";S=l.shortModuleName(e.name,m),u.push({isListItem:!0,string:"["+m.name+"] "+S,value:{package:m,module:e,shortName:S}})},w=m.modules[Symbol.iterator]();case 33:if(y=(k=w.next()).done){T.next=40;break}if("continue"!==x()){T.next=37;break}return T.abrupt("continue",37);case 37:y=!0,T.next=33;break;case 40:T.next=46;break;case 42:T.prev=42,T.t0=T.catch(30),_=!0,b=T.t0;case 46:T.prev=46,T.prev=47,!y&&w.return&&w.return();case 49:if(T.prev=49,!_){T.next=52;break}throw b;case 52:return T.finish(49);case 53:return T.finish(46);case 54:h=!0,T.next=23;break;case 57:T.next=63;break;case 59:T.prev=59,T.t1=T.catch(21),d=!0,p=T.t1;case 63:T.prev=63,T.prev=64,!h&&f.return&&f.return();case 66:if(T.prev=66,!d){T.next=69;break}throw p;case 69:return T.finish(66);case 70:return T.finish(63);case 71:return u=lively_lang.arr.sortBy(u,function(e){return e.string}),asyncToGenerator(regeneratorRuntime.mark(function _callee27(){var n,i,a,s,c,h,d,p;return regeneratorRuntime.wrap(function _callee27$(f){for(;;)switch(f.prev=f.next){case 0:return f.next=2,e.filterableListPrompt("Choose module to open",u,{historyId:"lively.morphic-choose and browse module",requester:r||t,width:700,multiSelect:!0,listFontColor:"white",fuzzy:"value.shortName"});case 2:n=f.sent,i=n.selected,a=0;case 5:if(!(a<i.length)){f.next=18;break}return s=i[a],c=s.package,h=s.shortName,d={packageName:c.name,moduleName:h},f.next=12,o.browse(d,0===a?r:void 0,l);case 12:(p=f.sent).moveBy(lively_graphics.pt(20*a,20*a)),p.activate();case 15:a++,f.next=5;break;case 18:case"end":return f.stop()}},_callee27,_this)}))(),T.abrupt("return",!0);case 74:case"end":return T.stop()}},_callee28,_this,[[21,59,63,71],[30,42,46,54],[47,,49,53],[64,,66,70]])})),function exec(e){return _ref55.apply(this,arguments)})},{name:"open code search",progressIndicator:"opening code search...",exec:(_ref60=asyncToGenerator(regeneratorRuntime.mark(function _callee29(e){var t,n,r,i,o,a,s,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{browser:null,systemInterface:null,input:null};return regeneratorRuntime.wrap(function _callee29$(c){for(;;)switch(c.prev=c.next){case 0:if(t=e.focusedMorph?e.focusedMorph.ownerChain():[],!(n=l.browser||t.find(function(e){return e.isBrowser}))||!n.isBrowser){c.next=6;break}if(!n.state.associatedSearchPanel){c.next=4;break}return c.abrupt("return",n.state.associatedSearchPanel.getWindow().activate());case 4:c.next=7;break;case 6:n=null;case 7:return c.next=9,System.import("lively-system-interface");case 9:return r=c.sent,i=r.localInterface,(o=l.systemInterface||n&&n.systemInterface)||(a=t.find(function(e){return e.isText&&e.editorPlugin&&e.editorPlugin.isJSEditorPlugin}),o=a?a.editorPlugin.systemInterface():i),c.next=15,loadObjectFromPartsbinFolder("code search");case 15:return s=c.sent,Object.assign(s.targetMorph,{browser:n,input:l.input,systemInterface:o}),s.activate(),n&&(n.state.associatedSearchPanel=s),c.abrupt("return",s);case 20:case"end":return c.stop()}},_callee29,_this)})),function exec(e){return _ref60.apply(this,arguments)})},{name:"open grep search",progressIndicator:"opening code search...",exec:(_ref62=asyncToGenerator(regeneratorRuntime.mark(function _callee30(e,t){var n;return regeneratorRuntime.wrap(function _callee30$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,loadObjectFromPartsbinFolder("grep search");case 2:return n=t.sent,t.abrupt("return",n.openInWorldNearHand(e).activate());case 4:case"end":return t.stop()}},_callee30,_this)})),function exec(e,t){return _ref62.apply(this,arguments)})},{name:"open test runner",progressIndicator:"opening test runner...",exec:(_ref63=asyncToGenerator(regeneratorRuntime.mark(function _callee31(e){var t,n;return regeneratorRuntime.wrap(function _callee31$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/test-runner.js");case 2:return t=e.sent,n=t.default,e.next=6,n.open();case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},_callee31,_this)})),function exec(e){return _ref63.apply(this,arguments)})},{name:"open file browser",progressIndicator:"opening file browser...",exec:(_ref65=asyncToGenerator(regeneratorRuntime.mark(function _callee32(e){var t,n,r,i,o,a,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee32$(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,System.import("lively.ide/http-file-browser.js");case 2:return t=l.sent,n=t.default,r=s.location,i=s.url,o=s.file,a=o?n.forFile(o,r):n.forLocation(i||r||document.location.origin),l.abrupt("return",e.openInWindow(a).activate());case 9:case"end":return l.stop()}},_callee32,_this)})),function exec(e){return _ref65.apply(this,arguments)})},{name:"open file",progressIndicator:"opening file...",exec:(_ref67=asyncToGenerator(regeneratorRuntime.mark(function _callee33(e){var t,n,r,i,o,a,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{url:null,lineNumber:null,reuse:!1};return regeneratorRuntime.wrap(function _callee33$(l){for(;;)switch(l.prev=l.next){case 0:if(t=s.url,n=s.lineNumber,r=s.reuse,t){l.next=5;break}return l.next=4,e.prompt("Enter file location",{historyId:"lively.morphic-text editor url",useLastInput:!0});case 4:t=l.sent;case 5:if(!r){l.next=10;break}if(e.getWindows().slice(-2)[0],!(i=lively_lang.arr.findAndGet(e.getWindows(),function(e){var n=e.targetMorph;return n&&n.isTextEditor&&n.location.split(":")[0]===t?n:null}))){l.next=10;break}return"number"==typeof n&&(i.lineNumber=n),l.abrupt("return",i.getWindow().activate());case 10:return n&&(t+=":"+n),l.next=13,System.import("lively.ide/text-editor.js");case 13:return o=l.sent,a=o.default,l.abrupt("return",t?a.openURL(t,lively_lang.obj.dissoc(s,["url"])):null);case 16:case"end":return l.stop()}},_callee33,_this)})),function exec(e){return _ref67.apply(this,arguments)})},{name:"open file for EDITOR",exec:(_ref69=asyncToGenerator(regeneratorRuntime.mark(function _callee34(e){var t,n,r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{url:null,lineNumber:null};return regeneratorRuntime.wrap(function _callee34$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("lively.ide/text-editor.js");case 2:return t=e.sent,n=t.default,r=i.url,i.lineNumber,e.next=8,n.openAsEDITOR(r,{});case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}},_callee34,_this)})),function exec(e){return _ref69.apply(this,arguments)})},{name:"open subserver controller",exec:(_ref71=asyncToGenerator(regeneratorRuntime.mark(function _callee35(e,t){var n;return regeneratorRuntime.wrap(function _callee35$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,loadPart("subserver controller");case 2:return n=e.sent,e.abrupt("return",n.openInWorld());case 4:case"end":return e.stop()}},_callee35,_this)})),function exec(e,t){return _ref71.apply(this,arguments)})},{name:"[lively.installer] publish new version of a package",exec:(_ref72=asyncToGenerator(regeneratorRuntime.mark(function _callee36(e){var t,n;return regeneratorRuntime.wrap(function _callee36$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,lively.modules.registerPackage(document.location.origin+"/lively.installer");case 2:return e.next=4,System.import("lively.installer/packages/publish-new-package-version.js");case 4:return t=e.sent,n=t.default,e.next=8,n();case 8:return e.abrupt("return",!0);case 9:case"end":return e.stop()}},_callee36,_this)})),function exec(e){return _ref72.apply(this,arguments)})},{name:"report a bug",exec:(_ref74=asyncToGenerator(regeneratorRuntime.mark(function _callee37(e){return regeneratorRuntime.wrap(function _callee37$(e){for(;;)switch(e.prev=e.next){case 0:return window.open("https://github.com/LivelyKernel/lively.morphic/issues/new","_blank"),e.abrupt("return",!0);case 2:case"end":return e.stop()}},_callee37,_this)})),function exec(e){return _ref74.apply(this,arguments)})},{name:"fix font metric",exec:(_ref75=asyncToGenerator(regeneratorRuntime.mark(function _callee38(e){return regeneratorRuntime.wrap(function _callee38$(t){for(;;)switch(t.prev=t.next){case 0:return e.env.fontMetric.reset(),e.withAllSubmorphsDo(function(e){return e.isText&&e.textLayout&&e.textLayout.reset()}),t.abrupt("return",!0);case 3:case"end":return t.stop()}},_callee38,_this)})),function exec(e){return _ref75.apply(this,arguments)})},{name:"delete change history",exec:function exec(e){var t=e.env,n=t.printStatus();return t.deleteHistory(),e.setStatusMessage(n),!0}},{name:"install global inspect and show",exec:function exec(e){return window.show=lively_halos_markers_js.show,window.inspect=exports.inspect,e.setStatusMessage("inspect() and show() are now globally available"),!0}},{name:"save world",exec:(_ref76=asyncToGenerator(regeneratorRuntime.mark(function _callee39(e,t,n,r){var i,o,a;return regeneratorRuntime.wrap(function _callee39$(n){for(;;)switch(n.prev=n.next){case 0:if(!(i=r&&e.relayCommandExecutionToFocusedMorph(r))){n.next=3;break}return n.abrupt("return",i);case 3:return t=Object.assign({confirmOverwrite:!0,showSaveDialog:!0},t),o=e.focusedMorph,n.next=7,interactivelySaveWorld(e,t);case 7:return a=n.sent,o&&o.focus(),n.abrupt("return",a);case 10:case"end":return n.stop()}},_callee39,_this)})),function exec(e,t,n,r){return _ref76.apply(this,arguments)})},{name:"save this world",exec:function exec(e,t,n,r){return e.execCommand("save world",Object.assign({confirmOverwrite:!0},t,{showSaveDialog:!1}))}},{name:"load world",exec:(_ref77=asyncToGenerator(regeneratorRuntime.mark(function _callee40(e){var t,n,r,i,o,a,s,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee40$(c){for(;;)switch(c.prev=c.next){case 0:if(t=l.id,n=l.commit,r=l.name,i=l.ref,o=l.world,a=e.constructor,!o){c.next=4;break}return c.abrupt("return",a.loadWorld(o,e));case 4:if(!t&&!n){c.next=6;break}return c.abrupt("return",a.loadFromCommit(t||n,e));case 6:if(!r){c.next=8;break}return c.abrupt("return",a.loadFromDB(r,i,e));case 8:if(c.t0=e.get("world-list"),c.t0){c.next=13;break}return c.next=12,loadObjectFromPartsbinFolder("world-list");case 12:c.t0=c.sent;case 13:return(s=c.t0).bringToFront().alignInWorld(e),s.update(),s.focus(),c.abrupt("return",s);case 18:case"end":return c.stop()}},_callee40,_this)})),function exec(e){return _ref77.apply(this,arguments)})},{name:"add external package dependency to object",exec:(_ref78=asyncToGenerator(regeneratorRuntime.mark(function _callee41(e){var t,n,r,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee41$(a){for(;;)switch(a.prev=a.next){case 0:return t=o.target||e,n=t.metadata&&t.metadata.externalPackages||[],a.next=4,e.editListPrompt("modify package dependencies of "+t,n);case 4:if(r=a.sent,i=r.list){a.next=8;break}return a.abrupt("return");case 8:return i.length?(t.metadata||(t.metadata={}),t.metadata.externalPackages=i):t.metadata&&delete t.metadata.externalPackages,a.abrupt("return",!0);case 10:case"end":return a.stop()}},_callee41,_this)})),function exec(e){return _ref78.apply(this,arguments)})}],_ref78,_ref77,_ref76,_ref75,_ref74,_ref72,_ref71,_ref69,_ref67,_ref65,_ref63,_ref62,_ref60,_ref55,_ref49,_ref47,_ref46,_ref43,_ref42,_ref23,_ref22,_ref20,_ref19,_ref14,_ref7,World=function(e){var t=_classRecorder,n=t.hasOwnProperty("World")&&"function"==typeof t.World?t.World:t.World=function World(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function World_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this._renderer=null,this._tooltipViewer=new TooltipViewer(this)}},{key:"__deserialize__",value:function World___deserialize___(e,t){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__deserialize__",this).call(this,e,t),this._renderer=null,this._tooltipViewer=new TooltipViewer(this)}},{key:"__additionally_serialize__",value:function World___additionally_serialize___(e,t,r,i){if(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__additionally_serialize__",this).call(this,e,t,r,i),e.props.submorphs)for(var o=e.props.submorphs.value,a=o.length;a--;){var s=o[a].id;r.refForId(s).realObj.isHand&&lively_lang.arr.removeAt(o,a)}}},{key:"isWorld",get:function get(){return!0}},{key:"render",value:function World_render_(e){return e.renderWorld(this)}},{key:"draggable",get:function get(){return!0}},{key:"draggable",set:function set(e){}},{key:"grabbable",get:function get(){return!1}},{key:"grabbable",set:function set(e){}},{key:"existingHandForPointerId",value:function World_existingHandForPointerId_(e){return this.submorphs.find(function(t){return t instanceof Hand&&t.pointerId===e})}},{key:"handForPointerId",value:function World_handForPointerId_(e){return this.existingHandForPointerId(e)||this.addMorph(new Hand(e),this.submorphs[0])}},{key:"removeHandForPointerId",value:function World_removeHandForPointerId_(e){var t=this.existingHandForPointerId(e);t&&this.hands.length>1&&t.remove()}},{key:"world",value:function World_world_(){return this}},{key:"makeDirty",value:function World_makeDirty_(){if(!this._dirty){this._dirty=!0;var e=this.env.renderer;e&&e.renderLater()}}},{key:"hands",get:function get(){return lively_lang.arr.sortBy(this.submorphs.filter(function(e){return e.isHand}),function(e){return e.pointerId})}},{key:"firstHand",get:function get(){return this.hands[0]}},{key:"activeWindow",value:function World_activeWindow_(){return this.getWindows().reverse().find(function(e){return e.isActive()})}},{key:"getWindows",value:function World_getWindows_(){return this.submorphs.filter(function(e){return e.isWindow})}},{key:"activePrompt",value:function World_activePrompt_(){return this.getPrompts().reverse().find(function(e){return e.isActive()})}},{key:"getPrompts",value:function World_getPrompts_(){return this.submorphs.filter(function(e){return e.isPrompt})}},{key:"openInWindow",value:function World_openInWindow_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{title:e.name,name:"window for "+e.name},n=new lively_components.Window(Object.assign({},t,{extent:e.extent.addXY(0,25),targetMorph:e})).openInWorld();return n.ensureNotOverTheTop(),n}},{key:"getCurrentUser",value:function World_getCurrentUser_(){return lively.user?lively.user.UserRegistry.current.loadUserFromLocalStorage(config$1.users.authServerURL):null}},{key:"focusedMorph",get:function get(){var e=this.env.eventDispatcher,t=e&&e.eventState.focusedMorph;return t&&t.world()===this?t:this}},{key:"onMouseMove",value:function World_onMouseMove_(e){e.hand&&e.hand.update(e),this._tooltipViewer.mouseMove(e)}},{key:"onMouseDown",value:function World_onMouseDown_(e){var t,n=e.state.clickedOnMorph,r=e.isCommandKey(),i=e.isShiftDown(),o=this.activeWindow();if(o&&n==this&&o.deactivate(),r&&!n.isHalo){var a=e.world.morphsContainingPoint(e.position),s=a.slice(a.indexOf(n));a=a.filter(function(e){return e.halosEnabled}),t=(s=s.filter(function(e){return e.halosEnabled}))[0]||a[0]}if(i&&!n.isHaloItem&&t&&e.halo&&e.halo.borderBox!=t)e.halo.addMorphToSelection(t);else{var l=e.halo&&!e.targetMorphs.find(function(e){return e.isHaloItem}),c=e.layoutHalo&&!e.targetMorphs.find(function(e){return e.isHaloItem}),u=(!e.halo||l)&&t;if(c&&e.layoutHalo.remove(),l&&e.halo.remove(),u)return e.stop(),void this.showHaloFor(t,e.domEvt.pointerId);e.state.menu&&e.state.menu.remove(),this._tooltipViewer.mouseDown(e)}}},{key:"onMouseUp",value:function World_onMouseUp_(e){if(e.isCommandKey()&&e.stop(),e.isAltDown()&&config$1.altClickDefinesThat){var t=this.morphsContainingPoint(e.position)[0];return setTimeout(function(){return System.global.that=t},100),t.show(),e.stop(),void console.log('Set global "that" to '+t)}}},{key:"onLongClick",value:function World_onLongClick_(e){var t,n=e.state.prevClick.clickedOnMorph,r=e.world.morphsContainingPoint(e.position),i=r.slice(r.indexOf(n));r=r.filter(function(e){return e.halosEnabled}),t=(i=i.filter(function(e){return e.halosEnabled}))[0]||r[0];var o=e.halo&&!e.targetMorphs.find(function(e){return e.isHaloItem}),a=e.layoutHalo&&!e.targetMorphs.find(function(e){return e.isHaloItem}),s=(!e.halo||o)&&t;if(a&&e.layoutHalo.remove(),o&&e.halo.remove(),s)return e.stop(),void this.showHaloFor(t,e.domEvt.pointerId)}},{key:"onMouseWheel",value:function World_onMouseWheel_(e){e.isShiftDown()&&(window.scrollBy(-e.domEvt.wheelDeltaX,-e.domEvt.wheelDeltaY),e.stop())}},{key:"onDragStart",value:function World_onDragStart_(e){e.leftMouseButtonPressed()&&(this.selectionStartPos=e.positionIn(this),this.morphSelection=this.addMorph({isSelectionElement:!0,position:this.selectionStartPos,extent:e.state.dragDelta,fill:lively_graphics.Color.gray.withA(.2),borderWidth:2,borderColor:lively_graphics.Color.gray}),this.selectedMorphs={})}},{key:"onDrag",value:function World_onDrag_(e){var t,n=this;this.morphSelection&&(t=lively_graphics.Rectangle.fromAny(e.position,n.selectionStartPos),n.morphSelection.setBounds(t),n.submorphs.forEach(function(e){if(!e.isSelectionElement&&!e.isHand){var r=e.bounds(),i=t.containsRect(r);!n.selectedMorphs[e.id]&&i&&(n.selectedMorphs[e.id]=n.addMorph({isSelectionElement:!0,bounds:r,borderColor:lively_graphics.Color.red,borderWidth:1,fill:lively_graphics.Color.transparent},n.morphSelection)),n.selectedMorphs[e.id]&&!i&&(n.selectedMorphs[e.id].remove(),delete n.selectedMorphs[e.id])}}))}},{key:"onDragEnd",value:function World_onDragEnd_(e){var t=this;this.morphSelection&&(this.morphSelection.fadeOut(200),lively_lang.obj.values(this.selectedMorphs).map(function(e){return e.remove()}),this.showHaloForSelection(Object.keys(this.selectedMorphs).map(function(e){return t.getMorphWithId(e)})),this.selectedMorphs={},this.morphSelection=null)}},{key:"nativeDrop_ensureUploadIndicator",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(){var e,t=this;return regeneratorRuntime.wrap(function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return this._cachedDragIndicator||(this._cachedDragIndicator=loadObjectFromPartsbinFolder("upload-indicator")),n.next=3,this._cachedDragIndicator;case 3:(e=n.sent).world()||e.openInWorld(),lively_lang.fun.debounceNamed("remove-upload-indicator",1e3,function(){t.nativeDrop_removeUploadIndicator()})();case 6:case"end":return n.stop()}},_callee,this)}));return function World_nativeDrop_ensureUploadIndicator_(){return e.apply(this,arguments)}}()},{key:"nativeDrop_removeUploadIndicator",value:function World_nativeDrop_removeUploadIndicator_(){this._cachedDragIndicator&&this._cachedDragIndicator.then(function(e){return e.remove()})}},{key:"onNativeDragover",value:function World_onNativeDragover_(e){e.targetMorph===this&&this.nativeDrop_ensureUploadIndicator()}},{key:"onNativeDrop",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var t,n,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k,S,C,M,T,P,A,L,R,E,O,z,D,I,F,j,B,N,W,H,V=this;return regeneratorRuntime.wrap(function _callee3$(G){for(;;)switch(G.prev=G.next){case 0:if(this.nativeDrop_removeUploadIndicator(),e.targetMorph==this){G.next=3;break}return G.abrupt("return");case 3:if(t=e.domEvt,n=t.dataTransfer,r=n.files,n.items,i=document.location.origin,!r.length){G.next=129;break}if(o=this.getCurrentUser(),a=o.isGuestUser?"uploads/":"users/"+$world.getCurrentUser().name+"/uploads",!e.isAltDown()){G.next=12;break}return G.next=9,this.prompt("Choose upload location",{history:"lively.morphic-html-drop-file-upload-location",input:a});case 9:if(a=G.sent){G.next=12;break}return G.abrupt("return",this.setStatusMessage("Canceled upload"));case 12:return G.next=14,this.confirm("Upload "+r.length+" file"+(r.length>1?"s":"")+"?");case 14:if(G.sent){G.next=17;break}return G.abrupt("return");case 17:for(s=new FormData,l=0;l<r.length;l++)s.append("file",r[l],r[l].name);return c=void 0,u=void 0,G.prev=20,h={},o.isGuestUser||(h.Authorization="Bearer "+o.token),G.next=25,fetch("/upload?uploadPath="+encodeURIComponent(a),{method:"POST",body:s,headers:h});case 25:return c=G.sent,G.next=28,c.text();case 28:u=G.sent,G.next=34;break;case 31:return G.prev=31,G.t0=G.catch(20),G.abrupt("return",this.showError("Upload failed: "+G.t0.message+"\n"));case 34:if(c.ok){G.next=36;break}return G.abrupt("return",this.showError(u||c.statusText));case 36:if(G.prev=36,"done"===(d=JSON.parse(u)).status){G.next=40;break}return G.abrupt("return",this.setStatusMessage("File upload failed: "+d.status));case 40:for(this.setStatusMessage("Uploaded "+d.uploadedFiles.length+" file"),p=d.uploadedFiles.map(function(e){var t=lively.resources.resource(i).join(e.path);return Object.assign({},e,{url:t.url,name:t.name()})}),f=[],g=[],m=[],v=!0,y=!1,_=void 0,G.prev=46,b=p[Symbol.iterator]();!(v=(x=b.next()).done);v=!0)(w=x.value).type.startsWith("image/")?f.push(w):w.type.startsWith("video")?g.push(w):m.push(w);G.next=54;break;case 50:G.prev=50,G.t1=G.catch(46),y=!0,_=G.t1;case 54:G.prev=54,G.prev=55,!v&&b.return&&b.return();case 57:if(G.prev=57,!y){G.next=60;break}throw _;case 60:return G.finish(57);case 61:return G.finish(54);case 62:if(!g.length){G.next=93;break}k=!0,S=!1,C=void 0,G.prev=66,M=g[Symbol.iterator]();case 68:if(k=(T=M.next()).done){G.next=79;break}return P=T.value,G.t2=Object,G.next=73,loadObjectFromPartsbinFolder("video morph");case 73:G.t3=G.sent,G.t4={videoURL:P.url,name:P.name},G.t2.assign.call(G.t2,G.t3,G.t4).openInWorld();case 76:k=!0,G.next=68;break;case 79:G.next=85;break;case 81:G.prev=81,G.t5=G.catch(66),S=!0,C=G.t5;case 85:G.prev=85,G.prev=86,!k&&M.return&&M.return();case 88:if(G.prev=88,!S){G.next=91;break}throw C;case 91:return G.finish(88);case 92:return G.finish(85);case 93:if(f.length&&!0&&f.forEach(function(e){var t=new Image({imageUrl:e.url,autoResize:!0,name:e.name});t.whenLoaded().then(asyncToGenerator(regeneratorRuntime.mark(function _callee2(){return regeneratorRuntime.wrap(function _callee2$(e){for(;;)switch(e.prev=e.next){case 0:return t.extent=t.naturalExtent.scaleBy(.8*V.visibleBounds().height/t.height),t.openInWorld(),e.next=4,t.whenRendered();case 4:t.center=V.visibleBounds().center();case 5:case"end":return e.stop()}},_callee2,V)})))}),!m.length){G.next=123;break}A=!0,L=!1,R=void 0,G.prev=98,E=m[Symbol.iterator]();case 100:if(A=(O=E.next()).done){G.next=109;break}return z=O.value,G.next=104,this.confirm("open file "+z.name+" ("+z.type+")?");case 104:G.sent&&this.execCommand("open file",{url:z.url});case 106:A=!0,G.next=100;break;case 109:G.next=115;break;case 111:G.prev=111,G.t6=G.catch(98),L=!0,R=G.t6;case 115:G.prev=115,G.prev=116,!A&&E.return&&E.return();case 118:if(G.prev=118,!L){G.next=121;break}throw R;case 121:return G.finish(118);case 122:return G.finish(115);case 123:G.next=128;break;case 125:G.prev=125,G.t7=G.catch(36),this.showError(G.t7);case 128:return G.abrupt("return");case 129:if(!(D=t.dataTransfer.types).includes("text/html")){G.next=143;break}if(I=t.dataTransfer.getData("text/html"),F=(new DOMParser).parseFromString(I,"text/html"),1!==(j=F.querySelectorAll("img")).length||!j[0].src||!D.includes("text/uri-list")){G.next=136;break}!function(){var e=j[0].src,t=new Image({imageUrl:e,autoResize:!0,name:lively_lang.arr.last(e.split("/"))});t.whenLoaded().then(function(){return t.openInWorld()})}(),G.next=142;break;case 136:return G.t8=Object,G.next=139,loadObjectFromPartsbinFolder("html-morph");case 139:G.t9=G.sent,G.t10={html:I},G.t8.assign.call(G.t8,G.t9,G.t10).openInWorld();case 142:return G.abrupt("return");case 143:B=0;case 144:if(!(B<t.dataTransfer.items.length)){G.next=163;break}if("file"!==(N=t.dataTransfer.items[B]).kind){G.next=159;break}return W=N.getAsFile(),G.next=150,this.confirm("Upload "+W.name+"?");case 150:if(!G.sent){G.next=157;break}return G.next=154,uploadFile(W,W.type);case 154:(H=G.sent)&&H.openInWorld(),H.center=this.visibleBounds().center();case 157:G.next=160;break;case 159:"string"===N.kind&&N.getAsString(function(e){return exports.inspect(e)});case 160:B++,G.next=144;break;case 163:case"end":return G.stop()}},_callee3,this,[[20,31],[36,125],[46,50,54,62],[55,,57,61],[66,81,85,93],[86,,88,92],[98,111,115,123],[116,,118,122]])}));return function World_onNativeDrop_(t){return e.apply(this,arguments)}}()},{key:"serveFileAsDownload",value:function World_serveFileAsDownload_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.fileName,r=void 0===n?"file.txt":n,i=t.type,o=void 0===i?"text/plain":i,a=window.document.createElement("a");a.href=window.URL.createObjectURL(new Blob([e],{type:o})),a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a)}},{key:"menuItems",value:function World_menuItems_(){var e=this;return[{title:"World menu"},{command:"undo",target:this},{command:"redo",target:this},{isDivider:!0},["Debugging",[{command:"delete change history",target:this},{command:"fix font metric",target:this},{command:"inspect server",target:this}]],["Tools",[{command:"open PartsBin",target:this},{command:"open workspace",target:this},{command:"open browser",target:this},{command:"choose and browse module",target:this},{command:"open code search",target:this},{command:"open file browser",target:this},{command:"open shell workspace",target:this}]],{isDivider:!0},{command:"run command",target:this},{command:"select morph",target:this},{command:"window switcher",target:this},["Resize","static"===this.resizePolicy?[{command:"resize to fit window",target:this},{command:"resize manually",target:this},["switch to automatic resizing of world",function(){return e.resizePolicy="elastic"}]]:[["switch to manual resizing of world",function(){return e.resizePolicy="static"}]]],{command:"report a bug",target:this},{isDivider:!0},{command:"save world",target:this},{command:"load world",target:this}]}},{key:"openWorldMenu",value:function World_openWorldMenu_(e,t){var n=this.env.eventDispatcher.eventState;return n.menu&&n.menu.remove(),n.menu=t&&t.length?lively_components.Menu.openAtHand(t,{hand:e&&e.hand||this.firstHand}):null}},{key:"onWindowScroll",value:function World_onWindowScroll_(e){var t=e.dispatcher.keyInputHelper.inputState,n=t.positionChangedTime,r=t.scrollLeftWhenChanged,i=t.scrollTopWhenChanged,o=document.documentElement;if(Date.now()-n<500&&!bowser.firefox)return o.scrollLeft=r,void(o.scrollTop=i);this.setProperty("scroll",lively_graphics.pt(o.scrollLeft,o.scrollTop)),this._cachedWindowBounds=null,this.updateVisibleWindowMorphs(e),this.onMouseMove(e)}},{key:"onWindowResize",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var t,n,r,i,o,a;return regeneratorRuntime.wrap(function _callee4$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this.whenRendered();case 2:for(this._cachedWindowBounds=null,"elastic"===this.resizePolicy&&this.execCommand("resize to fit window"),this.updateVisibleWindowMorphs(e),t=!0,n=!1,r=void 0,s.prev=8,i=this.submorphs[Symbol.iterator]();!(t=(o=i.next()).done);t=!0)"function"==typeof(a=o.value).onWorldResize&&a.onWorldResize(e);s.next=16;break;case 12:s.prev=12,s.t0=s.catch(8),n=!0,r=s.t0;case 16:s.prev=16,s.prev=17,!t&&i.return&&i.return();case 19:if(s.prev=19,!n){s.next=22;break}throw r;case 22:return s.finish(19);case 23:return s.finish(16);case 24:case"end":return s.stop()}},_callee4,this,[[8,12,16,24],[17,,19,23]])}));return function World_onWindowResize_(t){return e.apply(this,arguments)}}()},{key:"updateVisibleWindowMorphs",value:function World_updateVisibleWindowMorphs_(e){this.withAllSubmorphsDo(function(t){if(t.respondsToVisibleWindow)return"function"!=typeof t.relayout?t.showError(new Error(t+" listed as responding to visible window change, but has no relayout instruction")):void t.relayout(e)})}},{key:"onPaste",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee5(e){var t,n,r,i,o,a,s,l,c,u,h,d,p;return regeneratorRuntime.wrap(function _callee5$(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,!(t=e.domEvt.clipboardData).types.includes("application/morphic")){f.next=38;break}e.stop(),n=JSON.parse(t.getData("application/morphic")),r=[],t.clearData(),Array.isArray(n)||(n=[n]),i=!0,o=!1,a=void 0,f.prev=10,s=n[Symbol.iterator]();case 12:if(i=(l=s.next()).done){f.next=23;break}return c=l.value,f.next=16,loadMorphFromSnapshot$$1(c);case 16:(u=f.sent).openInWorld(e.hand.position),c.copyMeta&&c.copyMeta.offset&&(h=c.copyMeta.offset,d=h.x,p=h.y,u.moveBy(lively_graphics.pt(d,p))),r.push(u);case 20:i=!0,f.next=12;break;case 23:f.next=29;break;case 25:f.prev=25,f.t0=f.catch(10),o=!0,a=f.t0;case 29:f.prev=29,f.prev=30,!i&&s.return&&s.return();case 32:if(f.prev=32,!o){f.next=35;break}throw a;case 35:return f.finish(32);case 36:return f.finish(29);case 37:this.showHaloFor(r);case 38:f.next=43;break;case 40:f.prev=40,f.t1=f.catch(0),this.showError(f.t1);case 43:case"end":return f.stop()}},_callee5,this,[[0,40],[10,25,29,37],[30,,32,36]])}));return function World_onPaste_(t){return e.apply(this,arguments)}}()},{key:"relayCommandExecutionToFocusedMorph",value:function World_relayCommandExecutionToFocusedMorph_(e){if(!e)return null;var t=this.focusedMorph,n=lively_lang.arr.findAndGet(lively_lang.arr.without([t].concat(toConsumableArray(t.ownerChain())),this),function(t){return lively_lang.arr.findAndGet(t.keyhandlers,function(n){var r=n.eventCommandLookup(t,e);return r?{command:r,morph:t}:null})})||{},r=n.command,i=n.morph;return r?i.execCommand(r):null}},{key:"commands",get:function get(){return commands.concat(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"commands",this))}},{key:"keybindings",get:function get(){return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"keybindings",this).concat(config$1.globalKeyBindings)}},{key:"keybindings",set:function set(e){lively.classes.runtime.initializeClass._set(Object.getPrototypeOf(n.prototype),"keybindings",e,this)}},{key:"onBeforeUnload",value:function World_onBeforeUnload_(e){return this.onUnload(e)}},{key:"onUnload",value:function World_onUnload_(e){this.submorphs.forEach(function(t){"function"==typeof t.onWorldUnload&&t.onWorldUnload(e)})}},{key:"halos",value:function World_halos_(){return this.submorphs.filter(function(e){return e.isHalo})}},{key:"haloForPointerId",value:function World_haloForPointerId_(e){return this.submorphs.find(function(t){return t.isHalo&&t.state&&t.state.pointerId===e})}},{key:"showHaloFor",value:function World_showHaloFor_(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.firstHand&&this.firstHand.pointerId,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(Halo__default)return t="function"==typeof e.createHalo?e.createHalo(Halo__default,n):new Halo__default({pointerId:n,target:e}),this.addMorph(t),r&&t.focus(),t}},{key:"showHaloForSelection",value:function World_showHaloForSelection_(e,t){return e.length>0&&this.showHaloFor(e,t)}},{key:"layoutHaloForPointerId",value:function World_layoutHaloForPointerId_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.firstHand&&this.firstHand.pointerId;return this.submorphs.find(function(t){return t.isLayoutHalo&&t.state&&t.state.pointerId===e})}},{key:"showLayoutHaloFor",value:function World_showLayoutHaloFor_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.firstHand&&this.firstHand.pointerId,n=e===this?null:e.owner===this?e:e.ownerChain().slice(-2)[0],r=n?this.submorphs.indexOf(n)+1:this.submorphs.length,i=e.layout.inspect(t);return this.addMorphAt(i,r)}},{key:"highlightMorph",value:function World_highlightMorph_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return Halo.MorphHighlighter.for(e,t,n,r)}},{key:"removeHighlighters",value:function World_removeHighlighters_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this;return Halo.MorphHighlighter.removeHighlighters(e)}},{key:"visibleBounds",value:function World_visibleBounds_(){return this.env.renderer?this.windowBounds().intersection(this.innerBounds()):this.innerBounds()}},{key:"windowBounds",value:function World_windowBounds_(e){if(this._cachedWindowBounds)return this._cachedWindowBounds;var t=this.env.domEnv.window,n=1/this.scale,r=t.scrollX*n,i=t.scrollY*n,o=(t.innerWidth||this.width)*n,a=(t.innerHeight||this.height)*n;return this._cachedWindowBounds=new lively_graphics.Rectangle(r,i,o,a)}},{key:"visibleStatusMessages",value:function World_visibleStatusMessages_(){return this.submorphs.filter(function(e){return e.isStatusMessage})}},{key:"visibleStatusMessagesFor",value:function World_visibleStatusMessagesFor_(e){return this.submorphs.filter(function(t){return t.isStatusMessage&&t.targetMorph===e})}},{key:"logErrorPreperation",value:function World_logErrorPreperation_(e){var t=String(e),n=e.stack||"";n&&e.message!==e.stack&&(0===(n=String(n)).indexOf(t)&&(n=n.slice(t.length)),t+="\n"+n);return t}},{key:"logError",value:function World_logError_(e){this.setStatusMessage(this.logErrorPreperation(e),lively_graphics.Color.red)}},{key:"showError",value:function World_showError_(e){return this.logError(e)}},{key:"showErrorFor",value:function World_showErrorFor_(e,t){return this.setStatusMessageFor(e,this.logErrorPreperation(t),lively_graphics.Color.red)}},{key:"setStatusMessageFor",value:function World_setStatusMessageFor_(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5e3,i=arguments[4];this.visibleStatusMessagesFor(e).forEach(function(e){return e.remove()});var o=new lively_halos_markers_js.StatusMessageForMorph(Object.assign({message:t,color:n},i));return this.openStatusMessage(o,r),o.targetMorph=e,o.fadeIn(300),o.removeOnTargetMorphChange&&e.isText&&lively_bindings.once(e,"selectionChange",o,"fadeOut",{converter:function converter(){return 200}}),o}},{key:"setStatusMessage",value:function World_setStatusMessage_(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return console[t==lively_graphics.Color.red?"error":"log"](e),config$1.verboseLogging?this.openStatusMessage(new lively_halos_markers_js.StatusMessage(Object.assign({message:e,color:t},r)),n):null}},{key:"openStatusMessage",value:function World_openStatusMessage_(e,t){var n,r=this;if(this.addMorph(e),e.slidable){var i=this.visibleStatusMessages(),o=!0,a=!1,s=void 0;try{for(var l,c=i[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if(i.length<=(config$1.maxStatusMessages||0))break;!u.stayOpen&&u.slidable&&(u.remove(),lively_lang.arr.remove(i,u))}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}lively_lang.arr.without(i,e).forEach((n=asyncToGenerator(regeneratorRuntime.mark(function _callee6(t){return regeneratorRuntime.wrap(function _callee6$(n){for(;;)switch(n.prev=n.next){case 0:!t.isMaximized&&t.slidable&&t.slideTo(t.position.addPt(lively_graphics.pt(0,-e.extent.y-10)));case 1:case"end":return n.stop()}},_callee6,r)})),function(e){return n.apply(this,arguments)}));var h=this.visibleBounds().bottomRight().addXY(-20,-20);e.align(e.bounds().bottomRight(),h),e.topRight=h.addPt(lively_graphics.pt(0,40)),e.animate({bottomRight:h,duration:500})}return"number"==typeof t&&setTimeout(function(){return e.stayOpen||e.fadeOut()},t),e}},{key:"addProgressBar",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee7(){var e,t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:return e=r.location,t=void 0===e?"center":e,i.next=4,loadObjectFromPartsbinFolder("progress bar");case 4:return n=i.sent,Object.assign(n,{progress:0},lively_lang.obj.dissoc(r,["location"])),this.addMorph(n),n.align(n[t],this.visibleBounds()[t]()),i.abrupt("return",n);case 9:case"end":return i.stop()}},_callee7,this)}));return function World_addProgressBar_(){return e.apply(this,arguments)}}()},{key:"withProgressBarDo",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e,t){var n;return regeneratorRuntime.wrap(function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.addProgressBar(t);case 2:return n=r.sent,r.prev=3,r.next=6,e(n);case 6:return r.abrupt("return",r.sent);case 7:return r.prev=7,n.remove(),r.finish(7);case 10:case"end":return r.stop()}},_callee8,this,[[3,,7,10]])}));return function World_withProgressBarDo_(t,n){return e.apply(this,arguments)}}()},{key:"openPrompt",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee9(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,animated:!1};return regeneratorRuntime.wrap(function _callee9$(i){for(;;)switch(i.prev=i.next){case 0:return t=this.focusedMorph,n=this.visibleBounds(),e.openInWorldNear(r.requester?n.intersection(r.requester.globalBounds()).center():n.center(),this),e.height>n.height&&(e.height=n.height-5),"function"==typeof r.customize&&r.customize(e),r.animated&&(this.previousPrompt&&this.previousPrompt.world()?this.previousPrompt.transitionTo(e):e.openInWorld(e.globalPosition)),this.previousPrompt=e,i.abrupt("return",lively_lang.promise.finally(e.activate(r),function(){return t&&t.focus()}));case 7:case"end":return i.stop()}},_callee9,this)}));return function World_openPrompt_(t){return e.apply(this,arguments)}}()},{key:"inform",value:function World_inform_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no message",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{fontSize:16,requester:null,animated:!0};return this.openPrompt(new lively_components_prompts_js.InformPrompt(Object.assign({label:e},t)),t)}},{key:"prompt",value:function World_prompt_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,input:"",historyId:null,useLastInput:!1};return this.openPrompt(new lively_components_prompts_js.TextPrompt(Object.assign({label:e},t)),t)}},{key:"editPrompt",value:function World_editPrompt_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,input:"",historyId:null,useLastInput:!1,textStyle:null,mode:null,evalEnvironment:null};return this.openPrompt(new lively_components_prompts_js.EditPrompt(Object.assign({label:e},t)),t)}},{key:"passwordPrompt",value:function World_passwordPrompt_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,input:""};return this.openPrompt(new lively_components_prompts_js.PasswordPrompt(Object.assign({label:e},t)),t)}},{key:"confirm",value:function World_confirm_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,animated:!0};return this.openPrompt(new lively_components_prompts_js.ConfirmPrompt(Object.assign({label:e},t)),t)}},{key:"multipleChoicePrompt",value:function World_multipleChoicePrompt_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{requester:null,animated:!0,choices:[]};return this.openPrompt(new lively_components_prompts_js.MultipleChoicePrompt(Object.assign({label:e},t)),t)}},{key:"listPrompt",value:function World_listPrompt_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{requester:null,onSelection:null,preselect:0};return this.openPrompt(new lively_components_prompts_js.ListPrompt(Object.assign({filterable:!1,padding:lively_graphics.Rectangle.inset(3),label:e,items:t},n)),n)}},{key:"filterableListPrompt",value:function World_filterableListPrompt_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{requester:null,onSelection:null,preselect:0,multiSelect:!1,historyId:null,fuzzy:!1,actions:["default"],selectedAction:"default",theme:"dark"};if(n.prompt){var r=n.prompt.get("list");return r.items=t,r.selectedIndex=n.preselect||0,this.openPrompt(n.prompt,n)}return this.openPrompt(new lively_components_prompts_js.ListPrompt(Object.assign({filterable:!0,padding:lively_graphics.Rectangle.inset(3),label:e,items:t},n)),n)}},{key:"editListPrompt",value:function World_editListPrompt_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{requester:null,multiSelect:!0,historyId:null};return this.openPrompt(new lively_components_prompts_js.EditListPrompt(Object.assign({label:e,multiSelect:!0,items:t,padding:lively_graphics.Rectangle.inset(3)},n)),n)}},{key:"showLoadingIndicatorFor",value:function World_showLoadingIndicatorFor_(e,t){return this.addMorph(LoadingIndicator.open(t,{center:e.globalBounds().center()}))}}],[{key:"properties",get:function get(){return{resizePolicy:{doc:"how the world behaves on window size changes 'elastic': resizes to window extent, 'static': leaves its extent unchanged",defaultValue:"elastic",after:["clipMode"],type:"Enum",values:["static","elastic"],set:function set(e){this.setProperty("resizePolicy",e),this.clipMode="static"===e?"visible":"hidden","elastic"==e&&this.execCommand("resize to fit window")}},showsUserFlap:{defaultValue:!0,set:function set(e){var t=this;this.setProperty("showsUserFlap",e),System.import("lively.user/morphic/user-ui.js").then(function(n){return n.UserUI[e?"showUserFlap":"hideUserFlap"](t)})}},styleSheets:{initialize:function initialize(){this.styleSheets=lively_lang.arr.compact([lively_halos_markers_js.StatusMessage,lively_ide_styling_gradientEditor_js.GradientEditor,lively_components.Window,lively_components.FilterableList,lively_components.List,LoadingIndicator,Tooltip].map(function(e){return e&&e.styleSheet}).concat(lively_components.Window&&lively_components.Window.nodeStyleSheet))}}}}},{key:"defaultWorld",value:function World_defaultWorld_(){return MorphicEnv.default().world}},{key:"loadWorldFromURL",value:function World_loadWorldFromURL_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultWorld(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return loadWorldFromURL(e,t,n)}},{key:"loadWorld",value:function World_loadWorld_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultWorld(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return loadWorld(e,t,n)}},{key:"loadFromCommit",value:function World_loadFromCommit_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultWorld(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return loadWorldFromCommit(e,t,n)}},{key:"loadFromDB",value:function World_loadFromDB_(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.defaultWorld(),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return loadWorldFromDB(e,t,n,r)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1478,end:33326})}({referencedAs:"Morph",value:Morph}),Hand=function(e){var t=_classRecorder,n=t.hasOwnProperty("Hand")&&"function"==typeof t.Hand?t.Hand:t.Hand=function Hand(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Hand_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,{pointerId:e})}},{key:"__deserialize__",value:function Hand___deserialize___(e,t){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__deserialize__",this).call(this,e,t),this.reset()}},{key:"reset",value:function Hand_reset_(){this._grabbedMorphProperties=new WeakMap}},{key:"isHand",get:function get(){return!0}},{key:"pointerId",get:function get(){return this.getProperty("pointerId")}},{key:"pointerId",set:function set(e){this.setProperty("pointerId",e)}},{key:"draggable",get:function get(){return!1}},{key:"draggable",set:function set(e){}},{key:"grabbable",get:function get(){return!1}},{key:"grabbable",set:function set(e){}},{key:"grabbedMorphs",get:function get(){return this.submorphs}},{key:"carriesMorphs",value:function Hand_carriesMorphs_(){return!!this.grabbedMorphs.length}},{key:"morphsContainingPoint",value:function Hand_morphsContainingPoint_(e,t){return t}},{key:"update",value:function Hand_update_(e){this.position=e.position}},{key:"cancelGrab",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee10(){var e,t,n,r,i,o,a,s,l,c,u,h,d=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],p=arguments[1];return regeneratorRuntime.wrap(function _callee10$(f){for(;;)switch(f.prev=f.next){case 0:if(this.grabbedMorphs.length){f.next=2;break}return f.abrupt("return");case 2:this.env.eventDispatcher.cancelGrab(this,p),e=[],t=!0,n=!1,r=void 0,f.prev=7,i=this.grabbedMorphs[Symbol.iterator]();case 9:if(t=(o=i.next()).done){f.next=21;break}if(a=o.value,s=this._grabbedMorphProperties.get(a)||{},l=s.prevOwner,c=s.prevIndex,u=s.prevPosition,h=s.pointerAndShadow,Object.assign(a,h),l){f.next=16;break}return a.remove(),f.abrupt("continue",18);case 16:l.addMorphAt(a,c),d?e.push(a.animate({position:u})):a.position=u;case 18:t=!0,f.next=9;break;case 21:f.next=27;break;case 23:f.prev=23,f.t0=f.catch(7),n=!0,r=f.t0;case 27:f.prev=27,f.prev=28,!t&&i.return&&i.return();case 30:if(f.prev=30,!n){f.next=33;break}throw r;case 33:return f.finish(30);case 34:return f.finish(27);case 35:return f.abrupt("return",e.length?Promise.all(e):null);case 36:case"end":return f.stop()}},_callee10,this,[[7,23,27,35],[28,,30,34]])}));return function Hand_cancelGrab_(){return e.apply(this,arguments)}}()},{key:"grab",value:function Hand_grab_(e){var t=this;if(lively_lang.obj.isArray(e))return e.forEach(function(e){return t.grab(e)});this._grabbedMorphProperties.set(e,{prevOwner:e.owner,prevPosition:e.position,prevIndex:e.owner?e.owner.submorphs.indexOf(e):-1,pointerAndShadow:lively_lang.obj.select(e,["dropShadow","reactsToPointer"])}),e.reactsToPointer=!1,e.dropShadow=!0,this.addMorph(e),lively_bindings.signal(this,"grab",e)}},{key:"dropMorphsOn",value:function Hand_dropMorphsOn_(e){var t=this;this.grabbedMorphs.forEach(function(n){try{var r=(t._grabbedMorphProperties.get(n)||{}).pointerAndShadow;Object.assign(n,r),lively_bindings.signal(t,"drop",n),n.onBeingDroppedOn(t,e)}catch(r){console.error(r),t.world().showError("Error dropping "+n+" onto "+e+":\n"+r.stack),n.owner!==e&&t.world().addMorph(e)}})}},{key:"findDropTarget",value:function Hand_findDropTarget_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.position,t=this,n=arguments[1],r=arguments[2],i=this.world().morphsContainingPoint(e),o="function"==typeof r?function(e,i){return!t.isAncestorOf(e)&&e.acceptsDrops&&!n.includes(e)&&n.every(function(t){return t.wantsToBeDroppedOn(e)})&&r(e,i)}:function(e){return!t.isAncestorOf(e)&&e.acceptsDrops&&n.every(function(t){return t.wantsToBeDroppedOn(e)})};return i.find(o)}}],[{key:"properties",get:function get(){return{fill:{defaultValue:lively_graphics.Color.orange},extent:{defaultValue:lively_graphics.pt(1,1)},reactsToPointer:{defaultValue:!1},_grabbedMorphProperties:{serialize:!1,initialize:function initialize(){this._grabbedMorphProperties=new WeakMap}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:33335,end:36762})}({referencedAs:"Morph",value:Morph});function comparePosition(e,t){var n=e.row,r=e.column,i=t.row,o=t.column;return n<i?-2:n===i?r<o?-1:r===o?0:1:2}function lessPosition(e,t){return comparePosition(e,t)<0}function lessEqPosition(e,t){return comparePosition(e,t)<=0}function eqPosition(e,t){return 0===comparePosition(e,t)}function minPosition(e,t){return lessPosition(e,t)?e:t}function maxPosition(e,t){return lessPosition(e,t)?t:e}var Range=function(e){var t=_classRecorder,n=t.hasOwnProperty("Range")&&"function"==typeof t.Range?t.Range:t.Range=function Range(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Range_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{start:{row:0,column:0},end:{row:0,column:0}},t=e.start,n=t.row,r=t.column,i=e.end,o=i.row,a=i.column;if(o<n||o===n&&a<r){var s=[n,r,o,a];o=s[0],a=s[1],n=s[2],r=s[3]}this.start={row:n,column:r},this.end={row:o,column:a}}},{key:"isRange",get:function get(){return!0}},{key:"isEmpty",value:function Range_isEmpty_(){return this.start.row===this.end.row&&this.start.column===this.end.column}},{key:"equals",value:function Range_equals_(e){return!!(e&&e.start&&e.end)&&(eqPosition(this.start,e.start)&&eqPosition(this.end,e.end))}},{key:"copy",value:function Range_copy_(){return new Range(this)}},{key:"toLiteral",value:function Range_toLiteral_(){return{start:this.start,end:this.end}}},{key:"merge",value:function Range_merge_(e){return e.isRange||(e=new Range(e)),lessPosition(this.end,e.start)||lessPosition(e.end,this.start)?this:Range.fromPositions(minPosition(this.start,e.start),maxPosition(this.end,e.end))}},{key:"without",value:function Range_without_(e){e.isRange||(e=new Range(e));var t=Range.compare(this,e);return 0===t?Range.fromPositions(this.start,this.start):Math.abs(t)>=5?this:t<0?Range.fromPositions(this.start,e.start):Range.fromPositions(e.end,this.end)}},{key:"intersect",value:function Range_intersect_(e){e.isRange||(e=new Range(e));var t=Range.compare(this,e),n=t<0?this:e,r=t<0?e:this;switch(Math.abs(t)){case 0:case 1:return new Range(n);case 2:case 3:return new Range(r);case 4:return Range.fromPositions(r.start,n.end);case 5:return Range.at(r.start);case 6:return Range.at(n.end)}}},{key:"subtract",value:function Range_subtract_(e){switch(e.isRange||(e=new Range(e)),Range.compare(this,e)){case-6:case-5:case 5:case 6:return[new Range(this)];case-1:case 0:case 2:case 3:return[Range.at(this.start)];case 1:case 4:return[Range.fromPositions(e.end,this.end)];case-4:case-3:return[Range.fromPositions(this.start,e.start)];case-2:return[Range.fromPositions(this.start,e.start),Range.fromPositions(e.end,this.end)]}}},{key:"containsPosition",value:function Range_containsPosition_(e){return lessEqPosition(this.start,e)&&lessEqPosition(e,this.end)}},{key:"toString",value:function Range_toString_(){var e=this.start,t=e.row,n=e.column,r=this.end;return"Range("+t+"/"+n+" -> "+r.row+"/"+r.column+")"}}],[{key:"sort",value:function Range_sort_(e){return e.sort(Range.compare)}},{key:"compare",value:function Range_compare_(e,t){var n=e.start,r=e.end,i=t.start,o=t.end;return lessPosition(n,i)?lessPosition(r,i)?-6:eqPosition(r,i)?-5:lessPosition(r,o)?-4:eqPosition(r,o)?-3:-2:eqPosition(n,i)?eqPosition(r,o)?0:lessPosition(r,o)?-1:1:-1*Range.compare(t,e)}},{key:"at",value:function Range_at_(e){return new this({start:e,end:e})}},{key:"fromPositions",value:function Range_fromPositions_(e,t){return new this({start:e,end:t})}},{key:"create",value:function Range_create_(e,t,n,r){return new this({start:{row:e,column:t},end:{row:n,column:r}})}},{key:"isValidLiteral",value:function Range_isValidLiteral_(e){return!!e&&(!!e.isRange||e.start&&e.end&&"number"==typeof e.start.row&&"number"==typeof e.start.column&&"number"==typeof e.end.row&&"number"==typeof e.end.column)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:108,end:5392})}(void 0),defaultRange=new Range,Selection=function(e){var t=_classRecorder,n=t.hasOwnProperty("Selection")&&"function"==typeof t.Selection?t.Selection:t.Selection=function Selection(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Selection_initialize_(e,t){this.textMorph=e,this.initialize(t)}},{key:"isSelection",get:function get(){return!0}},{key:"initialize",value:function Selection_initialize_(e){this._goalColumn=void 0,this._goalX=void 0,this._isReverse=!1;var t=lively_lang.string.newUUID();this.startAnchor=this.textMorph.addAnchor("selection-start-"+t),this.endAnchor=this.textMorph.addAnchor("selection-end-"+t),this.range=Range.isValidLiteral(e)?e:defaultRange,this._cursorVisible=!0,this.cursorBlinkProcess=null}},{key:"isSelection",get:function get(){return!0}},{key:"uninstall",value:function Selection_uninstall_(){this.cursorBlinkStop(),this.textMorph.removeAnchor(this.startAnchor),this.textMorph.removeAnchor(this.endAnchor)}},{key:"compareRangesForMerge",value:function Selection_compareRangesForMerge_(e,t){var n=e.start,r=n.row,i=n.column,o=e.end,a=o.row,s=o.column,l=t.start,c=l.row,u=l.column,h=t.end,d=h.row,p=h.column;return r<c||r===c&&i<u?a<c||a===c&&s<u?"separate":a===c&&s===u?c===d&&u===p?"overlapping":"bordering":"overlapping":r===c&&i===u?a===d&&s===p?"equal":"overlapping":this.compareRangesForMerge(t,e)}},{key:"mergeWith",value:function Selection_mergeWith_(e){if(!e||!e.isSelection)return!1;var t=this.compareRangesForMerge(this.range,e.range);return"separate"!==t&&"bordering"!==t&&(this.range=this.range.merge(e.range),e.isReverse()!=this.isReverse()&&this.reverse(),!0)}},{key:"range",get:function get(){return this._range}},{key:"range",set:function set(e){if(e){var t=e,n=t.start,r=t.end;if(void 0!==n&&void 0!==r){var i=this.textMorph.document;if("number"==typeof n&&(e.start=n=i.indexToPosition(n)),"number"==typeof r&&(e.end=r=i.indexToPosition(r)),Range.isValidLiteral(e)){if(n=i.clipPositionToLines(n),r=i.clipPositionToLines(r),this._isReverse=lessPosition(r,n)){var o=[r,n];n=o[0],r=o[1]}e.start=n,e.end=r,e.isRange||(e=new Range(e)),e.equals(this._range)||(this._range=e,this._goalColumn=this.textMorph.lineWrapping?this.textMorph.columnInWrappedLine(this.lead):this.lead.column,this._goalX=this.textMorph.charBoundsFromTextPosition(this.lead).x,this.startAnchor.position=e.start,this.endAnchor.position=e.end,this.textMorph.makeDirty(),lively_bindings.signal(this.textMorph,"selectionChange",this))}}}}},{key:"directedRange",get:function get(){return{end:this.lead,start:this.anchor}}},{key:"updateFromAnchors",value:function Selection_updateFromAnchors_(){this.range={start:this.startAnchor.position,end:this.endAnchor.position}}},{key:"start",get:function get(){return this.range.start}},{key:"start",set:function set(e){this.range=Range.fromPositions(e,this.end)}},{key:"end",get:function get(){return this.range.end}},{key:"end",set:function set(e){this.range=Range.fromPositions(this.start,e)}},{key:"selectionColor",get:function get(){return this.textMorph.selectionColor||"#bed8f7"}},{key:"anchor",get:function get(){return this.isReverse()?this.range.end:this.range.start}},{key:"anchor",set:function set(e){this.range={start:e,end:this.lead}}},{key:"lead",get:function get(){return this.isReverse()?this.range.start:this.range.end}},{key:"lead",set:function set(e){this.range={start:this.anchor,end:e}}},{key:"text",get:function get(){return this.textMorph.document.textInRange(this.range)}},{key:"text",set:function set(e){this.replace(e)}},{key:"replace",value:function Selection_replace_(e,t,n,r){var i=this.range,o=this.textMorph,a=this.isReverse();return this.range=o.replace(i,e,t,n,r),a&&this.reverse(),this.range}},{key:"selectedRows",get:function get(){return{first:this.start.row,last:this.end.row}}},{key:"reverse",value:function Selection_reverse_(){return this._isReverse=!this.isEmpty()&&!this._isReverse,this}},{key:"isReverse",value:function Selection_isReverse_(){return this._isReverse&&!this.isEmpty()}},{key:"isEmpty",value:function Selection_isEmpty_(){return this.range.isEmpty()}},{key:"collapse",value:function Selection_collapse_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.start;return this.range={start:e,end:e},this}},{key:"collapseToEnd",value:function Selection_collapseToEnd_(){return this.collapse(this.end),this}},{key:"growLeft",value:function Selection_growLeft_(e){var t=this.textMorph.document,n=t.positionToIndex(this.end),r=Math.min(n,t.positionToIndex(this.start)-e),i=this.isReverse();return this.start=t.indexToPosition(r),this._isReverse=i,this}},{key:"growRight",value:function Selection_growRight_(e){var t=this.textMorph.document,n=t.positionToIndex(this.start),r=Math.max(n,t.positionToIndex(this.end)+e),i=this.isReverse();return this.end=t.indexToPosition(r),this._isReverse=i,this}},{key:"selectAll",value:function Selection_selectAll_(){return this.range={start:{row:0,column:0},end:this.textMorph.document.endPosition},this}},{key:"selectLine",value:function Selection_selectLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.lead.row,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.range={start:{row:e,column:0},end:{row:t?e+1:e,column:t?0:this.textMorph.getLine(e).length}},this}},{key:"gotoLineEnd",value:function Selection_gotoLineEnd_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.lead.row,t={row:e,column:this.textMorph.getLine(e).length};this.range={start:t,end:t}}},{key:"selectLeft",value:function Selection_selectLeft_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.isEmpty()?(this.growLeft(e),this.reverse()):this.isReverse()?this.growLeft(e):this.growRight(-e),this}},{key:"selectRight",value:function Selection_selectRight_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.isReverse()?this.growLeft(-e):this.growRight(e),this}},{key:"selectUp",value:function Selection_selectUp_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments[1];return this.goUp(e,t,!0)}},{key:"selectDown",value:function Selection_selectDown_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments[1];return this.selectUp(-e,t)}},{key:"goUp",value:function Selection_goUp_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(0===e)return this;var r=this._goalColumn,i=this._goalX;return this.lead=this.textMorph.getPositionAboveOrBelow(e,this.lead,t,r,i),n||(this.anchor=this.lead),this._goalColumn=r,this._goalX=i,this}},{key:"goDown",value:function Selection_goDown_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments[1];return this.goUp(-e,t)}},{key:"goLeft",value:function Selection_goLeft_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.isEmpty()&&this.growLeft(e),this.collapse(),this}},{key:"goRight",value:function Selection_goRight_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.isEmpty()&&this.growRight(e),this.collapseToEnd(),this}},{key:"cursorVisible",get:function get(){return this._cursorVisible&&this.textMorph.isFocused()&&!this.textMorph.rejectsInput()}},{key:"cursorBlinkStart",value:function Selection_cursorBlinkStart_(){var e=this;this.cursorBlinkStop();var t,n,r=config$1.text.cursorBlinkPeriod;r&&(t=e.textMorph,n=t.env.renderer.getNodeForMorph(t),e.cursorBlinkProcess=setInterval(function(){if(n||(n=t.env.renderer.getNodeForMorph(t)),n){e._cursorVisible=!e._cursorVisible;var r=n.className.split(" "),i=r.indexOf("hidden-cursor");e._cursorVisible&&i>-1&&(r.splice(i,1),n.className=r.join(" ")),e._cursorVisible||-1!==i||(n.className=[].concat(toConsumableArray(r),["hidden-cursor"]).join(" "))}},1e3*r))}},{key:"cursorBlinkStop",value:function Selection_cursorBlinkStop_(){this.cursorBlinkProcess&&clearInterval(this.cursorBlinkProcess),this.cursorBlinkProcess=null,this._cursorVisible=!0;var e=this.textMorph,t=e.env.renderer.getNodeForMorph(e);if(t){var n=t.className.split(" "),r=n.indexOf("hidden-cursor");r>-1&&(n.splice(r,1),t.className=n.join(" "))}}},{key:"toString",value:function Selection_toString_(){var e=this.anchor,t=e.row,n=e.column,r=this.lead;return"Selection("+t+"/"+n+" -> "+r.row+"/"+r.column+")"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:223,end:9050})}(void 0),MultiSelection=function(e){var t=_classRecorder,n=t.hasOwnProperty("MultiSelection")&&"function"==typeof t.MultiSelection?t.MultiSelection:t.MultiSelection=function MultiSelection(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"initialize",value:function MultiSelection_initialize_(e){this._selections=[new Selection(this.textMorph,e)]}},{key:"__deserialize__",value:function MultiSelection___deserialize___(e,t){this._selections=[]}},{key:"selections",get:function get(){return this._selections}},{key:"selections",set:function set(e){var t=this._selections?this._selections.filter(function(t){return!e.includes(t)}):[];this._selections=e,t.forEach(function(e){return e.uninstall()})}},{key:"isMultiSelection",get:function get(){return!0}},{key:"uninstall",value:function MultiSelection_uninstall_(){this.selections.forEach(function(e){return e.uninstall()})}},{key:"defaultSelection",get:function get(){return lively_lang.arr.last(this.selections)}},{key:"removeSelections",value:function MultiSelection_removeSelections_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this.selections.slice(e);t.forEach(function(e){return e.uninstall()}),this.selections=lively_lang.arr.withoutAll(this.selections,t)}},{key:"disableMultiSelect",value:function MultiSelection_disableMultiSelect_(){lively_lang.arr.without(this.selections,this.defaultSelection).forEach(function(e){return e.uninstall()}),this.selections=[this.defaultSelection]}},{key:"range",get:function get(){return this.defaultSelection.range}},{key:"range",set:function set(e){this.disableMultiSelect(),this.defaultSelection.range=e}},{key:"updateFromAnchors",value:function MultiSelection_updateFromAnchors_(){this.selections.forEach(function(e){return e.updateFromAnchors()})}},{key:"start",get:function get(){return this.defaultSelection.start}},{key:"start",set:function set(e){this.defaultSelection.start=e}},{key:"end",get:function get(){return this.defaultSelection.end}},{key:"end",set:function set(e){this.defaultSelection.end=e}},{key:"anchor",get:function get(){return this.defaultSelection.anchor}},{key:"anchor",set:function set(e){this.defaultSelection.anchor=e}},{key:"lead",get:function get(){return this.defaultSelection.lead}},{key:"lead",set:function set(e){this.defaultSelection.lead=e}},{key:"text",get:function get(){return this.selections.map(function(e){return e.text}).join("\n")}},{key:"text",set:function set(e){this.selections.forEach(function(t){return t.text=e})}},{key:"selectedRows",get:function get(){return this.defaultSelection.selectedRows}},{key:"reverse",value:function MultiSelection_reverse_(){this.defaultSelection.reverse()}},{key:"isReverse",value:function MultiSelection_isReverse_(){return this.defaultSelection.isReverse()}},{key:"isEmpty",value:function MultiSelection_isEmpty_(){return this.defaultSelection.isEmpty()}},{key:"collapse",value:function MultiSelection_collapse_(e){return this.defaultSelection.collapse(e),this}},{key:"collapseToEnd",value:function MultiSelection_collapseToEnd_(){return this.defaultSelection.collapseToEnd(),this}},{key:"growLeft",value:function MultiSelection_growLeft_(e){return this.defaultSelection.growLeft(e),this}},{key:"growRight",value:function MultiSelection_growRight_(e){return this.defaultSelection.growRight(e),this}},{key:"selectAll",value:function MultiSelection_selectAll_(){return this.disableMultiSelect(),this.defaultSelection.selectAll(),this}},{key:"selectLine",value:function MultiSelection_selectLine_(e,t){return this.defaultSelection.selectLine(e,t),this}},{key:"gotoLineEnd",value:function MultiSelection_gotoLineEnd_(e){this.defaultSelection.gotoLineEnd(e)}},{key:"selectLeft",value:function MultiSelection_selectLeft_(e){return this.defaultSelection.selectLeft(e),this}},{key:"selectRight",value:function MultiSelection_selectRight_(e){return this.defaultSelection.selectRight(e),this}},{key:"selectUp",value:function MultiSelection_selectUp_(e,t){return this.defaultSelection.selectUp(e,t),this}},{key:"selectDown",value:function MultiSelection_selectDown_(e,t){return this.defaultSelection.selectDown(e,t),this}},{key:"goUp",value:function MultiSelection_goUp_(e,t){return this.defaultSelection.goUp(e,t)}},{key:"goDown",value:function MultiSelection_goDown_(e,t){return this.defaultSelection.goDown(e,t)}},{key:"goLeft",value:function MultiSelection_goLeft_(e){return this.defaultSelection.goLeft(e)}},{key:"goRight",value:function MultiSelection_goRight_(e){return this.defaultSelection.goRight(e)}},{key:"cursorVisible",get:function get(){return this.defaultSelection.cursorVisible}},{key:"style",set:function set(e){this.defaultSelection.style=e}},{key:"getTextAttributes",value:function MultiSelection_getTextAttributes_(){return this.defaultSelection.getTextAttributes()}},{key:"toString",value:function MultiSelection_toString_(){return"MultiSelection("+this.selections.join(", ")+")"}},{key:"mergeSelections",value:function MultiSelection_mergeSelections_(){for(var e=this.selections.slice(),t=e.length-1;t>=0;t--)for(var n=e.length-1;n>=0;n--)if(t!==n&&e[n].mergeWith(e[t])){e.splice(t,1);break}this.selections=e}},{key:"ranges",get:function get(){return this.selections.map(function(e){return e.range})}},{key:"ranges",set:function set(e){for(var t=0;t<e.length;t++){var n=this.selections[t];n?n.range=e[t]:this.addRange(e[t],!1)}this.removeSelections(t),this.mergeSelections()}},{key:"addRange",value:function MultiSelection_addRange_(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.selections.push(new Selection(this.textMorph,e)),t&&this.mergeSelections(),lively_lang.arr.last(this.selections).range}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:9059,end:13620})}({referencedAs:"Selection",value:Selection});function shallowEquals(e,t){if(!e||!t)return e==t;var n=!0,r={};for(var i in e)if(r[i]=!0,!t.hasOwnProperty(i)||e[i]!==t[i]){n=!1;break}if(n)for(var o in t)if(!(r[o]||e.hasOwnProperty(o)&&e[o]===t[o])){n=!1;break}return n}function concatAttributePair(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",o="string"!=typeof e,a="string"!=typeof n;if(o||a){var s=[];return o?s.push(e,t):s.push(e+i,t),a?s.push(n,r):s.push(n+i,r),s}return t||r?t==r?[e+i+n,t]:t&&r&&shallowEquals(t,r)?[e+i+n,t]:[e+i,t,n,r]:[e+i+n,t]}function joinTextAttributes(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e.length<=2)return e;for(var n=[],r=slicedToArray(e,2),i=r[0],o=r[1],a=2;a<e.length;a+=2){var s=concatAttributePair(i,o,e[a],e[a+1],t);if(s.length<=2)i=s[0],o=s[1];else{n.push.apply(n,toConsumableArray(s.slice(0,-2)));var l=s.slice(-2),c=slicedToArray(l,2);i=c[0],o=c[1]}}return n.push(i,o),n}function splitTextAndAttributesAt(e,t){for(var n=0,r=0;r<e.length;r+=2){var i=e[r],o=n+("string"==typeof i?i.length:1);if(!(o<t)){if(n===t)return[e.slice(0,r),e.slice(r)];if(o===t)return[e.slice(0,r+2),e.slice(r+2)];if("string"!=typeof i)throw new Error("Assuming text is a string for splitting it, got "+i+" instead!");var a=e[r+1],s=t-n;return[[].concat(toConsumableArray(e.slice(0,r)),[i.slice(0,s),a]),i.length===s?e.slice(r+2):[i.slice(t-n),a].concat(toConsumableArray(e.slice(r+2)))]}n=o}return[e,[]]}function splitTextAndAttributesAtColumns(e,t){for(var n=e,r=0,i=[],o=0;o<t.length;o++){var a=splitTextAndAttributesAt(n,t[o]-r),s=slicedToArray(a,2),l=s[0],c=s[1];i.push(l);for(var u=0;u<l.length;u+=2)r+="string"==typeof l[u]?l[u].length:1;n=c}return i.push(n),i}function concatTextAndAttributes(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e.length||2===e.length&&""==e[0])return n?t:t.slice();if(!t.length||2===t.length&&""==t[0])return n?e:e.slice();for(var r=n?e:e.slice(),i=0;i<t.length;i+=2){var o=t[i],a=t[i+1];r.push(o,a)}return r}function modifyAttributesInRange(e,t,n){var r=t.start,i=t.end;if(eqPosition(r,i))return null;if(lessPosition(i,r)){var o=[i,r];r=o[0],i=o[1]}var a=r,s=a.row,l=a.column,c=i,u=c.row,h=c.column,d=e.getLine(s),p=function(){var e=d.textAndAttributes,t=0,r=splitTextAndAttributesAt(e,l),i=slicedToArray(r,2),o=i[0],a=i[1],c=void 0;if(e.length=0,textAndAttributesDo(o,function(n,r){t+="string"==typeof n?n.length:1,e.push(n,r)}),s===u){var p=splitTextAndAttributesAt(a,h-t),f=slicedToArray(p,2);a=f[0],c=f[1]}if(textAndAttributesDo(a,function(t,r){return e.push(t,n(d,r))}),s===u&&textAndAttributesDo(c,function(t,n){return e.push(t,n)}),d._textAttributes=null,d.textAndAttributes=joinTextAttributes(e),s===u)return{v:void 0}}();if("object"===(void 0===p?"undefined":_typeof(p)))return p.v;for(var f,g,m,v,y,_=function _loop(e){var t=(d=d.nextLine()).textAndAttributes,r=t.slice();t.length=0,textAndAttributesDo(r,function(e,r){return t.push(e,n(d,r))}),d._textAttributes=null,d.textAndAttributes=joinTextAttributes(t)},b=s+1;b<u;b++)_();f=(d=d.nextLine()).textAndAttributes,g=splitTextAndAttributesAt(f,h),m=slicedToArray(g,2),v=m[0],y=m[1],f.length=0,textAndAttributesDo(v,function(e,t){return f.push(e,n(d,t))}),textAndAttributesDo(y,function(e,t){return f.push(e,t)}),d._textAttributes=null,d.textAndAttributes=joinTextAttributes(f)}function textAndAttributesWithSubRanges(e,t){var n=e.column,r=e.row,i=[],o=[],a=!0,s=!1,l=void 0;try{for(var c,u=splitTextAndAttributesIntoLines(t)[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){for(var h=c.value,d=0;d<h.length;d+=2){var p=h[d],f=n+("string"==typeof p?p.length:1);i.push({start:{row:r,column:n},end:{row:r,column:f}}),o.push(h[d],h[d+1]),n=f}n=0,r++}}catch(e){s=!0,l=e}finally{try{!a&&u.return&&u.return()}finally{if(s)throw l}}return{ranges:i,textAndAttributes:o}}function textAndAttributesDo(e,t){for(var n=0;n<e.length;n+=2)t(e[n],e[n+1])}function splitTextAndAttributesIntoLines(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"\n";if(!e.length)return[];for(var n=[],r=[],i=0;i<e.length;i+=2){var o=e[i],a=e[i+1];if("string"==typeof o)for(;o.length;){var s=o.indexOf(t);if(-1===s){r.push(o,a);break}s>0&&r.push(o.slice(0,s),a),n.push(r),o=o.slice(s+1),r=[]}else r.push(o,a)}if(r.length)n.push(r);else{var l=e.slice(-2),c=slicedToArray(l,2),u=c[0],h=c[1];"string"==typeof u&&u.endsWith(t)&&n.push(["",h])}return n}var objectReplacementChar="",defaultOptions={maxLeafSize:3,minLeafSize:2,leafSplit:.5,maxNodeSize:10,minNodeSize:5,nodeSplit:.5},TreeNode=function(e){var t=_classRecorder,n=t.hasOwnProperty("TreeNode")&&"function"==typeof t.TreeNode?t.TreeNode:t.TreeNode=function TreeNode(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TreeNode_initialize_(e){this.parent=e}},{key:"root",get:function get(){return this.parent?this.parent.root:this}},{key:"isRoot",get:function get(){return!this.parent}},{key:"withParents",value:function TreeNode_withParents_(){for(var e=this,t=[];e;)t.push(e),e=e.parent;return t}},{key:"traverse",value:function TreeNode_traverse_(e){var t=[e.call(null,this)];if(this.isLeaf)return t;for(var n=0;n<this.children.length;n++)t.push.apply(t,toConsumableArray(this.children[n].traverse(e)));return t}},{key:"consistencyCheck",value:function TreeNode_consistencyCheck_(){var e=[],t=this.isRoot,n=this.isLeaf,r=this.children,i=this.size,o=this.stringSize,a=this.height,s=this.width,l=this.options,c=l.maxLeafSize,u=l.maxNodeSize,h=l.minLeafSize,d=l.minNodeSize;if(t||0!==i||e.push({error:"size of "+this+" expected to be > 0!"}),!Array.isArray(r))return e.push({error:this+".children is not an array but "+r}),e;var p=lively_lang.arr.sum(lively_lang.arr.pluck(r,"size"));p!=i&&e.push({error:"Sum of child sizes is not size of "+this+": "+p+" != "+i});var f=lively_lang.arr.sum(lively_lang.arr.pluck(r,"stringSize"));f!=o&&e.push({error:"Sum of child stringSize is not stringSIze of "+this+": "+f+" != "+o});var g=lively_lang.arr.sum(lively_lang.arr.pluck(r,"height"));Number.parseInt(g)!=Number.parseInt(a)&&e.push({error:"Sum of child Height is not Height of "+this+": "+g+" != "+a});var m=r.length?Math.max.apply(null,lively_lang.arr.pluck(r,"width")):0;Number.parseInt(m)!=Number.parseInt(s)&&e.push({error:"max width of children of "+this+" is not node width: "+m+" != "+s});var v=n?c:u,y=n?h:d;!t&&r.length>v&&e.push({error:"children count of "+this+" expected to be between "+y+" and "+v+" but is "+r.length});for(var _=0;_<r.length;_++){var b=r[_];b?(n&&!b.isLine?e.push({error:"child "+_+" of leaf "+this+" is not a line!"}):!n&&b.isLine&&e.push({error:"child of non-leaf "+this+" is a line!"}),this!==b.parent&&e.push({error:"child.parent is "+b.parent+" but should be "+this})):e.push({error:"child "+_+" of "+this+" is nullish!"})}return e.push.apply(e,toConsumableArray(lively_lang.arr.flatmap(r,function(e){return e.consistencyCheck()}))),e}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1416,end:4438})}(void 0),InnerTreeNode=function(e){var t=_classRecorder,n=t.hasOwnProperty("InnerTreeNode")&&"function"==typeof t.InnerTreeNode?t.InnerTreeNode:t.InnerTreeNode=function InnerTreeNode(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function InnerTreeNode_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e.parent),this.options=e.options,this.children=e.children,this.size=e.size,this.stringSize=e.stringSize,this.height=e.height,this.width=e.width,this.isLeaf=!0}},{key:"isNode",get:function get(){return!0}},{key:"resize",value:function InnerTreeNode_resize_(e,t,n){this.size=this.size+e,this.height=this.height+t,this.stringSize=this.stringSize+n;for(var r=0,i=0;i<this.children.length;i++){var o=this.children[i].width;o>r&&(r=o)}this.width=r,this.parent&&this.parent.resize(e,t,n)}},{key:"lines",value:function InnerTreeNode_lines_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(this.isLeaf)return e.push.apply(e,toConsumableArray(this.children)),e;for(var t=0;t<this.children.length;t++)this.children[t].lines(e);return e}},{key:"findRow",value:function InnerTreeNode_findRow_(e){if(e<0||e>=this.size)return null;if(this.isLeaf)return this.children[e];for(var t=0;t<this.children.length;t++){var n=this.children[t],r=n.size;if(e<r)return n.findRow(e);e-=r}return null}},{key:"findLineByVerticalOffset",value:function InnerTreeNode_findLineByVerticalOffset_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(e<0||e>this.height)return null;for(var r=0;r<this.children.length;r++){var i=this.children[r],o=i.height;if(e<=o)return this.isLeaf?{line:i,offset:e,y:t,row:n}:i.findLineByVerticalOffset(e,t,n);e-=o,t+=o,n+=i.size}return null}},{key:"computeVerticalOffsetOf",value:function InnerTreeNode_computeVerticalOffsetOf_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e<0||e>=this.size)return console.warn("strange row in computeVerticalOffsetOf: "+e),t;if(this.isLeaf){for(var n=0;n<Math.min(e,this.children.length);n++)t+=this.children[n].height;return t}for(var r=0;r<this.children.length;r++){var i=this.children[r],o=i.size;if(e<o)return i.computeVerticalOffsetOf(e,t);e-=o,t+=i.height}return t}},{key:"ensureLine",value:function InnerTreeNode_ensureLine_(e){e||(e="");var t="string"==typeof e;if(!t&&e.isLine)return e.parent=this,e;var n=t?[e,null]:e.textAndAttributes||[e.text||"",null],r=t?0:e.width||0,i=t?0:e.height||0;return new Line({parent:this,width:r,height:i,textAndAttributes:n})}},{key:"insert",value:function InnerTreeNode_insert_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.size,n=this.children,r=this.options;if(this.isLeaf){for(var i=[],o=0,a=0,s=0;s<e.length;s++){var l=this.ensureLine(e[s]);i.push(l),o+=l.height,a+=l.stringSize,n.splice(t++,0,l)}return this.resize(i.length,o,a),this.balanceAfterGrowth(),i}0===n.length&&n.push(new InnerTreeNode({parent:this,children:[],size:0,stringSize:0,width:0,height:0,options:r}));for(s=0;s<n.length;s++){var c=n[s],u=c.size;if(t<=u)return c.insert(e,t);t-=u}var h=n[s-1];return h.insert(e,h.size)}},{key:"withParentChainsUpToCommonParentDo",value:function InnerTreeNode_withParentChainsUpToCommonParentDo_(e,t,n){for(var r=this.withParents(),i=e,o=void 0,a=0;i;){if(r.includes(i)){o=i;break}t(i,a++),i=i.parent}var s=r.indexOf(o);s<0&&(s=r.length);for(var l=r.slice(0,s),c=0;c<l.length;c++)n(l[c],c)}},{key:"findLineWithTextIndex",value:function InnerTreeNode_findLineWithTextIndex_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.isLeaf){for(var n=0;n<this.children.length;n++){var r=this.children[n],i=r.stringSize;if(e<i)return{line:r,column:e,row:t};e-=i,t++}var o=lively_lang.arr.last(this.children);return{line:o,row:t-1,column:o.stringSize-1}}for(var a=0,s=0;s<this.children.length;s++){var l=this.children[s],c=l.stringSize;if(e<a+c)return l.findLineWithTextIndex(e-a,t);t+=l.size,a+=c}return lively_lang.arr.last(this.children).findLineWithTextIndex(e-a)}},{key:"findLeafs",value:function InnerTreeNode_findLeafs_(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(e>n+this.size||t<n)return[];if(this.isLeaf){var r=Math.max(0,e-n),i=this.children.length-1,o=Math.min(i,t-n),a=!1;return 0===r&&o===i&&(a=!0,o=i),[{node:this,firstLine:r,lastLine:o,full:a}]}for(var s=[],l=0;l<this.children.length;l++){var c=this.children[l];s.push.apply(s,toConsumableArray(c.findLeafs(e,t,n))),n+=c.size}return s}},{key:"removeFromToInRoot",value:function InnerTreeNode_removeFromToInRoot_(e,t,n){var r=this;if(!this.isRoot)throw new Error("removeFromTo() should be called on the root node");if(e>t){var i=[t,e];e=i[0],t=i[1]}var o=this.size,a=this.options,s=(a.maxLeafSize,a.minLeafSize),l=this.findLeafs(e,t),c=l.shift(),u=l.pop(),h=l,d=[],p=void 0,f=void 0,g=!1,m=!1;if(!(e>=o)){if(u&&c.node===u.node&&(u=null),c.full)n&&n.log("Removing complete first line "+c),h.push(c);else{var v=c.lastLine-c.firstLine+1;g=c.node.children.length-v<s}if(u)if(u.full)n&&n.log("Removing complete last line "+u),h.push(u);else{var y=u,_=y.lastLine-y.firstLine+1;m=y.node.children.length-_<s}if(g||m){var b=c.node.children[0].prevLine();p=b?b.parent:null;var x=lively_lang.arr.last(u?u.node.children:c.node.children).nextLine();f=x?x.parent:null}for(var w=0;w<h.length;w++){for(var k=h[w].node,S=k.children.length,C=0,M=0,T=0;T<S;T++){var P=k.children[T];C+=P.height,M+=P.stringSize,P.parent=null}k.children.length=0,k.resize(-S,-C,-M);var A=k.parent;A&&(k.parent=null,A.children.splice(A.children.indexOf(k),1),d.includes(A)||d.push(A))}if(!c.full){for(var L=c.lastLine,R=c.firstLine,E=c.node,O=E.children,z=(E.options,L-R+1),D=O.splice(R,z),I=0,F=0,j=0;j<D.length;j++){var B=D[j];I+=B.height,F+=B.stringSize,B.parent=null}E.resize(-z,-I,-F)}if(u&&!u.full){for(var N=u,W=N.lastLine,H=N.firstLine,V=N.node,G=W-H+1,q=V.children.splice(H,G),U=0,$=0,K=0;K<q.length;K++){var J=q[K];U+=J.height,$+=J.stringSize,J.parent=null}V.resize(-G,-U,-$)}if(n&&n.dump(""+this.print(!1)),g&&c.node.balanceByMergeOrTheft(p,!u||u.full?f:u.node,n),u&&m&&u.node.root===this){var X=!0,Y=c.full||!c.node.parent?p:c.node;g&&(u.node.root!==this&&(X=!1),Y&&Y.root!==this&&(Y=null),f&&f.root!==this&&(f=null)),X&&u.node.balanceByMergeOrTheft(Y,f,n)}d.forEach(function(e){return e.root===r&&e.balanceAfterShrink(n)})}}},{key:"balanceByMergeOrTheft",value:function InnerTreeNode_balanceByMergeOrTheft_(e,t,n){var r=this,i=this.children,o=this.options,a=this.isLeaf,s=a?o.maxLeafSize:o.maxNodeSize,l=a?o.minLeafSize:o.minNodeSize,c=(i.length,e&&e.children.length+i.length<=s),u=!c&&t&&t.children.length+i.length<=s,h=c?e:u?t:null;if(h){var d,p;n&&n.log("[balanceByMergeOrTheft] merging "+this+" "+(c?"left":"right")+" into "+h);var f=this.size,g=this.width,m=this.height,v=this.stringSize;i.forEach(function(e){return e.parent=h}),c?(d=h.children).push.apply(d,toConsumableArray(i)):(p=h.children).unshift.apply(p,toConsumableArray(i)),i.length=0,this.width=0,this.withParentChainsUpToCommonParentDo(h,function(e){g>e.width&&(e.width=g),e.height=e.height+m,e.size=e.size+f,e.stringSize=e.stringSize+v},function(e){if(g===e.width)for(var t=0;t<e.children.length;t++){var n=e.children[t];n.width>e.width&&(e.width=n.width)}e.height=e.height-m,e.size=e.size-f,e.stringSize=e.stringSize-v})}else{var y=e?Math.ceil((e.children.length-l)/2):0,_=t?Math.ceil((t.children.length-l)/2):0,b=y>0&&y>=_;if(b||!b&&_>0){var x,w,k=b?e.children.splice(e.children.length-y,y):t.children.splice(0,_),S=b?e:t,C=b?y:_,M=0,T=0,P=0,A=0;n&&n.log("[balanceByMergeOrTheft] "+this+" steals from "+(b?"left":"right")+" node "+S+" "+C+" nodes");for(var L=0;L<k.length;L++)M+=k[L].height,T+=k[L].stringSize,P=Math.max(P,k[L].width);for(var R=0;R<S.children.length;R++)A=Math.max(A,S.children[R].width);this.withParentChainsUpToCommonParentDo(S,function(e){if(A<P&&A<e.width){if(e===S)e.width=A;else{for(var t=!1,n=0;n<e.children.length;n++){if(e.children[n].width>A){t=!0;break}}t||(e.width=A)}e.width=P}e.height=e.height-M,e.size=e.size-C,e.stringSize=e.stringSize-T},function(e){e.width<P&&(e.width=P),e.height=e.height+M,e.size=e.size+C,e.stringSize=e.stringSize+T}),k.forEach(function(e){return e.parent=r}),b?(x=this.children).unshift.apply(x,toConsumableArray(k)):(w=this.children).push.apply(w,toConsumableArray(k))}}var E=this.parent;0===i.length&&(this.parent=null,E&&E.children.splice(E.children.indexOf(this),1)),E&&E.balanceAfterShrink(n)}},{key:"balanceAfterGrowth",value:function InnerTreeNode_balanceAfterGrowth_(){var e=this.isLeaf,t=this.size,n=this.stringSize,r=this.parent,i=this.children,o=this.width,a=this.height,s=this.options,l=e?s.maxLeafSize:s.maxNodeSize;if(i.length>l){r||((r=this.parent=new InnerTreeNode({parent:null,children:[this],size:t,width:o,height:a,stringSize:n,options:s})).isLeaf=!1);for(var c=Math.floor(i.length/2),u=0,h=0,d=0,p=0,f=0,g=0,m=0,v=0,y=0;u<c;u++)h+=i[u].size,p=Math.max(p,i[u].width),g+=i[u].height,v+=i[u].stringSize;for(;u<i.length;u++)d+=i[u].size,f=Math.max(f,i[u].width),m+=i[u].height,y+=i[u].stringSize;this.children=i.slice(0,c),this.size=h,this.width=p,this.height=g,this.stringSize=v;var _=r.children.indexOf(this),b=i.slice(c),x=new InnerTreeNode({parent:r,children:b,size:d,height:m,width:f,stringSize:y,options:s});x.isLeaf=e,b.forEach(function(e){return e.parent=x}),r.children.splice(_+1,0,x),x.children.length>l&&x.balanceAfterGrowth(),this.children.length>l&&this.balanceAfterGrowth(),this.parent.balanceAfterGrowth()}}},{key:"balanceAfterShrink",value:function InnerTreeNode_balanceAfterShrink_(e){for(var t=this,n=this.isLeaf,r=this.parent,i=this.children,o=this.options,a=o.maxLeafSize,s=o.maxNodeSize,l=o.minLeafSize,c=o.minNodeSize,u=n?a:s,h=n?l:c,d=!1,p=i.length;p--;)0===i[p].size&&(i.splice(p,1),d=!0,e&&e.log("[balanceAfterShrink] "+this+" removes node "+p+" b/c it is empty, remaining children: "+i.length+" (min: "+h+", max: "+u+")"));if(d&&e&&e.dump(""+this.root.print(!1)),i.length>=h)r&&r.balanceAfterShrink(e);else if(0!==i.length)if(n){if(r)if(1===r.children.length){var f;e&&e.log("[balanceAfterShrink] "+this+" is the only child - will remove it's parent and take its position"),e&&e.dump(""+this.root.print(!1)),this.parent=null,r.children.length=0,(f=r.children).push.apply(f,toConsumableArray(i)),i.forEach(function(e){return e.parent=r}),r.isLeaf=!0}else{var g=i[0].prevLine(),m=g&&g.parent,v=lively_lang.arr.last(i).nextLine(),y=v&&v.parent;this.balanceByMergeOrTheft(m,y,e)}this.parent&&this.parent.balanceAfterShrink(e)}else{for(var _=[],b=!1,x=!1,w=!1,k=0;k<i.length;k++){var S=i[k];if(!b&&S.isLeaf&&(b=!0),x||S.isLeaf||(x=!0),b&&x){w=!0;break}_.push.apply(_,toConsumableArray(S.children))}var C=b;!w&&_.length<=(C?a:s)&&(e&&e.log("[balanceAfterShrink] "+this+" grandChildren.length is "+_.length+" and <= max size so it is removing all its children and adopting their children"),i.forEach(function(e){return e.parent=null}),_.forEach(function(e){return e.parent=t}),i.length=0,i.push.apply(i,_),this.isLeaf=C,e&&e.log("[balanceAfterShrink] "+i.join("\n")),e&&e.dump(""+this.root.print(!1))),r&&r.balanceAfterShrink(e)}else r&&r.balanceAfterShrink(e)}},{key:"print",value:function InnerTreeNode_print_(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments[3],i=this.isLeaf,o=this.size,a=this.stringSize,s=this.width,l=this.height,c=this.children,u=r||(i?"leaf":"node"),h=""+" ".repeat(n)+u+" (size: "+o+" width: "+Math.round(s)+" height: "+Math.round(l)+" text length: "+a+")";if(c.length){for(var d="",p=t+o,f=c.length;f--;){var g=c[f];p-=g.size,d="\n"+g.print(e,p,n+1)+d}h+=d}return h}},{key:"toString",value:function InnerTreeNode_toString_(){var e=this.isLeaf,t=this.size,n=this.width,r=this.height,i=this.children;return"node ("+(e?"leaf, ":"")+(e&&i.length?"rows: "+i[0].row+"-"+lively_lang.arr.last(i).row+" ":"")+"size: "+t+" "+n+"x"+r+")"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:4441,end:28527})}({referencedAs:"TreeNode",value:TreeNode}),Line=function(e){var t=_classRecorder,n=t.hasOwnProperty("Line")&&"function"==typeof t.Line?t.Line:t.Line=function Line(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Line_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e.parent),this.textAndAttributes=joinTextAttributes(e.textAndAttributes||[]),this._text="",this._textAttributes=null,this.width=e.width,this.height=e.height,this.hasEstimatedExtent=!1,this.modeState=null,this.textAlign="left",this.lineHeight=null,this.marginTop=0,this.marginBottom=0}},{key:"isLine",get:function get(){return!0}},{key:"size",get:function get(){return 1}},{key:"stringSize",get:function get(){return this.text.length+1}},{key:"text",get:function get(){if(this._text)return this._text;for(var e="",t=this.textAndAttributes,n=0;n<t.length;n+=2)e+="string"==typeof t[n]?t[n]:objectReplacementChar;return this._text=e}},{key:"textAttributes",get:function get(){if(this._textAttributes)return this._textAttributes;for(var e=[],t=this.textAndAttributes,n=0;n<t.length;n+=2){var r=t[n+1];r&&!e.includes(r)&&e.push(r)}return this._textAttributes=e}},{key:"row",get:function get(){if(!this.parent)return 0;var e=this.withParents();if(1===e.length)return e.children.indexOf(this);for(var t=0,n=e.length-1;n>=1;n--)for(var r=e[n],i=e[n-1],o=r.children.indexOf(i),a=0;a<o;a++)t+=r.children[a].size;return t}},{key:"nextLine",value:function Line_nextLine_(){var e=this.parent;if(!e)return null;var t=e.children[e.children.indexOf(this)+1];if(t)return t;var n=this.root,r=this.row;return n.findRow(r+1)}},{key:"prevLine",value:function Line_prevLine_(){var e=this.parent;if(!e)return null;var t=e.children[e.children.indexOf(this)-1];if(t)return t;var n=this.root,r=this.row;return n.findRow(r-1)}},{key:"changeExtent",value:function Line_changeExtent_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.height,i=this.width,o=this.parent;if(this.width=e,this.height=t,this.hasEstimatedExtent=n,i!==e||r!==t)for(var a=t-r;o;){if(o.height=o.height+a,e>=o.width)o.width=e;else if(i===o.width){for(var s=0,l=0;l<o.children.length;l++){var c=o.children[l].width;c>s&&(s=c)}o.width=s}o=o.parent}return this}},{key:"changeText",value:function Line_changeText_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.parent,r=this.text,i=this.height,o=e.length+1-(r.length+1),a=0;if(this.modeState&&this.modeState._string!==e&&(this.modeState=null),this.height||this.width?this.hasEstimatedExtent=!0:(this.height=0,this.width=0,this.hasEstimatedExtent=!1,a=-i),this._text=e,this._textAttributes=null,this.textAndAttributes=t||(t=[e,null]),t.length%2!=0)throw new Error("textAndAttributes list is strange, expected flat pairs of text/attr");for(var s=0;s<t.length;s+=2){t[s];var l=t[s+1];if(l&&Array.isArray(l))throw new Error("invalid attr part of text/attr pair, its an array: "+l)}for(;n;){n.stringSize=n.stringSize+o,n.height=n.height+a;for(var c=0,u=0;u<n.children.length;u++){var h=n.children[u].width;h>c&&(c=h)}n.width=c,n=n.parent}return this}},{key:"changeTextAndAttributes",value:function Line_changeTextAndAttributes_(e){e=joinTextAttributes(e);for(var t="",n=0;n<e.length;n+=2)t+="string"==typeof e[n]?e[n]:objectReplacementChar;return this.changeText(t,e)}},{key:"print",value:function Line_print_(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=" ".repeat(n),i=this.width,o=this.height,a=this.stringSize,s=this.textAndAttributes,l=r+"line "+t+" (size: 1 width: "+Math.round(i)+" height: "+Math.round(o)+" text length: "+a,c=lively_lang.arr.toTuples(s,2).map(function printTextAttrTuple(e){var t=slicedToArray(e,2),n=t[0],r=t[1];return("string"==typeof n?'"'+n+'"':String(n))+","+JSON.stringify(r)}).join(",");return l+(e?")":" content: ["+c+"])")}},{key:"toString",value:function Line_toString_(){var e=this.width,t=this.height,n=this._text;return'line ("'+lively_lang.string.truncate(n,30)+'", '+e+"x"+t+")"}},{key:"consistencyCheck",value:function Line_consistencyCheck_(){var e=[];if(!this.parent)return e.push("line "+this+" has no parent!"),e}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:28537,end:34881})}({referencedAs:"TreeNode",value:TreeNode}),documentFuzzier={makeString:function makeString(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,n=lively_lang.arr.range(65,90).map(function(e){return String.fromCharCode(e)}).join("");n+=n.toLowerCase()+" \n";var r=lively_lang.num.random(e,t);return lively_lang.arr.shuffle(Array.from(n.repeat(Math.ceil(r/n.length)))).slice(0,r).join("")},randomDocPosition:function randomDocPosition(e){var t=0===e.rowCount?0:lively_lang.num.random(0,e.rowCount-1);return{row:t,column:lively_lang.num.random(0,e.getLineString(t).length-1)}},insertRandom:function insertRandom(e,t,n,r){var i=[this.makeString(n,r),null],o=this.randomDocPosition(e);t.push(["insertTextAndAttributes",i,o]),e.insertTextAndAttributes(i,o)},deleteRandom:function deleteRandom(e,t,n,r){var i={start:this.randomDocPosition(e),end:this.randomDocPosition(e)};t.push(["remove",i]),e.remove(i)},maybe:function maybe(){return Math.random()<.5},replay:function replay(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];n&&(e.debug=n,(n=e.debugHelper()).reset());var i=new Document([""]);t.forEach(function(e,o){var a=toArray(e),s=a[0],l=a.slice(1);r&&t.length,i[s].apply(i,toConsumableArray(l).concat([n]))}),e.changeDocument(i)},run:function run(){var e=Date.now(),t=0,n=new Document([],{maxLeafSize:3,minLeafSize:2,leafSplit:.5,maxNodeSize:10,minNodeSize:5,nodeSplit:.5}),r=[],i=void 0;try{for(;n.stringSize<1e4&&t++<1e4;)this.maybe()?this.deleteRandom(n,r):this.insertRandom(n,r),n.consistencyCheck()}catch(e){i=e}return{error:i,doc:n,actions:r,time:Date.now()-e}}},newline="\n",Document=function(e){var t=_classRecorder,n=t.hasOwnProperty("Document")&&"function"==typeof t.Document?t.Document:t.Document=function Document(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Document_initialize_(e,t){this.options=Object.assign({},defaultOptions,{},t),this.lines=e}},{key:"balance",value:function Document_balance_(){this.root.balanceAfterGrowth(),this.fixRoot()}},{key:"fixRoot",value:function Document_fixRoot_(){var e=this.root.root;this.root!==e&&(this.root=e)}},{key:"height",get:function get(){return this.root.height}},{key:"width",get:function get(){return this.root.width}},{key:"rowCount",get:function get(){return this.root.size}},{key:"stringSize",get:function get(){return 0===this.rowCount?0:this.root.stringSize-1}},{key:"lineStrings",get:function get(){return this.lines.map(function(e){return e.text})}},{key:"lines",get:function get(){return this.root.lines()}},{key:"lines",set:function set(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.root=new InnerTreeNode({parent:null,children:[],size:0,width:0,height:0,stringSize:0,options:this.options}),this.insertLines(e)}},{key:"clipRow",value:function Document_clipRow_(e){return Math.max(0,Math.min(e,this.rowCount-1))}},{key:"clipPositionToLines",value:function Document_clipPositionToLines_(e){var t=e.row,n=e.column,r=this.rowCount;if(0===r)return{row:0,column:0};if(t<0?t=0:t>=r&&(t=r-1,n=1/0),n<0)n=0;else{var i=this.getLineString(t).length;n>i&&(n=i)}return{row:t,column:n}}},{key:"findLineByVerticalOffset",value:function Document_findLineByVerticalOffset_(e){return this.root.findLineByVerticalOffset(e)}},{key:"computeVerticalOffsetOf",value:function Document_computeVerticalOffsetOf_(e){return this.root.computeVerticalOffsetOf(e)}},{key:"getLine",value:function Document_getLine_(e){return this.root.findRow(this.clipRow(e))}},{key:"getLineString",value:function Document_getLineString_(e){var t=this.getLine(e);return t?t.text:""}},{key:"insertLine",value:function Document_insertLine_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.root.rowCount;return this.insertLines([e],t)[0]}},{key:"removeLine",value:function Document_removeLine_(e){this.root.removeFromToInRoot(e,e)}},{key:"removeLines",value:function Document_removeLines_(e,t,n){this.root.removeFromToInRoot(e,t,n)}},{key:"insertLines",value:function Document_insertLines_(e,t){var n=this.root.insert(e,t);return this.fixRoot(),n}},{key:"textString",get:function get(){var e="",t=this.lines;if(!t.length)return e;for(var n=0;n<t.length-1;n++)e=e+t[n].text+newline;return e+=t[n].text}},{key:"textString",set:function set(e){this.lines=e.split(newline)}},{key:"endPosition",get:function get(){var e=this.rowCount;if(0===e)return{row:0,column:0};var t=e-1;return{row:t,column:this.getLine(t).stringSize-1}}},{key:"textAndAttributes",get:function get(){var e=this.lines;if(!e.length)return r;for(var t=newline,n=e.length-1,r=e[0].textAndAttributes.slice(),i=1;i<=n;i++){var o=e[i],a=r.pop()||null,s=r.pop()||"",l=o.textAndAttributes,c=l[0]||"",u=l[1]||null;r.push.apply(r,toConsumableArray(concatAttributePair(s,a,c,u,t)));for(var h=2;h<l.length;h+=2)r.push(l[h],l[h+1])}return r}},{key:"textAndAttributes",set:function set(e){this.lines=splitTextAndAttributesIntoLines(e,newline).map(function(e){return new Line({parent:null,width:0,height:0,textAndAttributes:e})})}},{key:"getTextAndAttributesOfLine",value:function Document_getTextAndAttributesOfLine_(e){return this.getLine(e).textAndAttributes}},{key:"setTextAndAttributesOfLine",value:function Document_setTextAndAttributesOfLine_(e,t){return this.getLine(e).changeTextAndAttributes(t),t}},{key:"mixinTextAttribute",value:function Document_mixinTextAttribute_(e,t){modifyAttributesInRange(this,t,function(t,n){return t._textAttributes=null,Object.assign({},n,e)})}},{key:"setTextAttribute",value:function Document_setTextAttribute_(e,t){modifyAttributesInRange(this,t,function(t,n){return t._textAttributes=null,e})}},{key:"mixoutTextAttribute",value:function Document_mixoutTextAttribute_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{start:{row:0,column:0},end:this.endPosition};if(e){var n=Object.keys(e);modifyAttributesInRange(this,t,function(e,t){if(!t)return t;e._textAttributes=null;var r=0,i={};for(var o in t)n.includes(o)||(i[o]=t[o],r++);return 0===r?null:i})}}},{key:"setTextAttributesWithSortedRanges",value:function Document_setTextAttributesWithSortedRanges_(e){if(!(e.length<2)){var t=e[0].start,n=e.slice(-2)[0].end,r=this.getLine(t.row);if(t.row!==n.row){var i=t.row,o=t.column,a=0,s=textAndAttributesFromRangedAttributesForRow(i,r.text,e,a),l=s.attributes,c=s.index,u=splitTextAndAttributesAt(r.textAndAttributes,o),h=slicedToArray(u,2),d=h[0],p=(h[1],splitTextAndAttributesAt(l,o)),f=slicedToArray(p,2),g=(f[0],f[1]);for(r.changeTextAndAttributes([].concat(toConsumableArray(d),toConsumableArray(g))),a=c;(r=r.nextLine())&&++i!==n.row;){var m=textAndAttributesFromRangedAttributesForRow(i,r.text,e,a),v=m.attributes;a=m.index,r.changeTextAndAttributes(v)}if(r){var y=n.column,_=textAndAttributesFromRangedAttributesForRow(i,r.text,e,a).attributes,b=splitTextAndAttributesAt(r.textAndAttributes,y),x=slicedToArray(b,2),w=(x[0],x[1]),k=splitTextAndAttributesAt(_,y),S=slicedToArray(k,1)[0];r.changeTextAndAttributes([].concat(toConsumableArray(S),toConsumableArray(w)))}}else{if(t.column>=n.column)return;var C=textAndAttributesFromRangedAttributesForRow(t.row,r.text,e,0).attributes,M=splitTextAndAttributesAtColumns(r.textAndAttributes,[t.column,n.column]),T=slicedToArray(M,3),P=T[0],A=(T[1],T[2]),L=splitTextAndAttributesAtColumns(C,[t.column,n.column]),R=slicedToArray(L,3),E=(R[0],R[1]);R[2];r.changeTextAndAttributes([].concat(toConsumableArray(P),toConsumableArray(E),toConsumableArray(A)))}}function textAndAttributesFromRangedAttributesForRow(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=0,o=t.length;if(n.length-r<=0)return{attributes:[t,null],index:r};for(var a=[],s=r;s<n.length&&!(i>=o);s+=2){var l=n[s],c=l.start,u=l.end,h=n[s+1];if(u.row<e)i=0;else{if(c.row===e&&i<c.column&&(a.push(t.slice(i,c.column),null),i=c.column),u.row>e){a.push(h.embeddedMorph||t.slice(i,o),h),i=o;break}i<u.column&&a.push(h.embeddedMorph||t.slice(i,u.column),h),i=u.column}}return i<o&&a.push(t.slice(i,o),null),{attributes:a,index:s}}}},{key:"resetTextAttributes",value:function Document_resetTextAttributes_(){this.lines.forEach(function(e){return e.changeText(e.text)})}},{key:"textAttributeAt",value:function Document_textAttributeAt_(e){var t=e.row,n=e.column;n=Math.max(0,n);var r=this.getLine(t);if(!r)return null;for(var i=0,o=r.textAndAttributes,a=0;a<o.length;a+=2){var s=o[a],l=o[a+1];if(n<(i+="string"==typeof s?s.length:1))return l}return o[o.length-1]}},{key:"textAndAttributesInRange",value:function Document_textAndAttributesInRange_(e){var t=e.start,n=e.end;if(eqPosition(t,n))return["",null];if(lessPosition(n,t)){var r=[n,t];t=r[0],n=r[1]}t=maxPosition(t,{column:0,row:0}),n=minPosition(n,this.endPosition);var i=this.getLine(t.row),o=i;if(n.row===t.row){var a=t.column,s=n.column;a===s&&s++;var l=splitTextAndAttributesAtColumns(o.textAndAttributes,[a,s]),c=slicedToArray(l,2);c[0];return c[1]}for(var u=[i],h=0;h<n.row-t.row;h++)u.push(i=i.nextLine());var d=u[u.length-1],p=splitTextAndAttributesAt(o.textAndAttributes,t.column),f=slicedToArray(p,2),g=(f[0],f[1]),m=splitTextAndAttributesAt(d.textAndAttributes,n.column),v=slicedToArray(m,1)[0];if(0===g.length&&(g=["",null]),1===u.length)return concatTextAndAttributes(g,v,!0);for(var y=g,_=1;_<u.length-1;_++)"string"==typeof y[y.length-2]&&(y[y.length-2]=y[y.length-2]+newline),concatTextAndAttributes(y,u[_].textAndAttributes,!0);return"string"==typeof y[y.length-2]&&(y[y.length-2]=y[y.length-2]+newline),concatTextAndAttributes(y,v,!0),joinTextAttributes(y,"")}},{key:"textInRange",value:function Document_textInRange_(e){var t=e.start,n=e.end;if(t=this.clipPositionToLines(t),lessPosition(n=this.clipPositionToLines(n),t)){var r=[n,t];t=r[0],n=r[1]}var i=t,o=i.row,a=i.column,s=n,l=s.row,c=s.column;if(o===l)return a===c?"":this.getLineString(o).slice(a,c);for(var u=this.getLine(o),h=u.text.slice(a);(u=u.nextLine())&&++o<l;)h+=newline+u.text;return h+newline+this.getLineString(l).slice(0,c)}},{key:"setTextInRange",value:function Document_setTextInRange_(e,t){return this.remove(t),this.insertText(e,t.start,!1)}},{key:"indexToPosition",value:function Document_indexToPosition_(e){e<0&&(e=0);var t=this.root.findLineWithTextIndex(e,0);return{row:t.row,column:t.column}}},{key:"positionToIndex",value:function Document_positionToIndex_(e){for(var t=e.row,n=e.column,r=this.getLine(t),i=n=Math.max(0,Math.min(n,r.stringSize-1)),o=r.parent,a=r;o;){for(var s=o.children.indexOf(a),l=o.children.slice(0,s),c=0;c<l.length;c++)i+=l[c].stringSize;a=o,o=o.parent}return i}},{key:"insertTextAndAttributes",value:function Document_insertTextAndAttributes_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e||!e.length||2===e.length&&!e[0])return{start:t,end:t};n&&!n.debugDocumentUpdate&&(n=!1),n&&!n.log&&(n=console);var r=t.row,i=t.column;r<0&&(r=0),i<0&&(i=0);var o=this.getLine(r),a=splitTextAndAttributesIntoLines(e,newline);if(n&&(n.log||(n={log:console.log.bind(console),dump:console.log.bind(console)})),!o){var s=this.insertLines(a.map(function(e){return new Line({parent:null,width:0,height:0,textAndAttributes:e})}));return n&&n.log("insert "+s.length+" lines into empty text"),{start:{row:0,column:0},end:{row:s.length,column:lively_lang.arr.last(s).text.length}}}if(r>=this.rowCount){var l=this.endPosition;n&&n.log("insertion after doc end, "+r+"/"+i+", inserting "+(r-l.row)+" rows");for(var c=0;c<r-l.row;c++)a.unshift(["",null]);r=l.row,i=l.column}if(1===a.length&&""===a[0][0]){n&&n.log("insert just newline at "+r+"/"+i);var u=this.splitLineAt({row:r,column:i});return n&&n.dump(""+this.root.print(!1)),u}var h=a.shift(),d=a.length,p={row:r,column:i},f=o.stringSize-1;if(i>f){n&&n.log("filling up insertion column at "+r+"/"+i+": "+(i-f));var g=" ".repeat(i-f);h.length?"string"==typeof h[0]?h[0]=g+h[0]:h.unshift(g,null):h.push(g,null)}var m=splitTextAndAttributesAt(o.textAndAttributes,i),v=slicedToArray(m,2),y=v[0],_=v[1];""===y[0]&&(y=[]);var b=concatTextAndAttributes(y,h,!0);if(0===d){for(var x=0,w=0;w<h.length;w+=2){var k=h[w];x+="string"==typeof k?k.length:1}p.column=i+x,concatTextAndAttributes(b,_,!0)}if(o.changeTextAndAttributes(b),0===d)return n&&(n.log("single line inserted at "+r+"/"+i),n&&n.dump(""+this.root.print(!1))),{start:{row:r,column:i},end:p};for(var S=a[d-1],C=0,M=0;M<S.length;M+=2){var T=S[M];C+="string"==typeof T?T.length:1}p.row+=d,p.column=C;var P=this.insertLines(a.map(function(e){return new Line({parent:null,width:0,height:0,textAndAttributes:e})}),r+1),A=lively_lang.arr.last(P);return A.changeTextAndAttributes(concatTextAndAttributes(A.textAndAttributes,_,!0)),n&&(n.log(P.length+" inserted at "+r+"/"+i),n&&n.dump(""+this.root.print(!1))),{start:{row:r,column:i},end:p}}},{key:"insertText",value:function Document_insertText_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)return{start:t,end:t};var r=t.row,i=t.column;r<0&&(r=0),i<0&&(i=0);var o=this.getLine(r);if(!o){var a=this.insertLines(e.split(newline));return{start:{row:0,column:0},end:{row:a.length,column:lively_lang.arr.last(a).text.length}}}if(r>=this.rowCount){var s=this.endPosition;e="\n".repeat(r-s.row)+e,r=s.row,i=s.column}var l=e.split(newline),c=l.shift(),u=l.length,h={row:r,column:i},d=o.stringSize-1;i>d&&(c=" ".repeat(i-d)+c);var p=splitTextAndAttributesAt(o.textAndAttributes,i),f=slicedToArray(p,2),g=f[0],m=f[1];""===g[0]&&(g=[]);var v=concatTextAndAttributes(g,[c,n&&g.length?g[g.length-1]:null],!0);if(0===u&&(h.column=i+c.length,concatTextAndAttributes(v,m,!0)),o.changeTextAndAttributes(v),0===u)return{start:{row:r,column:i},end:h};h.row+=u,h.column=l[u-1].length;var y=this.insertLines(l,r+1),_=lively_lang.arr.last(y);return _.changeTextAndAttributes(concatTextAndAttributes(_.textAndAttributes,m,!0)),{start:{row:r,column:i},end:h}}},{key:"remove",value:function Document_remove_(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(0!==this.rowCount){var n=e.start,r=e.end;if(n.row!==r.row||n.column!==r.column){if(lessPosition(r,n)){var i=[r,n];n=i[0],r=i[1]}var o=this.endPosition;if(!lessEqPosition(o,n)){var a=maxPosition(n,{column:0,row:0}),s=a.row,l=a.column,c=minPosition(r,o),u=c.row,h=c.column;l<0&&(l=0),h<0&&(h=0),t&&!t.debugDocumentUpdate&&(t=!1),t&&(t.log||(t={log:console.log.bind(console),dump:console.log.bind(console),group:console.group.bind(console),groupEnd:console.groupEnd.bind(console)}),t.group("document.remove "+JSON.stringify(e)),t.log("[text doc] removing "+s+"/"+l+" => "+u+"/"+h));for(var d=this.getLine(s),p=d,f=[d],g=0;g<u-s;g++)f.push(d=d.nextLine());var m=f[f.length-1],v=splitTextAndAttributesAt(p.textAndAttributes,l),y=slicedToArray(v,1)[0],_=splitTextAndAttributesAt(m.textAndAttributes,h),b=slicedToArray(_,2),x=(b[0],b[1]);p.changeTextAndAttributes(concatTextAndAttributes(y,x,!0)),t&&t.log('[text doc removal] what remains of start/end line: "'+p.textAndAttributes+'"'),f.length>1&&this.removeLines(s+1,u,t),t&&t.groupEnd("[text doc removal]")}}}}},{key:"splitLineAt",value:function Document_splitLineAt_(e){var t=e.row,n=e.column,r=this.getLine(t),i=splitTextAndAttributesAt(r.textAndAttributes,n),o=slicedToArray(i,2),a=o[0],s=o[1];r.changeTextAndAttributes(a);var l=new Line({parent:null,width:0,height:0,textAndAttributes:s});return this.insertLines([l],t+1),{start:{row:t,column:n},end:{row:t+1,column:0}}}},{key:"replace",value:function Document_replace_(e,t,n){var r=e.start,i=e.end;if(!t.length)return this.remove({start:r,end:i},n),{removed:{start:r,end:i},inserted:{start:r,end:r}};var o=this.clipPositionToLines(r),a=this.clipPositionToLines(i);if(o.row===a.row&&this.remove({start:o,end:a},n),o.row===a.row||lessEqPosition(this.endPosition,r)){var s=void 0;return"string"==typeof t?t.length&&(s=t.length&&this.insertText(t,r)):t.length&&(2!==t.length||t[0])&&(s=this.insertTextAndAttributes(t,r,n)),s||(s={start:o,end:o}),{removed:{start:r,end:i},inserted:s}}i=a;var l=r=o,c=l.row,u=l.column,h=i,d=h.row,p=(h.column,void 0);if("string"==typeof t){p=[];for(var f=t.split(newline),g=0;g<f.length;g++)p.push([f[g],null])}else p=splitTextAndAttributesIntoLines(t,newline);var m=!p.length||1===p.length&&(!p[0].length||!p[0][0].length);m&&(p=[]);var v=this.getLine(c),y=v,_=this.getLine(d),b=splitTextAndAttributesAt(y.textAndAttributes,u),x=slicedToArray(b,2),w=x[0];x[1];y.changeTextAndAttributes(m?w:concatTextAndAttributes(w,p.shift(),!0));for(var k=c;p.length&&(k++,(v=v.nextLine())!==_);)v.changeTextAndAttributes(p.shift());if(!p.length){var S=v.stringSize-1;return this.remove({start:{row:k,column:v.stringSize},end:i}),{removed:{start:r,end:i},inserted:{start:r,end:{row:k,column:S}}}}console.assert(k==d,"not end row"),console.assert(v.row==k,"row != last line.row"),this.remove({start:{row:k,column:0},end:i});for(var C=[],M=p.length,T=0;T<M-1;T++){var P=p[T];P.length||(P=["",null]),"string"==typeof P[P.length-2]?P[P.length-2]=P[P.length-2]+newline:P.push(newline,null),C.push.apply(C,toConsumableArray(P))}return C.push.apply(C,toConsumableArray(p[M-1])),{removed:{start:r,end:i},inserted:{start:r,end:this.insertTextAndAttributes(C,{row:k,column:0}).end}}}},{key:"wordsOfLine",value:function Document_wordsOfLine_(e){for(var t,n=this.getLineString(e),r=[],i=function isWordDelimiter(e){return/[^a-z0-9_]/i.test(e)},o=0;o<n.length;o++)i(n[o])?t&&(t.range.end.column=o,r.push(t),t=null):(t=t||{index:r.length,string:"",range:{start:{row:e,column:o},end:{row:e,column:o}}}).string+=n[o];return t&&(t.range.end.column=o,r.push(t)),r}},{key:"wordAt",value:function Document_wordAt_(e){var t=e.row,n=e.column;return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.wordsOfLine(t)).find(function(e){var t=e.range,r=t.start.column,i=t.end.column;return r<=n&&n<=i})||{range:{start:{column:n,row:t},end:{column:n,row:t}},string:""}}},{key:"wordLeft",value:function Document_wordLeft_(e){var t=e.row,n=e.column,r=this.wordsOfLine(t);if(!r.length||lessEqPosition(e,r[0].range.start)){for(;--t>=0;)if((r=this.wordsOfLine(t)).length)return lively_lang.arr.last(r);return{range:{start:e,end:e},string:""}}var i=this.wordAt(e);return i.string?eqPosition(i.range.start,e)?r[i.index-1]:i:r.slice().reverse().find(function(e){return e.range.end.column<=n})||{range:{start:e,end:e},string:""}}},{key:"wordRight",value:function Document_wordRight_(e){var t=e.column,n=e.row,r=this.wordsOfLine(e.row);if(!r.length||lessEqPosition(lively_lang.arr.last(r).range.end,e)){for(;++n<this.lines.length;)if((r=this.wordsOfLine(n)).length)return r[0];return{range:{start:e,end:e},string:""}}var i=this.wordAt(e);return i.string?eqPosition(i.range.end,e)?r[i.index+1]:i:r.find(function(e){return e.range.start.column>=t})||{range:{start:e,end:e},string:""}}},{key:"scanForward",value:function Document_scanForward_(e,t){for(var n=e.row,r=e.column,i=this.getLine(n),o=i.text,a=r;a<i.stringSize-1;a++){var s=t(o[a],{row:n,column:a});if(s)return s}for(;i=i.nextLine();){n++,o=i.text;for(var l=0;l<i.stringSize-1;l++){var c=t(o[l],{row:n,column:l});if(c)return c}}return null}},{key:"scanBackward",value:function Document_scanBackward_(e,t){for(var n=e.row,r=e.column,i=this.getLine(n),o=i.text,a=r-1;a>=0;a--){var s=t(o[a],{row:n,column:a});if(s)return s}for(;i=i.prevLine();){n--,o=i.text;for(var l=i.stringSize-2;l>=0;l--){var c=t(o[l],{row:n,column:l});if(c)return c}}return null}},{key:"copy",value:function Document_copy_(){return new this.constructor(this.lines.slice(),this.options)}},{key:"toString",value:function Document_toString_(){return"Document("+this.rowCount+" lines)"}},{key:"consistencyCheck",value:function Document_consistencyCheck_(){var e=[],t=this.rowCount,n=this.stringSize,r=this.lines,i=this.textString,o=this.root;t!==r.length&&e.push({error:"document "+this+" row count: "+t+" !== "+r.length}),i.length!==n&&e.push({error:"document "+this+" textString.length vs stringSize: "+i.length+" !== "+n}),e.push.apply(e,toConsumableArray(o.consistencyCheck()));for(var a=0,s=r[0];s;)s!=r[a]&&e.push({error:"line iteration at "+a+" is broken: nextLine() of "+r[a-1]+" is not "+r[a]+"!"}),a++,s=s.nextLine();if(r[a]&&e.push({error:"nextLine() of\n  "+r[a-1]+"\nis nullish but \n  "+r[a]+"\nexists in tree!"}),e.length)throw new Error("Consistency check of document revealed "+e.length+" error"+(e.length>1?"s":"")+":\n"+e.map(function(e){return e.error}).filter(Boolean).join("\n"))}},{key:"print",value:function Document_print_(){return this.root.print(!1,0,0,"root")}},{key:"print2",value:function Document_print2_(){var e=System.decanonicalize("lively.lang/text-graphics.js"),t=(System.get(e)||{}).printTree;return t?t(this.root,function(e){return e.toString()},function(e){return e.children},{padding:[2,1,2,1]}):(lively.module.module(e).load().then(function(){return console.log("lively.lang/text-graphics.js loaded")}).catch(function(e){return console.error(e)}),"Loading lively.lang/text-graphics.js lib, please try again later :P")}}],[{key:"fuzzyTest",value:function Document_fuzzyTest_(){return documentFuzzier.run()}},{key:"newline",get:function get(){return newline}},{key:"fromString",value:function Document_fromString_(e,t){return new this(e.split(newline),t)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:37090,end:70437})}(void 0),Anchor=function(e){var t=_classRecorder,n=t.hasOwnProperty("Anchor")&&"function"==typeof t.Anchor?t.Anchor:t.Anchor=function Anchor(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Anchor_initialize_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{column:0,row:0},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"move";this.id=e||""+(this.constructor._id=(this.constructor._id||0)+1),this.position=t,this.insertBehavior=n}},{key:"isAnchor",get:function get(){return!0}},{key:"onDelete",value:function Anchor_onDelete_(e){if(this.id,lessEqPosition(this.position,e.start))return!1;if(lessEqPosition(e.start,this.position)&&lessEqPosition(this.position,e.end))return this.position=e.start,!0;var t=this.position,n=t.row,r=t.column,i=e.start,o=i.row,a=i.column,s=e.end,l=s.row,c=s.column,u=n-(l-o),h=l!==this.position.row?r:a===c?r-(c-a):a+(r-c);return this.position={column:h,row:u},!0}},{key:"onInsert",value:function Anchor_onInsert_(e){if(this.id,lessPosition(this.position,e.start))return!1;if(eqPosition(this.position,e.start)&&"stay"===this.insertBehavior)return!1;var t=this.position,n=t.row,r=t.column,i=e.start,o=i.row,a=i.column,s=e.end,l=s.row,c=s.column,u=l-o,h=o!==this.position.row?0:c-a;return this.position={column:r+h,row:n+u},!0}},{key:"equalsPosition",value:function Anchor_equalsPosition_(e){return!!e&&(e.isAnchor?eqPosition(this.position,e.position):eqPosition(this.position,e))}},{key:"toString",value:function Anchor_toString_(){var e=this.id,t=this.position;return"Anchor("+e+" "+t.row+"/"+t.column+")"}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:82,end:3345})}(void 0),Icon=function(e){var t=_classRecorder,n=t.hasOwnProperty("Icon")&&"function"==typeof t.Icon?t.Icon:t.Icon=function Icon(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,void 0,[{key:"makeLabel",value:function Icon_makeLabel_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{prefix:"",suffix:""},n=t.prefix,r=t.suffix,i=[];return n&&i.push.apply(i,toConsumableArray("string"==typeof n?[n||"",{}]:n)),i.push.apply(i,toConsumableArray(this.textAttribute(e))),r&&i.push.apply(i,toConsumableArray("string"==typeof r?[r||"",{}]:r)),new Label(Object.assign({value:i},lively_lang.obj.dissoc(t,["prefix","suffix"])))}},{key:"textAttribute",value:function Icon_textAttribute_(e){return[Icons[e].code||"icon "+e+" not found",{fontFamily:"",textStyleClasses:["fa"]}]}},{key:"setIcon",value:function Icon_setIcon_(e,t){e.textAndAttributes=this.textAttribute(t)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:750,end:1642})}(void 0),Icons={"500px":{code:""},"address-book":{code:""},"address-book-o":{code:""},"address-card":{code:""},"address-card-o":{code:""},adjust:{code:""},adn:{code:""},"align-center":{code:""},"align-justify":{code:""},"align-left":{code:""},"align-right":{code:""},amazon:{code:""},ambulance:{code:""},"american-sign-language-interpreting":{code:""},anchor:{code:""},android:{code:""},angellist:{code:""},"angle-double-down":{code:""},"angle-double-left":{code:""},"angle-double-right":{code:""},"angle-double-up":{code:""},"angle-down":{code:""},"angle-left":{code:""},"angle-right":{code:""},"angle-up":{code:""},apple:{code:""},archive:{code:""},"area-chart":{code:""},"arrow-circle-down":{code:""},"arrow-circle-left":{code:""},"arrow-circle-o-down":{code:""},"arrow-circle-o-left":{code:""},"arrow-circle-o-right":{code:""},"arrow-circle-o-up":{code:""},"arrow-circle-right":{code:""},"arrow-circle-up":{code:""},"arrow-down":{code:""},"arrow-left":{code:""},"arrow-right":{code:""},"arrow-up":{code:""},arrows:{code:""},"arrows-alt":{code:""},"arrows-h":{code:""},"arrows-v":{code:""},"asl-interpreting":{code:""},"assistive-listening-systems":{code:""},asterisk:{code:""},at:{code:""},"audio-description":{code:""},automobile:{code:""},backward:{code:""},"balance-scale":{code:""},ban:{code:""},bandcamp:{code:""},bank:{code:""},"bar-chart":{code:""},"bar-chart-o":{code:""},barcode:{code:""},bars:{code:""},bath:{code:""},bathtub:{code:""},battery:{code:""},"battery-0":{code:""},"battery-1":{code:""},"battery-2":{code:""},"battery-3":{code:""},"battery-4":{code:""},"battery-empty":{code:""},"battery-full":{code:""},"battery-half":{code:""},"battery-quarter":{code:""},"battery-three-quarters":{code:""},bed:{code:""},beer:{code:""},behance:{code:""},"behance-square":{code:""},bell:{code:""},"bell-o":{code:""},"bell-slash":{code:""},"bell-slash-o":{code:""},bicycle:{code:""},binoculars:{code:""},"birthday-cake":{code:""},bitbucket:{code:""},"bitbucket-square":{code:""},bitcoin:{code:""},"black-tie":{code:""},blind:{code:""},bluetooth:{code:""},"bluetooth-b":{code:""},bold:{code:""},bolt:{code:""},bomb:{code:""},book:{code:""},bookmark:{code:""},"bookmark-o":{code:""},braille:{code:""},briefcase:{code:""},btc:{code:""},bug:{code:""},building:{code:""},"building-o":{code:""},bullhorn:{code:""},bullseye:{code:""},bus:{code:""},buysellads:{code:""},cab:{code:""},calculator:{code:""},calendar:{code:""},"calendar-check-o":{code:""},"calendar-minus-o":{code:""},"calendar-o":{code:""},"calendar-plus-o":{code:""},"calendar-times-o":{code:""},camera:{code:""},"camera-retro":{code:""},car:{code:""},"caret-down":{code:""},"caret-left":{code:""},"caret-right":{code:""},"caret-square-o-down":{code:""},"caret-square-o-left":{code:""},"caret-square-o-right":{code:""},"caret-square-o-up":{code:""},"caret-up":{code:""},"cart-arrow-down":{code:""},"cart-plus":{code:""},cc:{code:""},"cc-amex":{code:""},"cc-diners-club":{code:""},"cc-discover":{code:""},"cc-jcb":{code:""},"cc-mastercard":{code:""},"cc-paypal":{code:""},"cc-stripe":{code:""},"cc-visa":{code:""},certificate:{code:""},chain:{code:""},"chain-broken":{code:""},check:{code:""},"check-circle":{code:""},"check-circle-o":{code:""},"check-square":{code:""},"check-square-o":{code:""},"chevron-circle-down":{code:""},"chevron-circle-left":{code:""},"chevron-circle-right":{code:""},"chevron-circle-up":{code:""},"chevron-down":{code:""},"chevron-left":{code:""},"chevron-right":{code:""},"chevron-up":{code:""},child:{code:""},chrome:{code:""},circle:{code:""},"circle-o":{code:""},"circle-o-notch":{code:""},"circle-thin":{code:""},clipboard:{code:""},"clock-o":{code:""},clone:{code:""},close:{code:""},cloud:{code:""},"cloud-download":{code:""},"cloud-upload":{code:""},cny:{code:""},code:{code:""},"code-fork":{code:""},codepen:{code:""},codiepie:{code:""},coffee:{code:""},cog:{code:""},cogs:{code:""},columns:{code:""},comment:{code:""},"comment-o":{code:""},commenting:{code:""},"commenting-o":{code:""},comments:{code:""},"comments-o":{code:""},compass:{code:""},compress:{code:""},connectdevelop:{code:""},contao:{code:""},copy:{code:""},copyright:{code:""},"creative-commons":{code:""},"credit-card":{code:""},"credit-card-alt":{code:""},crop:{code:""},crosshairs:{code:""},css3:{code:""},cube:{code:""},cubes:{code:""},cut:{code:""},cutlery:{code:""},dashboard:{code:""},dashcube:{code:""},database:{code:""},deaf:{code:""},deafness:{code:""},dedent:{code:""},delicious:{code:""},desktop:{code:""},deviantart:{code:""},diamond:{code:""},digg:{code:""},dollar:{code:""},"dot-circle-o":{code:""},download:{code:""},dribbble:{code:""},"drivers-license":{code:""},"drivers-license-o":{code:""},dropbox:{code:""},drupal:{code:""},edge:{code:""},edit:{code:""},eercast:{code:""},eject:{code:""},"ellipsis-h":{code:""},"ellipsis-v":{code:""},empire:{code:""},envelope:{code:""},"envelope-o":{code:""},"envelope-open":{code:""},"envelope-open-o":{code:""},"envelope-square":{code:""},envira:{code:""},eraser:{code:""},etsy:{code:""},eur:{code:""},euro:{code:""},exchange:{code:""},exclamation:{code:""},"exclamation-circle":{code:""},"exclamation-triangle":{code:""},expand:{code:""},expeditedssl:{code:""},"external-link":{code:""},"external-link-square":{code:""},eye:{code:""},"eye-slash":{code:""},eyedropper:{code:""},fa:{code:""},facebook:{code:""},"facebook-f":{code:""},"facebook-official":{code:""},"facebook-square":{code:""},"fast-backward":{code:""},"fast-forward":{code:""},fax:{code:""},feed:{code:""},female:{code:""},"fighter-jet":{code:""},file:{code:""},"file-archive-o":{code:""},"file-audio-o":{code:""},"file-code-o":{code:""},"file-excel-o":{code:""},"file-image-o":{code:""},"file-movie-o":{code:""},"file-o":{code:""},"file-pdf-o":{code:""},"file-photo-o":{code:""},"file-picture-o":{code:""},"file-powerpoint-o":{code:""},"file-sound-o":{code:""},"file-text":{code:""},"file-text-o":{code:""},"file-video-o":{code:""},"file-word-o":{code:""},"file-zip-o":{code:""},"files-o":{code:""},film:{code:""},filter:{code:""},fire:{code:""},"fire-extinguisher":{code:""},firefox:{code:""},"first-order":{code:""},flag:{code:""},"flag-checkered":{code:""},"flag-o":{code:""},flash:{code:""},flask:{code:""},flickr:{code:""},"floppy-o":{code:""},folder:{code:""},"folder-o":{code:""},"folder-open":{code:""},"folder-open-o":{code:""},font:{code:""},"font-awesome":{code:""},fonticons:{code:""},"fort-awesome":{code:""},forumbee:{code:""},forward:{code:""},foursquare:{code:""},"free-code-camp":{code:""},"frown-o":{code:""},"futbol-o":{code:""},gamepad:{code:""},gavel:{code:""},gbp:{code:""},ge:{code:""},gear:{code:""},gears:{code:""},genderless:{code:""},"get-pocket":{code:""},gg:{code:""},"gg-circle":{code:""},gift:{code:""},git:{code:""},"git-square":{code:""},github:{code:""},"github-alt":{code:""},"github-square":{code:""},gitlab:{code:""},gittip:{code:""},glass:{code:""},glide:{code:""},"glide-g":{code:""},globe:{code:""},google:{code:""},"google-plus":{code:""},"google-plus-circle":{code:""},"google-plus-official":{code:""},"google-plus-square":{code:""},"google-wallet":{code:""},"graduation-cap":{code:""},gratipay:{code:""},grav:{code:""},group:{code:""},"h-square":{code:""},"hacker-news":{code:""},"hand-grab-o":{code:""},"hand-lizard-o":{code:""},"hand-o-down":{code:""},"hand-o-left":{code:""},"hand-o-right":{code:""},"hand-o-up":{code:""},"hand-paper-o":{code:""},"hand-peace-o":{code:""},"hand-pointer-o":{code:""},"hand-rock-o":{code:""},"hand-scissors-o":{code:""},"hand-spock-o":{code:""},"hand-stop-o":{code:""},"handshake-o":{code:""},"hard-of-hearing":{code:""},hashtag:{code:""},"hdd-o":{code:""},header:{code:""},headphones:{code:""},heart:{code:""},"heart-o":{code:""},heartbeat:{code:""},history:{code:""},home:{code:""},"hospital-o":{code:""},hotel:{code:""},hourglass:{code:""},"hourglass-1":{code:""},"hourglass-2":{code:""},"hourglass-3":{code:""},"hourglass-end":{code:""},"hourglass-half":{code:""},"hourglass-o":{code:""},"hourglass-start":{code:""},houzz:{code:""},html5:{code:""},"i-cursor":{code:""},"id-badge":{code:""},"id-card":{code:""},"id-card-o":{code:""},ils:{code:""},image:{code:""},imdb:{code:""},inbox:{code:""},indent:{code:""},industry:{code:""},info:{code:""},"info-circle":{code:""},inr:{code:""},instagram:{code:""},institution:{code:""},"internet-explorer":{code:""},intersex:{code:""},ioxhost:{code:""},italic:{code:""},joomla:{code:""},jpy:{code:""},jsfiddle:{code:""},key:{code:""},"keyboard-o":{code:""},krw:{code:""},language:{code:""},laptop:{code:""},lastfm:{code:""},"lastfm-square":{code:""},leaf:{code:""},leanpub:{code:""},legal:{code:""},"lemon-o":{code:""},"level-down":{code:""},"level-up":{code:""},"life-bouy":{code:""},"life-buoy":{code:""},"life-ring":{code:""},"life-saver":{code:""},"lightbulb-o":{code:""},"line-chart":{code:""},link:{code:""},linkedin:{code:""},"linkedin-square":{code:""},linode:{code:""},linux:{code:""},list:{code:""},"list-alt":{code:""},"list-ol":{code:""},"list-ul":{code:""},"location-arrow":{code:""},lock:{code:""},"long-arrow-down":{code:""},"long-arrow-left":{code:""},"long-arrow-right":{code:""},"long-arrow-up":{code:""},"low-vision":{code:""},magic:{code:""},magnet:{code:""},"mail-forward":{code:""},"mail-reply":{code:""},"mail-reply-all":{code:""},male:{code:""},map:{code:""},"map-marker":{code:""},"map-o":{code:""},"map-pin":{code:""},"map-signs":{code:""},mars:{code:""},"mars-double":{code:""},"mars-stroke":{code:""},"mars-stroke-h":{code:""},"mars-stroke-v":{code:""},maxcdn:{code:""},meanpath:{code:""},medium:{code:""},medkit:{code:""},meetup:{code:""},"meh-o":{code:""},mercury:{code:""},microchip:{code:""},microphone:{code:""},"microphone-slash":{code:""},minus:{code:""},"minus-circle":{code:""},"minus-square":{code:""},"minus-square-o":{code:""},mixcloud:{code:""},mobile:{code:""},"mobile-phone":{code:""},modx:{code:""},money:{code:""},"moon-o":{code:""},"mortar-board":{code:""},motorcycle:{code:""},"mouse-pointer":{code:""},music:{code:""},navicon:{code:""},neuter:{code:""},"newspaper-o":{code:""},"object-group":{code:""},"object-ungroup":{code:""},odnoklassniki:{code:""},"odnoklassniki-square":{code:""},opencart:{code:""},openid:{code:""},opera:{code:""},"optin-monster":{code:""},outdent:{code:""},pagelines:{code:""},"paint-brush":{code:""},"paper-plane":{code:""},"paper-plane-o":{code:""},paperclip:{code:""},paragraph:{code:""},paste:{code:""},pause:{code:""},"pause-circle":{code:""},"pause-circle-o":{code:""},paw:{code:""},paypal:{code:""},pencil:{code:""},"pencil-square":{code:""},"pencil-square-o":{code:""},percent:{code:""},phone:{code:""},"phone-square":{code:""},photo:{code:""},"picture-o":{code:""},"pie-chart":{code:""},"pied-piper":{code:""},"pied-piper-alt":{code:""},"pied-piper-pp":{code:""},pinterest:{code:""},"pinterest-p":{code:""},"pinterest-square":{code:""},plane:{code:""},play:{code:""},"play-circle":{code:""},"play-circle-o":{code:""},plug:{code:""},plus:{code:""},"plus-circle":{code:""},"plus-square":{code:""},"plus-square-o":{code:""},podcast:{code:""},"power-off":{code:""},print:{code:""},"product-hunt":{code:""},"puzzle-piece":{code:""},qq:{code:""},qrcode:{code:""},question:{code:""},"question-circle":{code:""},"question-circle-o":{code:""},quora:{code:""},"quote-left":{code:""},"quote-right":{code:""},ra:{code:""},random:{code:""},ravelry:{code:""},rebel:{code:""},recycle:{code:""},reddit:{code:""},"reddit-alien":{code:""},"reddit-square":{code:""},refresh:{code:""},registered:{code:""},remove:{code:""},renren:{code:""},reorder:{code:""},repeat:{code:""},reply:{code:""},"reply-all":{code:""},resistance:{code:""},retweet:{code:""},rmb:{code:""},road:{code:""},rocket:{code:""},"rotate-left":{code:""},"rotate-right":{code:""},rouble:{code:""},rss:{code:""},"rss-square":{code:""},rub:{code:""},ruble:{code:""},rupee:{code:""},s15:{code:""},safari:{code:""},save:{code:""},scissors:{code:""},scribd:{code:""},search:{code:""},"search-minus":{code:""},"search-plus":{code:""},sellsy:{code:""},send:{code:""},"send-o":{code:""},server:{code:""},share:{code:""},"share-alt":{code:""},"share-alt-square":{code:""},"share-square":{code:""},"share-square-o":{code:""},shekel:{code:""},sheqel:{code:""},shield:{code:""},ship:{code:""},shirtsinbulk:{code:""},"shopping-bag":{code:""},"shopping-basket":{code:""},"shopping-cart":{code:""},shower:{code:""},"sign-in":{code:""},"sign-language":{code:""},"sign-out":{code:""},signal:{code:""},signing:{code:""},simplybuilt:{code:""},sitemap:{code:""},skyatlas:{code:""},skype:{code:""},slack:{code:""},sliders:{code:""},slideshare:{code:""},"smile-o":{code:""},snapchat:{code:""},"snapchat-ghost":{code:""},"snapchat-square":{code:""},"snowflake-o":{code:""},"soccer-ball-o":{code:""},sort:{code:""},"sort-alpha-asc":{code:""},"sort-alpha-desc":{code:""},"sort-amount-asc":{code:""},"sort-amount-desc":{code:""},"sort-asc":{code:""},"sort-desc":{code:""},"sort-down":{code:""},"sort-numeric-asc":{code:""},"sort-numeric-desc":{code:""},"sort-up":{code:""},soundcloud:{code:""},"space-shuttle":{code:""},spinner:{code:""},spoon:{code:""},spotify:{code:""},square:{code:""},"square-o":{code:""},"stack-exchange":{code:""},"stack-overflow":{code:""},star:{code:""},"star-half":{code:""},"star-half-empty":{code:""},"star-half-full":{code:""},"star-half-o":{code:""},"star-o":{code:""},steam:{code:""},"steam-square":{code:""},"step-backward":{code:""},"step-forward":{code:""},stethoscope:{code:""},"sticky-note":{code:""},"sticky-note-o":{code:""},stop:{code:""},"stop-circle":{code:""},"stop-circle-o":{code:""},"street-view":{code:""},strikethrough:{code:""},stumbleupon:{code:""},"stumbleupon-circle":{code:""},subscript:{code:""},subway:{code:""},suitcase:{code:""},"sun-o":{code:""},superpowers:{code:""},superscript:{code:""},support:{code:""},table:{code:""},tablet:{code:""},tachometer:{code:""},tag:{code:""},tags:{code:""},tasks:{code:""},taxi:{code:""},telegram:{code:""},television:{code:""},"tencent-weibo":{code:""},terminal:{code:""},"text-height":{code:""},"text-width":{code:""},th:{code:""},"th-large":{code:""},"th-list":{code:""},themeisle:{code:""},thermometer:{code:""},"thermometer-0":{code:""},"thermometer-1":{code:""},"thermometer-2":{code:""},"thermometer-3":{code:""},"thermometer-4":{code:""},"thermometer-empty":{code:""},"thermometer-full":{code:""},"thermometer-half":{code:""},"thermometer-quarter":{code:""},"thermometer-three-quarters":{code:""},"thumb-tack":{code:""},"thumbs-down":{code:""},"thumbs-o-down":{code:""},"thumbs-o-up":{code:""},"thumbs-up":{code:""},ticket:{code:""},times:{code:""},"times-circle":{code:""},"times-circle-o":{code:""},"times-rectangle":{code:""},"times-rectangle-o":{code:""},tint:{code:""},"toggle-down":{code:""},"toggle-left":{code:""},"toggle-off":{code:""},"toggle-on":{code:""},"toggle-right":{code:""},"toggle-up":{code:""},trademark:{code:""},train:{code:""},transgender:{code:""},"transgender-alt":{code:""},trash:{code:""},"trash-o":{code:""},tree:{code:""},trello:{code:""},tripadvisor:{code:""},trophy:{code:""},truck:{code:""},try:{code:""},tty:{code:""},tumblr:{code:""},"tumblr-square":{code:""},"turkish-lira":{code:""},tv:{code:""},twitch:{code:""},twitter:{code:""},"twitter-square":{code:""},umbrella:{code:""},underline:{code:""},undo:{code:""},"universal-access":{code:""},university:{code:""},unlink:{code:""},unlock:{code:""},"unlock-alt":{code:""},unsorted:{code:""},upload:{code:""},usb:{code:""},usd:{code:""},user:{code:""},"user-circle":{code:""},"user-circle-o":{code:""},"user-md":{code:""},"user-o":{code:""},"user-plus":{code:""},"user-secret":{code:""},"user-times":{code:""},users:{code:""},vcard:{code:""},"vcard-o":{code:""},venus:{code:""},"venus-double":{code:""},"venus-mars":{code:""},viacoin:{code:""},viadeo:{code:""},"viadeo-square":{code:""},"video-camera":{code:""},vimeo:{code:""},"vimeo-square":{code:""},vine:{code:""},vk:{code:""},"volume-control-phone":{code:""},"volume-down":{code:""},"volume-off":{code:""},"volume-up":{code:""},warning:{code:""},wechat:{code:""},weibo:{code:""},weixin:{code:""},whatsapp:{code:""},wheelchair:{code:""},"wheelchair-alt":{code:""},wifi:{code:""},"wikipedia-w":{code:""},"window-close":{code:""},"window-close-o":{code:""},"window-maximize":{code:""},"window-minimize":{code:""},"window-restore":{code:""},windows:{code:""},won:{code:""},wordpress:{code:""},wpbeginner:{code:""},wpexplorer:{code:""},wpforms:{code:""},wrench:{code:""},xing:{code:""},"xing-square":{code:""},"y-combinator":{code:""},"y-combinator-square":{code:""},yahoo:{code:""},yc:{code:""},"yc-square":{code:""},yelp:{code:""},yen:{code:""},yoast:{code:""},youtube:{code:""},"youtube-play":{code:""},"youtube-square":{code:""}},Label=function(e){var t=_classRecorder,n=t.hasOwnProperty("Label")&&"function"==typeof t.Label?t.Label:t.Label=function Label(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Label_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fontMetric,r=e.position,i=e.rightCenter,o=e.leftCenter,a=e.topCenter,s=e.bottom,l=e.top,c=e.right,u=e.left,h=e.bottomCenter,d=e.bottomLeft,p=e.bottomRight,f=e.topRight,g=e.topLeft,m=e.center,v=e.extent;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,lively_lang.obj.dissoc(e,["fontMetric"])),t&&(this._fontMetric=t),this._cachedTextBounds=null,this.fit(),void 0!==v&&(this.extent=v),void 0!==r&&(this.position=r),void 0!==i&&(this.rightCenter=i),void 0!==o&&(this.leftCenter=o),void 0!==a&&(this.topCenter=a),void 0!==s&&(this.bottom=s),void 0!==l&&(this.top=l),void 0!==c&&(this.right=c),void 0!==u&&(this.left=u),void 0!==h&&(this.bottomCenter=h),void 0!==d&&(this.bottomLeft=d),void 0!==p&&(this.bottomRight=p),void 0!==f&&(this.topRight=f),void 0!==g&&(this.topLeft=g),void 0!==m&&(this.center=m)}},{key:"__additionally_serialize__",value:function Label___additionally_serialize___(e,t,r,i){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__additionally_serialize__",this).call(this,e,t,r,i),this.fit(),e._cachedTextBounds=this._cachedTextBounds&&this._cachedTextBounds.toTuple()}},{key:"__after_deserialize__",value:function Label___after_deserialize___(e,t){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__after_deserialize__",this).call(this,e,t),e._cachedTextBounds&&(this.changeMetaData("deserializeInfo",{recoveredTextBounds:!0}),this._cachedTextBounds=lively_graphics.Rectangle.fromTuple(e._cachedTextBounds))}},{key:"isLabel",get:function get(){return!0}},{key:"textStyle",get:function get(){return lively_lang.obj.select(this,["textStyleClasses","textDecoration","fontStyle","fontWeight","textShadow","fontColor","fontSize","fontFamily"])}},{key:"fit",value:function Label_fit_(){return this.extent=this.textBounds().extent(),this._needsFit=!1,this}},{key:"fitIfNeeded",value:function Label_fitIfNeeded_(){this._needsFit&&this.fit()}},{key:"textAndAttributesOfLines",get:function get(){return splitTextAndAttributesIntoLines(this.textAndAttributes,"\n")}},{key:"textBoundsSingleChunk",value:function Label_textBoundsSingleChunk_(){var e,t,n=this._fontMetric||this.env.fontMetric,r=slicedToArray(this.textAndAttributes,2),i=r[0],o=r[1],a=Object.assign({},this.textStyle,{},o),s=this.padding;if(n.isProportional(a.fontFamily)){var l=n.sizeFor(a,i);e=l.width,t=l.height}else{var c=n.sizeFor(a,"x"),u=c.width,h=c.height;e=i.length*u,t=h}return new lively_graphics.Rectangle(0,0,Math.ceil(s.left()+s.right()+e),Math.ceil(s.top()+s.bottom()+t))}},{key:"textBoundsAllChunks",value:function Label_textBoundsAllChunks_(){for(var e=this._fontMetric||this.env.fontMetric,t=this.padding,n=this.textStyle,r=this.textAndAttributesOfLines,i=!e.isProportional(n.fontFamily),o=e.sizeFor(n,"x").height,a=0,s=0,l=0;l<r.length;l++){var c=r[l];if(c.length){for(var u=0,h=0,d=0;d<c.length;d+=2){var p=c[d],f=c[d+1]||{},g=Object.assign({},n,{},f);if(i&&!f.fontFamily||!e.isProportional(g.fontFamily)){g.fontFamily,g.fontSize;var m=e.sizeFor(g,"x"),v=m.width,y=m.height;h+=p.length*v,u=Math.max(u,y)}else{var _=e.sizeFor(g,p),b=_.width,x=_.height;h+=b,u=Math.max(u,x)}}a+=u,s=Math.max(s,h)}else a+=o}return new lively_graphics.Rectangle(0,0,Math.ceil(t.left()+t.right()+s),Math.ceil(t.top()+t.bottom()+a))}},{key:"invalidateTextLayout",value:function Label_invalidateTextLayout_(){this._cachedTextBounds=null,this.autofit&&(this._needsFit=!0),this.makeDirty()}},{key:"textBounds",value:function Label_textBounds_(){var e=this.textAndAttributes,t=this._cachedTextBounds;return t||(this._cachedTextBounds=e.length<=2?this.textBoundsSingleChunk():this.textBoundsAllChunks())}},{key:"forceRerender",value:function Label_forceRerender_(){this._cachedTextBounds=null,this.makeDirty()}},{key:"applyLayoutIfNeeded",value:function Label_applyLayoutIfNeeded_(){this.fitIfNeeded(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"applyLayoutIfNeeded",this).call(this)}},{key:"render",value:function Label_render_(e){for(var t=[],n=this.textAndAttributesOfLines.length,r=0;r<n;r++){for(var i=this.textAndAttributesOfLines[r],o=0;o<i.length;o+=2){var a=i[o],s=i[o+1];t.push(this.renderChunk(a,s))}r<n-1&&t.push(vdom.h("br"))}var l=this.textStyle,c=l.fontColor,u=l.fontFamily,h=l.fontSize,d=l.fontStyle,p=l.fontWeight,f=l.textShadow,g=l.textDecoration,m=l.textStyleClasses,v=this.padding,y=(s={fontFamily:u,fontSize:"number"==typeof h?h+"px":h,color:c?String(c):"transparent",position:"absolute",cursor:this.nativeCursor},defaultAttributes(this,e));return f&&(s.textShadow=f),"normal"!==p&&(s.fontWeight=p),"normal"!==d&&(s.fontStyle=d),"none"!==g&&(s.textDecoration=g),m&&m.length&&(y.className=(y.className||"")+" "+m.join(" ")),y.style=Object.assign({},defaultStyle(this),{},s),vdom.h("div",y,[vdom.h("div",{style:{position:"absolute",paddingLeft:v.left()+"px",paddingRight:v.right()+"px",paddingTop:v.top()+"px",paddingBottom:v.bottom()+"px",width:"calc(100% - "+v.left()+"px - "+v.right()+"px)"}},t),e.renderSubmorphs(this)])}},{key:"renderChunk",value:function Label_renderChunk_(e,t){var n=t=t||{},r=n.backgroundColor,i=n.fontColor,o=n.fontFamily,a=n.fontStyle,s=n.fontWeight,l=n.textShadow,c=n.textDecoration,u=n.textStyleClasses,h=n.textAlign,d=n.float,p=n.display,f=n.lineHeight,g={},m={style:g};d&&(g.float=d),p&&(g.display=p),r&&(g.backgroundColor=String(r)),o&&(g.fontFamily=o),i&&(g.color=String(i)),l&&(g.textShadow=l),"normal"!==s&&(g.fontWeight=s),"normal"!==a&&(g.fontStyle=a),"none"!==c&&(g.textDecoration=c),h&&(g.textAlign=h),f&&(g.lineHeight=f),u&&u.length&&(m.className=u.join(" "));for(var v=["fontSize","width","height","maxWidth","maxHeight","top","left","padding","paddingLeft","paddingRight","paddingBottom","paddingTop","marginTop","marginRight","marginLeft","marginBottom"],y=0;y<v.length;y++){var _=v[y];if(t.hasOwnProperty(_)){var b=t[_];g[_]="number"==typeof b?b+"px":b}}return vdom.h("span",m,e)}},{key:"interactivelyChangeLabel",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(){var e;return regeneratorRuntime.wrap(function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.world().prompt("edit label",{input:this.textString,historyId:"lively.morphic-label-edit-hist"});case 2:"string"==typeof(e=t.sent)&&(this.textString=e);case 4:case"end":return t.stop()}},_callee,this)}));return function Label_interactivelyChangeLabel_(){return e.apply(this,arguments)}}()},{key:"menuItems",value:function Label_menuItems_(){var e=this,t=lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"menuItems",this).call(this);return t.unshift({isDivider:!0}),t.unshift(["change label",function(){return e.interactivelyChangeLabel()}]),t}}],[{key:"properties",get:function get(){return{fill:{defaultValue:lively_graphics.Color.transparent},draggable:{defaultValue:!1},nativeCursor:{defaultValue:"default"},isIcon:{derived:!0,get:function get(){return lively_lang.properties.values(Icons).map(function(e){return e.code}).includes(this.textString)}},value:{derived:!0,after:["textAndAttributes","textString"],get:function get(){var e=this.textAndAttributes;if(e.length<=2){var t=slicedToArray(e,2),n=t[0],r=t[1];if(!Object.keys(r||{}).length)return n||""}return e},set:function set(e){"string"==typeof e?this.textString=e:this.textAndAttributes=e}},textString:{derived:!0,after:["textAndAttributes"],get:function get(){return this.textAndAttributes.map(function(e,t){return t%2==0?e:""}).join("")},set:function set(e){this.textAndAttributes=[e,null]}},textAndAttributes:{get:function get(){var e=this.getProperty("textAndAttributes");return(!e||e.length<1)&&(e=["",null]),e},set:function set(e){Array.isArray(e)||(e=[String(e),{}]),0===e.length&&(e=["",{}]);var t=this.textAndAttributes;this.setProperty("textAndAttributes",e),this.autofit&&!lively_lang.arr.equals(t,e)&&this.invalidateTextLayout(),lively_bindings.signal(this,"value",e)}},valueAndAnnotation:{derived:!0,after:["textAndAttributes"],get:function get(){var e=this.textAndAttributes,t=null;if(e.length>2){var n=e.slice(-2),r=slicedToArray(n,2),i=r[0],o=r[1];o&&o.textStyleClasses&&o.textStyleClasses.includes("annotation")&&(e=e.slice(0,-2),t=[i,o])}return{value:e,annotation:t}},set:function set(e){var t=e.value,n=e.annotation;t||(t=""),"string"==typeof t&&(t=[t,null]),Array.isArray(t)||(t=[String(t),null]);var r=t.slice();if(n){"string"==typeof n&&(n=[n,null]);var i=n[1];i||(i=n[1]={}),r.push.apply(r,toConsumableArray(n)),i.textStyleClasses=(i.textStyleClasses||[]).concat("annotation"),i.textStyleClasses.includes("annotation")||i.textStyleClasses.push("annotation")}this.textAndAttributes=r}},autofit:{defaultValue:!0,set:function set(e){this.setProperty("autofit",e),e&&(this._needsFit=!0)}},padding:{type:"Rectangle",isStyleProp:!0,defaultValue:lively_graphics.Rectangle.inset(0),initialize:function initialize(e){this.padding=e},set:function set(e){e||(e=lively_graphics.Rectangle.inset(0));var t=this.padding;this.setProperty("padding","number"==typeof e?lively_graphics.Rectangle.inset(e):e),this.autofit&&!t.equals(e)&&this.invalidateTextLayout()}},fontFamily:{isStyleProp:!0,type:"Enum",values:config$1.text.basicFontItems,defaultValue:"Sans-Serif",set:function set(e){var t=this.fontFamily;this.setProperty("fontFamily",e),this.autofit&&t!=e&&this.invalidateTextLayout()}},fontSize:{type:"Number",min:1,isStyleProp:!0,defaultValue:12,set:function set(e){var t=this.fontSize;this.setProperty("fontSize",e),this.autofit&&e!=t&&this.invalidateTextLayout()}},fontColor:{type:"Color",isStyleProp:!0,defaultValue:lively_graphics.Color.black},fontWeight:{type:"Enum",values:["bold","bolder","light","lighter"],isStyleProp:!0,defaultValue:"normal",set:function set(e){var t=this.fontWeight;this.setProperty("fontWeight",e),this.autofit&&t!=e&&this.invalidateTextLayout()}},fontStyle:{type:"Enum",values:["normal","italic","oblique"],isStyleProp:!0,defaultValue:"normal",set:function set(e){var t=this.fontStyle;this.setProperty("fontStyle",e),this.autofit&&t!=e&&this.invalidateTextLayout()}},textShadow:{type:"String",isStyleProp:!0,defaultValue:""},textDecoration:{defaultValue:"none"},textStyleClasses:{defaultValue:void 0,set:function set(e){this.setProperty("textStyleClasses",e),this.autofit&&this.invalidateTextLayout()}}}}},{key:"icon",value:function Label_icon_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{prefix:"",suffix:""};return Icon.makeLabel(e,t)}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:435,end:16410})}({referencedAs:"Morph",value:Morph});function addIndexToTextPos(e,t,n){return e.indexToPosition(e.positionToIndex(t)+n)}var Snippet=function(e){var t=_classRecorder,n=t.hasOwnProperty("Snippet")&&"function"==typeof t.Snippet?t.Snippet:t.Snippet=function Snippet(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Snippet_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{trigger:null,expansion:""},t=e.trigger,n=e.expansion;this.trigger=t,this.expansion=n,this.resetExpansionState()}},{key:"isTextSnippet",get:function get(){return!0}},{key:"attach",value:function Snippet_attach_(e){this.isExpanding&&(this.textMorph=e,lively_bindings.connect(this.textMorph,"selectionChange",this,"onCursorMove"))}},{key:"detach",value:function Snippet_detach_(e){this.isExpanding&&(lively_bindings.disconnect(e,"selectionChange",this,"onCursorMove"),this.textMorph=null)}},{key:"onCursorMove",value:function Snippet_onCursorMove_(){var e=this.expansionState,t=e.startAnchor,n=e.endAnchor;e.isExpanding?Range.fromPositions(t.position,n.position).containsPosition(this.textMorph.cursorPosition)||this.resetExpansionState():this.resetExpansionState()}},{key:"resetExpansionState",value:function Snippet_resetExpansionState_(){var e=this.textMorph;if(e){var t=this.expansionState||{},n=t.marker,r=t.startAnchor,i=t.endAnchor,o=t.steps;r&&e.removeAnchor(r),i&&e.removeAnchor(i),n&&e.removeMarker(n),o.forEach(function(t){var n=t.anchor;return e.removeAnchor(n)})}this.expansionState={stepIndex:-1,steps:[],isExpanding:!1,startMarker:null,endMarker:null},e&&e.removePlugin(this)}},{key:"isExpanding",get:function get(){return this.expansionState.isExpanding}},{key:"createExpansionSteps",value:function Snippet_createExpansionSteps_(e){var t=[],n=0;return lively.lang.string.reMatches(e,/\$[0-9]+|\$\{[0-9]+:[^\}]*\}/g).forEach(function(r){var i,o=r.start,a=r.end,s=r.match,l="";if(s.startsWith("${")){var c=s.match(/^\$\{([0-9]+):([^\}]*)\}/),u=slicedToArray(c,3),h=(u[0],u[1]),d=u[2];i=Number(h),l=d}else i=Number(s.replace(/^\$/,""));e=e.slice(0,o-n)+l+e.slice(a-n),t[i]={index:o-n,prefill:l,anchor:null},n+=a-o-l.length}),{steps:t,expansion:e}}},{key:"expandAtCursor",value:function Snippet_expandAtCursor_(e){var t=e,n=t.selection,r=t.cursorPosition.column,i=this.expansion;if(this.trigger&&(r-=this.trigger.length),r=Math.max(0,r)){var o=lively_lang.string.lines(i);i=(o=[o[0]].concat(toConsumableArray(o.slice(1).map(function(e){return lively_lang.string.indent(e," ",r)})))).join("\n")}var a=this.createExpansionSteps(i),s=(i=a.expansion,a.steps);this.trigger&&n.growLeft(this.trigger.length),n.text=i;var l=n.start,c=n.end;if(n.collapseToEnd(),s.length){var u=lively_lang.string.newUUID();s.forEach(function(e,n){return e.anchor=t.addAnchor(Object.assign({id:"snippet-step-"+n+"-"+u},addIndexToTextPos(t,l,e.index)))});var h=t.addAnchor(Object.assign({id:"snippet-start-"+u},l,{insertBehavior:"stay"})),d=t.addAnchor(Object.assign({id:"snippet-end-"+u},c)),p=t.addMarker({id:"snippet-marker-"+u,get range(){return{start:h.position,end:d.position}},style:{"border-radius":"4px","background-color":"rgba(30, 200, 140, 0.3)","box-shadow":"0 0 4px rgba(30, 200, 140, 0.3)","pointer-events":"none",content:"fooooo"}});this.expansionState={marker:p,startAnchor:h,endAnchor:d,stepIndex:0,steps:s,isExpanding:!0},t.addPlugin(this),this.nextStep()}}},{key:"nextStep",value:function Snippet_nextStep_(){var e=this.expansionState,t=e.steps,n=e.stepIndex,r=(e.startAnchor,e.isExpanding),i=this.textMorph;if(r&&i){var o=i.selection,a=t[n],s=a.anchor.position,l=a.prefill;o.lead=o.anchor=s,o.growRight(l.length),this.expansionState.stepIndex++,this.expansionState.stepIndex>=t.length&&(this.resetExpansionState(),console.log("[snippet] expansion of "+this.expansion+" done"))}}},{key:"canExpand",value:function Snippet_canExpand_(e){arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.cursorPosition;var t=e.positionToIndex(e.cursorPosition),n=t-this.trigger.length;return e.textString.slice(n,t)===this.trigger}},{key:"tryTrigger",value:function Snippet_tryTrigger_(e){arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.cursorPosition;return!!this.canExpand(e,e.cursorPosition)&&(this.expandAtCursor(e),!0)}},{key:"getCommands",value:function Snippet_getCommands_(e){var t=this;return e.concat([{name:"[snippet] next expansion step",exec:function exec(e){return t.nextStep(),!0}},{name:"[snippet] cancel expansion",exec:function exec(e){return t.resetExpansionState(),!0}}])}},{key:"getKeyHandlers",value:function Snippet_getKeyHandlers_(e){return e.concat(KeyHandler.withBindings([{keys:"Tab",command:"[snippet] next expansion step"},{keys:"Escape",command:"[snippet] cancel expansion"}]))}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:331,end:5939})}(void 0),occurKeyHandler=Object.assign(KeyHandler.withBindings([{keys:"Escape|Ctrl-G",command:"occur exit"},{keys:"Enter",command:"occur accept"}]),{isOccurHandler:!0}),occurStartCommand={name:"occur",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.needle&&e.addPlugin(new Occur(t)),!!t.needle}};function findOccurPlugin(e){return e.plugins.slice().reverse().find(function(e){return e.isOccurPlugin})}var occurCommands=[{name:"occur exit",exec:function exec(e){var t=findOccurPlugin(e);if(!t)return!1;t.options.translatePosition=!0,e.removePlugin(t);var n=findOccurPlugin(e);return n&&n.highlight(),!0},readOnly:!0},{name:"occur accept",bindKey:"Enter",exec:function exec(e){var t=findOccurPlugin(e);if(!t)return!1;t.options.translatePosition=!0,e.removePlugin(t);var n=findOccurPlugin(e);return n&&n.highlight(),!0},readOnly:!0}],Occur=function(e){var t=_classRecorder,n=t.hasOwnProperty("Occur")&&"function"==typeof t.Occur?t.Occur:t.Occur=function Occur(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Occur_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=e,e.textMorph&&(this.textMorph=e.textMorph)}},{key:"isOccurPlugin",get:function get(){return!0}},{key:"attach",value:function Occur_attach_(e){this.textMorph=e;var t=this.textMorph.cursorPosition;if(this.displayOccurContent(this.options)){var n=this.originalToOccurPosition(t);this.textMorph.cursorPosition=n}return this}},{key:"detach",value:function Occur_detach_(e){this.removeHighlight();var t=this.options.translatePosition&&this.textMorph.cursorPosition,n=t&&this.occurToOriginalPosition(t);return this.displayOriginalContent(),n&&(this.textMorph.cursorPosition=n),this.textMorph=null,this}},{key:"getKeyHandlers",value:function Occur_getKeyHandlers_(e){return e.concat(occurKeyHandler)}},{key:"getCommands",value:function Occur_getCommands_(e){return occurCommands.concat(e)}},{key:"matchingLines",value:function Occur_matchingLines_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{needle:""};if(!e.needle)return[];var t=this.textMorph.document.lineStrings,n=new TextSearcher(this.textMorph).searchForAll(Object.assign({},e,{start:{column:0,row:0}}));return lively_lang.arr.groupBy(n,function(e){return e.range.start.row}).mapGroups(function(e,n){var r=n[0].range.start.row;return{row:r,ranges:n.map(function(e){return e.range}),line:t[r]}}).toArray()}},{key:"displayOccurContent",value:function Occur_displayOccurContent_(e){this._originalDocument=this.textMorph.document;var t=this._originalDocument.constructor,n=this.matchingLines(e),r=n.map(function(e){return e.line}),i=this._document=new t(r);return i._occurMatchingLines=n,n.length>0&&(this.textMorph.changeDocument(i,!0),this.highlight(e.needle),!0)}},{key:"displayOriginalContent",value:function Occur_displayOriginalContent_(){this.textMorph.changeDocument(this._originalDocument)}},{key:"occurToOriginalPosition",value:function Occur_occurToOriginalPosition_(e){var t=this._document._occurMatchingLines;return t&&t[e.row]?{row:t[e.row].row,column:e.column}:e}},{key:"originalToOccurPosition",value:function Occur_originalToOccurPosition_(e){var t=this._document._occurMatchingLines,n={row:0,column:0};if(!t)return n;for(var r=0;r<t.length;r++)if(t[r].row===e.row)return{row:r,column:e.column};return n}},{key:"highlight",value:function Occur_highlight_(e){var t=this;this.removeHighlight();var n={borderRadius:"4px",backgroundColor:"rgba(87, 255, 8, 0.25)",position:"absolute","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box","box-sizing":"border-box","box-shadow":"0 0 4px rgb(91, 255, 50)"};lively_lang.arr.flatmap(this._document._occurMatchingLines,function(e,t){return e.ranges.map(function(e){var n=e.start.column,r=e.end.column;return{start:{column:n,row:t},end:{column:r,row:t}}})}).map(function(e,t){return{id:"occur-"+t,range:e,style:n}}).forEach(function(e){return t.textMorph.addMarker(e)})}},{key:"removeHighlight",value:function Occur_removeHighlight_(){var e=this;(this.textMorph.markers||[]).filter(function(e){return 0===e.id.indexOf("occur-")}).forEach(function(t){return e.textMorph.removeMarker(t)})}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1810,end:5871})}(void 0),TextMap=function(e){var t=_classRecorder,n=t.hasOwnProperty("TextMap")&&"function"==typeof t.TextMap?t.TextMap:t.TextMap=function TextMap(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"onChange",value:function TextMap_onChange_(e){return"extent"===e.prop&&this.update(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onChange",this).call(this,e)}},{key:"reset",value:function TextMap_reset_(){this.border={width:0},this.preserveContents=!0}},{key:"attachTo",value:function TextMap_attachTo_(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.textMorph&&this.detachFrom(this.textMorph),this.textMorph=e,lively_bindings.connect(e,"viewChange",this,"updateDebounced"),lively_bindings.connect(e,"textChange",this,"updateDebounced"),lively_bindings.connect(e,"selectionChange",this,"updateDebounced"),t&&(this.textMorph.addMorph(this),this.height=this.textMorph.height),this.update(),this.makeDirty()}},{key:"detachFromCurrentTextMorph",value:function TextMap_detachFromCurrentTextMorph_(){this.detachFrom(this.textMorph),this.textMorph=null}},{key:"detachFrom",value:function TextMap_detachFrom_(e){var t=this;e&&e.attributeConnections.forEach(function(e){return e.targetObj===t&&e.disconnect()})}},{key:"updateDebounced",value:function TextMap_updateDebounced_(){var e=this;this.owner===this.textMorph&&(this.topRight=this.textMorph.innerBounds().topRight().addPt(this.textMorph.scroll)),lively_lang.fun.throttleNamed("update-"+this.id,100,function(){return e.update()})()}},{key:"measure",get:function get(){var e=this.width,t=this.height,n=this.textMorph.document;return{width:e,height:t,heightPerLine:Math.min(2,t/n.lines.length),widthPerChar:.5}}},{key:"update",value:function TextMap_update_(){var e=this.context,t=this.textMorph,n=this.measure,r=n.width,i=n.height,o=n.heightPerLine,a=n.widthPerChar,s=t.document,l=t.textLayout,c=t.markers,u=t.selections,h=l.whatsVisible(t),d=h.startRow,p=h.endRow;if(this.owner===t&&(this.topRight=this.textMorph.innerBounds().topRight().addPt(this.textMorph.scroll)),e){this.clear(null),e.fillStyle="rgba(0,0,0, 0.1)",e.fillRect(0,0,r,d*o),e.fillStyle="rgba(0,0,0, 0.1)",e.fillRect(0,p*o,r,i-p*o);var f=0;e.beginPath(),e.lineWidth=Math.max(1,o-.3),e.strokeStyle="gray";var g=!0,m=!1,v=void 0;try{for(var y,_=s.lines[Symbol.iterator]();!(g=(y=_.next()).done);g=!0){var b=y.value.text,x=b.length,w=b.trimLeft().length,k=x-w;e.moveTo(k,f),e.lineTo(k+w*a,f),k=0,f+=o}}catch(e){m=!0,v=e}finally{try{!g&&_.return&&_.return()}finally{if(m)throw v}}e.stroke(),e.beginPath(),e.strokeStyle="black",e.moveTo(0,d*o),e.lineTo(r,d*o),e.moveTo(0,p*o),e.lineTo(r,p*o),e.stroke(),e.fillStyle="blue";var S=!0,C=!1,M=void 0;try{for(var T,P=u[Symbol.iterator]();!(S=(T=P.next()).done);S=!0){var A=T.value;A.isEmpty()||highlighRange(A,"blue",!0)}}catch(e){C=!0,M=e}finally{try{!S&&P.return&&P.return()}finally{if(C)throw M}}var L=!0,R=!1,E=void 0;try{for(var O,z=c[Symbol.iterator]();!(L=(O=z.next()).done);L=!0){var D=O.value,I=D.style["background-color"]||"red";if("string"==typeof I){var F=lively_graphics.Color.fromString(I);F&&F.a<.5&&(F.a=.9,I=F.toRGBAString())}highlighRange(D.range,I,!0)}}catch(e){R=!0,E=e}finally{try{!L&&z.return&&z.return()}finally{if(R)throw E}}}function highlighRange(t,n){arguments.length>2&&void 0!==arguments[2]&&arguments[2];var i=t.start,a=t.end,s=Math.max((a.row-i.row+1)*o,1);e.fillStyle=n,e.fillRect(0,i.row*o,r,s)}}},{key:"onMouseDown",value:function TextMap_onMouseDown_(e){var t=this,n=this.textMorph,r=this.measure,i=(r.width,r.height,r.heightPerLine),o=e.positionIn(this),a=Math.round(o.y/i);n.scrollPositionIntoView({row:a,column:0}),lively_lang.promise.delay(100).then(function(){return t.update()})}},{key:"onDrag",value:function TextMap_onDrag_(e){this.onMouseDown(e)}}],[{key:"openInside",value:function TextMap_openInside_(e){var t=new TextMap;return t.attachTo(e),t}},{key:"properties",get:function get(){return{textMorph:{},relativeBoundsInTextMorph:{},extent:{defaultValue:lively_graphics.pt(60,50)},markers:{}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:202,end:4959})}({referencedAs:"Canvas",value:lively_components_canvas_js.Canvas}),TextSearcher=function(e){var t=_classRecorder,n=t.hasOwnProperty("TextSearcher")&&"function"==typeof t.TextSearcher?t.TextSearcher:t.TextSearcher=function TextSearcher(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TextSearcher_initialize_(e){this.morph=e,this.STOP={}}},{key:"doc",get:function get(){return this.morph.document}},{key:"processFind",value:function TextSearcher_processFind_(e,t){var n=this.doc.positionToIndex(e);return{range:{start:e,end:this.doc.indexToPosition(n+t.length)},match:t}}},{key:"stringSearch",value:function TextSearcher_stringSearch_(e,t,n,r,i,o,a){if(i&&(lessPosition(a,i.start)||lessPosition(i.end,a)))return this.STOP;if(n||(o=o.toLowerCase()),o!==t[0])return null;var s=a.row,l=a.column,c=e[s],u=r<=1?"":"\n"+e.slice(s+1,s+1+(r-1)).join("\n"),h=c.slice(l)+u;return 0!==(n?h:h.toLowerCase()).indexOf(t)?null:this.processFind({row:s,column:l},h.slice(0,t.length))}},{key:"reSearch",value:function TextSearcher_reSearch_(e,t,n,r,i,o){if(r&&(lessPosition(o,r.start)||lessPosition(r.end,o)))return this.STOP;var a=o.row,s=o.column,l=(e[a].slice(s)+(n?"\n"+e.slice(a+1).join("\n"):"")).match(t);return l?this.processFind({row:a,column:s},l[0]):null}},{key:"search",value:function TextSearcher_search_(e){var t,n=Object.assign({start:this.morph.cursorPosition,needle:"",backwards:!1,caseSensitive:!1,inRange:null},e),r=n.start,i=n.needle,o=n.backwards,a=n.caseSensitive,s=n.inRange;if(!i)return null;if(s&&(r=o?minPosition(s.end,r):maxPosition(s.start,r)),i instanceof RegExp){var l=(i.flags||"").split(""),c=!!i.multiline;l.splice(l.indexOf("m"),1),a||l.includes("i")||l.push("i"),i=new RegExp("^"+i.source.replace(/^\^+/,""),l.join("")),t=this.reSearch.bind(this,this.doc.lineStrings,i,c,s)}else{i=String(i),a||(i=i.toLowerCase());var u=i.split(this.doc.constructor.newline).length;t=this.stringSearch.bind(this,this.doc.lineStrings,i,a,u,s)}var h=this.doc[o?"scanBackward":"scanForward"](r,t);return h===this.STOP?null:h}},{key:"searchForAll",value:function TextSearcher_searchForAll_(e){for(var t=[],n=0;;){if(n++>1e4)throw new Error("endless loop");var r=this.search(e);if(!r)return t;t.push(r),e=Object.assign({},e,{start:e.backwards?r.range.start:r.range.end})}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:584,end:3725})}(void 0),SearchWidget=function(e){var t=_classRecorder,n=t.hasOwnProperty("SearchWidget")&&"function"==typeof t.SearchWidget?t.SearchWidget:t.SearchWidget=function SearchWidget(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SearchWidget_initialize_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t.targetText&&(t.target=t.targetText),!t.target)throw new Error("SearchWidget needs a target text morph!");lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,t);var r,i=this.getSubmorphNamed("replaceButton"),o=this.getSubmorphNamed("replaceAllButton"),a=(this.getSubmorphNamed("replaceInput"),this.getSubmorphNamed("searchInput")),s=this.getSubmorphNamed("prevButton"),l=this.getSubmorphNamed("nextButton"),c=this.getSubmorphNamed("cancelButton"),u=this.getSubmorphNamed("acceptButton");lively_bindings.connect(u,"fire",this,"execCommand",{converter:function converter(){return"accept search"}}),lively_bindings.connect(c,"fire",this,"execCommand",{converter:function converter(){return"cancel search"}}),lively_bindings.connect(l,"fire",this,"execCommand",{converter:function converter(){return"search next"}}),lively_bindings.connect(s,"fire",this,"execCommand",{converter:function converter(){return"search prev"}}),lively_bindings.connect(a,"inputChanged",this,"search"),lively_bindings.connect(i,"fire",this,"execCommand",{converter:function converter(){return"replace and go to next"}}),lively_bindings.connect(o,"fire",this,"execCommand",{converter:function converter(){return"replace all"}}),this.state={backwards:!1,before:null,position:null,inProgress:null,last:null},a.addCommands([{name:"realign top-bottom-center",exec:(r=asyncToGenerator(regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return e.target.execCommand("realign top-bottom-center"),e.addSearchMarkersForPreview(e.state.inProgress&&e.state.inProgress.found,!1),t.abrupt("return",!0);case 3:case"end":return t.stop()}},_callee,e)})),function exec(){return r.apply(this,arguments)})}])}},{key:"focus",value:function SearchWidget_focus_(){var e=this;this.get("searchInput").focus(),this.whenRendered().then(function(){return e.get("searchInput").invalidateTextLayout(!0,!0)})}},{key:"onBlur",value:function SearchWidget_onBlur_(e){var t=this,n=this.world();n&&setTimeout(function(){var e=n.focusedMorph;t.withAllSubmorphsDetect(function(e){return e.isFocused()})?t.get("searchInput")!=e&&t.get("replaceInput")!=e&&t.get("searchInput").focus():t.cancelSearch()})}},{key:"cleanup",value:function SearchWidget_cleanup_(){this.removeSearchMarkers(),this.state.inProgress=null,this.textMap&&this.textMap.update()}},{key:"cancelSearch",value:function SearchWidget_cancelSearch_(){if(this.state.inProgress&&(this.state.last=this.state.inProgress),this.cleanup(),this.removeTextMap(),this.state.before){var e=this.state.before,t=e.scroll,n=e.selectionRange;this.target.selection=n,this.target.scroll=t,this.state.before=null}this.remove(),this.target.focus()}},{key:"acceptSearch",value:function SearchWidget_acceptSearch_(){this.state.inProgress&&(this.state.last=this.state.inProgress),this.applySearchResult(this.state.inProgress)&&this.state.before&&this.target.saveMark(this.state.before.position),this.get("searchInput").acceptInput(),this.cleanup(),this.removeTextMap(),this.state.before=null,this.remove(),this.target.focus()}},{key:"applySearchResult",value:function SearchWidget_applySearchResult_(e){if(!e||!e.found)return null;var t=this.target,n=t.selection,r=!!t.activeMark||!n.isEmpty(),i=e.backwards,o=e.found.range,a=o.start,s=o.end,l=i?a:s;return r?n.lead=l:t.cursorPosition=l,t.isLineFullyVisible(l.row)||t.centerRow(),e}},{key:"removeSearchMarkers",value:function SearchWidget_removeSearchMarkers_(){var e=this;(this.target.markers||[]).forEach(function(t){var n=t.id;return n.startsWith("search-highlight")&&e.target.removeMarker(n)})}},{key:"addSearchMarkers",value:function SearchWidget_addSearchMarkers_(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.removeSearchMarkers();var n=this.target,r=this.textMap,i=n.whatsVisible,o=i.startRow,a=i.endRow,s=n.document.lineStrings,l=0,c=config$1.codeEditor.search,u=c.maxCharsPerLine,h=c.fastHighlightLineCount;r&&e.match.length>=3&&s.length<h&&(o=0,a=s.length-1);for(var d,p=!1,f=window.performance.now(),g=o;g<=a&&!p;g++)for(var m=s[g]||"",v=0;v<Math.min(m.length,u);v++){if(window.performance.now()-f>300){p=!0;break}(t?0===m.slice(v).indexOf(e.match):0===m.slice(v).toLowerCase().indexOf(e.match.toLowerCase()))&&(n.addMarker({id:"search-highlight-"+l++,range:{start:{row:g,column:v},end:{row:g,column:v+e.match.length}},style:{"border-radius":"4px","background-color":"rgba(255, 200, 0, 0.3)","box-shadow":"0 0 4px rgba(255, 200, 0, 0.3)","pointer-events":"none"}}),v+=e.match.length)}if(this.state.backwards){var y=e.range.start,_=y.row,b=y.column;d={start:{row:_,column:b},end:{row:_,column:b+1}}}else{var x=e.range.end,w=x.row,k=x.column;d={start:{row:w,column:k-1},end:{row:w,column:k}}}n.addMarker({id:"search-highlight-cursor",range:d,style:defineProperty({"pointer-events":"none","box-sizing":"border-box"},this.state.backwards?"border-left":"border-right","3px red solid")}),r&&r.update()}},{key:"addSearchMarkersForPreview",value:function SearchWidget_addSearchMarkersForPreview_(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e&&(this.addSearchMarkers(e),t&&this.target.removeMarker("search-highlight-cursor"))}},{key:"prepareForNewSearch",value:function SearchWidget_prepareForNewSearch_(){var e=this.target,t=this.state,n=e.world();if(n){this.openInWorld(n.visibleBounds().center(),n),this.topRight=e.globalBounds().insetBy(5).topRight(),e.getWindow()&&lively_bindings.once(e.getWindow(),"remove",this,"remove");var r=this.get("searchInput"),i=e.scroll,o=e.selection;t.position=o.lead,t.before={scroll:i,position:o.lead,selectionRange:o.range,selectionReverse:o.isReverse()},t.last&&t.last.found&&(lively_bindings.disconnect(r,"inputChanged",this,"search"),this.input=t.last.needle,lively_bindings.connect(r,"inputChanged",this,"search"),this.addSearchMarkersForPreview(t.last.found)),this.focus(),r.selectAll()}}},{key:"advance",value:function SearchWidget_advance_(e){var t=this.state.inProgress;if(t&&t.found){var n=e!==this.state.backwards,r=t.found.range,i=r.start,o=r.end;this.state.position=n?e?o:i:e?i:o}return this.state.backwards=e,this.search()}},{key:"searchNext",value:function SearchWidget_searchNext_(){return this.advance(!1)}},{key:"searchPrev",value:function SearchWidget_searchPrev_(){return this.advance(!0)}},{key:"search",value:function SearchWidget_search_(){if(!this.input)return this.cleanup(),null;var e=this.state,t=e.backwards,n=(e.inProgress,{backwards:t,start:e.position}),r=this.target.search(this.input,n),i=this.state.inProgress=Object.assign({},n,{needle:this.input,found:r});return this.applySearchResult(i),r?this.addSearchMarkers(r,t):this.cleanup(),i}},{key:"showTextMap",value:function SearchWidget_showTextMap_(){var e=this.textMap=new TextMap;return e.attachTo(this.target),e.isLayoutable=!1,this.addMorph(e),e.topRight=this.innerBounds().bottomRight().addXY(0,5),e.height=this.target.height-this.height-15,e.update(),e}},{key:"removeTextMap",value:function SearchWidget_removeTextMap_(){this.textMap&&(this.textMap.remove(),this.textMap.detachFromCurrentTextMorph(),this.textMap=null)}},{key:"keybindings",get:function get(){return[{keys:"Enter",command:"accept search or replace and go to next"},{keys:"Tab",command:"change focus"},{keys:"Ctrl-O",command:"occur with search term"},{keys:"Ctrl-W",command:"yank next word from text"},{keys:"Escape|Ctrl-G",command:"cancel search"},{keys:{win:"Ctrl-F|Ctrl-S|Ctrl-G",mac:"Meta-F|Ctrl-S|Meta-G"},command:"search next"},{keys:{win:"Ctrl-Shift-F|Ctrl-R|Ctrl-Shift-G",mac:"Meta-Shift-F|Ctrl-R|Meta-Shift-G"},command:"search prev"}]}},{key:"commands",get:function get(){var e=this;return[{name:"occur with search term",exec:function exec(){return e.target.addCommands([occurStartCommand]),e.execCommand("accept search"),e.target.execCommand("occur",{needle:e.input})}},{name:"accept search",exec:function exec(){return e.acceptSearch(),!0}},{name:"cancel search",exec:function exec(){return e.cancelSearch(),!0}},{name:"search next",exec:function exec(){return e.searchNext(),!0}},{name:"search prev",exec:function exec(){return e.searchPrev(),!0}},{name:"accept search or replace and go to next",exec:function exec(t,n,r){return e.execCommand(e.get("replaceInput").isFocused()?"replace and go to next":"accept search",n,r)}},{name:"replace current search location with replace input",exec:function exec(){var t=lively_lang.Path("state.inProgress").get(e);if(t.found){var n=e.get("replaceInput").textString;e.get("replaceInput").get("replaceInput").acceptInput(),t.needle instanceof RegExp&&(n=t.found.match.replace(t.needle,n)),e.target.replace(t.found.range,n)}return!0}},{name:"replace and go to next",exec:function exec(){return e.execCommand("replace current search location with replace input"),e.execCommand(e.state.backwards?"search prev":"search next"),!0}},{name:"replace all",exec:function exec(){var t=lively_lang.Path("state.inProgress").get(e);if(t.found){t=Object.assign({},t,{start:{row:0,column:0}});var n=e.get("replaceInput").textString;e.get("replaceInput").get("replaceInput").acceptInput();var r=new TextSearcher(e.target).searchForAll(t);e.target.undoManager.group(),r.forEach(function(r){var i=r.range,o=r.match;t.needle instanceof RegExp&&(n=o.replace(t.needle,n)),e.target.replace(i,n,!0,!0,!1)}),e.target.undoManager.group(),e.acceptSearch()}return!0}},{name:"change focus",exec:function exec(){return e.get("searchInput").isFocused()?e.get("replaceInput").focus():e.get("searchInput").focus(),!0}},{name:"yank next word from text",exec:function exec(){var t=e.target,n=t.wordRight(),r=e.get("searchInput");r.selection.isEmpty()||(r.selection.text="");var i=t.textInRange({start:t.cursorPosition,end:n.range.end});return r.textString+=i,!0}}]}}],[{key:"properties",get:function get(){return{name:{defaultValue:"search widget"},borderWidth:{defaultValue:1},borderColor:{defaultValue:lively_graphics.Color.gray},borderRadius:{defaultValue:3},fill:{defaultValue:lively_graphics.Color.black.withA(.6)},target:{},state:{},input:{after:["submorphs"],get:function get(){var e=this.get("searchInput").textString,t=e.match(/^\/(.*)\/([a-z]*)$/);return t?new RegExp(t[1],t[2]):e},set:function set(e){this.get("searchInput").textString=String(e)}},fontSize:{after:["submorphs"],get:function get(){return this.get("searchInput").fontSize},set:function set(e){this.get("replaceInput").fontSize=e}},fontFamily:{after:["submorphs"],get:function get(){return this.get("searchInput").fontFamily},set:function set(e){this.get("searchInput").fontFamily=e,this.get("replaceInput").fontFamily=e}},styleSheets:{initialize:function initialize(){this.styleSheets=new StyleSheet({".Button.nav":{extent:lively_graphics.pt(24,24),opacity:.9,borderWidth:0,fill:lively_graphics.Color.transparent},".Button.nav [name=label]":{fontSize:18,fontColor:lively_graphics.Color.white},".Button.replace":{borderWidth:2,borderColor:lively_graphics.Color.white,fill:lively_graphics.Color.transparent},".Button.replace [name=label]":{fontColor:lively_graphics.Color.white},".InputLine [name=placeholder]":{fontSize:12,fontFamily:"Monaco, monospace"},".InputLine":{fill:lively_graphics.Color.gray.withA(.2),fontSize:12,fontFamily:"Monaco, monospace",fontColor:lively_graphics.Color.white,borderWidth:1,borderColor:lively_graphics.Color.gray,padding:lively_graphics.Rectangle.inset(2)}})}},layout:{initialize:function initialize(){this.layout=new GridLayout({groups:{nextButton:{resize:!1},prevButton:{resize:!1},acceptButton:{resize:!1},cancelButton:{resize:!1}},rows:[0,{fixed:28,paddingTop:5,paddingBottom:2.5},1,{fixed:28,paddingTop:2.5,paddingBottom:5}],columns:[0,{paddingLeft:5,paddingRight:5},1,{fixed:25},2,{fixed:25},3,{fixed:5},4,{fixed:25},5,{fixed:25},6,{fixed:10}],grid:[["searchInput","nextButton","prevButton",null,"acceptButton","cancelButton",null],["replaceInput","replaceButton","replaceButton",null,"replaceAllButton","replaceAllButton",null]]})}},submorphs:{after:["extent"],initialize:function initialize(){this.submorphs=[new lively_components_buttons_js.Button({name:"acceptButton",label:Icon.textAttribute("check-circle-o"),styleClasses:["nav"]}).fit(),new lively_components_buttons_js.Button({name:"cancelButton",label:Icon.textAttribute("times-circle-o"),styleClasses:["nav"]}).fit(),new lively_components_buttons_js.Button({name:"nextButton",label:Icon.textAttribute("arrow-circle-o-down"),styleClasses:["nav"]}).fit(),new lively_components_buttons_js.Button({name:"prevButton",label:Icon.textAttribute("arrow-circle-o-up"),styleClasses:["nav"]}).fit(),Text.makeInputLine({name:"searchInput",clipMode:"hidden",width:this.width,height:20,placeholder:"search input",historyId:"lively.morphic-text search"}),Text.makeInputLine({name:"replaceInput",clipMode:"hidden",width:this.width,height:20,placeholder:"replace input",historyId:"lively.morphic-text replace"}),new lively_components_buttons_js.Button({styleClasses:["replace"],name:"replaceButton",label:"replace",fontSize:10,extent:lively_graphics.pt(60,17)}),new lively_components_buttons_js.Button({styleClasses:["replace"],name:"replaceAllButton",label:"replace all",fontSize:10,extent:lively_graphics.pt(60,17)})],lively_bindings.connect(this.get("searchInput"),"onBlur",this,"onBlur"),lively_bindings.connect(this.get("replaceInput"),"onBlur",this,"onBlur")}},textMap:{after:["submorphs"]}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:3845,end:21838})}({referencedAs:"Morph",value:Morph}),searchCommands=[{name:"search in text",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{backwards:!1},n=e._searchWidget||(e._searchWidget=new SearchWidget({target:e,extent:lively_graphics.pt(300,20)}));return n.state.backwards=t.backwards,n.prepareForNewSearch(),config$1.codeEditor.search.showTextMap&&n.showTextMap(),!0}}];function todo(e){throw new Error("not yet implemented "+e)}var TextLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("TextLayout")&&"function"==typeof t.TextLayout?t.TextLayout:t.TextLayout=function TextLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TextLayout_initialize_(){this.reset()}},{key:"reset",value:function TextLayout_reset_(){this.resetLineCharBoundsCache()}},{key:"resetLineCharBoundsCache",value:function TextLayout_resetLineCharBoundsCache_(e){this.lineCharBoundsCache=new WeakMap,e&&!e._isDeserializing&&(this.estimateLineHeights(e),e.makeDirty())}},{key:"resetLineCharBoundsCacheOfLine",value:function TextLayout_resetLineCharBoundsCacheOfLine_(e){e&&this.lineCharBoundsCache.set(e,null)}},{key:"resetLineCharBoundsCacheOfRow",value:function TextLayout_resetLineCharBoundsCacheOfRow_(e,t){var n=e.document;n&&this.resetLineCharBoundsCacheOfLine(n.getLine(t))}},{key:"resetLineCharBoundsCacheOfRange",value:function TextLayout_resetLineCharBoundsCacheOfRange_(e,t){for(var n=t.start.row;n<=t.end.row;n++)this.resetLineCharBoundsCacheOfRow(e,n)}},{key:"estimateLineHeightsInRange",value:function TextLayout_estimateLineHeightsInRange_(e,t){for(var n=e.document,r=e.getGlobalTransform(),i=t.start.row;i<=t.end.row;i++)this.resetLineCharBoundsCacheOfRow(e,n.getLine(i),r)}},{key:"estimateExtentOfLine",value:function TextLayout_estimateExtentOfLine_(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getGlobalTransform(),i=e.fontMetric,o=e.lineWrapping,a=e.extent,s=a.x,l=(a.y,e.padding),c=e.textRenderer,u=e.debug,h=e.defaultTextStyle,d=l.left(),p=l.right(),f=l.top(),g=l.bottom(),m=c.directRenderTextLayerFn(e),v=t.textAndAttributes,y=[];if(s=s-d-p,v&&v.length)for(var _=0,b=0;_<v.length;_+=2)(n=v[_])&&n.isMorph?(n.position=this.pixelPositionFor(e,{row:t.row,column:b}).subPt(e.origin),b++):n&&(b+=n.length),y.push(Object.assign({},h,{},v[_+1]));else y.push(h);for(var x=y.length,w=0,k=0,S=0;S<x;S++){var C=i.defaultCharExtent(e,{defaultTextStyle:y[S],width:1e3,transform:r,paddingBottom:g,paddingTop:f,paddingRight:p,paddingLeft:d},m),M=C.width,T=C.height;k=Math.max(T,k),w+=M}var P=k,A=t.text.length||1,L=Math.round(w/x),R=A*L,E=o?Math.min(R,s):R;if(o){var O=Math.max(3,s/L),z=Math.ceil(A/O)||1;P=Math.round(z*k)}u&&console.log(t.row+": "+t.height+" => "+P),t.changeExtent(E,P,!0)}},{key:"estimateLineHeights",value:function TextLayout_estimateLineHeights_(e,t){var n=e.fontMetric,r=e.textRenderer,i=e.document,o=e.defaultTextStyle,a=e.extent,s=a.x,l=a.y,c=e.clipMode,u=e.textAlign,h=e.padding,d=e.lineWrapping,p=e.debug,f=e.getGlobalTransform(),g=h.left(),m=h.right(),v=h.top(),y=h.bottom(),_=i.lines,b=(i.stringSize,r.directRenderTextLayerFn(e));if(p&&((p=e.debugHelper(p)).debugTextLayout||(p=!1)),!p&&e.lineCount()<10&&e.document.stringSize<3e3&&!lively_lang.arr.any(e.textAndAttributes,function(e){return e&&void 0!=e.fontFamily}))for(var x=r.directRenderLineFn(e),w=n.manuallyComputeBoundsOfLines(e,_,0,0,{defaultTextStyle:o,width:s,height:l,clipMode:c,lineWrapping:d,textAlign:u,transform:f,paddingLeft:g,paddingRight:m,paddingTop:v,paddingBottom:y},b,x),k=0;k<_.length;k++){var S=w[k],C=S.width,M=S.height;_[k].changeExtent(C,M,!1)}else{var T=0;for(k=0;k<_.length;k++){var P=_[k];!t&&P.height>0||(T++,this.estimateExtentOfLine(e,P,f))}e.viewState._textLayoutStale=!1,p&&p.log("estimateLineHeights, "+T+"/"+_.length+" updated, force: "+t)}}},{key:"defaultCharExtent",value:function TextLayout_defaultCharExtent_(e){var t=e.textRenderer,n=e.fontMetric,r=e.defaultTextStyle,i=e.getGlobalTransform(),o=t.directRenderTextLayerFn(e);return n.defaultCharExtent(e,{transform:i,defaultTextStyle:r,width:1e3},o)}},{key:"textBounds",value:function TextLayout_textBounds_(e){var t=e.document,n=e.padding,r=e.borderWidthLeft,i=e.borderWidthRight,o=e.borderWidthTop,a=e.borderWidthBottom;return new lively_graphics.Rectangle(n.left(),n.top(),t.width+r+i,t.height+o+a)}},{key:"isFirstLineVisible",value:function TextLayout_isFirstLineVisible_(e){return e.viewState.firstVisibleRow<=0}},{key:"isLastLineVisible",value:function TextLayout_isLastLineVisible_(e){return e.viewState.lastVisibleRow>=e.lineCount()-1}},{key:"isLineVisible",value:function TextLayout_isLineVisible_(e,t){return t>=e.viewState.firstVisibleRow&&t<=e.viewState.lastVisibleRow}},{key:"isLineFullyVisible",value:function TextLayout_isLineFullyVisible_(e,t){return t>=e.viewState.firstFullyVisibleRow&&t<=e.viewState.lastFullyVisibleRow}},{key:"whatsVisible",value:function TextLayout_whatsVisible_(e){var t=e.viewState.firstVisibleRow,n=e.viewState.lastVisibleRow;return{lines:e.document.lines.slice(t,n),startRow:t,endRow:n}}},{key:"firstFullVisibleLine",value:function TextLayout_firstFullVisibleLine_(e){return e.viewState.firstFullyVisibleRow}},{key:"lastFullVisibleLine",value:function TextLayout_lastFullVisibleLine_(e){return e.viewState.lastFullyVisibleRow}},{key:"screenLineRange",value:function TextLayout_screenLineRange_(e,t,n){var r=t.row,i=t.column;i=Math.max(0,i),r=Math.min(e.lineCount()-1,Math.max(0,r));var o=this.charBoundsOfRow(e,r);i>o.length-1&&(i=o.length-1);for(var a=o[i],s=i,l=i,c=i+1;c<o.length&&!(o[c].y+o[c].height>a.y+a.height);c++)l=c;l===o.length-1&&l++;for(c=i-1;c>=0&&!(o[c].y+o[c].height<a.y+a.height);c--)s=c;n&&(s+=e.getLine(r).slice(s,l).match(/^\s*/)[0].length);return new Range({start:{row:r,column:s},end:{row:r,column:l}})}},{key:"rangesOfWrappedLine",value:function TextLayout_rangesOfWrappedLine_(e,t){for(var n=e.getLine(t).length,r=0,i=[];;){var o=this.screenLineRange(e,{row:t,column:r},!1);if(i.push(o),o.end.column>=n)break;var a=o.end.column+1;if(a>=n)break;if(a<=r)throw new Error("should not happen "+o.end.column+" vs "+r);r=a}return i}},{key:"chunkAtPos",value:function TextLayout_chunkAtPos_(e,t){todo("chunkAtPos")}},{key:"charBoundsOfRow",value:function TextLayout_charBoundsOfRow_(e,t){var n=e.document.getLine(t),r=this.lineCharBoundsCache.get(n);if(r)return r;var i=e.fontMetric,o=e.textRenderer,a=e.defaultTextStyle,s=e.extent,l=s.x,c=s.y,u=e.clipMode,h=e.textAlign,d=e.padding,p=e.lineWrapping,f=e.getGlobalTransform(),g=d.left(),m=d.right(),v=d.top(),y=d.bottom(),_=o.directRenderLineFn(e),b=o.directRenderTextLayerFn(e),x=i.manuallyComputeCharBoundsOfLine(e,n,0,0,{defaultTextStyle:a,width:l,height:c,clipMode:u,lineWrapping:p,textAlign:h,paddingLeft:g,paddingRight:m,paddingTop:v,paddingBottom:y,transform:f},b,_);return this.lineCharBoundsCache.set(n,x),x}},{key:"computeMaxBoundsForLineSelection",value:function TextLayout_computeMaxBoundsForLineSelection_(e,t){var n=t.start,r=t.end,i=e.textLayout,o=(r=(r=e.lineWrapping?i.rangesOfWrappedLine(e,n.row).find(function(e){return e.containsPosition(n)}).end:r).row==n.row?r:{row:r.row,column:-1},i.charBoundsOfRow(e,n.row)),a=(o=r.column<0?o.slice(n.column):o.slice(n.column,r.column+1),n.column+(o?o.indexOf(lively_lang.arr.max(o,function(e){return e.height})):0));return i.boundsFor(e,{row:n.row,column:a})}},{key:"boundsFor",value:function TextLayout_boundsFor_(e,t){var n=t.row,r=t.column;r=Math.max(0,r),n=Math.min(e.lineCount()-1,Math.max(0,n));var i=this.charBoundsOfRow(e,n),o=void 0;if(i.length>0)if(r>=i.length){var a=i[i.length-1],s=a.x,l=a.y,c=a.width,u=a.height;o=new lively_graphics.Rectangle(s+c,l,0,u)}else o=lively_graphics.Rectangle.fromLiteral(i[r]);o||(console.warn("Cannot compute bounds for line "+n+"/"+r),o=new lively_graphics.Rectangle(0,0,0,0));var h=e.document,d=e.padding;return o.x=o.x+d.left(),o.y=o.y+h.computeVerticalOffsetOf(n)+d.top(),o}},{key:"pixelPositionFor",value:function TextLayout_pixelPositionFor_(e,t){return this.boundsFor(e,t).topLeft()}},{key:"textPositionFromPoint",value:function TextLayout_textPositionFromPoint_(e,t){var n=t.addPt(e.origin),r=n.x,i=n.y,o=e.document,a=e.padding,s=(e.origin,a.left()),l=a.top();if(i>o.height+l)return o.endPosition;if(i<l)return{row:0,column:0};var c=o.findLineByVerticalOffset(i-l);if(!c)return{row:0,column:0};var u=c.line.row,h=this.charBoundsOfRow(e,u),d=h.length,p=h[0],f=h[d-1],g={row:u,column:0};if(r-=s,i-=l+o.computeVerticalOffsetOf(u),0===d||r<=p.x+Math.round(p.width/2)&&i>=p.y&&i<=p.y+p.height)return g;if(r>f.x+Math.round(f.width/2)&&i>=f.y&&i<=f.y+f.height)return g.column=d,g;for(var m=[],v=d-1;v>=0;v--){var y=(C=h[v]).x,_=C.width,b=C.y,x=C.height;if(!(i<b||i>b+x)&&(m.push(C),r>=y+Math.round(_/2))){var w=1===m.length;return g.column=w?v:v+1,g}}if(m.length)return g.column=h.indexOf(lively_lang.arr.last(m)),g;var k=1/0,S=-1;for(v=0;v<h.length;v++){y=(C=h[v]).x,_=C.width,b=C.y,x=C.height;var C,M=t.distSquared(lively_graphics.pt(y+_/2,b+x/2));M>=k||(k=M,S=v)}return g.column=S,g}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:274,end:15424})}(void 0),cssInstalled=!1,debug$1=!!config$1.onloadURLQuery["debug-text"];function printViewState(e){var t=e.viewState,n=t.scrollTop,r=t.scrollHeight,i=(t.heightBefore,t.textHeight),o=t.firstVisibleRow,a=t.lastVisibleRow,s=(t.firstFullyVisibleRow,t.lastFullyVisibleRow,t.visibleLines,e.document.lines);console.log(e+" #"+e.id.slice(0,12)+"\nscroll: "+n+" + "+r+"\nlines: "+o+" - "+a+"\nheight: "+i+", "+s.length+" lines")}function installCSS(e){cssInstalled=!0,addOrChangeCSSDeclaration("new-text-css","\n\n    /* markers */\n\n    .newtext-marker-layer {\n      position: absolute;\n    }\n\n    /* selection / cursor */\n\n    .newtext-cursor {\n      z-index: 5;\n      pointer-events: none;\n      position: absolute;\n      background-color: black;\n    }\n\n    .hidden-cursor .newtext-cursor {\n      background-color: transparent !important;\n    }\n\n    .newtext-cursor.diminished {\n      background-color: gray;\n    }\n\n    .newtext-selection-layer {\n      position: absolute;\n    }\n\n    /*-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-*/\n    /* text layer / content */\n\n    .newtext-text-layer {\n      box-sizing: border-box;\n      position: absolute;\n      white-space: pre;\n      z-index: 0;\n      min-width: 100%;\n    }\n\n    .newtext-before-filler {}\n\n    .newtext-text-layer.wrap-by-words {\n      white-space: pre-wrap;\n      overflow-wrap: break-word;\n      max-width: 100%;\n    }\n\n    .newtext-text-layer.only-wrap-by-words {\n      white-space: pre-wrap;\n      overflow-wrap: break-all;\n      max-width: 100%;\n    }\n\n    .newtext-text-layer.wrap-by-chars {\n      white-space: pre-wrap;\n      word-break: break-all;\n      max-width: 100%;\n    }\n\n    .newtext-text-layer.no-wrapping {\n    }\n\n    .newtext-text-layer .line {\n      -moz-border-radius: 0;\n      -webkit-border-radius: 0;\n      border-radius: 0;\n      border-width: 0;\n      background: transparent;\n      font-family: inherit;\n      font-size: inherit;\n      margin: 0;\n      word-wrap: normal;\n      line-height: inherit;\n      color: inherit;\n      position: relative;\n      overflow: visible;\n      -webkit-tap-highlight-color: transparent;\n      -webkit-font-variant-ligatures: contextual;\n      font-variant-ligatures: contextual;\n    }\n\n    .line > .Morph {\n      display: inline-block !important;\n      vertical-align: top !important;\n    }\n\n    blockquote {\n      margin: 0;\n      -webkit-margin-start: 0;\n      -webkit-margin-end: 0;\n    }\n\n    .newtext-text-layer blockquote {\n      margin-left: 2em;\n      margin-right: 2em;\n      border-left: 2px lightgray solid;\n      padding-left: 2%;\n    }\n\n    /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-*/\n    /* debug styling */\n\n    .debug-info {\n      position: absolute;\n      outline: 1px solid green;\n      pointer-events: none;\n      z-index: 4;\n      text-align: center;\n      font-family: monospace;\n      color: green;\n      background-color: white;\n      font-size: small;\n      vertical-align: baseline;\n    }\n\n    .debug-line {\n      position: absolute;\n      outline: 1px solid red;\n      pointer-events: none;\n      z-index: 4,\n      text-align: right;\n      font-family: monospace;\n      font-size: small;\n      vertical-align: baseline;\n      color: red;\n    }\n\n    .debug-char {\n      position: absolute;\n      outline: 1px solid orange;\n      pointer-events: none;\n      z-index: 3\n    }\n\n  ",e.document)}var nextTick=function(e,t,n,r,i,o){for(;!i&&n<t.length;)i=e[t[n++]+"equestAnimationFrame"];return i&&i.bind(e)||e.setImmediate||function(t){e.setTimeout(t,0)}}("undefined"!=typeof window?window:global,"r webkitR mozR msR oR".split(" "),0);function AfterTextRenderHook(){}AfterTextRenderHook.prototype.reset=function(e){this.morph=e,this.called=!1,this.needsRerender=!1},AfterTextRenderHook.prototype.updateLineHeightOfNode=function(e,t,n){if(0===t.height||t.hasEstimatedExtent){var r=e.getGlobalTransform().inverse();r.e=r.f=0,1==r.getScale()&&0==r.getRotation()||(n.style.transform=r.toString());var i=n.getBoundingClientRect(),o=i.height,a=i.width;return n.style.transform="",o&&a&&(t.height!==o||t.width!==a)&&(t.changeExtent(a,o,!1),e.textLayout.resetLineCharBoundsCacheOfLine(t),this.needsRerender=!0,e.viewState._needsFit=!0),o}return t.height},AfterTextRenderHook.prototype.updateExtentsOfLines=function(e){var t=this.morph,n=(t.textLayout,t.viewState);n.dom_nodes=[],n.dom_nodeFirstRow=0,n.textWidth=e.scrollWidth;for(var r=e.children,i=0,o=void 0;i<r.length&&"line"!=r[i].className;)i++;if(i<r.length){var a=(o=r[i]).dataset,s=Number(a?a.row:o.getAttribute("data-row"));if("number"==typeof s&&!isNaN(s)){n.dom_nodeFirstRow=s;for(var l=t.document.getLine(s);i<r.length;i++){var c=r[i];n.dom_nodes.push(c),l&&(this.updateLineHeightOfNode(t,l,c),l=l.nextLine())}this.needsRerender?(t.fitIfNeeded(),t.makeDirty()):t._dirty=!!t.submorphs.find(function(e){return e.needsRerender()})}}},AfterTextRenderHook.prototype.hook=function(e,t,n){if(e&&e.parentNode){var r=this.morph.viewState;r.text_layer_node=e,r.fontmetric_text_layer_node=null,this.called=!0,this.updateExtentsOfLines(e)}};var TextRenderer=function(e){var t=_classRecorder,n=t.hasOwnProperty("TextRenderer")&&"function"==typeof t.TextRenderer?t.TextRenderer:t.TextRenderer=function TextRenderer(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TextRenderer_initialize_(e){e?cssInstalled||installCSS(e):console.warn("Text renderer initialized without domEnv. Depending on what you want to do you might have bad luck...!"),this.domEnv=e}},{key:"directRenderLineFn",value:function TextRenderer_directRenderLineFn_(e){var t,n=this,r=e.viewState._renderLineFn;return r||(t=hyperscriptFnForDocument(n.domEnv.document),r=e.viewState._renderLineFn=function(r){return n.renderLine(t,null,e,r)}),r}},{key:"directRenderTextLayerFn",value:function TextRenderer_directRenderTextLayerFn_(e){var t,n=this,r=e.viewState._renderTextLayerFn;return r||(t=hyperscriptFnForDocument(n.domEnv.document),r=e.viewState._renderTextLayerFn=function(r){return n.renderJustTextLayerNode(t,e,r,[])}),r}},{key:"renderMorph",value:function TextRenderer_renderMorph_(e,t){var n=e.fontSize<=12?2:3,r=[],i=e.selection;if(e.inMultiSelectMode()){for(var o,a=i.selections,s=0;s<a.length-1;s++){var l;(l=r).push.apply(l,toConsumableArray(this.renderSelectionLayer(e,a[s],!0,2)))}(o=r).push.apply(o,toConsumableArray(this.renderSelectionLayer(e,a[s],!1,4)))}else r=this.renderSelectionLayer(e,i,!1,n);var c=this.renderTextLayer(e,t),u=this.renderJustTextLayerNode(vdom.h,e,null,[]),h=this.renderMarkerLayer(e,t);c.properties.className+=" actual",u.properties.className+=" font-measure";var d=e.embeddedMorphMap,p=d?e.submorphs.filter(function(e){return!d.has(e)}):e.submorphs;return vdom.h("div",Object.assign({},defaultAttributes(e,t),{style:Object.assign({},defaultStyle(e),{"-moz-user-select":"none",cursor:"auto"===e.nativeCursor?e.readOnly?"default":"text":e.nativeCursor})}),[].concat(toConsumableArray(r),[h,u,c,t.renderSelectedSubmorphs(e,p)]))}},{key:"renderTextLayer",value:function TextRenderer_renderTextLayer_(e,t){var n=e.debug?[].concat(toConsumableArray(this.renderDebugLayer(e)),toConsumableArray(this.renderLines(vdom.h,t,e))):this.renderLines(vdom.h,t,e),r=this.renderJustTextLayerNode(vdom.h,e,null,n),i=e.viewState.afterTextRenderHook||(e.viewState.afterTextRenderHook=new AfterTextRenderHook);return i.reset(e),r.properties["after-text-render-hook"]=i,nextTick(function(){if(!i.called){var n=t.getNodeForMorph(e),r=n&&n.querySelector(".actual.newtext-text-layer");r&&i.hook(r)}}),r}},{key:"renderJustTextLayerNode",value:function TextRenderer_renderJustTextLayerNode_(e,t,n,r){t.height;var i=t.padding,o=i.x,a=i.y,s=i.width,l=i.height,c=t.lineWrapping,u=t.backgroundColor,h=t.fontColor,d=t.textAlign,p=t.fontSize,f=t.textDecoration,g=t.fontStyle,m=t.fontWeight,v=t.fontFamily,y=t.lineHeight,_=t.wordSpacing,b=t.letterSpacing,x=(t.document,t.tabWidth),w=o+s,k=a+l,S=Math.max(t.document.height,t.height),C="newtext-text-layer";switch(c){case!0:case"by-words":C+=" wrap-by-words";break;case"only-by-words":C+=" only-wrap-by-words";break;case"by-chars":C+=" wrap-by-chars";break;case!1:C+=" no-wrapping"}var M={height:S+"px"};o>0&&(M.paddingLeft=o+"px"),w>0&&(M.paddingRight=w+"px"),a>0&&(M.paddingTop=a+"px"),k>0&&(M.paddingBottom=k+"px"),b&&(M.letterSpacing=b),_&&(M.wordSpacing=_),y&&(M.lineHeight=y),v&&(M.fontFamily=v),m&&(M.fontWeight=m),g&&(M.fontStyle=g),f&&(M.textDecoration=f),p&&(M.fontSize=p+"px"),d&&(M.textAlign=d),h&&(M.color=String(h)),u&&(M.backgroundColor=u),8!==x&&(M.tabSize=x);var T={className:C,style:M};if(n){var P=n.clipMode,A=n.height,L=n.width;"number"==typeof L&&(M.width=L+"px"),"number"==typeof A&&(M.height=A+"px"),P&&(M.overflow=P)}return M.overflow="hidden",e("div",T,r)}},{key:"renderLines",value:function TextRenderer_renderLines_(e,t,n){var r=n.height,i=n.scroll,o=n.padding,a=(o.x,o.y),s=(o.width,o.height,n.document),l=n.clipMode,c=t.getNodeForMorph(n),u=i.y,h=r,d=s.rowCount-1,p=s.height,f="visible"!==l,g=i.y-(c&&c._lastScrollTop||i.y),m=0>g||0==g?500:0,v=0<g||0==g?500:0;c&&(c._lastScrollTop=i.y);var y=s.findLineByVerticalOffset(f?Math.max(0,f?u-a-m:0):0)||{row:0,y:0,offset:0,line:s.getLine(0)},_=y.line,b=y.offset,x=y.y,w=y.row,k=s.findLineByVerticalOffset(f?Math.min(p,u-a+v+h):p)||{row:d,offset:0,y:0,line:s.getLine(d)},S=k.line,C=k.offset,M=k.row,T=f?w:0,P=0===b?w:w+1,A=f?M+1:d,L=S&&C!==S.height?M-1:M,R=[],E=[];E.push(e("div.newtext-before-filler",{style:{height:x+"px"}}));for(var O=_;O&&(R.push(O),E.push(this.renderLine(e,t,n,O)),0,O!==S);)O=O.nextLine();return Object.assign(n.viewState,{scrollTop:u,scrollHeight:h,scrollBottom:u+h,heightBefore:x,textHeight:p,firstVisibleRow:T,lastVisibleRow:A,firstFullyVisibleRow:P,lastFullyVisibleRow:L,visibleLines:R}),debug$1&&printViewState(n),E}},{key:"renderLine",value:function TextRenderer_renderLine_(e,t,n,r){var i=r.textAndAttributes,o=[],a=i.length,s=void 0,l=void 0,c=void 0,u=void 0,h=void 0,d=void 0,p=void 0,f=void 0,g=void 0,m=void 0,v=void 0,y=void 0,_=void 0,b=void 0,x=void 0,w=void 0,k=void 0,S=void 0,C=void 0,M=void 0,T=void 0,P=void 0,A=void 0,L=void 0;if(a>0)for(var R=0;R<a;R+=2)s=i[R]||"",l=i[R+1],"string"==typeof s?l?(c=l.fontSize&&(lively_lang.obj.isString(l.fontSize)?l.fontSize:l.fontSize+"px"),u=l.fontFamily,h=l.fontWeight,d=l.fontStyle,p=l.textDecoration,f=l.fontColor,g=l.backgroundColor,m=l.nativeCursor,v=l.textStyleClasses,y=l.link,M=l.lineHeight||M,T=l.textAlign||T,P=l.wordSpacing||P,A=l.letterSpacing||A,w=l.paddingRight,k=l.paddingLeft,S=l.paddingTop,C=l.paddingBottom,L=l.quote||L,_="span",x={style:b={}},y&&(_="a",x.href=y,y&&y.startsWith("http")&&(x.target="_blank")),c&&(b.fontSize=c),u&&(b.fontFamily=u),h&&(b.fontWeight=h),d&&(b.fontStyle=d),p&&(b.textDecoration=p),f&&(b.color=String(f)),g&&(b.backgroundColor=String(g)),m&&(b.cursor=m),w&&(b.paddingRight=w),k&&(b.paddingLeft=k),S&&(b.paddingTop=S),C&&(b.paddingBottom=C),v&&v.length&&(x.className=v.join(" ")),o.push(e(_,x,s))):o.push(s):o.push(s.isMorph?this.renderEmbeddedSubmorph(e,t,s,l):objectReplacementChar);else o.push(e("br"));var E={};M&&(E.lineHeight=M),T&&(E.textAlign=T),A&&(E.letterSpacing=A),P&&(E.wordSpacing=P);var O=e("div",{className:"line",key:r.row,style:E,dataset:{row:r.row}},o);if(L){"number"!=typeof L&&(L=1);for(var z=L;z--;)O=e("blockquote",{},O)}return O}},{key:"renderEmbeddedSubmorph",value:function TextRenderer_renderEmbeddedSubmorph_(e,t,n,r){var i=void 0;if(r=r||{},t)return(i=t.render(n)).properties.style.position="relative",i.properties.style.transform="",r.paddingTop&&(i.properties.style.marginTop=r.paddingTop),r.paddingLeft&&(i.properties.style.marginLeft=r.paddingLeft),r.paddingRight&&(i.properties.style.marginRight=r.paddingRight),r.paddingBottom&&(i.properties.style.marginBottom=r.paddingBottom),i;var o=n.extent,a=n.styleClasses,s=o.x+"px",l=o.y+"px";return e("div",{className:a.join(" "),style:{width:s,height:l}},[])}},{key:"renderSelectionLayer",value:function TextRenderer_renderSelectionLayer_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;if(!t)return[];var i=e.textLayout,o=t.start,a=t.end,s=(t.lead,t.cursorVisible),l=t.selectionColor,c=t.isReverse(),u=(e.document,e.cursorColor),h=i.boundsFor(e,o),d=i.computeMaxBoundsForLineSelection(e,t),p=i.boundsFor(e,a),f=lively_graphics.pt(h.x,d.y),g=lively_graphics.pt(p.x,p.y),m=h.height,v=d.height,y=p.height,_=c?lively_graphics.pt(h.x,h.y):g,b=c?m:y;if(t.isEmpty())return[this.cursor(_,b,s,n,r,u)];if(Math.abs(h.y+m-(p.y+y))<5)return[this.selectionLayerPart(f,g.withY(d.y+v),l),this.cursor(_,b,s,n,r,u)];var x=lively_graphics.pt(e.width-e.padding.right(),d.y+v),w=lively_graphics.pt(e.padding.left(),x.y);if(Math.abs(h.y+m-p.y)<5)return[this.selectionLayerPart(f,x,l),this.selectionLayerPart(w,g.addXY(0,y),l),this.cursor(_,b,s,n,r,u)];var k=lively_graphics.pt(e.width-e.padding.right(),g.y),S=lively_graphics.pt(e.padding.left(),g.y);return[this.selectionLayerPart(f,x,l),this.selectionLayerPart(w,k,l),this.selectionLayerPart(S,g.addXY(0,y),l),this.cursor(_,b,s,n,r,u)]}},{key:"selectionLayerPart",value:function TextRenderer_selectionLayerPart_(e,t,n){return vdom.h("div.newtext-selection-layer.selection-layer-part",{style:{left:e.x+"px",top:e.y+"px",width:t.x-e.x+"px",height:t.y-e.y+"px",backgroundColor:n}})}},{key:"cursor",value:function TextRenderer_cursor_(e,t,n,r,i,o){return vdom.h("div",{className:"newtext-cursor"+(r?" diminished":""),style:{left:e.x-Math.ceil(i/2)+"px",top:e.y+"px",width:i+"px",height:t+"px",display:n?"":"none",background:o||"black"}})}},{key:"renderMarkerLayer",value:function TextRenderer_renderMarkerLayer_(e){var t=e.markers,n=e.textLayout,r=e.viewState,i=r.firstVisibleRow,o=r.lastVisibleRow,a=[];if(!t)return a;var s=!0,l=!1,c=void 0;try{for(var u,h=t[Symbol.iterator]();!(s=(u=h.next()).done);s=!0){var d=u.value,p=d.style,f=d.range,g=f.start,m=f.end;if(!(m.row<i||g.row>o))if(g.row!==m.row){a.push(this.renderMarkerPart(n,e,g,e.lineRange(g.row).end,p));for(var v=g.row+1;v<=m.row-1;v++){var y=e.lineRange(v),_=y.start,b=y.end;a.push(this.renderMarkerPart(n,e,_,b,p,!0))}a.push(this.renderMarkerPart(n,e,{row:m.row,column:0},m,p))}else a.push(this.renderMarkerPart(n,e,g,m,p))}}catch(e){l=!0,c=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw c}}return a}},{key:"renderMarkerPart",value:function TextRenderer_renderMarkerPart_(e,t,n,r,i){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=0,s=0,l=0,c=0,u=t.document,h=u.getLine(n.row);if(o){var d=t.padding;a=d.left(),l=d.top()+u.computeVerticalOffsetOf(n.row),s=a+h.width,c=h.height}else{var p=e.boundsFor(t,n);a=p.x,l=p.y;var f=e.boundsFor(t,r);s=f.x,c=f.height}return c=Math.ceil(c),vdom.h("div.newtext-marker-layer",{style:Object.assign({},i,{left:a+"px",top:l+"px",height:c+"px",width:s-a+"px"})})}},{key:"renderDebugLayer",value:function TextRenderer_renderDebugLayer_(e){var t=e.viewState,n=[],r=t.heightBefore,i=t.firstVisibleRow,o=t.lastVisibleRow,a=t.visibleLines,s=e.padding,l=e.scroll,c=l.x,u=l.y,h=s.left(),d=s.right(),p=s.top();s.bottom();n.push(vdom.h("div.debug-info",{style:{left:c+h+"px",top:u+"px",width:e.width-d+"px"}},vdom.h("span","visible rows: "+i+" - "+o)));for(var f=0,g=i;g<o;f++,g++){var m=a[f],v=e.textLayout.lineCharBoundsCache.get(m),y=m.height;if(n.push(vdom.h("div.debug-line",{style:{left:c+h+"px",top:p+r+"px",width:e.width-d+"px",height:y+"px"}},vdom.h("span",String(g)))),v){for(var _=0;_<v.length;_++){var b=v[_],x=b.x,w=b.y,k=b.width,S=b.height;n.push(vdom.h("div.debug-char",{style:{left:h+x+"px",top:p+r+w+"px",width:k+"px",height:S+"px"}}))}r+=y}else r+=y}return n}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:7467,end:28446})}(void 0);function extractHTMLFromTextMorph(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.textAndAttributesInRange(e.selection.range),n=new e.constructor(Object.assign({},e.defaultTextStyle,{width:e.width,textAndAttributes:t})),r=n.textRenderer.directRenderTextLayerFn(n),i=n.textRenderer.directRenderLineFn(n),o=r(),a=System.global&&System.global.getComputedStyle?System.global.getComputedStyle(o):null;a&&(o.ownerDocument.body.appendChild(o),o.style.whiteSpace=a.whiteSpace,o.style.overflowWrap=a.overflowWrap,o.style.wordBreak=a.wordBreak,o.style.minWidth=a.minWidth,o.parentNode.removeChild(o));var s=!0,l=!1,c=void 0;try{for(var u,h=n.document.lines[Symbol.iterator]();!(s=(u=h.next()).done);s=!0){var d=u.value;o.appendChild(i(d))}}catch(e){l=!0,c=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw c}}return o.outerHTML}var commands$3={activate:{name:"[IyGotoChar] activate",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{backwards:!1};return IyGotoCharKeyHandler.installInto(e,t.backwards),!0}},moveTo:{name:"[IyGotoChar] move to",exec:function exec(e,t){e.saveMark();var n=e.selection,r=n.lead,i=r.row,o=r.column,a=!!e.activeMark||!n.isEmpty(),s={row:i,column:o-1},l=e.document[t.backwards?"scanBackward":"scanForward"](s,function(e,n){return e!==t.needle||eqPosition(s,n)?null:n});return!l||(l.column++,n.lead=l,a||(n.anchor=l),!0)},multiSelectAction:"forEach",readOnly:!0}},activate=commands$3.activate,IyGotoCharKeyHandler=function(e){var t=_classRecorder,n=t.hasOwnProperty("IyGotoCharKeyHandler")&&"function"==typeof t.IyGotoCharKeyHandler?t.IyGotoCharKeyHandler:t.IyGotoCharKeyHandler=function IyGotoCharKeyHandler(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function IyGotoCharKeyHandler_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this),this.charToFind=void 0,this.backwards=e}},{key:"isIyGoToChar",get:function get(){return!0}},{key:"uninstallFrom",value:function IyGotoCharKeyHandler_uninstallFrom_(e){e._cachedKeyhandlers=null,lively_lang.arr.remove(e._keyhandlers||[],this)}},{key:"eventCommandLookup",value:function IyGotoCharKeyHandler_eventCommandLookup_(e,t){var n=t.keyCombo,r=n.startsWith("input-");if(t.onlyModifiers||n.startsWith("Shift-")||t.isFunctionKey&&"Escape"===!n&&"Backspace"===!n||!r&&!t.isModified&&!t.isFunctionKey)return{command:"null",passEvent:!0};var i=r&&n.slice("input-".length);if(!this.charToFind){if(!r)return this.uninstallFrom(e),null;this.charToFind=i}return i!==this.charToFind?(this.uninstallFrom(e),null):{command:commands$3.moveTo,args:{backwards:this.backwards,needle:i}}}}],[{key:"installInto",value:function IyGotoCharKeyHandler_installInto_(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.keyhandlers.filter(function(e){return e.isIyGoToChar}).forEach(function(t){return t.uninstallFrom(e)}),e._cachedKeyhandlers=null,e._keyhandlers=(e._keyhandlers||[]).concat(new this(t))}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1049,end:3032})}({referencedAs:"KeyHandler",value:KeyHandler}),_this$1=void 0,commands$1=[{name:"clipboard copy",doc:"placeholder for native copy",scrollCursorIntoView:!1,exec:function exec(e){return e.selection.isEmpty()&&e.selectLine(e.cursorPosition.row),!0}},{name:"manual clipboard copy",doc:"attempts to copy selection via browser interface",scrollCursorIntoView:!1,multiSelectAction:"single",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{collapseSelection:!0,delete:!1,dontTryNativeClipboard:!1},n=e.selection,r=n.text,i=!t.hasOwnProperty("collapseSelection")||t.collapseSelection;return e.saveMark(n.anchor),e.activeMark=null,(n.isMultiSelection?n.selections.slice():[n]).forEach(function(n){var r=n.isEmpty()?e.lineRange():n.range,o=e.textInRange(r);e.env.eventDispatcher.killRing.add(o),t.delete?e.deleteText(r):!n.isEmpty()&&i&&n.collapse(n.lead)}),t.dontTryNativeClipboard||e.env.eventDispatcher.doCopy(r),!0}},{name:"clipboard cut",doc:"placeholder for native cut",exec:function exec(e){return e.selection.isEmpty()&&e.selectLine(e.cursorPosition.row,!0),!0}},{name:"clipboard paste",doc:"placeholder for native paste",exec:function exec(){return!0}},{name:"manual clipboard paste",doc:"attempts to paste from the clipboard to lively  currently requires browser extension!",multiSelectAction:"single",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{killRingCycleBack:!1};return regeneratorRuntime.wrap(function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return n=e.env.eventDispatcher.killRing,r.killRingCycleBack&&(lively_lang.arr.last(lively_lang.arr.pluck(e.commandHandler.history,"name"))||"").includes("clipboard paste")&&(t=n.back()),!t&&n.isCycling()&&(t=n.yank()),t||(t=n.yank()),e.selection.isMultiSelection?(e.undoManager.group(),e.selection.selections.slice(0,-1).reverse().map(function(e,t){var r=n.pointer-1-t;return r<0&&(r=n.buffer.length-1),{selection:e,pasted:n.buffer[r]||""}}).concat({selection:e.selection.defaultSelection,pasted:t}).forEach(function(e){var t=e.selection,n=e.pasted;return t.text=n}),e.undoManager.group()):t&&(e.undoManager.group(),e.selection.text=t,e.undoManager.group()),i.abrupt("return",!0);case 6:case"end":return i.stop()}},_callee,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"browse clipboard",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var t,n,r,i,o,a;return regeneratorRuntime.wrap(function _callee2$(s){for(;;)switch(s.prev=s.next){case 0:return t=e.env.eventDispatcher.killRing,n=t.pointer,r=t.buffer,i=r.map(function(e){return{isListItem:!0,string:lively_lang.string.truncate(e,80).replace(/\n/g,""),value:e}}),s.next=6,e.world().filterableListPrompt("select items to paste",i,{preselect:n,multiSelect:!0});case 6:return o=s.sent,(a=o.selected).length&&(e.undoManager.group(),e.insertTextAndSelect(a.join("\n")),e.undoManager.group()),s.abrupt("return",!0);case 10:case"end":return s.stop()}},_callee2,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"text undo",doc:"undo text changes",multiSelectAction:"single",exec:function exec(e){return e.textUndo(),!0}},{name:"text redo",doc:"redo text changes",multiSelectAction:"single",exec:function exec(e){return e.textRedo(),!0}},{name:"select all",doc:"Selects entire text contents.",scrollCursorIntoView:!1,multiSelectAction:"single",exec:function exec(e){return e.saveMark(),e.selectAll(),!0}},{name:"delete backwards",doc:"Delete the character in front of the cursor or the selection.",exec:function exec(e){if(e.rejectsInput())return!1;if(e.editorPlugin&&"function"==typeof e.editorPlugin.cmd_newline&&e.editorPlugin.cmd_delete_backwards())return!0;var t=e.selection;return t.isEmpty()&&t.growLeft(1),t.text="",t.collapse(),e.activeMark&&(e.activeMark=null),!0}},{name:"delete",doc:"Delete the character following the cursor or the selection.",exec:function exec(e){var t=e.selection;return!e.rejectsInput()&&(t.isEmpty()&&t.growRight(1),t.text="",t.collapse(),e.activeMark&&(e.activeMark=null),!0)}},{name:"indent",scrollCursorIntoView:!1,exec:function exec(e){return e.undoManager.group(),e.withSelectedLinesDo(function(t,n){return e.insertText(e.tab,n.start)}),e.undoManager.group(),!0}},{name:"outdent",scrollCursorIntoView:!1,exec:function exec(e){return e.undoManager.group(),e.withSelectedLinesDo(function(t,n){return t.startsWith(e.tab)&&e.deleteText({start:n.start,end:{row:n.start.row,column:e.tab.length}})}),e.undoManager.group(),!0}},{name:"indent according to mode",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var t,n,r,i,o,a,s,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee3$(c){for(;;)switch(c.prev=c.next){case 0:if(t=e.editorPlugin&&e.editorPlugin.mode){c.next=3;break}return c.abrupt("return",!0);case 3:return n=void 0,r=void 0,i=!l.hasOwnProperty("undo")||l.undo,l.hasOwnProperty("firstRow")&&l.hasOwnProperty("lastRow")?(n=l.firstRow,r=l.lastRow):e.selection.isEmpty()?n=r=e.cursorPosition.row:(o=e.selection.selectedRows,n=o.first,r=o.last),c.next=7,System.import("lively.ide/editor-modes.js");case 7:return a=c.sent,s=a.indentLines,i&&e.undoManager.group(),s(e,t,n,r,"smart",!0,l),i&&e.undoManager.group(),c.abrupt("return",!0);case 13:case"end":return c.stop()}},_callee3,_this$1)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"tab - snippet expand or indent",scrollCursorIntoView:!0,exec:function exec(e){var t=e.snippets.find(function(t){return t.canExpand(e)});return t?(t.expandAtCursor(e),!0):e.selection.isEmpty()?e.execCommand("insertstring",{string:e.tab}):e.execCommand("indent according to mode")}},{name:"browse snippets",scrollCursorIntoView:!0,exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var t,n,r,i;return regeneratorRuntime.wrap(function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:return t=e.snippets.map(function(e){return{isListItem:!0,string:e.trigger+" - "+e.expansion,value:e}}),o.next=3,e.world().filterableListPrompt("select snippet",t,{requester:e});case 3:return n=o.sent,r=slicedToArray(n.selected,1),(i=r[0])&&i.expandAtCursor(e),o.abrupt("return",!0);case 8:case"end":return o.stop()}},_callee4,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"transpose chars",exec:function exec(e){if(e.selection.isEmpty()){var t=e.cursorPosition,n=t.row,r=t.column,i=Range.create(n,r-1,n,r+1),o=e.getLine(n),a=o[r-1],s=o[r];a&&s&&e.replace(i,s+a,!0)}return!0}},{name:"cycle selection contents",documentation:"If there are multiple selections, will take the text of the first one and replace the second one with it, the text of the second will replace the third, the last selection contents will replace the contents of the first.",multiSelectAction:"single",exec:function exec(e){var t=e.selection.selections;return e.undoManager.group(),t.reduce(function(e,t){var n=t.text;return t.text=e,n},lively_lang.arr.last(t).text),e.undoManager.group(),!0}},{name:"go left",doc:"Move the cursor 1 character left. At the beginning of a line move the cursor up. If a selection is active, collapse the selection left.",exec:function exec(e){return e.activeMark?e.selection.selectLeft(1):e.selection.goLeft(1),!0}},{name:"go right",doc:"Move the cursor 1 character right. At the end of a line move the cursor down. If a selection is active, collapse the selection right.",exec:function exec(e){return e.activeMark?e.selection.selectRight(1):e.selection.goRight(1),!0}},{name:"go up",doc:"Move the cursor 1 line. At the end of a line move the cursor down. If a selection is active, collapse the selection right.",scrollCursorIntoView:!0,exec:function exec(e){return e.activeMark?e.selection.selectUp(1):e.selection.goUp(1,!0),!0}},{name:"go down",exec:function exec(e){return e.activeMark?e.selection.selectDown(1):e.selection.goDown(1,!0),!0}},{name:"select left",exec:function exec(e){return e.selection.selectLeft(1),!0}},{name:"select right",exec:function exec(e){return e.selection.selectRight(1),!0}},{name:"select up",exec:function exec(e){return e.selection.selectUp(1,!0),!0}},{name:"select down",exec:function exec(e){return e.selection.selectDown(1,!0),!0}},{name:"select line",exec:function exec(e){var t=e.selection,n=t.lead.row,r=e.lineRange(n,!1);return t.range=t.range.equals(r)?e.lineRange(n,!0):r,!0}},{name:"goto line start",exec:function exec(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!1}).select||!!e.activeMark,n=e.selection,r=n.lead,i=e.screenLineRange(r,!0);return n.lead=eqPosition(r,i.start)?{column:0,row:r.row}:i.start,!t&&(n.anchor=n.lead),!0}},{name:"goto line end",exec:function exec(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!1}).select||!!e.activeMark,n=e.selection,r=n.lead,i=e.screenLineRange(r,!0);return n.lead=i.end,!t&&(n.anchor=n.lead),!0}},{name:"goto page up",exec:function exec(e){return e.pageUpOrDown({direction:"up",select:!!e.activeMark}),!0}},{name:"goto page down",exec:function exec(e){return e.pageUpOrDown({direction:"down",select:!!e.activeMark}),!0}},{name:"goto page up and select",exec:function exec(e){return e.pageUpOrDown({direction:"up",select:!0}),!0}},{name:"goto page down and select",exec:function exec(e){return e.pageUpOrDown({direction:"down",select:!0}),!0}},{name:"goto start",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark};return e.gotoDocumentStart(Object.assign({},t)),!0}},{name:"goto end",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark};return e.gotoDocumentEnd(Object.assign({},t)),!0}},{name:"goto paragraph above",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark},n=e.paragraphRangeAbove(e.cursorPosition.row);return n.start.row--,e.selection.lead=n.start,t.select||e.collapseSelection(),!0}},{name:"goto paragraph below",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark},n=e.paragraphRangeBelow(e.cursorPosition.row);return n.end.row++,e.selection.lead=n.end,t.select||e.collapseSelection(),!0}},{name:"move cursor to screen bottom in 1/3 steps",readOnly:!0,exec:function exec(e){var t=!!e.activeMark,n=e.cursorPosition,r=e.textLayout.firstFullVisibleLine(e),i=e.textLayout.lastFullVisibleLine(e),o=r+Math.floor((i-r)/2),a=n;if(n.row<r)a.row=r;else if(n.row<o)a.row=o;else{if(!(n.row<i))return!0;a.row=i}return e.selection.lead=a,t||(e.selection.anchor=e.selection.lead),!0}},{name:"move cursor to screen top in 1/3 steps",readOnly:!0,exec:function exec(e){var t=!!e.activeMark,n=e.cursorPosition,r=e.textLayout.firstFullVisibleLine(e),i=e.textLayout.lastFullVisibleLine(e),o=r+Math.floor((i-r)/2),a=n;return n.row<=r||(n.row<=o?a.row=r:n.row<=i?a.row=o:a.row=i,e.selection.lead=a,t||(e.selection.anchor=e.selection.lead),!0)}},{name:"goto line",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee5(e){var t,n;return regeneratorRuntime.wrap(function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return t=!!e.activeMark,r.t0=Number,r.next=4,e.world().prompt("Enter line number");case 4:return r.t1=r.sent,n=(0,r.t0)(r.t1),isNaN(n)||(t?e.selection.lead={row:n,column:0}:e.cursorPosition={row:n,column:0},e.scrollCursorIntoView(),e.focus()),r.abrupt("return",!0);case 8:case"end":return r.stop()}},_callee5,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"join line",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{withLine:"before"},n=e.selection,r=n.start,i=n.end,o=n.lead;if(!e.selection.isEmpty()){if(r.row===i.row)return!0;var a=e.undoManager.ensureNewGroup(e,"join line"),s=lively_lang.arr.range(0,i.row-1-r.row).map(function(t){return e.joinLine(r.row)});return e.undoManager.group(a),e.selection.isMultiSelection&&(e.cursorPosition=s[0],s.slice(1).forEach(function(t){return e.selection.addRange({start:t,end:t})})),!0}var l=o.row;if("before"===t.withLine&&l<=0)return!0;if("after"===t.withLine&&l>=e.document.endPosition.row)return!0;e.undoManager.group();var c="before"===t.withLine?l-1:l;return e.cursorPosition=e.joinLine(c),e.undoManager.group(),!0}},{name:"split line",exec:function exec(e){var t=e.cursorPosition,n=e.getLine(t.row).match(/^\s*/)[0].length;return e.insertText("\n"+" ".repeat(n),t),e.cursorPosition=t,!0}},{name:"insert line",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{where:"above"},n=e.cursorPosition.row,r=e.getLine(n).match(/^\s*/)[0].length;return"below"===t.where&&n++,e.insertText(" ".repeat(r)+"\n",{column:0,row:n}),e.cursorPosition={column:r,row:n},!0}},{name:"duplicate line or selection",exec:function exec(e){e.undoManager.group();var t=e.selection.end;if(e.selection.isEmpty())e.insertText(e.getLine(t.row)+"\n",{column:0,row:t.row+1});else{var n=e.selection.range;e.insertText(e.selection.text,t),e.selection=n}return e.undoManager.group(),!0}},{name:"delete emtpy line or until end of line",exec:function exec(e){var t=e.cursorPosition,n=e.getLine(t.row);if(eqPosition(e.document.endPosition,t))return!0;var r=n.trim()?{start:t,end:{row:t.row,column:n.length}}:{start:{row:t.row,column:0},end:{row:t.row+1,column:0}};return e.env.eventDispatcher.doCopy(e.textInRange(r)),e.undoManager.group(),e.deleteText(r),e.undoManager.group(),!0}},{name:"delete left until beginning of line",exec:function exec(e){if(e.activeMark&&(e.activeMark=null),!e.selection.isEmpty())return e.selection.text="",!0;var t=e.lineRange(),n=e.cursorPosition;if(eqPosition({row:n.row,column:0},n))return!0;var r={start:eqPosition(t.start,n)?{row:n.row,column:0}:t.start,end:n};return e.deleteText(r),!0}},{name:"move lines up",multiSelectAction:"single",exec:function exec(e){var t=e.selection;if(e.inMultiSelectMode()){var n=t.selections.map(function(e){return e.range});return n.slice().sort(Range.compare).forEach(function(t){e.selection=t,e.execCommand("move lines up")}),n.forEach(function(e){e.start.row--,e.end.row--}),e.selection.ranges=n,!0}t.isEmpty()||0!==t.end.column||t.growRight(-1);var r=t.start,i=t.end,o=e.getLine(r.row-1),a=e.undoManager.ensureNewGroup(e);return e.insertText(o+"\n",{row:i.row+1,column:0}),e.deleteText({start:{row:r.row-1,column:0},end:{row:r.row,column:0}}),e.undoManager.group(a),!0}},{name:"move lines down",multiSelectAction:"single",exec:function exec(e){var t=e.selection;if(e.inMultiSelectMode()){var n=t.selections.map(function(e){return e.range});return n.slice().sort(Range.compare).reverse().forEach(function(t){e.selection=t,e.execCommand("move lines down")}),n.forEach(function(e){e.start.row++,e.end.row++}),e.selection.ranges=n,!0}t.isEmpty()||0!==t.end.column||t.growRight(-1);var r=t.range,i=r,o=i.start,a=i.end;t.isEmpty()?r={start:{row:o.row,column:0},end:{row:o.row+1,column:0}}:0!==a.column&&(r={start:o,end:{row:a.row+1,column:0}});var s=e.undoManager.ensureNewGroup(e),l=e.deleteText(r);return e.insertText(l,{row:o.row+1,column:0}),e.undoManager.group(s),e.selection={start:Object.assign({},o,{row:o.row+1}),end:Object.assign({},a,{row:a.row+1})},!0}},{name:"old select word",exec:function exec(e){var t=e.selection;return t.range=e.wordAt(t.lead).range,!0}},{name:"select word",exec:function exec(e){var t=e.selection,n=e.selectMatchingBrackets(e.textString,e.positionToIndex(t.lead));return n&&(t.range={start:n[0],end:n[1]+1}),!0}},{name:"select word right",exec:function exec(e){var t=e.selection;return t.anchor=e.wordRight(t.end).range.end,!0}},{name:"goto word left",exec:function exec(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!1}).select||!!e.activeMark,n=e.wordLeft().range;return e.selection.lead=n.start,t||(e.selection.anchor=n.start),!0}},{name:"goto word right",exec:function exec(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!1}).select||!!e.activeMark,n=e.wordRight().range;return e.selection.lead=n.end,t||(e.selection.anchor=n.end),!0}},{name:"delete word right",exec:function exec(e){e.undoManager.group();var t=e.wordRight().range.end,n={start:e.cursorPosition,end:t};return e.env.eventDispatcher.doCopy(e.textInRange(n)),e.deleteText(n),e.undoManager.group(),!0}},{name:"delete word left",exec:function exec(e){e.undoManager.group();var t={start:e.wordLeft().range.start,end:e.cursorPosition};return e.deleteText(t),e.undoManager.group(),!0}},{name:"goto matching right",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark},n=t.pairs||{"{":"}","[":"]","(":")","<":">"},r=e.findMatchingForward(e.cursorPosition,"right",n)||e.findMatchingForward(e.cursorPosition,"left",n);return r&&(e.selection.lead=r,t.select||(e.selection.anchor=e.selection.lead)),!0}},{name:"goto matching left",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{select:!!e.activeMark},n=t.pairs||{"}":"{","]":"[",")":"(",">":"<"},r=e.findMatchingBackward(e.cursorPosition,"left",n)||e.findMatchingBackward(e.cursorPosition,"right",n);return r&&(e.selection.lead=r,t.select||(e.selection.anchor=e.selection.lead)),!0}},{name:"realign top-bottom-center",doc:"Cycles through centering the cursor position, aligning it at the top, aligning it at the bottom.",scrollCursorIntoView:!1,multiSelectAction:"single",exec:function exec(e){var t=e.charBoundsFromTextPosition(e.cursorPosition),n=t.topLeft(),r=e.height-t.height,i=e.scroll,o=i.x,a=i.y;return a=Math.abs(n.y-a)<2?n.y-r:Math.abs(n.y-a-.5*r)<2?n.y:n.y-.5*r,e.scroll=lively_graphics.pt(o,a),!0}},{name:"reverse selection",doc:"switches the selection lead and anchor",exec:function exec(e){var t=e.selection;if(t.isEmpty()){var n=e.popSavedMark();n&&(e.saveMark(e.cursorPosition),t.lead=n.position)}else t.reverse();return!0}},{name:"toggle active mark",doc:"....",handlesCount:!0,multiSelectAction:"single",exec:function exec(e,t,n){var r=e.activeMark,i=e.selection,o=!i.isEmpty();if(4===n){var a=e.popSavedMark();return a&&(i.lead=a.position,o||(i.anchor=i.lead)),!0}if(!r&&!o)return e.activeMark=i.lead,!0;(e.saveMark(r||i.anchor),e.activeMark=null,o)&&(e.inMultiSelectMode()?i.selections:[i]).forEach(function(e){return e.anchor=e.lead});return!0}},{name:"fit text to column",handlesCount:!0,multiSelectAction:"forEach",exec:function exec(e,t,n){if(4===n)return e.execCommand("join line");e.selection.isEmpty()&&e.selectLine();var r=e.selection,i=n||80,o=r.selectedRows,a=r.range,s=/[ ]+/g,l=/^[\s\t]+/,c=lively_lang.string.paragraphs(lively_lang.arr.range(o.first,o.last).map(function(t){return e.getLine(t)}).join("\n"),{keepEmptyLines:!0}),u=lively_lang.chain(c.map(function fitParagraph(e){return/^\s*$/.test(e)?e:function fitRow(e){if(""===e.trim())return[""];var t=e.match(l),n=t?t[0]:"";return function splitLineIntoChunks(e,t,n){if(e.length<=i)return[t+e.trim()];var r=e.slice(0,i),o=lively_lang.arr.last(lively_lang.string.reMatches(r,s)),a=o&&o.start>0?o.start:i,l=r.slice(0,a),c=t+(r.slice(a)+e.slice(i)).trimLeft();return[l].concat(splitLineIntoChunks(c,t,n+1))}(n+e.trim(),n)}(e.split("\n").join(" ")).join("\n")+"\n"})).flatten().value().join("\n");return e.undoManager.group(),e.replace(a,u),e.undoManager.group(),!0}},{name:"lowercase",exec:function exec(e){return e.undoManager.group(),e.selection.isEmpty()&&(e.selection=e.wordAt().range),e.selection.text=e.selection.text.toLowerCase(),e.undoManager.group(),!0}},{name:"remove trailing whitespace",exec:function exec(e){e.undoManager.group();var t=0;return e.withLinesDo(0,e.documentEndPosition.row,function(n,r){return n.match(/\s+$/)&&++t&&e.replace(r,n.trimRight())}),e.world().setStatusMessage(t+" lines cleaned up"),e.undoManager.group(),!0}},{name:"uppercase",exec:function exec(e){return e.undoManager.group(),e.selection.isEmpty()&&(e.selection=e.wordAt().range),e.selection.text=e.selection.text.toUpperCase(),e.undoManager.group(),!0}},{name:"newline",exec:function exec(e){var t=e.cursorPosition,n=e.getLine(t.row),r=n.match(/^\s*/)[0].length;return e.undoManager.group(),!n.trim()&&r&&(e.deleteText({start:{row:t.row,column:0},end:{row:t.row,column:r}}),t.column=0),!(!e.editorPlugin||"function"!=typeof e.editorPlugin.cmd_newline||!e.editorPlugin.cmd_newline(t,n,r))||(e.selection.text="\n"+" ".repeat(r),e.selection.collapseToEnd(),e.undoManager.group(),!0)}},{name:"insertstring",exec:function exec(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{string:null,undoGroup:!1},n=t.string,r=t.undoGroup,i="string"==typeof n&&n.length;if(i||console.warn("command insertstring called with not string value"),e.rejectsInput()||!i)return!1;if(e.saveActiveMarkAndDeactivate(),e.editorPlugin&&"function"==typeof e.editorPlugin.cmd_insertstring&&e.editorPlugin.cmd_insertstring(n))return!0;var o=e.selection,a=!o.isEmpty();a&&e.undoManager.group();var s=o.lead,l=!(1===n.length&&"\n"!==n&&s.column>0);return o.replace(n,!0,!0,!0,l),o.collapseToEnd(),a&&e.undoManager.group(),r&&(/^[\s\.,\?\+=]+$/.test(n)||"number"!=typeof r?e.undoManager.group():e.undoManager.groupLater(r)),!0}},{name:"toggle line wrapping",scrollCursorIntoView:!1,multiSelectAction:"single",exec:function exec(e){return e.keepPosAtSameScrollOffsetWhile(function(){return e.lineWrapping=!e.lineWrapping&&(!!e.fontMetric.isProportional(e.fontFamily)||"by-chars")}),!0}},{name:"cancel input",scrollCursorIntoView:!1,multiSelectAction:"single",exec:function exec(e,t,n,r){return e.env.eventDispatcher.resetKeyInputState(),e.selection.disableMultiSelect&&e.selection.disableMultiSelect(),e.selection.isEmpty()||(e.selection.anchor=e.selection.lead),e.activeMark&&(e.activeMark=null),!0}}],usefulEditorCommands=[{name:"insert date",handlesCount:!0,exec:function exec(e,t,n){var r=lively_lang.date.format(new Date,n?"mediumDate":"isoDate");return e.undoManager.group(),e.insertText(r),e.undoManager.group(),!0}},{name:"[todo] toggle todo marker",exec:function exec(e){var t=e.selection;t.isEmpty()&&e.selectLine();var n=/\[\s*\]/g,r=/\[X\]/g,i=t.text;return i=n.test(i)?i.replace(n,"[X]"):r.test(i)?i.replace(r,"[ ]"):"[ ] "+i.trimLeft(),t.text=i,!0}},{name:"selected lines: sort",exec:function exec(e){var t=e.selection,n=t.start.row,r=t.end.row,i=[];return e.withLinesDo(n,r,function(e){var t=i.findIndex(function(t){return t>e});t>-1?i.splice(t,0,e):i.push(e)}),e.undoManager.group(),e.replace({start:{row:n,column:0},end:{row:r+1,column:0}},i.join("\n")+"\n"),e.undoManager.group(),!0}},{name:"selected lines: reverse",exec:function exec(e){var t=e.selection,n=t.start.row,r=t.end.row,i=[];return e.withLinesDo(n,r,function(e){return i.push(e)}),e.undoManager.group(),e.replace({start:{row:n,column:0},end:{row:r+1,column:0}},i.reverse().join("\n")+"\n"),e.undoManager.group(),!0}},{name:"selected lines: remove duplicates (uniq)",exec:function exec(e){var t=e.selection,n=t.start.row,r=t.end.row,i=[];return e.withLinesDo(n,r,function(e){return lively_lang.arr.pushIfNotIncluded(i,e)}),e.undoManager.group(),e.replace({start:{row:n,column:0},end:{row:r+1,column:0}},i.join("\n")+"\n"),e.undoManager.group(),!0}},{name:"change string inflection",handlesCount:!0,multiSelectAction:"single",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee6(e,t,n){var r,i,o,a,s,l,c,u,h;return regeneratorRuntime.wrap(function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:if(h=function detectCamelCaseType(e){return e.match(/[A-Z]/)?"uppercased":e.match(/-/)?"dashed":e.match(/\s/)?"spaced":"unknown"},u=function convertCamelCased(e,t){var n,r,i=h(e).trim();return"uppercased"===i?n=/\s*[A-Z0-9]+/g:"dashed"===i?n=/-\w/g:"spaced"===i&&(n=/\s+.?/g),"uppercased"===t?r=function replace(e){return e.trim().replace(/^-/,"").toUpperCase()}:"dashed"===t?r=function replace(e){return"-"+e.trim().replace(/^-/,"").toLowerCase()}:"spaced"===t&&(r=function replace(e){return" "+e.trim().replace(/^-/,"").toLowerCase()}),e.replace(n,r)},e.selection.isEmpty()&&(e.selection=e.wordAt().range),r=e.selection.ranges,i=e.textInRange(r[0])){t.next=7;break}return e.setStatusMessage("Please select some text"),t.abrupt("return",!0);case 7:return o=h(i),a=lively_lang.arr.without(["uppercased","dashed","spaced"],o),t.next=11,e.world().listPrompt("Convert "+o+" into?",a,{});case 11:if(s=t.sent,l=slicedToArray(s.selected,1),c=l[0]){t.next=16;break}return t.abrupt("return",!0);case 16:return e.undoManager.group(),r.forEach(function(t,n){var r=e.textInRange(t),i=u(r,c);e.replace(t,i)}),e.undoManager.group(),e.focus(),t.abrupt("return",!0);case 21:case"end":return t.stop()}},_callee6,this)}));return function exec(t,n,r){return e.apply(this,arguments)}}()},{name:"spell check word",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee7(e,t){var n,r,i,o,a,s,l;return regeneratorRuntime.wrap(function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:if((n=e.wordAt()).string){t.next=4;break}return e.setStatusMessage("no word for spellcheck!"),t.abrupt("return",!0);case 4:return t.next=6,System.import("lively.ide/shell/spell-checker.js");case 6:return r=t.sent,i=r.spellCheckWord,t.next=10,i(n.string);case 10:if((o=t.sent).length){t.next=14;break}return e.setStatusMessage("no suggestions for word "+n.string),t.abrupt("return",!0);case 14:return t.next=16,e.world().filterableListPrompt("Choose replacement for "+n.string,o);case 16:return a=t.sent,s=slicedToArray(a.selected,1),(l=s[0])&&(e.undoManager.group(),e.replace(n.range,l),e.undoManager.group()),t.abrupt("return",!0);case 21:case"end":return t.stop()}},_callee7,this)}));return function exec(t,n){return e.apply(this,arguments)}}()},{name:"[shell] run shell command on region",multiSelectAction:"single",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee8(e,t){var n,r,i,o,a,s,l;return regeneratorRuntime.wrap(function _callee8$(t){for(;;)switch(t.prev=t.next){case 0:return n=e.textInRange(e.selection),r=n&&0!==n.length?{stdin:n}:{},t.next=4,e.world().prompt("Enter shell command to run on region.",{historyId:"lively.ide.execShellCommand"});case 4:return i=t.sent,t.next=7,System.import("lively.ide/shell/shell-interface.js");case 7:if(o=t.sent,a=o.runCommand,i){t.next=11;break}return t.abrupt("return",e.setStatusMessage("No command entered, aborting...!"));case 11:return s=a(i,r),t.prev=12,t.next=15,s.whenDone();case 15:l=s.output.trim(),e.undoManager.group(),e.selection.selections.forEach(function(e){return e.text=l}),e.undoManager.group(),t.next=24;break;case 21:t.prev=21,t.t0=t.catch(12),e.showError(t.t0);case 24:return t.abrupt("return",!0);case 25:case"end":return t.stop()}},_callee8,this,[[12,21]])}));return function exec(t,n){return e.apply(this,arguments)}}()},{name:"open file at cursor",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee9(e,t){var n,r,i,o,a,s,l,c,u;return regeneratorRuntime.wrap(function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return e.getLine(),n=e.cursorPosition.row,r=e.document.scanBackward(e.cursorPosition,function(e,t){return(t.column<=0||e.match(/\s/))&&t})||{row:0,column:0},i=e.document.scanForward(e.cursorPosition,function(e,t){return(t.row!=n||e.match(/\s/))&&t})||e.documentEndPosition,o=e.textInRange({start:r,end:i}).replace(/\s/g,""),a=o.split(":"),s=a[0].match(/^file|http/)?a.shift()+":"+a.shift():a.shift(),a[0].match(/^[0-9]+$/)&&(s+=":"+a.shift()),t.next=4,System.import("lively.ide/text-editor.js");case 4:return l=t.sent,c=l.default,(u=c.openInWindow()).location=s,t.abrupt("return",u);case 9:case"end":return t.stop()}},_callee9,this)}));return function exec(t,n){return e.apply(this,arguments)}}()},{name:"run code on text morph",doc:"...",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee10(e,t){var n,r,i,o,a;return regeneratorRuntime.wrap(function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:return n={targetModule:"lively://code-on-text-morph",context:e},t.next=3,e.world().editPrompt("Run code on selection. Use this.selection.text to access it",{requester:e,mode:"js",evalEnvironment:n,historyId:"run-code-on-text-morph-hist"});case 3:return r=t.sent,i=void 0,o=void 0,t.prev=6,e.undoManager.group(),t.next=10,lively.vm.runEval(r,n);case 10:a=t.sent,e.undoManager.group(),o=a.isError?a.value:null,t.next=18;break;case 15:t.prev=15,t.t0=t.catch(6),o=t.t0;case 18:return o&&e.showError(o),t.abrupt("return",i);case 20:case"end":return t.stop()}},_callee10,this,[[6,15]])}));return function exec(t,n){return e.apply(this,arguments)}}()},{name:"change editor mode",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee11(e){var t,n,r,i,o,a,s,l,c;return regeneratorRuntime.wrap(function _callee11$(u){for(;;)switch(u.prev=u.next){case 0:return t=function filter(e){return!e.endsWith("ide/editor-plugin.js")&&e.endsWith("editor-plugin.js")},u.next=3,lively.modules.getPackage("lively.ide").resources(t);case 3:return n=u.sent,r=e.editorPlugin||{},i=r.shortName,o=0,a=["<no mode>"].concat(n.map(function(e,t){var n=e.url.match(/([^\/]+)\/editor-plugin.js/)[1];return n===i&&(o=t),{isListItem:!0,string:n,value:e}})),u.next=10,e.world().filterableListPrompt("choose mode",a,{requester:e,preselect:o,historyId:"lively.morphic/text-change-editor-mode-hist",fuzzy:!0});case 10:if(s=u.sent,l=slicedToArray(s.selected,1),c=l[0]){u.next=15;break}return u.abrupt("return");case 15:if("<no mode>"!==c){u.next=20;break}return u.next=18,e.changeEditorMode(null);case 18:return e.resetTextAttributes(),u.abrupt("return");case 20:if(c.isLoaded){u.next=23;break}return u.next=23,lively.modules.module(c.url).load();case 23:return u.next=25,e.changeEditorMode(c.url);case 25:case"end":return u.stop()}},_callee11,this)}));return function exec(t){return e.apply(this,arguments)}}()},{name:"report token at cursor",exec:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee12(e){var t,n,r,i;return regeneratorRuntime.wrap(function _callee12$(o){for(;;)switch(o.prev=o.next){case 0:return t=e.tokenAt(e.cursorPosition)||{},n=t.token,r=t.start,i=t.end,e.setStatusMessage(n?n+" "+r.column+" => "+i.column:"no token"),o.abrupt("return",!0);case 3:case"end":return o.stop()}},_callee12,this)}));return function exec(t){return e.apply(this,arguments)}}()}];commands$1.push.apply(commands$1,usefulEditorCommands),commands$1.push(activate),commands$1.push.apply(commands$1,toConsumableArray(searchCommands));var Text=function(e){var t=_classRecorder,n=t.hasOwnProperty("Text")&&"function"==typeof t.Text?t.Text:t.Text=function Text(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Text_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.position,r=e.rightCenter,i=e.leftCenter,o=e.topCenter,a=e.bottom,s=e.top,l=e.right,c=e.left,u=e.bottomCenter,h=e.bottomLeft,d=e.bottomRight,p=e.topRight,f=e.topLeft,g=e.center;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.undoManager.reset(),this.fit(),void 0!==t&&(this.position=t),void 0!==r&&(this.rightCenter=r),void 0!==i&&(this.leftCenter=i),void 0!==o&&(this.topCenter=o),void 0!==a&&(this.bottom=a),void 0!==s&&(this.top=s),void 0!==l&&(this.right=l),void 0!==c&&(this.left=c),void 0!==u&&(this.bottomCenter=u),void 0!==h&&(this.bottomLeft=h),void 0!==d&&(this.bottomRight=d),void 0!==p&&(this.topRight=p),void 0!==f&&(this.topLeft=f),void 0!==g&&(this.center=g)}},{key:"__deserialize__",value:function Text___deserialize___(e,t,r){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__deserialize__",this).call(this,e,t),this.viewState=this.defaultViewState,this.markers=[],this.textRenderer=new TextRenderer(this.env.domEnv),this.textLayout=new TextLayout(this),this.changeDocument(Document.fromString("")),this.ensureUndoManager(),this._isDeserializing=!0}},{key:"__after_deserialize__",value:function Text___after_deserialize___(e,t){var r=this;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__after_deserialize__",this).call(this,e,t);var i=void 0,o=void 0,a=void 0;if(e._cachedLineCharBounds){this.changeMetaData("deserializeInfo",{recoveredLineCharBounds:!0}),i=e._cachedLineCharBounds;for(var s=0;s<i.length;s++)if(o=i[s]){a=[],this.textLayout.lineCharBoundsCache.set(this.document.getLine(s),a);for(var l=0;l<o.length;l+=4)a.push({height:o[l],width:o[l+1],x:o[l+2],y:o[l+3]})}}e._cachedLineExtents&&(this.changeMetaData("deserializeInfo",{recoveredTextBounds:!0}),this.whenRendered().then(function(){for(var t=0;t<Math.min(e._cachedLineExtents.length,r.document.lines.length);t++){var n=slicedToArray(e._cachedLineExtents[t],2),i=n[0],o=n[1];r.document.lines[t].changeExtent(i,o),r.fit()}})),this._isDeserializing=!1,this.whenRendered().then(function(){r.embeddedMorphs.forEach(function(e){return e.top=0})})}},{key:"__only_serialize__",get:function get(){return lively_lang.arr.withoutAll(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__only_serialize__",this),["document","textRenderer","viewState","undoManager","markers","textLayout","embeddedMorphMap"])}},{key:"__additionally_serialize__",value:function Text___additionally_serialize___(e,t,r,i){var o=this;lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__additionally_serialize__",this).call(this,e,t,r,i),e.props.selections={key:"selections",verbatim:!0,value:(this.selection.isMultiSelection?this.selection.ranges:[this.selection.range]).map(function(e){return lively_lang.obj.select(e,["start","end"])})},e.props.textAndAttributes={key:"textAndAttributes",value:this.textAndAttributes.map(function(e){if(!e)return e;if(e.isMorph)return r.ref(e).asRefForSerializedObjMap();if(lively_lang.obj.isObject(e)){var t=(n={},i=(i=JSON.stringify(e,function(e,t){return t&&t.__serialize__?(t=t.__serialize__(),Object.assign(n,t.bindings),"->["+t.__expr__+"]"):t})).replace(/\"->\[.*\]\"/g,function(e){return e.slice(4,-2)}),{v:r.expressionSerializer.exprStringEncode({__expr__:"("+i+")",bindings:n})});if("object"===(void 0===t?"undefined":_typeof(t)))return t.v}var n,i;return e})},e._cachedLineExtents=this.document.lines.map(function(e){return[e.width,e.height]}),e._cachedLineCharBounds=this.document.lines.map(function(e){var t=o.textLayout.lineCharBoundsCache.get(e);return t?lively_lang.arr.flatten(t.map(function(e){return[e.height,e.width,e.x,e.y]})):null})}},{key:"isText",get:function get(){return!0}},{key:"onChange",value:function Text_onChange_(e){var t=this,r=e.prop,i=e.selector,o=e.meta,a=this.lineWrapping,s=!1,l=!1,c=!1,u=!1,h=!1;if(i)s="replace"===i,u="addTextAttribute"===i,this._displacementChange=!this._displacing&&s;else switch(r){case"scroll":l=!0,h=!0;break;case"extent":l=!0,c=!0,u=a&&e.prevValue.x!=e.value.x,this._displacementChange=u;break;case"wordSpacing":case"letterSpacing":case"tabWidth":a&&(u=!0);break;case"fontFamily":case"fontSize":case"lineHeight":case"textAlign":case"fontWeight":case"fontStyle":case"textStyleClasses":case"fixedWidth":case"lineWrapping":u=!0;break;case"fixedHeight":case"padding":c=!0}lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onChange",this).call(this,e);var d=function updateTextEngine(){t._textChange=!0,h&&(t.viewState.wasScrolled=!0),(u||c&&!o.styleSheetChange)&&t.invalidateTextLayout(u,u),t._displacementChange&&(t._displacementChange=!1),s&&lively_bindings.signal(t,"textChange",e),l&&lively_bindings.signal(t,"viewChange",e),t._textChange=!1};o.animation?lively_lang.promise.delay(o.animation.duration).then(d):"extent"==r?this.whenRendered().then(d):d()}},{key:"onSubmorphChange",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e,t){var r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b=this;return regeneratorRuntime.wrap(function _callee$(x){for(;;)switch(x.prev=x.next){case 0:if(!e.meta||!e.meta.styleSheetChange){x.next=2;break}return x.abrupt("return");case 2:if(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onSubmorphChange",this).call(this,e,t),!e.meta.animation){x.next=6;break}return x.next=6,e.meta.animation.asPromise();case 6:if(!this._textChange&&this._positioningSubmorph!==t){x.next=8;break}return x.abrupt("return");case 8:if(r=e.prop,i="position"==r||"extent"==r||"scale"==r||"rotation"==r,this.displacingMorphMap.get(t)&&i&&[].concat(toConsumableArray(this.displacingMorphMap.keys())).filter(function(e){return e.top>=t.top}).forEach(function(e){b._intersectionShapeCache&&b._intersectionShapeCache.delete(e),b.updateTextDisplacementFor(e)}),o=this.embeddedMorphMap.get(t)||{},!(a=o.anchor)||!i){x.next=44;break}if("position"!=r){x.next=17;break}return this._positioningSubmorph=t,t.position=e.prevValue,this._positioningSubmorph=null,x.abrupt("return");case 17:if(s=t.bounds(),l=t._lastBounds,c=a.position.row,u=this.document.getLine(c),l&&l.height==s.height&&l.bottom()==s.bottom()){x.next=44;break}return t._lastBounds=s,l&&l.height==s.height||(this.textLayout.estimateExtentOfLine(this,u),this.textLayout.resetLineCharBoundsCacheOfRow(morph$2,c)),x.next=23,t.whenRendered();case 23:for(h=lively_lang.arr.sortBy([].concat(toConsumableArray(this.embeddedMorphMap.entries())),function(e){return e[1].anchor.position.row}),d=!0,p=!1,f=void 0,x.prev=27,g=h[Symbol.iterator]();!(d=(m=g.next()).done);d=!0)v=slicedToArray(m.value,2),y=v[0],(_=v[1].anchor).position.row>c&&(this._positioningSubmorph=y,l?y.top+=s.height-l.height:_.position=_.position,this._positioningSubmorph=null);x.next=35;break;case 31:x.prev=31,x.t0=x.catch(27),p=!0,f=x.t0;case 35:x.prev=35,x.prev=36,!d&&g.return&&g.return();case 38:if(x.prev=38,!p){x.next=41;break}throw f;case 41:return x.finish(38);case 42:return x.finish(35);case 43:case 44:case"end":return x.stop()}},_callee,this,[[27,31,35,43],[36,,38,42]])}));return function Text_onSubmorphChange_(t,n){return e.apply(this,arguments)}}()},{key:"removeMorph",value:function Text_removeMorph_(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this.embeddedMorphMap,i=this.displacingMorphMap;if(i&&i.has(e)&&this.toggleTextWrappingAround(e,!1),r&&r.has(e)){var o=r.get(e).anchor;if(o){var a=o.position,s=a.row,l=a.column;this.replace({start:{row:s,column:l},end:{row:s,column:l+1}},[],!0,t),this.replace}r.delete(e)}return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"removeMorph",this).call(this,e)}},{key:"toggleTextWrappingAround",value:function Text_toggleTextWrappingAround_(e,t){var n=this;if(t){if(this.displacingMorphMap.has(e))return;this.embeddedMorphMap.has(e)&&this.addMorph(e.remove()),this.displacingMorphMap.set(e,[]),this.updateTextDisplacementFor(e)}else{var r=this.displacingMorphMap.get(e);r&&(this._displacing=!0,r.forEach(function(e){return n.removeMorph(e)}),this._displacing=!1,this.displacingMorphMap.delete(e))}}},{key:"updateTextDisplacementFor",value:function Text_updateTextDisplacementFor_(e){var t=this;if(!this._displacing){this._displacing=!0;var n,r=this.displacingMorphMap.get(e),i=this.computeDisplacementRectsFor(e).values(),o=[];r.forEach(function(e){return t.removeMorph(e,!1)}),this.textLayout.resetLineCharBoundsCacheOfRange(this,e._displacementRange);var a=!0,s=!1,l=void 0;try{for(var c,u=i[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var h=c.value,d=r.shift()||morph$2({visible:!0,reactsToPointer:!1,isDisplacementMorph:!0}),p=this.textLayout.textPositionFromPoint(this,h.leftCenter());d.setBounds(h),this.insertText([d,{}],p),this.viewState._needsFit=!1,n!=d.top?(n=d.top,o.push(d)):d.remove()}}catch(e){s=!0,l=e}finally{try{!a&&u.return&&u.return()}finally{if(s)throw l}}r.forEach(function(e){return t.removeMorph(e,!1)}),this.displacingMorphMap.set(e,o),this._displacing=!1}}},{key:"computeDisplacementRectsFor",value:function Text_computeDisplacementRectsFor_(e){var t=this.textLayout,n=t.textPositionFromPoint(this,e.topLeft),r=t.textPositionFromPoint(this,e.bottomLeft),i=[];e._displacementRange=Range.fromPositions(n,r);for(var o=n.row;o<r.row+1;o++)i.push.apply(i,toConsumableArray(t.rangesOfWrappedLine(this,o)));this._intersectionShapeCache||(this._intersectionShapeCache=new Map);var a=this._intersectionShapeCache.get(e)||function computeIntersectionShape(e){return e.isPath?Shapes.path(getSvgVertices(e.vertices)):"Ellipse"==e.constructor.name?Shapes.ellipse(e.center.x,e.center.y,e.width/2,e.height/2):Shapes.rectangle(e.left,e.top,e.width,e.height)}(e);this._intersectionShapeCache.set(e,a);var s=this.width,l=new Map,c=!0,u=!1,h=void 0;try{for(var d,p=i[Symbol.iterator]();!(c=(d=p.next()).done);c=!0){var f=d.value,g=t.computeMaxBoundsForLineSelection(this,f),m=g.height,v=g.y,y=Shapes.rectangle(s,m,0,v),_=Intersection.intersect(y,a);if(!(_.points.length<1)){var b=lively_graphics.Rectangle.unionPts(_.points.map(lively_graphics.Point.fromLiteral));b.y=v,b.height=m,b.x-=15,b.width+=30,l.set(f,b)}}}catch(e){u=!0,h=e}finally{try{!c&&p.return&&p.return()}finally{if(u)throw h}}return l}},{key:"rejectsInput",value:function Text_rejectsInput_(){return this.readOnly}},{key:"addAnchor",value:function Text_addAnchor_(e){if(e){if("string"==typeof e&&(e={id:e,row:0,column:0}),!e.isAnchor){var t=e,n=t.id,r=t.column,i=t.row,o=t.insertBehavior;e=new Anchor(n,"number"==typeof i&&"number"==typeof r?{row:i,column:r}:void 0,o||"move")}var a=e.id&&this.anchors.find(function(t){return t.id===e.id});return a?Object.assign(a,e):(this.anchors.push(e),e)}}},{key:"removeAnchor",value:function Text_removeAnchor_(e){for(var t=this.anchors,n=void 0,r=t.length;r--;){var i=t[r];i.id!=e&&i!==e||(n=i,t.splice(r,1))}return n}},{key:"addMarker",value:function Text_addMarker_(e){return this.removeMarker(e.id),this.markers.push(e),this.makeDirty(),e}},{key:"removeMarker",value:function Text_removeMarker_(e){var t="string"==typeof e?e:e.id;this.markers=this.markers.filter(function(e){return e.id!==t}),this.makeDirty()}},{key:"saveMark",value:function Text_saveMark_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition,t=arguments[1],n=this.activeMark;n&&n!==e&&!n.equalsPosition(e)&&(this.savedMarks=this.savedMarks.concat(n)),t?this.activeMark=e:this.savedMarks=this.savedMarks.concat(e)}},{key:"saveActiveMarkAndDeactivate",value:function Text_saveActiveMarkAndDeactivate_(){var e=this.activeMark;e&&(this.saveMark(e),this.activeMark=null)}},{key:"popSavedMark",value:function Text_popSavedMark_(){var e=this.activeMark;if(e)return this.activeMark=null,e;var t=lively_lang.arr.last(this.savedMarks);return this.savedMarks=this.savedMarks.slice(0,-1),t}},{key:"lastSavedMark",get:function get(){return this.activeMark||lively_lang.arr.last(this.savedMarks)}},{key:"savedMarkForSelection",value:function Text_savedMarkForSelection_(e){var t=this.selection,n=this.savedMarks,r=this.multiSelect?this.multiSelect.getAllRanges().length:1,i=t.index||0,o=n.length-(r-i),a=n[o]||t.anchor;return e&&"row"in e&&"column"in e&&(this.savedMarks=n.slice(0,o).concat(e).concat(n.slice(o+1))),a}},{key:"addPlugin",value:function Text_addPlugin_(e){return this.plugins.includes(e)||(this.plugins.push(e),this._cachedKeyhandlers=null,"function"==typeof e.attach&&e.attach(this)),e}},{key:"removePlugin",value:function Text_removePlugin_(e){return!!this.plugins.includes(e)&&(this._cachedKeyhandlers=null,lively_lang.arr.remove(this.plugins,e),"function"==typeof e.detach&&e.detach(this),!0)}},{key:"pluginCollect",value:function Text_pluginCollect_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.plugins.forEach(function(n){return"function"==typeof n[e]&&(t=n[e](t))}),t}},{key:"pluginInvokeFirst",value:function Text_pluginInvokeFirst_(e){for(var t=this.pluginFind(function(t){return"function"==typeof t[e]}),n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return t?t[e].apply(t,r):void 0}},{key:"pluginFind",value:function Text_pluginFind_(e){return this.plugins.slice().reverse().find(e)}},{key:"editorPlugin",get:function get(){return this.pluginFind(function(e){return e.isEditorPlugin})}},{key:"lookupEditorPluginNamed",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var t,n,r,i;return regeneratorRuntime.wrap(function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return e=config$1.ide.modes.aliases[e]||e,t=/^[^:\\]+:\/\//.test(e),n=t?e:"lively.ide/"+e+"/editor-plugin.js",o.next=4,lively.modules.doesModuleExist(n);case 4:if(o.sent){o.next=6;break}return o.abrupt("return",null);case 6:return o.next=8,lively.modules.module(n).load();case 8:return r=o.sent,i=r.default,o.abrupt("return",i);case 11:case"end":return o.stop()}},_callee2,this)}));return function Text_lookupEditorPluginNamed_(t){return e.apply(this,arguments)}}()},{key:"changeEditorMode",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var t,n;return regeneratorRuntime.wrap(function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:if(t=this.plugins.filter(function(e){return!e.isEditorPlugin}),e){r.next=4;break}return this.plugins=t,r.abrupt("return",null);case 4:if("string"!=typeof e){r.next=11;break}return r.next=7,this.lookupEditorPluginNamed(e);case 7:if(n=r.sent){r.next=10;break}throw new Error("Cannot find editor mode "+e);case 10:e=new n(config$1.codeEditor.defaultTheme);case 11:return this.plugins=t.concat(e),r.abrupt("return",e);case 13:case"end":return r.stop()}},_callee3,this)}));return function Text_changeEditorMode_(t){return e.apply(this,arguments)}}()},{key:"invalidateTextLayout",value:function Text_invalidateTextLayout_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._isDeserializing){var n=this.viewState;if(n){this.fixedWidth&&this.fixedHeight||(n._needsFit=!0);var r=this.textLayout;r&&(e&&r.resetLineCharBoundsCache(this),r.estimateLineHeights(this,t))}}}},{key:"textBounds",value:function Text_textBounds_(){return this.textLayout.textBounds(this)}},{key:"defaultCharExtent",value:function Text_defaultCharExtent_(){return this.textLayout.defaultCharExtent(this)}},{key:"scrollExtent",get:function get(){return this.textBounds().extent().addPt(this.padding.topLeft()).addPt(this.padding.bottomRight()).addPt(this.scrollbarOffset).maxPt(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"scrollExtent",this))}},{key:"commands",get:function get(){return this.pluginCollect("getCommands",(this._commands||[]).concat(commands$1))}},{key:"execCommand",value:function Text_execCommand_(e,t,n,r){var i=this,o=this.lookupCommand(e)||{},a=(o.name,o.command);if(a){var s=this.inMultiSelectMode(),l=a.hasOwnProperty("multiSelectAction")?a.multiSelectAction:"forEach";if(s&&"forEach"===l){var c=this.selection,u=this.selection.selections.slice().reverse();this.selection=u[0],this._multiSelection=c;try{var h=this.execCommand(e,t,n,r)}catch(e){throw this.selection=c,this._multiSelection=null,this.selection.mergeSelections(),e}if(!h)return h;var d=[h];if("function"==typeof h.then&&"function"==typeof h.catch)return lively_lang.promise.finally(lively_lang.promise.chain([function(){return h}].concat(u.slice(1).map(function(o){return function(){return i.selection=o,Promise.resolve(i.execCommand(e,t,n,r)).then(function(e){return d.push(e)})}}))).then(function(){return d}),function(){i.selection=c,i._multiSelection=null,i.selection.mergeSelections()});try{var p=!0,f=!1,g=void 0;try{for(var m,v=u.slice(1)[Symbol.iterator]();!(p=(m=v.next()).done);p=!0){var y=m.value;this.selection=y,d.push(this.execCommand(e,t,n,r))}}catch(e){f=!0,g=e}finally{try{!p&&v.return&&v.return()}finally{if(f)throw g}}}finally{this.selection=c,this._multiSelection=null,this.selection.mergeSelections()}return d}return(h=this.commandHandler.exec(e,this,t,n,r))&&("function"==typeof h.then&&"function"==typeof h.catch?h.then(function(){return cleanupScroll(i)}):cleanupScroll(this)),h}function cleanupScroll(e){(!a.hasOwnProperty("scrollCursorIntoView")||a.scrollCursorIntoView)&&lively_lang.fun.debounceNamed("execCommand-scrollCursorIntoView-"+e.id,100,function(){return e.scrollCursorIntoView()})()}}},{key:"changeDocument",value:function Text_changeDocument_(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.document)var n=this.defaultTextStyle;else t=!1;this.document=e,this.textLayout.reset(),t&&(this.defaultTextStyle=n),this.makeDirty(),this.consistencyCheck()}},{key:"textInRange",value:function Text_textInRange_(e){return this.document.textInRange(e)}},{key:"charRight",value:function Text_charRight_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition,t=e.row,n=e.column;return this.getLine(t).slice(n,n+1)}},{key:"charLeft",value:function Text_charLeft_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition,t=e.row,n=e.column;return this.getLine(t).slice(n-1,n)}},{key:"indexToPosition",value:function Text_indexToPosition_(e){return this.document.indexToPosition(e)}},{key:"positionToIndex",value:function Text_positionToIndex_(e){return this.document.positionToIndex(e)}},{key:"getVisibleLine",value:function Text_getVisibleLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row;return this.textLayout.wrappedLines(this)[e].text}},{key:"isLineVisible",value:function Text_isLineVisible_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row;return this.textLayout.isLineVisible(this,e)}},{key:"isLineFullyVisible",value:function Text_isLineFullyVisible_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row;return this.textLayout.isLineFullyVisible(this,e)}},{key:"getLine",value:function Text_getLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row;return this.document.getLineString(e)}},{key:"lineCount",value:function Text_lineCount_(){return this.document.rowCount}},{key:"isLineEmpty",value:function Text_isLineEmpty_(e){return!this.getLine(e).trim()}},{key:"isAtLineEnd",value:function Text_isAtLineEnd_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition,t=this.getLine(e.row);return e.column===t.length}},{key:"wordsOfLine",value:function Text_wordsOfLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row;return this.document.wordsOfLine(e)}},{key:"wordAt",value:function Text_wordAt_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition;return this.document.wordAt(e)}},{key:"wordLeft",value:function Text_wordLeft_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition;return this.document.wordLeft(e)}},{key:"wordRight",value:function Text_wordRight_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition;return this.document.wordRight(e)}},{key:"lineRange",value:function Text_lineRange_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];"number"!=typeof e&&this.cursorPosition.row;var n=this.getLine(e),r={start:{column:0,row:e},end:{column:n.length,row:e}},i=n.match(/^\s*/);return i[0].length&&t&&(r.start.column+=i[0].length),new Range(r)}},{key:"screenLineRange",value:function Text_screenLineRange_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.textLayout.screenLineRange(this,e,t)}},{key:"insertTextAndSelect",value:function Text_insertTextAndSelect_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e=String(e),t?this.selection.range=this.insertText(e,t):this.selection.text=e}},{key:"append",value:function Text_append_(e){var t=this;return this.saveExcursion(function(){return t.insertText(e,t.documentEndPosition)})}},{key:"insertText",value:function Text_insertText_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cursorPosition,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.replace({start:t,end:t},e,n,r)}},{key:"deleteText",value:function Text_deleteText_(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.textAndAttributesInRange(e);return this.replace(e,[],!1,t),n}},{key:"replace",value:function Text_replace_(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=this,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];e=e.isRange?e:new Range(e);var s="string"==typeof t?[t,null]:Array.isArray(t)?t:[String(t||""),null],l=!s.length||2==s.length&&!s[0],c=e.isEmpty();if(l&&c)return e;var u=void 0;n&&(u=this.textAttributeAt({row:e.start.row,column:e.start.column-(e.start.column>0?1:0)}));for(var h=[],d=0;d<s.length;d+=2){var p=s[d],f=s[d+1];p.isMorph&&h.push(p),u&&(s[d+1]=Object.assign({},u,{},f))}o&&this.undoManager.undoStart(this,"replace");var g=this.textAndAttributesInRange(e),m=this.document.replace(e,s,this.debug&&this.debugHelper(this.debug)).inserted;return this.addMethodCallChangeDoing({target:this,selector:"replace",args:[e,s],undo:{target:this,selector:"replace",args:[m,g,!1]}},function(){var t,n,o,l;r&&(i.invalidateTextLayout(!1,!1),i.textLayout.resetLineCharBoundsCacheOfRange(i,m)),eqPosition(e.end,m.end)||(lessPosition(m.end,e.end)?(o=new Range(e).subtract(m),l=slicedToArray(o,1)[0],i.anchors.forEach(function(e){return e.onDelete(l)})):(t=new Range(m).subtract(e),n=slicedToArray(t,1)[0],i.anchors.forEach(function(e){return e.onInsert(n)})),i._multiSelection?i._multiSelection.updateFromAnchors():i.selection.updateFromAnchors()),i._updateEmbeddedMorphsDuringReplace(h,m,s,g),i.textLayout.estimateLineHeights(i,!1),a&&i.consistencyCheck()}),o&&this.undoManager.undoStop(),m}},{key:"_updateEmbeddedMorphsDuringReplace",value:function Text__updateEmbeddedMorphsDuringReplace_(e,t,n,r){for(var i=this.embeddedMorphMap,o=0;o<r.length;o+=2){var a=r[o];if(a.isMorph&&!e.includes(a)){if(i){var s=i.get(a);s&&s.anchor&&(this.removeAnchor(s.anchor),lively_bindings.disconnect(s.anchor,"position",a,"position")),i.set(a,Object.assign({},s,{anchor:null}))}a.remove()}}if(e.length)for(var l=textAndAttributesWithSubRanges(t.start,n),c=l.ranges,u=l.textAndAttributes,h=0;h<c.length;h++){var d=u[2*h];if(d.isMorph){console.assert(e.includes(d),"????");var p=c[h].start;if(d.owner!==this&&this.addMorph(d),i){if(i.has(d)){i.get(d).anchor.position=p;continue}var f=this.addAnchor(Object.assign({id:"embedded-"+d.id},p));lively_bindings.connect(f,"position",d,"position",{updater:function updater(e,t){var n=this.targetObj.owner,r=this.targetObj,i=n?n.charBoundsFromTextPosition(t).topLeft().subPt(n.origin):r.position;n&&(n._positioningSubmorph=r),e(i),n&&(n._positioningSubmorph=!1)}}).update(f.position),i.set(d,{anchor:f})}}}}},{key:"applyJsDiffPatch",value:function Text_applyJsDiffPatch_(e){var t=this,n=[],r=0,i=0,o=!0,a=!1,s=void 0;try{for(var l,c=e[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;u.removed?i=remove(r,r+u.count,i,n):u.added&&(i=insert(r,u.value,i,n)),r+=u.count}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}return n;function remove(e,n,r,i){var o=t.indexToPosition(e+r),a=t.indexToPosition(n+r);return i.push(t.deleteText({start:o,end:a})),r-(n-e)}function insert(e,n,r,i){return i.push(t.insertText(n,t.indexToPosition(e+r))),r}}},{key:"applyTextChanges",value:function Text_applyTextChanges_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments[3],i=[],o=!0,a=!1,s=void 0;try{for(var l,c=e[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=slicedToArray(l.value,3),h=u[0],d=u[1],p=u[2];if(t){var f="number"==typeof d?d:this.positionToIndex(d);if(d=f+t,p&&"string"!=typeof p&&!Array.isArray(p))p=("number"==typeof p?p:this.positionToIndex(p))+t;d=f+t}var g="number"==typeof d?this.indexToPosition(d):d;switch(h){case"delete":case"remove":var m="number"==typeof p?this.indexToPosition(p):p;i.push(this.deleteText({start:g,end:m},r));break;case"insert":i.push(this.insertText(p,g,n,r));break;default:console.warn("[applyTextChanges] unknown type: "+h)}}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}return i}},{key:"modifyLines",value:function Text_modifyLines_(e,t,n){var r=this,i=lively_lang.arr.range(e,t).map(function(e){return r.getLine(e)}).map(n).join("\n")+"\n";this.deleteText({start:{row:e,column:0},end:{row:t+1,column:0}},!1),this.insertText(i,{row:e,column:0})}},{key:"modifySelectedLines",value:function Text_modifySelectedLines_(e){var t=this.selection.isEmpty()?this.lineRange(void 0,!1):this.selection.range;return this.modifyLines(t.start.row,t.end.row,e)}},{key:"withLinesDo",value:function Text_withLinesDo_(e,t,n){var r=this;return lively_lang.arr.range(e,t).map(function(e){var t=r.getLine(e),i=Range.create(e,0,e,t.length);return n(t,i)})}},{key:"withSelectedLinesDo",value:function Text_withSelectedLinesDo_(e){var t=this.selection.isEmpty()?this.lineRange(void 0,!1):this.selection.range,n=t.start.row,r=t.end,i=r.row,o=r.column;return this.withLinesDo(n,0===o&&i>n?i-1:i,e)}},{key:"joinLine",value:function Text_joinLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=this.getLine(e),n=t+this.getLine(e+1).replace(/^\s+/,"")+this.document.constructor.newline;return this.replace({start:{column:0,row:e},end:{column:0,row:e+2}},n,!0),{row:e,column:t.length}}},{key:"whatsVisible",get:function get(){return this.textLayout.whatsVisible(this)}},{key:"flash",value:function Text_flash_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection.range,n=arguments[1],r=(n=Object.assign({time:1e3,fill:lively_graphics.Color.orange},n)).id||"flash"+lively_lang.string.newUUID();this.addMarker({id:r,range:t,style:{"background-color":n.fill.toCSSString(),"pointer-events":"none"}}),lively_lang.fun.debounceNamed("flash-"+r,n.time,function(){return e.removeMarker(r)})()}},{key:"addTextAttribute",value:function Text_addTextAttribute_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.selection,r={start:n.start,end:n.end};return this.undoManager.undoStart(this,"addTextAttribute"),this.addMethodCallChangeDoing({target:this,selector:"addTextAttribute",args:[e,r],undo:{target:this,selector:"removeTextAttribute",args:[e,r]}},function(){t.document.mixinTextAttribute(e,r),t.onAttributesChanged(r),t.consistencyCheck()}),this.undoManager.undoStop(),e}},{key:"removeTextAttribute",value:function Text_removeTextAttribute_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.selection,r={start:n.start,end:n.end};this.undoManager.undoStart(this,"removeTextAttribute"),this.addMethodCallChangeDoing({target:this,selector:"removeTextAttribute",args:[e,r],undo:{target:this,selector:"addTextAttribute",args:[e,r]}},function(){t.document.mixoutTextAttribute(e,r),t.onAttributesChanged(r),t.consistencyCheck()}),this.undoManager.undoStop()}},{key:"setTextAttributesWithSortedRanges",value:function Text_setTextAttributesWithSortedRanges_(e){this.document.setTextAttributesWithSortedRanges(e),this.consistencyCheck();for(var t=0;t<e.length;)this.onAttributesChanged(e[t]),t+=2}},{key:"textAttributeAt",value:function Text_textAttributeAt_(e){var t=this.document;this.textLayout;return t.textAttributeAt(e)}},{key:"textAttributeAtPoint",value:function Text_textAttributeAtPoint_(e){return this.textAttributeAt(this.textLayout.textPositionFromPoint(this,e))}},{key:"textAndAttributesInRange",value:function Text_textAndAttributesInRange_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection.range;return this.document.textAndAttributesInRange(e)}},{key:"resetTextAttributes",value:function Text_resetTextAttributes_(){this.document.resetTextAttributes(),this.onAttributesChanged(this.documentRange),this.consistencyCheck()}},{key:"onAttributesChanged",value:function Text_onAttributesChanged_(e){this.invalidateTextLayout(!1,!1);var t=this.textLayout;t&&t.resetLineCharBoundsCacheOfRange(this,e),this.makeDirty()}},{key:"styleAt",value:function Text_styleAt_(e){var t=this.textLayout.chunkAtPos(this,e);return t?t.style:Object.assign({},this.defaultTextStyle)}},{key:"getStyleInRange",value:function Text_getStyleInRange_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection;return this.textAndAttributesInRange(e).filter(function(e,t){return t%2!=0}).reduce(function(e,t){for(var n in t){var r=t[n];(!e.hasOwnProperty(n)||void 0!==r&&null!==r)&&(e[n]=r)}return e},{})}},{key:"setStyleInRange",value:function Text_setStyleInRange_(e){for(var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.selection,r=this.textAndAttributesInRange(n),i={start:Object.assign({},n.start),end:Object.assign({},n.start)},o=[],a=0;a<r.length;a+=2){var s=r[a],l=r[a+1],c=-1;for("string"!=typeof s&&(s=objectReplacementChar);(c=s.indexOf("\n"))>-1;){c>0&&(i.end.column=i.end.column+c,o.push(i,l));var u={row:i.end.row+1,column:0};i={start:u,end:Object.assign({},u)},s=s.slice(c+1)}i.end.column+=s.length,o.push(i,l),i={start:Object.assign({},i.end),end:Object.assign({},i.end)}}this.undoManager.undoStart(this,"setStyleInRange"),this.addMethodCallChangeDoing({target:this,selector:"setStyleInRange",args:[e,n],undo:{target:this,selector:"setTextAttributesWithSortedRanges",args:[o]}},function(){t.document.setTextAttribute(e,n),t.consistencyCheck(),t.onAttributesChanged(n)}),this.undoManager.undoStop()}},{key:"resetStyleInRange",value:function Text_resetStyleInRange_(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection,t=this.document.textAndAttributesInRange(e),n={},r=0;r<t.length;r+=2)Object.assign(n,t[r+1]);this.removeTextAttribute(n,e)}},{key:"changeStyleProperty",value:function Text_changeStyleProperty_(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.selection,i=t(this.getStyleInRange(r)[e]);this.selections.forEach(function(t){return n.addTextAttribute(defineProperty({},e,i),t)})}},{key:"inMultiSelectMode",value:function Text_inMultiSelectMode_(){return this.selection.selections&&this.selection.selections.length>1}},{key:"selectionBounds",value:function Text_selectionBounds_(){var e=this;return this.selections.map(function(t){var n=e.charBoundsFromTextPosition(t.start),r=e.charBoundsFromTextPosition(t.end);return t.start.row===t.end.row?n.union(r):lively_graphics.rect(lively_graphics.pt(e.padding.left(),n.top()),lively_graphics.pt(e.width-e.padding.left(),r.bottom()))}).reduce(function(e,t){return t.union(e)})}},{key:"documentEndPosition",get:function get(){return this.document?this.document.endPosition:{row:0,column:0}}},{key:"isAtDocumentEnd",value:function Text_isAtDocumentEnd_(){return eqPosition(this.cursorPosition,this.documentEndPosition)}},{key:"documentRange",get:function get(){return{start:{row:0,column:0},end:this.documentEndPosition}}},{key:"cursorUp",value:function Text_cursorUp_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.selection.goUp(e)}},{key:"cursorDown",value:function Text_cursorDown_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.selection.goDown(e)}},{key:"cursorLeft",value:function Text_cursorLeft_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.selection.goLeft(e)}},{key:"cursorRight",value:function Text_cursorRight_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.selection.goRight(e)}},{key:"getPositionAboveOrBelow",value:function Text_getPositionAboveOrBelow_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cursorPosition,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments[3],i=arguments[4];if(0===e)return t;"number"==typeof i&&(i-=this.padding.left());var o=t.row,a=t.column;if(n&&this.lineWrapping){var s=this.textLayout.rangesOfWrappedLine(this,t.row);if(!s.length)return t;var l,c=s.length-1-s.slice().reverse().findIndex(function(e){var n=e.start;e.end;return n.column<=t.column});s[c];if(e>=1){var u=0===c;if(!(l=u?t.row<=0?null:lively_lang.arr.last(this.textLayout.rangesOfWrappedLine(this,t.row-1)):s[c-1]))return t;u}else if(e<=-1){var h=s.length-1===c?t.row>=this.lineCount()-1?[]:this.textLayout.rangesOfWrappedLine(this,t.row+1):s.slice(c+1);if(!(l=h[0]))return t;1===h.length}o=l.start.row;var d=this.textLayout.charBoundsOfRow(this,o).slice(l.start.column,l.end.column+1);a=l.start.column+columnInCharBoundsClosestToX(d,i)}else{if(o=Math.min(Math.max(0,t.row-e),this.lineCount()-1),"number"==typeof i)a=columnInCharBoundsClosestToX(this.textLayout.charBoundsOfRow(this,o),i)}var p={row:o,column:a};return Math.abs(e)>1?this.getPositionAboveOrBelow(e+(e>1?-1:1),p,n,r,i):p;function columnInCharBoundsClosestToX(e,t){(e=e.slice()).push({x:lively_lang.arr.last(e).x+lively_lang.arr.last(e).width});for(var n=0,r=1/0,i=0;i<e.length;i++){var o=e[i].x,a=Math.abs(o-t);a<r&&(r=a,n=i)}return n}}},{key:"collapseSelection",value:function Text_collapseSelection_(){return this.selection.collapse(this.selection.lead),this.selection}},{key:"selectAll",value:function Text_selectAll_(){return this.selection.selectAll(),this.selection}},{key:"selectLine",value:function Text_selectLine_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.selection.selectLine(e,t),this.selection}},{key:"selectionOrLineString",value:function Text_selectionOrLineString_(){var e=this.selection,t=e.text,n=e.start;return t||this.getLine(n.row)}},{key:"scrollCursorIntoView",value:function Text_scrollCursorIntoView_(){this.scrollPositionIntoView(this.cursorPosition)}},{key:"centerRange",value:function Text_centerRange_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection.range,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lively_graphics.pt(0,0),n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this.charBoundsFromTextPosition(e.start).top(),i=this.charBoundsFromTextPosition(e.end).bottom()-r;if(i<this.height||!1===n){var o=r+i/2;this.scroll=this.scroll.withY(o-this.height/2).addPt(t)}else this.scroll=this.scroll.withY(r).addPt(t)}},{key:"centerRow",value:function Text_centerRow_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lively_graphics.pt(0,0);return this.alignRowAtTop(e,t.addXY(0,-this.height/2))}},{key:"alignRowAtTop",value:function Text_alignRowAtTop_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lively_graphics.pt(0,0),n=this.charBoundsFromTextPosition({row:e,column:0}).topLeft().addXY(-this.padding.left(),0);this.scroll=n.addPt(t)}},{key:"alignRowAtBottom",value:function Text_alignRowAtBottom_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cursorPosition.row,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lively_graphics.pt(0,0),n=this.charBoundsFromTextPosition({row:e,column:0}).height;this.alignRowAtTop(e,t.addXY(0,-this.textPageHeight()+n))}},{key:"scrollPositionIntoView",value:function Text_scrollPositionIntoView_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lively_graphics.pt(0,0);if(this.isClip()){var n=this.scroll,r=(this.padding,this.innerBounds().translatedBy(n).insetByRect(this.padding).insetBy(this.borderWidth)),i=this.charBoundsFromTextPosition(e);this.lineWrapping||(i=i.insetByPt(lively_graphics.pt(-20,0)));var o=r.bottom()-i.bottom()>20?"bottomLeft":"topLeft",a=i[o]().subPt(r.translateForInclusion(i)[o]()).addPt(t);0==a.x&&0==a.y||(this.scroll=this.scroll.addPt(a).addPt(t),this.isFocused()&&this.ensureKeyInputHelperAtCursor())}}},{key:"keepPosAtSameScrollOffsetWhile",value:function Text_keepPosAtSameScrollOffsetWhile_(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cursorPosition,r=this.scroll,i=(n=this.selection.lead,this.charBoundsFromTextPosition(n).y-r.y),o=!1,a=function cleanup(){return t.scroll=t.scroll.withY(t.charBoundsFromTextPosition(n).y-i)};try{var s=e();o=s&&s instanceof Promise}finally{!o&&a()}return o&&lively_lang.promise.finally(s,a),s}},{key:"saveExcursion",value:function Text_saveExcursion_(e,t){var n=this;t=Object.assign({useAnchors:!1},t);var r=this.selection.isMultiSelection?this.selection.selections.map(function(e){return e.directedRange}):[this.selection],i=t.useAnchors?r.map(function(e){var t=e.start,r=e.end;return[n.addAnchor(Object.assign({},t,{id:"save-excursion-"+lively_lang.string.newUUID()})),n.addAnchor(Object.assign({},r,{id:"save-excursion-"+lively_lang.string.newUUID()}))]}):null,o=!1,a=t.useAnchors?function(){var e=i.map(function(e){var t=slicedToArray(e,2);return{start:t[0].position,end:t[1].position}});n.selections=e,i.forEach(function(e){var t=slicedToArray(e,2),r=t[0],i=t[1];n.removeAnchor(r),n.removeAnchor(i)})}:function(){return n.selections=r};try{var s=this.keepPosAtSameScrollOffsetWhile(e);o=s&&s instanceof Promise}finally{!o&&a()}return o&&lively_lang.promise.finally(s,a),s}},{key:"alignRow",value:function Text_alignRow_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center";if(this.isClip()){var n=this.scroll,r=this.padding,i=this.innerBounds().insetByRect(r).translatedBy(n),o=this.charBoundsFromTextPosition({row:e,column:0}),a="top"===t||"bottom"===t?i[t]()-o[t]():"center"===t?i[t]().y-o[t]().y:0;a&&(this.scroll=this.scroll.addXY(0,-a))}}},{key:"fit",value:function Text_fit_(){var e=this,t=this.viewState,n=this.fixedWidth,r=this.fixedHeight;if(t._needsFit=!1,r&&n||!this.textLayout)return this;var i=this.textBounds().outsetByRect(this.padding),o=function resize(){r||e.height==i.height||(e.height=i.height),n||e.width==i.width||(e.width=i.width),e.embeddedMorphs.forEach(function(t){var n=e.embeddedMorphMap.get(t).anchor;n.position=n.position})};return t._needsFit=!1,this.document.lines.find(function(e){return e.hasEstimatedExtent})?this.whenRendered().then(o):o(),this}},{key:"fitIfNeeded",value:function Text_fitIfNeeded_(){this.viewState._needsFit&&this.fit()}},{key:"defaultLineHeight",get:function get(){var e=this.padding;return e.top()+e.bottom()+this.fontMetric.defaultLineHeight({fontSize:this.fontSize,fontFamily:this.fontFamily})}},{key:"columnInWrappedLine",value:function Text_columnInWrappedLine_(e){if(!this.lineWrapping)return e.column;var t=this.screenLineRange(e,!0).start.column;return e.column-t}},{key:"textPositionFromPoint",value:function Text_textPositionFromPoint_(e){return this.textLayout.textPositionFromPoint(this,e)}},{key:"charBoundsFromTextPosition",value:function Text_charBoundsFromTextPosition_(e){return this.textLayout.boundsFor(this,e)}},{key:"forceRerender",value:function Text_forceRerender_(){this.textLayout.reset(),this.makeDirty()}},{key:"aboutToRender",value:function Text_aboutToRender_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"aboutToRender",this).call(this,e)}},{key:"applyLayoutIfNeeded",value:function Text_applyLayoutIfNeeded_(){this.fitIfNeeded(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"applyLayoutIfNeeded",this).call(this)}},{key:"render",value:function Text_render_(e){return this.textRenderer.renderMorph(this,e)}},{key:"onMouseDown",value:function Text_onMouseDown_(e){if(!e.rightMouseButtonPressed()){this.activeMark&&(this.activeMark=null);var t=e.position,n=e.state,r=n.clickedOnMorph,i=(n.clickedOnPosition,n.clickCount);if(r===this){var o=(i-1)%3+1,a=this.localize(t),s=this.textPositionFromPoint(a);e.leftMouseButtonPressed()&&!e.isShiftDown()&&!e.isAltDown()&&this.callTextAttributeDoitFromMouseEvent(e,a),this.selectable&&(e.isShiftDown()?this.selection.lead=s:e.isAltDown()?this.selection.addRange(Range.at(s)):(this.selection.disableMultiSelect(),1===o?e.isShiftDown()?this.selection.lead=s:this.selection={start:s,end:s}:2===o?this.execCommand("select word",null,1,e):3===o&&this.execCommand("select line",null,1,e)),this.isFocused()&&this.ensureKeyInputHelperAtCursor())}}}},{key:"evalEnvForDoit",value:function Text_evalEnvForDoit_(e){var t="lively://text-doit/"+this.id;return lively.modules.module(t),{context:e.context||this,format:"esm",targetModule:t}}},{key:"callTextAttributeDoitFromMouseEvent",value:function Text_callTextAttributeDoitFromMouseEvent_(e,t){var n=this,r=this.textAttributeAtPoint(t)||[],i=r&&r.doit;if(!i||!i.code)return!1;var o=this.evalEnvForDoit(i),a=lively.modules.module(o.targetModule);return a.recorder.evt=e,lively.vm.runEval(i.code,o).catch(function(e){return n.world().logError(new Error("Error in text doit: "+e.stack))}).then(function(){return a.recorder.evt=null}),!0}},{key:"onMouseMove",value:function Text_onMouseMove_(e){e.leftMouseButtonPressed()&&this.selectable&&e.state.clickedOnMorph===this&&(this.selection.lead=this.textPositionFromPoint(this.localize(e.position)))}},{key:"selectMatchingBrackets",value:function Text_selectMatchingBrackets_(e,t){function isWhiteSpace(e){return"\t"===e||" "===e}function isAlpha(e){return(e||"").match(/^[a-zA-Z0-9\-]+$/)}function periodWithDigit(e,t){return"."==e&&"0123456789".indexOf(t)>=0}function matchBrackets(e,t,n,r,i){for(var o=r,a=1;i<0?o-1>=0:o+1<e.length;)if(e[o+=i]==t&&t!=n&&a++,e[o]==n&&a--,0==a)return o;return o}function findLine(e,t,n,r){for(var i=t;n<0?i-1>=0:i+1<e.length;)if(e[i+=n]==r)return n>0?[t,i]:[i+1,t];return n>0?[t+1,e.length-1]:[0,t]}if(!e)return t;if(0==t||t==e.length)return[0,e.length-1];var n=t-1;if(t>0){if("\n"==e[t-1]||"\r"==e[t-1])return findLine(e,t,1,e[t-1]);var r="*({[<'\"`".indexOf(e[t-1]);if("*"==e[t-1]&&(t-2<0||"/"!=e[t-2])&&(r=-1),r>=0)return[t,(n=matchBrackets(e,"*({[<'\"`"[r],"*)}]>'\"`"[r],t-1,1))-1]}if(t<e.length){if("\n"==e[t]||"\r"==e[t])return findLine(e,t,-1,e[t]);r="*)}]>'\"`".indexOf(e[t]);if("*"==e[t]&&(t+1>=e.length||"/"!=e[t+1])&&(r=-1),r>=0)return[(t=matchBrackets(e,"*)}]>'\"`"[r],"*({[<'\"`"[r],t,-1))+1,n]}if("/"===e[t-1]&&"/"===e[t-2]){for(;n+1<e.length&&"\n"!==e[n+1]&&"\r"!==e[n+1];)n++;return[t,n]}for(var i=t,o=n;i-1>=0&&isWhiteSpace(e[i-1]);)i--;for(;o<e.length&&isWhiteSpace(e[o+1]);)o++;if(o-i>=1)return[i,o];for(var a=t<e.length?e[t]:"";t-1>=0&&(isAlpha(e[t-1])||periodWithDigit(e[t-1],a));)a=e[t-1],t--;for(;n+1<e.length&&(isAlpha(e[n+1])||periodWithDigit(e[n+1],a));)a=e[n+1],n++;return[t,n]}},{key:"onContextMenu",value:function Text_onContextMenu_(e){var t=this;if(e.targetMorph===this){e.stop();var n=this.textPositionFromPoint(this.localize(e.position)),r=this.selection.selections||[this.selection];(this.selection.isEmpty()||r.every(function(e){return!e.range.containsPosition(n)}))&&(this.cursorPosition=n),Promise.resolve(this.menuItemsForContextMenu()).then(function(n){return t.openMenu(n,e)}).catch(function(e){return $world.logError(e)})}}},{key:"onDrop",value:function Text_onDrop_(e){var t=e.hand.grabbedMorphs.filter(function(e){return e.isLayoutable});if(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onDrop",this).call(this,e),t[0]){var r=this.textPositionFromPoint(this.localize(e.hand.position));this.insertText([t[0],null],r),t[0].opacity=e.state.originalOpacity||1}}},{key:"buildDropHoverGrid",value:function Text_buildDropHoverGrid_(e){var t=this;if(e.simpleDrop)return null;var n=this.whatsVisible,r=n.startRow,i=n.endRow,o=Math.min(this.documentEndPosition.row,i),a=this.document,s=this.padding.left(),l=this.padding.top(),c=lively_lang.arr.range(r,o).reduce(function(n,r){var i=t.textLayout.charBoundsOfRow(t,r).slice();if(i.length>=1&&0==lively_lang.arr.last(i).width&&(lively_lang.arr.last(i).width=12),i.length>1){var o=lively_lang.arr.last(i);i.push({x:o.x+o.width,y:o.y,height:o.height,width:o.width||12})}var c=i.map(function(n,i){var o=lively_graphics.Rectangle.fromLiteral(n).translatedBy(lively_graphics.pt(s,l+a.computeVerticalOffsetOf(r))),c=t.getGlobalTransform().transformRectToRect(o);return{textPos:{row:r,column:i},bounds:o,globalBounds:c,morph:e.showDropGrid?morph$2({reactsToPointer:!1,acceptsDrops:!1,bounds:o,border:{width:1,color:lively_graphics.Color.green},fill:null}):null}});return n.concat(c)},[]);return c.forEach(function(e){return e.morph&&t.addMorph(e.morph)}),c}},{key:"onDropHoverIn",value:function Text_onDropHoverIn_(e){var t={simpleDrop:!window.hasOwnProperty("simpleDrop")||window.simpleDrop,showDropGrid:!!window.hasOwnProperty("showDropGrid")&&window.showDropGrid,useTextFlowPlaceholder:!!window.hasOwnProperty("useTextFlowPlaceholder")&&window.useTextFlowPlaceholder},n=e.hand.grabbedMorphs[0];n&&(e.state.originalOpacity=n.opacity,n.opacity=.3);var r=this.buildDropHoverGrid(t),i=e.state.dropHover||(e.state.dropHover=new WeakMap),o=i.get(this);o||(o={},i.set(this,o)),o.config=t,o.dropGrid=r}},{key:"onDropHoverUpdate",value:function Text_onDropHoverUpdate_(e){var t=e.hand.grabbedMorphs[0];if(t){var n=e.state.dropHover;if(n){var r=n.get(this);if(r){if(!r.dropGrid){var i=this.textPositionFromPoint(e.positionIn(this));return this.focus(),void(this.cursorPosition=i)}var o=r.config,a=e.positionIn(this),s=void 0,l=void 0,c=1/0,u=!0,h=!1,d=void 0;try{for(var p,f=r.dropGrid[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=p.value;if(g.bounds.containsPoint(a)){s=g;break}var m=g.bounds.closestPointToPt(a).dist(a);m<c&&(c=m,l=g)}}catch(e){h=!0,d=e}finally{try{!u&&f.return&&f.return()}finally{if(h)throw d}}if(s||(s=l),s){var v=r.placeholder;v||(r.placeholder=v=morph$2({fill:t.fill,extent:t.extent,reactsToPointer:!1,acceptsDrops:!1})),lively_lang.obj.equals(v._textPos||{},s.textPos)||(this!==v.owner&&this.addMorph(v),v.position=s.bounds.topLeft(),o&&o.useTextFlowPlaceholder&&(v.remove(),v._textPos=s.textPos,this.insertText([v,null],s.textPos)))}}}}}},{key:"onDropHoverOut",value:function Text_onDropHoverOut_(e){var t=e.hand.grabbedMorphs[0];t&&(t.opacity=e.state.originalOpacity||1);var n=e.state.dropHover;if(n){var r=n.get(this);r&&(n.delete(this),r.dropGrid&&(r.dropGrid.forEach(function(e){return e.morph&&e.morph.remove()}),r.dropGrid=null),r.placeholder&&(r.placeholder.remove(),r.placeholder=null))}}},{key:"menuItems",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(){var e,t,r,i;return regeneratorRuntime.wrap(function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,Promise.all([lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"menuItems",this).call(this),this.menuItemsForContextMenu()]);case 2:return e=o.sent,t=slicedToArray(e,2),r=t[0],i=t[1],o.abrupt("return",r.concat({isDivider:!0}).concat(i));case 7:case"end":return o.stop()}},_callee4,this)}));return function Text_menuItems_(){return e.apply(this,arguments)}}()},{key:"menuItemsForContextMenu",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee5(){var e,t,n,r,i,o,a,s=this;return regeneratorRuntime.wrap(function _callee5$(l){for(;;)switch(l.prev=l.next){case 0:e=[{command:"text undo",alias:"undo",target:this,showKeyShortcuts:!0},{command:"text redo",alias:"redo",target:this,showKeyShortcuts:!0},{command:"manual clipboard copy",alias:"copy",target:this,showKeyShortcuts:this.keysForCommand("clipboard copy"),args:{collapseSelection:!1,delete:!1}},{command:"manual clipboard paste",alias:"paste",target:this,showKeyShortcuts:this.keysForCommand("clipboard paste")},{command:"open text attribute controls",alias:"edit text attributes",target:this},{isDivider:!0},{command:"toggle line wrapping",alias:(this.lineWrapping?"disable":"enable")+" line wrapping",target:this,showKeyShortcuts:!0},["run command",function(){s.focus(),s.world().execCommand("run command")}]],t=!0,n=!1,r=void 0,l.prev=4,i=this.plugins[Symbol.iterator]();case 6:if(t=(o=i.next()).done){l.next=15;break}if("function"!=typeof(a=o.value).getMenuItems){l.next=12;break}return l.next=11,a.getMenuItems(e);case 11:e=l.sent;case 12:t=!0,l.next=6;break;case 15:l.next=21;break;case 17:l.prev=17,l.t0=l.catch(4),n=!0,r=l.t0;case 21:l.prev=21,l.prev=22,!t&&i.return&&i.return();case 24:if(l.prev=24,!n){l.next=27;break}throw r;case 27:return l.finish(24);case 28:return l.finish(21);case 29:return l.abrupt("return",e);case 30:case"end":return l.stop()}},_callee5,this,[[4,17,21,29],[22,,24,28]])}));return function Text_menuItemsForContextMenu_(){return e.apply(this,arguments)}}()},{key:"keybindings",get:function get(){return this.pluginCollect("getKeyBindings",lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"keybindings",this).concat(config$1.text.defaultKeyBindings))}},{key:"keybindings",set:function set(e){lively.classes.runtime.initializeClass._set(Object.getPrototypeOf(n.prototype),"keybindings",e,this)}},{key:"keyhandlers",get:function get(){if(this._cachedKeyhandlers)return this._cachedKeyhandlers;var e=lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"keyhandlers",this).concat(this._keyhandlers||[]);return e=this.pluginCollect("getKeyHandlers",e),this._cachedKeyhandlers=e}},{key:"snippets",get:function get(){return this.pluginCollect("getSnippets",[]).map(function(e){if(e.isTextSnippet)return e;var t=slicedToArray(e,2),n=t[0],r=t[1];return new Snippet({trigger:n,expansion:r})})}},{key:"onKeyDown",value:function Text_onKeyDown_(e){this.compositionRange||e.targetMorph!=this||(this.selection.cursorBlinkStart(),KeyHandler.invokeKeyHandlers(this,e,!0))}},{key:"onTextInput",value:function Text_onTextInput_(e){KeyHandler.invokeKeyHandlers(this,e,!1)}},{key:"onCompositionStart",value:function Text_onCompositionStart_(e){this.insertTextAndSelect(e.data),this.compositionRange=this.selection.range}},{key:"onCompositionUpdate",value:function Text_onCompositionUpdate_(e){this.selection.range=this.compositionRange,this.selection.text=[e.data,{textDecoration:"underline"}],this.compositionRange=this.selection.range}},{key:"onCompositionEnd",value:function Text_onCompositionEnd_(e){this.selection.range=this.compositionRange,this.selection.text=e.data,this.cursorPosition=this.compositionRange.end,this.compositionRange=null}},{key:"onCut",value:function Text_onCut_(e){!this.rejectsInput()&&this.isFocused()&&(config$1.emacs||this.onCopy(e,!this.rejectsInput()))}},{key:"onCopy",value:function Text_onCopy_(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.isFocused()){e.stop();var n=this.selection;try{for(var r=this.textAndAttributesInRange(this.selection.range),i=this.defaultTextStyle,o={},a=0;a<r.length;a+=2){var s=r[a];if(s.isMorph)if(s.isDisplacementMorph)r[a]="";else{var l=o[a]=serializeMorph(r[a]);r[a]=deserializeMorph(l,{reinitializeIds:!0})}}var c=extractHTMLFromTextMorph(this,r);for(var u in e.domEvt.clipboardData.setData("text/html",c),o)r[u]=o[u];var h=JSON.stringify({textAndAttributes:r,defaultTextStyle:i});e.domEvt.clipboardData.setData("application/x-lively-text",h)}catch(e){$world.logError(e)}e.domEvt.clipboardData.setData("text/plain",n.text),this.execCommand("manual clipboard copy",{collapseSelection:config$1.codeEditor.collapseSelection||!1,delete:t,dontTryNativeClipboard:!0})}}},{key:"onPaste",value:function Text_onPaste_(e){var t=this;if(!this.rejectsInput()){e.stop();var n,r="";try{r=e.domEvt.clipboardData.getData("text")}catch(e){console.warn(e)}if(!this.editorPlugin)try{for(var i=e.domEvt.clipboardData.getData("application/x-lively-text"),o=(n=i&&JSON.parse(i)).textAndAttributes,a=0;a<o.length;a+=2)"string"!=typeof o[a]&&(o[a]=deserializeMorph(o[a],{reinitializeIds:!0}))}catch(e){console.warn(e)}var s=this.selection,l=s.isMultiSelection?s.selections:[s];n&&this.undoManager.group(),l.forEach(function(e){n?t.replace(e.range,n.textAndAttributes,!1,!0,!0):e.text=r,t.saveMark(e.start),e.collapseToEnd()}),n&&this.undoManager.group()}}},{key:"onFocus",value:function Text_onFocus_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onFocus",this).call(this,e),this.makeDirty(),this.selection.cursorBlinkStart(),this.highlightWhenFocused&&this.animate({dropShadow:this.haloShadow||this.propertiesAndPropertySettings().properties.haloShadow.defaultValue,duration:200})}},{key:"onBlur",value:function Text_onBlur_(e){this.makeDirty(),this.selection.cursorBlinkStop(),this.highlightWhenFocused&&this.animate({dropShadow:null,duration:200}),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onBlur",this).call(this,e)}},{key:"onScroll",value:function Text_onScroll_(e){this.isFocused()&&this.ensureKeyInputHelperAtCursor();var t=this.env.renderer.getNodeForMorph(this);if(t){var n=t.scrollTop,r=t.scrollLeft;lively_bindings.signal(this,"viewChanged",{prop:"scroll",value:lively_graphics.pt(r,n)})}}},{key:"ensureKeyInputHelperAtCursor",value:function Text_ensureKeyInputHelperAtCursor_(){this.env.eventDispatcher.keyInputHelper&&this.env.eventDispatcher.keyInputHelper.ensureBeingAtCursorOfText(this)}},{key:"textPageHeight",value:function Text_textPageHeight_(){var e=this.height,t=this.padding,n=this.borderWidthBottom,r=this.borderWidthTop;return e-t.top()-t.bottom()-n-r}},{key:"scrollPageDown",value:function Text_scrollPageDown_(){this.scrollDown(this.textPageHeight())}},{key:"scrollPageUp",value:function Text_scrollPageUp_(){this.scrollUp(this.textPageHeight())}},{key:"pageUpOrDown",value:function Text_pageUpOrDown_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{direction:"up",select:!1},t=e.direction,n=e.select,r=this.textLayout["down"===t?"lastFullVisibleLine":"firstFullVisibleLine"](this),i=this.cursorPosition.column,o=this.padding;n?this.selection.lead={row:r,column:i}:this.cursorPosition={row:r,column:i},"down"===t?this.alignRowAtTop(r,lively_graphics.pt(0,-o.top()-o.bottom())):(this.alignRowAtBottom(r,lively_graphics.pt(0,0)),this.alignRowAtBottom(r,lively_graphics.pt(0,o.top()+o.bottom())))}},{key:"gotoDocumentStart",value:function Text_gotoDocumentStart_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{select:!1};this.selection.lead={row:0,column:0},e&&e.select||(this.selection.anchor=this.selection.lead)}},{key:"gotoDocumentEnd",value:function Text_gotoDocumentEnd_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{select:!1};this.selection.lead=this.documentEndPosition,e&&e.select||(this.selection.anchor=this.selection.lead)}},{key:"paragraphRangeAbove",value:function Text_paragraphRangeAbove_(e){var t;if(this.isLineEmpty(e)){for(var n=e-1;n>=0;n--)if(!this.isLineEmpty(n)){t=n;break}if(void 0===t)return{start:{row:e,column:0},end:{row:e,column:0}}}else t=e;return this.paragraphRange(t)}},{key:"paragraphRangeBelow",value:function Text_paragraphRangeBelow_(e){var t,n=this.isLineEmpty(e),r=this.documentEndPosition;if(n){for(var i=e+1;i<=r.row;i++)if(!this.isLineEmpty(i)){t=i;break}if(void 0===t)return{start:{row:e,column:0},end:{row:e,column:0}}}else t=e;return this.paragraphRange(t)}},{key:"paragraphRange",value:function Text_paragraphRange_(e){if(this.isLineEmpty(e))return{start:{row:e,column:0},end:{row:e,column:0}};for(var t,n,r=this.documentEndPosition,i=e+1;i<=r.row;i++)if(this.isLineEmpty(i)){t={row:i-1,column:this.getLine(i-1).length};break}t||(t=r);for(i=t.row-1;i>=0;i--)if(this.isLineEmpty(i)){n={row:i+1,column:0};break}return n||(n={row:0,column:0}),{start:n,end:t}}},{key:"astNodeRange",value:function Text_astNodeRange_(e){return{start:this.document.indexToPosition(e.start),end:this.document.indexToPosition(e.end)}}},{key:"parseIntoLines",value:function Text_parseIntoLines_(e){return e.split("\n")}},{key:"computeTextRangeForChanges",value:function Text_computeTextRangeForChanges_(e){var t=Range.at(this.cursorPosition);if(!e.length)return t;for(var n=this,r=e[0],i="replace"===r.selector?insertRange(r.args[1],r.args[0].start):t,o=1;o<e.length;o++){var a=e[o];i="replace"===a.selector?i.merge(insertRange(a.args[1],a.args[0].start)):i}return i;function insertRange(e,t){for(var r="",i=0;i<e.length;i+=2)r+="string"==typeof e[i]?e[i]:objectReplacementChar;var o=n.parseIntoLines(r);return 1===o.length?Range.fromPositions(t,{row:t.row,column:t.column+o[0].length}):o.length>1?Range.fromPositions(t,{row:t.row+o.length-1,column:lively_lang.arr.last(o).length}):Range.at(t)}}},{key:"ensureUndoManager",value:function Text_ensureUndoManager_(){if(this.undoManager)return this.undoManager;var e=["addTextAttribute","removeTextAttribute","setStyleInRange","replace"];return this.undoManager=new UndoManager(function(t){return e.includes(t.selector)})}},{key:"textUndo",value:function Text_textUndo_(){var e=this.undoManager.undo();if(e){var t=e.changes.slice().reverse().map(function(e){return e.undo});this.selection=this.computeTextRangeForChanges(t)}}},{key:"textRedo",value:function Text_textRedo_(){var e=this.undoManager.redo();if(e){var t=e.changes.slice();this.selection=this.computeTextRangeForChanges(t)}}},{key:"findMatchingForward",value:function Text_findMatchingForward_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"right",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this["right"===t?"charRight":"charLeft"](e),i=n[r];if(!i)return null;var o="right"===t?-1:0;return this.document.scanForward(e,function(e,n){if(e===i){if(0===o)return"right"===t?{row:n.row,column:n.column+1}:n;o--}else e===r&&o++;return null})}},{key:"findMatchingBackward",value:function Text_findMatchingBackward_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"right",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this["right"===t?"charRight":"charLeft"](e),i=n[r];if(!i)return null;var o="left"===t?-1:0;return this.document.scanBackward(e,function(e,n){if(e===i){if(0===o)return"right"===t?{row:n.row,column:n.column+1}:n;o--}else e===r&&o++;return null})}},{key:"search",value:function Text_search_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{start:this.cursorPosition,backwards:!1,caseSensitive:!1};return new TextSearcher(this).search(Object.assign({needle:e},t))}},{key:"searchForAll",value:function Text_searchForAll_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{caseSensitive:!1};return new TextSearcher(this).searchForAll(Object.assign({needle:e},t))}},{key:"tokenAt",value:function Text_tokenAt_(e){return this.pluginInvokeFirst("tokenAt",e)}},{key:"astAt",value:function Text_astAt_(e){return this.pluginInvokeFirst("astAt",e)}},{key:"evalEnvironment",get:function get(){var e=this.editorPlugin;return e&&e.evalEnvironment}},{key:"evalEnvironment",set:function set(e){var t=this.editorPlugin;t&&(t.evalEnvironment=e)}},{key:"doitContext",get:function get(){return(this.evalEnvironment||{}).context}},{key:"doitContext",set:function set(e){(this.evalEnvironment||{}).context=e}},{key:"logDoit",value:function Text_logDoit_(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).time,n=void 0===t?Date.now():t,r=void 0;if(!(e.length>12e4)){try{r=JSON.parse(localStorage["lively.next-js-ide-doitlog"])}catch(e){}if(r||(r=[]),!r.some(function(t){return"string"==typeof t?t===e:t.source===e})){r.push({source:e,time:n}),r.length>50&&(r=r.slice(-50));try{localStorage["lively.next-js-ide-doitlog"]=JSON.stringify(r)}catch(e){}}}}},{key:"doEval",value:function Text_doEval_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.selection.isEmpty()?this.lineRange():this.selection.range,t=arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.textInRange(e),r=this.pluginFind(function(e){return e.isEditorPlugin&&"function"==typeof e.runEval});if(!r)throw new Error("doit not possible: cannot find js editor plugin of !"+this);return t&&t.logDoit&&this.logDoit(n,t),r.runEval(n,t)}},{key:"maybeSelectCommentOrLine",value:function Text_maybeSelectCommentOrLine_(){var e=this.selection,t=e.lead,n=t.row,r=t.column,i=this.selectionOrLineString();if(e.isEmpty()){var o=i.indexOf("//");-1===o||r<o||o>0&&":\"'".indexOf(i[o-1])>=0?this.selectLine(n):e.range={start:{row:n,column:o+2},end:{row:n,column:i.length}}}}},{key:"debugHelper",value:function Text_debugHelper_(e){return e=Object.assign({debugDocumentUpdate:!0,debugTextLayout:!0},e),this._debugHelper?Object.assign(this._debugHelper,e):this._debugHelper=Object.assign({},e,{logged:[],groups:[],reset:function reset(){this.groups=[[]],this.logged=this.groups[0]},log:function log(){for(var e,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).log.apply(e,n),this.logged.push({args:n})},dump:function dump(e){console.log(e.split("\n").map(function(e){return e.slice(0,100)}).join("\n")),this.logged.push({dump:e})},group:function group(e){this.groups.push([]),this.logged=lively_lang.arr.last(this.groups),console.group(e)},groupEnd:function groupEnd(e){console.groupEnd(e)},steps:function steps(e){for(var steps=[];e.length;){var t=lively_lang.arr.takeWhile(e,function(e){return!e.dump}),n=((e=e.slice(t.length)).shift()||{}).dump;steps.push({actions:t,dump:n})}return steps},printToConsole:function printToConsole(){var e=this;console.clear(),this.groups.forEach(function(t){var n=e.steps(t);console.group(n.length),e.steps(t).forEach(function(e,t){var n=e.actions;console.group("step "+(t+1)),n.forEach(function(e){var t,n=e.args;return(t=console).log.apply(t,toConsumableArray(n))}),console.groupEnd("step "+(t+1))}),console.groupEnd(n.length)})},report:function report(){var e=this;return asyncToGenerator(regeneratorRuntime.mark(function _callee6(){var t,n,r,i,o,a,s;return regeneratorRuntime.wrap(function _callee6$(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,System.import("jsdiff",System.decanonicalize("lively.morphic"));case 2:return t=l.sent,l.next=5,System.import("lively.ide/diff/editor-plugin.js");case 5:return n=l.sent,r=n.default,i=0,o="",a=[],s=0,e.groups.forEach(function(n,l){o+=">>> group "+(l+1)+"\n",s++,i++;var c=e.steps(n);c.forEach(function(e,n){var l=e.actions,u=e.dump;if(o+=lively_lang.string.indent(">>> step "+(n+1)," ",i)+"\n",s++,i++,l.forEach(function(e){var t=e.args,n=lively_lang.string.indent(lively_lang.string.formatFromArray(t.slice()).trim()," ",i);s+=n.split("\n").length,o+=n+"\n"}),n>=1&&u&&c[n-1].dump){var h=new r,d=t.createPatch(String(n),c[n-1].dump,u);h.tokenize(d),a.push.apply(a,toConsumableArray(h.styledRanges(s,i))),o+=d,s+=d.split("\n").length-1}o+=lively_lang.string.indent("<< step "+(n+1)," ",i)+"\n",s++,i--}),o+="<<< group "+(l+1)+"\n",s++,i--}),l.abrupt("return",{report:o,reportStyles:a});case 13:case"end":return l.stop()}},_callee6,e)}))()},openReport:function openReport(){var e=this;return asyncToGenerator(regeneratorRuntime.mark(function _callee7(){var t,n,r;return regeneratorRuntime.wrap(function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,e.report();case 2:return t=i.sent,n=t.reportStyles,r=t.report,i.abrupt("return",$world.execCommand("open text window",{title:"text debug",fontFamily:"monospace",content:r,rangesAndStyles:n}));case 6:case"end":return i.stop()}},_callee7,e)}))()}})}},{key:"consistencyCheck",value:function Text_consistencyCheck_(){if(this.debug)return this.document.consistencyCheck();try{return this.document.consistencyCheck()}catch(i){var e=this.document;this.brokenDocument||(this.brokenDocument=e);var t=this.world()||$world;try{var n=new Document([]);n.textAndAttributes=e.textAndAttributes,this.changeDocument(n)}catch(e){var r="Broken document could not be fixed";t?t.logError(r):console.error(r)}t?t.logError(i):console.error(i)}}}],[{key:"makeLabel",value:function Text_makeLabel_(e,t){return new Label(Object.assign({value:e,fontFamily:"Helvetica Neue, Arial, sans-serif",fontColor:lively_graphics.Color.almostBlack,fontSize:11},t))}},{key:"makeInputLine",value:function Text_makeInputLine_(e){return new(lively.morphic?lively.morphic.InputLine:lively.modules.module("lively.morphic").recorder.InputLine)(e)}},{key:"defaultTextStyle",get:function get(){if(this._defaultTextStyle)return this._defaultTextStyle;for(var e=this.prototype.propertiesAndPropertySettings().properties,t=this.defaultTextStyleProps,n={},r=0;r<t.length;r++){var i=t[r];n[i]=e[i].defaultValue}return this._defaultTextStyle=n}},{key:"defaultTextStyleProps",get:function get(){if(this._defaultTextStyleProps)return this._defaultTextStyleProps;var e=this.prototype.propertiesAndPropertySettings().properties,t=[];for(var n in e)e[n].isDefaultTextStyleProp&&t.push(n);return this._defaultTextStyleProps=t}},{key:"properties",get:function get(){return{clipMode:{isStyleProp:!0,defaultValue:"visible",set:function set(e){this.setProperty("clipMode",e),this.fixedWidth=this.fixedHeight=this.isClip()}},fontMetric:{group:"_rendering",serialize:!1,get:function get(){return this.getProperty("fontMetric")||this.env.fontMetric}},undoManager:{group:"core",before:["document"],initialize:function initialize(){this.ensureUndoManager()}},textRenderer:{group:"_rendering",after:["viewState"],initialize:function initialize(){this.textRenderer=new TextRenderer(this.env.domEnv)}},debug:{group:"_debugging",isStyleProp:!0,after:["textRenderer","textLayout"],defaultValue:!1,doc:"For visualizing and debugging text layout and rendering"},defaultViewState:{group:"_rendering",derived:!0,readOnly:!0,get:function get(){return{_needsFit:!0,text_layer_node:null,fontmetric_text_layer_node:null,dom_nodes:[],dom_nodeFirstRow:[],scrollTop:0,scrollHeight:0,scrollBottom:0,textHeight:0,textWidth:0,firstVisibleRow:0,lastVisibleRow:0,heightBefore:0,wasScrolled:!1,afterTextRenderHook:null}}},viewState:{group:"_rendering",initialize:function initialize(){this.viewState=this.defaultViewState}},displacingMorphMap:{group:"_rendering",initialize:function initialize(){this.displacingMorphMap=new Map}},embeddedMorphMap:{group:"_rendering",initialize:function initialize(){this.embeddedMorphMap=new Map}},embeddedMorphs:{group:"text",derived:!0,readOnly:!0,after:["embeddedMorphMap"],get:function get(){return this.embeddedMorphMap?Array.from(this.embeddedMorphMap.keys()):[]}},textLayout:{group:"_rendering",after:["textRenderer"],initialize:function initialize(){this.textLayout=new TextLayout(this)}},document:{group:"text",initialize:function initialize(){this.document=Document.fromString("",{maxLeafSize:50,minLeafSize:25,maxNodeSize:35,minNodeSize:7}),this.consistencyCheck()}},draggable:{defaultValue:!1},useSoftTabs:{group:"text",isStyleProp:!0,defaultValue:void 0===config$1.text.useSoftTabs||config$1.text.useSoftTabs},tabWidth:{group:"text",isStyleProp:!0,defaultValue:config$1.text.tabWidth||2},tab:{group:"text",isStyleProp:!0,after:["useSoftTabs","tabWidth"],readOnly:!0,get:function get(){return this.useSoftTabs?" ".repeat(this.tabWidth):"\t"}},autoInsertPairs:{group:"text",defaultValue:!0},fixedWidth:{group:"text",isStyleProp:!0,after:["clipMode","viewState"],defaultValue:!1},fixedHeight:{group:"text",isStyleProp:!0,after:["clipMode","viewState"],defaultValue:!1},readOnly:{group:"text",isStyleProp:!0,defaultValue:!1,set:function set(e){this.nativeCursor=e?"default":"auto",this.setProperty("readOnly",e)}},selectable:{group:"selection",isStyleProp:!0,after:["selection"],defaultValue:!0,set:function set(e){this.setProperty("selectable",e),e||this.selection.collapse()}},padding:{group:"styling",type:"Rectangle",isStyleProp:!0,after:["textLayout","viewState"],defaultValue:lively_graphics.Rectangle.inset(0),set:function set(e){this.setProperty("padding","number"==typeof e?lively_graphics.Rectangle.inset(e):e)}},haloShadow:{group:"styling",type:"Shadow",isStyleProp:!0,defaultValue:null},highlightWhenFocused:{group:"styling",defaultValue:!1,after:["haloShadow"],set:function set(e){this.setProperty("highlightWhenFocused",e),e&&!this.haloShadow&&(this.haloShadow={blur:6,color:lively_graphics.Color.rgb(52,152,219),distance:0,rotation:45})}},cursorPosition:{group:"selection",derived:!0,after:["selection"],get:function get(){return this.selection.lead},set:function set(e){this.selection.range={start:e,end:e}}},selection:{group:"selection",derived:!0,after:["document","anchors"],get:function get(){var e=this.getProperty("selection");return e||(e=new(config$1.text.useMultiSelect?MultiSelection:Selection)(this),this.setProperty("selection",e),e)},set:function set(e){e?e.isSelection?this.setProperty("selection",e):this.selection.range=e:(this.selection.isMultiSelection&&this.selection.disableMultiSelect(),this.selection.collapse())}},selections:{group:"selection",derived:!0,after:["selection"],get:function get(){return this.selection.isMultiSelection?this.selection.selections:[this.selection]},set:function set(e){var t=this;this.selection=e[0],this.selection.isMultiSelection&&e.slice(1).forEach(function(e){return t.selection.addRange(e)})}},textString:{group:"text",after:["document"],derived:!0,get:function get(){return this.document?this.document.textString:""},set:function set(e){e=null!=e?String(e):"",this.deleteText({start:{column:0,row:0},end:this.document.endPosition}),this.insertText(e,{column:0,row:0})}},value:{group:"text",after:["document","embeddedMorphMap"],derived:!0,get:function get(){var e=this.textAndAttributes;if(1===e.length){var t=slicedToArray(e[0],2),n=t[0],r=t[1];if(!Object.keys(r||{}).length)return n}return e},set:function set(e){"string"==typeof e?this.textString=e:this.textAndAttributes=e}},textAndAttributes:{group:"text",derived:!0,after:["document"],get:function get(){return this.document.textAndAttributes},set:function set(e){this.replace({start:{row:0,column:0},end:this.documentEndPosition},e)}},defaultTextStyleProps:{group:"_internal",readOnly:!0,derived:!0,get:function get(){return this.constructor.defaultTextStyleProps}},defaultTextStyle:{group:"styling",after:["viewState"],derived:!0,get:function get(){return lively_lang.obj.select(this,this.defaultTextStyleProps)},set:function set(e){Object.assign(this,e)}},customizedTextStyle:{group:"styling",readOnly:!0,derived:!0,get:function get(){for(var e={},t=this.defaultTextStyleProps,n=this.constructor.defaultTextStyle,r=0;r<t.length;r++){var i=t[r],o=this[i];o!==n[i]&&(e[i]=o)}return e}},nativeCursor:{defaultValue:"",isDefaultTextStyleProp:!0},fontFamily:{group:"text styling",type:"Enum",values:config$1.text.basicFontItems,defaultValue:"Sans-Serif",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},fontSize:{group:"text styling",type:"Number",min:1,unit:"pt",defaultValue:12,isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},selectionColor:{group:"text styling",type:"Color",defaultValue:lively_graphics.Color.rgba(212,230,241,.8),isStyleProp:!0,after:["defaultTextStyle"]},cursorColor:{group:"text styling",type:"Color",isStyleProp:!0,after:["defaultTextStyle"],defaultValue:lively_graphics.Color.black},fontColor:{group:"text styling",type:"Color",defaultValue:lively_graphics.Color.black,isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},fontWeight:{group:"text styling",type:"Enum",values:["bold","bolder","light","lighter","normal"],defaultValue:"normal",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},fontStyle:{group:"text styling",type:"Enum",values:["normal","italic","oblique"],defaultValue:"normal",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},textDecoration:{group:"text styling",type:"Enum",values:["none","underline"],defaultValue:"none",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},textStyleClasses:{group:"text styling",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},backgroundColor:{group:"text styling",type:"Color",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["defaultTextStyle"]},textAlign:{group:"text styling",type:"Enum",values:["center","justify","left","right"],isStyleProp:!0,isDefaultTextStyleProp:!0,after:["document","defaultTextStyle","viewState"]},lineHeight:{group:"text styling",isStyleProp:!0,isDefaultTextStyleProp:!0,defaultValue:1.4,after:["document","defaultTextStyle","viewState"]},letterSpacing:{group:"text styling",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["document","defaultTextStyle","viewState"]},wordSpacing:{group:"text styling",isStyleProp:!0,isDefaultTextStyleProp:!0,after:["document","defaultTextStyle","viewState"]},lineWrapping:{group:"text",type:"Enum",values:[!1,!0,"by-words","anywhere","only-by-words","wider","by-chars"],isStyleProp:!0,defaultValue:!1,after:["document","viewState"]},anchors:{group:"core",defaultValue:[],set:function set(e){var t=this,n=lively_lang.arr.withoutAll(e,this.anchors);lively_lang.arr.withoutAll(this.anchors,e).forEach(function(e){return t.removeAnchor(e)}),n.forEach(function(e){return t.addAnchor(e)})}},markers:{group:"core",defaultValue:[]},savedMarks:{group:"core",defaultValue:[],after:["anchors"],set:function set(e){var t=this;this.savedMarks;e=e.map(function(e){return e.isAnchor?e:t.addAnchor(Object.assign({},e,{id:"saved-mark-"+lively_lang.string.newUUID()}))});var n=this.savedMarks.filter(function(t){return!e.includes(t)});return e>config$1.text.markStackSize&&n.push.apply(n,toConsumableArray(e.splice(0,e.length-config$1.text.markStackSize))),n.map(function(e){return t.removeAnchor(e)}),this.setProperty("savedMarks",e)}},activeMarkPosition:{group:"_internal",after:["activeMark"],derived:!0,get:function get(){var e=this.activeMark;return e?e.position:null}},activeMark:{group:"core",after:["anchors"],set:function set(e){if(e)e=this.addAnchor(e.isAnchor?e:Object.assign({},e,{id:"saved-mark-"+lively_lang.string.newUUID()}));else{var t=this.activeMark;this.savedMarks.includes(t)||this.removeAnchor(t)}this.setProperty("activeMark",e)}},plugins:{group:"plugins",defaultValue:[],after:["value"],set:function set(e){var t=this,n=this.getProperty("plugins");lively_lang.arr.withoutAll(n,e).forEach(function(e){return t.removePlugin(e)}),e.forEach(function(e){return t.addPlugin(e)})}},editorModeName:{group:"plugins",derived:!0,after:["plugins"],get:function get(){var e=this.editorPlugin;return e?e.shortName:null},set:function set(e){this.changeEditorMode(e)}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:1127,end:110499})}({referencedAs:"Morph",value:Morph}),diff$1=vdom__default.diff,patch$1=vdom__default.patch,h$1=vdom__default.h,createElement=vdom__default.create,CustomVNode=function(e){var t=_classRecorder,n=t.hasOwnProperty("CustomVNode")&&"function"==typeof t.CustomVNode?t.CustomVNode:t.CustomVNode=function CustomVNode(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function CustomVNode_initialize_(e,t){this.morph=e,this.renderer=t,this.morphVtree=null,this.key="custom-"+e.id}},{key:"type",get:function get(){return"Widget"}},{key:"renderMorph",value:function CustomVNode_renderMorph_(){var e=this.morph,t=this.renderer,n=this.morphVtree=t.renderMorph(e),r="customNode-key-"+e.id;return n.children[0]&&n.children[0].key===r||n.children.unshift(h$1(e.domNodeTagName||"div",{key:r},[])),n}},{key:"init",value:function CustomVNode_init_(){var e=createElement(this.renderMorph(),this.renderer.domEnvironment);return e.childNodes[0].appendChild(this.morph.domNode),e}},{key:"update",value:function CustomVNode_update_(e,t){var n=e.morphVtree||this.renderMorph(),r=this.renderMorph(),i=diff$1(n,r);return patch$1(t,i),null}},{key:"destroy",value:function CustomVNode_destroy_(e){console.log("[HTMLMorph] node of "+this.morph.name+" gets removed from DOM")}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:381,end:1946})}(void 0),HTMLMorph=function(e){var t=_classRecorder,n=t.hasOwnProperty("HTMLMorph")&&"function"==typeof t.HTMLMorph?t.HTMLMorph:t.HTMLMorph=function HTMLMorph(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"isHTMLMorph",get:function get(){return!0}},{key:"defaultHTML",get:function get(){return'\n<div style="display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 100%;\n            background: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(0%, rgba(242,243,244,1)),color-stop(100%, rgba(229,231,233,1)))">\n  <p style="font: bold 40pt Inconsolata, monospace; color: lightgray;">&lt;HTML&#x2F;&gt;</p>\n</div>'}},{key:"render",value:function HTMLMorph_render_(e){return new CustomVNode(this,e)}},{key:"menuItems",value:function HTMLMorph_menuItems_(){var e=this,t=lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"menuItems",this).call(this);return t.unshift(["edit html...",function(){return e.world().execCommand("open workspace",{language:"html",content:e.html,target:e})}],{isDivider:!0}),t}}],[{key:"properties",get:function get(){return{extent:{defaultValue:lively_graphics.pt(420,330)},html:{after:["cssDeclaration"],initialize:function initialize(){this.html=this.defaultHTML},get:function get(){return this.domNode.innerHTML},set:function set(e){if(this.domNode.innerHTML=e,e.includes("<script")){var t=this.domNode.querySelectorAll("script"),n=!0,r=!1,i=void 0;try{for(var o,a=t[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value,l=s.parentNode;s.remove();var c=document.createElement("script"),u=!0,h=!1,d=void 0;try{for(var p,f=s.attributes[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=p.value,m=g.name,v=g.value;c.setAttribute(m,v)}}catch(e){h=!0,d=e}finally{try{!u&&f.return&&f.return()}finally{if(h)throw d}}var y=!0,_=!1,b=void 0;try{for(var x,w=s.childNodes[Symbol.iterator]();!(y=(x=w.next()).done);y=!0){var k=x.value;c.appendChild(k)}}catch(e){_=!0,b=e}finally{try{!y&&w.return&&w.return()}finally{if(_)throw b}}l.appendChild(c)}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}}}},domNodeTagName:{readOnly:!0,get:function get(){return"div"}},domNodeStyle:{readOnly:!0,get:function get(){return"position: absolute; width: 100%; height: 100%;"}},domNode:{derived:!0,get:function get(){return this._domNode||(this._domNode=this.document.createElement(this.domNodeTagName),this._domNode.setAttribute("style",this.domNodeStyle)),this._domNode},set:function set(e){return this.domNode.parentNode&&this.domNode.parentNode.replaceChild(e,this.domNode),this._domNode=e}},document:{readOnly:!0,get:function get(){return this.env.domEnv.document}},scrollExtent:{readOnly:!0,get:function get(){return lively_graphics.pt(this.domNode.scrollWidth,this.domNode.scrollHeight)}},cssDeclaration:{set:function set(e){var t=this;if(this.setProperty("cssDeclaration",e),e)System.import("lively.ide/css/parser.js").then(function(n){var r=n.parse(e);r.stylesheet.rules.forEach(function(e){e.selectors&&(e.selectors=e.selectors.map(function(e){return"#"+t.id+" "+e}))}),addOrChangeCSSDeclaration("css-for-"+t.id,n.stringify(r))}).catch(function(e){return console.error("Error setting cssDeclaration of "+t+": "+e)});else{var n=this.env.domEnv.document.getElementById("css-for-"+this.id);n&&n.remove()}}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:2271,end:5895})}({referencedAs:"Morph",value:Morph}),IFrameMorph=function(e){var t=_classRecorder,n=t.hasOwnProperty("IFrameMorph")&&"function"==typeof t.IFrameMorph?t.IFrameMorph:t.IFrameMorph=function IFrameMorph(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"isIFrameMorph",get:function get(){return!0}},{key:"reload",value:function IFrameMorph_reload_(){return this.src?this.loadURL(this.src):this.srcDoc?this.displayHTML(this.srcDoc):null}},{key:"whenLoaded",value:function IFrameMorph_whenLoaded_(){return this._whenLoaded||Promise.resolve()}},{key:"displayHTML",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var t,n,r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return t=i.keepScroll,(n=void 0===t||t)&&(r=this.iframeScroll),this.srcDoc=e,o.next=5,this.whenLoaded();case 5:return n&&r&&(this.iframeScroll=r),o.abrupt("return",this);case 7:case"end":return o.stop()}},_callee,this)}));return function IFrameMorph_displayHTML_(t){return e.apply(this,arguments)}}()},{key:"loadURL",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var t,n,r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return t=i.keepScroll,(n=void 0===t||t)&&(r=this.iframeScroll),this.src=e,o.next=5,this.whenLoaded();case 5:return n&&r&&(this.iframeScroll=r),o.abrupt("return",this);case 7:case"end":return o.stop()}},_callee2,this)}));return function IFrameMorph_loadURL_(t){return e.apply(this,arguments)}}()},{key:"defaultSrcDoc",get:function get(){return'\n    <div style="display: flex;\n                align-items: center;\n                justify-content: center;\n                height: 100%;\n                background: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(0%, rgba(242,243,244,1)),color-stop(100%, rgba(229,231,233,1)))">\n      <p style="font: bold 40pt Inconsolata, monospace; color: lightgray;">&lt;iFrame&#x2F;&gt;</p>\n    </div>'}},{key:"defaultHTML",get:function get(){return'<iframe width="100%" height="100%" frameBorder="false" srcdoc=""></iframe>'}}],[{key:"example",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(){var e;return regeneratorRuntime.wrap(function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return(e=(new IFrameMorph).openInWindow({title:"iframe"}).targetMorph).srcDoc="",e.src="http://localhost:9011/worlds/html%20export",t.next=5,e.loadURL("https://google.com");case 5:return e.iframe.src,e.iframe.srcDoc,e.src="",e.srcDoc="fooo",t.next=11,e.reload();case 11:case"end":return t.stop()}},_callee3,this)}));return function IFrameMorph_example_(){return e.apply(this,arguments)}}()},{key:"properties",get:function get(){return{html:{initialize:function initialize(){this.html=this.defaultHTML,this.srcDoc=this.defaultSrcDoc}},iframe:{derived:!0,readOnly:!0,after:["domNode"],get:function get(){return this.domNode.querySelector("iframe")}},src:{derived:!0,after:["iframe"],get:function get(){return this.iframe.src},set:function set(e){this.iframe.removeAttribute("srcDoc"),this.iframe.src=e;var t=lively_lang.promise.deferred(),n=(t.promise,t.resolve);t.reject;this._whenLoaded=lively_lang.promise,this.iframe.onload=function(e){return n(e)}}},srcDoc:{derived:!0,after:["iframe"],get:function get(){return this.iframe.srcdoc},set:function set(e){this.iframe.removeAttribute("src"),this.iframe.srcdoc=e,this._whenLoaded=this.whenRendered().then(function(){return lively_lang.promise.delay(20)})}},iframeScroll:{derived:!0,after:["iframe"],get:function get(){try{var e=this.iframe.contentWindow,t=e.scrollX,n=e.scrollY;return lively_graphics.pt(t,n)}catch(e){return lively_graphics.pt(0,0)}},set:function set(e){try{this.iframe.contentWindow.scrollTo(e.x,e.y)}catch(e){}}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:5905,end:9097})}({referencedAs:"HTMLMorph",value:HTMLMorph}),Layout=function(e){var t=_classRecorder,n=t.hasOwnProperty("Layout")&&"function"==typeof t.Layout?t.Layout:t.Layout=function Layout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function Layout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.spacing,n=e.padding,r=e.border,i=e.container,o=e.manualUpdate,a=e.autoResize,s=e.ignore,l=e.onScheduleApply,c=e.layoutOrder,u=e.reactToSubmorphAnimations;this.applyRequests=!1,this.border=Object.assign({top:0,left:0,right:0,bottom:0},r),this.ignore=s||[],this.lastBoundsExtent=this.container&&this.container.bounds().extent(),this.active=!1,this.container=i,this.manualUpdate=o,this.reactToSubmorphAnimations=u||!1,this.autoResize=void 0==a||a,this.onScheduleApply=l||function(e,t,n){},c&&(this.layoutOrder=c,this.layoutOrderSource=JSON.stringify(String(c))),this.spacing=t||0,this._padding=n?"number"==typeof n?lively_graphics.Rectangle.inset(n):n:null}},{key:"attach",value:function Layout_attach_(){this.apply(),this.refreshBoundsCache()}},{key:"copy",value:function Layout_copy_(){return new this.constructor(this)}},{key:"description",value:function Layout_description_(){return"Describe the layout behavior here."}},{key:"name",value:function Layout_name_(){return"Name presented to the user."}},{key:"isEnabled",value:function Layout_isEnabled_(){return!this.active}},{key:"disable",value:function Layout_disable_(){this.active=!0}},{key:"enable",value:function Layout_enable_(e){this.active=!1,this.scheduleApply(null,e)}},{key:"padding",get:function get(){return this._padding}},{key:"padding",set:function set(e){"number"==typeof e&&(e=lively_graphics.Rectangle.inset(e)),this._padding=e,this.apply()}},{key:"boundsChanged",value:function Layout_boundsChanged_(e){return!(this.lastBoundsExtent&&e.bounds().extent().equals(this.lastBoundsExtent))}},{key:"extentChanged",value:function Layout_extentChanged_(e){return!(this.lastExtent&&e.extent.equals(this.lastExtent))}},{key:"layoutableSubmorphs",get:function get(){var e=this;return this.layoutOrder||(this.layoutOrder=lively_lang.Closure.fromSource(JSON.parse(this.layoutOrderSource)).recreateFunc()),lively_lang.arr.sortBy(this.container.submorphs.filter(function(t){return t.isLayoutable&&!e.ignore.includes(t.name)}),function(t){return e.layoutOrder(t)})}},{key:"layoutOrder",value:function Layout_layoutOrder_(e){return this.container.submorphs.indexOf(e)}},{key:"submorphBoundsChanged",get:function get(){var e=this.layoutableSubmorphs,t=this.layoutableSubmorphBounds;if(!t||e.length!=t.length)return!0;for(var n=0;n<e.length;n++){var r=e[n];if(!t[n].equals(r.bounds()))return!0}return!1}},{key:"refreshBoundsCache",value:function Layout_refreshBoundsCache_(){this.lastExtent=this.container.extent,this.layoutableSubmorphBounds=this.layoutableSubmorphs.map(function(e){return e.bounds()})}},{key:"onContainerRender",value:function Layout_onContainerRender_(){this.forceLayout()}},{key:"noLayoutActionNeeded",get:function get(){return!this.submorphBoundsChanged&&!this.boundsChanged(this.container)&&!this.extentChanged(this.container)}},{key:"__dont_serialize__",get:function get(){return["lastAnim","animationPromise"]}},{key:"forceLayout",value:function Layout_forceLayout_(){var e=this;if(this.applyRequests){if(this.applyRequests=!1,this.noLayoutActionNeeded)return;this.refreshBoundsCache(),this.container.withMetaDo({isLayoutAction:!0,animation:this.lastAnim},function(){return e.apply(e.lastAnim)}),this.lastAnim=!1}}},{key:"forceLayoutsInNextLevel",value:function Layout_forceLayoutsInNextLevel_(){this.layoutableSubmorphs.forEach(function forceLayouts(e){e.layout?e.layout.forceLayout():e.submorphs.forEach(forceLayouts)})}},{key:"scheduleApply",value:function Layout_scheduleApply_(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};"function"==typeof this.onScheduleApply&&this.onScheduleApply(e,t,n),this.active||(t&&(this.lastAnim=t),this.applyRequests=!0)}},{key:"onSubmorphResized",value:function Layout_onSubmorphResized_(e,t){this.scheduleApply(e,this.reactToSubmorphAnimations&&t.meta.animation,t)}},{key:"onSubmorphAdded",value:function Layout_onSubmorphAdded_(e,t){this.scheduleApply(e,t)}},{key:"onSubmorphRemoved",value:function Layout_onSubmorphRemoved_(e,t){this.scheduleApply(e,t)}},{key:"onChange",value:function Layout_onChange_(e){var t=e.selector,n=e.args,r=e.prop,i=e.value,o=e.prevValue,a=e.meta,s=this.reactToSubmorphAnimations&&a&&a.animation,l=n&&n[0];switch(t){case"removeMorph":this.onSubmorphRemoved(l,s);break;case"addMorphAt":this.onSubmorphAdded(l,s)}"extent"===r&&i&&o&&(o.x!==i.x||o.y!==i.y)&&this.scheduleApply(l,s)}},{key:"affectsLayout",value:function Layout_affectsLayout_(e,t){var n=t.prop,r=t.value,i=t.prevValue;return["position","scale","rotation","isLayoutable","extent"].includes(n)&&!lively_lang.obj.equals(r,i)}},{key:"onSubmorphChange",value:function Layout_onSubmorphChange_(e,t){if(t.meta&&t.meta.isLayoutAction)return this.scheduleApply(e,this.reactToSubmorphAnimation&&t.meta.animation);this.affectsLayout(e,t)&&this.onSubmorphResized(e,t)}},{key:"changePropertyAnimated",value:function Layout_changePropertyAnimated_(e,t,n,r){if(r){var i,o=r.duration,a=r.easing;this.animationPromise=e.animate((defineProperty(i={},t,n),defineProperty(i,"duration",o),defineProperty(i,"easing",a),i))}else e[t]=n}},{key:"attachAnimated",value:function Layout_attachAnimated_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments[1],n=arguments[2];this.active||(this.container=t,this.apply({duration:e,easing:n}),this.active=!0,t.layout=this,this.active=!1)}},{key:"apply",value:function Layout_apply_(e){this.active||(this.active=!0,this.lastBoundsExtent=this.container&&this.container.bounds().extent(),this.active=!1)}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:281,end:6436})}(void 0),CustomLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("CustomLayout")&&"function"==typeof t.CustomLayout?t.CustomLayout:t.CustomLayout=function CustomLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function CustomLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.relayout=e.relayout,this.layouterString=JSON.stringify(String(e.relayout)),this.varMapping=e.varMapping||{},lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e)}},{key:"name",value:function CustomLayout_name_(){return"Custom Layout"}},{key:"apply",value:function CustomLayout_apply_(e){if(!this.active&&this.container){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,e),this.active=!0,this.relayout||(this.relayout=lively_lang.Closure.fromSource(JSON.parse(this.layouterString),this.varMapping).recreateFunc());try{this.relayout(this.container,e)}catch(e){console.error("Error in relayout() of a custom layout:",e)}this.lastBoundsExtent=this.container&&this.container.bounds().extent(),this.active=!1}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:6445,end:7391})}({referencedAs:"Layout",value:Layout}),SnapLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("SnapLayout")&&"function"==typeof t.SnapLayout?t.SnapLayout:t.SnapLayout=function SnapLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function SnapLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this._spacing=e.spacing}},{key:"name",value:function SnapLayout_name_(){return"Snap"}},{key:"description",value:function SnapLayout_description_(){return"Fits the parent morph to the combined bounds of all its submorphs."}},{key:"apply",value:function SnapLayout_apply_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active&&this.container){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,t);var r=this.container.submorphBounds().insetBy(-this.spacing),i=lively_graphics.pt(this.spacing,this.spacing).subPt(r.topLeft());i.r()&&this.container.submorphs.forEach(function(n){return e.changePropertyAnimated(n,"position",n.position.addPt(i),t)}),this.changePropertyAnimated(this.container,"extent",r.extent(),t)}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:7401,end:8196})}({referencedAs:"Layout",value:Layout}),FillLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("FillLayout")&&"function"==typeof t.FillLayout?t.FillLayout:t.FillLayout=function FillLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function FillLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.morphs=e.morphs||[],this.fixedHeight=e.fixedHeight,this.fixedWidth=e.fixedWidth,this._spacing=0}},{key:"name",value:function FillLayout_name_(){return"Fill"}},{key:"description",value:function FillLayout_description_(){return"Forces all submorphs to match the extent of their owner."}},{key:"spacing",set:function set(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(lively_lang.obj.isNumber(e))var t=n=r=i=e;else{t=e.top;var n=e.left,r=e.right,i=e.bottom;t=t||0,n=n||0,r=r||0,i=i||0}this._spacing={top:t,left:n,right:r,bottom:i},this.apply()}},{key:"spacing",get:function get(){return this._spacing}},{key:"apply",value:function FillLayout_apply_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active&&this.container){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,t);var r=this.fixedWidth,i=this.fixedHeight,o=this.spacing,a=o.top,s=o.bottom,l=o.left,c=o.right,u=!i&&this.container.height-a-s,h=!r&&this.container.width-l-c;this.active=!0,this.morphs.forEach(function(n){if(n.isLayoutable){n=e.container.getSubmorphNamed(n);var r=lively_graphics.pt(l,a).extent(lively_graphics.pt(h||n.width,u||n.height));if(t){var i=t.duration,o=t.easing;n.animate({bounds:r,duration:i,easing:o})}else n.setBounds(r)}}),this.active=!1}}},{key:"layoutOrder",value:function FillLayout_layoutOrder_(e){return e.top}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:8205,end:9855})}({referencedAs:"Layout",value:Layout}),FloatLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("FloatLayout")&&"function"==typeof t.FloatLayout?t.FloatLayout:t.FloatLayout=function FloatLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"layoutOrder",value:function FloatLayout_layoutOrder_(e){return e.left}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:9857,end:9940})}({referencedAs:"Layout",value:Layout}),VerticalLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("VerticalLayout")&&"function"==typeof t.VerticalLayout?t.VerticalLayout:t.VerticalLayout=function VerticalLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function VerticalLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this._resizeSubmorphs=void 0!==e.resizeSubmorphs&&e.resizeSubmorphs,this._align=e.align||"left"}},{key:"name",value:function VerticalLayout_name_(){return"Vertical"}},{key:"description",value:function VerticalLayout_description_(){return"Assemble the submorphs in a vertically growing list."}},{key:"inspect",value:function VerticalLayout_inspect_(e){return new lively_halos_layout_js.FlexLayoutHalo(this.container,e)}},{key:"equals",value:function VerticalLayout_equals_(e){return!(!e.name||"Vertical"!=e.name())&&(this.spacing==e.spacing&&this.align==e.align)}},{key:"possibleAlignValues",get:function get(){return["left","center","right"]}},{key:"align",get:function get(){return this._align}},{key:"align",set:function set(e){this._align=e,this.apply()}},{key:"autoResize",get:function get(){return this._autoResize}},{key:"autoResize",set:function set(e){this._autoResize=e,this.apply()}},{key:"spacing",get:function get(){return this._spacing}},{key:"spacing",set:function set(e){this._spacing=e,this.apply()}},{key:"resizeSubmorphs",get:function get(){return this._resizeSubmorphs}},{key:"resizeSubmorphs",set:function set(e){this._resizeSubmorphs=e,this.apply()}},{key:"apply",value:function VerticalLayout_apply_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active&&this.container){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,e);var t=this.container,r=this.autoResize,i=this.resizeSubmorphs,o=this.spacing,a=this.align,s=this.layoutableSubmorphs,l=this.padding,c=l?l.left():0,u=l?l.right():0,h=l?l.top():0,d=l?l.bottom():0,p=lively_graphics.pt(c+o,h+o),f=t.width,g=f-2*o-c-u,m=0;this.active=!0;var v=!0,y=!1,_=void 0;try{for(var b,x=s[Symbol.iterator]();!(v=(b=x.next()).done);v=!0){var w=b.value,k=w.position,S=k.x,C=k.y,M=w.extent.x,T=p.y,P=p.x,A="topLeft";if(i&&M!==g&&(w.width=g),"center"==a&&(A="topCenter",P=f/2),"right"==a&&(A="topRight",P=f-u-o),S!==P||C!==T)if(e){var L,R=e.duration,E=e.easing;w.animate((defineProperty(L={},A,lively_graphics.pt(P,T)),defineProperty(L,"duration",R),defineProperty(L,"easing",E),L))}else w[A]=lively_graphics.pt(P,T);p=w.bottomLeft.addPt(lively_graphics.pt(0,o)),m=Math.max(w.bounds().width,m)}}catch(e){y=!0,_=e}finally{try{!v&&x.return&&x.return()}finally{if(y)throw _}}if(this.forceLayoutsInNextLevel(),r&&s.length>0){var O=lively_graphics.pt(m+2*o+c+u,d+p.y);if(e){var z=e.duration,D=e.easing;this.container.animate({height:O.y,duration:z,easing:D})}else this.container.height=O.y}this.lastBoundsExtent=this.container.bounds().extent(),this.active=!1}}},{key:"layoutOrder",value:function VerticalLayout_layoutOrder_(e){return e.top}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:9949,end:13395})}({referencedAs:"FloatLayout",value:FloatLayout}),HorizontalLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("HorizontalLayout")&&"function"==typeof t.HorizontalLayout?t.HorizontalLayout:t.HorizontalLayout=function HorizontalLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function HorizontalLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this._direction=e.direction||"leftToRight",this._align=e.align||"top"}},{key:"name",value:function HorizontalLayout_name_(){return"Horizontal"}},{key:"description",value:function HorizontalLayout_description_(){return"Assemble the submorphs in a horizontally growing list."}},{key:"inspect",value:function HorizontalLayout_inspect_(e){return new lively_halos_layout_js.FlexLayoutHalo(this.container,e)}},{key:"possibleDirectionValues",get:function get(){return["leftToRight","rightToLeft","centered"]}},{key:"direction",get:function get(){return this._direction}},{key:"direction",set:function set(e){this._direction=e,this.apply()}},{key:"possibleAlignValues",get:function get(){return["top","center","bottom"]}},{key:"align",get:function get(){return this._align}},{key:"align",set:function set(e){this._align=e,this.apply()}},{key:"autoResize",get:function get(){return this._autoResize}},{key:"autoResize",set:function set(e){this._autoResize=e,this.apply()}},{key:"spacing",get:function get(){return this._spacing}},{key:"spacing",set:function set(e){this._spacing=e,this.apply()}},{key:"apply",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(){var e,t,r,i,o,a,s,l,c,u,h,d,p,f,g,m,v,y,_,b,x,w,k=this,S=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return regeneratorRuntime.wrap(function _callee$(C){for(;;)switch(C.prev=C.next){case 0:if(!this.active&&this.container&&this.container.submorphs.length){C.next=2;break}return C.abrupt("return");case 2:if(e=this.direction,t=this.align,r=this.spacing,i=this.container,o=this.autoResize,(a=this.layoutableSubmorphs).length){C.next=5;break}return C.abrupt("return");case 5:if(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,S),this.active=!0,this.maxHeight=0,s=this.computeMinContainerExtent(r,i,a),o||(s=s.maxPt(i.extent)),l=0,c=!1,"rightToLeft"!==e){C.next=17;break}c=!0,a=a.reverse(),l=Math.max(0,i.width-2*r),C.next=39;break;case 17:if("centered"!==e){C.next=39;break}for(o?i.width-s.x:s.x,u=a.length-1*r,h=!0,d=!1,p=void 0,C.prev=22,f=a[Symbol.iterator]();!(h=(g=f.next()).done);h=!0)m=g.value,u+=m.width;C.next=30;break;case 26:C.prev=26,C.t0=C.catch(22),d=!0,p=C.t0;case 30:C.prev=30,C.prev=31,!h&&f.return&&f.return();case 33:if(C.prev=33,!d){C.next=36;break}throw p;case 36:return C.finish(33);case 37:return C.finish(30);case 38:l=s.x/2-u/2;case 39:return o&&(v=0,"centered"===e?(y=a[0].left,v=lively_lang.arr.last(a).right+y):v=lively_lang.arr.last(a).right+r,_=lively_graphics.pt(Math.max(s.x,v),s.y+2*r),this.changePropertyAnimated(i,"extent",_,S)),"top"===t?(b=r,a.reduce(function(e,t){return k.changePropertyAnimated(t,c?"topRight":"topLeft",e,S),c?t.topLeft.subPt(lively_graphics.pt(r,0)):t.topRight.addPt(lively_graphics.pt(r,0))},lively_graphics.pt(Math.max(0,l)+r,b)),this.forceLayoutsInNextLevel()):"bottom"===t?(x=s.y+(o?r:-r),a.reduce(function(e,t){return k.changePropertyAnimated(t,c?"bottomRight":"bottomLeft",e,S),c?t.bottomLeft.subPt(lively_graphics.pt(r,0)):t.bottomRight.addPt(lively_graphics.pt(r,0))},lively_graphics.pt(Math.max(0,l)+r,x)),this.forceLayoutsInNextLevel()):(w=i.height/2,a.reduce(function(e,t){return k.changePropertyAnimated(t,c?"rightCenter":"leftCenter",e,S),c?t.leftCenter.subPt(lively_graphics.pt(r,0)):t.rightCenter.addPt(lively_graphics.pt(r,0))},lively_graphics.pt(Math.max(0,l)+r,w)),this.forceLayoutsInNextLevel()),this.lastBoundsExtent=this.container.bounds().extent(),this.active=!1,C.abrupt("return",this.animationPromise);case 44:case"end":return C.stop()}},_callee,this,[[22,26,30,38],[31,,33,37]])}));return function HorizontalLayout_apply_(){return e.apply(this,arguments)}}()},{key:"equals",value:function HorizontalLayout_equals_(e){return!(!e.name||"Horizontal"!=e.name())&&(this.spacing==e.spacing&&(this.align==e.align&&this.direction==e.direction))}},{key:"computeMinContainerExtent",value:function HorizontalLayout_computeMinContainerExtent_(e,t,n){for(var r=(n.length+1)*e,i=0,o=0,a=0;a<n.length;a++){var s=n[a].extent,l=s.x,c=s.y;i+=l,o=Math.max(c,o)}return lively_graphics.pt(i+r,o)}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:13404,end:17971})}({referencedAs:"FloatLayout",value:FloatLayout}),ProportionalLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("ProportionalLayout")&&"function"==typeof t.ProportionalLayout?t.ProportionalLayout:t.ProportionalLayout=function ProportionalLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"name",value:function ProportionalLayout_name_(){return"Proportional"}},{key:"description",value:function ProportionalLayout_description_(){return"Resizes, scales, and moves morphs according to their original position."}},{key:"inspect",value:function ProportionalLayout_inspect_(e){return new lively_halos_layout_js.ProportionalLayoutHalo(this.container,e)}},{key:Symbol.for("lively-instance-initialize"),value:function ProportionalLayout_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.extentDelta=lively_graphics.pt(0,0),this.proportionalLayoutSettingsForMorphs=new WeakMap,this.submorphSettings=e&&e.submorphSettings||[]}},{key:"__dont_serialize__",get:function get(){return[].concat(toConsumableArray(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"__dont_serialize__",this)),["extentDelta","lastExtent"])}},{key:"__after_deserialize__",value:function ProportionalLayout___after_deserialize___(e,t){var n=this._submorphSettings,r=this.container,i=this.proportionalLayoutSettingsForMorphs||new WeakMap;if(this.extentDelta=lively_graphics.pt(0,0),n&&r){var o=!0,a=!1,s=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=slicedToArray(l.value,2),h=u[0],d=u[1],p=this._morphsMatchingSelector(r,h),f=slicedToArray(p,1)[0];f&&i.set(f,d)}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}this.proportionalLayoutSettingsForMorphs=i}}},{key:"onSubmorphChange",value:function ProportionalLayout_onSubmorphChange_(e,t,r,i){if("name"===t.prop){var o=this.proportionalLayoutSettingsForMorphs.get(e);o&&this.changeSettingsFor(e,o,!0)}return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onSubmorphChange",this).call(this,e,t)}},{key:"settingsFor",value:function ProportionalLayout_settingsFor_(e){return this.proportionalLayoutSettingsForMorphs.get(e)||{x:"scale",y:"scale"}}},{key:"changeSettingsFor",value:function ProportionalLayout_changeSettingsFor_(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("string"==typeof t&&(t={x:t,y:t}),this.proportionalLayoutSettingsForMorphs.set(e,Object.assign({},this.settingsFor(e),{},t)),n){var r=this.submorphSettings.filter(function(t){return t[0]!==e.name});r.push([e.name,this.settingsFor(e)]),this._submorphSettings=r}}},{key:"submorphSettings",get:function get(){return this._submorphSettings}},{key:"submorphSettings",set:function set(e){this.container?(this._submorphSettings=e,this.changeSubmorphSettings(e)):lively_bindings.once(this,"container",this,"submorphSettings",{converter:function converter(){return e},varMapping:{submorphSettings:e}})}},{key:"changeSubmorphSettings",value:function ProportionalLayout_changeSubmorphSettings_(e){var t=this,n=!0,r=!1,i=void 0;try{for(var o,a=function _loop(){var e=slicedToArray(o.value,2),n=e[0],r=e[1];t._morphsMatchingSelector(t.container,n).forEach(function(e){return t.changeSettingsFor(e,r)})},s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0)a()}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}}},{key:"_morphsMatchingSelector",value:function ProportionalLayout__morphsMatchingSelector_(e,t){var n=this,r=[];return t?(t.isMorph?r=[t]:t instanceof RegExp?r=e.submorphs.filter(function(e){return e.name.match(t)}):"string"==typeof t?r=e.submorphs.filter(function(e){return e.name===t}):Array.isArray(t)&&(r=lively_lang.arr.flatmap(t,function(t){return n._morphsMatchingSelector(e,t)})),r):r}},{key:"refreshBoundsCache",value:function ProportionalLayout_refreshBoundsCache_(){var e=this.container.extent,t=this.lastExtent;t&&!e.eqPt(t)&&(this.extentDelta=this.extentDelta.addPt(e.subPt(t))),this.lastExtent=e,this.layoutableSubmorphBounds=this.layoutableSubmorphs.map(function(e){return e.bounds()})}},{key:"apply",value:function ProportionalLayout_apply_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.container,r=this.active,i=this.extentDelta,o=i.x,a=i.y,s=(t||{}).extent;if(!r&&t&&(0!=o||0!=a)){this.extentDelta=lively_graphics.pt(0,0),this.active=!0,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,e);var l=this.layoutableSubmorphs,c=s.scaleByPt(s.addXY(-o,-a).invertedSafely()),u=!0,h=!1,d=void 0;try{for(var p,f=l[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=p.value,m=this.settingsFor(g),v=m.x,y=m.y,_=0,b=0,x=0,w=0;if("move"===v&&(_=o),"move"===y&&(b=a),"resize"===v&&(x=o),"resize"===y&&(w=a),"scale"===v||"scale"===y){var k=lively_graphics.pt("scale"===v?c.x:1,"scale"===y?c.y:1);g.position=g.position.scaleByPt(k),g.extent=g.extent.scaleByPt(k)}(_||b)&&g.moveBy(lively_graphics.pt(_,b)),(x||w)&&(g.extent=g.extent.addXY(x,w))}}catch(e){h=!0,d=e}finally{try{!u&&f.return&&f.return()}finally{if(h)throw d}}this.forceLayoutsInNextLevel(),this.active=!1}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:17981,end:22788})}({referencedAs:"Layout",value:Layout}),TilingLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("TilingLayout")&&"function"==typeof t.TilingLayout?t.TilingLayout:t.TilingLayout=function TilingLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function TilingLayout_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this._axis=e.axis||"row",this._align=e.align||"left"}},{key:"name",value:function TilingLayout_name_(){return"Tiling"}},{key:"description",value:function TilingLayout_description_(){return"Make the submorphs fill their owner, inserting breaks to defer intersecting the bounds as much as possible."}},{key:"inspect",value:function TilingLayout_inspect_(e){return new lively_halos_layout_js.TilingLayoutHalo(this.container,e)}},{key:"axis",get:function get(){return this._axis}},{key:"axis",set:function set(e){this._axis=e,this.apply()}},{key:"align",get:function get(){return this._align}},{key:"align",set:function set(e){this._align=e,this.apply()}},{key:"spacing",get:function get(){return this._spacing}},{key:"spacing",set:function set(e){this._spacing=e,this.apply()}},{key:"apply",value:function TilingLayout_apply_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active&&this.container){this.active=!0,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,e);for(var t=this.container,r=this.axis,i=this.align,o=this.border,a=this.spacing,s=this.layoutableSubmorphs,l=this.getOptimalWidth(t),c="row"==r,u=c?"left":"top",h=c?"x":"y",d=c?"y":"x",p=0,f=a+o[c?"top":"left"];s.length;){var g,m=l-a,v=lively_lang.arr.takeWhile(s,function(e){var t=e.extent,n=m-(t[h]+a);return!(n<0)&&(m=n,!0)});v.length?s.splice(0,v.length):(v=[s.shift()],m=0),g=c?"center"===i?lively_graphics.pt(m/2+a+o[u],f):lively_graphics.pt(a,f):"center"===i?lively_graphics.pt(f,m/2+a+o[u]):lively_graphics.pt(f,a);var y=!0,_=!1,b=void 0;try{for(var x,w=v[Symbol.iterator]();!(y=(x=w.next()).done);y=!0){var k=x.value;if(e){var S=e.duration,C=e.easing;k.animate({position:g,duration:S,easing:C})}else k.position=g;g=c?g.addXY(a+k.extent[h],0):g.addXY(0,a+k.extent[h]),p=Math.max(p,k.extent[d])}}catch(e){_=!0,b=e}finally{try{!y&&w.return&&w.return()}finally{if(_)throw b}}f+=a+p,p=0}this.active=!1}}},{key:"getMinWidth",value:function TilingLayout_getMinWidth_(){var e=this.layoutableSubmorphs,t=this.border,n=t.left,r=t.right;return e.reduce(function(e,t){return t.width>e?t.width:e},0)+n+r}},{key:"getMinHeight",value:function TilingLayout_getMinHeight_(){var e=this.layoutableSubmorphs,t=this.border,n=t.top,r=t.bottom;return e.reduce(function(e,t){return t.height>e?t.height:e},0)+n+r}},{key:"getOptimalWidth",value:function TilingLayout_getOptimalWidth_(e){var t=this.axis,n=this.border,r=n.left,i=n.top,o=n.right,a=n.bottom,s="row"==t?e.width-r-o:e.height-i-a,l="row"==t?this.getMinWidth():this.getMinHeight();return Math.max(s,l)}},{key:"layoutOrder",value:function TilingLayout_layoutOrder_(e){return 1e6*(e.top-e.top%15)+e.left}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:22797,end:26618})}({referencedAs:"Layout",value:Layout}),CenteredTilingLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("CenteredTilingLayout")&&"function"==typeof t.CenteredTilingLayout?t.CenteredTilingLayout:t.CenteredTilingLayout=function CenteredTilingLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:"name",value:function CenteredTilingLayout_name_(){return"CenteredTiling"}},{key:"description",value:function CenteredTilingLayout_description_(){return"Similar to TilingLayout but center the rows."}},{key:"apply",value:function CenteredTilingLayout_apply_(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active&&this.container){this.active=!0,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,t);var r=this.getOptimalWidth(this.container),i=this.spacing,o=this.layoutableSubmorphs,a=i+this.border.top;o=o.slice();for(var s=function _loop2(){var t=r,n=lively_lang.arr.takeWhile(o,function(e){var n=t-(e.width+2*i);return!(n<0)&&(t=n,!0)});n.length?o=lively_lang.arr.withoutAll(o,n):(n=[o.shift()],t=0);var s=lively_graphics.pt(t/2+i+e.border.left,a),l=!0,c=!1,u=void 0;try{for(var h,d=n[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var p=h.value;p.position=s,s=s.addXY(2*i+p.width,0),a=Math.max(a,p.bottom)}}catch(e){c=!0,u=e}finally{try{!l&&d.return&&d.return()}finally{if(c)throw u}}a+=2*i};o.length;)s();this.active=!1}}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:26627,end:27903})}({referencedAs:"TilingLayout",value:TilingLayout}),CellGroup=function(e){var t=_classRecorder,n=t.hasOwnProperty("CellGroup")&&"function"==typeof t.CellGroup?t.CellGroup:t.CellGroup=function CellGroup(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function CellGroup_initialize_(e){var t=e.cell,n=e.morph,r=e.layout,i=e.align;this.state={cells:[t],layout:r,align:i,resize:r.fitToCell},r&&r.addGroup(this),this.morph=n}},{key:"morph",get:function get(){var e=this.state,t=e.morph,n=e.layout;return t?t.isMorph?t:n.layoutableSubmorphs.find(function(e){return e.name==t}):null}},{key:"compensateOrigin",get:function get(){return this.layout.compensateOrigin}},{key:"resize",get:function get(){return this.state.resize}},{key:"resize",set:function set(e){this.state.resize=e,this.layout.apply()}},{key:"align",get:function get(){return this.state.align||"topLeft"}},{key:"align",set:function set(e){this.state.align=e,this.layout.apply()}},{key:"morph",set:function set(e){var t=e&&this.layout.getCellGroupFor(e);t&&(t.morph=null),this.state.morph=e,this.layout.apply()}},{key:"manages",value:function CellGroup_manages_(e){return this.morph&&(this.morph==e||this.morph.name==e)}},{key:"apply",value:function CellGroup_apply_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.morph;if(t){var n=this.bounds(),r=this.compensateOrigin?this.layout.container.origin.negated():lively_graphics.pt(0,0);if(e){var i,o=this.resize?n.extent():t.extent,a=e.duration,s=e.easing;t.animate((defineProperty(i={},this.alignedProperty||this.align,n[this.align]().addPt(r)),defineProperty(i,"extent",o),defineProperty(i,"duration",a),defineProperty(i,"easing",s),i))}else this.resize&&(t.extent=n.extent()),t[this.alignedProperty||this.align]=n[this.align]().addPt(r);this.layout.forceLayoutsInNextLevel()}}},{key:"cells",get:function get(){return this.state.cells}},{key:"layout",get:function get(){return this.state.layout}},{key:"bounds",value:function CellGroup_bounds_(){return this.cells.length>0?this.cells.map(function(e){return e.bounds()}).reduce(function(e,t){return e.union(t)}):lively_graphics.rect(0,0,0,0)}},{key:"includes",value:function CellGroup_includes_(e){return this.cells.find(function(t){return t==e})}},{key:"connect",value:function CellGroup_connect_(e){void 0==this.morph&&(this.morph=e.group.morph),e.group?e.group.disconnect(e,this):e.group=this,this.cells.push(e)}},{key:"disconnect",value:function CellGroup_disconnect_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e.group=t||new CellGroup({morph:null,layout:this.layout,cell:e}),lively_lang.arr.remove(this.cells,e),this.cells.length<1&&this.layout&&this.layout.removeGroup(this)}},{key:"merge",value:function CellGroup_merge_(e){var t=this;e.cells.forEach(function(e){t.connect(e)})}},{key:"topLeft",get:function get(){var e=this;return this.cells.find(function(t){return!(null!=t.left&&t.left.group==e||null!=t.top&&t.top.group==e)})}},{key:"bottomRight",get:function get(){var e=this;return this.cells.find(function(t){return!(null!=t.right&&t.right.group==e||null!=t.bottom&&t.bottom.group==e)})}},{key:"position",get:function get(){return this.topLeft.position}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:27912,end:31104})}(void 0),LayoutAxis=function(e){var t=_classRecorder,n=t.hasOwnProperty("LayoutAxis")&&"function"==typeof t.LayoutAxis?t.LayoutAxis:t.LayoutAxis=function LayoutAxis(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function LayoutAxis_initialize_(e){this.origin=e}},{key:"otherAxis",get:function get(){return[].concat(toConsumableArray(this.axisBefore),toConsumableArray(this.axisAfter))}},{key:"axisBefore",get:function get(){for(var e=this,t=[];e=e.before;)t=[e].concat(toConsumableArray(t));return t}},{key:"axisAfter",get:function get(){for(var e=this,t=[];e=e.after;)t=[].concat(toConsumableArray(t),[e]);return t}},{key:"before",get:function get(){throw Error("before() not implemented!")}},{key:"after",get:function get(){throw Error("after() not implemented!")}},{key:"containerLength",get:function get(){return this.container[this.dimension]}},{key:"containerLength",set:function set(e){this.container[this.dimension]=e}},{key:"getRoot",value:function LayoutAxis_getRoot_(){return(this.axisBefore[0]||this).items[0]}},{key:"container",get:function get(){return this.origin.container}},{key:"layout",get:function get(){return this.origin.layout}},{key:"frozen",get:function get(){return this.origin.frozen[this.dimension]}},{key:"frozen",set:function set(e){this.origin.frozen[this.dimension]=e}},{key:"align",set:function set(e){this.items.forEach(function(t){return t.group.state.align=e})}},{key:"fixed",get:function get(){return this.origin.fixed[this.dimension]}},{key:"fixed",set:function set(e){var t,n,r=this;lively_lang.obj.isNumber(e)&&(t=e,e=!0),this.items.forEach(function(t){t.fixed[r.dimension]=e}),n=this.containerLength,t&&(this[this.dimension]=t),this.adjustOtherProportions(e),this.containerLength=n}},{key:"length",get:function get(){return this.origin[this.dimension]}},{key:"length",set:function set(e){var t=this;this.items.forEach(function(n){n[t.dimension]=lively_lang.num.roundTo(e,1)})}},{key:"proportion",get:function get(){return this.origin.proportion[this.dimension]}},{key:"proportion",set:function set(e){var t=this;this.items.forEach(function(n){n.proportion[t.dimension]=e})}},{key:"min",get:function get(){return this.origin.min[this.dimension]}},{key:"min",set:function set(e){this.adjustMin(e-this.min)}},{key:"adjustMin",value:function LayoutAxis_adjustMin_(e){var t=this;this.items.forEach(function(n){n.min[t.dimension]+e<0?n.min[t.dimension]=0:(n.min[t.dimension],n[t.dimension],n.min[t.dimension]+=e)}),this.layout.apply()}},{key:"adjustProportion",value:function LayoutAxis_adjustProportion_(){this.fixed||(this.proportion=this.dynamicLength>0?this.length/this.dynamicLength:0)}},{key:"adjustOtherProportions",value:function LayoutAxis_adjustOtherProportions_(e){var t=this,n=this.axisBefore,r=this.axisAfter,i=lively_lang.arr.sum([].concat(toConsumableArray(n),toConsumableArray(r)).filter(function(e){return!e.fixed}).map(function(e){return e.proportion})),o=function removeOwnProportion(e){return e.proportion=e.proportion/i},a=function insertOwnProportion(e){return e.proportion=e.proportion*t.origin.removedDynamicProportions};e&&(this.origin.removedDynamicProportions=i),n.forEach(e?o:a),r.forEach(e?o:a)}},{key:"prepareForResize",value:function LayoutAxis_prepareForResize_(e){var t=this.proportion*Math.max(0,e-this.staticLength);return this.frozen&&t>=this.min?(this.frozen=!1,this.fixed=!1,this.length=t):!this.frozen&&this.min>t&&(this.frozen=!0,this.fixed=!0,this.length=this.min),this}},{key:"adjustLength",value:function LayoutAxis_adjustLength_(e){var t;this.length+e<0&&(e=-this.length),(t=this.axisAfter.find(function(e){return!e.fixed}))?(e=Math.min(e,t.length),this.length+=e,t.length-=e,this.adjustProportion(),t.adjustProportion()):(t=this.axisBefore.reverse().find(function(e){return!e.fixed}))?(t.length-=e,this.length+=e,this.adjustProportion(),t.adjustProportion()):(this.length+=e,this.adjustProportion(),this.otherAxis.forEach(function(e){return e.adjustProportion()}),this.containerLength+=e)}},{key:"equalizeDynamicAxis",value:function LayoutAxis_equalizeDynamicAxis_(){var e=[].concat(toConsumableArray(this.otherAxis.filter(function(e){return!e.fixed})),toConsumableArray(this.fixed?[]:[this])),t=(this.containerLength-this.staticLength)/e.length;e.map(function(e){return e.fixed||(e.length=t),e}).forEach(function(e){return e.adjustProportion()})}},{key:"addBefore",value:function LayoutAxis_addBefore_(){var e=this.emptyAxis();this.before&&this.before.attachTo(e),e.attachTo(this),this.equalizeDynamicAxis(),this.layout.grid=this.getRoot()}},{key:"addAfter",value:function LayoutAxis_addAfter_(){var e=this.emptyAxis();this.after&&e.attachTo(this.after),this.attachTo(e),this.equalizeDynamicAxis(),this.layout.grid=this.getRoot()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:31744,end:37394})}(void 0),LayoutColumn=function(e){var t=_classRecorder,n=t.hasOwnProperty("LayoutColumn")&&"function"==typeof t.LayoutColumn?t.LayoutColumn:t.LayoutColumn=function LayoutColumn(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function LayoutColumn_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.items=[].concat(toConsumableArray(e.above),[e],toConsumableArray(e.below))}},{key:"dimension",get:function get(){return"width"}},{key:"before",get:function get(){return this._before||(this._before=this.origin.left&&new LayoutColumn(this.origin.left))}},{key:"after",get:function get(){return this._after||(this._after=this.origin.right&&new LayoutColumn(this.origin.right))}},{key:"row",value:function LayoutColumn_row_(e){return this.items[e]}},{key:"dynamicLength",get:function get(){return this.origin.dynamicWidth}},{key:"staticLength",get:function get(){return this.origin.totalStaticWidth}},{key:"width",get:function get(){return this.length}},{key:"width",set:function set(e){var t=e-this.width;this.fixed?(this.length+=t,this.container.width+=t):this.adjustLength(t),!this.layout.manualUpdate&&this.layout.apply()}},{key:"paddingLeft",set:function set(e){this.items.forEach(function(t){t.padding.x=e}),this.layout.apply()}},{key:"paddingRight",set:function set(e){this.items.forEach(function(t){t.padding.width=e}),this.layout.apply()}},{key:"emptyAxis",value:function LayoutColumn_emptyAxis_(){var e=new LayoutColumn(new LayoutCell({column:lively_lang.arr.withN(this.items.length,null),layout:this.layout}));return lively_lang.arr.zip(e.items,this.items).forEach(function(e){var t=slicedToArray(e,2),n=t[0],r=t[1];n.height=r.height,n.fixed.height=r.fixed.height,n.frozen.height=r.frozen.height,n.proportion.height=r.proportion.height,n.min.height=r.min.height}),e}},{key:"attachTo",value:function LayoutColumn_attachTo_(e){return this.after&&(this.after._before=null),this._after=null,lively_lang.arr.zip(this.items,e.items).forEach(function(e){var t=slicedToArray(e,2),n=t[0],r=t[1];n.right=r,r.left=n}),this.equalizeDynamicAxis(),e}},{key:"remove",value:function LayoutColumn_remove_(){var e=this,t=this.before||this.after;this.items.forEach(function(t){t.left&&(t.left.right=t.right),t.right&&(t.right.left=t.left),t.group.disconnect(t),e.layout.removeGroup(t.group)}),this.before&&(this.before._after=null),this.after&&(this.after._before=null),this.before||(this.layout.grid=this.after.getRoot()),t.equalizeDynamicAxis()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:37403,end:39655})}({referencedAs:"LayoutAxis",value:LayoutAxis}),LayoutRow=function(e){var t=_classRecorder,n=t.hasOwnProperty("LayoutRow")&&"function"==typeof t.LayoutRow?t.LayoutRow:t.LayoutRow=function LayoutRow(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function LayoutRow_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.items=[].concat(toConsumableArray(e.before),[e],toConsumableArray(e.after))}},{key:"dimension",get:function get(){return"height"}},{key:"emptyAxis",value:function LayoutRow_emptyAxis_(){var e=new LayoutRow(new LayoutCell({row:lively_lang.arr.withN(this.items.length,null),layout:this.layout}));return lively_lang.arr.zip(e.items,this.items).forEach(function(e){var t=slicedToArray(e,2),n=t[0],r=t[1];n.width=r.width,n.fixed.width=r.fixed.width,n.frozen.width=r.frozen.width,n.proportion.width=r.proportion.width,n.min.width=r.min.width}),e}},{key:"paddingTop",set:function set(e){this.items.forEach(function(t){t.padding.y=e}),this.layout.apply()}},{key:"paddingBottom",set:function set(e){this.items.forEach(function(t){t.padding.height=e}),this.layout.apply()}},{key:"before",get:function get(){return this._before||(this._before=this.origin.top&&new LayoutRow(this.origin.top))}},{key:"after",get:function get(){return this._after||(this._after=this.origin.bottom&&new LayoutRow(this.origin.bottom))}},{key:"dynamicLength",get:function get(){return this.origin.dynamicHeight}},{key:"staticLength",get:function get(){return this.origin.totalStaticHeight}},{key:"attachTo",value:function LayoutRow_attachTo_(e){return this.after&&(this.after._before=null),this._after=null,lively_lang.arr.zip(this.items,e.items).forEach(function(e){var t=slicedToArray(e,2),n=t[0],r=t[1];n.bottom=r,r.top=n}),this.equalizeDynamicAxis(),e}},{key:"col",value:function LayoutRow_col_(e){return this.items[e]}},{key:"height",get:function get(){return this.length}},{key:"height",set:function set(e){var t=e-this.height;this.fixed?(this.length+=t,this.container.height+=t):(this.adjustLength(t),this.proportion=this.origin.dynamicHeight>0?this.height/this.origin.dynamicHeight:0),!this.layout.manualUpdate&&this.layout.apply()}},{key:"remove",value:function LayoutRow_remove_(){var e=this,t=this.before||this.after;this.items.forEach(function(t){t.top&&(t.top.bottom=t.bottom),t.bottom&&(t.bottom.top=t.top),t.group.disconnect(t),e.layout.removeGroup(t.group)}),this.before&&(this.before._after=null),this.after&&(this.after._before=null),this.before||(this.layout.grid=this.after.getRoot()),t.equalizeDynamicAxis()}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:39664,end:41996})}({referencedAs:"LayoutAxis",value:LayoutAxis}),LayoutCell=function(e){var t=_classRecorder,n=t.hasOwnProperty("LayoutCell")&&"function"==typeof t.LayoutCell?t.LayoutCell:t.LayoutCell=function LayoutCell(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function LayoutCell_initialize_(e){var t,n=e.row,r=e.column,i=e.top,o=e.left,a=e.right,s=e.bottom,l=e.layout,c=toArray(n||[]),u=c[0],h=(n=c.slice(1),toArray(r||[])),d=h[0];r=h.slice(1);this.layout=l,this.fixed={width:!1,height:!1},this.frozen={width:!1,height:!1},this.min={width:0,height:0},this.top=i,this.left=o,this.bottom=s,this.right=a,this.padding=lively_graphics.rect(0,0,0,0),n.length>0?this.right=new LayoutCell({row:n,left:this,layout:l}):r.length>0&&(this.bottom=new LayoutCell({column:r,top:this,layout:l})),this.proportion={width:1/(1+this.before.length+this.after.length),height:1/(1+this.above.length+this.below.length)},this.height=this.container.height*this.proportion.height,this.width=this.container.width*this.proportion.width,(t=l&&l.getCellGroupFor(u||d))?t.connect(this):this.group=new CellGroup({cell:this,morph:u||d,layout:l})}},{key:"container",get:function get(){return this.layout.container}},{key:"above",get:function get(){return this.collect({neighbor:"top",prepend:!0})}},{key:"below",get:function get(){return this.collect({neighbor:"bottom",append:!0})}},{key:"before",get:function get(){return this.collect({neighbor:"left",prepend:!0})}},{key:"after",get:function get(){return this.collect({neighbor:"right",append:!0})}},{key:"collect",value:function LayoutCell_collect_(e){for(var t=e.neighbor,n=e.prepend,r=e.append,i=[],o=this;o=o[t];)n&&(i=[o].concat(toConsumableArray(i))),r&&(i=[].concat(toConsumableArray(i),[o]));return i}},{key:"col",value:function LayoutCell_col_(e){for(var t=this,n=e;n>0&&t;)t=t.right,n--;if(!t)throw Error(e+" out of bounds! Last column was "+(e-n-1));return new LayoutColumn(t)}},{key:"row",value:function LayoutCell_row_(e){for(var t=this,n=e;n>0&&t;)t=t.bottom,n--;if(!t)throw Error(e+" out of bounds! Last row was "+(e-n-1));return new LayoutRow(t)}},{key:"extent",get:function get(){return lively_graphics.pt(this.width,this.height)}},{key:"staticWidth",get:function get(){return this.fixed.width||this.min.width==this.width}},{key:"staticHeight",get:function get(){return this.fixed.height||this.min.height==this.height}},{key:"totalStaticWidth",get:function get(){return lively_lang.arr.sum([this].concat(toConsumableArray(this.before),toConsumableArray(this.after)).filter(function(e){return e.staticWidth}).map(function(e){return e.width}))}},{key:"totalStaticHeight",get:function get(){return lively_lang.arr.sum([this].concat(toConsumableArray(this.above),toConsumableArray(this.below)).filter(function(e){return e.staticHeight}).map(function(e){return e.height}))}},{key:"dynamicWidth",get:function get(){return lively_lang.arr.sum([this].concat(toConsumableArray(this.before),toConsumableArray(this.after)).filter(function(e){return!e.staticWidth}).map(function(e){return e.width}))}},{key:"dynamicHeight",get:function get(){return lively_lang.arr.sum([this].concat(toConsumableArray(this.above),toConsumableArray(this.below)).filter(function(e){return!e.staticHeight}).map(function(e){return e.height}))}},{key:"height",get:function get(){return Math.max(this.min.height,this._height||0)}},{key:"height",set:function set(e){this._height=e}},{key:"width",get:function get(){return Math.max(this.min.width,this._width||0)}},{key:"width",set:function set(e){this._width=e}},{key:"position",get:function get(){return lively_graphics.pt(lively_lang.arr.sum(this.before.map(function(e){return e.width})),lively_lang.arr.sum(this.above.map(function(e){return e.height})))}},{key:"bounds",value:function LayoutCell_bounds_(){return this.position.addPt(this.padding.topLeft()).extent(this.extent.subPt(this.padding.extent()).subPt(this.padding.topLeft()))}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:42005,end:45751})}(void 0),GridLayout=function(e){var t=_classRecorder,n=t.hasOwnProperty("GridLayout")&&"function"==typeof t.GridLayout?t.GridLayout:t.GridLayout=function GridLayout(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function GridLayout_initialize_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),e=Object.assign({autoAssign:!0,fitToCell:!0},e),this.cellGroups=[],this.config=e}},{key:"name",value:function GridLayout_name_(){return"Grid"}},{key:"description",value:function GridLayout_description_(){return"Aligns the submorphs alongside a configurable grid. Columns and rows and be configured to have different proportional, minimal or fixed sizes. Cells can further be grouped such that submorphs fill up multiple slots of the grid."}},{key:"initGrid",value:function GridLayout_initGrid_(){var e=this,t=this.ensureGrid(this.config).map(function(t){return new LayoutRow(new LayoutCell({row:t,layout:e}))});t.reduce(function(e,t){return e.attachTo(t)}),this.config.autoAssign&&this.autoAssign(this.notInLayout),this.grid=t[0].col(0),this.col(0).equalizeDynamicAxis(),this.row(0).equalizeDynamicAxis(),this.initRowsAndColumns(),this.initGroups()}},{key:"initGroups",value:function GridLayout_initGroups_(){var e=this.config.groups;if(e)for(var t in e){var n=this.getCellGroupFor(this.container.getSubmorphNamed(t)),r=e[t],i=r.resize,o=r.align,a=void 0===o?"topLeft":o,s=r.alignedProperty,l=void 0===s?"topLeft":s;void 0!=i&&(n.resize=i),n.align=a,n.alignedProperty=l}}},{key:"initRowsAndColumns",value:function GridLayout_initRowsAndColumns_(){var e=this.config,t=e.rows,n=void 0===t?[]:t,r=e.columns,i=void 0===r?[]:r,o=!0,a=!1,s=void 0;try{for(var l,c=lively_lang.arr.toTuples(n,2)[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=slicedToArray(l.value,2),h=u[0],d=u[1];Object.assign(this.row(h),d)}}catch(e){a=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw s}}var p=!0,f=!1,g=void 0;try{for(var m,v=lively_lang.arr.toTuples(i,2)[Symbol.iterator]();!(p=(m=v.next()).done);p=!0){var y=slicedToArray(m.value,2);h=y[0],d=y[1];Object.assign(this.col(h),d)}}catch(e){f=!0,g=e}finally{try{!p&&v.return&&v.return()}finally{if(f)throw g}}}},{key:"compensateOrigin",get:function get(){return this.config.compensateOrigin}},{key:"compensateOrigin",set:function set(e){this.config.compensateOrigin=e,this.apply()}},{key:"fitToCell",get:function get(){return this.config.fitToCell}},{key:"fitToCell",set:function set(e){this.config.fitToCell=e,this.cellGroups.forEach(function(t){return t.resize=e}),this.apply()}},{key:"notInLayout",get:function get(){return lively_lang.arr.withoutAll(this.layoutableSubmorphs,this.cellGroups.map(function(e){return e.morph}))}},{key:"col",value:function GridLayout_col_(e){return this.grid.col(e)}},{key:"row",value:function GridLayout_row_(e){return this.grid.row(e)}},{key:"rowCount",get:function get(){return this.grid.col(0).items.length}},{key:"columnCount",get:function get(){return this.grid.row(0).items.length}},{key:"addGroup",value:function GridLayout_addGroup_(e){this.cellGroups.push(e)}},{key:"removeGroup",value:function GridLayout_removeGroup_(e){lively_lang.arr.remove(this.cellGroups,e)}},{key:"fitAxis",value:function GridLayout_fitAxis_(){var e,t,n=this;this.grid.dynamicHeight,this.grid.dynamicWidth;[this.grid.row(0)].concat(toConsumableArray(this.grid.row(0).axisAfter)).map(function(t){return t.prepareForResize(n.container.height),e=n.grid.totalStaticHeight,t}).forEach(function(t){t.fixed||(t.length=t.proportion*Math.max(0,n.container.height-e))}),[this.grid.col(0)].concat(toConsumableArray(this.grid.col(0).axisAfter)).map(function(e){return e.prepareForResize(n.container.width),t=n.grid.totalStaticWidth,e}).forEach(function(e){e.fixed||(e.length=e.proportion*Math.max(0,n.container.width-t))})}},{key:"apply",value:function GridLayout_apply_(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.active||(this.active=!0,lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"apply",this).call(this,e),this.grid||this.initGrid(),this.fitAxis(),this.container.extent=lively_graphics.pt(Math.max(this.grid.totalStaticWidth,this.container.width),Math.max(this.grid.totalStaticHeight,this.container.height)),this.fitAxis(),this.cellGroups.forEach(function(t){t&&t.apply(e)}),this.lastBoundsExtent=this.container.bounds().extent(),this.active=!1)}},{key:"submorphBoundsChanged",get:function get(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.cellGroups[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){var o=r.value;if(o.morph&&!o.bounds().equals(o.morph.bounds()))return!0}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}return!1}},{key:"getCellGroupFor",value:function GridLayout_getCellGroupFor_(e){return e&&this.cellGroups.find(function(t){return t.morph==e})}},{key:"onSubmorphRemoved",value:function GridLayout_onSubmorphRemoved_(e){var t=this.getCellGroupFor(e);t&&(t.morph=null),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onSubmorphRemoved",this).call(this,e)}},{key:"inspect",value:function GridLayout_inspect_(e){return new lively_halos_layout_js.GridLayoutHalo(this.container,e)}},{key:"ensureGrid",value:function GridLayout_ensureGrid_(e){var t=this,n=e.grid,r=e.rowCount,i=e.columnCount;return n=n||[[]],r=r||n.length,i=i||lively_lang.arr.max(n.map(function(e){return e.length})),n.length<r&&(n=n.concat(lively_lang.arr.withN(r-n.length,[]))),n=n.map(function(e){return e.length<i&&(e=e.concat(lively_lang.arr.withN(i-e.length,null))),e.map(function(e){return e&&e.isMorph?(e.owner!=t.container&&t.container.addMorph(e),e):e&&t.container.getSubmorphNamed(e)||e})})}},{key:"autoAssign",value:function GridLayout_autoAssign_(e){var t=this;e.forEach(function(e){var n,r=1/0;t.cellGroups.forEach(function(t){t.morph||t.cells.forEach(function(i){var o=i.position.dist(e.position);o<r&&(n=t,r=o)})}),n&&(n.morph=e)})}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:45760,end:51247})}({referencedAs:"Layout",value:Layout}),StyleSheet=function(e){var t=_classRecorder,n=t.hasOwnProperty("StyleSheet")&&"function"==typeof t.StyleSheet?t.StyleSheet:t.StyleSheet=function StyleSheet(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function StyleSheet_initialize_(e,t){for(var n in lively_lang.obj.isObject(e)&&!t&&(t=e,e=null),this.rules=t,t)t[n]=this.unwrapFoldedProps(t[n]);this.name=e}},{key:"copy",value:function StyleSheet_copy_(){var e={};for(var t in this.rules)e[t]=Object.assign({},this.rules[t]);return new StyleSheet(this.name,e)}},{key:"__only_serialize__",get:function get(){return["rules","context"]}},{key:"context",set:function set(e){this._context=e}},{key:"context",get:function get(){return this._context}},{key:"unwrapFoldedProps",value:function StyleSheet_unwrapFoldedProps_(e){return["borderRadius","borderWidth","borderColor","borderStyle"].forEach(function(t){var n;t in e&&((n=e[t])||(n=0),e[t]=4==lively_lang.arr.intersect(lively_lang.obj.keys(n),["top","left","bottom","right"]).length?n:{top:n,bottom:n,right:n,left:n,valueOf:function valueOf(){return n}})}),e}},{key:"removeRule",value:function StyleSheet_removeRule_(e){delete this.rules[e],this.context.requestStyling()}},{key:"setRule",value:function StyleSheet_setRule_(e,t){this.rules[e]=this.unwrapFoldedProps(t),this.context.requestStyling()}},{key:"toggleRule",value:function StyleSheet_toggleRule_(e,t){this.rules[e]._deactivated=!t,this.context.requestStyling()}},{key:"applicableRules",value:function StyleSheet_applicableRules_(){var e={};for(var t in this.rules)e[t]={styleSheet:this,rule:t};return e}},{key:"toJSExpr",value:function StyleSheet_toJSExpr_(){return"new StyleSheet("+lively_lang.obj.inspect(this.rules,{customPrinter:function customPrinter(e,t,n){if(e&&e.isColor)return e.toJSExpr();if(e&&e.isGradient)return e.toJSExpr();if(e&&e.isPoint)return e.toString();if(e){var r=e.top,i=e.left,o=e.right,a=e.bottom;if(lively_lang.arr.all([r,i,o,a],function(t){return t&&lively_lang.obj.equals(t,e.top)}))return n(e.top)}return e&&lively_lang.obj.keys(e).includes("_rev")?n(lively_lang.obj.dissoc(e,["_rev","_deactivated"])):t},escapeKeys:!0})+")"}},{key:"applyRule",value:function StyleSheet_applyRule_(e,t,n){var r=this.rules[e];return r._deactivated?{}:(r=lively_lang.obj.dissoc(r,["_deactivated"]),t.withMetaDo({styleSheetChange:!0},function(){if("layout"in r){var e=r.layout.copy();e.container=t,r.layout=e}"dropShadow"in r&&(r.dropShadow=new ShadowObject(r.dropShadow),r.dropShadow.morph=t),"padding"in r&&(r.padding=r.padding.isRect?r.padding:lively_graphics.rect(r.padding,r.padding));var i=lively_lang.obj.keys(r).filter(function(e){return!lively_lang.obj.equals(t[e],r[e])}),o=lively_lang.obj.select(r,i),a=t.propertiesAndPropertySettings().properties,s={};for(var l in r)s[l]=a[l]&&a[l].defaultValue||t[l];return n?t.animate(Object.assign({},o,{duration:n.duration,easing:n.easing})):Object.assign(t,o),s}))}}],void 0,t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:153,end:3619})}(void 0),InputLine=function(e){var t=_classRecorder,n=t.hasOwnProperty("InputLine")&&"function"==typeof t.InputLine?t.InputLine:t.InputLine=function InputLine(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function InputLine_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),lively_bindings.connect(this,"textChange",this,"onInputChanged"),lively_bindings.connect(this,"selectionChange",this,"fixCursor")}},{key:"onChange",value:function InputLine_onChange_(e){return["extent","fontSize","padding","fontFamily","position","selection"].includes(e.prop)&&this.updatePlaceholder(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onChange",this).call(this,e)}},{key:"isInputLine",get:function get(){return!0}},{key:"allowDuplicatesInHistory",get:function get(){return!1}},{key:"resetHistory",value:function InputLine_resetHistory_(){this.inputHistory={items:[],max:50,index:0}}},{key:"inputHistory",get:function get(){return this._inputHistory?this._inputHistory:this._inputHistory=this.historyId?this.constructor.getHistory(this.historyId):{items:[],max:30,index:0}}},{key:"inputHistory",set:function set(e){this._inputHistory=e,this.historyId&&this.constructor.setHistory(this.historyId,this._inputHistory)}},{key:"clear",value:function InputLine_clear_(){this.input=""}},{key:"focus",value:function InputLine_focus_(){return this.fixCursor(),lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"focus",this).call(this)}},{key:"fitToLineHeight",value:function InputLine_fitToLineHeight_(){this.height=this.defaultLineHeight+this.padding.top()+this.padding.bottom()}},{key:"updatePlaceholder",value:function InputLine_updatePlaceholder_(){var e=this.getSubmorphNamed("placeholder");if(e)if(this.input.length)e.visible=!1;else{var t=this.innerBounds();e.fontSize=this.fontSize,e.leftCenter=this.label.length?t.rightCenter().addXY(0,this.borderWidth):t.leftCenter().withX(0),e.visible=!0,e.height=this.height,e.padding=this.padding,e.defaultTextStyle=this.defaultTextStyle,e.lineHeight=this.height+"px"}}},{key:"fixCursor",value:function InputLine_fixCursor_(){this.label&&(this.positionToIndex(this.selection.lead)<this.label.length&&(this.selection.lead=this.indexToPosition(this.label.length)),this.positionToIndex(this.selection.anchor)<this.label.length&&(this.selection.anchor=this.indexToPosition(this.label.length)))}},{key:"acceptInput",value:function InputLine_acceptInput_(){var e=this.input;return this.onInput(e),e}},{key:"onInput",value:function InputLine_onInput_(e){this.input.length>0&&this.addInputToHistory(this.input),this.clearOnInput&&this.clear(),lively_bindings.signal(this,"inputAccepted",e)}},{key:"onInputChanged",value:function InputLine_onInputChanged_(e){lively_bindings.signal(this,"inputChanged",e),this.updatePlaceholder()}},{key:"deleteText",value:function InputLine_deleteText_(e){if(!(e=e.isRange?e:new Range(e)).isEmpty())return e=e.subtract({start:{row:0,column:0},end:{row:0,column:this.label.length}})[0],lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"deleteText",this).call(this,e)}},{key:"addInputToHistory",value:function InputLine_addInputToHistory_(e){var t=this.inputHistory,n=t.items;if(lively_lang.arr.last(n)!==e){if(n.push(e),n.length>t.max&&(t.items=n=n.slice(-t.max)),t.index=n.length-1,!this.allowDuplicatesInHistory)for(var r=t.items.length-1;r--;)t.items[r]===e&&(t.items.splice(r,1),t.index--);this.historyId&&this.constructor.addHistoryToLocalStorage(this.historyId,t)}}},{key:"browseHistory",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(){var e,t,n,r;return regeneratorRuntime.wrap(function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return e=this.inputHistory.items.map(function(e,t){return{isListItem:!0,string:e,value:t}}).reverse(),i.next=3,this.world().filterableListPrompt("Choose item:",e,{commands:[this.histEditCommandForHistBrowse()]});case 3:t=i.sent,n=slicedToArray(t.selected,1),"number"==typeof(r=n[0])&&this.setAndShowHistItem(r),this.focus();case 8:case"end":return i.stop()}},_callee,this)}));return function InputLine_browseHistory_(){return e.apply(this,arguments)}}()},{key:"histEditCommandForHistBrowse",value:function InputLine_histEditCommandForHistBrowse_(){var e,t=this;return{name:"edit history "+this.historyId,exec:(e=asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var n,r,i,o;return regeneratorRuntime.wrap(function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return n=t.inputHistory.items.slice().reverse(),a.next=3,e.world().editListPrompt("edit history "+t.historyId,n);case 3:if(r=a.sent,i=r.status,o=r.list,"canceled"!==i){a.next=8;break}return a.abrupt("return",!0);case 8:return n=n.filter(function(e){return e.isListItem?o.includes(e.value):o.includes(e)}),t.inputHistory=Object.assign({},t.inputHistory,{items:n}),e.get("list").items=n.map(function(e,t){return{isListItem:!0,string:e,value:t}}).reverse(),a.abrupt("return",!0);case 12:case"end":return a.stop()}},_callee2,t)})),function exec(t){return e.apply(this,arguments)})}}},{key:"setAndShowHistItem",value:function InputLine_setAndShowHistItem_(e){var t=this.inputHistory,n=t.items,r=n.length-1,i=e;lively_lang.num.between(i,0,r+1)?t.index=i:t.index=i=r,this.input!==n[i]&&void 0!==n[i]&&(this.input=n[i])}},{key:"showHistItem",value:function InputLine_showHistItem_(e){e=e||"next";var t=this.inputHistory,n=t.items,r=n.length-1,i=t.index;if(lively_lang.num.between(i,0,r+1)||(t.index=i=r),this.input===n[i]||void 0===n[i]){if("next"===e){if(i>r)return;i=++t.index}else{if(i<=0)return;i=--t.index}this.input=n[i]||""}else this.input=n[i]}},{key:"commands",get:function get(){var e,t=this;return[{name:"accept input",exec:function exec(){return t.acceptInput(),!0}},{name:"show previous input from history",exec:function exec(){return t.showHistItem("prev"),!0}},{name:"show next input from history",exec:function exec(){return t.showHistItem("next"),!0}},{name:"browse history",exec:function exec(){return t.browseHistory(),!0}},{name:"remove items from history",exec:(e=asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var n,r,i,o;return regeneratorRuntime.wrap(function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return n=e.inputHistory,r=n.items.map(function(e,t){return{isListItem:!0,string:e,value:t}}).reverse(),t.next=4,e.world().filterableListPrompt("Choose items to delete:",r,{multiSelect:!0});case 4:return i=t.sent,o=i.selected,lively_lang.arr.sort(o).reverse().forEach(function(e){e<n.index&&n.index--,n.items.splice(e,1)}),e.inputHistory=n,t.abrupt("return",!0);case 9:case"end":return t.stop()}},_callee3,t)})),function exec(t){return e.apply(this,arguments)})}].concat(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"commands",this))}},{key:"keybindings",get:function get(){return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"keybindings",this).concat([{keys:"Enter",command:"accept input"},{keys:{mac:"Meta-S",win:"Ctrl-S"},command:"accept input"},{keys:"Up|Ctrl-Up|Alt-P",command:"show previous input from history"},{keys:"Down|Ctrl-Down|Alt-N",command:"show next input from history"},{keys:"Alt-H",command:"browse history"},{keys:"Alt-Shift-H",command:"remove items from history"}])}},{key:"onFocus",value:function InputLine_onFocus_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onFocus",this).call(this,e),this.highlightWhenFocused&&this.animate({dropShadow:this.haloShadow,duration:200})}},{key:"onBlur",value:function InputLine_onBlur_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onBlur",this).call(this,e),this.highlightWhenFocused&&this.animate({dropShadow:!1,duration:200})}},{key:"htmlExport_transformNode",value:function InputLine_htmlExport_transformNode_(e){var t=e.ownerDocument.createElement("input"),n=e.querySelector(".newtext-text-layer.actual");return t.id=e.id,t.className=e.className,t.style=e.style.cssText,Object.assign(t.style,lively_lang.obj.select(n.style,["padding","font-family","font-weight","font-style","text-decoration","font-size","color"])),t.placeholder=this.placeholder,t.type="text",t.autocomplete=t.name=this.name.replace(/[\s"]/g,"-"),t}}],[{key:"getHistoryFromLocalSorage",value:function InputLine_getHistoryFromLocalSorage_(e){if("undefined"==typeof localStorage)return null;try{var t=localStorage.getItem("lively.morphic-inputline-"+e);return t?JSON.parse(t):null}catch(e){return null}}},{key:"addHistoryToLocalStorage",value:function InputLine_addHistoryToLocalStorage_(e,t){if("undefined"!=typeof localStorage)try{localStorage.setItem("lively.morphic-inputline-"+e,JSON.stringify(t))}catch(e){console.error(e)}}},{key:"histories",get:function get(){return this._histories||(this._histories=new Map),this._histories}},{key:"getHistory",value:function InputLine_getHistory_(e){var t=this.histories.get(e);return t||(t=this.getHistoryFromLocalSorage(e)||{items:[],max:50,index:0},this.histories.set(e,t),t)}},{key:"setHistory",value:function InputLine_setHistory_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{items:[],max:50,index:0};return this.histories.set(e,t),this.addHistoryToLocalStorage(e,t),t}},{key:"properties",get:function get(){return{fixedWidth:{defaultValue:!0},fixedHeight:{defaultValue:!0},extent:{defaultValue:lively_graphics.pt(100,20)},padding:{defaultValue:lively_graphics.Rectangle.inset(2,4)},clipMode:{defaultValue:"hidden"},lineWrapping:{defaultValue:!1},historyId:{defaultValue:null},clearOnInput:{defaultValue:!1},label:{after:["textAndAttributes","extent","padding","submorphs"],defaultValue:"",set:function set(e){this.setProperty("label",e),this.textString.startsWith(e)||(lively_bindings.disconnect(this,"textChange",this,"onInputChanged"),this.textString=e+this.input,lively_bindings.connect(this,"textChange",this,"onInputChanged"))}},input:{after:["label"],derived:!0,get:function get(){return this.textString.slice(this.label.length)},set:function set(e){this.textString=this.label+(e?String(e):""),this.updatePlaceholder()}},placeholder:{after:["submorphs","label","defaultTextStyle"],dervied:!0,get:function get(){var e=this.getSubmorphNamed("placeholder");return e?e.value:null},set:function set(e){var t=this.getSubmorphNamed("placeholder");e?t?(t.defaultTextStyle=Object.assign({},this.defaultTextStyle,{fontColor:lively_graphics.Color.gray}),t.value=e):t=this.addMorph(Text.makeLabel(e,Object.assign({},this.defaultTextStyle,{name:"placeholder",reactsToPointer:!1,fontColor:lively_graphics.Color.gray}))):t&&(t.remove(),t=null),this.updatePlaceholder()}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:334,end:12983})}({referencedAs:"Text",value:Text}),PasswordInputLine=function(e){var t=_classRecorder,n=t.hasOwnProperty("PasswordInputLine")&&"function"==typeof t.PasswordInputLine?t.PasswordInputLine:t.PasswordInputLine=function PasswordInputLine(e){e&&e[Symbol.for("lively-instance-restorer")]||this[Symbol.for("lively-instance-initialize")].apply(this,arguments)};return lively.classes.runtime.initializeClass(n,e,[{key:Symbol.for("lively-instance-initialize"),value:function PasswordInputLine_initialize_(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),Symbol.for("lively-instance-initialize"),this).call(this,e),this.onLoad()}},{key:"bounds",value:function PasswordInputLine_bounds_(){return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"bounds",this).call(this)}},{key:"onLoad",value:function PasswordInputLine_onLoad_(){var e=this;this.ensureInputNode().then(function(t){e.updateHtml(e.input),t.onkeydown=function(t){return e.env.eventDispatcher.dispatchDOMEvent(t,e,"onKeyDown")},t.onkeyup=function(t){return e.env.eventDispatcher.dispatchDOMEvent(t,e,"onKeyUp")}})}},{key:"ensureInputNode",value:function PasswordInputLine_ensureInputNode_(){var e=this;return this.whenRendered().then(function(){var t=e.domNode;if("INPUT"==t.parentNode.tagName){var n=t.parentNode;t.remove(),e.domNode=n}return e.domNode})}},{key:"onKeyDown",value:function PasswordInputLine_onKeyDown_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onKeyDown",this).call(this,e),this.input!=this.lastInput&&this.onInputChanged(this.input),this.lastInput=this.input}},{key:"focus",value:function PasswordInputLine_focus_(){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"focus",this).call(this),this.domNode&&this.domNode.focus()}},{key:"onFocus",value:function PasswordInputLine_onFocus_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onFocus",this).call(this,e),this.animate({dropShadow:this.haloShadow,duration:200})}},{key:"onBlur",value:function PasswordInputLine_onBlur_(e){lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"onBlur",this).call(this,e),this.animate({dropShadow:null,duration:200})}},{key:"acceptInput",value:function PasswordInputLine_acceptInput_(){var e=this.input;return lively_bindings.signal(this,"inputAccepted",e),e}},{key:"onInputChanged",value:function PasswordInputLine_onInputChanged_(e){lively_bindings.signal(this,"inputChanged",e)}},{key:"updateHtml",value:function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var t,n,r,i,o,a,s,l,c,u,h,d;return regeneratorRuntime.wrap(function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:return t=this.fontSize,n=this.fontFamily,r=this.padding,i=this.placeholder,o=this.fill,a=void 0===o?lively_graphics.Color.white:o,s=this.borderRadius,l=r.top(),c=r.right(),u=r.bottom(),h=r.left(),p.next=3,this.ensureInputNode();case 3:(d=p.sent).setAttribute("type","password"),d.setAttribute("placeholder",i),d.setAttribute("value",e),Object.assign(d.style,{height:"calc(100% - "+l+"px - "+u+"px)",width:"calc(100% - "+h+"px - "+c+"px)","border-width":0,outline:"none","border-radius":s.valueOf()+"px",background:a.toString(),padding:l+"px "+c+"px "+u+"px "+h+"px","font-size":t+"px","font-family":""+n});case 8:case"end":return p.stop()}},_callee4,this)}));return function PasswordInputLine_updateHtml_(t){return e.apply(this,arguments)}}()},{key:"commands",get:function get(){var e=this;return[{name:"accept input",exec:function exec(){return e.acceptInput(),!0}}].concat(lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"commands",this))}},{key:"keybindings",get:function get(){return lively.classes.runtime.initializeClass._get(Object.getPrototypeOf(n.prototype),"keybindings",this).concat([{keys:"Enter",command:"accept input"},{keys:{mac:"Meta-S",win:"Ctrl-S"},command:"accept input"}])}},{key:"htmlExport_transformNode",value:function PasswordInputLine_htmlExport_transformNode_(e){var t=e.ownerDocument,n=e.querySelector("input"),r=t.createElement("input");return r.id=e.id,r.className=e.className,r.placeholder=this.placeholder,r.style=e.style.cssText,Object.assign(r.style,lively_lang.obj.select(n.style,["padding","font-family","font-weight","font-style","text-decoration","font-size","color"])),r.type="password",r.autocomplete=r.name=this.name.replace(/[\s"]/g,"-"),r}}],[{key:"properties",get:function get(){return{extent:{defaultValue:lively_graphics.pt(100,20)},html:{derived:!0,initialize:function initialize(){},get:function get(){return""},set:function set(e){}},haloShadow:{readOnly:!0,get:function get(){return{blur:10,color:lively_graphics.Color.rgb(52,152,219),distance:0,rotation:45}}},domNodeTagName:{readOnly:!0,get:function get(){return"input"}},domNodeStyle:{readOnly:!0,get:function get(){return"background: grey"}},input:{derived:!0,after:["domNode"],get:function get(){return this.domNode&&this.domNode.value||""},set:function set(e){this.domNode.value=e,this.updateHtml(this.input)}},placeholder:{after:["domNode"],set:function set(e){this.setProperty("placeholder",e),this.updateHtml(this.input)}},fontSize:{defaultValue:12,after:["input"],set:function set(e){this.setProperty("fontSize",e),this.updateHtml(this.input)}},fontFamily:{defaultValue:"sans-serif",after:["input"],set:function set(e){this.setProperty("fontFamily",e),this.updateHtml(this.input)}},padding:{defaultValue:lively_graphics.Rectangle.inset(2),after:["input"],set:function set(e){this.setProperty("padding",e),this.updateHtml(this.input)}}}}}],t,{pathInPackage:function pathInPackage(){return"/index.js"},subscribeToToplevelDefinitionChanges:function subscribeToToplevelDefinitionChanges(){return function(){}},package:function _package(){return{name:"lively.morphic",version:"0.1.0"}}},{start:13106,end:18740})}({referencedAs:"HTMLMorph",value:HTMLMorph}),lazyInspect=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var t,n;return regeneratorRuntime.wrap(function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,System.import("lively.ide/js/inspector.js");case 2:return t=r.sent,n=t.inspect,exports.inspect=n,r.abrupt("return",n(e));case 6:case"end":return r.stop()}},_callee,this)}));return function lazyInspect(t){return e.apply(this,arguments)}}();function morph$2(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{restore:!1},n=Morph;if(e.type)if("function"==typeof e.type)n=e.type;else if("string"==typeof e.type)switch(e.type.toLowerCase()){case"world":n=World;break;case"hand":n=Hand;break;case"image":n=Image;break;case"ellipse":n=Ellipse;break;case"triangle":n=Triangle;break;case"path":n=Path;break;case"text":n=Text;break;case"input":n=InputLine;break;case"label":n=Label;break;case"list":n=lively_components_list_js.List;break;case"polygon":n=Polygon;break;case"line":n=LineMorph;break;case"html":n=HTMLMorph;break;case"dropdownlist":n=lively_components_list_js.DropDownList;break;case"button":n=lively_components_buttons_js.Button;break;case"checkbox":n=lively_components_widgets_js.CheckBox;break;case"labeledcheckbox":n=lively_components_widgets_js.LabeledCheckBox}return t.restore?new n(defineProperty({},Symbol.for("lively-instance-restorer"),!0)).initFromJSON(e):new n(e)}exports.inspect=lazyInspect,exports.InputLine=InputLine,exports.PasswordInputLine=PasswordInputLine,exports.morph=morph$2,exports.config=config$1,exports.StyleSheet=StyleSheet,exports.ShadowObject=ShadowObject,exports.addOrChangeCSSDeclaration=addOrChangeCSSDeclaration,exports.addOrChangeLinkedCSS=addOrChangeLinkedCSS,exports.easings=easings,exports.stringToEasing=stringToEasing,exports.Icon=Icon,exports.loadMorphFromSnapshot=loadMorphFromSnapshot$$1,exports.newMorphId=newMorphId$$1,exports.Morph=Morph,exports.Ellipse=Ellipse,exports.Triangle=Triangle,exports.Image=Image,exports.PathPoint=PathPoint,exports.Path=Path,exports.Polygon=Polygon,exports.LineMorph=LineMorph,exports.World=World,exports.Hand=Hand,exports.Text=Text,exports.Label=Label,exports.Anchor=Anchor,exports.HTMLMorph=HTMLMorph,exports.IFrameMorph=IFrameMorph,exports.MorphicEnv=MorphicEnv,exports.CustomLayout=CustomLayout,exports.SnapLayout=SnapLayout,exports.FillLayout=FillLayout,exports.VerticalLayout=VerticalLayout,exports.HorizontalLayout=HorizontalLayout,exports.ProportionalLayout=ProportionalLayout,exports.TilingLayout=TilingLayout,exports.CenteredTilingLayout=CenteredTilingLayout,exports.CellGroup=CellGroup,exports.LayoutColumn=LayoutColumn,exports.LayoutRow=LayoutRow,exports.LayoutCell=LayoutCell,exports.GridLayout=GridLayout,exports.TooltipViewer=TooltipViewer,exports.Tooltip=Tooltip,exports.MorphicDB=MorphicDB}(this.lively.morphic=this.lively.morphic||{},lively.graphics,bowser,lively.lang,lively.bindings,virtualDom,vdomParser,lively.morphic,flubber,BezierEasing,{},lively.notifications,{},lively.serializer2,lively.resources,lively.storage,lively.modules,{},{},{},{},{},{},{},{},{},{},{},{},{}),"undefined"!=typeof module&&"function"==typeof require&&(module.exports=GLOBAL.lively.morphic)}();
//pep.js
/*!
 * PEP v0.4.3 | https://github.com/jquery/PEP
 * Copyright jQuery Foundation and other contributors | http://jquery.org/license
 */
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.PointerEventsPolyfill=b()}(this,function(){"use strict";function a(a,b){b=b||Object.create(null);var c=document.createEvent("Event");c.initEvent(a,b.bubbles||!1,b.cancelable||!1);
// define inherited MouseEvent properties
// skip bubbles and cancelable since they're set above in initEvent()
for(var d,e=2;e<m.length;e++)d=m[e],c[d]=b[d]||n[e];c.buttons=b.buttons||0;
// Spec requires that pointers without pressure specified use 0.5 for down
// state and 0 for up state.
var f=0;
// add x/y properties aliased to clientX/Y
// define the properties of the PointerEvent interface
return f=b.pressure&&c.buttons?b.pressure:c.buttons?.5:0,c.x=c.clientX,c.y=c.clientY,c.pointerId=b.pointerId||0,c.width=b.width||0,c.height=b.height||0,c.pressure=f,c.tiltX=b.tiltX||0,c.tiltY=b.tiltY||0,c.twist=b.twist||0,c.tangentialPressure=b.tangentialPressure||0,c.pointerType=b.pointerType||"",c.hwTimestamp=b.hwTimestamp||0,c.isPrimary=b.isPrimary||!1,c}function b(){this.array=[],this.size=0}function c(a,b,c,d){this.addCallback=a.bind(d),this.removeCallback=b.bind(d),this.changedCallback=c.bind(d),A&&(this.observer=new A(this.mutationWatcher.bind(this)))}function d(a){return"body /shadow-deep/ "+e(a)}function e(a){return'[touch-action="'+a+'"]'}function f(a){return"{ -ms-touch-action: "+a+"; touch-action: "+a+"; }"}function g(){if(F){D.forEach(function(a){String(a)===a?(E+=e(a)+f(a)+"\n",G&&(E+=d(a)+f(a)+"\n")):(E+=a.selectors.map(e)+f(a.rule)+"\n",G&&(E+=a.selectors.map(d)+f(a.rule)+"\n"))});var a=document.createElement("style");a.textContent=E,document.head.appendChild(a)}}function h(){
// only activate if this platform does not have pointer events
if(!window.PointerEvent){if(window.PointerEvent=a,window.navigator.msPointerEnabled){var b=window.navigator.msMaxTouchPoints;Object.defineProperty(window.navigator,"maxTouchPoints",{value:b,enumerable:!0}),u.registerSource("ms",_)}else Object.defineProperty(window.navigator,"maxTouchPoints",{value:0,enumerable:!0}),u.registerSource("mouse",N),void 0!==window.ontouchstart&&u.registerSource("touch",V);u.register(document)}}function i(a){if(!u.pointermap.has(a)){var b=new Error("InvalidPointerId");throw b.name="InvalidPointerId",b}}function j(a){for(var b=a.parentNode;b&&b!==a.ownerDocument;)b=b.parentNode;if(!b){var c=new Error("InvalidStateError");throw c.name="InvalidStateError",c}}function k(a){var b=u.pointermap.get(a);return 0!==b.buttons}function l(){window.Element&&!Element.prototype.setPointerCapture&&Object.defineProperties(Element.prototype,{setPointerCapture:{value:W},releasePointerCapture:{value:X},hasPointerCapture:{value:Y}})}/**
   * This is the constructor for new PointerEvents.
   *
   * New Pointer Events must be given a type, and an optional dictionary of
   * initialization properties.
   *
   * Due to certain platform requirements, events returned from the constructor
   * identify as MouseEvents.
   *
   * @constructor
   * @param {String} inType The type of the event to create.
   * @param {Object} [inDict] An optional dictionary of initial event properties.
   * @return {Event} A new PointerEvent of type `inType`, initialized with properties from `inDict`.
   */
var m=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","pageX","pageY"],n=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0],o=window.Map&&window.Map.prototype.forEach,p=o?Map:b;b.prototype={set:function(a,b){return void 0===b?this["delete"](a):(this.has(a)||this.size++,void(this.array[a]=b))},has:function(a){return void 0!==this.array[a]},"delete":function(a){this.has(a)&&(delete this.array[a],this.size--)},get:function(a){return this.array[a]},clear:function(){this.array.length=0,this.size=0},
// return value, key, map
forEach:function(a,b){return this.array.forEach(function(c,d){a.call(b,c,d,this)},this)}};var q=[
// MouseEvent
"bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget",
// DOM Level 3
"buttons",
// PointerEvent
"pointerId","width","height","pressure","tiltX","tiltY","pointerType","hwTimestamp","isPrimary",
// event instance
"type","target","currentTarget","which","pageX","pageY","timeStamp"],r=[
// MouseEvent
!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,
// DOM Level 3
0,
// PointerEvent
0,0,0,0,0,0,"",0,!1,
// event instance
"",null,null,0,0,0,0],s={pointerover:1,pointerout:1,pointerenter:1,pointerleave:1},t="undefined"!=typeof SVGElementInstance,u={pointermap:new p,eventMap:Object.create(null),captureInfo:Object.create(null),
// Scope objects for native events.
// This exists for ease of testing.
eventSources:Object.create(null),eventSourceList:[],/**
     * Add a new event source that will generate pointer events.
     *
     * `inSource` must contain an array of event names named `events`, and
     * functions with the names specified in the `events` array.
     * @param {string} name A name for the event source
     * @param {Object} source A new source of platform events.
     */
registerSource:function(a,b){var c=b,d=c.events;d&&(d.forEach(function(a){c[a]&&(this.eventMap[a]=c[a].bind(c))},this),this.eventSources[a]=c,this.eventSourceList.push(c))},register:function(a){for(var b,c=this.eventSourceList.length,d=0;d<c&&(b=this.eventSourceList[d]);d++)
// call eventsource register
b.register.call(b,a)},unregister:function(a){for(var b,c=this.eventSourceList.length,d=0;d<c&&(b=this.eventSourceList[d]);d++)
// call eventsource register
b.unregister.call(b,a)},contains:/*scope.external.contains || */function(a,b){try{return a.contains(b)}catch(c){
// most likely: https://bugzilla.mozilla.org/show_bug.cgi?id=208427
return!1}},
// EVENTS
down:function(a){a.bubbles=!0,this.fireEvent("pointerdown",a)},move:function(a){a.bubbles=!0,this.fireEvent("pointermove",a)},up:function(a){a.bubbles=!0,this.fireEvent("pointerup",a)},enter:function(a){a.bubbles=!1,this.fireEvent("pointerenter",a)},leave:function(a){a.bubbles=!1,this.fireEvent("pointerleave",a)},over:function(a){a.bubbles=!0,this.fireEvent("pointerover",a)},out:function(a){a.bubbles=!0,this.fireEvent("pointerout",a)},cancel:function(a){a.bubbles=!0,this.fireEvent("pointercancel",a)},leaveOut:function(a){this.out(a),this.propagate(a,this.leave,!1)},enterOver:function(a){this.over(a),this.propagate(a,this.enter,!0)},
// LISTENER LOGIC
eventHandler:function(a){
// This is used to prevent multiple dispatch of pointerevents from
// platform events. This can happen when two elements in different scopes
// are set up to create pointer events, which is relevant to Shadow DOM.
if(!a._handledByPE){var b=a.type,c=this.eventMap&&this.eventMap[b];c&&c(a),a._handledByPE=!0}},
// set up event listeners
listen:function(a,b){b.forEach(function(b){this.addEvent(a,b)},this)},
// remove event listeners
unlisten:function(a,b){b.forEach(function(b){this.removeEvent(a,b)},this)},addEvent:/*scope.external.addEvent || */function(a,b){a.addEventListener(b,this.boundHandler)},removeEvent:/*scope.external.removeEvent || */function(a,b){a.removeEventListener(b,this.boundHandler)},
// EVENT CREATION AND TRACKING
/**
     * Creates a new Event of type `inType`, based on the information in
     * `inEvent`.
     *
     * @param {string} inType A string representing the type of event to create
     * @param {Event} inEvent A platform event with a target
     * @return {Event} A PointerEvent of type `inType`
     */
makeEvent:function(b,c){
// relatedTarget must be null if pointer is captured
this.captureInfo[c.pointerId]&&(c.relatedTarget=null);var d=new a(b,c);return c.preventDefault&&(d.preventDefault=c.preventDefault),d._target=d._target||c.target,d},
// make and dispatch an event in one call
fireEvent:function(a,b){var c=this.makeEvent(a,b);return this.dispatchEvent(c)},/**
     * Returns a snapshot of inEvent, with writable properties.
     *
     * @param {Event} inEvent An event that contains properties to copy.
     * @return {Object} An object containing shallow copies of `inEvent`'s
     *    properties.
     */
cloneEvent:function(a){for(var b,c=Object.create(null),d=0;d<q.length;d++)b=q[d],c[b]=a[b]||r[d],
// Work around SVGInstanceElement shadow tree
// Return the <use> element that is represented by the instance for Safari, Chrome, IE.
// This is the behavior implemented by Firefox.
!t||"target"!==b&&"relatedTarget"!==b||c[b]instanceof SVGElementInstance&&(c[b]=c[b].correspondingUseElement);
// keep the semantics of preventDefault
return a.preventDefault&&(c.preventDefault=function(){a.preventDefault()}),c},getTarget:function(a){var b=this.captureInfo[a.pointerId];return b?a._target!==b&&a.type in s?void 0:b:a._target},propagate:function(a,b,c){
// Order of conditions due to document.contains() missing in IE.
for(var d=a.target,e=[];d!==document&&!d.contains(a.relatedTarget);)
// Touch: Do not propagate if node is detached.
if(e.push(d),d=d.parentNode,!d)return;c&&e.reverse(),e.forEach(function(c){a.target=c,b.call(this,a)},this)},setCapture:function(b,c,d){this.captureInfo[b]&&this.releaseCapture(b,d),this.captureInfo[b]=c,this.implicitRelease=this.releaseCapture.bind(this,b,d),document.addEventListener("pointerup",this.implicitRelease),document.addEventListener("pointercancel",this.implicitRelease);var e=new a("gotpointercapture");e.pointerId=b,e._target=c,d||this.asyncDispatchEvent(e)},releaseCapture:function(b,c){var d=this.captureInfo[b];if(d){this.captureInfo[b]=void 0,document.removeEventListener("pointerup",this.implicitRelease),document.removeEventListener("pointercancel",this.implicitRelease);var e=new a("lostpointercapture");e.pointerId=b,e._target=d,c||this.asyncDispatchEvent(e)}},/**
     * Dispatches the event to its target.
     *
     * @param {Event} inEvent The event to be dispatched.
     * @return {Boolean} True if an event handler returns true, false otherwise.
     */
dispatchEvent:/*scope.external.dispatchEvent || */function(a){var b=this.getTarget(a);if(b)return b.dispatchEvent(a)},asyncDispatchEvent:function(a){requestAnimationFrame(this.dispatchEvent.bind(this,a))}};u.boundHandler=u.eventHandler.bind(u);var v={shadow:function(a){if(a)return a.shadowRoot||a.webkitShadowRoot},canTarget:function(a){return a&&Boolean(a.elementFromPoint)},targetingShadow:function(a){var b=this.shadow(a);if(this.canTarget(b))return b},olderShadow:function(a){var b=a.olderShadowRoot;if(!b){var c=a.querySelector("shadow");c&&(b=c.olderShadowRoot)}return b},allShadows:function(a){for(var b=[],c=this.shadow(a);c;)b.push(c),c=this.olderShadow(c);return b},searchRoot:function(a,b,c){if(a){var d,e,f=a.elementFromPoint(b,c);for(
// is element a shadow host?
e=this.targetingShadow(f);e;){if(
// find the the element inside the shadow root
d=e.elementFromPoint(b,c)){
// shadowed element may contain a shadow root
var g=this.targetingShadow(d);return this.searchRoot(g,b,c)||d}
// check for older shadows
e=this.olderShadow(e)}
// light dom element is the target
return f}},owner:function(a){
// walk up until you hit the shadow root or document
for(var b=a;b.parentNode;)b=b.parentNode;
// the owner element is expected to be a Document or ShadowRoot
return b.nodeType!==Node.DOCUMENT_NODE&&b.nodeType!==Node.DOCUMENT_FRAGMENT_NODE&&(b=document),b},findTarget:function(a){var b=a.clientX,c=a.clientY,d=this.owner(a.target);
// if x, y is not in this root, fall back to document search
return d.elementFromPoint(b,c)||(d=document),this.searchRoot(d,b,c)}},w=Array.prototype.forEach.call.bind(Array.prototype.forEach),x=Array.prototype.map.call.bind(Array.prototype.map),y=Array.prototype.slice.call.bind(Array.prototype.slice),z=Array.prototype.filter.call.bind(Array.prototype.filter),A=window.MutationObserver||window.WebKitMutationObserver,B="[touch-action]",C={subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["touch-action"]};c.prototype={watchSubtree:function(a){
// Only watch scopes that can target find, as these are top-level.
// Otherwise we can see duplicate additions and removals that add noise.
//
// TODO(dfreedman): For some instances with ShadowDOMPolyfill, we can see
// a removal without an insertion when a node is redistributed among
// shadows. Since it all ends up correct in the document, watching only
// the document will yield the correct mutations to watch.
this.observer&&v.canTarget(a)&&this.observer.observe(a,C)},enableOnSubtree:function(a){this.watchSubtree(a),a===document&&"complete"!==document.readyState?this.installOnLoad():this.installNewSubtree(a)},installNewSubtree:function(a){w(this.findElements(a),this.addElement,this)},findElements:function(a){return a.querySelectorAll?a.querySelectorAll(B):[]},removeElement:function(a){this.removeCallback(a)},addElement:function(a){this.addCallback(a)},elementChanged:function(a,b){this.changedCallback(a,b)},concatLists:function(a,b){return a.concat(y(b))},
// register all touch-action = none nodes on document load
installOnLoad:function(){document.addEventListener("readystatechange",function(){"complete"===document.readyState&&this.installNewSubtree(document)}.bind(this))},isElement:function(a){return a.nodeType===Node.ELEMENT_NODE},flattenMutationTree:function(a){
// find children with touch-action
var b=x(a,this.findElements,this);
// flatten the list
// make sure the added nodes are accounted for
return b.push(z(a,this.isElement)),b.reduce(this.concatLists,[])},mutationWatcher:function(a){a.forEach(this.mutationHandler,this)},mutationHandler:function(a){if("childList"===a.type){var b=this.flattenMutationTree(a.addedNodes);b.forEach(this.addElement,this);var c=this.flattenMutationTree(a.removedNodes);c.forEach(this.removeElement,this)}else"attributes"===a.type&&this.elementChanged(a.target,a.oldValue)}};var D=["none","auto","pan-x","pan-y",{rule:"pan-x pan-y",selectors:["pan-x pan-y","pan-y pan-x"]}],E="",F=window.PointerEvent||window.MSPointerEvent,G=!window.ShadowDOMPolyfill&&document.head.createShadowRoot,H=u.pointermap,I=25,J=[1,4,2,8,16],K=!1;try{K=1===new MouseEvent("test",{buttons:1}).buttons}catch(L){}
// handler block for native mouse events
var M,N={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],register:function(a){u.listen(a,this.events)},unregister:function(a){u.unlisten(a,this.events)},lastTouches:[],
// collide with the global mouse listener
isEventSimulatedFromTouch:function(a){for(var b,c=this.lastTouches,d=a.clientX,e=a.clientY,f=0,g=c.length;f<g&&(b=c[f]);f++){
// simulated mouse events will be swallowed near a primary touchend
var h=Math.abs(d-b.x),i=Math.abs(e-b.y);if(h<=I&&i<=I)return!0}},prepareEvent:function(a){var b=u.cloneEvent(a),c=b.preventDefault;return b.preventDefault=function(){a.preventDefault(),c()},b.pointerId=this.POINTER_ID,b.isPrimary=!0,b.pointerType=this.POINTER_TYPE,b},prepareButtonsForMove:function(a,b){var c=H.get(this.POINTER_ID);
// Update buttons state after possible out-of-document mouseup.
0!==b.which&&c?a.buttons=c.buttons:a.buttons=0,b.buttons=a.buttons},mousedown:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=H.get(this.POINTER_ID),c=this.prepareEvent(a);K||(c.buttons=J[c.button],b&&(c.buttons|=b.buttons),a.buttons=c.buttons),H.set(this.POINTER_ID,a),b&&0!==b.buttons?u.move(c):u.down(c)}},mousemove:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);K||this.prepareButtonsForMove(b,a),b.button=-1,H.set(this.POINTER_ID,a),u.move(b)}},mouseup:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=H.get(this.POINTER_ID),c=this.prepareEvent(a);if(!K){var d=J[c.button];
// Produces wrong state of buttons in Browsers without `buttons` support
// when a mouse button that was pressed outside the document is released
// inside and other buttons are still pressed down.
c.buttons=b?b.buttons&~d:0,a.buttons=c.buttons}H.set(this.POINTER_ID,a),
// Support: Firefox <=44 only
// FF Ubuntu includes the lifted button in the `buttons` property on
// mouseup.
// https://bugzilla.mozilla.org/show_bug.cgi?id=1223366
c.buttons&=~J[c.button],0===c.buttons?u.up(c):u.move(c)}},mouseover:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);K||this.prepareButtonsForMove(b,a),b.button=-1,H.set(this.POINTER_ID,a),u.enterOver(b)}},mouseout:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);K||this.prepareButtonsForMove(b,a),b.button=-1,u.leaveOut(b)}},cancel:function(a){var b=this.prepareEvent(a);u.cancel(b),this.deactivateMouse()},deactivateMouse:function(){H["delete"](this.POINTER_ID)}},O=u.captureInfo,P=v.findTarget.bind(v),Q=v.allShadows.bind(v),R=u.pointermap,S=2500,T=200,U="touch-action",V={events:["touchstart","touchmove","touchend","touchcancel"],register:function(a){M.enableOnSubtree(a)},unregister:function(){},elementAdded:function(a){var b=a.getAttribute(U),c=this.touchActionToScrollType(b);c&&(a._scrollType=c,u.listen(a,this.events),
// set touch-action on shadows as well
Q(a).forEach(function(a){a._scrollType=c,u.listen(a,this.events)},this))},elementRemoved:function(a){a._scrollType=void 0,u.unlisten(a,this.events),
// remove touch-action from shadow
Q(a).forEach(function(a){a._scrollType=void 0,u.unlisten(a,this.events)},this)},elementChanged:function(a,b){var c=a.getAttribute(U),d=this.touchActionToScrollType(c),e=this.touchActionToScrollType(b);
// simply update scrollType if listeners are already established
d&&e?(a._scrollType=d,Q(a).forEach(function(a){a._scrollType=d},this)):e?this.elementRemoved(a):d&&this.elementAdded(a)},scrollTypes:{EMITTER:"none",XSCROLLER:"pan-x",YSCROLLER:"pan-y",SCROLLER:/^(?:pan-x pan-y)|(?:pan-y pan-x)|auto$/},touchActionToScrollType:function(a){var b=a,c=this.scrollTypes;return"none"===b?"none":b===c.XSCROLLER?"X":b===c.YSCROLLER?"Y":c.SCROLLER.exec(b)?"XY":void 0},POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(a){return this.firstTouch===a.identifier},setPrimaryTouch:function(a){
// set primary touch if there no pointers, or the only pointer is the mouse
(0===R.size||1===R.size&&R.has(1))&&(this.firstTouch=a.identifier,this.firstXY={X:a.clientX,Y:a.clientY},this.scrolling=!1,this.cancelResetClickCount())},removePrimaryPointer:function(a){a.isPrimary&&(this.firstTouch=null,this.firstXY=null,this.resetClickCount())},clickCount:0,resetId:null,resetClickCount:function(){var a=function(){this.clickCount=0,this.resetId=null}.bind(this);this.resetId=setTimeout(a,T)},cancelResetClickCount:function(){this.resetId&&clearTimeout(this.resetId)},typeToButtons:function(a){var b=0;return"touchstart"!==a&&"touchmove"!==a||(b=1),b},touchToPointer:function(a){var b=this.currentTouchEvent,c=u.cloneEvent(a),d=c.pointerId=a.identifier+2;c.target=O[d]||P(c),c.bubbles=!0,c.cancelable=!0,c.detail=this.clickCount,c.button=0,c.buttons=this.typeToButtons(b.type),c.width=2*(a.radiusX||a.webkitRadiusX||0),c.height=2*(a.radiusY||a.webkitRadiusY||0),c.pressure=a.force||a.webkitForce||.5,c.isPrimary=this.isPrimaryTouch(a),c.pointerType=this.POINTER_TYPE,
// forward modifier keys
c.altKey=b.altKey,c.ctrlKey=b.ctrlKey,c.metaKey=b.metaKey,c.shiftKey=b.shiftKey;
// forward touch preventDefaults
var e=this;return c.preventDefault=function(){e.scrolling=!1,e.firstXY=null,b.preventDefault()},c},processTouches:function(a,b){var c=a.changedTouches;this.currentTouchEvent=a;for(var d,e=0;e<c.length;e++)d=c[e],b.call(this,this.touchToPointer(d))},
// For single axis scrollers, determines whether the element should emit
// pointer events or behave as a scroller
shouldScroll:function(a){if(this.firstXY){var b,c=a.currentTarget._scrollType;if("none"===c)
// this element is a touch-action: none, should never scroll
b=!1;else if("XY"===c)
// this element should always scroll
b=!0;else{var d=a.changedTouches[0],e=c,f="Y"===c?"X":"Y",g=Math.abs(d["client"+e]-this.firstXY[e]),h=Math.abs(d["client"+f]-this.firstXY[f]);
// if delta in the scroll axis > delta other axis, scroll instead of
// making events
b=g>=h}return this.firstXY=null,b}},findTouch:function(a,b){for(var c,d=0,e=a.length;d<e&&(c=a[d]);d++)if(c.identifier===b)return!0},
// In some instances, a touchstart can happen without a touchend. This
// leaves the pointermap in a broken state.
// Therefore, on every touchstart, we remove the touches that did not fire a
// touchend event.
// To keep state globally consistent, we fire a
// pointercancel for this "abandoned" touch
vacuumTouches:function(a){var b=a.touches;
// pointermap.size should be < tl.length here, as the touchstart has not
// been processed yet.
if(R.size>=b.length){var c=[];R.forEach(function(a,d){
// Never remove pointerId == 1, which is mouse.
// Touch identifiers are 2 smaller than their pointerId, which is the
// index in pointermap.
if(1!==d&&!this.findTouch(b,d-2)){var e=a.out;c.push(e)}},this),c.forEach(this.cancelOut,this)}},touchstart:function(a){this.vacuumTouches(a),this.setPrimaryTouch(a.changedTouches[0]),this.dedupSynthMouse(a),this.scrolling||(this.clickCount++,this.processTouches(a,this.overDown))},overDown:function(a){R.set(a.pointerId,{target:a.target,out:a,outTarget:a.target}),u.enterOver(a),u.down(a)},touchmove:function(a){this.scrolling||(this.shouldScroll(a)?(this.scrolling=!0,this.touchcancel(a)):(a.preventDefault(),this.processTouches(a,this.moveOverOut)))},moveOverOut:function(a){var b=a,c=R.get(b.pointerId);
// a finger drifted off the screen, ignore it
if(c){var d=c.out,e=c.outTarget;u.move(b),d&&e!==b.target&&(d.relatedTarget=b.target,b.relatedTarget=e,
// recover from retargeting by shadow
d.target=e,b.target?(u.leaveOut(d),u.enterOver(b)):(
// clean up case when finger leaves the screen
b.target=e,b.relatedTarget=null,this.cancelOut(b))),c.out=b,c.outTarget=b.target}},touchend:function(a){this.dedupSynthMouse(a),this.processTouches(a,this.upOut)},upOut:function(a){this.scrolling||(u.up(a),u.leaveOut(a)),this.cleanUpPointer(a)},touchcancel:function(a){this.processTouches(a,this.cancelOut)},cancelOut:function(a){u.cancel(a),u.leaveOut(a),this.cleanUpPointer(a)},cleanUpPointer:function(a){R["delete"](a.pointerId),this.removePrimaryPointer(a)},
// prevent synth mouse events from creating pointer events
dedupSynthMouse:function(a){var b=N.lastTouches,c=a.changedTouches[0];
// only the primary finger will synth mouse events
if(this.isPrimaryTouch(c)){
// remember x/y of last touch
var d={x:c.clientX,y:c.clientY};b.push(d);var e=function(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}.bind(null,b,d);setTimeout(e,S)}}};M=new c(V.elementAdded,V.elementRemoved,V.elementChanged,V);var W,X,Y,Z=u.pointermap,$=window.MSPointerEvent&&"number"==typeof window.MSPointerEvent.MSPOINTER_TYPE_MOUSE,_={events:["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerOut","MSPointerOver","MSPointerCancel","MSGotPointerCapture","MSLostPointerCapture"],register:function(a){u.listen(a,this.events)},unregister:function(a){u.unlisten(a,this.events)},POINTER_TYPES:["","unavailable","touch","pen","mouse"],prepareEvent:function(a){var b=a;return $&&(b=u.cloneEvent(a),b.pointerType=this.POINTER_TYPES[a.pointerType]),b},cleanup:function(a){Z["delete"](a)},MSPointerDown:function(a){Z.set(a.pointerId,a);var b=this.prepareEvent(a);u.down(b)},MSPointerMove:function(a){var b=this.prepareEvent(a);u.move(b)},MSPointerUp:function(a){var b=this.prepareEvent(a);u.up(b),this.cleanup(a.pointerId)},MSPointerOut:function(a){var b=this.prepareEvent(a);u.leaveOut(b)},MSPointerOver:function(a){var b=this.prepareEvent(a);u.enterOver(b)},MSPointerCancel:function(a){var b=this.prepareEvent(a);u.cancel(b),this.cleanup(a.pointerId)},MSLostPointerCapture:function(a){var b=u.makeEvent("lostpointercapture",a);u.dispatchEvent(b)},MSGotPointerCapture:function(a){var b=u.makeEvent("gotpointercapture",a);u.dispatchEvent(b)}},aa=window.navigator;aa.msPointerEnabled?(W=function(a){i(a),j(this),k(a)&&(u.setCapture(a,this,!0),this.msSetPointerCapture(a))},X=function(a){i(a),u.releaseCapture(a,!0),this.msReleasePointerCapture(a)}):(W=function(a){i(a),j(this),k(a)&&u.setCapture(a,this)},X=function(a){i(a),u.releaseCapture(a)}),Y=function(a){return!!u.captureInfo[a]},g(),h(),l();var ba={dispatcher:u,Installer:c,PointerEvent:a,PointerMap:p,targetFinding:v};return ba});
//fetch.js
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.WHATWGFetch={})}(this,function(t){"use strict";var e={searchParams:"URLSearchParams"in self,iterable:"Symbol"in self&&"iterator"in Symbol,blob:"FileReader"in self&&"Blob"in self&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self};if(e.arrayBuffer)var r=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],o=ArrayBuffer.isView||function(t){return t&&r.indexOf(Object.prototype.toString.call(t))>-1};function n(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function i(t){return"string"!=typeof t&&(t=String(t)),t}function s(t){var r={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(r[Symbol.iterator]=function(){return r}),r}function a(t){this.map={},t instanceof a?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function h(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function f(t){return new Promise(function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}})}function u(t){var e=new FileReader,r=f(e);return e.readAsArrayBuffer(t),r}function d(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function c(){return this.bodyUsed=!1,this._initBody=function(t){var r;this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:e.blob&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:e.formData&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():e.arrayBuffer&&e.blob&&((r=t)&&DataView.prototype.isPrototypeOf(r))?(this._bodyArrayBuffer=d(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):e.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(t)||o(t))?this._bodyArrayBuffer=d(t):this._bodyText=t=Object.prototype.toString.call(t):this._bodyText="",this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=h(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?h(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(u)}),this.text=function(){var t,e,r,o=h(this);if(o)return o;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,r=f(e),e.readAsText(t),r;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),o=0;o<e.length;o++)r[o]=String.fromCharCode(e[o]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(p)}),this.json=function(){return this.text().then(JSON.parse)},this}a.prototype.append=function(t,e){t=n(t),e=i(e);var r=this.map[t];this.map[t]=r?r+", "+e:e},a.prototype.delete=function(t){delete this.map[n(t)]},a.prototype.get=function(t){return t=n(t),this.has(t)?this.map[t]:null},a.prototype.has=function(t){return this.map.hasOwnProperty(n(t))},a.prototype.set=function(t,e){this.map[n(t)]=i(e)},a.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},a.prototype.keys=function(){var t=[];return this.forEach(function(e,r){t.push(r)}),s(t)},a.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),s(t)},a.prototype.entries=function(){var t=[];return this.forEach(function(e,r){t.push([r,e])}),s(t)},e.iterable&&(a.prototype[Symbol.iterator]=a.prototype.entries);var l=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function y(t,e){var r,o,n=(e=e||{}).body;if(t instanceof y){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new a(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,n||null==t._bodyInit||(n=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"same-origin",!e.headers&&this.headers||(this.headers=new a(e.headers)),this.method=(r=e.method||this.method||"GET",o=r.toUpperCase(),l.indexOf(o)>-1?o:r),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function p(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var r=t.split("="),o=r.shift().replace(/\+/g," "),n=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(o),decodeURIComponent(n))}}),e}function b(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new a(e.headers),this.url=e.url||"",this._initBody(t)}y.prototype.clone=function(){return new y(this,{body:this._bodyInit})},c.call(y.prototype),c.call(b.prototype),b.prototype.clone=function(){return new b(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new a(this.headers),url:this.url})},b.error=function(){var t=new b(null,{status:0,statusText:""});return t.type="error",t};var m=[301,302,303,307,308];b.redirect=function(t,e){if(-1===m.indexOf(e))throw new RangeError("Invalid status code");return new b(null,{status:e,headers:{location:t}})},t.DOMException=self.DOMException;try{new t.DOMException}catch(e){t.DOMException=function(t,e){this.message=t,this.name=e;var r=Error(t);this.stack=r.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function w(r,o){return new Promise(function(n,i){var s=new y(r,o);if(s.signal&&s.signal.aborted)return i(new t.DOMException("Aborted","AbortError"));var h=new XMLHttpRequest;function f(){h.abort()}h.onload=function(){var t,e,r={status:h.status,statusText:h.statusText,headers:(t=h.getAllResponseHeaders()||"",e=new a,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var r=t.split(":"),o=r.shift().trim();if(o){var n=r.join(":").trim();e.append(o,n)}}),e)};r.url="responseURL"in h?h.responseURL:r.headers.get("X-Request-URL");var o="response"in h?h.response:h.responseText;n(new b(o,r))},h.onerror=function(){i(new TypeError("Network request failed"))},h.ontimeout=function(){i(new TypeError("Network request failed"))},h.onabort=function(){i(new t.DOMException("Aborted","AbortError"))},h.open(s.method,s.url,!0),"include"===s.credentials?h.withCredentials=!0:"omit"===s.credentials&&(h.withCredentials=!1),"responseType"in h&&e.blob&&(h.responseType="blob"),s.headers.forEach(function(t,e){h.setRequestHeader(e,t)}),s.signal&&(s.signal.addEventListener("abort",f),h.onreadystatechange=function(){4===h.readyState&&s.signal.removeEventListener("abort",f)}),h.send(void 0===s._bodyInit?null:s._bodyInit)})}w.polyfill=!0,self.fetch||(self.fetch=w,self.Headers=a,self.Request=y,self.Response=b),t.Headers=a,t.Request=y,t.Response=b,t.fetch=w,Object.defineProperty(t,"__esModule",{value:!0})});