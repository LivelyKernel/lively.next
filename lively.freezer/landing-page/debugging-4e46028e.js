System.register(["./__rootModule___commonjs-entry-51a55f66.js","@babel/plugin-syntax-import-meta"],function(bd){var Dd,se,Rc,ad,Ne,Cb,Sd,ve,uc,dd,vd,Ed,fe,jc,Od,qb,ic,Wb,lc;return{setters:[function(db){Dd=db.l;se=db.v;Rc=db.s;ad=db.b3;Ne=db.t;Cb=db.ai;Sd=db.u;ve=db.bJ;uc=db.bK;dd=db.bL;vd=db.bM;Ed=db.Q;fe=db.bN;jc=db.bO;Od=db.bP;qb=db.i;ic=db.m;Wb=db.K;lc=db.N},function(){}],execute:function(){var db=window.lively.FreezerRuntime.recorderFor("lively.serializer2/debugging.js");db.fun=Dd;db.obj=se;db.arr=
Rc;db.num=ad;db.string=Ne;db.graph=Cb;db.Path=Sd;db.ObjectPool=ve;db.lookupPath=uc;db.referencesAndClassNamesOfId=dd;db.modifyProperty=vd;db.removeUnreachableObjects=Ed;db.referenceGraph=fe;db.findPathFromToId=jc;db.ClassHelper=Od;var Xa=bd("SnapshotInspector",function(Gb){var sc=window.lively.FreezerRuntime.recorderFor("lively.serializer2/debugging.js"),ub=sc.hasOwnProperty("SnapshotInspector")&&"function"===typeof sc.SnapshotInspector?sc.SnapshotInspector:sc.SnapshotInspector=function(sb){if(!sb||
!sb[Symbol["for"]("lively-instance-restorer")])return this[Symbol["for"]("lively-instance-initialize")].apply(this,arguments)};return qb(ub,Gb,[{key:Symbol["for"]("lively-instance-initialize"),value:function(sb){this.snapshot=sb;this.classes={};this.expressions={}}},{key:"processSnapshot",value:function(){var sb=this.snapshot;sb.snapshot&&(sb=sb.snapshot);sb=db.ObjectPool.fromSnapshot(sb);return this.processPool(sb)}},{key:"processPool",value:function(sb){var fa=this.expressions,Db=this.classes;this.pool=
sb;sb.objectRefs().forEach(function(ab){var eb=ab.currentSnapshot,kc=(eb[db.ClassHelper.classMetaForSerializationProp]||{}).className,Vb=Object.keys(eb.props);null==kc&&(kc=3<Vb.length?"{"+Vb.slice(0,3).join(", ")+", ...}":"{"+Vb.join(", ")+"}");Db[kc]||(Db[kc]={count:0,bytes:0,name:kc,objects:[]});Db[kc].count++;Db[kc].bytes+=JSON.stringify(eb).length;Db[kc].objects.push([ab.id,eb]);Vb.forEach(function(pb){var Nb=eb.props[pb].value;if(Nb&&"string"===typeof Nb&&sb.expressionSerializer.isSerializedExpression(Nb)){var zb=
sb.expressionSerializer.exprStringDecode(Nb).__expr__,rb=fa[zb];rb||(rb=fa[zb]={count:0,bytes:0,name:zb,objects:[]});rb.count++;rb.bytes+=Nb.length;rb.objects.push([[ab.id,pb],Nb])}})});return this}},{key:"explainId",value:function(sb){var fa=this.snapshot;fa.snapshot&&(fa=fa.snapshot);fa=fa[sb];if(!fa)return null;sb=(fa[db.ClassHelper.classMetaForSerializationProp]||{className:"Object"}).className;fa=Object.keys(fa.props);"Object"==sb&&(sb=3<fa.length?"{"+fa.slice(0,3).join(", ")+", ...}":"{"+fa.join(", ")+
"}");return sb}},{key:"sorted",value:function(sb){var fa=this;return db.arr.sortBy(Object.keys(this[sb]).map(function(Db){return fa[sb][Db]}),function(Db){return isNaN(Db.bytes)?0:Db.bytes}).reverse()}},{key:"report",value:function(sb){sb=[["#bytes","#objs","avg",sb]].concat(ic(this.sorted(sb).map(function(fa){return[db.num.humanReadableByteSize(fa.bytes),fa.count,db.num.humanReadableByteSize(fa.bytes/fa.count),db.string.truncate(fa.name,300)]})));return db.string.printTable(sb,{separator:" | "})}},
{key:"toString",value:function(){var sb=this.snapshot,fa=JSON.stringify(sb).length;sb=Object.keys(sb).length;return db.string.format("Total: %s (%s objs - %s per obj)",db.num.humanReadableByteSize(fa),sb,db.num.humanReadableByteSize(fa/sb))+"\nclasses:\n"+this.report("classes")+"\nexpressions:\n"+this.report("expressions")}},{key:"biggestObjectsOfType",value:function(sb){return db.arr.sortBy(this.classes[sb].objects.map(function(fa){fa=Wb(fa,2);fa[0];return JSON.stringify(fa[1])}),function(fa){return fa.length}).reverse().map(function(fa){return JSON.parse(fa)})}},
{key:"toCSV",value:function(){var sb=["type,size,size in bytes,count,size per object,size perobject in bytes"];this.sorted("classes").forEach(function(fa){sb.push([fa.name,db.num.humanReadableByteSize(fa.bytes),fa.bytes,fa.count,db.num.humanReadableByteSize(fa.bytes/fa.count),fa.bytes/fa.count].join())});return sb.join("\n")}},{key:"findPathFromToId",value:function(sb,fa){var Db=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},ab=this.snapshot;ab.snapshot&&(ab=ab.snapshot);return db.findPathFromToId(ab,
sb,fa,Db)}},{key:"referenceGraph",value:function(){var sb=this.snapshot;sb.snapshot&&(sb=sb.snapshot);return db.referenceGraph(sb)}},{key:"referenceCounts",value:function(){var sb=db.graph.invert(this.referenceGraph()),fa={};Object.keys(sb).forEach(function(Db){return fa[Db]=sb[Db].length});return fa}},{key:"lookupPath",value:function(sb,fa){var Db=this.snapshot;Db.snapshot&&(Db=Db.snapshot);return db.lookupPath(Db,sb,fa)}},{key:"idsReferencingId",value:function(sb){return db.graph.invert(this.referenceGraph())[sb]}},
{key:"modifyProperty",value:function(sb,fa,Db){var ab=this.snapshot;ab.snapshot&&(ab=ab.snapshot);return db.modifyProperty(ab,sb,fa,Db)}},{key:"replaceReferencesTo",value:function(sb,fa){var Db=db.graph.invert(this.referenceGraph())[sb];Db=lc(Db);var ab;try{for(Db.s();!(ab=Db.n()).done;){var eb=ab.value,kc=this.findPathFromToId(eb,sb);this.modifyProperty(eb,kc,fa)}}catch(Vb){Db.e(Vb)}finally{Db.f()}}},{key:"removeUnreachableObjects",value:function(sb){var fa=this.snapshot;sb||(sb=this.snapshot.id);
if(!sb)throw Error("Cannot find root id");fa.snapshot&&(fa=fa.snapshot);return db.removeUnreachableObjects([sb],fa)}},{key:"reportAboutObject",value:function(sb,fa,Db){var ab=this;fa=fa||this.referenceGraph();Db=Db||db.graph.invert(fa);Db=(Db[sb]||[]).map(function(eb){return[eb,ab.findPathFromToId(eb,sb),ab.explainId(eb)]});fa=(fa[sb]||[]).map(function(eb){return[eb,ab.findPathFromToId(sb,eb),ab.explainId(eb)]});return"".concat(sb,"\n")+" is a ".concat(this.explainId(sb)," object\n")+" path from root: ".concat(this.findPathFromToId(this.snapshot.id,
sb),"\n")+" references \n".concat(db.string.indent(db.string.printTable(fa),"  ",2),"\n")+" referenced by:\n".concat(db.string.indent(db.string.printTable(Db),"  ",2),"\n")}},{key:"reportAboutObjects",value:function(sb){var fa=this,Db=this.referenceGraph(),ab=db.graph.invert(Db);return sb.map(function(eb){return fa.reportAboutObject(eb,Db,ab)}).join("\n")}},{key:"rootObjectName",value:function(){var sb=this.snapshot,fa="";if(sb.snapshot){var Db=sb.id;sb=sb.snapshot;sb[Db].props.name&&(fa=sb[Db].props.name.value)}return fa}},
{key:"openSummary",value:function(){var sb=this.rootObjectName();return $world.execCommand("open text window",{content:this.toString(),title:"serialization debug"+(sb?" for "+sb:""),fontFamily:"monospace"})}},{key:"openConnectionsList",value:function(){var sb=this,fa=this.rootObjectName(),Db=((this.classes.AttributeConnection||{}).objects||[]).map(function(ab){var eb=Wb(ab,2);ab=eb[0];var kc=eb[1].props;eb=kc.sourceObj;var Vb=kc.sourceAttrName,pb=kc.targetObj;kc=kc.targetMethodName;return"".concat(sb.explainId(eb.value.id),
".").concat(Vb.value," => ")+"".concat(sb.explainId(pb.value.id),".").concat(kc.value,"\n")+"  ".concat(eb.value.id," => ").concat(pb.value.id,"\n")+"  connection id: ".concat(ab,"\n")}).join("\n");return $world.execCommand("open text window",{content:Db,title:"serialized connections"+(fa?" for "+fa:""),fontFamily:"monospace"})}},{key:"openObjectReport",value:function(){var sb=this.snapshot,fa=this.rootObjectName();sb.snapshot&&(sb=sb.snapshot);$world.execCommand("open text window",{title:"object report"+
(fa?" for "+fa:""),content:this.reportAboutObjects(Object.keys(sb)),fontFamily:"monospace"})}}],[{key:Symbol["for"]("__LivelyClassName__"),get:function(){return"SnapshotInspector"}},{key:"forSnapshot",value:function(sb){return(new this(sb)).processSnapshot()}},{key:"forPoolAndSnapshot",value:function(sb,fa){return(new this(sb)).processPool(fa)}},{key:"checkForLeaks",value:function(sb){(new this).processPool(sb).referenceCounts();(this.classes.AttributeConnection||{}).objects||[]}}],sc,{pathInPackage:function(){return"./debugging.js"},
unsubscribeFromToplevelDefinitionChanges:function(){return function(){}},subscribeToToplevelDefinitionChanges:function(){return function(){}},"package":function(){return{name:"lively.serializer2",version:"0.1.3"}}},{start:3299,end:12122})}(void 0));db.SnapshotInspector=Xa;db.SnapshotInspector=Xa}}});