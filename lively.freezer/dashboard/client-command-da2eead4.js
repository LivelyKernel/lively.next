System.register(["./__root_module__-7efb35ac.js","kld-intersections"],function(Ba){var Cb,Sb,jc,lc,Xd;return{setters:[function(ed){Cb=ed._;Sb=ed.bl;jc=ed.a4;lc=ed.a5;Xd=ed.ap},function(){}],execute:function(){function ed(jd,bb){bb=void 0===bb?{}:bb;var Fb=bb.l2lClient;if(!Fb)throw Error("lively.shell client side runCommand needs opts.l2lClient!");Sd.ClientCommand.installLively2LivelyServices(Fb);Fb=new Sd.ClientCommand(Fb);Fb.spawn(Object.assign({command:jd},Sd.obj.dissoc(bb,["l2lClient"])));
return Fb}function Yd(jd){return Sd.dirCache[jd.trackerId]?Sd.dirCache[jd.trackerId]:Promise.resolve().then(function(){var bb,Fb,vc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){if(1==pc.nextAddress)return pc.yield(jd.sendToAndWait(jd.trackerId,"lively.shell.info",{}),2);bb=pc.yieldResult;Fb=bb.data;vc=Fb.defaultDirectory;return pc.return(Sd.dirCache[jd.trackerId]=vc)})})}function id(jd){var bb,Fb,vc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){if(1==pc.nextAddress)return pc.yield(jd.sendToAndWait(jd.trackerId,
"lively.shell.env",{}),2);bb=pc.yieldResult;Fb=bb.data;vc=Fb.env;return pc.return(vc)})}function Wc(jd,bb){bb=(bb=void 0===bb?{}:bb)||{};var Fb=Sd.runCommand('cat "'+jd+'"',bb);return Fb.whenDone().then(function(){if(Fb.exitCode)throw Error("Read "+jd+" failed: "+Fb.stderr);return Fb.output})}function Ad(jd,bb,Fb){!Fb&&bb&&bb.content&&(Fb=bb,bb=Fb.content);var vc=Sd.runCommand('tee "'+jd+'"',Object.assign({stdin:bb||""},Fb));return vc.whenDone().then(function(){if(vc.exitCode)throw Error("Write "+
jd+" failed: "+vc.stderr);return vc})}Ba({defaultDirectory:Yd,env:id,readFile:Wc,runCommand:ed,writeFile:Ad});var Cd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");Cd.promise=Cb;Cd.events=Sb;var fe=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=Cd.promise.deferred();this._whenStarted=Cd.promise.deferred();this.startTime=0;this.lastSignal=null;Cd.events.makeEmitter(this)};fe.findCommand=function(jd){return this.commands.find(function(bb){return bb.pid===
jd})};fe.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};fe.prototype.isDone=function(){return void 0!=this.exitCode};fe.prototype.whenStarted=function(){return this._whenStarted.promise};fe.prototype.whenDone=function(){return this._whenDone.promise};fe.prototype.spawn=function(jd){throw Error("not yet implemented");};fe.prototype.kill=function(jd){this.lastSignal=void 0===jd?"KILL":jd};fe.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(fe.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(fe,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});Cd.CommandInterface=fe;Cd.default=fe;var Sd=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");Sd.runCommand=ed;Sd.defaultDirectory=Yd;Sd.env=id;Sd.readFile=Wc;Sd.writeFile=
Ad;Sd.CommandInterface=fe;Sd.promise=Cb;Sd.arr=jc;Sd.obj=lc;Sd.signal=Xd;Sd.debug=!1;Sd.runCommand=ed;Sd.runCommand=ed;Sd.dirCache={};Sd.defaultDirectory=Yd;Sd.defaultDirectory=Yd;Sd.env=id;Sd.env=id;Sd.readFile=Wc;Sd.readFile=Wc;Sd.writeFile=Ad;Sd.writeFile=Ad;fe=function(jd){var bb=Sd.CommandInterface.call(this)||this;bb.debug=Sd.debug;bb.l2lClient=jd;return bb};$jscomp.inherits(fe,Sd.CommandInterface);fe.installLively2LivelyServices=function(jd){Object.keys(Sd.L2LServices).forEach(function(bb){return jd.addService(bb,
function(Fb,vc,pc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(sd){return sd.return(Sd.L2LServices[bb](Fb,vc,pc))})})})};fe.prototype.envForCommand=function(jd){var bb=this.l2lClient,Fb=bb.id,vc=bb.origin,pc=bb.path;bb=bb.namespace;var sd=jd||{};jd=sd.env;sd=sd.owner;jd=jd||{};sd&&(jd.LIVELY_COMMAND_OWNER=sd);return Object.assign({ASKPASS_SESSIONID:Fb,L2L_EDITOR_SESSIONID:Fb,L2L_SESSIONTRACKER_SERVER:vc,L2L_SESSIONTRACKER_PATH:pc,L2L_SESSIONTRACKER_NS:bb},jd)};fe.prototype.spawn=function(jd){jd=
void 0===jd?{command:null,env:{},cwd:null,stdin:null}:jd;var bb=this,Fb,vc,pc,sd,pd,tc,bd,Xb,Tb,Oc,td;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Pb){if(1==Pb.nextAddress)return Fb=bb,vc=Fb.l2lClient,pc=jd,sd=pc.command,pd=pc.env,tc=pc.cwd,bd=pc.stdin,bb.startTime=new Date,pd=bb.envForCommand(jd),bb.debug&&console.log(bb+" spawning "+sd),bb.debug&&bb.whenStarted().then(function(){return console.log(bb+" started")}),bb.debug&&bb.whenDone().then(function(){return console.log(bb+" exited")}),
Sd.arr.pushIfNotIncluded(bb.constructor.commands,bb),bb.commandString=Array.isArray(sd)?sd.join(""):sd,Pb.yield(vc.sendToAndWait(vc.trackerId,"lively.shell.spawn",{command:sd,env:pd,cwd:tc,stdin:bd},{ackTimeout:3E4}),2);Xb=Pb.yieldResult;Tb=Xb.data;Oc=Tb.error;td=Tb.pid;if(Oc)throw Sd.debug&&console.error("["+bb+"] error at start: "+Oc),bb.process={error:Oc},bb.exitCode=1,Sd.signal(bb,"error",Oc),Error(Oc);bb.process={pid:td};Sd.debug&&console.log("["+bb+"] got pid "+td);Sd.signal(bb,"pid",td);bb._whenStarted.resolve();
return Pb.return(bb)})};fe.prototype.writeToStdin=function(jd){var bb=this,Fb,vc,pc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(sd){if(!bb.isRunning())return sd.return();Fb=bb;vc=Fb.l2lClient;pc=Fb.pid;return sd.yield(vc.sendToAndWait(vc.trackerId,"lively.shell.writeToStdin",{pid:pc,stdin:String(jd)}),0)})};fe.prototype.kill=function(jd){jd=void 0===jd?"KILL":jd;var bb=this,Fb,vc,pc,sd,pd,tc,bd;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Xb){if(1==Xb.nextAddress){if(!bb.isRunning())return Xb.return();
Sd.debug&&console.log(bb+" signaling "+jd);bb.lastSignal=jd;Fb=bb;vc=Fb.pid;pc=Fb.l2lClient;return Xb.yield(pc.sendToAndWait(pc.trackerId,"lively.shell.kill",{pid:vc}),2)}sd=Xb.yieldResult;pd=sd.data;tc=pd.status;bd=pd.error;Sd.debug&&console.log(bb+" kill send: "+(bd||tc));if(bd)throw Error(bd);return Xb.return(bb.whenDone())})};fe.prototype.onOutput=function(jd){var bb=jd.stdout;jd=jd.stderr;bb&&(this._stdout+=bb,Sd.signal(this,"stdout",bb),this.emit("stdout",bb));jd&&(this._stderr+=jd,Sd.signal(this,
"stderr",jd),this.emit("stderr",jd))};fe.prototype.onClose=function(jd){Sd.arr.remove(this.constructor.commands,this);this.exitCode=jd;this.emit("close",jd);Sd.signal(this,"close",jd);this._whenDone.resolve(this)};fe.prototype.onError=function(jd){Sd.arr.remove(this.constructor.commands,this);this._stderr+=jd.stack;this.exitCode=1;this.emit("error",jd.stack);Sd.signal(this,"error",jd.stack);this._whenDone.reject(jd)};Ba("default",fe);Sd.ClientCommand=fe;Sd.L2LServices={"lively.shell.onOutput":function(jd,
bb,Fb,vc){jd=bb.data;var pc=jd.pid,sd=jd.stdout,pd=jd.stderr,tc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bd){switch(bd.nextAddress){case 1:return Sd.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+pc),bd.setCatchFinallyBlocks(2),bd.yield(Sd.promise.waitFor(1E3,function(){return Sd.ClientCommand.findCommand(pc)}),4);case 4:tc=bd.yieldResult;bd.leaveTryBlock(3);break;case 2:return bd.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
pc+" but it isn't registered!'"),bd.return();case 3:tc.onOutput({stdout:sd,stderr:pd}),bd.jumpToEnd()}})},"lively.shell.onExit":function(jd,bb,Fb,vc){jd=bb.data;var pc=jd.pid,sd=jd.code,pd=jd.error,tc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bd){switch(bd.nextAddress){case 1:return Sd.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+pc),bd.setCatchFinallyBlocks(2),bd.yield(Sd.promise.waitFor(1E3,function(){return Sd.ClientCommand.findCommand(pc)}),
4);case 4:tc=bd.yieldResult;bd.leaveTryBlock(3);break;case 2:return bd.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+pc+" but it isn't registered!'"),bd.return();case 3:if(pd)"string"===typeof pd&&(pd=Error(pd)),tc.onError(pd);else tc.onClose(sd);bd.jumpToEnd()}})}};Sd.default=fe}}});