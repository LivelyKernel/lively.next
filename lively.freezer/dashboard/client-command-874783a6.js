System.register(["./__root_module__-64e296ea.js","kld-intersections"],function(Ba){var Ab,Qb,dc,Xb,Xd;return{setters:[function(ad){Ab=ad.$;Qb=ad.bo;dc=ad.a6;Xb=ad.a7;Xd=ad.as},function(){}],execute:function(){function ad(Hc,fb){fb=void 0===fb?{}:fb;var Db=fb.l2lClient;if(!Db)throw Error("lively.shell client side runCommand needs opts.l2lClient!");Kd.ClientCommand.installLively2LivelyServices(Db);Db=new Kd.ClientCommand(Db);Db.spawn(Object.assign({command:Hc},Kd.obj.dissoc(fb,["l2lClient"])));
return Db}function Nd(Hc){return Kd.dirCache[Hc.trackerId]?Kd.dirCache[Hc.trackerId]:Promise.resolve().then(function(){var fb,Db,mc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(hc){if(1==hc.nextAddress)return hc.yield(Hc.sendToAndWait(Hc.trackerId,"lively.shell.info",{}),2);fb=hc.yieldResult;Db=fb.data;mc=Db.defaultDirectory;return hc.return(Kd.dirCache[Hc.trackerId]=mc)})})}function dd(Hc){var fb,Db,mc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(hc){if(1==hc.nextAddress)return hc.yield(Hc.sendToAndWait(Hc.trackerId,
"lively.shell.env",{}),2);fb=hc.yieldResult;Db=fb.data;mc=Db.env;return hc.return(mc)})}function Lc(Hc,fb){fb=(fb=void 0===fb?{}:fb)||{};var Db=Kd.runCommand('cat "'+Hc+'"',fb);return Db.whenDone().then(function(){if(Db.exitCode)throw Error("Read "+Hc+" failed: "+Db.stderr);return Db.output})}function rd(Hc,fb,Db){!Db&&fb&&fb.content&&(Db=fb,fb=Db.content);var mc=Kd.runCommand('tee "'+Hc+'"',Object.assign({stdin:fb||""},Db));return mc.whenDone().then(function(){if(mc.exitCode)throw Error("Write "+
Hc+" failed: "+mc.stderr);return mc})}Ba({defaultDirectory:Nd,env:dd,readFile:Lc,runCommand:ad,writeFile:rd});var Gd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");Gd.promise=Ab;Gd.events=Qb;var ke=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=Gd.promise.deferred();this._whenStarted=Gd.promise.deferred();this.startTime=0;this.lastSignal=null;Gd.events.makeEmitter(this)};ke.findCommand=function(Hc){return this.commands.find(function(fb){return fb.pid===
Hc})};ke.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};ke.prototype.isDone=function(){return void 0!=this.exitCode};ke.prototype.whenStarted=function(){return this._whenStarted.promise};ke.prototype.whenDone=function(){return this._whenDone.promise};ke.prototype.spawn=function(Hc){throw Error("not yet implemented");};ke.prototype.kill=function(Hc){this.lastSignal=void 0===Hc?"KILL":Hc};ke.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(ke.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(ke,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});Gd.CommandInterface=ke;Gd.default=ke;var Kd=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");Kd.runCommand=ad;Kd.defaultDirectory=Nd;Kd.env=dd;Kd.readFile=Lc;Kd.writeFile=
rd;Kd.CommandInterface=ke;Kd.promise=Ab;Kd.arr=dc;Kd.obj=Xb;Kd.signal=Xd;Kd.debug=!1;Kd.runCommand=ad;Kd.runCommand=ad;Kd.dirCache={};Kd.defaultDirectory=Nd;Kd.defaultDirectory=Nd;Kd.env=dd;Kd.env=dd;Kd.readFile=Lc;Kd.readFile=Lc;Kd.writeFile=rd;Kd.writeFile=rd;ke=function(Hc){var fb=Kd.CommandInterface.call(this)||this;fb.debug=Kd.debug;fb.l2lClient=Hc;return fb};$jscomp.inherits(ke,Kd.CommandInterface);ke.installLively2LivelyServices=function(Hc){Object.keys(Kd.L2LServices).forEach(function(fb){return Hc.addService(fb,
function(Db,mc,hc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(Tc){return Tc.return(Kd.L2LServices[fb](Db,mc,hc))})})})};ke.prototype.envForCommand=function(Hc){var fb=this.l2lClient,Db=fb.id,mc=fb.origin,hc=fb.path;fb=fb.namespace;var Tc=Hc||{};Hc=Tc.env;Tc=Tc.owner;Hc=Hc||{};Tc&&(Hc.LIVELY_COMMAND_OWNER=Tc);return Object.assign({ASKPASS_SESSIONID:Db,L2L_EDITOR_SESSIONID:Db,L2L_SESSIONTRACKER_SERVER:mc,L2L_SESSIONTRACKER_PATH:hc,L2L_SESSIONTRACKER_NS:fb},Hc)};ke.prototype.spawn=function(Hc){Hc=
void 0===Hc?{command:null,env:{},cwd:null,stdin:null}:Hc;var fb=this,Db,mc,hc,Tc,Ld,oc,pc,Nb,Dc,Vc,Hd;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Id){if(1==Id.nextAddress)return Db=fb,mc=Db.l2lClient,hc=Hc,Tc=hc.command,Ld=hc.env,oc=hc.cwd,pc=hc.stdin,fb.startTime=new Date,Ld=fb.envForCommand(Hc),fb.debug&&console.log(fb+" spawning "+Tc),fb.debug&&fb.whenStarted().then(function(){return console.log(fb+" started")}),fb.debug&&fb.whenDone().then(function(){return console.log(fb+" exited")}),
Kd.arr.pushIfNotIncluded(fb.constructor.commands,fb),fb.commandString=Array.isArray(Tc)?Tc.join(""):Tc,Id.yield(mc.sendToAndWait(mc.trackerId,"lively.shell.spawn",{command:Tc,env:Ld,cwd:oc,stdin:pc},{ackTimeout:3E4}),2);Nb=Id.yieldResult;Dc=Nb.data;Vc=Dc.error;Hd=Dc.pid;if(Vc)throw Kd.debug&&console.error("["+fb+"] error at start: "+Vc),fb.process={error:Vc},fb.exitCode=1,Kd.signal(fb,"error",Vc),Error(Vc);fb.process={pid:Hd};Kd.debug&&console.log("["+fb+"] got pid "+Hd);Kd.signal(fb,"pid",Hd);fb._whenStarted.resolve();
return Id.return(fb)})};ke.prototype.writeToStdin=function(Hc){var fb=this,Db,mc,hc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Tc){if(!fb.isRunning())return Tc.return();Db=fb;mc=Db.l2lClient;hc=Db.pid;return Tc.yield(mc.sendToAndWait(mc.trackerId,"lively.shell.writeToStdin",{pid:hc,stdin:String(Hc)}),0)})};ke.prototype.kill=function(Hc){Hc=void 0===Hc?"KILL":Hc;var fb=this,Db,mc,hc,Tc,Ld,oc,pc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Nb){if(1==Nb.nextAddress){if(!fb.isRunning())return Nb.return();
Kd.debug&&console.log(fb+" signaling "+Hc);fb.lastSignal=Hc;Db=fb;mc=Db.pid;hc=Db.l2lClient;return Nb.yield(hc.sendToAndWait(hc.trackerId,"lively.shell.kill",{pid:mc}),2)}Tc=Nb.yieldResult;Ld=Tc.data;oc=Ld.status;pc=Ld.error;Kd.debug&&console.log(fb+" kill send: "+(pc||oc));if(pc)throw Error(pc);return Nb.return(fb.whenDone())})};ke.prototype.onOutput=function(Hc){var fb=Hc.stdout;Hc=Hc.stderr;fb&&(this._stdout+=fb,Kd.signal(this,"stdout",fb),this.emit("stdout",fb));Hc&&(this._stderr+=Hc,Kd.signal(this,
"stderr",Hc),this.emit("stderr",Hc))};ke.prototype.onClose=function(Hc){Kd.arr.remove(this.constructor.commands,this);this.exitCode=Hc;this.emit("close",Hc);Kd.signal(this,"close",Hc);this._whenDone.resolve(this)};ke.prototype.onError=function(Hc){Kd.arr.remove(this.constructor.commands,this);this._stderr+=Hc.stack;this.exitCode=1;this.emit("error",Hc.stack);Kd.signal(this,"error",Hc.stack);this._whenDone.reject(Hc)};Ba("default",ke);Kd.ClientCommand=ke;Kd.L2LServices={"lively.shell.onOutput":function(Hc,
fb,Db,mc){Hc=fb.data;var hc=Hc.pid,Tc=Hc.stdout,Ld=Hc.stderr,oc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){switch(pc.nextAddress){case 1:return Kd.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+hc),pc.setCatchFinallyBlocks(2),pc.yield(Kd.promise.waitFor(1E3,function(){return Kd.ClientCommand.findCommand(hc)}),4);case 4:oc=pc.yieldResult;pc.leaveTryBlock(3);break;case 2:return pc.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
hc+" but it isn't registered!'"),pc.return();case 3:oc.onOutput({stdout:Tc,stderr:Ld}),pc.jumpToEnd()}})},"lively.shell.onExit":function(Hc,fb,Db,mc){Hc=fb.data;var hc=Hc.pid,Tc=Hc.code,Ld=Hc.error,oc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){switch(pc.nextAddress){case 1:return Kd.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+hc),pc.setCatchFinallyBlocks(2),pc.yield(Kd.promise.waitFor(1E3,function(){return Kd.ClientCommand.findCommand(hc)}),
4);case 4:oc=pc.yieldResult;pc.leaveTryBlock(3);break;case 2:return pc.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+hc+" but it isn't registered!'"),pc.return();case 3:if(Ld)"string"===typeof Ld&&(Ld=Error(Ld)),oc.onError(Ld);else oc.onClose(Tc);pc.jumpToEnd()}})}};Kd.default=ke}}});