System.register(["./__root_module__-aa47e4cd.js","kld-intersections"],function(Ca){var ub,Tb,lc,mc,Zd;return{setters:[function(id){ub=id._;Tb=id.bl;lc=id.a4;mc=id.a5;Zd=id.ap},function(){}],execute:function(){function id(nd,eb){eb=void 0===eb?{}:eb;var Hb=eb.l2lClient;if(!Hb)throw Error("lively.shell client side runCommand needs opts.l2lClient!");Xd.ClientCommand.installLively2LivelyServices(Hb);Hb=new Xd.ClientCommand(Hb);Hb.spawn(Object.assign({command:nd},Xd.obj.dissoc(eb,["l2lClient"])));
return Hb}function ce(nd){return Xd.dirCache[nd.trackerId]?Xd.dirCache[nd.trackerId]:Promise.resolve().then(function(){var eb,Hb,Cc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(qc){if(1==qc.nextAddress)return qc.yield(nd.sendToAndWait(nd.trackerId,"lively.shell.info",{}),2);eb=qc.yieldResult;Hb=eb.data;Cc=Hb.defaultDirectory;return qc.return(Xd.dirCache[nd.trackerId]=Cc)})})}function kd(nd){var eb,Hb,Cc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(qc){if(1==qc.nextAddress)return qc.yield(nd.sendToAndWait(nd.trackerId,
"lively.shell.env",{}),2);eb=qc.yieldResult;Hb=eb.data;Cc=Hb.env;return qc.return(Cc)})}function $c(nd,eb){eb=(eb=void 0===eb?{}:eb)||{};var Hb=Xd.runCommand('cat "'+nd+'"',eb);return Hb.whenDone().then(function(){if(Hb.exitCode)throw Error("Read "+nd+" failed: "+Hb.stderr);return Hb.output})}function Cd(nd,eb,Hb){!Hb&&eb&&eb.content&&(Hb=eb,eb=Hb.content);var Cc=Xd.runCommand('tee "'+nd+'"',Object.assign({stdin:eb||""},Hb));return Cc.whenDone().then(function(){if(Cc.exitCode)throw Error("Write "+
nd+" failed: "+Cc.stderr);return Cc})}Ca({defaultDirectory:ce,env:kd,readFile:$c,runCommand:id,writeFile:Cd});var Fd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");Fd.promise=ub;Fd.events=Tb;var pe=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=Fd.promise.deferred();this._whenStarted=Fd.promise.deferred();this.startTime=0;this.lastSignal=null;Fd.events.makeEmitter(this)};pe.findCommand=function(nd){return this.commands.find(function(eb){return eb.pid===
nd})};pe.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};pe.prototype.isDone=function(){return void 0!=this.exitCode};pe.prototype.whenStarted=function(){return this._whenStarted.promise};pe.prototype.whenDone=function(){return this._whenDone.promise};pe.prototype.spawn=function(nd){throw Error("not yet implemented");};pe.prototype.kill=function(nd){this.lastSignal=void 0===nd?"KILL":nd};pe.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(pe.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(pe,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});Fd.CommandInterface=pe;Fd.default=pe;var Xd=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");Xd.runCommand=id;Xd.defaultDirectory=ce;Xd.env=kd;Xd.readFile=$c;Xd.writeFile=
Cd;Xd.CommandInterface=pe;Xd.promise=ub;Xd.arr=lc;Xd.obj=mc;Xd.signal=Zd;Xd.debug=!1;Xd.runCommand=id;Xd.runCommand=id;Xd.dirCache={};Xd.defaultDirectory=ce;Xd.defaultDirectory=ce;Xd.env=kd;Xd.env=kd;Xd.readFile=$c;Xd.readFile=$c;Xd.writeFile=Cd;Xd.writeFile=Cd;pe=function(nd){var eb=Xd.CommandInterface.call(this)||this;eb.debug=Xd.debug;eb.l2lClient=nd;return eb};$jscomp.inherits(pe,Xd.CommandInterface);pe.installLively2LivelyServices=function(nd){Object.keys(Xd.L2LServices).forEach(function(eb){return nd.addService(eb,
function(Hb,Cc,qc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(ld){return ld.return(Xd.L2LServices[eb](Hb,Cc,qc))})})})};pe.prototype.envForCommand=function(nd){var eb=this.l2lClient,Hb=eb.id,Cc=eb.origin,qc=eb.path;eb=eb.namespace;var ld=nd||{};nd=ld.env;ld=ld.owner;nd=nd||{};ld&&(nd.LIVELY_COMMAND_OWNER=ld);return Object.assign({ASKPASS_SESSIONID:Hb,L2L_EDITOR_SESSIONID:Hb,L2L_SESSIONTRACKER_SERVER:Cc,L2L_SESSIONTRACKER_PATH:qc,L2L_SESSIONTRACKER_NS:eb},nd)};pe.prototype.spawn=function(nd){nd=
void 0===nd?{command:null,env:{},cwd:null,stdin:null}:nd;var eb=this,Hb,Cc,qc,ld,wd,Xc,gd,bc,ad,ed,Id;return $jscomp.asyncExecutePromiseGeneratorProgram(function(hc){if(1==hc.nextAddress)return Hb=eb,Cc=Hb.l2lClient,qc=nd,ld=qc.command,wd=qc.env,Xc=qc.cwd,gd=qc.stdin,eb.startTime=new Date,wd=eb.envForCommand(nd),eb.debug&&console.log(eb+" spawning "+ld),eb.debug&&eb.whenStarted().then(function(){return console.log(eb+" started")}),eb.debug&&eb.whenDone().then(function(){return console.log(eb+" exited")}),
Xd.arr.pushIfNotIncluded(eb.constructor.commands,eb),eb.commandString=Array.isArray(ld)?ld.join(""):ld,hc.yield(Cc.sendToAndWait(Cc.trackerId,"lively.shell.spawn",{command:ld,env:wd,cwd:Xc,stdin:gd},{ackTimeout:3E4}),2);bc=hc.yieldResult;ad=bc.data;ed=ad.error;Id=ad.pid;if(ed)throw Xd.debug&&console.error("["+eb+"] error at start: "+ed),eb.process={error:ed},eb.exitCode=1,Xd.signal(eb,"error",ed),Error(ed);eb.process={pid:Id};Xd.debug&&console.log("["+eb+"] got pid "+Id);Xd.signal(eb,"pid",Id);eb._whenStarted.resolve();
return hc.return(eb)})};pe.prototype.writeToStdin=function(nd){var eb=this,Hb,Cc,qc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(ld){if(!eb.isRunning())return ld.return();Hb=eb;Cc=Hb.l2lClient;qc=Hb.pid;return ld.yield(Cc.sendToAndWait(Cc.trackerId,"lively.shell.writeToStdin",{pid:qc,stdin:String(nd)}),0)})};pe.prototype.kill=function(nd){nd=void 0===nd?"KILL":nd;var eb=this,Hb,Cc,qc,ld,wd,Xc,gd;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bc){if(1==bc.nextAddress){if(!eb.isRunning())return bc.return();
Xd.debug&&console.log(eb+" signaling "+nd);eb.lastSignal=nd;Hb=eb;Cc=Hb.pid;qc=Hb.l2lClient;return bc.yield(qc.sendToAndWait(qc.trackerId,"lively.shell.kill",{pid:Cc}),2)}ld=bc.yieldResult;wd=ld.data;Xc=wd.status;gd=wd.error;Xd.debug&&console.log(eb+" kill send: "+(gd||Xc));if(gd)throw Error(gd);return bc.return(eb.whenDone())})};pe.prototype.onOutput=function(nd){var eb=nd.stdout;nd=nd.stderr;eb&&(this._stdout+=eb,Xd.signal(this,"stdout",eb),this.emit("stdout",eb));nd&&(this._stderr+=nd,Xd.signal(this,
"stderr",nd),this.emit("stderr",nd))};pe.prototype.onClose=function(nd){Xd.arr.remove(this.constructor.commands,this);this.exitCode=nd;this.emit("close",nd);Xd.signal(this,"close",nd);this._whenDone.resolve(this)};pe.prototype.onError=function(nd){Xd.arr.remove(this.constructor.commands,this);this._stderr+=nd.stack;this.exitCode=1;this.emit("error",nd.stack);Xd.signal(this,"error",nd.stack);this._whenDone.reject(nd)};Ca("default",pe);Xd.ClientCommand=pe;Xd.L2LServices={"lively.shell.onOutput":function(nd,
eb,Hb,Cc){nd=eb.data;var qc=nd.pid,ld=nd.stdout,wd=nd.stderr,Xc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(gd){switch(gd.nextAddress){case 1:return Xd.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+qc),gd.setCatchFinallyBlocks(2),gd.yield(Xd.promise.waitFor(1E3,function(){return Xd.ClientCommand.findCommand(qc)}),4);case 4:Xc=gd.yieldResult;gd.leaveTryBlock(3);break;case 2:return gd.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
qc+" but it isn't registered!'"),gd.return();case 3:Xc.onOutput({stdout:ld,stderr:wd}),gd.jumpToEnd()}})},"lively.shell.onExit":function(nd,eb,Hb,Cc){nd=eb.data;var qc=nd.pid,ld=nd.code,wd=nd.error,Xc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(gd){switch(gd.nextAddress){case 1:return Xd.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+qc),gd.setCatchFinallyBlocks(2),gd.yield(Xd.promise.waitFor(1E3,function(){return Xd.ClientCommand.findCommand(qc)}),
4);case 4:Xc=gd.yieldResult;gd.leaveTryBlock(3);break;case 2:return gd.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+qc+" but it isn't registered!'"),gd.return();case 3:if(wd)"string"===typeof wd&&(wd=Error(wd)),Xc.onError(wd);else Xc.onClose(ld);gd.jumpToEnd()}})}};Xd.default=pe}}});