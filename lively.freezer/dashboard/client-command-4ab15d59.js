System.register(["./__root_module__-5a58cfed.js","kld-intersections"],function(Ca){var Cb,Vb,lc,gc,fe;return{setters:[function(fd){Cb=fd._;Vb=fd.bl;lc=fd.a4;gc=fd.a5;fe=fd.ap},function(){}],execute:function(){function fd(kd,cb){cb=void 0===cb?{}:cb;var Fb=cb.l2lClient;if(!Fb)throw Error("lively.shell client side runCommand needs opts.l2lClient!");Ud.ClientCommand.installLively2LivelyServices(Fb);Fb=new Ud.ClientCommand(Fb);Fb.spawn(Object.assign({command:kd},Ud.obj.dissoc(cb,["l2lClient"])));
return Fb}function Zd(kd){return Ud.dirCache[kd.trackerId]?Ud.dirCache[kd.trackerId]:Promise.resolve().then(function(){var cb,Fb,vc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){if(1==pc.nextAddress)return pc.yield(kd.sendToAndWait(kd.trackerId,"lively.shell.info",{}),2);cb=pc.yieldResult;Fb=cb.data;vc=Fb.defaultDirectory;return pc.return(Ud.dirCache[kd.trackerId]=vc)})})}function id(kd){var cb,Fb,vc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(pc){if(1==pc.nextAddress)return pc.yield(kd.sendToAndWait(kd.trackerId,
"lively.shell.env",{}),2);cb=pc.yieldResult;Fb=cb.data;vc=Fb.env;return pc.return(vc)})}function Uc(kd,cb){cb=(cb=void 0===cb?{}:cb)||{};var Fb=Ud.runCommand('cat "'+kd+'"',cb);return Fb.whenDone().then(function(){if(Fb.exitCode)throw Error("Read "+kd+" failed: "+Fb.stderr);return Fb.output})}function Ad(kd,cb,Fb){!Fb&&cb&&cb.content&&(Fb=cb,cb=Fb.content);var vc=Ud.runCommand('tee "'+kd+'"',Object.assign({stdin:cb||""},Fb));return vc.whenDone().then(function(){if(vc.exitCode)throw Error("Write "+
kd+" failed: "+vc.stderr);return vc})}Ca({defaultDirectory:Zd,env:id,readFile:Uc,runCommand:fd,writeFile:Ad});var Nd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");Nd.promise=Cb;Nd.events=Vb;var ee=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=Nd.promise.deferred();this._whenStarted=Nd.promise.deferred();this.startTime=0;this.lastSignal=null;Nd.events.makeEmitter(this)};ee.findCommand=function(kd){return this.commands.find(function(cb){return cb.pid===
kd})};ee.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};ee.prototype.isDone=function(){return void 0!=this.exitCode};ee.prototype.whenStarted=function(){return this._whenStarted.promise};ee.prototype.whenDone=function(){return this._whenDone.promise};ee.prototype.spawn=function(kd){throw Error("not yet implemented");};ee.prototype.kill=function(kd){this.lastSignal=void 0===kd?"KILL":kd};ee.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(ee.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(ee,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});Nd.CommandInterface=ee;Nd.default=ee;var Ud=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");Ud.runCommand=fd;Ud.defaultDirectory=Zd;Ud.env=id;Ud.readFile=Uc;Ud.writeFile=
Ad;Ud.CommandInterface=ee;Ud.promise=Cb;Ud.arr=lc;Ud.obj=gc;Ud.signal=fe;Ud.debug=!1;Ud.runCommand=fd;Ud.runCommand=fd;Ud.dirCache={};Ud.defaultDirectory=Zd;Ud.defaultDirectory=Zd;Ud.env=id;Ud.env=id;Ud.readFile=Uc;Ud.readFile=Uc;Ud.writeFile=Ad;Ud.writeFile=Ad;ee=function(kd){var cb=Ud.CommandInterface.call(this)||this;cb.debug=Ud.debug;cb.l2lClient=kd;return cb};$jscomp.inherits(ee,Ud.CommandInterface);ee.installLively2LivelyServices=function(kd){Object.keys(Ud.L2LServices).forEach(function(cb){return kd.addService(cb,
function(Fb,vc,pc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(sd){return sd.return(Ud.L2LServices[cb](Fb,vc,pc))})})})};ee.prototype.envForCommand=function(kd){var cb=this.l2lClient,Fb=cb.id,vc=cb.origin,pc=cb.path;cb=cb.namespace;var sd=kd||{};kd=sd.env;sd=sd.owner;kd=kd||{};sd&&(kd.LIVELY_COMMAND_OWNER=sd);return Object.assign({ASKPASS_SESSIONID:Fb,L2L_EDITOR_SESSIONID:Fb,L2L_SESSIONTRACKER_SERVER:vc,L2L_SESSIONTRACKER_PATH:pc,L2L_SESSIONTRACKER_NS:cb},kd)};ee.prototype.spawn=function(kd){kd=
void 0===kd?{command:null,env:{},cwd:null,stdin:null}:kd;var cb=this,Fb,vc,pc,sd,pd,tc,bd,Xb,Tb,Oc,td;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Ob){if(1==Ob.nextAddress)return Fb=cb,vc=Fb.l2lClient,pc=kd,sd=pc.command,pd=pc.env,tc=pc.cwd,bd=pc.stdin,cb.startTime=new Date,pd=cb.envForCommand(kd),cb.debug&&console.log(cb+" spawning "+sd),cb.debug&&cb.whenStarted().then(function(){return console.log(cb+" started")}),cb.debug&&cb.whenDone().then(function(){return console.log(cb+" exited")}),
Ud.arr.pushIfNotIncluded(cb.constructor.commands,cb),cb.commandString=Array.isArray(sd)?sd.join(""):sd,Ob.yield(vc.sendToAndWait(vc.trackerId,"lively.shell.spawn",{command:sd,env:pd,cwd:tc,stdin:bd},{ackTimeout:3E4}),2);Xb=Ob.yieldResult;Tb=Xb.data;Oc=Tb.error;td=Tb.pid;if(Oc)throw Ud.debug&&console.error("["+cb+"] error at start: "+Oc),cb.process={error:Oc},cb.exitCode=1,Ud.signal(cb,"error",Oc),Error(Oc);cb.process={pid:td};Ud.debug&&console.log("["+cb+"] got pid "+td);Ud.signal(cb,"pid",td);cb._whenStarted.resolve();
return Ob.return(cb)})};ee.prototype.writeToStdin=function(kd){var cb=this,Fb,vc,pc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(sd){if(!cb.isRunning())return sd.return();Fb=cb;vc=Fb.l2lClient;pc=Fb.pid;return sd.yield(vc.sendToAndWait(vc.trackerId,"lively.shell.writeToStdin",{pid:pc,stdin:String(kd)}),0)})};ee.prototype.kill=function(kd){kd=void 0===kd?"KILL":kd;var cb=this,Fb,vc,pc,sd,pd,tc,bd;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Xb){if(1==Xb.nextAddress){if(!cb.isRunning())return Xb.return();
Ud.debug&&console.log(cb+" signaling "+kd);cb.lastSignal=kd;Fb=cb;vc=Fb.pid;pc=Fb.l2lClient;return Xb.yield(pc.sendToAndWait(pc.trackerId,"lively.shell.kill",{pid:vc}),2)}sd=Xb.yieldResult;pd=sd.data;tc=pd.status;bd=pd.error;Ud.debug&&console.log(cb+" kill send: "+(bd||tc));if(bd)throw Error(bd);return Xb.return(cb.whenDone())})};ee.prototype.onOutput=function(kd){var cb=kd.stdout;kd=kd.stderr;cb&&(this._stdout+=cb,Ud.signal(this,"stdout",cb),this.emit("stdout",cb));kd&&(this._stderr+=kd,Ud.signal(this,
"stderr",kd),this.emit("stderr",kd))};ee.prototype.onClose=function(kd){Ud.arr.remove(this.constructor.commands,this);this.exitCode=kd;this.emit("close",kd);Ud.signal(this,"close",kd);this._whenDone.resolve(this)};ee.prototype.onError=function(kd){Ud.arr.remove(this.constructor.commands,this);this._stderr+=kd.stack;this.exitCode=1;this.emit("error",kd.stack);Ud.signal(this,"error",kd.stack);this._whenDone.reject(kd)};Ca("default",ee);Ud.ClientCommand=ee;Ud.L2LServices={"lively.shell.onOutput":function(kd,
cb,Fb,vc){kd=cb.data;var pc=kd.pid,sd=kd.stdout,pd=kd.stderr,tc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bd){switch(bd.nextAddress){case 1:return Ud.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+pc),bd.setCatchFinallyBlocks(2),bd.yield(Ud.promise.waitFor(1E3,function(){return Ud.ClientCommand.findCommand(pc)}),4);case 4:tc=bd.yieldResult;bd.leaveTryBlock(3);break;case 2:return bd.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
pc+" but it isn't registered!'"),bd.return();case 3:tc.onOutput({stdout:sd,stderr:pd}),bd.jumpToEnd()}})},"lively.shell.onExit":function(kd,cb,Fb,vc){kd=cb.data;var pc=kd.pid,sd=kd.code,pd=kd.error,tc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bd){switch(bd.nextAddress){case 1:return Ud.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+pc),bd.setCatchFinallyBlocks(2),bd.yield(Ud.promise.waitFor(1E3,function(){return Ud.ClientCommand.findCommand(pc)}),
4);case 4:tc=bd.yieldResult;bd.leaveTryBlock(3);break;case 2:return bd.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+pc+" but it isn't registered!'"),bd.return();case 3:if(pd)"string"===typeof pd&&(pd=Error(pd)),tc.onError(pd);else tc.onClose(sd);bd.jumpToEnd()}})}};Ud.default=ee}}});