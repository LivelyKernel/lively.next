System.register(["./__root_module__-aefa9179.js","kld-intersections"],function(Da){var Bb,Qb,hc,ac,be;return{setters:[function(bd){Bb=bd.$;Qb=bd.bn;hc=bd.a6;ac=bd.a7;be=bd.ar},function(){}],execute:function(){function bd(jd,cb){cb=void 0===cb?{}:cb;var Ab=cb.l2lClient;if(!Ab)throw Error("lively.shell client side runCommand needs opts.l2lClient!");Kd.ClientCommand.installLively2LivelyServices(Ab);Ab=new Kd.ClientCommand(Ab);Ab.spawn(Object.assign({command:jd},Kd.obj.dissoc(cb,["l2lClient"])));
return Ab}function Sd(jd){return Kd.dirCache[jd.trackerId]?Kd.dirCache[jd.trackerId]:Promise.resolve().then(function(){var cb,Ab,Yb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(gc){if(1==gc.nextAddress)return gc.yield(jd.sendToAndWait(jd.trackerId,"lively.shell.info",{}),2);cb=gc.yieldResult;Ab=cb.data;Yb=Ab.defaultDirectory;return gc.return(Kd.dirCache[jd.trackerId]=Yb)})})}function ed(jd){var cb,Ab,Yb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(gc){if(1==gc.nextAddress)return gc.yield(jd.sendToAndWait(jd.trackerId,
"lively.shell.env",{}),2);cb=gc.yieldResult;Ab=cb.data;Yb=Ab.env;return gc.return(Yb)})}function Mc(jd,cb){cb=(cb=void 0===cb?{}:cb)||{};var Ab=Kd.runCommand('cat "'+jd+'"',cb);return Ab.whenDone().then(function(){if(Ab.exitCode)throw Error("Read "+jd+" failed: "+Ab.stderr);return Ab.output})}function pd(jd,cb,Ab){!Ab&&cb&&cb.content&&(Ab=cb,cb=Ab.content);var Yb=Kd.runCommand('tee "'+jd+'"',Object.assign({stdin:cb||""},Ab));return Yb.whenDone().then(function(){if(Yb.exitCode)throw Error("Write "+
jd+" failed: "+Yb.stderr);return Yb})}Da({defaultDirectory:Sd,env:ed,readFile:Mc,runCommand:bd,writeFile:pd});var Dd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");Dd.promise=Bb;Dd.events=Qb;var ke=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=Dd.promise.deferred();this._whenStarted=Dd.promise.deferred();this.startTime=0;this.lastSignal=null;Dd.events.makeEmitter(this)};ke.findCommand=function(jd){return this.commands.find(function(cb){return cb.pid===
jd})};ke.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};ke.prototype.isDone=function(){return void 0!=this.exitCode};ke.prototype.whenStarted=function(){return this._whenStarted.promise};ke.prototype.whenDone=function(){return this._whenDone.promise};ke.prototype.spawn=function(jd){throw Error("not yet implemented");};ke.prototype.kill=function(jd){this.lastSignal=void 0===jd?"KILL":jd};ke.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(ke.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(ke,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});Dd.CommandInterface=ke;Dd.default=ke;var Kd=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");Kd.runCommand=bd;Kd.defaultDirectory=Sd;Kd.env=ed;Kd.readFile=Mc;Kd.writeFile=
pd;Kd.CommandInterface=ke;Kd.promise=Bb;Kd.arr=hc;Kd.obj=ac;Kd.signal=be;Kd.debug=!1;Kd.runCommand=bd;Kd.runCommand=bd;Kd.dirCache={};Kd.defaultDirectory=Sd;Kd.defaultDirectory=Sd;Kd.env=ed;Kd.env=ed;Kd.readFile=Mc;Kd.readFile=Mc;Kd.writeFile=pd;Kd.writeFile=pd;ke=function(jd){var cb=Kd.CommandInterface.call(this)||this;cb.debug=Kd.debug;cb.l2lClient=jd;return cb};$jscomp.inherits(ke,Kd.CommandInterface);ke.installLively2LivelyServices=function(jd){Object.keys(Kd.L2LServices).forEach(function(cb){return jd.addService(cb,
function(Ab,Yb,gc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(dd){return dd.return(Kd.L2LServices[cb](Ab,Yb,gc))})})})};ke.prototype.envForCommand=function(jd){var cb=this.l2lClient,Ab=cb.id,Yb=cb.origin,gc=cb.path;cb=cb.namespace;var dd=jd||{};jd=dd.env;dd=dd.owner;jd=jd||{};dd&&(jd.LIVELY_COMMAND_OWNER=dd);return Object.assign({ASKPASS_SESSIONID:Ab,L2L_EDITOR_SESSIONID:Ab,L2L_SESSIONTRACKER_SERVER:Yb,L2L_SESSIONTRACKER_PATH:gc,L2L_SESSIONTRACKER_NS:cb},jd)};ke.prototype.spawn=function(jd){jd=
void 0===jd?{command:null,env:{},cwd:null,stdin:null}:jd;var cb=this,Ab,Yb,gc,dd,Zd,Wb,oc,Lb,Bc,Sc,Yc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Xb){if(1==Xb.nextAddress)return Ab=cb,Yb=Ab.l2lClient,gc=jd,dd=gc.command,Zd=gc.env,Wb=gc.cwd,oc=gc.stdin,cb.startTime=new Date,Zd=cb.envForCommand(jd),cb.debug&&console.log(cb+" spawning "+dd),cb.debug&&cb.whenStarted().then(function(){return console.log(cb+" started")}),cb.debug&&cb.whenDone().then(function(){return console.log(cb+" exited")}),
Kd.arr.pushIfNotIncluded(cb.constructor.commands,cb),cb.commandString=Array.isArray(dd)?dd.join(""):dd,Xb.yield(Yb.sendToAndWait(Yb.trackerId,"lively.shell.spawn",{command:dd,env:Zd,cwd:Wb,stdin:oc},{ackTimeout:3E4}),2);Lb=Xb.yieldResult;Bc=Lb.data;Sc=Bc.error;Yc=Bc.pid;if(Sc)throw Kd.debug&&console.error("["+cb+"] error at start: "+Sc),cb.process={error:Sc},cb.exitCode=1,Kd.signal(cb,"error",Sc),Error(Sc);cb.process={pid:Yc};Kd.debug&&console.log("["+cb+"] got pid "+Yc);Kd.signal(cb,"pid",Yc);cb._whenStarted.resolve();
return Xb.return(cb)})};ke.prototype.writeToStdin=function(jd){var cb=this,Ab,Yb,gc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(dd){if(!cb.isRunning())return dd.return();Ab=cb;Yb=Ab.l2lClient;gc=Ab.pid;return dd.yield(Yb.sendToAndWait(Yb.trackerId,"lively.shell.writeToStdin",{pid:gc,stdin:String(jd)}),0)})};ke.prototype.kill=function(jd){jd=void 0===jd?"KILL":jd;var cb=this,Ab,Yb,gc,dd,Zd,Wb,oc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Lb){if(1==Lb.nextAddress){if(!cb.isRunning())return Lb.return();
Kd.debug&&console.log(cb+" signaling "+jd);cb.lastSignal=jd;Ab=cb;Yb=Ab.pid;gc=Ab.l2lClient;return Lb.yield(gc.sendToAndWait(gc.trackerId,"lively.shell.kill",{pid:Yb}),2)}dd=Lb.yieldResult;Zd=dd.data;Wb=Zd.status;oc=Zd.error;Kd.debug&&console.log(cb+" kill send: "+(oc||Wb));if(oc)throw Error(oc);return Lb.return(cb.whenDone())})};ke.prototype.onOutput=function(jd){var cb=jd.stdout;jd=jd.stderr;cb&&(this._stdout+=cb,Kd.signal(this,"stdout",cb),this.emit("stdout",cb));jd&&(this._stderr+=jd,Kd.signal(this,
"stderr",jd),this.emit("stderr",jd))};ke.prototype.onClose=function(jd){Kd.arr.remove(this.constructor.commands,this);this.exitCode=jd;this.emit("close",jd);Kd.signal(this,"close",jd);this._whenDone.resolve(this)};ke.prototype.onError=function(jd){Kd.arr.remove(this.constructor.commands,this);this._stderr+=jd.stack;this.exitCode=1;this.emit("error",jd.stack);Kd.signal(this,"error",jd.stack);this._whenDone.reject(jd)};Da("default",ke);Kd.ClientCommand=ke;Kd.L2LServices={"lively.shell.onOutput":function(jd,
cb,Ab,Yb){jd=cb.data;var gc=jd.pid,dd=jd.stdout,Zd=jd.stderr,Wb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(oc){switch(oc.nextAddress){case 1:return Kd.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+gc),oc.setCatchFinallyBlocks(2),oc.yield(Kd.promise.waitFor(1E3,function(){return Kd.ClientCommand.findCommand(gc)}),4);case 4:Wb=oc.yieldResult;oc.leaveTryBlock(3);break;case 2:return oc.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
gc+" but it isn't registered!'"),oc.return();case 3:Wb.onOutput({stdout:dd,stderr:Zd}),oc.jumpToEnd()}})},"lively.shell.onExit":function(jd,cb,Ab,Yb){jd=cb.data;var gc=jd.pid,dd=jd.code,Zd=jd.error,Wb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(oc){switch(oc.nextAddress){case 1:return Kd.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+gc),oc.setCatchFinallyBlocks(2),oc.yield(Kd.promise.waitFor(1E3,function(){return Kd.ClientCommand.findCommand(gc)}),
4);case 4:Wb=oc.yieldResult;oc.leaveTryBlock(3);break;case 2:return oc.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+gc+" but it isn't registered!'"),oc.return();case 3:if(Zd)"string"===typeof Zd&&(Zd=Error(Zd)),Wb.onError(Zd);else Wb.onClose(dd);oc.jumpToEnd()}})}};Kd.default=ke}}});