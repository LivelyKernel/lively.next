System.register(["./__root_module__-11543d52.js","kld-intersections"],function(sa){var lb,Eb,Vb,Wb,qd;return{setters:[function(Ec){lb=Ec._;Eb=Ec.bk;Vb=Ec.a4;Wb=Ec.a5;qd=Ec.ap},function(){}],execute:function(){function Ec(Vc,Ra){Ra=void 0===Ra?{}:Ra;var tb=Ra.l2lClient;if(!tb)throw Error("lively.shell client side runCommand needs opts.l2lClient!");md.ClientCommand.installLively2LivelyServices(tb);tb=new md.ClientCommand(tb);tb.spawn(Object.assign({command:Vc},md.obj.dissoc(Ra,["l2lClient"])));
return tb}function vd(Vc){return md.dirCache[Vc.trackerId]?md.dirCache[Vc.trackerId]:Promise.resolve().then(function(){var Ra,tb,dc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bc){if(1==bc.nextAddress)return bc.yield(Vc.sendToAndWait(Vc.trackerId,"lively.shell.info",{}),2);Ra=bc.yieldResult;tb=Ra.data;dc=tb.defaultDirectory;return bc.return(md.dirCache[Vc.trackerId]=dc)})})}function Ic(Vc){var Ra,tb,dc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(bc){if(1==bc.nextAddress)return bc.yield(Vc.sendToAndWait(Vc.trackerId,
"lively.shell.env",{}),2);Ra=bc.yieldResult;tb=Ra.data;dc=tb.env;return bc.return(dc)})}function Jc(Vc,Ra){Ra=(Ra=void 0===Ra?{}:Ra)||{};var tb=md.runCommand('cat "'+Vc+'"',Ra);return tb.whenDone().then(function(){if(tb.exitCode)throw Error("Read "+Vc+" failed: "+tb.stderr);return tb.output})}function Zc(Vc,Ra,tb){!tb&&Ra&&Ra.content&&(tb=Ra,Ra=tb.content);var dc=md.runCommand('tee "'+Vc+'"',Object.assign({stdin:Ra||""},tb));return dc.whenDone().then(function(){if(dc.exitCode)throw Error("Write "+
Vc+" failed: "+dc.stderr);return dc})}sa({defaultDirectory:vd,env:Ic,readFile:Jc,runCommand:Ec,writeFile:Zc});var $c=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");$c.promise=lb;$c.events=Eb;var Fd=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=$c.promise.deferred();this._whenStarted=$c.promise.deferred();this.startTime=0;this.lastSignal=null;$c.events.makeEmitter(this)};Fd.findCommand=function(Vc){return this.commands.find(function(Ra){return Ra.pid===
Vc})};Fd.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};Fd.prototype.isDone=function(){return void 0!=this.exitCode};Fd.prototype.whenStarted=function(){return this._whenStarted.promise};Fd.prototype.whenDone=function(){return this._whenDone.promise};Fd.prototype.spawn=function(Vc){throw Error("not yet implemented");};Fd.prototype.kill=function(Vc){this.lastSignal=void 0===Vc?"KILL":Vc};Fd.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(Fd.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(Fd,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});$c.CommandInterface=Fd;$c.default=Fd;var md=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");md.runCommand=Ec;md.defaultDirectory=vd;md.env=Ic;md.readFile=Jc;md.writeFile=
Zc;md.CommandInterface=Fd;md.promise=lb;md.arr=Vb;md.obj=Wb;md.signal=qd;md.debug=!1;md.runCommand=Ec;md.runCommand=Ec;md.dirCache={};md.defaultDirectory=vd;md.defaultDirectory=vd;md.env=Ic;md.env=Ic;md.readFile=Jc;md.readFile=Jc;md.writeFile=Zc;md.writeFile=Zc;Fd=function(Vc){var Ra=md.CommandInterface.call(this)||this;Ra.debug=md.debug;Ra.l2lClient=Vc;return Ra};$jscomp.inherits(Fd,md.CommandInterface);Fd.installLively2LivelyServices=function(Vc){Object.keys(md.L2LServices).forEach(function(Ra){return Vc.addService(Ra,
function(tb,dc,bc){return $jscomp.asyncExecutePromiseGeneratorProgram(function(Yc){return Yc.return(md.L2LServices[Ra](tb,dc,bc))})})})};Fd.prototype.envForCommand=function(Vc){var Ra=this.l2lClient,tb=Ra.id,dc=Ra.origin,bc=Ra.path;Ra=Ra.namespace;var Yc=Vc||{};Vc=Yc.env;Yc=Yc.owner;Vc=Vc||{};Yc&&(Vc.LIVELY_COMMAND_OWNER=Yc);return Object.assign({ASKPASS_SESSIONID:tb,L2L_EDITOR_SESSIONID:tb,L2L_SESSIONTRACKER_SERVER:dc,L2L_SESSIONTRACKER_PATH:bc,L2L_SESSIONTRACKER_NS:Ra},Vc)};Fd.prototype.spawn=function(Vc){Vc=
void 0===Vc?{command:null,env:{},cwd:null,stdin:null}:Vc;var Ra=this,tb,dc,bc,Yc,Oc,$b,zc,Fb,Bb,pc,Pc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(xb){if(1==xb.nextAddress)return tb=Ra,dc=tb.l2lClient,bc=Vc,Yc=bc.command,Oc=bc.env,$b=bc.cwd,zc=bc.stdin,Ra.startTime=new Date,Oc=Ra.envForCommand(Vc),Ra.debug&&console.log(Ra+" spawning "+Yc),Ra.debug&&Ra.whenStarted().then(function(){return console.log(Ra+" started")}),Ra.debug&&Ra.whenDone().then(function(){return console.log(Ra+" exited")}),
md.arr.pushIfNotIncluded(Ra.constructor.commands,Ra),Ra.commandString=Array.isArray(Yc)?Yc.join(""):Yc,xb.yield(dc.sendToAndWait(dc.trackerId,"lively.shell.spawn",{command:Yc,env:Oc,cwd:$b,stdin:zc},{ackTimeout:3E4}),2);Fb=xb.yieldResult;Bb=Fb.data;pc=Bb.error;Pc=Bb.pid;if(pc)throw md.debug&&console.error("["+Ra+"] error at start: "+pc),Ra.process={error:pc},Ra.exitCode=1,md.signal(Ra,"error",pc),Error(pc);Ra.process={pid:Pc};md.debug&&console.log("["+Ra+"] got pid "+Pc);md.signal(Ra,"pid",Pc);Ra._whenStarted.resolve();
return xb.return(Ra)})};Fd.prototype.writeToStdin=function(Vc){var Ra=this,tb,dc,bc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Yc){if(!Ra.isRunning())return Yc.return();tb=Ra;dc=tb.l2lClient;bc=tb.pid;return Yc.yield(dc.sendToAndWait(dc.trackerId,"lively.shell.writeToStdin",{pid:bc,stdin:String(Vc)}),0)})};Fd.prototype.kill=function(Vc){Vc=void 0===Vc?"KILL":Vc;var Ra=this,tb,dc,bc,Yc,Oc,$b,zc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Fb){if(1==Fb.nextAddress){if(!Ra.isRunning())return Fb.return();
md.debug&&console.log(Ra+" signaling "+Vc);Ra.lastSignal=Vc;tb=Ra;dc=tb.pid;bc=tb.l2lClient;return Fb.yield(bc.sendToAndWait(bc.trackerId,"lively.shell.kill",{pid:dc}),2)}Yc=Fb.yieldResult;Oc=Yc.data;$b=Oc.status;zc=Oc.error;md.debug&&console.log(Ra+" kill send: "+(zc||$b));if(zc)throw Error(zc);return Fb.return(Ra.whenDone())})};Fd.prototype.onOutput=function(Vc){var Ra=Vc.stdout;Vc=Vc.stderr;Ra&&(this._stdout+=Ra,md.signal(this,"stdout",Ra),this.emit("stdout",Ra));Vc&&(this._stderr+=Vc,md.signal(this,
"stderr",Vc),this.emit("stderr",Vc))};Fd.prototype.onClose=function(Vc){md.arr.remove(this.constructor.commands,this);this.exitCode=Vc;this.emit("close",Vc);md.signal(this,"close",Vc);this._whenDone.resolve(this)};Fd.prototype.onError=function(Vc){md.arr.remove(this.constructor.commands,this);this._stderr+=Vc.stack;this.exitCode=1;this.emit("error",Vc.stack);md.signal(this,"error",Vc.stack);this._whenDone.reject(Vc)};sa("default",Fd);md.ClientCommand=Fd;md.L2LServices={"lively.shell.onOutput":function(Vc,
Ra,tb,dc){Vc=Ra.data;var bc=Vc.pid,Yc=Vc.stdout,Oc=Vc.stderr,$b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(zc){switch(zc.nextAddress){case 1:return md.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+bc),zc.setCatchFinallyBlocks(2),zc.yield(md.promise.waitFor(1E3,function(){return md.ClientCommand.findCommand(bc)}),4);case 4:$b=zc.yieldResult;zc.leaveTryBlock(3);break;case 2:return zc.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
bc+" but it isn't registered!'"),zc.return();case 3:$b.onOutput({stdout:Yc,stderr:Oc}),zc.jumpToEnd()}})},"lively.shell.onExit":function(Vc,Ra,tb,dc){Vc=Ra.data;var bc=Vc.pid,Yc=Vc.code,Oc=Vc.error,$b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(zc){switch(zc.nextAddress){case 1:return md.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+bc),zc.setCatchFinallyBlocks(2),zc.yield(md.promise.waitFor(1E3,function(){return md.ClientCommand.findCommand(bc)}),
4);case 4:$b=zc.yieldResult;zc.leaveTryBlock(3);break;case 2:return zc.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+bc+" but it isn't registered!'"),zc.return();case 3:if(Oc)"string"===typeof Oc&&(Oc=Error(Oc)),$b.onError(Oc);else $b.onClose(Yc);zc.jumpToEnd()}})}};md.default=Fd}}});