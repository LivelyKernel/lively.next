System.register(["./__root_module__-3d4e820f.js","kld-intersections"],function(ra){var kb,zb,Sb,Mb,Fd;return{setters:[function(Jc){kb=Jc.$;zb=Jc.bm;Sb=Jc.a6;Mb=Jc.a7;Fd=Jc.ar},function(){}],execute:function(){function Jc(Xc,Na){Na=void 0===Na?{}:Na;var nb=Na.l2lClient;if(!nb)throw Error("lively.shell client side runCommand needs opts.l2lClient!");nd.ClientCommand.installLively2LivelyServices(nb);nb=new nd.ClientCommand(nb);nb.spawn(Object.assign({command:Xc},nd.obj.dissoc(Na,["l2lClient"])));
return nb}function wd(Xc){return nd.dirCache[Xc.trackerId]?nd.dirCache[Xc.trackerId]:Promise.resolve().then(function(){var Na,nb,Pb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Wb){if(1==Wb.nextAddress)return Wb.yield(Xc.sendToAndWait(Xc.trackerId,"lively.shell.info",{}),2);Na=Wb.yieldResult;nb=Na.data;Pb=nb.defaultDirectory;return Wb.return(nd.dirCache[Xc.trackerId]=Pb)})})}function Kc(Xc){var Na,nb,Pb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Wb){if(1==Wb.nextAddress)return Wb.yield(Xc.sendToAndWait(Xc.trackerId,
"lively.shell.env",{}),2);Na=Wb.yieldResult;nb=Na.data;Pb=nb.env;return Wb.return(Pb)})}function Fc(Xc,Na){Na=(Na=void 0===Na?{}:Na)||{};var nb=nd.runCommand('cat "'+Xc+'"',Na);return nb.whenDone().then(function(){if(nb.exitCode)throw Error("Read "+Xc+" failed: "+nb.stderr);return nb.output})}function Wc(Xc,Na,nb){!nb&&Na&&Na.content&&(nb=Na,Na=nb.content);var Pb=nd.runCommand('tee "'+Xc+'"',Object.assign({stdin:Na||""},nb));return Pb.whenDone().then(function(){if(Pb.exitCode)throw Error("Write "+
Xc+" failed: "+Pb.stderr);return Pb})}ra({defaultDirectory:wd,env:Kc,readFile:Fc,runCommand:Jc,writeFile:Wc});var hd=lively.FreezerRuntime.recorderFor("lively.shell/command-interface.js");hd.promise=kb;hd.events=zb;var Id=function(){this._stderr=this._stdout="";this.exitCode=void 0;this.commandString="";this.process=null;this._whenDone=hd.promise.deferred();this._whenStarted=hd.promise.deferred();this.startTime=0;this.lastSignal=null;hd.events.makeEmitter(this)};Id.findCommand=function(Xc){return this.commands.find(function(Na){return Na.pid===
Xc})};Id.prototype.isRunning=function(){return this.process&&void 0===this.exitCode};Id.prototype.isDone=function(){return void 0!=this.exitCode};Id.prototype.whenStarted=function(){return this._whenStarted.promise};Id.prototype.whenDone=function(){return this._whenDone.promise};Id.prototype.spawn=function(Xc){throw Error("not yet implemented");};Id.prototype.kill=function(Xc){this.lastSignal=void 0===Xc?"KILL":Xc};Id.prototype.toString=function(){return this.constructor.name+"("+this.commandString+
", "+this.status+")"};$jscomp.global.Object.defineProperties(Id.prototype,{isShellCommand:{configurable:!0,enumerable:!0,get:function(){return!0}},status:{configurable:!0,enumerable:!0,get:function(){return this.process?void 0===this.exitCode?"running, pid "+this.pid:"exited "+this.exitCode+", pid "+this.pid:"not started"}},pid:{configurable:!0,enumerable:!0,get:function(){return this.process?this.process.pid:null}},output:{configurable:!0,enumerable:!0,get:function(){return this.stdout+(this.stderr?
"\n"+this.stderr:"")}},stdout:{configurable:!0,enumerable:!0,get:function(){return this._stdout}},stderr:{configurable:!0,enumerable:!0,get:function(){return this._stderr}}});$jscomp.global.Object.defineProperties(Id,{commands:{configurable:!0,enumerable:!0,get:function(){return this._commands||(this._commands=[])}}});hd.CommandInterface=Id;hd.default=Id;var nd=lively.FreezerRuntime.recorderFor("lively.shell/client-command.js");nd.runCommand=Jc;nd.defaultDirectory=wd;nd.env=Kc;nd.readFile=Fc;nd.writeFile=
Wc;nd.CommandInterface=Id;nd.promise=kb;nd.arr=Sb;nd.obj=Mb;nd.signal=Fd;nd.debug=!1;nd.runCommand=Jc;nd.runCommand=Jc;nd.dirCache={};nd.defaultDirectory=wd;nd.defaultDirectory=wd;nd.env=Kc;nd.env=Kc;nd.readFile=Fc;nd.readFile=Fc;nd.writeFile=Wc;nd.writeFile=Wc;Id=function(Xc){var Na=nd.CommandInterface.call(this)||this;Na.debug=nd.debug;Na.l2lClient=Xc;return Na};$jscomp.inherits(Id,nd.CommandInterface);Id.installLively2LivelyServices=function(Xc){Object.keys(nd.L2LServices).forEach(function(Na){return Xc.addService(Na,
function(nb,Pb,Wb){return $jscomp.asyncExecutePromiseGeneratorProgram(function(Pc){return Pc.return(nd.L2LServices[Na](nb,Pb,Wb))})})})};Id.prototype.envForCommand=function(Xc){var Na=this.l2lClient,nb=Na.id,Pb=Na.origin,Wb=Na.path;Na=Na.namespace;var Pc=Xc||{};Xc=Pc.env;Pc=Pc.owner;Xc=Xc||{};Pc&&(Xc.LIVELY_COMMAND_OWNER=Pc);return Object.assign({ASKPASS_SESSIONID:nb,L2L_EDITOR_SESSIONID:nb,L2L_SESSIONTRACKER_SERVER:Pb,L2L_SESSIONTRACKER_PATH:Wb,L2L_SESSIONTRACKER_NS:Na},Xc)};Id.prototype.spawn=function(Xc){Xc=
void 0===Xc?{command:null,env:{},cwd:null,stdin:null}:Xc;var Na=this,nb,Pb,Wb,Pc,Bd,Hb,Ub,vb,kc,xc,Dc;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Gb){if(1==Gb.nextAddress)return nb=Na,Pb=nb.l2lClient,Wb=Xc,Pc=Wb.command,Bd=Wb.env,Hb=Wb.cwd,Ub=Wb.stdin,Na.startTime=new Date,Bd=Na.envForCommand(Xc),Na.debug&&console.log(Na+" spawning "+Pc),Na.debug&&Na.whenStarted().then(function(){return console.log(Na+" started")}),Na.debug&&Na.whenDone().then(function(){return console.log(Na+" exited")}),
nd.arr.pushIfNotIncluded(Na.constructor.commands,Na),Na.commandString=Array.isArray(Pc)?Pc.join(""):Pc,Gb.yield(Pb.sendToAndWait(Pb.trackerId,"lively.shell.spawn",{command:Pc,env:Bd,cwd:Hb,stdin:Ub},{ackTimeout:3E4}),2);vb=Gb.yieldResult;kc=vb.data;xc=kc.error;Dc=kc.pid;if(xc)throw nd.debug&&console.error("["+Na+"] error at start: "+xc),Na.process={error:xc},Na.exitCode=1,nd.signal(Na,"error",xc),Error(xc);Na.process={pid:Dc};nd.debug&&console.log("["+Na+"] got pid "+Dc);nd.signal(Na,"pid",Dc);Na._whenStarted.resolve();
return Gb.return(Na)})};Id.prototype.writeToStdin=function(Xc){var Na=this,nb,Pb,Wb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Pc){if(!Na.isRunning())return Pc.return();nb=Na;Pb=nb.l2lClient;Wb=nb.pid;return Pc.yield(Pb.sendToAndWait(Pb.trackerId,"lively.shell.writeToStdin",{pid:Wb,stdin:String(Xc)}),0)})};Id.prototype.kill=function(Xc){Xc=void 0===Xc?"KILL":Xc;var Na=this,nb,Pb,Wb,Pc,Bd,Hb,Ub;return $jscomp.asyncExecutePromiseGeneratorProgram(function(vb){if(1==vb.nextAddress){if(!Na.isRunning())return vb.return();
nd.debug&&console.log(Na+" signaling "+Xc);Na.lastSignal=Xc;nb=Na;Pb=nb.pid;Wb=nb.l2lClient;return vb.yield(Wb.sendToAndWait(Wb.trackerId,"lively.shell.kill",{pid:Pb}),2)}Pc=vb.yieldResult;Bd=Pc.data;Hb=Bd.status;Ub=Bd.error;nd.debug&&console.log(Na+" kill send: "+(Ub||Hb));if(Ub)throw Error(Ub);return vb.return(Na.whenDone())})};Id.prototype.onOutput=function(Xc){var Na=Xc.stdout;Xc=Xc.stderr;Na&&(this._stdout+=Na,nd.signal(this,"stdout",Na),this.emit("stdout",Na));Xc&&(this._stderr+=Xc,nd.signal(this,
"stderr",Xc),this.emit("stderr",Xc))};Id.prototype.onClose=function(Xc){nd.arr.remove(this.constructor.commands,this);this.exitCode=Xc;this.emit("close",Xc);nd.signal(this,"close",Xc);this._whenDone.resolve(this)};Id.prototype.onError=function(Xc){nd.arr.remove(this.constructor.commands,this);this._stderr+=Xc.stack;this.exitCode=1;this.emit("error",Xc.stack);nd.signal(this,"error",Xc.stack);this._whenDone.reject(Xc)};ra("default",Id);nd.ClientCommand=Id;nd.L2LServices={"lively.shell.onOutput":function(Xc,
Na,nb,Pb){Xc=Na.data;var Wb=Xc.pid,Pc=Xc.stdout,Bd=Xc.stderr,Hb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Ub){switch(Ub.nextAddress){case 1:return nd.debug&&console.log("[lively.shell] client received lively.shell.onOutput for command "+Wb),Ub.setCatchFinallyBlocks(2),Ub.yield(nd.promise.waitFor(1E3,function(){return nd.ClientCommand.findCommand(Wb)}),4);case 4:Hb=Ub.yieldResult;Ub.leaveTryBlock(3);break;case 2:return Ub.enterCatchBlock(),console.warn("[lively.shell] received output for command "+
Wb+" but it isn't registered!'"),Ub.return();case 3:Hb.onOutput({stdout:Pc,stderr:Bd}),Ub.jumpToEnd()}})},"lively.shell.onExit":function(Xc,Na,nb,Pb){Xc=Na.data;var Wb=Xc.pid,Pc=Xc.code,Bd=Xc.error,Hb;return $jscomp.asyncExecutePromiseGeneratorProgram(function(Ub){switch(Ub.nextAddress){case 1:return nd.debug&&console.log("[lively.shell] client received lively.shell.onExit for command "+Wb),Ub.setCatchFinallyBlocks(2),Ub.yield(nd.promise.waitFor(1E3,function(){return nd.ClientCommand.findCommand(Wb)}),
4);case 4:Hb=Ub.yieldResult;Ub.leaveTryBlock(3);break;case 2:return Ub.enterCatchBlock(),console.warn("[lively.shell] received exit message for command "+Wb+" but it isn't registered!'"),Ub.return();case 3:if(Bd)"string"===typeof Bd&&(Bd=Error(Bd)),Hb.onError(Bd);else Hb.onClose(Pc);Ub.jumpToEnd()}})}};nd.default=Id}}});