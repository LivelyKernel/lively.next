<!DOCTYPE html>
<html>
  <head>
    <title>lively.next</title>
  </head>
  <body style="margin: 0;">

    <div id="dom-loading-indicator"
         style="position: fixed; top: 50%; left: 50%;
                margin-left: -160px; margin-top: -90px; z-index: 10;">
      <div style="width: 320px; height: 180px; font-size: 30pt; border-radius: 10px;
                  color: #ff7700; font-family: Helvetica Neue, Arial, sans-serif;
                  padding: 10px; background: #666;">
         <center><b>Loading</b></center>
         <div style="background-image: url(/lively.morphic/lively-web-logo-small-animate.svg);
                     background-size: cover; height: 100%; margin-left: 110px; margin-top: 20px;"></div>
      </div>
    </div>

    <script src="/lively.next-node_modules/babel-standalone/babel.js"></script>
    <script src="/lively.next-node_modules/systemjs/dist/system.src.js"></script>
    <script src="/lively.modules/dist/lively.modules.js"></script>

    <script>
      if (document.location.host !== "lively-next.org")
        document.title = `lively.next (${document.location.host})`;
      var res = lively.resources.resource,
          loc = document.location,
          origin = loc.origin,
          query = res(loc.href).query(),
          loginDone = false, worldLoaded = false,
          loadingIndicator = document.getElementById("dom-loading-indicator");

      lively.lang.promise.waitFor(function() { return !!lively.user; })
        .then(function() {
          var userRegistry = lively.user.UserRegistry.current;
          if (!userRegistry.hasUserStored() || query.login) {
            var userRegistry = lively.user.UserRegistry.current;
            res(`${origin}/lively.user/html/html-ui.fragment`).read()
              .then(function(content) {
                document.body.insertAdjacentHTML("beforeend", content);
                loadingIndicator.style.display = "none";
                return lively.resources.loadViaScript("/lively.user/html/html-ui.js")
              })
              .then(function() { return lively.user.html.openUserUI(); })
              .then(function(user) {
                loadingIndicator.style.display = "";
                loginDone = true;
              })
              .catch(function(err) { console.error(err); });
          } else loginDone = true;
        });
      
      Promise.resolve()
        .then(polyfills)
        .then(bootstrapLivelySystem)
        .then(function() { return lively.modules.registerPackage('lively.2lively'); })
        .then(function() {
          window.addEventListener('beforeunload', function(evt) {
            var msg = "Really?";
            evt.returnValue = msg;
            return msg;
          }, true);

          var isLocal = loc.search.includes("location=local"),
              worldNameMatch = decodeURIComponent(loc.pathname).match(/\/worlds\/(.+)/),
              worldName = worldNameMatch
                ? worldNameMatch[1].replace(/(\.json)?($|\?.*)/, ".json$2")
                : "default",
              resource = isLocal
                ? res("lively.storage://worlds/" + worldName)
                : res(origin + "/" + "lively.morphic/worlds/" + worldName);
          return resource.exists().then(function(exists) {
            return {
              exists: exists,
              resource: resource,
              showWorldLoadDialog: !worldNameMatch,
              isLocal: isLocal
            };
          });
        })
        .then(function(worldLocation) {
          if (!worldLocation.exists) {
            var msg = "No lively world exists at " + worldLocation.resource.url;
            document.body.innerHTML = "<h1>" + msg + "</h1>";
            throw new Error(msg);
          }
          Promise.all([
            lively.modules.importPackage('lively.morphic'),
            lively.lang.promise.waitFor(function() { return loginDone; })
          ]).then(function(result) {
            var morphic = result[0];
            return morphic.World.loadWorldFromURL(worldLocation.resource, null, {
              verbose: true,
              localconfig: true,
              l2l: true,
              shell: true,
              worldLoadDialog: worldLocation.showWorldLoadDialog,
              browserURL: "/worlds/"
              + worldLocation.resource.name().replace(/\.json($|\?)/, "")
              + (worldLocation.isLocal ? "?location=local" : ""),
            });
          })
        })
        .then(function() { worldLoaded = true; console.log("...lively.morphic world created"); })
        .catch(function(err) {
          if (err.originalErr) err = err.originalErr;
          console.error(err);
          var printed = err.message;
          printed += err.stack.includes(err.message) ? err.stack.replace(err.message, "\n") : err.stack;
          console.error(printed);
        });

      function bootstrapLivelySystem() {

        // for loading an instrumented version of the packages comprising the lively.system
        return Promise.resolve()
          .then(function() { console.log("starting bootstrap process..."); })

          .then(function() { return lively.resources.resource(origin).join("package-registry.json").readJson(); })
          .then(function (packageCached) {
            var System = lively.modules.getSystem("bootstrapped", {baseURL: origin});
            // System.debug = true;
            lively.modules.changeSystem(System, true);
            System["__lively.modules__packageRegistry"] = lively.modules.PackageRegistry.fromJSON(System, packageCached);
            return System;
          })
          .then(function() {
            return importPackageAndDo(
              "lively.lang",
              function(m) { delete m._prevLivelyGlobal; }); })

          .then(function() {
            return importPackageAndDo(
              "lively.ast",
              function(m) { lively.ast = m; }); })

          .then(function() {
            return importPackageAndDo(
              "lively.source-transform",
              function(m) { lively.sourceTransform = m; }); })

          .then(function() {
            return importPackageAndDo(
              "lively.classes",
              function(m) { lively.classes = m; }); })

          .then(function() {
            return importPackageAndDo(
              "lively.vm",
              function(m) { lively.vm = m; }); })

          .then(function() {
            return importPackageAndDo(
              "lively.modules",
              function(m) {
                lively.modules = m;
                lively.modules.unwrapModuleLoad();
                lively.modules.wrapModuleLoad();
                let oldRegistry = System["__lively.modules__packageRegistry"];
                delete System["__lively.modules__packageRegistry"];
                let newRegistry = System["__lively.modules__packageRegistry"] = m.PackageRegistry.ofSystem(System);
                Object.assign(newRegistry, lively.lang.obj.select(oldRegistry, ["packageMap", "individualPackageDirs", "devPackageDirs", "packageBaseDirs"]))
                newRegistry.resetByURL();
              })})

          .then(function() {
            return importPackageAndDo(
              "lively.user",
              function(m) { lively.user = m; })})

          .then(function() {
            return importPackageAndDo(
              "lively.storage",
              function(m) { lively.storage = m; })})

          .then(function() { console.log("...lively systems are ready!"); });
      }

      function importPackageAndDo(packageURL, doFunc) {
        var name = packageURL.split("/").slice(-1)[0];
        return lively.modules.importPackage(packageURL)
          .then(doFunc || function() {})
          .then(function() { console.log("...%s loaded...", name); })
      }

      function polyfills() {
        var loads = [];
        if (!("PointerEvent" in window))
          loads.push(lively.resources.loadViaScript(`${origin}/lively.next-node_modules/pepjs/dist/pep.js`));
        if (!("fetch" in window))
          loads.push(lively.resources.loadViaScript(`//cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.js`));
        return Promise.all(loads);
      }
    </script>
  </body>
</html>
